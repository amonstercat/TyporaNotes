

# æ‰“å¡ä¸šåŠ¡







## å…³é”®è¯æ€»è§ˆ

> æ‰“å¡ä¸šåŠ¡ä¸­ç»å¸¸æ¶‰åŠåˆ°çš„å…³é”®è¯å¦‚ä¸‹ï¼š

| **å…³é”®è¯**         | **è¯´æ˜**                                                     | **ç¤ºä¾‹**                                                     |
| ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **æ‰“å¡è§„åˆ™**       | **æ‰“å¡è§„åˆ™**ä¸»è¦æ˜¯çº¦æŸç”¨æˆ·å¯æ‰“å¡çš„æ–¹å¼ï¼šå¤–å‹¤æ‰“å¡ã€å†…å‹¤æ‰“å¡ï¼›ç§Ÿæˆ·åŠå…¬ä½ç½®çš„gpsæˆ–wifiä¿¡æ¯(ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æœ‰æ•ˆæ‰“å¡)ï¼›æ‰“å¡åŠ¨ä½œçš„çº¦æŸé™åˆ¶ï¼šæ˜¯å¦éœ€è¦é™„ä»¶ã€æ˜¯å¦éœ€è¦æ‹ç…§ç­‰ï¼Œç›®å‰æ‰“å¡è§„åˆ™çš„é…ç½®æ˜¯ä¾é™„äºè€ƒå‹¤ç»„è§„åˆ™é…ç½®é¡µé¢ | ![img](https://cdn.nlark.com/yuque/0/2023/png/34673482/1699585734637-6805c48e-3b90-429e-8130-93910bb37228.png) |
| **æ‰“å¡æ¸ é“**       | æ‰“å¡æ¸ é“æ˜¯ç”¨æ¥æ ‡è¯†ç”¨æˆ·ä½¿ç”¨çš„æ˜¯å“ªç§æ¸ é“è¿›è¡Œçš„æ‰“å¡åŠ¨ä½œæ•°æ®æ¥æºçš„ä¸»è¦æ¸ é“ï¼šæ‹‰å–ç¬¬ä¸‰æ–¹ï¼š ä¼å¾®ã€é’‰é’‰(é’‰é’‰æ‰“å¡ã€é’‰é’‰ç­¾åˆ°)ã€é£ä¹¦Mokaæ‰“å¡ï¼šmokaç§»åŠ¨ç«¯æ‰“å¡è€ƒå‹¤æœºæ‰“å¡ï¼š ä¸­æ§ã€å¤©æ•è€ƒå‹¤æœºç¬¬ä¸‰æ–¹ä¸»åŠ¨ä¸ŠæŠ¥ï¼š ä½¿ç”¨`openApi`ä¸»åŠ¨ä¸ŠæŠ¥ |                                                              |
| **æ‰“å¡æˆåŠŸæç¤º**   | æ‰“å¡æˆåŠŸåï¼Œç»™ç”¨æˆ·å‘é€æ‰“å¡åŠ¨ä½œæ“ä½œæˆåŠŸçš„æé†’é€šçŸ¥             |                                                              |
| **å‘˜å·¥æ‰“å¡æé†’**   | åœ¨ä¸Šç­æ—¶é—´èŒƒå›´å’Œä¸‹ç­æ—¶é—´èŒƒå›´å†…ä¸»åŠ¨å‘é€é€šçŸ¥ï¼Œæé†’ç”¨æˆ·è¿›è¡Œæ‰“å¡æ“ä½œé…ç½®é¡¹ï¼šè€ƒå‹¤ç»„ä¸­è®¾ç½®ä¸Šã€ä¸‹ç­çš„æé†’æ—¶é—´(åœ¨ç­æ¬¡å‰åå¤šä¹…) | ä¾‹å¦‚è®¾ç½®çš„ç­æ¬¡æ—¶é—´ä¸º**9ç‚¹~18ç‚¹** ï¼šåˆ™ä¸Šç­æ‰“å¡æé†’ï¼šæ‰“å¡å‰10åˆ†é’Ÿï¼Œ ä¸‹ç­æ‰“å¡æé†’ï¼šä¸‹ç­å5åˆ†é’Ÿä¸Šç­æé†’é€šçŸ¥å‘é€æ—¶é—´ï¼š8ç‚¹50åˆ†ä¸‹ç­æé†’é€šçŸ¥å‘é€æ—¶é—´ï¼š18ç‚¹05åˆ† |
| **æ‰“å¡æ–¹å¼**       | å†…å‹¤æ‰“å¡ï¼šåœ¨ç§Ÿæˆ·åŠå…¬ç‚¹æœ‰æ•ˆèŒƒå›´å†…çš„æ‰“å¡è¡Œä¸ºå±äºå†…å‹¤æ‰“å¡å¤–å‹¤æ‰“å¡ï¼šä¸åœ¨ç§Ÿæˆ·åŠå…¬ç‚¹æœ‰æ•ˆèŒƒå›´å†…çš„æ‰“å¡è¡Œä¸ºå±äºå¤–å‹¤æ‰“å¡ |                                                              |
| **ç³»ç»Ÿå¡(å…æ‰“å¡)** | å…æ‰“å¡åœºæ™¯ä¸‹ï¼Œè€ƒå‹¤æ ¸ç®—åœ¨è§¦å‘æ ¸ç®—æ—¶ç»™ç”¨æˆ·è‡ªåŠ¨ç”Ÿæˆçš„æ‰“å¡è®°å½•è¢«ç§°ä¸ºç³»ç»Ÿå¡ | å…¥ã€ç¦»èŒæ—¥å…æ‰“å¡è¯·å‡å…æ‰“å¡å¤–å‡ºå…æ‰“å¡å‡ºå·®å…æ‰“å¡å…¥å£ï¼šè€ƒå‹¤ç»„è®¾ç½® |
| **è‡ªåŠ¨æ‰“å¡**       | ä¸ºäº†æé«˜ç”¨æˆ·æ‰“å¡æˆåŠŸç‡ï¼Œç”¨æˆ·è¿›å…¥æ‰“å¡é¡µé¢æ—¶æ ¹æ®è§„åˆ™å¯èƒ½ä¼šä¸»åŠ¨è§¦å‘ä¸€æ¬¡è‡ªåŠ¨æ‰“å¡1. **å¦‚æœæ˜¯æœ‰æ•ˆä¸Šç­æ‰“å¡èŒƒå›´å†…ï¼Œéœ€è¦checkèŒƒå›´å†…æ˜¯å¦å·²ç»æœ‰è¿‡æ‰“å¡è®°å½•ï¼Œæ²¡æœ‰æ‰“å¡è®°å½•çš„æ‰ä¼šè§¦å‘è‡ªåŠ¨æ‰“å¡** 2. å¦‚æœåœ¨æœ‰æ•ˆä¸‹ç­æ‰“å¡èŒƒå›´å†…ï¼Œè¿›å…¥é¡µé¢å°±ä¼šè§¦å‘ä¸€æ¬¡è‡ªåŠ¨æ‰“å¡æœ‰æ•ˆä¸Šç­æ‰“å¡èŒƒå›´ï¼š æ ‡å‡†ä¸Šç­æ‰“å¡èŒƒå›´å¼€å§‹æ—¶é—´ ~ å¼¹æ€§å·¥ä½œå¼€å§‹æ—¶é—´  æœ‰æ•ˆä¸‹ç­æ‰“å¡èŒƒå›´ï¼š å¼¹æ€§å·¥ä½œç»“æŸæ—¶é—´ ~æ ‡å‡†ç­¾é€€æ‰“å¡èŒƒå›´ç»“æŸæ—¶é—´ | ç­æ¬¡æ—¶é—´9ç‚¹~18ç‚¹ï¼Œæœ‰æ•ˆæ‰“å¡èŒƒå›´ 7ç‚¹20ç‚¹ä¸Šç­å¡ï¼šç”¨æˆ·åœ¨7ç‚¹9ç‚¹è¿›å…¥æ‰“å¡é¡µé¢ï¼ŒæœŸé—´7ç‚¹9ç‚¹å¦‚æœæ²¡æœ‰æ‰“å¡è®°å½•ï¼Œè¿›å…¥é¡µé¢ä¼šè§¦å‘è‡ªåŠ¨æ‰“å¡ä¸‹ç­å¡ï¼šç”¨æˆ·åœ¨18ç‚¹20ç‚¹è¿›å…¥æ‰“å¡é¡µé¢ï¼Œä¼šè§¦å‘è‡ªåŠ¨æ‰“å¡ç­æ¬¡æ—¶é—´ï¼Œéœ€è¦è€ƒè™‘åˆ°å¼¹æ€§æ—¶é—´ï¼Œæ¯”å¦‚å…è®¸æ™šåˆ°æ™šèµ°30åˆ†é’Ÿï¼Œåˆ™ä¸Šç­å¡è‡ªåŠ¨æ‰“å¡æ—¶é—´ä¼šå˜ä¸º7ç‚¹~9ç‚¹30(ä¸Šç­å¡æ—¶é—´ä¼šè€ƒè™‘æ™šåˆ°æ™šèµ°è§„åˆ™) ï¼›ä¸Šç­æ‰“å¡æ˜¯8ç‚¹åŠï¼Œåˆ™ä¸‹ç­è‡ªåŠ¨æ‰“å¡å¼€å§‹æ—¶é—´ä¸º17ç‚¹30 |







## æ•°æ®åº“è¡¨



æ‰“å¡é€šç”¨è§„åˆ™è¡¨ï¼š

|              è¡¨å              |              è¯´æ˜              |                å¤‡æ³¨                 |
| :----------------------------: | :----------------------------: | :---------------------------------: |
|  hcm_abs_attendance_rule_gps   | è€ƒå‹¤è§„åˆ™ä¸­ç”¨äºæ‰“å¡çš„GPSä½ç½®è¡¨  |                                     |
|  hcm_abs_attendance_rule_wifi  | è€ƒå‹¤è§„åˆ™ä¸­ç”¨äºæ‰“å¡çš„WiFiä¿¡æ¯è¡¨ |                                     |
|         hcm_ding_user          |        é’‰é’‰åŒæ­¥çš„ç”¨æˆ·è¡¨        |                                     |
| hcm_abs_ding_talk_clock_record |      é’‰é’‰åŒæ­¥çš„æ‰“å¡è®°å½•è¡¨      |                                     |
|    hcm_abs_clock_in_record     |    æ‰€æœ‰æ¥æºæ±‡æ€»çš„æ‰“å¡è®°å½•è¡¨    |                                     |
|   hcm_abs_moka_clock_record    |        ç§»åŠ¨ç«¯æ‰“å¡è®°å½•è¡¨        |                                     |
|   hcm_abs_sync_clock_record    |           åŒæ­¥è®°å½•è¡¨           |                                     |
|   hcm_abs_ding_talk_sync_log   |      é’‰é’‰åŒæ­¥æ“ä½œçš„æ—¥å¿—è¡¨      |                                     |
|      `hcm_excel_template`      |        excelæ¨¡æ¿ä¿¡æ¯è¡¨         | å…¬å…±çš„æ¨¡å—ï¼Œä¸ç‹¬å±äºclockï¼Œæ— éœ€è¿ç§» |



ä¸‰æ–¹æ‰“å¡è®°å½•å¸¸ç”¨çš„æ•°æ®åº“è¡¨ï¼š

å¸¸ç”¨æ•°æ®åº“è¡¨ï¼š

ä»¥ä¸‹å’Œå‘˜å·¥ç›¸å…³è”çš„è¡¨éƒ½å¯ä»¥é€šè¿‡employeeIdå»æŸ¥è¯¢å¯¹åº”çš„æ˜ å°„å…³ç³»

| æ•°æ®åº“è¡¨                         | å«ä¹‰                             |
| :------------------------------- | :------------------------------- |
| hcm_ding_ent                     | ç§Ÿæˆ·åœ¨é’‰é’‰å’Œpeopleçš„æ˜ å°„å…³ç³»     |
| hcm_ding_user                    | å‘˜å·¥åœ¨é’‰é’‰å’Œpeopleçš„æ˜ å°„å…³ç³»     |
| hcm_ding_talk_clock_record       | å‘˜å·¥åœ¨é’‰é’‰æ‰“å¡çš„åŸå§‹è®°å½•         |
| hcm_wxin_ent                     | ç§Ÿæˆ·åœ¨ä¼ä¸šå¾®ä¿¡å’Œpeopleçš„æ˜ å°„å…³ç³» |
| hcm_wxin_user                    | å‘˜å·¥åœ¨ä¼ä¸šå¾®ä¿¡å’Œpeopleçš„æ˜ å°„å…³ç³» |
| hcm_wxin_origin_clock_record     | å‘˜å·¥åœ¨ä¼ä¸šå¾®ä¿¡çš„åŸå§‹è®°å½•         |
| hcm_lark_ent                     | ç§Ÿæˆ·åœ¨é£ä¹¦å’Œpeopleçš„æ˜ å°„å…³ç³»     |
| hcm_lark_user                    | å‘˜å·¥åœ¨é£ä¹¦å’Œpeopleçš„æ˜ å°„å…³ç³»     |
| hcm_abs_lark_origin_clock_record | å‘˜å·¥åœ¨é£ä¹¦çš„åŸå§‹è®°å½•             |





## å…³é”®æµç¨‹å›¾



1ã€**æ•´ä½“ä¸šåŠ¡é€»è¾‘**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241612279.png" alt="image-20231124161236688" style="zoom:50%;" />





2ã€ç§»åŠ¨ç«¯æ‰“å¡

![image-20231124161431344](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241614949.png)





3ã€æ‰‹åŠ¨å¯¼å…¥æ‰“å¡è®°å½•



![æ‰‹åŠ¨å¯¼å…¥æ‰“å¡è®°å½•](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241614269.png)





4ã€åŒæ­¥é’‰é’‰æ‰“å¡



![åŒæ­¥é’‰é’‰æ‰“å¡](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241615688.png)



5ã€ä¼ä¸šå¾®ä¿¡æ‰“å¡



![ä¼ä¸šå¾®ä¿¡æ‰“å¡æµç¨‹å›¾](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241615151.png)











6ã€è·å–æ‰“å¡è®°å½•



![è·å–æ‰“å¡è®°å½•](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241616628.png)









7ã€**ä¸‰æ–¹æ‰“å¡è®°å½•äº¤äº’æµç¨‹**



![image-20231124162252531](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241622598.png)









# æ‰“å¡æ•°æ®åŒæ­¥







æ‰“å¡æ•°æ®åŒæ­¥çš„æ€»ä½“æœåŠ¡æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š
![æ‰“å¡æµç¨‹.png](https://cdn.nlark.com/yuque/0/2023/png/34673482/1699599809232-bf92b565-da77-4460-b4e9-52f1c2b52b69.png#averageHue=%23faf7f6&clientId=ud6df02a7-9e4b-4&from=ui&height=619&id=bGbit&originHeight=1542&originWidth=2044&originalType=binary&ratio=2&rotation=0&showTitle=false&size=195230&status=done&style=none&taskId=u7814840e-feb8-4791-9f5f-33c2141d61e&title=&width=820)









## 1ã€åŒæ­¥ç¬¬ä¸‰æ–¹æ¸ é“æ‰“å¡æ•°æ® :exclamation:



è€Œ**é’ˆå¯¹ä¸‰æ–¹æ¸ é“æ‰“å¡çš„æ•°æ®æ‹‰å–ç¯èŠ‚**ï¼Œæµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š
![æ‰“å¡æ•°æ®åŒæ­¥.drawio.png](https://cdn.nlark.com/yuque/0/2023/png/34673482/1699600016465-594768ee-4f78-4fbb-8a1a-97521dfa93ba.png#averageHue=%23f9f9f9&clientId=ud6df02a7-9e4b-4&from=ui&id=TLb8w&originHeight=1395&originWidth=1312&originalType=binary&ratio=2&rotation=0&showTitle=false&size=200033&status=done&style=none&taskId=ub9f977de-df0f-4ab3-913d-3d222a8344e&title=)







æ³¨æ„è¿™é‡Œæœ‰å‡ ä¸ªè¦ç‚¹:exclamation: :exclamation:

1. transIdçš„ä½œç”¨ï¼š è°ƒç”¨mobileè·å–æ‰“å¡æ•°æ®â†’ mobileè¿”å›æ‰“å¡æ•°æ® æ˜¯é€šè¿‡mqæ¶ˆæ¯çš„æ–¹å¼è§¦å‘çš„å¼‚æ­¥å›è°ƒï¼Œç”±äºä¸‰æ–¹äººæ•°+é¢‘æ¬¡+æ—¶é—´åŒºé—´çš„é™åˆ¶ï¼Œä¸€æ¬¡è°ƒç”¨å¯èƒ½ä¼šæœ‰å¤šæ¬¡çš„mqå›è°ƒï¼ŒtransIdçš„ä½œç”¨ä¸»è¦æ˜¯ç”¨æ¥è¯†åˆ«æŸä¸€æ‰¹çš„æ‹‰å–æ•°æ®å·²ç»å…¨éƒ¨å¤„ç†å®Œæˆã€‚æ„å»ºä¸€ä¸ªtransIdä¸ºkey,valueä¸ºå‘˜å·¥åˆ—è¡¨çš„set, æ¯æ¬¡å›è°ƒå–å‡ºtransIdï¼Œ å¹¶åˆ é™¤å›è°ƒæ•°æ®ä¸­åœ¨setä¸­çš„äººå‘˜æ•°æ®ã€‚å¦‚æœtransIdçš„setä¸ºç©ºï¼Œæœ¬æ¬¡åŒæ­¥ä»»åŠ¡å¯ä»¥è®¤ä¸ºå·²ç»“æŸ

2. ç”±äºå„ä¸ªæ¸ é“ç›®å‰å¯¹æ‹‰å–é¢‘ç‡é™åˆ¶ä¸ä¸€æ ·ï¼Œå¹¶ä¸”è€ƒè™‘åˆ°ä¸€ä¸ªæ¸ é“ä¸èƒ½å½±å“å…¶ä»–æ¸ é“çš„æ‹‰å–ï¼Œå®šæ—¶ä»»åŠ¡æ˜¯åˆ†æ¸ é“è¿›è¡Œçš„é…ç½®

   

   ![](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231147008.png)

   

3. å„ä¸ªæ¸ é“å¯¹å†å²æ˜¯å¦å·²ç»å¤„ç†è¿‡ç›¸åŒçš„æ‰“å¡è®°å½•çš„åˆ¤æ–­æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ï¼šå¦‚æœä¸‰æ–¹æœ‰å”¯ä¸€æ€§æ ‡è¯†ï¼Œåˆ™ä½¿ç”¨å”¯ä¸€æ€§æ ‡è¯†ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç”¨æˆ·å+æ—¶é—´æ„æˆå”¯ä¸€æ€§æ ‡è¯† ï¼Œ ç›®å‰é£ä¹¦ç”¨çš„æ˜¯å¤–éƒ¨å”¯ä¸€æ ‡è¯† 

4. ä¸­æ§è€ƒå‹¤æœºç”±äºåœ¨æ•°æ®å›å†™è¿‡ç¨‹ä¸­çš„æµç¨‹å’Œä¸‰æ–¹æ¸ é“ç±»ä¼¼ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯é‡‡ç”¨çš„è¿™ç§ç±»ä¼¼æ–¹å¼ï¼šå°†è°ƒç”¨mobileçš„æ•°æ®æ‹‰å–æ¥å£æ›´æ¢ä¸ºè°ƒç”¨ä¸­æ§æœåŠ¡åœ°å€ï¼›æ•°æ®æ‹‰å–åˆ°åï¼Œå°†æ•°æ®æ„é€ æˆmobileçš„æ‰“å¡æ•°æ®å†…å®¹ï¼Œå‘é€åˆ°åŒtopicä¸‹ã€‚åç»­å¡æ•°æ®å¤„ç†æµç¨‹ä¸€è‡´

é—®é¢˜ï¼š

1. ä¸‰æ–¹æ¸ é“çš„æ‰“å¡æ—¶é—´åœ¨è½æ‰“å¡è®°å½•è¡¨æ—¶ï¼Œè¢«æŠ¹å»äº†ç§’â†’ å¯¼è‡´çš„é—®é¢˜ï¼šç”¨æˆ·å¦‚æœåœ¨ç›¸åŒåˆ†é’Ÿï¼Œä¸åŒç§’æ—¶é—´ä¸‹ï¼Œå¦‚æœè¿›è¡Œäº†å¤šæ¬¡æ‰“å¡ï¼Œåœ¨mokaç³»ç»Ÿä¸Šï¼Œæ— æ³•ä½“ç°ç§’çº§åˆ«
2. ä¸‰æ–¹æ¸ é“é€šå¸¸éƒ½ä¼šæœ‰è‡ªå·±çš„é™æµæªæ–½ï¼Œè¿™æ ·å°±ä¼šæœ‰ä¸€ä¸ªçŸ›ç›¾ç‚¹ï¼šåŒæ­¥ä»»åŠ¡é¢‘ç‡å¤§(å‘¨æœŸçŸ­)ï¼Œç”¨æˆ·çš„æ‰“å¡æ•°æ®å°±æ›´å®æ—¶ï¼Œä½†æ˜¯è§¦å‘æ¥å£é™æµçš„å‡ ç‡å°±ä¼šå¾ˆå¤§â†’ è§£å†³æ€è·¯ï¼šå¦‚æœä¸‰æ–¹æ¸ é“æ”¯æŒæ•°æ®å›è°ƒï¼Œéœ€è¦æ¥å…¥å›è°ƒã€‚å›è°ƒä½œä¸ºä¸»ï¼Œå®šæ—¶ä»»åŠ¡ä½œä¸ºæ•°æ®æ‹‰å–çš„å¤‡ç”¨ã€‚



---



ä¸‹é¢æˆ‘ä»¬å¯¹ç€ä»£ç èµ°ä¸€éæµç¨‹ï¼Œçœ‹çœ‹æ˜¯å¦‚ä½•æŒ‡å®šæ‰“å¡æ¸ é“ï¼Œå¹¶åŒæ­¥è¯¥æ¸ é“çš„æ•°æ®ï¼š

ä»£ç å…¥å£åœ¨ï¼š `hcm-absence-clock`ä¸‹çš„`SyncClockInRecordController.java`ä¸‹ï¼š

1ã€åœ¨é¡µé¢ç‚¹å‡»æ‰“å¡æ•°æ®åŒæ­¥æ—¶ï¼Œå¯ä»¥é€‰æ‹©å¤šä¸ªæ¸ é“ï¼Œæ¯”å¦‚æ•°æ®æ¥æºé€‰æ‹© **åŒæ­¥é£ä¹¦ï¼š**
![image.png](https://cdn.nlark.com/yuque/0/2023/png/34673482/1699604849286-5e0b6599-75de-4aa9-92e5-a4ab92598f80.png#averageHue=%23b4e495&clientId=ued10d878-99c2-4&from=paste&height=774&id=Em8qv&originHeight=1548&originWidth=3238&originalType=binary&ratio=2&rotation=0&showTitle=false&size=458970&status=done&style=none&taskId=u4474ffad-8f30-4290-94b3-57a6141989d&title=&width=1619)

å¯ä»¥çœ‹åˆ°  `clockInChannel`çš„`value`å€¼ä¸º3 ï¼Œè¯´æ˜æ¯ä¸€ä¸ª`clockChannel`å‡å…³è”ä¸€ä¸ªç‰¹å®šçš„æ¸ é“ï¼Œæˆ‘ä»¬èµ°å…¥æ‰“å¡çš„å…¥å£urlï¼ˆ`/api/abs/clock/v1/channel/record/sync`ï¼‰ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š

```java
@ApiOperation("åŒæ­¥æ¸ é“æ‰“å¡æ•°æ®")
@PostMapping("/sync")
ResultDto<Void> sync(@RequestBody @Validated ApiSyncClockInDataParamDto param, @ApiIgnore CurrentUserDto currentUser) {
    if (param.getStartDate().after(param.getEndDate())) {
        throw new CustomException(ErrorCodeEnum.INVALID_PARAMS.getCode(), "å¼€å§‹æ—¶é—´ä¸èƒ½å°äºç»“æŸæ—¶é—´");
    }
    Long entId = currentUser.getEntId();
    Long buId = currentUser.getBuid();
    SyncTypeEnum syncClockInChannel = param.getClockInChannel();

    //ä¸‰æ–¹æ¸ é“è®°å½•åœ¨mobileä¸­ï¼Œæ‰€ä»¥è¿™é‡Œåªåˆ¤æ–­ä¸‰æ–¹æ¸ é“çš„ï¼›ä¸­æ§å†…éƒ¨æ–¹æ³•æœ‰åˆ¤æ–­
    boolean isThirdChannel = isThirdChannel(syncClockInChannel);
    if (isThirdChannel) {
        List<EntCheckInChannelDto> entCheckInChannelDtoList = hcmAbsenceClockSyncServiceAdapter.list3rdCheckInEnt(entId, buId, false);
        boolean notValidChannel = !isValidThirdChannel(entCheckInChannelDtoList, syncClockInChannel);
        if (notValidChannel) {
            String syncClockInChannelDesc = syncClockInChannel.getDesc();
            log.error("ä¼ä¸šæœªå¼€é€š" + syncClockInChannelDesc + "æˆ–æœªå¼€å¯" + syncClockInChannelDesc + "æ‰“å¡");
            return ResultDto.success();
        }
    }

    //è·å–æŒ‡å®šæ¸ é“çš„å¤„ç†æ–¹æ³•,å°è£…åŒæ­¥æ‰“å¡æ•°æ®çš„å‚æ•°å¹¶ä¼ å…¥
    channelClockInThreadPool.execute(() ->
                                     syncClockInRecordFactory.getClockInRecordSyncReqService(param.getClockInChannel())
                                     .syncChannelClockInData(SyncClockInDataArg.fromApiSyncParam(param, currentUser))
                                    );
    return ResultDto.success();
}


```

ä¼ å…¥çš„`ApiSyncClockInDataParamDto`æœ‰ä¸€ä¸ªå†…éƒ¨å±æ€§`SyncTypeEnum`ï¼Œè¯¥æšä¸¾ç±»åŒ…å«äº†æ‰€æœ‰æ¸ é“ç±»å‹

```java
@Getter
@AllArgsConstructor
public enum SyncTypeEnum {

    /**
     * @see com.moka.hcm.mobile.client.enums.ImCheckInChannelEnum
     */
    DINGDING(1, "é’‰é’‰æ‰“å¡", "dingding"),
    WEIXIN(2, "ä¼ä¸šå¾®ä¿¡", "wechat"),
    LARK(3, "é£ä¹¦", "lark"),

    /**
     * è€ƒå‹¤æœºç›¸å…³
     */
    TEN_MOONS(4, "å¤©æ•è€ƒå‹¤æœº", "10moons"),
    ZKTECO_CLOUD(5, "ä¸­æ§äº‘è€ƒå‹¤æœº", "zktecocloud"),
    DINGDING_CHECKIN(ImCheckInChannelEnum.DINGDING_CHECKIN.getChannel(),"é’‰é’‰ç­¾åˆ°","dingding_checkin"),

    INTERFACE_SYNC(7, "æ¥å£åŒæ­¥", "openapi-interface"),
    ZKTECO_CLIENT(8,"ä¸­æ§ç»ˆç«¯è€ƒå‹¤æœº","zkteco_client"),
    ;

    @JsonValue
    private int code;
    private String desc;
    private String value;

```


æ³¨æ„è¿™è¡Œä»£ç ï¼š

```java
syncClockInRecordFactory.getClockInRecordSyncReqService(param.getClockInChannel())
        .syncChannelClockInData(SyncClockInDataArg.fromApiSyncParam(param, currentUser))
```

æ ¹æ®`param`ä¸­ä¼ å…¥çš„`channel`å€¼æ¥è·å–å¯¹åº”çš„`service`ï¼ˆå·¥å‚æ¨¡å¼çš„ä½“ç°ï¼‰ï¼Œç„¶åè°ƒç”¨è¯¥`service`ä¸‹çš„`syncChannelClockInData`æ–¹æ³•æ¥å¤„ç†

![image.png](https://cdn.nlark.com/yuque/0/2023/png/34673482/1699861289573-74fb1dd1-5f34-4e0f-ad35-082e23ee9b77.png#averageHue=%23f6f6f6&clientId=u9ef19e6c-d0f4-4&from=paste&height=601&id=u965d84c3&originHeight=1202&originWidth=2136&originalType=binary&ratio=2&rotation=0&showTitle=false&size=280767&status=done&style=none&taskId=u158e7f5a-bd37-492d-9eb3-c1cc72e9944&title=&width=1068)

è¿™é‡Œçš„æ•°æ®åŒæ­¥å°±æ¶‰åŠåˆ°äº†å¤šç§åŒæ­¥æ–¹å¼(åŒæ­¥è€ƒå‹¤æœºã€å®šæ—¶ä»»åŠ¡å®šæ—¶æ‹‰å–ã€PCç«¯æ‰‹åŠ¨å¯¼å…¥),ä¸‹é¢å…ˆä»‹ç»å®šæ—¶ä»»åŠ¡åŒæ­¥æ–¹å¼





### 1.1 å®šæ—¶ä»»åŠ¡ è®¾ç½®jobHandler

å¯¹åº”xxl-jobçš„ç•Œé¢ä¸ºï¼š

![image-20231206172125908](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312061721014.png)



å…¶ä¸­Cronè¡¨è¾¾å¼ä¸ºï¼š ==0 0/10 * * * ?==   

> è¿™ä¸ª Cron è¡¨è¾¾å¼ `0 0/10 * * * ?` è¡¨ç¤ºæ¯éš”10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚è§£æå¦‚ä¸‹ï¼š
>
> - ç¬¬ä¸€ä¸ªå­—æ®µï¼ˆç§’ï¼‰ï¼š0ï¼Œè¡¨ç¤ºåœ¨æ¯åˆ†é’Ÿçš„ç¬¬ 0 ç§’æ‰§è¡Œã€‚
> - ç¬¬äºŒä¸ªå­—æ®µï¼ˆåˆ†ï¼‰ï¼š0/10ï¼Œè¡¨ç¤ºæ¯éš” 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚
> - ç¬¬ä¸‰ä¸ªå­—æ®µï¼ˆå°æ—¶ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å°æ—¶éƒ½æ‰§è¡Œã€‚
> - ç¬¬å››ä¸ªå­—æ®µï¼ˆæ—¥ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯æœˆéƒ½æ‰§è¡Œã€‚
> - ç¬¬äº”ä¸ªå­—æ®µï¼ˆæœˆï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å‘¨éƒ½æ‰§è¡Œã€‚
> - ç¬¬å…­ä¸ªå­—æ®µï¼ˆæ˜ŸæœŸï¼‰ï¼š?ï¼Œè¡¨ç¤ºä¸æŒ‡å®šæ˜ŸæœŸã€‚
> - ç¬¬ä¸ƒä¸ªå­—æ®µï¼ˆå¹´ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å¹´éƒ½æ‰§è¡Œã€‚
>
> å› æ­¤ï¼Œè¿™ä¸ªè¡¨è¾¾å¼è¡¨ç¤ºæ¯éš”10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼Œæ— è®ºæ˜¯å“ªä¸€å¤©ï¼Œå“ªä¸€ä¸ªæœˆï¼Œå“ªä¸€å¹´ã€‚

å†çœ‹ä¸¤ä¸ªä¾‹å­ï¼š

ä¾‹å­1   ==0 30 1 * * ?==	

è¿™ä¸ª Cron è¡¨è¾¾å¼ `0 30 1 * * ?` è¡¨ç¤ºåœ¨æ¯å¤©çš„å‡Œæ™¨1ç‚¹30åˆ†æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚è§£æå¦‚ä¸‹ï¼š

- ç¬¬ä¸€ä¸ªå­—æ®µï¼ˆç§’ï¼‰ï¼š0ï¼Œè¡¨ç¤ºåœ¨æ¯åˆ†é’Ÿçš„ç¬¬ 0 ç§’æ‰§è¡Œã€‚
- ç¬¬äºŒä¸ªå­—æ®µï¼ˆåˆ†ï¼‰ï¼š30ï¼Œè¡¨ç¤ºåœ¨æ¯å°æ—¶çš„ç¬¬ 30 åˆ†é’Ÿæ‰§è¡Œã€‚
- ç¬¬ä¸‰ä¸ªå­—æ®µï¼ˆå°æ—¶ï¼‰ï¼š1ï¼Œè¡¨ç¤ºåœ¨æ¯å¤©çš„ç¬¬ 1 å°æ—¶æ‰§è¡Œã€‚
- ç¬¬å››ä¸ªå­—æ®µï¼ˆæ—¥ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯æœˆéƒ½æ‰§è¡Œã€‚
- ç¬¬äº”ä¸ªå­—æ®µï¼ˆæœˆï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å‘¨éƒ½æ‰§è¡Œã€‚
- ç¬¬å…­ä¸ªå­—æ®µï¼ˆæ˜ŸæœŸï¼‰ï¼š?ï¼Œè¡¨ç¤ºä¸æŒ‡å®šæ˜ŸæœŸã€‚
- ç¬¬ä¸ƒä¸ªå­—æ®µï¼ˆå¹´ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å¹´éƒ½æ‰§è¡Œã€‚

å› æ­¤ï¼Œè¿™ä¸ªè¡¨è¾¾å¼è¡¨ç¤ºåœ¨æ¯å¤©å‡Œæ™¨1ç‚¹30åˆ†æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ï¼Œæ— è®ºæ˜¯å“ªä¸€å¤©ï¼Œå“ªä¸€ä¸ªæœˆï¼Œå“ªä¸€å¹´ã€‚





ä¾‹å­2   ==0 30 5,11,17,23 * * ?==	

![image-20231206172959225](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312061730313.png)

è¿™ä¸ª Cron è¡¨è¾¾å¼ `0 30 5,11,17,23 * * ?` è¡¨ç¤ºåœ¨æ¯å¤©çš„å‡Œæ™¨5ç‚¹30åˆ†ã€11ç‚¹30åˆ†ã€ä¸‹åˆ5ç‚¹30åˆ†ã€æ™šä¸Š11ç‚¹30åˆ†å„æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚è§£æå¦‚ä¸‹ï¼š

- ç¬¬ä¸€ä¸ªå­—æ®µï¼ˆç§’ï¼‰ï¼š0ï¼Œè¡¨ç¤ºåœ¨æ¯åˆ†é’Ÿçš„ç¬¬ 0 ç§’æ‰§è¡Œã€‚
- ç¬¬äºŒä¸ªå­—æ®µï¼ˆåˆ†ï¼‰ï¼š30ï¼Œè¡¨ç¤ºåœ¨æ¯å°æ—¶çš„ç¬¬ 30 åˆ†é’Ÿæ‰§è¡Œã€‚
- ç¬¬ä¸‰ä¸ªå­—æ®µï¼ˆå°æ—¶ï¼‰ï¼š5,11,17,23ï¼Œè¡¨ç¤ºåœ¨æ¯å¤©çš„ç¬¬ 5, 11, 17, 23 å°æ—¶æ‰§è¡Œã€‚
- ç¬¬å››ä¸ªå­—æ®µï¼ˆæ—¥ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯æœˆéƒ½æ‰§è¡Œã€‚
- ç¬¬äº”ä¸ªå­—æ®µï¼ˆæœˆï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å‘¨éƒ½æ‰§è¡Œã€‚
- ç¬¬å…­ä¸ªå­—æ®µï¼ˆæ˜ŸæœŸï¼‰ï¼š?ï¼Œè¡¨ç¤ºä¸æŒ‡å®šæ˜ŸæœŸã€‚
- ç¬¬ä¸ƒä¸ªå­—æ®µï¼ˆå¹´ï¼‰ï¼š*ï¼Œè¡¨ç¤ºæ¯å¹´éƒ½æ‰§è¡Œã€‚

å› æ­¤ï¼Œè¿™ä¸ªè¡¨è¾¾å¼è¡¨ç¤ºåœ¨æ¯å¤©çš„å‡Œæ™¨5ç‚¹30åˆ†ã€11ç‚¹30åˆ†ã€ä¸‹åˆ5ç‚¹30åˆ†ã€æ™šä¸Š11ç‚¹30åˆ†å„æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡ã€‚





åœ¨è¿™ä¸ªç±»ä¸­ï¼Œ`scheduleTaskRun` æ–¹æ³•å°±æ˜¯æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„åœ°æ–¹ï¼Œæ–¹æ³•å†…éƒ¨é€šè¿‡è°ƒç”¨ `clockInRecordTaskSyncService` çš„ `syncChannelClockInData` æ–¹æ³•ï¼Œä¼ å…¥æ„å»ºå¥½çš„å‚æ•°å¯¹è±¡ï¼Œæ‰§è¡Œå®é™…çš„åŒæ­¥æ“ä½œ

```java
@Service
@Slf4j
@JobHandler("sync3rdClockInRecordJobHandler")
public class Sync3rdClockInRecordJobHandler extends LoopScheduleTaskImplementModule {

    @Resource
    private ClockInRecordTaskSyncServiceImpl clockInRecordTaskSyncService;

    private String AUTO_CALCULATE_APOLLO_KEY = "sync-clock-record-auto-calculate";

    @Override
    public void scheduleTaskRun(Long entId, Long buId, Map<String, String> otherParam) {
        log.info("syncClockInRecordTask start....entId : {}, buId : {}, param : {}",
                 entId, buId, JacksonUtils.toJson(otherParam));

        String traceId = UUID.randomUUID().toString().replace("-", "");
        MDC.put(CommonConstants.TRACE_ID, traceId);

        SyncClockInDataArg arg = buildDefaultArg();
        arg.setEntId(entId);
        arg.setBuId(buId);
        SyncClockInRecordTaskParam param = null;
        if (MapUtils.isNotEmpty(otherParam)) {
            try {
                param = JacksonUtils.parse(JacksonUtils.toJson(otherParam), SyncClockInRecordTaskParam.class);
            } catch (Exception e) {
                log.error("syncClockInRecordTask task param fromJson failed, taskParam : {}", JacksonUtils.toJson(otherParam));
            }
        }
        Boolean syncAllDay = null;
        if (param != null) {
            syncAllDay = param.getSyncAllDay();
            Long entIdParam = param.getEntId();
            Integer channel = param.getChannel();

            // æŒ‡å®šäº†åªåŒæ­¥å›ºå®šçš„ç§Ÿæˆ·
            if (Objects.nonNull(entIdParam) && BooleanUtils.isFalse(entId.equals(entIdParam))) {
                return;
            }
            if (Objects.nonNull(channel)) {
                SyncTypeEnum syncTypeEnum = SyncTypeEnum.fromCode(channel);
                if (syncTypeEnum != null) {
                    arg.setClockInChannel(syncTypeEnum);
                }
            }
        }
        if (BooleanUtils.isTrue(syncAllDay)) {
            DateTime now = DateTime.now().withTime(8, 0, 0, 0);
            Date endDate = now.toDate();
            Date startDate = now.minusDays(1).withTime(0, 0, 0, 0).toDate();
            log.info("åŒæ­¥æ¸ é“æ‰“å¡,åŒæ­¥æ—¶é—´:{}~{}",
                     DateFormatUtils.format(startDate, DatePattern.YMD), DateFormatUtils.format(endDate, DatePattern.YMD));
            arg.setStartDate(startDate);
            arg.setEndDate(endDate);
            arg.setAutoCalculate(isAutoCalculate());
            // åŒæ­¥å…¨å¤©æ•°æ®éœ€è¦å’ŒæŒ‰æ—¶é—´æ®µçš„ä»»åŠ¡åŒºåˆ†å¼€ï¼Œä¸éœ€è¦å¼€å¯ä¸Šæ‰¹ä»»åŠ¡ç»“æŸæ ¡éªŒï¼Œé˜²æ­¢ä»»åŠ¡é‡å¤å¯¼è‡´æ‹‰å–å‰ä¸€å¤©çš„æ•°æ®å¤±è´¥
            arg.setWaitPreTaskDone(false);
        }
        clockInRecordTaskSyncService.syncChannelClockInData(arg);
    }
```



æ ¹æ®ä¸‹åˆ—ä»£ç å¯ä»¥çœ‹å‡ºï¼šåœ¨xxl-jobä¸­ä¼šå®šæ—¶æ‰§è¡Œ`ClockInRecordTaskSyncServiceImpl`ä¸­çš„æ–¹æ³• ğŸ˜²ğŸ˜²ğŸ˜²


```java
public class ClockInRecordTaskSyncServiceImpl implements ClockInRecordSyncAllChannelReqService {
    @Resource
    private HcmAbsenceClockSyncServiceAdapter hcmAbsenceClockSyncServiceAdapter;

    @Resource
    private SyncClockInRecordFactory factory;


    //åŒæ­¥æ–¹æ³•çš„å…¥å£å¤„ï¼š
    @Override
    public boolean syncChannelClockInData(SyncClockInDataArg arg) {
        Assert.notNull(arg, "åŒæ­¥å‚æ•°ä¿¡æ¯ä¸èƒ½ä¸ºç©º");
        Assert.notNull(arg.getEntId(), "ç§Ÿæˆ·Idä¸èƒ½ä¸ºç©º");
        Assert.notNull(arg.getBuId(), "ç§Ÿæˆ·Idä¸èƒ½ä¸ºç©º");
        Long entId = arg.getEntId();
        Long buId = arg.getBuId();


        //è¿™é‡Œæ­£å¸¸æƒ…å†µä¸‹å…¥å£åªèƒ½æ˜¯å®šæ—¶ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜
        List<EntCheckInChannelDto> entCheckInChannelDtoList = hcmAbsenceClockSyncServiceAdapter.list3rdCheckInEnt(entId, buId, true);//è·å–ä¼ä¸šæ”¯æŒçš„ç¬¬ä¸‰æ–¹æ‰“å¡æ¸ é“åˆ—è¡¨

        if (CollectionUtils.isEmpty(entCheckInChannelDtoList)) {
            log.info("æœªæŸ¥è¯¢åˆ°å¼€å¯ç¬¬åŒæ­¥ä¸‰æ–¹æ‰“å¡çš„ç§Ÿæˆ· entId: {}", entId);
            return true;
        }

        SyncTypeEnum syncTypeEnum = arg.getClockInChannel();
        for (EntCheckInChannelDto entCheckInChannel : entCheckInChannelDtoList) {
            SyncTypeEnum channel = entCheckInChannel.getChannel();
            // å¦‚æœæŒ‡å®šçš„æ¸ é“ï¼Œåˆ™åªåŒæ­¥æŒ‡å®šçš„æ¸ é“
            if (Objects.nonNull(syncTypeEnum) && syncTypeEnum != channel) {
                continue;
            }
            
            //å¦‚æœæ¸ é“ç›¸åŒ¹é…ï¼Œåˆ™æ ¹æ®æ‰“å¡æ¸ é“ç±»å‹ channel è·å–ç›¸åº”çš„ ClockInRecordSyncReqService å®ä¾‹
            ClockInRecordSyncReqService clockInRecordSyncService = factory.getClockInRecordSyncReqService(channel);
            SyncClockInDataArg entArg = new SyncClockInDataArg();
            BeanUtils.copyProperties(arg, entArg);
            entArg.setClockInChannel(channel);

            //è°ƒç”¨ ClockInRecordSyncServiceDateWrapper ç±»çš„ syncChannelClockInData(entArg) æ–¹æ³•ï¼Œå°†æ‰“å¡æ•°æ®åŒæ­¥ç»™ç›¸åº”çš„æ‰“å¡æ¸ é“æœåŠ¡
            new ClockInRecordSyncServiceDateWrapper(clockInRecordSyncService).syncChannelClockInData(entArg);
        }
        return true;
    }
}
```

æ³¨æ„`list3rdCheckInEnt()`æ–¹æ³•ï¼š

```java
public List<EntCheckInChannelDto> list3rdCheckInEnt(Long entId, Long buId, boolean loadFromCacheFirst) {
    String entCheckInChannelRedisKey = buildEntCheckInChannelRedisKey(entId, buId);
    List<EntCheckInChannelDto> entCheckInChannelDtoList = null;

    if (loadFromCacheFirst) {
        String queryEntCheckInChannelDtoListValueFromRedis = redisTemplate.opsForValue().get(entCheckInChannelRedisKey);
        if (StringUtils.isNotBlank(queryEntCheckInChannelDtoListValueFromRedis)) {
            entCheckInChannelDtoList = JacksonUtils.parse(queryEntCheckInChannelDtoListValueFromRedis, new TypeReference<List<EntCheckInChannelDto>>() {
            });
            return entCheckInChannelDtoList;
        }
    }

    List<EntCheckInChannel> entCheckInChannelList = hcmAbsenceClockInService.list3rdCheckInEnt(entId, buId);
    log.info("list3rdCheckInEnt resp:{}", JacksonUtils.toJson(entCheckInChannelList));
    entCheckInChannelDtoList = EntCheckInChannelDto.entCheckInChannel2Dto(entCheckInChannelList);//å°†è·å–çš„ EntCheckInChannel åˆ—è¡¨è½¬æ¢ä¸º EntCheckInChannelDto åˆ—è¡¨

    String queryEntCheckInChannelDtoListValue = JacksonUtils.toJson(entCheckInChannelDtoList);
    redisTemplate.opsForValue().set(entCheckInChannelRedisKey, queryEntCheckInChannelDtoListValue, 5, TimeUnit.MINUTES);

    return entCheckInChannelDtoList;

}
```



è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªç”±`EntCheckInChannel`åˆ°`EntCheckInChannelDto`çš„ç±»å‹è½¬æ¢é—®é¢˜ï¼š

```java
/**
     * EntCheckInChannel è½¬åŒ–ä¸º  EntCheckInChannelDto
     * @param sources åŸå§‹æ•°æ®
     * @return List<EntCheckInChannelDto>
     */
public static List<EntCheckInChannelDto> entCheckInChannel2Dto(List<EntCheckInChannel> sources) {
    List<EntCheckInChannelDto> returnList = Lists.newArrayList();
    if (CollectionUtils.isEmpty(sources)) {
        return returnList;
    }
    for (EntCheckInChannel entCheckInChannel : sources) {
        returnList.add(entCheckInChanel2Dto(entCheckInChannel));
    }
    return returnList;
}
/**
     * EntCheckInChannel è½¬åŒ–ä¸º  EntCheckInChannelDto
     * @param source åŸå§‹æ•°æ®
     * @return List<EntCheckInChannelDto>
     */
private static EntCheckInChannelDto entCheckInChanel2Dto(EntCheckInChannel source) {
SyncTypeEnum channel = Optional.ofNullable(source.getImCheckInChannel()).map(imCheckInChannelEnum -> SyncTypeEnum.fromCode(imCheckInChannelEnum.getChannel())).orElse(null);
return EntCheckInChannelDto.builder()
.entId(source.getEntId())
.buId(source.getBuId())
.channel(channel)
.build();
}
```

ä¸Šè¿°ä»£ç ç”¨åˆ°äº†`java8`ä¸­çš„`Optional`ï¼ˆå¼€å‘ä¸­å¾ˆå¸¸ç”¨ï¼‰

å…¶ä¸­ï¼Œ`Optional.ofNullable(source.getImCheckInChannel())`ç”¨æ¥ä¼˜é›…å¤„ç†`NullPointerException`é—®é¢˜ï¼›
`ImCheckInChannelEnum.map(imCheckInChannelEnum -> SyncTypeEnum.fromCode(imCheckInChannelEnum.getChannel()))` åœ¨æ˜ å°„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨ imCheckInChannelEnum.getChannel() æ–¹æ³•è·å–æ‰“å¡æ¸ é“çš„ä»£ç ï¼Œç„¶åä½¿ç”¨ SyncTypeEnum.fromCode() æ–¹æ³•å°†ä»£ç è½¬æ¢ä¸ºç›¸åº”çš„ SyncTypeEnum æšä¸¾å€¼ã€‚å¦‚æœè½¬æ¢æˆåŠŸï¼Œè¿”å›è½¬æ¢åçš„æšä¸¾å€¼ï¼›
è¿™æ˜¯å› ä¸º` ImCheckInChannelEnum`å’Œ `SyncTypeEnum`ä¸¤ä¸ªæšä¸¾ç±»å¯¹åº”çš„valueä¸ä¸€è‡´ï¼Œéœ€è¦è¿›è¡ŒåŒæ­¥ ï¼š

```java
public enum SyncTypeEnum {

    /**
     * @see com.moka.hcm.mobile.client.enums.ImCheckInChannelEnum
     */
    DINGDING(1, "é’‰é’‰æ‰“å¡", "dingding"),
    WEIXIN(2, "ä¼ä¸šå¾®ä¿¡", "wechat"),
    LARK(3, "é£ä¹¦", "lark"),

    /**
     * è€ƒå‹¤æœºç›¸å…³
     */
    TEN_MOONS(4, "å¤©æ•è€ƒå‹¤æœº", "10moons"),
    ZKTECO_CLOUD(5, "ä¸­æ§äº‘è€ƒå‹¤æœº", "zktecocloud"),
    DINGDING_CHECKIN(ImCheckInChannelEnum.DINGDING_CHECKIN.getChannel(),"é’‰é’‰ç­¾åˆ°","dingding_checkin"),

    INTERFACE_SYNC(7, "æ¥å£åŒæ­¥", "openapi-interface"),
    ZKTECO_CLIENT(8,"ä¸­æ§ç»ˆç«¯è€ƒå‹¤æœº","zkteco_client"),
    ;
}


---------------


public enum ImCheckInChannelEnum {
    DINGDING_CHECKIN(ImTypeEnum.DINGDING.getCode(), "é’‰é’‰ç­¾åˆ°", 6),
    DINGDING(ImTypeEnum.DINGDING.getCode(), "é’‰é’‰æ‰“å¡", 1),
    WEIXIN(ImTypeEnum.WEIXIN.getCode(), "ä¼ä¸šå¾®ä¿¡", 2),
    LARK(ImTypeEnum.LARK.getCode(), "é£ä¹¦æ‰“å¡", 3);
}
```

ç„¶åå›åˆ°æ ¸å¿ƒåŒæ­¥çš„é€»è¾‘å¤„ï¼š
`new ClockInRecordSyncServiceDateWrapper(clockInRecordSyncService).syncChannelClockInData(entArg);`   è¿™é‡Œéœ€è¦æ³¨æ„å®é™…è°ƒç”¨çš„æ–¹æ³•æ˜¯`AbstractChannelClockInRecordSyncService`ä¸­çš„`syncChannelClockInData`æ–¹æ³•ï¼š
![image.png](https://cdn.nlark.com/yuque/0/2023/png/34673482/1699863257445-143bbceb-ec12-4f72-aef7-3400236e67b3.png#averageHue=%23f2f1f1&clientId=u9ef19e6c-d0f4-4&from=paste&height=554&id=u0b5f44ff&originHeight=1108&originWidth=2556&originalType=binary&ratio=2&rotation=0&showTitle=false&size=438677&status=done&style=none&taskId=u13b18a6a-80dd-43af-83c8-d12d2bdf978&title=&width=1278)

> è¿™æ˜¯ä¸ºä»€ä¹ˆâ“â“





è¯¥æŠ½è±¡ç±»ä¸­çš„`syncChannelClockInData`æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š

```java
@Transactional(rollbackFor = Exception.class)
@Override
public boolean syncChannelClockInData(SyncClockInDataArg arg) {
log.info("å¼€å§‹æ‰§è¡ŒåŒæ­¥æ‰“å¡æ•°æ®ä»»åŠ¡,è¯·æ±‚å‚æ•°:{}", JacksonUtils.toJson(arg));
arg.check();
Long entId = arg.getEntId();
Long buId = arg.getBuId();
SyncTypeEnum syncTypeEnum = arg.getClockInChannel();


//å±è”½é»‘åå•ç§Ÿæˆ·
List<Long> blackEntList = getBlackEntList();
if (blackEntList.contains(entId)) {
    log.warn("ä¼ä¸šä¸å…è®¸è¿›è¡Œæ‰“å¡æ•°æ®åŒæ­¥, entId:" + entId + ", blackEntList:" + JacksonUtils.toJson(blackEntList));
    return true;
}

List<SyncTypeEnum> blackChannelList = getBlackChannelList();
if (blackChannelList.contains(syncTypeEnum)) {
    log.warn("ä¸å…è®¸å½“å‰æ¸ é“çš„æ‰“å¡æ•°æ®åŒæ­¥, entId:" + entId + ", channel:" + syncTypeEnum + ", blackChannelList:" + JacksonUtils.toJson(blackChannelList));
    return true;
}

Date syncStartDate = arg.getStartDate();
Date syncEndDate = DateUtil.getMaxTimeOfDay(arg.getEndDate());

EntDto entDto = EntDto.builder().entId(entId).buId(buId).build();

//é€šè¿‡ç§Ÿæˆ·ä¿¡æ¯è·å–è¯¥ç§Ÿæˆ·ä¸‹çš„å…¨é‡å‘˜å·¥ä¿¡æ¯
List<EmployeeInfoDto> employeeInfoDtoList = hrJobInfoAdapter.getEmployeesByEnt(entDto, true);

//è¿‡æ»¤æ‰åŒæ­¥æ—¥æœŸå‰å¤šå°‘å¤©ç¦»èŒçš„å‘˜å·¥ï¼Œä¸ç”¨å†æ‹‰å–è¿™äº›å‘˜å·¥çš„æ•°æ®
List<Long> employeeIds = SyncEmployeeFilter.filterValidEmployee(entId,buId,employeeInfoDtoList, syncStartDate);


if (CollectionUtils.isEmpty(employeeIds)) {
    log.info("æœªæŸ¥è¯¢åˆ° ent:{}, buId:{} å‘˜å·¥ä¿¡æ¯,{}æ‰“å¡è®°å½•åŒæ­¥ç»“æŸ.", entId, buId, getChannelDesc());
    return true;
}

// æ ¡éªŒä¸Šæ¬¡ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
if (BooleanUtils.isTrue(arg.getWaitPreTaskDone()) && !preTaskDone(entId, buId, arg.getClockInChannel(), employeeIds)) {
    return false;
}

//å°†åŒæ­¥æ—¥æœŸèŒƒå›´æ‹†åˆ†ä¸ºå¤šä¸ªæ—¶é—´æ®µ
List<DateScope> dateScopes = DateUtil.partition(syncStartDate, syncEndDate, getMaxSyncDay());
log.info("æ—¶é—´æ‹†åˆ†åä¸ºï¼š{}", JacksonUtils.toJson(dateScopes));


//ç”ŸæˆtransId
String transId = arg.buildTransId();

// ä¿å­˜ log
syncLogService.save(buildDingTalkSyncLog(arg, new Date(), transId));


/*
* é’ˆå¯¹æ¯ä¸ªæ—¶é—´æ®µï¼Œæ„å»ºåŒæ­¥æ‰“å¡è®°å½•çš„è¯·æ±‚å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨é€‚é…å™¨å¯¹è±¡ 
* hcmAbsenceClockSyncServiceAdapter å¼‚æ­¥è°ƒç”¨æ‰“å¡è®°å½•çš„åŒæ­¥æ–¹æ³•
* asyncPull3rdCheckInRecord()
*/
for (DateScope dateScope : dateScopes) {
    SyncChannelClockRecordReqDto syncChannelClockRecordReqDto = buildSyncChannelClockRecordReqDto(entId, buId, employeeIds, transId, dateScope);
    log.info("asyncPull3rdCheckInRecord ,syncChannelClockRecordReqDto:{}", syncChannelClockRecordReqDto);
    hcmAbsenceClockSyncServiceAdapter.asyncPull3rdCheckInRecord(syncChannelClockRecordReqDto);
}
return true;
}
```



çœŸæ­£æ‰§è¡Œæ‰“å¡æ•°æ®åŒæ­¥çš„é€»è¾‘åœ¨ `syncChannelClockInData`() æ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨é€‚é…å™¨å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œå¼‚æ­¥æ‰“å¡è®°å½•åŒæ­¥ï¼š

```java
public class HcmAbsenceClockSyncServiceAdapterImpl implements HcmAbsenceClockSyncServiceAdapter {

    @Override
    public void asyncPull3rdCheckInRecord(SyncChannelClockRecordReqDto syncChannelClockRecordReqDto) {

        //è·å–æ‰“å¡åŒæ­¥æ—¥æœŸåŒºé—´
        DateScope syncDateScope = syncChannelClockRecordReqDto.getDateScope(); 
      
        SyncTypeEnum syncChannelType = syncChannelClockRecordReqDto.getChannel();
        Long entId = syncChannelClockRecordReqDto.getEntId();
        Long buId = syncChannelClockRecordReqDto.getBuId();
        PullChannelCheckInRecordReq pullChannelCheckInRecordReq = PullChannelCheckInRecordReq.builder()
        .entId(entId)
        .buId(buId)
        .startDate(syncDateScope.getStartDate())
        .endDate(syncDateScope.getEndDate())
        .employeeIds(syncChannelClockRecordReqDto.getEmployeeIds())
        .checkInChannel(ImCheckInChannelEnum.getEnumByChannelCode(syncChannelType.getCode()))
        .transId(syncChannelClockRecordReqDto.getTransId())
        .build();
        try {
            log.info("asyncPull3rdCheckInRecord req:{}", JacksonUtils.toJson(pullChannelCheckInRecordReq));
            BaseResult result = hcmAbsenceClockInService.asyncPull3rdCheckInRecord(pullChannelCheckInRecordReq);
            if (!result.isSuccess()) {
                log.warn("asyncPull3rdCheckInRecord failed, result:{}", JacksonUtils.toJson(result));
            }
        } catch (Exception e) {
            log.error("åŒæ­¥" + syncChannelType.getDesc() + "æ‰“å¡æ•°æ®å¼‚å¸¸,ent:{}, buId:{}.", entId, buId, e);
        }
    }
}
```



----

![image-20231123141647483](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231421866.png)







==åªå…³æ³¨æ ¸å¿ƒé€»è¾‘==ï¼š 

`BaseResult result = hcmAbsenceClockInService.asyncPull3rdCheckInRecord(pullChannelCheckInRecordReq);`
ä¼šå‘ç°ï¼š

1ã€è¯¥æ–¹æ³•é¦–å…ˆä¼šè°ƒç”¨ **hcm-mobile-client æ¨¡å—**ä¸‹çš„`pull3rdCheckInRecord`æ–¹æ³•ï¼š

![image-20231123142739396](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231427658.png)



2ã€ç„¶åé€šè¿‡`openFeign`è¿œç¨‹è°ƒç”¨ ==hcm-mobile==æ¨¡å—ä¸‹çš„	ï¼š

![image-20231123142528733](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231425993.png)





å…¶å…¥å£urlåœ¨ `hcmâ€”â€”mobile`ä¸‹ï¼š

> /client/api/mobile/absence/pull3rdCheckInRecord



3ã€ `hcm-mobile`ä¸‹å¯¹åº”çš„`controller`åŠ`service`ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * æ‹‰å–ä¸‰æ–¹æ‰“å¡æ•°æ®
 *
 * @param pullChannelCheckInRecordReq æ‹‰å–
 * @return æ‹¼è£…åçš„ç¬¬ä¸‰æ–¹æ‰“å¡æ•°æ®
 */
@PostMapping(value = "/absence/pull3rdCheckInRecord", produces = "application/json")
BaseResult pull3rdCheckInRecord(@RequestBody PullChannelCheckInRecordReq pullChannelCheckInRecordReq,CurrentUserDto currentUserDto) {
  return absenceService.pull3rdCheckInRecord(pullChannelCheckInRecordReq,currentUserDto);
}




/*
 * HcmAbsenceServiceImpl.pull3rdCheckInRecordçš„æ–¹æ³•å®ç°
 */
public BaseResult pull3rdCheckInRecord(PullChannelCheckInRecordReq req, CurrentUserDto currentUserDto) {
  //è·å–requestä¸­æ‰“å¡æ¸ é“å¯¹åº”çš„æšä¸¾ç±»å‹
  ImCheckInChannelEnum imCheckInChannel = req.getCheckInChannel();
  if (Objects.isNull(imCheckInChannel)) {
    return BaseResult.buildResult(ErrorCodeEnum.SYS_INVALID_PARAMS);
  }

  //å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹åº”æ‰“å¡æ¸ é“çš„serviceâ€”â€”æ ¹æ®ä¸åŒçš„ ImTypeEnum åˆ›å»ºç›¸åº”çš„ HcmImEntService å®ä¾‹
  HcmImEntService<?> hcmImEntService = HcmMobileEntServiceFactory.createHcmImEntService(imCheckInChannel.getImType());

    /**
     * æ ¹æ®ç§Ÿæˆ·æŸ¥è¯¢å¯¹åº”æ¸ é“çš„æ‰“å¡æ•°æ®åŒæ­¥æ˜¯å¦å¼€å¯
     */
  List<EntCheckInChannel> absenceModes = hcmImEntService.getAbsenceModeNew(req.getEntId(), req.getBuId());
  log.info("search entId -{} buId - {} ent check in channel :{}", req.getEntId(), req.getBuId(), JsonUtils.toJsonString(absenceModes));
  if (CollectionUtils.isEmpty(absenceModes)) {
    log.info("æ‰“å¡æ•°æ®åŒæ­¥å¼€å…³æœªå¼€å¯ï¼šent:{},channel:{}", req.getEntId(), JacksonUtils.toJson(req.getCheckInChannel()));
    return BaseResult.buildResult(ErrorCodeEnum.PUNCH_DATA_SWITCH_CLOSE);
  }
  boolean switchFlag = false;
  for (EntCheckInChannel absenceMode : absenceModes) {
    if (absenceMode.getImCheckInChannel().equals(imCheckInChannel)) {
      switchFlag = true;
    }
  }
  if (!switchFlag) {
    log.info("æ‰“å¡æ•°æ®åŒæ­¥å¼€å…³æœªå¼€å¯ï¼šent:{},channel:{}", req.getEntId(), JacksonUtils.toJson(req.getCheckInChannel()));
    return BaseResult.buildResult(ErrorCodeEnum.PUNCH_DATA_SWITCH_CLOSE);
  }
  
  //åˆæ˜¯å·¥å‚æ¨¡å¼çš„ä½“ç°
  HcmMobileAbsenceService hcmIntegrationService = HcmMobileAbsenceServiceFactory.createHcmMobileAbsenceService(imCheckInChannel);
  
  
  hcmIntegrationService.pullAbsenceData(req, currentUserDto); //æ ¸å¿ƒé€»è¾‘
  return BaseResult.buildResult(ErrorCodeEnum.SUCCESS);
}
```





> æ³¨æ„è¿™é‡Œæ ¹æ®ä¸åŒçš„æ‰“å¡æ¸ é“ï¼Œéœ€è¦æŸ¥è¯¢==å¯¹åº”ç§Ÿæˆ·æ˜¯å¦å¼€å¯äº†å¯¹åº”æ¸ é“çš„æ‰“å¡æ•°æ®åŒæ­¥æ–¹å¼ :exclamation::exclamation:==

![image-20231123144027523](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231440771.png)



ä»¥é’‰é’‰ã€é£ä¹¦ä¸ºä¾‹ï¼š

- [ ] lark:![image-20231123144308274](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231443521.png)



- [ ] DingDing:

  ![image-20231123144413716](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231444977.png)

- [ ] WeiXin: åŒç†



### 1.2 ä¸»åŠ¨Pull æ‹‰å–ç¬¬ä¸‰æ–¹æ¸ é“

 `hcmIntegrationService.pullAbsenceData(req, currentUserDto);` 

![image-20231123145427820](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231454077.png)



#### æ‹‰å–é£ä¹¦æ‰“å¡

æœ‰å‡ ç‚¹æ³¨æ„äº‹é¡¹ï¼š

- `HcmLarkEnt`è¡¨ç¤ºé£ä¹¦ä¸­çš„ä¼ä¸šä¸HCMç§Ÿæˆ·æ˜ å°„å…³ç³»ç±»<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231504505.png" alt="image-20231123150417239" style="zoom: 40%;" />



- åœ¨æ‰§è¡Œæ•°æ®æ‹‰å–æ—¶ä½¿ç”¨äº†è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼ˆé˜»å¡é˜Ÿåˆ—å®¹é‡ä¸º10000ï¼‰ï¼š

  ```java
  /**
   * çº¿ç¨‹æ± 
   */
  private static final ThreadPoolExecutor PUNCH_DATA_SYNC_EXECUTOR = new LogThreadLocalThreadPoolExecutor(20, 20, 60, TimeUnit.SECONDS,
          new ArrayBlockingQueue<>(10000), new NamedThreadFactory("async_pull_punch_data") {
      @Override
      public Thread newThread(Runnable r) {
          Thread thread = super.newThread(r);
          thread.setUncaughtExceptionHandler((t, e) -> log.error("çº¿ç¨‹ {} é‡åˆ°æœªæ•è·çš„å¼‚å¸¸", t.getName(), e));
          return thread;
      }
  }, (r, executor) -> log.error("çº¿ç¨‹ {} å¤„ç†å¤±è´¥", r));
  ```







ç„¶åæˆ‘ä»¬å†æ¥çœ‹é€»è¾‘ä»£ç ï¼š

```java
public void pullAbsenceData(PullChannelCheckInRecordReq req, CurrentUserDto userDto) {
    // log.info("begin pull absence data paramï¼š{}", JsonUtils.toJsonString(req));

    Long entId = req.getEntId();
    Long buId = req.getBuId();
    HcmLarkEnt hcmLarkEnt = hcmLarkEntDao.findByEntId(entId, buId);
    String corpId = hcmLarkEnt.getCorpId();
    // log.info("batchNumber begin async : {} entId :{} buId :{}", batchNumber, entId, buId);
    List<Long> employeeIds = req.getEmployeeIds();
  
    //é£ä¹¦å¼€æ”¾å¹³å°è§„å®šæ¯æ¬¡è°ƒç”¨æœ€å¤š50ä¸ªï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«å¤šä¸ªå­åˆ—è¡¨ï¼ˆå…ƒç´ æ•°é‡ä¸º50ï¼‰çš„åˆ—è¡¨ lists
    List<List<Long>> lists = ListUtils.partition(employeeIds, ImIntegrationConstants.LARK_MAX_COUNT_PULL);
    for (List<Long> list : lists) {
        PUNCH_DATA_SYNC_EXECUTOR.execute(() -> {
            asyncPullPunchData(list, req, corpId);
        });
    }
}
```



è¿›å…¥åˆ° **asyncPullPunchData **æ–¹æ³•ï¼š

```java
public void asyncPullPunchData(List<Long> list, PullChannelCheckInRecordReq req, String corpId) {
    Long entId= req.getEntId();
    accessLimitService.larkAbsenceAcquireByEnt(req.getEntId()); //å¤–éƒ¨æ¥å£è°ƒç”¨é™æµ
    List<HcmLarkUser> hcmLarkUsers = hcmLarkUserDao.findByEmployeeIds(req.getEntId(), req.getBuId(), corpId, list);
    Map<Long, String> employeeIdUserIdMap = hcmLarkUsers.parallelStream()
            .filter(hcmLarkUser -> DataStatusEnum.ENABLE.getStatus() == hcmLarkUser.getBindStatus())
            .collect(Collectors.toMap(HcmLarkUser::getEmployeeId, HcmLarkUser::getUserid, (v1, v2) -> v2));
    List<ChannelCheckInDataRes> resList = new ArrayList<>();
    List<String> userIdList = new ArrayList<>(employeeIdUserIdMap.values());
    List<LarkAttendanceUserFlowRespVO> records = new ArrayList<>();
  
    if (!employeeIdUserIdMap.isEmpty()) {
        records = getPunchRecord(userIdList, req, corpId); //è·å–é£ä¹¦æ‰“å¡è®°å½•
    }
  
  
    Map<String, List<LarkAttendanceUserFlowRespVO>> larkClockRecordMap = records.stream().collect(Collectors.groupingBy(item -> item.getUserId()));//æŒ‰ç”¨æˆ·IDåˆ†ç»„æ‰“å¡è®°å½•ï¼š


    if (!larkClockRecordMap.isEmpty()) {
        log.info("æŸ¥è¯¢åˆ°çš„é£ä¹¦æ‰“å¡æ•°æ®ç»“æœé›† ï¼š{}", JsonUtils.toJsonString(larkClockRecordMap));
    }
  
    // éå†å‘˜å·¥IDåˆ—è¡¨ï¼Œæ„å»ºæ‰“å¡æ•°æ®ç»“æœ
    for (Long employeeId : list) {
        ChannelCheckInDataRes channelCheckInDataRes = new ChannelCheckInDataRes();
        channelCheckInDataRes.setChannel(ImCheckInChannelEnum.LARK);
        channelCheckInDataRes.setBuId(req.getBuId());
        channelCheckInDataRes.setEntId(req.getEntId());
        channelCheckInDataRes.setEmployeeId(employeeId);
        channelCheckInDataRes.setTransId(req.getTransId());
        String userId = employeeIdUserIdMap.get(employeeId);
        if (!StringUtils.isEmpty(userId) && larkClockRecordMap.containsKey(userId)) {
            for (LarkAttendanceUserFlowRespVO larkClockRecord : larkClockRecordMap.get(userId)) {
                ChannelCheckInDataRes channelCheckInDataResSuccess = new ChannelCheckInDataRes();
                BeanUtils.copyProperties(channelCheckInDataRes, channelCheckInDataResSuccess);
                channelCheckInDataResSuccess.setOutsideClock(larkClockRecord.getIsField());
                channelCheckInDataResSuccess.setOutsideRemark(larkClockRecord.getComment());
                channelCheckInDataResSuccess.setCheckInSource(Integer.toString(larkClockRecord.getType()));
                channelCheckInDataResSuccess.setCheckInTime(Long.valueOf(larkClockRecord.getCheckTime()));
                channelCheckInDataResSuccess.setDeviceId(larkClockRecord.getDeviceId());
                channelCheckInDataResSuccess.setLocationDetail(larkClockRecord.getLocationName());
                channelCheckInDataResSuccess.setOriginData(JacksonUtils.toJson(larkClockRecord));
                channelCheckInDataResSuccess.setRecordId(larkClockRecord.getRecordId());
                channelCheckInDataResSuccess.setVerify(Objects.toString(larkClockRecord.getType(), null));
                if (CollectionUtils.isNotEmpty(larkClockRecord.getPhotoUrls())) {
                    channelCheckInDataResSuccess.setImg(larkClockRecord.getPhotoUrls().get(0));
                }
                resList.add(channelCheckInDataResSuccess);
            }
            continue;
        }

        resList.add(channelCheckInDataRes);

    }
    absenceMsgProducer.pushMsg(resList,entId);
}
```



æµç¨‹å¦‚ä¸‹ï¼š

1. ä»è¯·æ±‚å‚æ•° `req` ä¸­è·å–ä¼ä¸šID

2. å¯¹é£ä¹¦æ‰“å¡æ•°æ®æ‹‰å–çš„è®¿é—®é™åˆ¶ï¼š

   ![image-20231123151536227](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231515531.png)

     - ä½¿ç”¨ä¼ä¸šIDæ„å»ºäº†ä¸€ä¸ªç”¨äºå­˜å‚¨åœ¨ Redis ä¸­çš„é”®
   - ä½¿ç”¨ `redisLimitTemplate` åˆå§‹åŒ–ä¸€ä¸ªä»¤ç‰Œæ¡¶é™æµå™¨ï¼Œæ¯ç§’ç”Ÿæˆ `40 - LIMIT_BUFFER` ä¸ªä»¤ç‰Œï¼Œå³æ¯ç§’å¡«å…… `40 - LIMIT_BUFFER` ä¸ªä»¤ç‰Œåˆ°ä»¤ç‰Œæ¡¶ä¸­ ï¼Œ**è¿™é‡Œä½¿ç”¨äº†`RRateLimiter`åˆ†å¸ƒå¼é™æµå™¨**ï¼Œç›¸å…³æ–‡ç« é“¾æ¥å¦‚ä¸‹ï¼š
     - [è°ˆè°ˆé™æµç®—æ³•ï¼Œä»¥åŠRedissonå®ç°](https://segmentfault.com/a/1190000043472098)
     - [å¦‚ä½•å¤„ç†é’‰é’‰æœåŠ¡ç«¯APIé™æµ](https://open.dingtalk.com/document/orgapp/how-to-process-api-throttling-on-the-dingtalk-server)



3. **æŸ¥è¯¢è¿™äº›é£ä¹¦ç”¨æˆ·å¯¹åº”åœ¨hcmä¸­çš„ç§Ÿæˆ·ä¿¡æ¯**ï¼Œ**æ„å»ºå‘˜å·¥IDåˆ°é£ä¹¦ç”¨æˆ·IDçš„æ˜ å°„**

4. ==è·å–é£ä¹¦æ‰“å¡è®°å½•: getPunchRecord()æ–¹æ³•==

5. **æŒ‰ç”¨æˆ·IDåˆ†ç»„æ‰“å¡è®°å½•ï¼Œéå†å‘˜å·¥IDåˆ—è¡¨ï¼Œæ„å»ºæ‰“å¡æ•°æ®ç»“æœï¼Œæ„å»ºæ‰“å¡æ•°æ®ç»“æœåˆ—è¡¨**

6. æ„å»ºå¥½çš„æ‰“å¡æ•°æ®ç»“æœé€šè¿‡`kafka`å‘é€å¼‚æ­¥æ¶ˆæ¯  [æ¶ˆè´¹è€…æ‰¹é‡æ¶ˆè´¹](#consumer-batch)

   

   <img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231552151.png" alt="image-20231123155217105" style="zoom:45%;" />





**é’ˆå¯¹å…¶ä¸­çš„ç¬¬å››æ­¥**ï¼Œè·å–é£ä¹¦æ‰“å¡è®°å½•è¿™é‡Œï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

```java
public List<LarkAttendanceUserFlowRespVO> getPunchRecord(List<String> list, PullChannelCheckInRecordReq req, String corpId) {
    Date startDate = req.getStartDate();
    Date endDate = req.getEndDate();
 
  
    ///è®¾ç½®è¯·æ±‚å‚æ•°
    GetLarkAttendanceUserFlowBatchReqVO getLarkAttendanceUserFlowBatchReqVO = GetLarkAttendanceUserFlowBatchReqVO.builder()
            .checkTimeFrom(Long.toString(startDate.getTime() / 1000))
            .checkTimeTo(Long.toString(endDate.getTime() / 1000))
            .employeeType(ImIntegrationConstants.LARK_EMPLOYEE_ID_TYPE)
            .includeTerminatedUser(true)
            .userIds(list)
            .build();
    getLarkAttendanceUserFlowBatchReqVO.setAppType(ImIntegrationConstants.LARK_SELF);
    getLarkAttendanceUserFlowBatchReqVO.setCorpId(corpId);
    getLarkAttendanceUserFlowBatchReqVO.setBus(ImIntegrationConstants.REQUEST_BUS);

  
  
    //è°ƒç”¨é£ä¹¦æ¥å£è·å–æ‰“å¡è®°å½•
    RespEntity<LarkAttendanceUserFlowBatchRespVO> larkAttendanceUserFlowsBatch
            = larkAttendanceApi.getLarkAttendanceUserFlowsBatch(getLarkAttendanceUserFlowBatchReqVO);
    if (null == larkAttendanceUserFlowsBatch || null == larkAttendanceUserFlowsBatch.getData()) {
        log.info("æŸ¥è¯¢é£ä¹¦æ‰“å¡è®°å½•æ¥å£è·å–å¤±è´¥ :{}", JsonUtils.toJsonString(getLarkAttendanceUserFlowBatchReqVO));
        return Collections.EMPTY_LIST;
    }
    LarkAttendanceUserFlowBatchRespVO larkAttendanceUserFlowBatchRespVO = larkAttendanceUserFlowsBatch.getData();
    List<LarkAttendanceUserFlowRespVO> userFlowList = larkAttendanceUserFlowBatchRespVO.getUserFlowList();


    if (RespCode.SUCCESS.getCode() != larkAttendanceUserFlowsBatch.getCode()) {
        log.info("æŸ¥è¯¢é£ä¹¦æ‰“å¡è®°å½•æ¥å£è·å–å¤±è´¥ exception :{} response:{}", JsonUtils.toJsonString(getLarkAttendanceUserFlowBatchReqVO)
                , JsonUtils.toJsonString(larkAttendanceUserFlowsBatch));
        return Collections.EMPTY_LIST;
    }
    return userFlowList == null ? Collections.EMPTY_LIST : userFlowList;

}
```



é€šè¿‡å°è£…å¥½çš„`LarkAttendanceApi`æ¥æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·çš„é£ä¹¦æ‰“å¡è®°å½•ï¼š

![image-20231123160051103](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231600447.png)



è¯¥æ¥å£ä½äº`moka-lark`ä¸‹ï¼š **LarkAttendanceInnerController.java**

```java
@RestController
@RequestMapping("/api/inner/moka-lark/attendance")
public class LarkAttendanceInnerController implements LarkAttendanceApi {

    @Autowired
    private LarkAttendanceService larkAttendanceService;

    @Override
    @ApiOperation("æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·é£ä¹¦æ‰“å¡è®°å½•")
    @PostMapping(value = "/getLarkAttendanceUserFlowsBatch")
    public RespEntity<LarkAttendanceUserFlowBatchRespVO> getLarkAttendanceUserFlowsBatch(@RequestBody GetLarkAttendanceUserFlowBatchReqVO reqVO) {
        try {
            LarkAttendanceUserFlowBatchRespVO respVO = larkAttendanceService.getLarkAttendanceUserFlowBatch(reqVO);
            return RespEntity.respSuccess(respVO);
        } catch (Exception e) {
            if (e instanceof ServiceException) {
                return RespEntity.resp(((ServiceException) e).getCode(), e.getMessage(), null);
            }
            return RespEntity.respFail("LarkAttendanceInnerController getLarkAttendanceUserFlowsBatch error: " + e.getMessage());
        }
    }
}
```



å› ä¸ºæ˜¯ATSçš„é¡¹ç›®ï¼Œå…·ä½“å°±ä¸ç»†çœ‹äº†ï¼Œåªçœ‹æœ€ç»ˆè°ƒç”¨ä»£ç ,å®é™…ä¸Šæ˜¯é€šè¿‡`Unirest`å‘é€httpè¯·æ±‚ç»™é£ä¹¦å¼€æ”¾å¹³å°æ¥è¯·æ±‚æ‰“å¡æ•°æ®

```java
    public String getUserFlowBatch(String tenantAccessToken, GetLarkAttendanceUserFlowBatchReqVO vo) throws UnirestException {
        // 1.æ‰¹é‡æŸ¥è¯¢æ‰“å¡æµæ°´è®°å½•url
        String url = LarkConstants.LARK_OPEN_API_URL + LarkConstants.LARK_V1_ATTENDANCE_USER_FLOWS_QUERY_URL;
        // 2.æ„é€ è¯·æ±‚å‚æ•°
        GetLarkUserFlowBatchRequestParam requestParam = GetLarkUserFlowBatchRequestParam.builder()
            .employee_type(vo.getEmployeeType())
            .include_terminated_user(vo.getIncludeTerminatedUser())
            .build();
        GetLarkUserFlowBatchRequestBodyParam requestBodyParam = GetLarkUserFlowBatchRequestBodyParam.builder()
            .user_ids(vo.getUserIds())
            .check_time_from(vo.getCheckTimeFrom())
            .check_time_to(vo.getCheckTimeTo())
            .build();
        // 3.è¯·æ±‚lark
        try {
            HttpResponse<JsonNode> response = Unirest
                .post(url)
                .header("Content-Type", MediaType.APPLICATION_JSON_VALUE)
                .header("Accept", MediaType.APPLICATION_JSON_VALUE)
                .header("Authorization", tenantAccessToken)
                .queryString(gson.fromJson(gson.toJson(requestParam), Map.class))
                .body(gson.toJson(requestBodyParam))
                .asJson();
            LarkResponse larkResponse = JSONObject.parseObject(response.getBody().toString(), LarkResponse.class);

            if (response.getStatus() != HttpStatusEnum.SUCCESS.value() || larkResponse.getCode() != OK_CODE) {
                throw new ServiceException(larkResponse.getCode(),
                    larkResponse.getMsg() + StrUtil.nullToEmpty(larkResponse.getError()));
            }

            return gson.toJson(larkResponse.getData());
        } catch (Exception e) {
            log.error("LarkAttendanceDaoImpl getUserFlowsBatch error! tenantAccessToken=[{}],error=[{}]",
                tenantAccessToken, e);
            throw e;
        }
    }

```



> ä»€ä¹ˆæ˜¯Unirestï¼Ÿ
>
> 
>
> <img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231745513.png" alt="image-20231123174534852" style="zoom:33%;" />









#### æ‹‰å–ä¼ä¸šå¾®ä¿¡æ‰“å¡



æ‹‰å–ä¼å¾®æ‰“å¡æ•°æ®çš„é€»è¾‘å’Œæ‹‰å–é£ä¹¦ç±»ä¼¼ï¼Œè¿™é‡Œåªå…³æ³¨ä¸åŒç‚¹ :grey_exclamation: :grey_exclamation:



å…ˆçœ‹çœ‹å…¥å£urlï¼š

![image-20231123163357591](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231633039.png)



æ‹‰å–ä¼å¾®æ•°æ®çš„æ ¸å¿ƒä»£ç ï¼š

```java
public void asyncPullPunchData(List<Long> list, long entId,long buId, Date startDate, Date endDate,String transId , String corpId, String punchSecret) {
    accessLimitService.wechatAbsenceAcquireByEnt(entId); //å¤–éƒ¨æ¥å£è°ƒç”¨é™æµ
    List<HcmWxinUser> hcmWxinUsers = hcmWxinUserDao.findByEmployeeIds(entId, buId, corpId, list);
  
    // ä»ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨ä¸­è¿‡æ»¤å‡ºæ²¡æœ‰åŸå§‹ç”¨æˆ·IDï¼ˆOriginalUserIdï¼‰çš„ç”¨æˆ·åˆ—è¡¨ noOriUserIdList
    List<HcmWxinUser> noOriUserIdList = hcmWxinUsers.stream().filter(hcmWxinUser -> StringUtils.isBlank(hcmWxinUser.getOriginalUserId())).collect(Collectors.toList());
  
    /*
    å¯¹ä¼ä¸šå¾®ä¿¡ç”¨æˆ·åˆ—è¡¨ hcmWxinUsers è¿›è¡Œå¤„ç†ï¼Œè¿‡æ»¤å‡ºé‚£äº› OriginalUserId ä¸ä¸ºç©ºçš„ç”¨æˆ·ï¼Œç„¶åå°†ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·æ˜ å°„ä¸ºä¸€ä¸ª Map<Long, String> ç±»å‹çš„é›†åˆï¼Œå…¶ä¸­é”®ä¸ºç”¨æˆ·çš„å‘˜å·¥IDï¼ˆgetEmployeeId()æ–¹æ³•è¿”å›çš„å€¼ï¼‰ï¼Œå€¼ä¸ºç”¨æˆ·çš„ä¼ä¸šå¾®ä¿¡ç”¨æˆ·IDï¼ˆgetOriginalUserId()æ–¹æ³•è¿”å›çš„å€¼ï¼‰
    ç”¨ä½œåç»­è°ƒç”¨ä¼ä¸šå¾®ä¿¡æ¥å£æŸ¥è¯¢ä¼å¾®ç”¨æˆ·æ‰“å¡è®°å½•ä½¿ç”¨
    */
    Map<Long, String> employeeIdUserIdMap = hcmWxinUsers.stream().filter(hcmWxinUser -> StringUtils.isNotBlank(hcmWxinUser.getOriginalUserId()))
            .collect(Collectors.toMap(HcmWxinUser::getEmployeeId, HcmWxinUser::getOriginalUserId, (v1, v2) -> v2));
  
  
    if(CollectionUtils.isNotEmpty(noOriUserIdList)){
        List<Long> employeeIdList = noOriUserIdList.stream().map(HcmWxinUser::getEmployeeId).collect(Collectors.toList());
      
      
      //é€šè¿‡ä¼ä¸šå¾®ä¿¡æ¥å£æŸ¥è¯¢æ‰‹æœºå·å¯¹åº”çš„ç”¨æˆ·IDï¼Œä»…é’ˆå¯¹æ²¡æœ‰åŸå§‹ç”¨æˆ·IDï¼ˆOriginalUserIdï¼‰çš„ç”¨æˆ·
        HashMap<Long, String> employeeTelephoneByEmployeeId = imHandleManager.getEmployeeTelephoneByEmployeeId(entId, buId, employeeIdList, true);
        for (HcmWxinUser hcmWxinUser : noOriUserIdList) {
            Long employeeId = hcmWxinUser.getEmployeeId();
            String telephone = employeeTelephoneByEmployeeId.get(employeeId);
            if (StringUtils.isBlank(telephone)) {
                log.warn("è¯¥å‘˜å·¥æŸ¥åˆ°çš„æ‰‹æœºå·ä¸åˆæ³•ï¼ŒemployeeId: {}, telephone: {}", employeeId, telephone);
                continue;
            }
            GetUserIdByPhoneReqDTO params = GetUserIdByPhoneReqDTO.builder().corpId(hcmWxinUser.getCorpid()).corpSecret(punchSecret).phone(telephone).build();
            String workWechatUserId = "";
            try {
                //å¦‚æœæ‰‹æœºå·æŸ¥è¯¢userIdæŸ¥è¯¢å¤±è´¥äº†åç»­å°±ä¸æŸ¥äº†ã€‚
                String redisUserid = redisClient.getValue(PHONE_USERID_REDIS_PRE+telephone);
                if(StringUtils.isNotBlank(redisUserid)){
                    log.info("redisUserid is :{}",redisUserid);
                    continue;
                }
              
              //é€šè¿‡æ‰‹æœºå·è·å–ä¼ä¸šå¾®ä¿¡id
                AtsRespEntity<GetUserIdByPhoneRespDTO>  workWechatUserIdByPhone = iWorkWechatAddressBookUserInnerApi.getWorkwechatUserIdByPhone(params);
                log.info("é€šè¿‡æ‰‹æœºå·æ¢å–userIdç»“æœï¼š{}", JacksonUtils.toJson(workWechatUserIdByPhone));
                if(workWechatUserIdByPhone.isSuccess()){
              /*
              *å¦‚æœæ¥å£è°ƒç”¨æˆåŠŸï¼ˆworkWechatUserIdByPhone.isSuccess()ï¼‰ï¼Œ
               ä»å“åº”ç»“æœä¸­è·å–ç”¨æˆ·IDï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºç”¨æˆ·çš„åŸå§‹ç”¨æˆ·IDï¼ˆOriginalUserIdï¼‰ã€‚
               æ›´æ–° employeeIdUserIdMap ä¸­çš„æ˜ å°„å…³ç³»ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·å·²ç»æœ‰äº†åŸå§‹ç”¨æˆ·IDã€‚
               è°ƒç”¨ hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser) æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯
              */
                    GetUserIdByPhoneRespDTO data = workWechatUserIdByPhone.getData();
                    workWechatUserId = data.getWorkwechatUserId();
                    hcmWxinUser.setOriginalUserId(workWechatUserId);
                    employeeIdUserIdMap.put(employeeId, workWechatUserId);
                    hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser);
                }else{
                    //è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ä¸º12å°æ—¶ï¼Œå³åœ¨æ¥ä¸‹æ¥çš„12å°æ—¶å†…ï¼Œå¯¹äºç›¸åŒçš„æ‰‹æœºå·ä¸å†è¿›è¡Œç”¨æˆ·IDçš„æŸ¥è¯¢
                    try
                    {
                        redisClient.setValue(PHONE_USERID_REDIS_PRE + telephone, telephone, 12, TimeUnit.HOURS);
                        log.info("query  by phone:{}", telephone);
                    } catch (Exception e)
                    {
                        log.error("redis function error. userid:{} , phone:{}", workWechatUserId, telephone,e);
                    }
                }
            } catch (Exception e) {
                log.error("ä½¿ç”¨punchSecretè·å–å‘˜å·¥userIdå¤±è´¥:å…¥å‚{}:ç§Ÿæˆ·:{}",JacksonUtils.toJson(params),entId,e);
            }

        }
        log.info("é‡å»ºåŸå§‹userIdç»“æœ:{}",JacksonUtils.toJson(noOriUserIdList));
    }

    List<ChannelCheckInDataRes> resList = new ArrayList<>();
    List<String> userIdList = new ArrayList<>(employeeIdUserIdMap.values());
    List<GetWorkwechatCardRespDTO> punchRecord = getPunchRecord(userIdList, startDate, endDate, corpId, punchSecret);
    Map<String, List<GetWorkwechatCardRespDTO>> punchRecordMap = punchRecord.stream().collect(Collectors.groupingBy(GetWorkwechatCardRespDTO::getUserId));
    if(!punchRecordMap.isEmpty()){
        log.info("æŸ¥è¯¢åˆ°çš„ä¼ä¸šå¾®ä¿¡æ‰“å¡æ•°æ®:{}", JacksonUtils.toJson(punchRecordMap));
    }
    for (Long employeeId : list) {
        ChannelCheckInDataRes channelCheckInDataRes = new ChannelCheckInDataRes();
        channelCheckInDataRes.setChannel(ImCheckInChannelEnum.WEIXIN);
        channelCheckInDataRes.setBuId(buId);
        channelCheckInDataRes.setEntId(entId);
        channelCheckInDataRes.setEmployeeId(employeeId);
        channelCheckInDataRes.setTransId(transId);
        String userId = employeeIdUserIdMap.get(employeeId);
        if (!StringUtils.isEmpty(userId) && punchRecordMap.containsKey(userId)) {
            for (GetWorkwechatCardRespDTO datum : punchRecordMap.get(userId)) {
                ChannelCheckInDataRes channelCheckInDataResSuccess = new ChannelCheckInDataRes();
                BeanUtils.copyProperties(channelCheckInDataRes, channelCheckInDataResSuccess);
                channelCheckInDataResSuccess.setWechatException(datum.getExceptionType());
                channelCheckInDataResSuccess.setCheckInSource(datum.getCheckinSource());
                channelCheckInDataResSuccess.setCheckInTime(datum.getCheckinTime());
                channelCheckInDataResSuccess.setDeviceId(datum.getDeviceId());
                channelCheckInDataResSuccess.setLocationDetail(datum.getLocationDetail());
                channelCheckInDataResSuccess.setOutsideClock(datum.getCheckinType());
                channelCheckInDataResSuccess.setOutsideRemark(datum.getNotes());
                channelCheckInDataResSuccess.setOriginData(JacksonUtils.toJson(datum));
                resList.add(channelCheckInDataResSuccess);
            }
            continue;
        }
        resList.add(channelCheckInDataRes);
    }
    absenceMsgProducer.pushMsg(resList,entId);

}
```



1. **é™æµæ§åˆ¶ï¼š**

   - è°ƒç”¨ `accessLimitService.wechatAbsenceAcquireByEnt(entId)` æ–¹æ³•ï¼Œè¿›è¡Œä¼ä¸šå¾®ä¿¡å¤–éƒ¨æ¥å£è°ƒç”¨çš„é™æµæ§åˆ¶ã€‚

2. **è·å–ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯ï¼š**

   - é€šè¿‡ä¼ä¸šIDï¼ˆ`entId`ï¼‰ã€éƒ¨é—¨IDï¼ˆ`buId`ï¼‰ã€ä¼ä¸šå¾®ä¿¡CorpIdï¼ˆ`corpId`ï¼‰ã€å‘˜å·¥IDåˆ—è¡¨ï¼ˆ`list`ï¼‰ç­‰å‚æ•°ï¼Œä»æ•°æ®åº“ä¸­è·å–ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨ `hcmWxinUsers`ã€‚

3. **è·å–æ— åŸå§‹ç”¨æˆ·IDçš„ç”¨æˆ·åˆ—è¡¨ `noOriUserIdList`ï¼š**

   - ä»ä¼ä¸šå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨ä¸­è¿‡æ»¤å‡ºæ²¡æœ‰åŸå§‹ç”¨æˆ·IDï¼ˆ`OriginalUserId`ï¼‰çš„ç”¨æˆ·åˆ—è¡¨ `noOriUserIdList`

   ![image-20231123164406437](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231644944.png)

   

4. **è·å–å‘˜å·¥IDä¸ä¼ä¸šå¾®ä¿¡ç”¨æˆ·IDçš„æ˜ å°„å…³ç³» `employeeIdUserIdMap`ï¼š**

   - é€šè¿‡ Java 8 çš„ Stream APIï¼Œå°†å…·æœ‰åŸå§‹ç”¨æˆ·IDçš„ç”¨æˆ·ä¿¡æ¯æ˜ å°„ä¸ºå‘˜å·¥IDä¸ä¼ä¸šå¾®ä¿¡ç”¨æˆ·IDçš„å…³ç³»ï¼Œå­˜å‚¨åœ¨ `employeeIdUserIdMap` ä¸­ã€‚

5. **å¤„ç†æ— åŸå§‹ç”¨æˆ·IDçš„ç”¨æˆ·åˆ—è¡¨ï¼š**

   - å¯¹äºæ²¡æœ‰åŸå§‹ç”¨æˆ·IDçš„ç”¨æˆ·ï¼Œå°è¯•é€šè¿‡æ‰‹æœºå·ç ä»ä¼ä¸šå¾®ä¿¡è·å–ç”¨æˆ·IDã€‚
   - å¦‚æœæ‰‹æœºå·åœ¨Redisä¸­æœ‰è®°å½•ï¼Œåˆ™è·³è¿‡ï¼›å¦åˆ™ï¼Œé€šè¿‡ä¼ä¸šå¾®ä¿¡æ¥å£æŸ¥è¯¢æ‰‹æœºå·å¯¹åº”çš„ç”¨æˆ·IDï¼Œå¹¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€‚

6. **æ„å»ºæ¨é€æ‰“å¡æ•°æ®çš„ç»“æœåˆ—è¡¨ `resList`ï¼š**

   - é€šè¿‡ç”¨æˆ·IDåˆ—è¡¨è°ƒç”¨ `getPunchRecord` æ–¹æ³•ï¼Œè·å–ä¼ä¸šå¾®ä¿¡ç”¨æˆ·çš„æ‰“å¡è®°å½•ã€‚
   - æ ¹æ®æ‰“å¡è®°å½•æ„å»ºæ¨é€æ‰“å¡æ•°æ®çš„ç»“æœåˆ—è¡¨ `resList`ã€‚

7. **æ¨é€æ‰“å¡æ•°æ®ï¼š**

   - è°ƒç”¨ `absenceMsgProducer.pushMsg(resList, entId)` æ–¹æ³•ï¼Œå°†æ‰“å¡æ•°æ®å¼‚æ­¥æ¨é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ã€‚







**1ã€è°ƒç”¨å¤–éƒ¨apié™æµé¢‘ç‡å·®å¼‚**

ä»¤ç‰Œç”Ÿæˆçš„é€Ÿç‡ä¸º 10 ä»¤ç‰Œæ¯ç§’ï¼ˆå³æ¯ç§’æœ€å¤šå…è®¸ 10 æ¬¡è¯·æ±‚ï¼‰ï¼Œç¼“å†²åŒºå¤§å°ä¸º `LIMIT_BUFFER`ã€‚`LIMIT_BUFFER` çš„å€¼åº”è¯¥æ˜¯ä¸€ä¸ªå°äºä»¤ç‰Œç”Ÿæˆé€Ÿç‡çš„æ•°å€¼ï¼Œç”¨äºç¡®ä¿å³ä½¿åœ¨é€Ÿç‡æ­£å¥½ç”¨å°½æ—¶ï¼Œè¯·æ±‚ä¹Ÿèƒ½å¤Ÿé€šè¿‡ã€‚åœ¨è¿™é‡Œï¼Œé€Ÿç‡æ˜¯æ¯ç§’ 10 æ¬¡ï¼Œ`LIMIT_BUFFER` ä¸º 1ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯æ¯ç§’æœ€å¤šå…è®¸ 11 æ¬¡è¯·æ±‚ï¼š

```java
 public void wechatAbsenceAcquireByEnt(Long entId) {
        String key = "mobile:limiter:wXin:absence:" + entId;
        log.info("wechatAbsenceAcquireByEnt:{}", key);
        redisLimitTemplate.initRateLimiter(key, 10 - LIMIT_BUFFER, 1, RateIntervalUnit.SECONDS);
        boolean acquire = redisLimitTemplate.tryAcquire(key, LIMITER_WAIT_TIME, TimeUnit.SECONDS);
        if (!acquire) {
            log.info("è¯·æ±‚è¢«é™æµæ§åˆ¶ï¼ŒentId:{}",entId);
            throw new CustomException("è¯·æ±‚è¢«é™æµæ§åˆ¶ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
```



ä¼ä¸šå¾®ä¿¡å¼€å‘è€…ä¸­å¿ƒè§„å®šäº†æ¥å£çš„è®¿é—®é¢‘ç‡ï¼š[è®¿é—®é¢‘ç‡é™åˆ¶](https://developer.work.weixin.qq.com/document/path/90312)

<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241102113.png" alt="image-20231124110230586" style="zoom: 33%;" />







**2ã€ç±»ä¼¼é£ä¹¦ã€åŒæ ·æœ‰ä¸€å¼ è¡¨è®°å½•ä¼ä¸šå¾®ä¿¡ç”¨æˆ·å’Œ hcm ç§Ÿæˆ·ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼š**
<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231632367.png" alt="image-20231123163251930" style="zoom:33%;" />



åŒæ—¶ï¼Œè¡¨``hcm_wxin_user`è®°å½•äº†æ‰€æœ‰ä¼ä¸šå¾®ä¿¡ç”¨æˆ·éš¶å±äºçš„hcmç§Ÿæˆ·ä¿¡æ¯ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231637967.png" alt="image-20231123163706509" style="zoom:33%;" />





3ã€**é’ˆå¯¹hcm-wxin-userè¡¨ä¸­çš„ç©ºç”¨æˆ·é—®é¢˜å¤„ç†ï¼ˆå¤„ç†ç¼“å­˜å‡»ç©¿ï¼‰**





> å…ˆæ¥ç†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ `original_user_id` ï¼Ÿ
>
> 1ã€æ•°æ®åº“ä¸­æœ‰ä¸€å¼ è¡¨ hcm_wxin_userï¼Œè¯¥è¡¨è®°å½•äº†æ‰€æœ‰hcmç”¨æˆ·åœ¨mokaä¸­çš„idï¼ŒåŒæ—¶è®°å½•äº†è¿™äº›ç”¨æˆ·åœ¨ä¼ä¸šå¾®ä¿¡ä¸­çš„åŸå§‹id
>
> 
>
> 2ã€åœ¨å¯¹ä¼ä¸šå¾®ä¿¡ç”¨æˆ·åˆ—è¡¨ `hcmWxinUsers` è¿›è¡Œå¤„ç†æ—¶ï¼Œè¿‡æ»¤å‡ºé‚£äº› `OriginalUserId` ä¸ä¸ºç©ºçš„ç”¨æˆ·ï¼Œç„¶åå°†ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·æ˜ å°„ä¸ºä¸€ä¸ª `Map<Long, String>` ç±»å‹çš„é›†åˆï¼Œå…¶ä¸­é”®ä¸ºç”¨æˆ·çš„å‘˜å·¥IDï¼ˆ`getEmployeeId()`æ–¹æ³•è¿”å›çš„å€¼ï¼‰ï¼Œå€¼ä¸ºç”¨æˆ·çš„ä¼ä¸šå¾®ä¿¡ç”¨æˆ·IDï¼ˆ`getOriginalUserId()`æ–¹æ³•è¿”å›çš„å€¼ï¼‰
>
> 
>
> 3ã€æœ€ç»ˆè°ƒç”¨ä¼å¾®apiæ‰¹é‡æŸ¥è¯¢è¿™äº›å‘˜å·¥çš„æ‰“å¡è®°å½•ï¼Œä¼ å…¥å‚æ•°åˆ™ä¸º`OriginalUserId`çš„`List`



åœ¨å¤„ç†é‚£äº›noOriginUserIdçš„ç”¨æˆ·æ—¶ï¼š

```java
List<HcmWxinUser> noOriUserIdList = hcmWxinUsers.stream().filter(hcmWxinUser -> StringUtils.isBlank(hcmWxinUser.getOriginalUserId())).collect(Collectors.toList());

if(CollectionUtils.isNotEmpty(noOriUserIdList)){
  List<Long> employeeIdList = noOriUserIdList.stream().map(HcmWxinUser::getEmployeeId).collect(Collectors.toList());
  HashMap<Long, String> employeeTelephoneByEmployeeId = imHandleManager.getEmployeeTelephoneByEmployeeId(entId, buId, employeeIdList, true);
  for (HcmWxinUser hcmWxinUser : noOriUserIdList) {
    Long employeeId = hcmWxinUser.getEmployeeId();
    String telephone = employeeTelephoneByEmployeeId.get(employeeId);
    if (StringUtils.isBlank(telephone)) {
      log.warn("è¯¥å‘˜å·¥æŸ¥åˆ°çš„æ‰‹æœºå·ä¸åˆæ³•ï¼ŒemployeeId: {}, telephone: {}", employeeId, telephone);
      continue;
    }
    GetUserIdByPhoneReqDTO params = GetUserIdByPhoneReqDTO.builder().corpId(hcmWxinUser.getCorpid()).corpSecret(punchSecret).phone(telephone).build();
    String workWechatUserId = "";
    try {
      //å¦‚æœåœ¨redisä¸­æŸ¥è¯¢åˆ°å¯¹åº”çš„åŸå§‹idï¼Œç›´æ¥è·³è¿‡è¯¥å‘˜å·¥
      String redisUserid = redisClient.getValue(PHONE_USERID_REDIS_PRE+telephone);
      if(StringUtils.isNotBlank(redisUserid)){
        log.info("redisUserid is :{}",redisUserid);
        continue;
      }
      
      
      //å¦‚æœredisä¸­æ²¡æœ‰å­˜å‚¨è¯¥å‘˜å·¥å¯¹åº”çš„åŸå§‹idï¼Œåˆ™é€šè¿‡ä¼ä¸šå¾®ä¿¡é€šè®¯å½•ç”¨æˆ·inneræ¥å£ï¼Œé€šè¿‡è¯¥å‘˜å·¥æ‰‹æœºå·æ¥è·å–è¯¥å‘˜å·¥çš„ä¼ä¸šå¾®ä¿¡id
      AtsRespEntity<GetUserIdByPhoneRespDTO>  workWechatUserIdByPhone = iWorkWechatAddressBookUserInnerApi.getWorkwechatUserIdByPhone(params);
      log.info("é€šè¿‡æ‰‹æœºå·æ¢å–userIdç»“æœï¼š{}", JacksonUtils.toJson(workWechatUserIdByPhone));
      if(workWechatUserIdByPhone.isSuccess()){
        GetUserIdByPhoneRespDTO data = workWechatUserIdByPhone.getData();
        workWechatUserId = data.getWorkwechatUserId();
        hcmWxinUser.setOriginalUserId(workWechatUserId);
        employeeIdUserIdMap.put(employeeId, workWechatUserId);
        hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser);
      }else{
        //è°ƒç”¨æ¥å£æŸ¥è¯¢åˆ°æ‰‹æœºå·åï¼ŒredisåŠ ä¸€ä¸ªé”12å°æ—¶å†…ä¸å†æŸ¥è¯¢ã€‚
        try
        {
          redisClient.setValue(PHONE_USERID_REDIS_PRE + telephone, telephone, 12, TimeUnit.HOURS);
          log.info("query  by phone:{}", telephone);
        } catch (Exception e)
        {
          log.error("redis function error. userid:{} , phone:{}", workWechatUserId, telephone,e);
        }
      }
    } catch (Exception e) {
      log.error("ä½¿ç”¨punchSecretè·å–å‘˜å·¥userIdå¤±è´¥:å…¥å‚{}:ç§Ÿæˆ·:{}",JacksonUtils.toJson(params),entId,e);
    }

  }
  log.info("é‡å»ºåŸå§‹userIdç»“æœ:{}",JacksonUtils.toJson(noOriUserIdList));
}

```



åœ¨é€šè¿‡è¯¥å‘˜å·¥æ‰‹æœºå·æ¥è·å–å®ƒåœ¨ä¼ä¸šå¾®ä¿¡ä¸­çš„å¯¹åº”idæ—¶ï¼Œéœ€è¦è°ƒç”¨ä»¥ä¸‹æ¥å£ï¼š

![image-20231123170209869](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231702367.png)

å¦‚æœé€šè¿‡è¯¥å‘˜å·¥çš„æ‰‹æœºå·æˆåŠŸè·å–åˆ°å…¶åœ¨ä¼å¾®ä¸­çš„`userId`

- å°†å…¶è®¾ç½®ä¸ºç”¨æˆ·çš„åŸå§‹ç”¨æˆ·IDï¼ˆ`OriginalUserId`ï¼‰ã€‚
- æ›´æ–° `employeeIdUserIdMap` ä¸­çš„æ˜ å°„å…³ç³»ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·å·²ç»æœ‰äº†åŸå§‹ç”¨æˆ·IDã€‚
- è°ƒç”¨ `hcmWxinUserDaoAdapter.buildUserId(hcmWxinUser)` æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯



å¦‚æœé€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·IDå¤±è´¥ï¼Œè®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ä¸º12å°æ—¶ï¼Œå³åœ¨æ¥ä¸‹æ¥çš„12å°æ—¶å†…ï¼Œå¯¹äºç›¸åŒçš„æ‰‹æœºå·ä¸å†è¿›è¡Œç”¨æˆ·IDçš„æŸ¥è¯¢

å³åœ¨å‘ç”Ÿå¤±è´¥æ—¶ï¼Œé€šè¿‡ `redisClient` è®¾ç½®ä¸€ä¸ªé”ï¼ˆå®é™…ä¸Šæ˜¯åœ¨ Redis ä¸­è®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹ï¼‰ï¼Œä»¥é¿å…åœ¨æ¥ä¸‹æ¥çš„12å°æ—¶å†…å¯¹ç›¸åŒæ‰‹æœºå·è¿›è¡Œç”¨æˆ·IDçš„é‡å¤æŸ¥è¯¢ã€‚è¿™ä¸ªé”çš„é”®æ˜¯ç”±æ‰‹æœºå·æ„å»ºçš„ï¼Œè€Œå€¼åˆ™è¢«è®¾ç½®ä¸ºæ‰‹æœºå·æœ¬èº«ï¼š`redisClient.setValue(PHONE_USERID_REDIS_PRE + telephone, telephone, 12, TimeUnit.HOURS);`





4ã€å¤–éƒ¨è°ƒç”¨ä¼ä¸šå¾®ä¿¡æ¥å£æ‰¹é‡æŸ¥è¯¢æ‰“å¡è®°å½•



```java
    public List<GetWorkwechatCardRespDTO> getPunchRecord(List<String> list, Date startDate, Date endDate, String corpId, String punchSecret) {

        // å¦‚æœè¯·æ±‚çš„ç”¨æˆ·idä¸ºç©ºï¼Œç›´æ¥è¿”å›
        if (CollectionUtils.isEmpty(list)){
            return new ArrayList<>();
        }

        GetWorkwechatCardReqDTO params = new GetWorkwechatCardReqDTO();
        params.setCorpId(corpId);
        params.setStarttime(startDate.getTime() / 1000);
        params.setEndtime(endDate.getTime() / 1000);
        params.setUseridlist(list);
        params.setOpencheckindatatype(3);//å›ºå®šå…¥å‚
        params.setCorpSecret(punchSecret);
        params.setSuiteType(suite);
        log.info("æŸ¥è¯¢ä¼ä¸šå¾®ä¿¡æ‰“å¡è®°å½•å…¥å‚:{}", JacksonUtils.toJson(params));
        AtsRespEntity<List<GetWorkwechatCardRespDTO>> resp = new AtsRespEntity<>();
        try {
            resp = workWechatUserInnerApi.getCard(params); //å¤–éƒ¨è°ƒç”¨ 
        } catch (Exception exception) {
            log.error("ä¼ä¸šå¾®ä¿¡è·å–æ‰“å¡æ•°æ®å¼‚å¸¸ exception :{}",exception);
        }
        //log.info("æŸ¥è¯¢ä¼ä¸šå¾®ä¿¡æ‰“å¡è®°å½•å‡ºå‚:{}", JsonUtils.toJsonString(resp));
        if (resp.isSuccess()) {
            return resp.getData();
        }
        return new ArrayList<>();
    }

```



<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231732254.png" alt="image-20231123173216728" style="zoom:50%;" />



è¯¥æ¥å£ä½ç½®åœ¨moka-workwechatä¸‹ï¼Œåªçœ‹æ ¸å¿ƒä»£ç ,å®é™…ä¸Šè¿˜æ˜¯å‘é€httpè¯·æ±‚æ¥è·å–æ•°æ®ï¼š

```java
    public List<GetWorkwechatCardRespDTO> getCard(GetWorkwechatCardReqDTO dto) throws Exception {

        //è·å–token
        String accessToken = getCardToken(dto.getCorpId(), dto.getCorpSecret());
        if (StringUtils.isBlank(accessToken)) {
            log.info("get accessToken error. corpId:{},corpSecret:{}", dto.getCorpId(), dto.getCorpSecret());
            throw new Exception("get accessToken error");
        }
        // å…¼å®¹ä¹‹å‰è€ä»£ç ï¼Œä¹‹å‰useridlistæ˜¯ç©ºæ•°ç»„æ—¶ï¼Œä¼ä¸šå¾®ä¿¡æ¥å£æŠ¥é”™ï¼Œè¯¥æ¥å£è¿”å›å€¼ä¸ºç©ºæ•°ç»„
        // æ‰€ä»¥ç°åœ¨useridlistæ˜¯ç©ºæ•°ç»„æ—¶ï¼Œä¸è°ƒç”¨ä¼ä¸šå¾®ä¿¡æ¥å£ï¼Œç›´æ¥è¿”å›ç©ºæ•°ç»„
        if (ObjectUtil.isEmpty(dto.getUseridlist()) || 0 == dto.getUseridlist().size()) {
            return new ArrayList<>();
        }

        //ç»„è£…å‚æ•°è·å–æ‰“å¡è®°å½•
        Map<String, Object> params = new HashMap<>();
        params.put("opencheckindatatype", CHECKIN_DATA_TYPE);
        params.put("useridlist", dto.getUseridlist());
        params.put("starttime", dto.getStarttime());
        params.put("endtime", dto.getEndtime());
        String result = HttpClientUtil.postJson(CHECKIN_DATA_URL + accessToken, JSONUtil.toJsonStr(params), null);
        log.info("get checkin data result:{}", result);
        JSON json = JSONUtil.parse(result);
        Integer errCode = (Integer) JSONUtil.getByPath(json, "errcode");
        if (errCode != 0) {
            throw new Exception(JSONUtil.getByPath(json, "errmsg") + "");
        }
        //è§£æç»“æœ
        JSONArray dataList = (JSONArray) JSONUtil.getByPath(json, "checkindata");
        Iterator<Object> iterator = dataList.stream().iterator();
        List<GetWorkwechatCardRespDTO> list = new ArrayList<>(dataList.size());
        while (iterator.hasNext()) {
            JSONObject object = (JSONObject) iterator.next();
            GetWorkwechatCardRespDTO respDTO = new GetWorkwechatCardRespDTO();
            respDTO.setUserId(object.getStr("userid"));
            respDTO.setCheckinTime(object.getLong("checkin_time"));
            respDTO.setDeviceId(object.getStr("deviceid"));
            respDTO.setLocationDetail(object.getStr("location_detail"));
            respDTO.setCheckinSource("ä¼ä¸šå¾®ä¿¡");
            respDTO.setNotes(object.getStr("notes"));
            //å¤–å‡ºæ‰“å¡å®šä¹‰ä¸ºå¤–å‹¤æ‰“å¡
            if ("å¤–å‡ºæ‰“å¡".equals(object.getStr("checkin_type"))) {
                respDTO.setCheckinType(true);
            } else {
                respDTO.setCheckinType(false);
            }

            //æœ‰wifiåç§°æ—¶ï¼Œå®šä¹‰ä¸ºWi-Fiæ‰“å¡ï¼Œæ²¡æœ‰æ—¶åˆ¤æ–­ç»çº¬åº¦
            String wifiName = object.getStr("wifiname");
            if (StringUtils.isNotBlank(wifiName)) {
                respDTO.setCheckinMethod(1);
            } else {
                Long lat = object.getLong("lat");
                Long lng = object.getLong("lng");
                if (Objects.nonNull(lat) && Objects.nonNull(lng)) {
                    respDTO.setCheckinMethod(0);
                }
            }
            respDTO.setExceptionType(object.getStr("exception_type"));
            respDTO.setWifiMac(object.getStr("wifimac"));
            respDTO.setMediaIds(object.get("mediaids", List.class));
            respDTO.setGroupName(object.getStr("groupname"));
            respDTO.setGroupId(object.getInt("groupid"));
            respDTO.setScheduleId(object.getInt("schedule_id"));
            respDTO.setTimelineId(object.getInt("timeline_id"));
            list.add(respDTO);
        }
        return list;
    }


 /**
     * post jsonç±»å‹ contentTypeä¸ºjson
     *
     * @param url
     * @return
     */
    public static String postJson(String url, String json, Map<String, String> headers) {

        CloseableHttpClient httpClient = HttpClientBuilder.create().build();
        HttpPost post = new HttpPost(url);
        post.setHeader("Content-Type", "application/json;charset=UTF-8");
        if (Objects.nonNull(headers)) {
            for (Map.Entry<String, String> entry : headers.entrySet()) {
                String mapKey = entry.getKey();
                String mapValue = entry.getValue();
                post.setHeader(mapKey, mapValue);
            }
        }
        String response = null;
        try {
            StringEntity s = new StringEntity(json, "utf-8");
            post.setEntity(s);
            log.info("HttpUtilsConsumer.doPostJsonè¯·æ±‚å…¥å‚post=" + JSON.toJSONString(post));
            HttpResponse res = httpClient.execute(post);

            if (HttpStatus.SC_OK <= res.getStatusLine().getStatusCode() && res.getStatusLine().getStatusCode() < HttpStatus.SC_MULTIPLE_CHOICES) {
                String result = EntityUtils.toString(res.getEntity());// è¿”å›jsonæ ¼å¼ï¼š
                response = result;
            } else {
                log.info("postJson httpstatus error {} {}", res.getStatusLine().getStatusCode(), EntityUtils.toString(res.getEntity()));
                throw new Exception();
            }
        } catch (Exception e) {
            log.error("httpæ¥å£è°ƒç”¨å¤±è´¥" + ",url=" + url + ",param=" + json, e);
        }
        return response;
    }
```









#### æ‹‰å–é’‰é’‰æ‰“å¡



é’‰é’‰åŒç†ï¼š

```java
/**
 * æ‰“å¡æ¥å£é’‰é’‰å•ç‹¬å®šä¹‰æ¥å£æƒé™æ¯S 40æ¬¡
 *
 * @param entId
 */
public void dingAbsenceAcquireByEnt(Long entId) {
    String key = "mobile:limiter:ding:absence:" + entId;
    log.info("dingAbsenceAcquireByEnt:{} ", key);
    redisLimitTemplate.initRateLimiter(key, 40 - LIMIT_BUFFER, 1, RateIntervalUnit.SECONDS);
    boolean acquire = redisLimitTemplate.tryAcquire(key, LIMITER_WAIT_TIME, TimeUnit.SECONDS);
    if (!acquire) {
        log.info("è¯·æ±‚è¢«é™æµæ§åˆ¶ï¼ŒentId:{}",entId);
        throw new CustomException("è¯·æ±‚è¢«é™æµæ§åˆ¶ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```







### <a name="consumer-batch"></a>1.3 æ¶ˆè´¹è€…æ‰¹é‡æ¶ˆè´¹





é’ˆå¯¹ä¸Šè¿°æåˆ°çš„æœ€åä¸€æ­¥æ¶ˆæ¯æ¨é€ï¼Œ`hcm-mobile`æœåŠ¡ä¼šé€šè¿‡`kafka`å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š

```java
/**
 * @ClassName HcmAbsenceMsgProducer
 * @Author yangpeixu@mokahr.com
 * @Date 2022/1/29 2:46 ä¸‹åˆ
 * @Desc
 * @Version 1.0
 **/
@Component
@Slf4j
public class HcmAbsenceMsgProducer {

    @Value("${topic.hcm_abs_batch_sync_channel_record}")
    private String topic;

    @Resource
    private InstanceProfileConfig instanceProfileConfig;

    @Resource
    private DefaultNoLogMsgProducer defaultNoLogMsgProducer;


    /**
     * æ¨é€æ‰“å¡æ•°æ®
     * 1.åŸºäºå‘˜å·¥è¿›è¡Œåˆ†ç»„æ¨é€
     * 2.æ¯ä¸ªæ¶ˆæ¯æœ€å¤š600æ¡ ï¼› å¾ªç¯æ¨é€
     * 3.key ä½¿ç”¨å‘˜å·¥ID
     *
     * @param resList
     * @param entId
     */
    public void pushMsg(List<ChannelCheckInDataRes> resList, Long entId) {
        if (CollectionUtils.isEmpty(resList)) {
            return;
        }

        // æ¯ä¸ªæ¶ˆæ¯çš„æœ€å¤§æ¡æ•°
        String countAbs = MokaConfig.getInstance().getStrPropertyFromDefault(ApolloConstants.HCM_MOBILE_MOKA_ABSENCE_MSG_COUNT);
        int partitionRecord = resList.size();
        if (StringUtils.isNotBlank(countAbs)) {
            partitionRecord = Integer.parseInt(countAbs);
        }

        // å°†æ‰“å¡æ•°æ®åˆ—è¡¨æŒ‰å‘˜å·¥å·è¿›è¡Œåˆ†ç»„
        Map<Long, List<ChannelCheckInDataRes>> employeeDataMap = resList.stream().collect(Collectors.groupingBy(ChannelCheckInDataRes::getEmployeeId));
        for (Long employeeId : employeeDataMap.keySet()) {
            List<ChannelCheckInDataRes> employeeCheckInDataList = employeeDataMap.get(employeeId);
          
       //éå†æ¯ä¸ªå‘˜å·¥çš„æ‰“å¡æ•°æ®ï¼Œå°†æ•°æ®æŒ‰é…ç½®çš„æ¯ä¸ªæ¶ˆæ¯çš„æœ€å¤§æ¡æ•°è¿›è¡Œåˆ†å‰²ï¼Œç”Ÿæˆå¤šä¸ªæ¶ˆæ¯   
            List<List<ChannelCheckInDataRes>> checkInLists = ListUtils.partition(employeeCheckInDataList, partitionRecord);
          
      
            for (List<ChannelCheckInDataRes> singleEmployeeDataList : checkInLists) {
                AbsClockCheckInDataDto absClockCheckInDataDto = new AbsClockCheckInDataDto();
                absClockCheckInDataDto.setEntId(entId);
                absClockCheckInDataDto.setBuId(singleEmployeeDataList.get(0).getBuId());
                absClockCheckInDataDto.setEmployeeId(employeeId);
                absClockCheckInDataDto.setCheckInDataResDtoList(singleEmployeeDataList);

                Message message = Message.builder().sendTime(new Date())
                        .msgId(employeeId)
                        .isSequential(false)
                        .topic(getTopic(entId))
                        .body(JacksonUtils.toJson(absClockCheckInDataDto))
                        .build();
                log.info("HcmAbsenceMsgProducer pushMsg -{}", JacksonUtils.toJson(message));
                defaultNoLogMsgProducer.pushMsg(message); //å‘é€æ¶ˆæ¯
            }
        }

    }

    /*
     * æ ¹æ®ä¼ä¸šIDã€ç¯å¢ƒå’Œç°åº¦å‘å¸ƒçŠ¶æ€å†³å®šæ˜¯å¦ä½¿ç”¨ç°åº¦å‘å¸ƒçš„æ¶ˆæ¯ä¸»é¢˜ã€‚å¦‚æœéœ€è¦åˆ‡æ¢åˆ°ç°åº¦ä¸»é¢˜ï¼Œå°†æ¶ˆæ¯ä¸»é¢˜çš„å‰ç¼€ä¿®æ”¹ä¸º "gray_"
     */
    public String getTopic(Long entId) {
        String newTopic = topic;
        boolean shouldChange2GrayTopic = GrayUtils.shouldChange2GrayTopic(entId, instanceProfileConfig.getEnv(), instanceProfileConfig.getGrayReleased());
        if (shouldChange2GrayTopic) {
            newTopic = "gray_" + topic;
            log.info("getTopic should be replace to new topic:{}, originTopic:{}", newTopic, topic);
        }
        return newTopic;
    }
}
```



å…¶ä¸­ topic å­—æ®µå°†è¢«èµ‹äºˆé»˜è®¤å€¼ `hcm_${spring.kafka.active}_abs_batch_sync_channel_record`ï¼Œ`${spring.kafka.active}` æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œå®ƒä¼šåœ¨è¿è¡Œæ—¶è¢«å®é™…çš„é…ç½®å€¼æ›¿æ¢ï¼Œä¾‹å¦‚ localã€prodã€staging

```java
@Value("${topic.hcm_abs_batch_sync_channel_record}")
private String topic;
```



è‡³äºè¯¥`kafka`æ¶ˆæ¯çš„æ¶ˆè´¹è€…ï¼Œåˆ™çœ‹å…·ä½“ä¸šåŠ¡ï¼Œ

æ¯”å¦‚è¯¥æ‰“å¡ä¸šåŠ¡(hcm-absence-clock)ä¸­çš„åŒæ­¥é£ä¹¦æ‰“å¡æ•°æ®ï¼Œæœ€ç»ˆéœ€è¦æŠŠæŒ‡å®šç§Ÿæˆ·ä¸‹å‘˜å·¥çš„é£ä¹¦æ‰“å¡è®°å½•å†™å…¥åˆ° **`hcm_abs_lark_origin_clock_record`**è¡¨ä¸­ï¼š

![image-20231123182328699](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231823326.png)



æ³¨æ„è¿™é‡Œçš„`containerFactory`  åˆ›å»ºäº†ä¸€ä¸ª Kafka ç›‘å¬å™¨å®¹å™¨å·¥å‚ ï¼Œè¿™ä¸ªå·¥å‚é…ç½®äº† Kafka æ¶ˆè´¹è€…ï¼Œä½¿å…¶èƒ½å¤Ÿæ”¯æŒ**æ‰¹é‡æ¶ˆè´¹**

```java
@Bean
public KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>> batchConsumeListenContainerFactory() {
    log.info("---KafkaListenerContainerFactory---");
    ConcurrentKafkaListenerContainerFactory<String, String> factory = new ConcurrentKafkaListenerContainerFactory<>();
    log.info("---ConcurrentKafkaListenerContainerFactory---new");
    factory.getContainerProperties().setAckMode(AbstractMessageListenerContainer.AckMode.MANUAL);
    factory.setConsumerFactory(this.consumerFactory());
    log.info("---ConcurrentKafkaListenerContainerFactory---setConsumerFactory");
    factory.setConcurrency(this.concurrency);
    factory.getContainerProperties().setPollTimeout(2500L);
    factory.getContainerProperties().setIdleEventInterval(6000L);
    // å¼€å¯æ‰¹é‡æ¶ˆè´¹
    factory.setBatchListener(true);
    log.info("---ConcurrentKafkaListenerContainerFactory---return--");
    return factory;
}
```



åœ¨ä» Kafka æ¶ˆæ¯ä¸­æå–æ‰¹é‡åŒæ­¥çš„æ‰“å¡è®°å½•æ•°æ®ï¼ŒæŒ‰ç…§å‘˜å·¥çš„å”¯ä¸€é”®è¿›è¡Œåˆ†ç»„ï¼Œæ„å»ºä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œå…¶ä¸­é”®æ˜¯å‘˜å·¥çš„å”¯ä¸€é”®ï¼Œå€¼æ˜¯è¯¥å‘˜å·¥å¯¹åº”çš„æ‰“å¡è®°å½•åˆ—è¡¨åï¼Œå°±æ‰§è¡ŒçœŸæ­£çš„`batchSync`æ‰¹é‡åŒæ­¥é€»è¾‘ [åŒæ­¥æ‰“å¡æ•°æ®æŒ‰employeeIdåˆ†ç»„](#syncOptimize)ï¼š==batchSyncChannelRecordService.handleChannelRecords(employeeUniqkeyChannelRecordsMap);==

```java
    public void handleChannelRecords(Map<String, List<ChannelCheckInDataResDto>> employeeUniqkeyChannelRecordsMap) {
        if (MapUtils.isEmpty(employeeUniqkeyChannelRecordsMap)) {
            return;
        }
        MokaStopWatch stopWatch = new MokaStopWatch("æ‰¹é‡åŒæ­¥æ‰“å¡æ•°æ®");

        stopWatch.start("å¤„ç†å½“å‰åŒæ­¥çš„æ•°æ®ä»¥åŠçŠ¶æ€");
        // å¤„ç†å½“å‰åŒæ­¥çš„æ•°æ®ä»¥åŠçŠ¶æ€
        handleChannelSyncTaskData(employeeUniqkeyChannelRecordsMap);
        stopWatch.stop();

        stopWatch.start("å¤„ç†åŸå§‹åŒæ­¥çš„æ‰“å¡æ•°æ®");
        // å¤„ç†åŒæ­¥çš„æ‰“å¡æ•°æ®
        Map<String, List<ClockInRecord>> employeeUniqKeyRecordsMap = Maps.newHashMap();
        for (String employeeUniqKey : employeeUniqkeyChannelRecordsMap.keySet()) {
            List<ChannelCheckInDataResDto> channelRecords = employeeUniqkeyChannelRecordsMap.get(employeeUniqKey);
            Long employeeId = ClockRecordUtil.parseEmployeeIdFromEmployeeUniqKey(employeeUniqKey);

            if (CollectionUtils.isEmpty(channelRecords)) {
                log.info("{}æ²¡æœ‰éœ€è¦åŒæ­¥çš„æ•°æ®", employeeId);
                continue;
            }
            String key = SYNC_CHANNEL_DATA_KEY_PREFIX + employeeId;
            RLock lock = redissonClient.getLock(key);
            try {
                boolean lockFlag = lock.tryLock(10, TimeUnit.SECONDS);
                if (!lockFlag) {
                    log.error("å½“å‰å‘˜å·¥æ­£åœ¨åŒæ­¥æ‰“å¡æ•°æ®: {}", employeeId);
                    continue;
                }

                Map<SyncTypeEnum, List<ChannelCheckInDataResDto>> channelRecordsMap = channelRecords.stream().collect(Collectors.groupingBy(ChannelCheckInDataResDto::getChannel));
                Map<SyncTypeEnum, ChannelOriginRecordService> channelServiceMap = syncClockInRecordFactory.getSyncChannelRecordsByChannels(channelRecordsMap.keySet());
                List<ClockInRecord> clockInRecords = Lists.newArrayList();
                for (SyncTypeEnum channel : channelServiceMap.keySet()) {
                    ChannelOriginRecordService originRecordService = channelServiceMap.get(channel);
                    if (Objects.isNull(originRecordService)) {
                        log.error("æ²¡æœ‰æ‰¾åˆ°æ¸ é“å¯¹åº”çš„åŸå§‹è®°å½•å¤„ç†æ–¹å¼: {}, employeeUniqKey: {}", channel, employeeUniqKey);
                        continue;
                    }
                    // å¤„ç†åŸå§‹æ•°æ®
                    List<ClockInRecord> curChannelRecords = originRecordService.batchHandleOriginRecords(channelRecordsMap.getOrDefault(channel, Lists.newArrayList()));
                    clockInRecords.addAll(curChannelRecords);
                }
                employeeUniqKeyRecordsMap.put(employeeUniqKey, clockInRecords);
            } catch (Exception e) {
                log.error("{}å‘˜å·¥æ‰“å¡æ•°æ®åŒæ­¥å¤±è´¥", employeeId, e);
            } finally {
                if (lock.isHeldByCurrentThread() && lock.isLocked()) {
                    lock.unlock();
                }
            }
        }
        stopWatch.stop();

        stopWatch.start("ä¿å­˜æ•°æ®");
        transactionTemplate.execute(new TransactionCallbackWithoutResult() {
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus transactionStatus) {
                List<ClockInRecord> totalRecords = employeeUniqKeyRecordsMap.values().stream().flatMap(Collection::stream).collect(Collectors.toList());
                batchSaveClockRecords(totalRecords);
            }
        });
        stopWatch.stop();

        stopWatch.start("æ¨é€æ¶ˆæ¯");
        // æ¨é€ç›¸å…³æ¶ˆæ¯å¤„ç†åç»­ä¸šåŠ¡
        TransactionAsyncExecutor.asyncExecute(() -> postHandleResult(employeeUniqKeyRecordsMap));
        stopWatch.stop();

        log.info("æ•°æ®åŒæ­¥è€—æ—¶ï¼š{}", stopWatch.prettyPrint());
    }

```



æ³¨æ„è¿™ä¸€è¡Œä»£ç ,å®ƒä¼š**è·å–é€šé“å¯¹åº”çš„åŸå§‹æ‰“å¡è®°å½•åˆ—è¡¨ï¼Œè¿™é‡Œè·å–çš„å°±æ˜¯é£ä¹¦**

```java
List<ClockInRecord> curChannelRecords = originRecordService.batchHandleOriginRecords(channelRecordsMap.getOrDefault(channel, Lists.newArrayList()));
```





![](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232029497.png)



æœ€åè°ƒç”¨`larkService`ä¸‹çš„`batchSave`æ–¹æ³•ï¼Œå®Œæˆæ‰“å¡è®°å½•çš„åŒæ­¥ï¼š



![image-20231123203142111](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232031789.png)



å¯¹åº”çš„`mapper`æ–‡ä»¶ä¸ºï¼š

```xml
<insert id="batchInsert" keyColumn="id" keyProperty="id" parameterType="map" useGeneratedKeys="true">
  insert into hcm_abs_lark_origin_clock_record
  (ent_id, bu_id, user_id, corp_id, employee_id, detail, lark_record_id, check_time, batch_number)
  values
  <foreach collection="list" item="item" separator=",">
    (#{item.entId}, #{item.buId}, #{item.userId}, #{item.corpId}, #{item.employeeId},
    #{item.detail}, #{item.larkRecordId}, #{item.checkTime}, #{item.batchNumber})
  </foreach>
</insert>
```



æ•°æ®åº“ä¸­çš„è®°å½•ä¸ºï¼š

![image-20231123203601172](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232036853.png)













## 2ã€å®æ—¶æ‰“å¡â€”è€ƒå‹¤æœºåŒæ­¥



ç›®å‰ppæ”¯æŒäº†ä¸¤ç±»è€ƒå‹¤æœºï¼šå¤©æ•è€ƒå‹¤æœºã€ä¸­æ§è€ƒå‹¤æœºã€‚ä¸¤ç±»è€ƒå‹¤æœºåœ¨æ¥å…¥æµç¨‹å’Œæ•°æ®äº¤äº’æµç¨‹ä¸Šä¸å…¨ç›¸åŒ 

  

|            | ä¼ è¾“åè®®                                         | äººè„¸æ£€æµ‹ | äººå‘˜ä¸‹å‘       | æ‰“å¡æ•°æ®è·å– |
| :--------- | :----------------------------------------------- | :------- | :------------- | :----------- |
| å¤©æ•è€ƒå‹¤æœº | websocket(äººå‘˜ä¸‹å‘ã€å¿ƒè·³æ£€æµ‹)+http(æ‰“å¡æ•°æ®ä¸ŠæŠ¥) | å·²æ¥å…¥   | è€ƒå‹¤æœºé€ä¸ªä¸‹å‘ | ä¸»åŠ¨ä¸ŠæŠ¥     |
| ä¸­æ§è€ƒå‹¤æœº | http                                             | æš‚æœªæ¥å…¥ | ä¸­æ§serverä¸‹å‘ | ä¸»åŠ¨å®šæœŸæ‹‰å– |





### æ¶æ„å›¾

**å¤©æ•è€ƒå‹¤æœºæœåŠ¡æ¶æ„å›¾**å¦‚ä¸‹ï¼š





![è€ƒå‹¤æœºæ¶æ„æµç¨‹.drawio](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241732116.png)



è¿™é‡Œéœ€è¦å…³æ³¨å‡ ä¸ªç‚¹ï¼š

1. è€ƒå‹¤æœºçš„é‰´æƒï¼šwebsocketçš„æ¡æ‰‹é˜¶æ®µ(åè®®æœªå‡çº§å‰çš„æ­¥éª¤)å¯ä»¥æ‹¿åˆ°è¯·æ±‚ä¸­ä¼ å…¥çš„param,é€šè¿‡è¿™ä¸ªparamæˆ‘ä»¬å¯ä»¥å¯¹è€ƒå‹¤æœºè¿›è¡Œé‰´æƒ --ç»™æ¯ä¸ªä½æˆ·åˆ†é…ä¸€ä¸ªkey, è¯·æ±‚è¿›æ¥æ—¶ï¼Œå¯¹keyè¿›è¡Œæœ‰æ•ˆåˆ¤æ–­
2. æ€ä¹ˆè¯†åˆ«æŸä¸ªè€ƒå‹¤æœºæ˜¯å“ªä¸ªç§Ÿæˆ·çš„ï¼Ÿè€ƒå‹¤æœºè¿æ¥æˆåŠŸåï¼Œwebsocketä¼šç†è§£ç»™è€ƒå‹¤æœºå‘é€ä¸€ä¸ªdeviceInfoçš„æ¶ˆæ¯ï¼ŒdeviceInfoçš„åº”ç­”å†…å®¹ä¸­æœ‰è€ƒå‹¤æœºçš„macåœ°å€ï¼Œåå°é€šè¿‡macåœ°å€ï¼Œè¯†åˆ«å‡ºæ¥è¿™ä¸ªè€ƒå‹¤æœºæ˜¯å“ªä¸ªç§Ÿæˆ·çš„ ã€‚åç»­sessionå›è¯ç®¡ç†ä¼šå°†macåœ°å€å’Œsocketé“¾æ¥å»ºç«‹å…³ç³» 

é—®é¢˜ï¼š

1. ç›®å‰çº¿ä¸Šå’Œç°åº¦æ˜¯å„è‡ªä¸¤å°websocket, é€šè¿‡ä¸Šé¢çš„æ¶æ„å›¾å¯ä»¥çœ‹å‡ºï¼Œwebsocket serverå’Œgatewayæ˜¯é•¿è¿æ¥çš„å½¢å¼ï¼š å¦‚æœæœ‰ä¸€å°websocket serverå‡ºç°é—®é¢˜ï¼Œwebsocketè¿›è¡Œè¿æ¥é‡å»ºï¼Œå‡ºé—®é¢˜çš„é‚£å°websocketå¯åŠ¨æˆåŠŸåï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯æ²¡æœ‰è¿æ¥çš„ ã€‚çº¿ä¸Šæš‚æ—¶æœªå‘ç°è¿™ä¸ªæƒ…å†µå‡ºç°ï¼Œå› ä¸ºè€ƒå‹¤æœºä¸­æ–­åï¼Œé‡æ–°å»ºç«‹è¿æ¥æ—¶ï¼Œå¯ä»¥é€‰æ‹©åˆ°å…¶ä»–çš„æœºå™¨
2. è€ƒå‹¤æœºå¤©æ•æ˜¯æ”¯æŒhttpåè®®çš„ï¼Œä½†æ˜¯æˆ‘ä»¬é€‰æ‹©äº†websocketåè®®ï¼Œè¿™é‡Œçš„åŸå› å’ŒèƒŒæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ å¦‚æœä½¿ç”¨httpåè®®ï¼Œè€ƒå‹¤æœºéœ€è¦æä¾›ä¸€ä¸ªå¯ä»¥è¢«è®¿é—®çš„å¤–ç½‘åœ°å€ï¼Œåœ¨ä½¿ç”¨åœºæ™¯ä¸‹ä¸å¤ªåˆé€‚ 







### æµç¨‹å›¾



å¤©æ•è€ƒå‹¤æœºäº¤äº’æµç¨‹V1:

![å¤©æ•è€ƒå‹¤æœºäº¤äº’æµç¨‹.drawio](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241738503.png)







å¤©æ•è€ƒå‹¤æœºäº¤äº’æµç¨‹V2:

![å¤©æ•è€ƒå‹¤æœºæµç¨‹æ¢³ç†V2.drawio](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241739243.png)







## 3ã€å®æ—¶æ‰“å¡â€”Mokaæ‰“å¡ :exclamation:

MokaPeople ç§»åŠ¨ç«¯æ‰“å¡å±äºå®æ—¶æ‰“å¡çš„ä¸€ç§ï¼Œæ—§çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![ç§»åŠ¨ç«¯æ‰“å¡](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291725750.png)





![image-20231204154846112](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041548328.png)





1.æ–°çš„ç§»åŠ¨ç«¯å®æ—¶æ‰“å¡å…¥å£åœ¨`ClockOnPageController`å†…(==/v2/m/clockOn==)ï¼š

![image-20231204153707026](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041537220.png)



2.æ„å»ºæ‰“å¡ä¸Šä¸‹æ–‡ã€é€‰æ‹©å¯¹åº”çš„æ‰“å¡Processor(WIFIã€GPSã€OutSide)ã€è¿›å…¥æ‰“å¡æ ¸å¿ƒæµç¨‹

```java
 public ClockOnResultDto clockOn(ClockOnReqV2Dto clockOnReqDto, Long entId, Long buId, Long employeeId) {
        StopWatch stopWatch = new MokaStopWatch("æ‰“å¡æ¥å£");

        stopWatch.start("æ‰“å¡ä¸Šä¸‹æ–‡æ„å»º");
        ClockOnResultDto clockOnResultDto = new ClockOnResultDto();
        Date attendanceDay = clockOnReqDto.getAttendanceDay();
        Date clockInTime = DateTime.now().millisOfSecond().withMinimumValue().toDate();
        ClockOnContext clockOnContext = ClockOnContext.builder().entId(entId).buId(buId).employeeId(employeeId)
                .attendanceDay(attendanceDay)
                .needCheckOfficeStaff(true)
                .macAddress(clockOnReqDto.getMacAddress())
                .longitude(clockOnReqDto.getLongitude())
                .latitude(clockOnReqDto.getLatitude())
                .gpsAddress(clockOnReqDto.getGpsAddress())
                .deviceId(clockOnReqDto.getDeviceId())
                .description(clockOnReqDto.getDescription())
                .attachment(clockOnReqDto.getAttachment())
                .relatedRecordId(clockOnReqDto.getRelatedRecordId())
                .relatedRecordType(clockOnReqDto.getRelatedRecordType())
                .clockTime(clockInTime)
                .sourceType(ClockRecordSourceTypeEnum.CLOCK.getValue())
                .build();

        List<AbstractClockTypeProcessor> processorList = Lists.newArrayList(wifiClockOn, gpsClockOn, outSideClockOn).stream().sorted(Comparator.comparing(AbstractClockTypeProcessor::sortOrder)).collect(toList());
        AbstractClockTypeProcessor validProcessor = null;
        stopWatch.stop();

        stopWatch.start("æ‰“å¡å¤„ç†å™¨æ‰§è¡Œ");
        for (AbstractClockTypeProcessor processor : processorList) {
            if (!processor.ruleOpen(clockOnContext)) {
                continue;
            }
            if (!processor.isValid(clockOnContext)) {
                continue;
            }
            validProcessor = processor;
            break;
        }
        stopWatch.stop();

        stopWatch.start("æ‰“å¡æ ¸å¿ƒæµç¨‹");
        if (validProcessor != null) {
            addClockRecordAndPushSuccessNotify(clockOnContext, validProcessor);
            clockOnResultDto.setClockInTime(clockInTime);
            clockOnResultDto.setClockOnStatus(true);
        } else {
            clockOnResultDto.setClockInTime(null);
            clockOnResultDto.setClockOnStatus(false);
        }
        stopWatch.stop();
        log.info(stopWatch.prettyPrint());

        return clockOnResultDto;
    }
```



3.(`addClockRecordAndPushSuccessNotify(clockOnContext, validProcessor)`)æ·»åŠ æ‰“å¡è®°å½•ï¼Œå¹¶å‘é€æˆåŠŸæ¶ˆæ¯

```java
/**
 * æ·»åŠ æ‰“å¡è®°å½•ï¼Œå¹¶å‘é€æˆåŠŸæ¶ˆæ¯
 *
 * @param clockOnContext
 * @param processor
 */
public void addClockRecordAndPushSuccessNotify(ClockOnContext clockOnContext, AbstractClockTypeProcessor processor) {
    StopWatch stopWatch = new StopWatch("ç§»åŠ¨ç«¯æ‰“å¡");
    Long entId = clockOnContext.getEntId();
    Long buId = clockOnContext.getBuId();
    Long employeeId = clockOnContext.getEmployeeId();
    Date attendanceDay = clockOnContext.getAttendanceDay();

    stopWatch.start("è®°å½•æ‰“å¡è®°å½•");
    processor.addClockRecord(clockOnContext);
    stopWatch.stop();

    stopWatch.start("rpcè§¦å‘æ‰“å¡è€ƒå‹¤æ ¸ç®—");
    attendanceRecordV2Service.clockCalculate(entId, buId, employeeId, attendanceDay);
    stopWatch.stop();

    stopWatch.start("å‘é€æ‰“å¡æˆåŠŸå¼‚æ­¥é€šçŸ¥");
    ClockSuccessNotifyContext clockSuccessNotifyContext = ClockSuccessNotifyContext.buildClockRecordContextFromClockOnAction(clockOnContext);
    clockNoticeMsgPushService.asyncPushClockSuccessNotify(clockSuccessNotifyContext);
    stopWatch.stop();

    log.info(stopWatch.prettyPrint());

}
```

è¿™ä¸€æ­¥éª¤ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š

#### æ‰“å¡è®°å½•å…¥åº“(äº‹åŠ¡ä¿è¯Mokaæ‰“å¡è¡¨æ•°æ®å’Œæ‰“å¡æ€»è¡¨æ•°æ®ä¸€è‡´æ€§)

![image-20231204155642559](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041556776.png)

â€‹    å½•å…¥ moka people åŸå§‹æ‰“å¡è®°å½•è¡¨`hcm_abs_moka_clock_record`:

![image-20231204160401684](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041604905.png)   



â€‹    å½•å…¥æ‰“å¡è®°å½•æ€»è¡¨ `hcm_abs_clock_in_record`:

![image-20231204160825399](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041608682.png)





#### RPC è§¦å‘æ‰“å¡è€ƒå‹¤æ ¸ç®—(åŠ å…¥åˆ¤æ–­æ ¸ç®—é™çº§é€»è¾‘)ï¼š

```java
public void clockCalculate(Long entId, Long buId, Long employeeId, Date attendanceDay) {

    //é™çº§æ¨¡å¼
    DegradationModelEnum degradationModel = imitateClockFailedBackHandler.degradationModel();
    try {
        if(degradationModel == DegradationModelEnum.ACTIVE){
            log.info("æ‰“å¡å®æ—¶æ ¸ç®—ä¸»åŠ¨è§¦å‘é™çº§,entId:{},employeeId:{}",entId,employeeId);
            // å‘é€è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯
            Period<Day> period = Period.between(Day.of(attendanceDay), Day.of(attendanceDay));
            BatchCalculateMessageDto batchCalculateMessageDto = BatchCalculateMessageDto
                    .buildBatchCalculateMessage(Tenant.of(entId, buId), period, Lists.newArrayList(employeeId));
            clockInRecordAddMsgProducer.pushBatchCalculateMsg(batchCalculateMessageDto);
        }else{
            ClockCalculateDto clockCalculateDto = new ClockCalculateDto();
            clockCalculateDto.setEntId(entId);
            clockCalculateDto.setBuId(buId);
            clockCalculateDto.setEmployeeId(employeeId);
            clockCalculateDto.setWorkflowStatusList(Lists.newArrayList(WorkflowStatusEnum.APPROVED));
            clockCalculateDto.setCalculateDate(attendanceDay);
            clockCalculateDto.setUid(employeeId);
            clockCalculateDto.setSourceType(AttendanceCalculateSourceTypeEnum.CLOCK);


          
          // è§¦å‘æ‰“å¡å®æ—¶æ ¸ç®—
            ResultDto clockCalculateResult = attendanceCalculateClient.clockCalculate(clockCalculateDto);
            if (clockCalculateResult == null || !clockCalculateResult.success()) {
                log.info("clockCalculate failed, param:{}, result:{}", JacksonUtils.toJson(clockCalculateDto), JacksonUtils.toJson(clockCalculateResult));
                //å¦‚æœå®æ—¶æ‰“å¡æ ¸ç®—å¤±è´¥ï¼ŒæŠ›å¼‚å¸¸èµ°é™çº§
                throw new CustomException("æ‰“å¡æ ¸ç®—å¤±è´¥");
            }
        }
    } catch (Exception e) {
        log.warn("è€ƒå‹¤æ ¸ç®—å¤±è´¥ entId:{}, employeeId:{},attendanceDay:{}", entId, employeeId, attendanceDay, e);
        if(degradationModel == DegradationModelEnum.PASSIVE){
            log.error("è°ƒç”¨å®æ—¶è€ƒå‹¤æ ¸ç®—æŠ¥é”™ï¼Œè¢«åŠ¨é™çº§æ¨¡å¼ï¼Œè§¦å‘é™çº§");
            // å‘é€è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯
            Period<Day> period = Period.between(Day.of(attendanceDay).add(-1), Day.of(attendanceDay).add(1));
            BatchCalculateMessageDto batchCalculateMessageDto = BatchCalculateMessageDto.builder()
                    .entId(entId)
                    .buId(buId)
                    .employeeIdList(Lists.newArrayList(employeeId))
                    .beginDate(period.getStart().toDate())
                    .endDate(period.getEnd().toDate())
                    .sourceType(AttendanceCalculateSourceTypeEnum.CLOCK_MOKA)
                    .triggerOverTime(true)
                    .uid(1L)  // 1è¡¨ç¤ºç³»ç»Ÿè§¦å‘çš„æ ¸ç®—
                    .build();
            clockInRecordAddMsgProducer.pushBatchCalculateMsg(batchCalculateMessageDto);
        }
    }
}
```



åˆ¤æ–­é™çº§åä¼šå‘é€`kafka`æ¶ˆæ¯ï¼š

![image-20231204163018146](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041630404.png)

`hcm-attendance` æ¥æ”¶æ¶ˆæ¯è¿›è¡Œè€ƒå‹¤æ‰¹é‡æ ¸ç®—ï¼š

![image-20231204163320564](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041633826.png)





> Tipsï¼šé™çº§æ¨¡å¼ä¸‹çš„æ ¸ç®—ä¸éé™çº§æ¨¡å¼ä¸‹çš„æ ¸ç®—é€»è¾‘åŒºåˆ«åœ¨å“ªé‡ŒğŸ§?



å¦‚æœèµ°é™çº§ï¼šåˆ™å‘é€ä¸€ä¸ª`kafka`æ¶ˆæ¯è‡³æŒ‡å®š`topic`ï¼Œå¹¶ä¸å…³æ³¨ä»€ä¹ˆä¸‹æ¸¸æ¶ˆè´¹è€…æ—¶å€™æ¶ˆè´¹

![image-20231204192546711](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041925018.png)



å¦‚æœä¸èµ°é™çº§æ¨¡å¼ï¼šåˆ™æ‰§è¡Œå®æ—¶æ ¸ç®—ï¼š

![image-20231204192811184](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041928504.png)



é‚£ä¹ˆå¦‚ä½•åˆ¤æ–­è¯¥èµ° é™çº§/éé™çº§ é“¾è·¯å‘¢ï¼Ÿ

åœ¨ä¸‹åˆ—`degradationModel`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå°è¯•ä»é…ç½®ä¸­å¿ƒè·å–æ‰“å¡é™çº§æ¨¡å¼çš„é…ç½®é¡¹å€¼ã€‚å®ƒä½¿ç”¨äº†`MokaConfig.getInstance().getPropertyFromDefault`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå°è¯•ä»é…ç½®ä¸­å¿ƒè·å–åä¸º`CLOCK_DEGRADATION_MODEL`çš„é…ç½®é¡¹çš„å€¼ã€‚å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™é»˜è®¤ä¸ºè¢«åŠ¨é™çº§æ¨¡å¼ï¼ˆ`DegradationModelEnum.PASSIVE`ï¼‰

```java
//é™çº§æ¨¡å¼
DegradationModelEnum degradationModel = imitateClockFailedBackHandler.degradationModel();


/**
     * é™çº§æ¨¡å¼
     * @return
     */
public DegradationModelEnum degradationModel(){
  try {
    //return DegradationModelEnum.parse(this.clockDegradationModel);
    String degradationModel = MokaConfig.getInstance().getPropertyFromDefault(CLOCK_DEGRADATION_MODEL, String.class, DegradationModelEnum.PASSIVE.name());
    return DegradationModelEnum.parse(degradationModel);
  }catch (Exception e){
    log.error("æŸ¥è¯¢æ‰“å¡é™çº§æ¨¡å¼å¤±è´¥ï¼Œé»˜è®¤å…³é—­é™çº§");
    return DegradationModelEnum.OFF;
  }
}
```



apolloé…ç½®å¦‚ä¸‹ï¼š

![image-20231204195330851](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041953186.png)



å¯ä»¥çœ‹å‡º Key ä¸º`CLOCK_DEGRADATION_MODEL`å¯¹åº”çš„ Value é»˜è®¤å€¼ä¸º **Passive â€”â€”è¢«åŠ¨é™çº§**ï¼Œå› æ­¤åªæœ‰åœ¨è¿œç¨‹è°ƒç”¨`attendanceCalculateClient.clockCalculate()`å¼‚å¸¸æ—¶ï¼Œä¼šæ•æ‰å¼‚å¸¸catchä»£ç å—æ‰§è¡Œé™çº§é€»è¾‘ï¼š

![image-20231204195835988](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041958317.png)



















#### å‘é€æ‰“å¡æˆåŠŸå¼‚æ­¥é€šçŸ¥

```java
clockNoticeMsgPushService.asyncPushClockSuccessNotify(clockSuccessNotifyContext);
```



å‘é€æ‰“å¡æˆåŠŸé€šçŸ¥æ—¶é€šè¿‡è‡ªå®šä¹‰çº¿ç¨‹æ± æ¥å‘é€ï¼š

![image-20231204164153738](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041641050.png)

æ¨é€æ¶ˆæ¯ï¼š

```java
/**
 * æ¨é€æ‰“å¡æˆåŠŸé€šçŸ¥
 *
 * @param clockSuccessNotifyContext æ‰“å¡è®°å½•
 */
@Override
public void asyncPushClockSuccessNotify(ClockSuccessNotifyContext clockSuccessNotifyContext) {
    CLOCK_SUCCESS_NOTICE_MSG_SEND_THREAD_POOL.execute(() -> {
        try {
            Long entId = clockSuccessNotifyContext.getEntId();
            boolean isOff = ApolloUtil.isClockSuccessNotifySwitchIsOff(entId);
            if (isOff) {
                log.info("å½“å‰ç§Ÿæˆ·æ‰“å¡æˆåŠŸæé†’å·²å…³é—­, entId:{}", entId);
                return;
            }

            log.info("æ‰“å¡è®°å½•æ¨é€æ‰“å¡æˆåŠŸæé†’é€šçŸ¥ record : {}", clockSuccessNotifyContext.toString());
            //å‘é€æ‰“å¡è®°å½•æ ¡éªŒæé†’
            for (ClockSuccessNotifyCheck clockSuccessNotifyCheck : clockNotifyCheckList) {
                if (!clockSuccessNotifyCheck.verifyNeedNotify(clockSuccessNotifyContext)) {
                    log.info("æ‰“å¡æˆåŠŸæé†’æ ¡éªŒå¤±è´¥ï¼Œä¸å‘é€æ‰“å¡é€šçŸ¥");
                    return;
                }
            }
            log.info("å‘˜å·¥æ‰“å¡æˆåŠŸæ¨é€æ‰“å¡æˆåŠŸæ¶ˆæ¯ pushClockSuccessNotify  entId :{}, bu:{}, uid:{}", clockSuccessNotifyContext.getEntId(), clockSuccessNotifyContext.getBuId(), clockSuccessNotifyContext.getEmployeeId());
            PushMsg pushMsg = new PushMsg();
          
            //æ ¹æ®æ‰“å¡è®°å½•ç”Ÿæˆæ‰“å¡æˆåŠŸé€šçŸ¥title
            pushMsg.setTitle(generateClockTitle(clockSuccessNotifyContext));
            
            //æ ¹æ®æ‰“å¡è®°å½•ç”Ÿæˆæ‰“å¡å‘é€é€šçŸ¥å†…å®¹
            pushMsg.setMsg(generateClockMsg(clockSuccessNotifyContext));
            pushMsg.setMsgType(PushMsg.TYPE_CLOCK_NOTICE);
            pushMsg.setMsgOrigId(0L);
            // æ¥æ”¶æ¶ˆæ¯çš„ç”¨æˆ·
            pushMsg.setMsgTargIdList(Collections.singletonList(clockSuccessNotifyContext.getEmployeeId()));
            pushMsg.setMsgId(PushMsgKeyUtil.generateKeyWithSnowFlake());
            pushMsg.setEntId(clockSuccessNotifyContext.getEntId().intValue());
            pushMsg.setBuId(clockSuccessNotifyContext.getBuId().intValue());
            pushMsg.setCreateTime(System.currentTimeMillis());

            EmployeeAttendanceRuleDetailDto attendanceRuleDetailDto = clockSuccessNotifyContext.getAttendanceRuleDetailDto();
            AttendanceRuleClockDto clockDto = attendanceRuleDetailDto.getClockInfo();
            if (clockDto.getIsNeedClock() || clockDto.getIsAllowOutsideClock()) {
                pushMsg.setHaveRedirectUrl(true);
            } else {
                pushMsg.setHaveRedirectUrl(false);
            }

            Message message = Message.builder()
                    .topic(topic)
                    .body(JacksonUtils.toJson(pushMsg))
                    .build();
            boolean pushFlag = defaultMsgProducer.pushMsg(message);
            if (pushFlag) {
                log.info("æ‰“å¡æˆåŠŸæ¶ˆæ¯æ¨é€kafka success pushClockSuccessNotify msg ={}", JacksonUtils.toJson(message));
            } else {
                log.warn("æ‰“å¡æˆåŠŸæ¶ˆæ¯æ¨é€kafkaå¤±è´¥ pushClockSuccessNotify msg ={}", JacksonUtils.toJson(message));
            }
        } catch (Exception e) {
            log.error("æ‰“å¡è®°å½•æ¨é€æ‰“å¡æˆåŠŸæé†’é€šçŸ¥å¤±è´¥, record : {}", JacksonUtils.toJson(clockSuccessNotifyContext), e);
        }
    });
}
```













# æ‰“å¡é“¾è·¯ä¼˜åŒ–



## èƒŒæ™¯ä¸é—®é¢˜

ç›®å‰æ‰“å¡æ˜¯å‡å‹¤é‡Œé¢ç”¨çš„æœ€å¤šçš„ä¸€ä¸ªä¸šåŠ¡ï¼ŒåŠ ç­ã€è€ƒå‹¤æ ¸ç®—ã€å‡ºå·®ã€å¤–å‡ºéƒ½å¯èƒ½ä¼šç”¨æ‰“å¡ä½œä¸ºåŸºç¡€æ•°æ®ï¼Œæ‰€ä»¥æ‰“å¡æ•°æ®èƒ½åŠæ—¶åŒæ­¥ã€å‘˜å·¥æ‰“å¡åŠ¨ä½œèƒ½å¿«é€Ÿæµç•…çš„å®Œæˆï¼Œå¯¹ç³»ç»Ÿä¸šåŠ¡åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒéå¸¸é‡è¦ã€‚

ä½†ç›®å‰æˆ‘ä»¬ç³»ç»Ÿæ‰“å¡è¿˜å­˜åœ¨ä¸€å®šé—®é¢˜ï¼Œä¸»è¦æ˜¯ï¼ˆåˆ’çº¿çš„æœ¬æ¬¡æ–¹æ¡ˆæœªè§£å†³ï¼‰ï¼š

1ã€å‘˜å·¥æ‰“å¡çš„æ—¶å€™ç”±äº`attendance`æœåŠ¡çš„å‹åŠ›ï¼Œæœ‰å¯èƒ½æ¨¡æ‹Ÿæ ¸ç®—å¤±è´¥ï¼Œå‘˜å·¥æ‰“ä¸äº†å¡ï¼ˆç§»åŠ¨ç«¯è€ƒå‹¤æ ¸ç®—é€Ÿåº¦æ…¢ï¼‰

2ã€**åŒæ­¥æ‰“å¡æ•°æ®åå‘è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯æ˜¯ä¸€æ¡ä¸€æ¡å‘çš„ï¼Œå¢åŠ äº†attendanceæœåŠ¡çš„æ ¸ç®—å‹åŠ›ï¼›æ ¡éªŒæ˜¯å¦å·²è½åº“æŒ‰å•æ¡è®°å½•åŠ é”ï¼Œæ•ˆç‡ä½**ï¼ˆ==åŒæ­¥æ‰“å¡ä¼˜åŒ–==ï¼‰

~~3ã€åŒæ­¥æ‰“å¡çš„æ•°æ®æºåº”ç”¨é™æµï¼Œå¯¼è‡´æˆ‘ä»¬æ‰“å¡æ•°æ®ä¸èƒ½åŠæ—¶åŒæ­¥ï¼ˆ==åŒæ­¥æ‰“å¡ä¼˜åŒ–==ï¼‰~~

~~4ã€å¦‚æœå‘˜å·¥åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨è¡¥å¡ï¼Œè¶…è¿‡æˆ‘ä»¬æœ€å¤§åŒæ­¥æ—¶é—´ï¼ŒåŒæ­¥ä¸äº†æ‰“å¡æ•°æ®ï¼ˆåŒæ­¥ï¼Œå½“å‰è¶…è¿‡xåˆ†é’Ÿä¹ŸåŒæ­¥ä¸è¿‡æ¥ï¼‰~~

~~5ã€å…¥èŒæœªç»‘å®šåˆ°ç¬¬ä¸‰æ–¹åº”ç”¨æˆ–ç¦»èŒå‘˜å·¥æ‰“å¡åŒæ­¥ä¸è¿‡æ¥ï¼ˆåŒæ­¥ï¼Œå—ç¬¬ä¸‰æ–¹åº”ç”¨é™åˆ¶ï¼‰~~

6ã€openapiæ²¡æœ‰æ¥æºæ–¹å¼å­—æ®µï¼ˆéœ€æ±‚ï¼‰

7ã€å‘˜å·¥æ‰“å¡è°ƒç”¨äº†å¤ªå¤šæ¬¡è€ƒå‹¤è§„åˆ™ï¼ŒabsenceæœåŠ¡å‹åŠ›å¢å¤§(==å®æ—¶æ‰“å¡ä¼˜åŒ–==)





## åŸæ¥æµç¨‹

**1ã€åŒæ­¥æ‰“å¡æµç¨‹**



![image-20231128195002904](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281950041.png)





2ã€å®æ—¶æ‰“å¡é“¾è·¯ä¼˜åŒ–



![image-20231128194850890](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281948030.png)







## ä¼˜åŒ–æ–¹æ¡ˆ :star2:



### **1ã€åŒæ­¥æ‰“å¡æµç¨‹ä¼˜åŒ–** <a name="syncOptimize"></a>

è§£å†³**åŒæ­¥å•æ¡å¤„ç†ï¼Œæ— æ³•æ‰¹é‡åˆå¹¶å‘é€è€ƒå‹¤æ ¸ç®—é—®é¢˜**

ä¼˜åŒ–é¢„æœŸæ•ˆæœï¼š

  1ï¼‰è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£çš„æ¬¡æ•°å‡å°‘ï¼Œé™ä½é™æµæ¦‚ç‡

  2ï¼‰æŒ‰å‘˜å·¥idæŒ‡å®šåˆ†åŒºå‘é€æ‰“å¡æ•°æ®ï¼Œå‡å°‘é”å†²çªï¼Œæ‰¹é‡å¤„ç†æ•°æ®ï¼Œæé«˜å¤„ç†æ•ˆç‡

  3ï¼‰åˆå¹¶æ‰“å¡è§¦å‘è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯ï¼Œå¢åŠ è€ƒå‹¤æ ¸ç®—æ•ˆç‡

  4ï¼‰åŒæ­¥æ‰“å¡å…¥å£éƒ½ç”¨åŒä¸€å¥—é€»è¾‘ï¼Œæ–¹ä¾¿ç»´æŠ¤



1.1 æ€»è§ˆï¼š

![image-20231128195049663](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281950808.png)







1.2 ä¿®æ”¹çš„åŠŸèƒ½ç‚¹

| åŠŸèƒ½ç‚¹                                                       | æ‰€å±æœåŠ¡   |
| :----------------------------------------------------------- | :--------- |
| mobile å•æœºé™æµæ”¹æˆåˆ†å¸ƒå¼ï¼Œæ‰€æœ‰å®ä¾‹ç»Ÿä¸€æ§åˆ¶                  | mobile     |
| åŒæ­¥æ‰“å¡æ•°æ®æŒ‰employeeIdåˆ†ç»„ï¼Œå¹¶æŒ‰employeeIdæ‰¹é‡åˆ†å‘åˆ°æŒ‡å®šåˆ†åŒºï¼Œä½¿ç”¨æ–°çš„topic | mobile     |
| å›è°ƒç»“æœå¢åŠ ç¼“å­˜é˜Ÿåˆ—ï¼Œ10Sæˆ–20æ¡æ•°æ®æ‰¹é‡æŸ¥è¯¢ç¬¬ä¸‰æ–¹æ‰“å¡è®°å½•ï¼Œå¹¶æŒ‰employeeIdæ‰¹é‡åˆ†å‘åˆ°æŒ‡å®šåˆ†åŒºï¼Œä½¿ç”¨æ–°çš„topic | mobile     |
| åŒæ­¥æ‰“å¡å¤„ç†æµç¨‹å¤„ç†ï¼Œä»æ–°topicå–æ‰“å¡æ•°æ®ï¼ŒæŒ‰å‘˜å·¥æ‰¹é‡å¤„ç†(åŠ é”ã€è½åº“ç­‰) | clock      |
| å‘é€è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯ä¼˜åŒ–ï¼ŒåŒä¸€ä¸ªå‘˜å·¥è¿ç»­å¤šå¤©çš„æ‰“å¡è®°å½•åˆå¹¶æˆä¸€æ¡è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯ï¼Œå¤šä¸ªå‘˜å·¥çš„è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯æ‰¹é‡å‘é€ï¼Œä½¿ç”¨æ–°çš„topic | clock      |
| æ¶ˆè´¹è€ƒå‹¤æ ¸ç®—æ¶ˆæ¯ä¿®æ”¹ï¼Œæ¶ˆè´¹æ–°çš„topicæ¶ˆæ¯                      | attendance |

æ¯ä¸ªåŠŸèƒ½ç‚¹å¯¹åº”çš„ä»£ç å—ä¸ºï¼š



#### é™æµä¼˜åŒ–

**(1) æ›´æ”¹ä¸ºåˆ†å¸ƒå¼é™æµç»Ÿä¸€æ§åˆ¶æ‰€æœ‰å®ä¾‹ï¼š**



Before: å…ˆæ¥çœ‹çœ‹æ—§æ–¹æ¡ˆçš„å¤„ç†æ–¹å¼(åŸºäºGuavaçš„å•æœºé™æµ)

![image-20231130130544775](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311301305215.png)



```java
/**
 * é’‰é’‰ç­¾åˆ°æ¥å£é™æµ â€”â€”version1
 */


private static final int DING_RATE_LIMIT_COUNT = 19;

public void dingCheckinAcquireByCorpId(String corpId){
    // é’‰é’‰ç­¾åˆ°å•æœºé™æµï¼Œæ¯S 40ä¸ª ä¸¤å°æœºå­ æ¯ä¸ª19 é˜²æ­¢è·‘æ»¡
    RateLimiter rateLimiter = null;
    if (absDingCheckinLimiterMap.containsKey(corpId)) {
        rateLimiter = absDingCheckinLimiterMap.get(corpId);
    }else{
        rateLimiter = RateLimiter.create(DING_RATE_LIMIT_COUNT);
        absDingCheckinLimiterMap.put(corpId, rateLimiter);
    }
    rateLimiter.acquire();
}


 @CanIgnoreReturnValue
    public double acquire() {
        return this.acquire(1);
}


----------------
  
   /**
     * é’‰é’‰ç­¾åˆ°æ¥å£é™æµ  â€”â€”version2
     */
    public void dingCheckinAcquireByCorpId(String corpId){
        RRateLimiter rRateLimiter = redissonClient.getRateLimiter("mobile:limiter:ding:checkin:" + corpId);
        rRateLimiter.trySetRate(RateType.OVERALL,40,1, RateIntervalUnit.SECONDS);
        rRateLimiter.acquire();
    }



-----------------
/**
     * é’‰é’‰ç­¾åˆ°æ¥å£é™æµ  â€”â€”version3
     */
    public void dingCheckinAcquireByCorpId(String corpId) {
        String key = "mobile:limiter:ding:checkin:" + corpId;
        log.info("dingCheckinAcquireByCorpId:{} ", key);
        redisLimitTemplate.initRateLimiter(key, 40 - LIMIT_BUFFER, 1, RateIntervalUnit.SECONDS);
        boolean acquire = redisLimitTemplate.tryAcquire(key, 3, TimeUnit.SECONDS);
        if (!acquire) {
            throw new CustomException("è¯·æ±‚è¢«é™æµæ§åˆ¶ï¼Œè¯·ç¨åé‡è¯•");
        }
    }  


```

å¯¹åº”çš„`RedisLimitTemplate`ç±»ä»£ç ä¸ºï¼š

![image-20231130142705047](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311301427513.png)











Now: æ›´æ”¹ä¸ºåˆ†å¸ƒå¼é™æµ

- [ ] Larké™æµï¼š

![image-20231129193438686](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291934382.png)



- [ ] ä¼ä¸šå¾®ä¿¡é™æµï¼š

![image-20231129193607884](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291936572.png)



- [ ] DingDingé™æµ: åŒç†





#### åˆå¹¶å‘é€æ¶ˆæ¯å¤„ç†ã€åŠ é”è½åº“



**(2) å°†æ‰“å¡æ•°æ®æŒ‰ç…§å‘˜å·¥idåˆ†ç»„ï¼Œæ‰¹é‡åˆ†å‘ã€æ¥æ”¶æ¶ˆæ¯**



- [ ] åˆ†å‘æ¶ˆæ¯ï¼š![image-20231129193114998](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291931698.png)



- [ ] æ¥æ”¶æ¶ˆæ¯ï¼š

  ![image-20231129193317457](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291933159.png)







(3) ==å›è°ƒç»“æœå¢åŠ ç¼“å­˜é˜Ÿåˆ—==

- å¯¹åº”çš„æ”¾åˆ°topicå¯ä»¥ç†è§£ä¸ºç¼“å­˜
- è°ƒç”¨å®ƒçš„åœ°æ–¹å°±ç±»ä¼¼äºæœ¬åœ°ç¼“å­˜äº†ï¼Œå…¶å®å°±æ˜¯æ‰¹é‡æŸ¥è¯¢





(4)åŒæ­¥æ‰“å¡å¤„ç†æµç¨‹å¤„ç†ï¼Œä»æ–°topicå–æ‰“å¡æ•°æ®ï¼ŒæŒ‰å‘˜å·¥æ‰¹é‡å¤„ç†(**åŠ é”ã€è½åº“**ç­‰):

è·¯å¾„ä¸º `BatchSyncChannelRecordServiceImpl#handleChannelRecords` æ–¹æ³•ï¼š

![image-20231130143745312](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311301437834.png)







(5)`hcm-absence-attendance`å¢åŠ æ‰¹é‡è§¦å‘æ ¸ç®—æ¶ˆæ¯ï¼š

![image-20231204141018839](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041410027.png)









### **2ã€å®æ—¶æ‰“å¡é“¾è·¯ä¼˜åŒ–**

è§£å†³æ¨¡æ‹Ÿæ ¸ç®—å¤±è´¥ï¼Œæ— æ³•æ‰“å¡ï¼Œè€ƒå‹¤è§„åˆ™è°ƒç”¨é¢‘ç¹å“åº”æ…¢çš„é—®é¢˜

ä¼˜åŒ–é¢„æœŸæ•ˆæœï¼šæ‰“å¡è°ƒç”¨æ¨¡æ‹Ÿæ ¸ç®—æ¥å£æ¬¡æ•°å‡å°‘ã€attendanceæœåŠ¡æŒ‚äº†æˆ–è€…æŠ¥é”™å‘˜å·¥ä»èƒ½æ­£å¸¸æ‰“å¡ã€æŸ¥è¯¢è€ƒå‹¤è§„åˆ™æ¥å£å“åº”æ›´å¿«

**2.1 æ€»è§ˆï¼š**

![image-20231129195131544](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311291951824.png)



####  æœåŠ¡é™çº§

| æ¥å£                                                         | æè¿°                                                 | é™çº§                                                     |
| :----------------------------------------------------------- | :--------------------------------------------------- | :------------------------------------------------------- |
| `/api/abs/clock/clockOnPage/v2/m/clockOn`                    | æ‰“å¡çš„æ—¶å€™å®æ—¶æ ¸ç®—ï¼Œå¼‚æ­¥é€šçŸ¥                         | å‘é€æ ¸ç®—æ¶ˆæ¯                                             |
| `/api/abs/clock/clockOnPage/v2/m/clockOutCheck`              | æ‰“ä¸‹ç­å¡çš„æ—¶å€™å…ˆæå‰æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ä¼šç­¾é€€å¼‚å¸¸ï¼Œæç¤ºç”¨æˆ· | ä¸å¤„ç†ï¼ˆå½“ä¸Šé¢ä¸¤ä¸ªæ¥å£é™çº§æˆæ— ç­æ¬¡ä¹‹åä¸ä¼šè°ƒç”¨è¿™ä¸ªæ¥å£ï¼‰ |
| `/api/abs/clock/clockOnPage/v2/m/queryClockRecord`           | æŸ¥è¯¢æ‰“å¡è®°å½•ï¼Œæ ‡è®°æ˜¯ç­¾åˆ°æˆ–ç­¾é€€å¡                     | åŒä¸Š                                                     |
| `/api/abs/clock/clockOnPage/v2/m/queryRuleAndAttendanceInfo` | æŸ¥è¯¢ç­æ¬¡ä¿¡æ¯ã€æ‰“å¡æ—¶é—´ä¿¡æ¯ã€è€ƒå‹¤è§„åˆ™ç­‰               | æŒ‰æ— ç­æ¬¡å¤„ç†ï¼Œclockå†…éƒ¨æŒ‰æ— ç­æ¬¡æ¨¡æ‹Ÿæ¨¡ç®—å¤åˆ¶ä¸€ä»½ä»£ç       |
| `/api/abs/clock/clockOnPage/v2/m/refreshGps`                 | åˆ·æ–°gpsä¿¡æ¯ï¼Œä¼šè°ƒè€ƒå‹¤è§„åˆ™ï¼Œè§¦å‘è‡ªåŠ¨æ‰“å¡              | ä¸å¤„ç†                                                   |
| `/api/abs/clock/clockOnPage/v2/m/refreshWifi`                | åˆ·æ–°wifiä¿¡æ¯ï¼Œä¼šè°ƒè€ƒå‹¤è§„åˆ™ï¼Œè§¦å‘è‡ªåŠ¨æ‰“å¡             | ä¸å¤„ç†                                                   |





 git clone -b main  https://github.com/fyupeng/rpc-netty-framework.git





**2.3 æ¥å£åˆå¹¶ï¼š**

`queryRuleAndAttendanceInfo` å’Œ `queryClockRecord` æ¥å£åˆå¹¶æˆä¸€ä¸ªæ¥å£è¿”å›ç»™å‰ç«¯







####  è€ƒå‹¤è§„åˆ™æ¥å£ç¼“å­˜

![è€ƒå‹¤è§„åˆ™ç¼“å­˜111.drawio](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281957236.png)



ç”±äºåœ¨è¿›è¡Œè€ƒå‹¤æ ¸ç®—æ—¶ï¼Œéœ€è¦æŸ¥è¯¢å‘˜å·¥å¯¹åº”è€ƒå‹¤è§„åˆ™(hcm-absenceä¸‹):

![image-20231204172235931](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041722302.png)



åˆ¤æ–­è€ƒå‹¤è§„åˆ™æ•°æ®æ˜¯å¦å‘½ä¸­ã€åŠæ˜¯å¦éœ€è¦åŠ å…¥ç¼“å­˜ï¼š

![image-20231204172714517](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312041727855.png)



ç€é‡æ¥çœ‹ä¸€ä¸‹ç¼“å­˜ç›¸å…³é€»è¾‘

1ã€ä»ç¼“å­˜ä¸­æŸ¥è¯¢è§„åˆ™ä¿¡æ¯ï¼š

```java
/**
 * ä»ç¼“å­˜ä¸­æŸ¥è¯¢è§„åˆ™ä¿¡æ¯
 * @param start
 * @param end
 * @param employeeIds
 * @param entId
 * @return null è¡¨ç¤ºç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œæˆ–è€…ç¼“å­˜ä¸­æ•°æ®å·²æ˜¯è¿‡æœŸæ•°æ®ï¼Œéœ€è¦é‡æ–°ä»dbæŸ¥è¯¢
 *         å¦‚æœè¿”å›ç»“æœä¸ä¸ºç©ºï¼Œå³ä½¿æ˜¯ä¸ªç©ºæ•°ç»„ï¼Œä¹Ÿä¸ç”¨ä»dbæŸ¥è¯¢ï¼ˆä¸ºç©ºæ•°ç»„è¯´æ˜è¿™å‡ å¤©ç¡®å®å°±æ˜¯æ²¡æœ‰é…ç½®è€ƒå‹¤è§„åˆ™ï¼‰
 */
private List<EmployeeAttendanceRuleDetailDto> queryRuleFromCache(LocalDate start,LocalDate end,int attrType,List<Long> employeeIds,Long entId){
    //æ„é€ ç¼“å­˜key
    List<String> keys = new ArrayList<>();
    List<LocalDate> dateList = this.getDates(start,end);
    dateList.forEach(date -> {
        employeeIds.forEach(employeeId -> {
            String key = getDetailCacheKey(entId,employeeId,date);
            keys.add(key);
        });
    });

    //æ‰¹é‡æŸ¥è¯¢ç»“æœ
    List<String> resStrs = redisTemplate.opsForValue().multiGet(keys);
    if(CollectionUtils.isEmpty(resStrs)){
        //ç¼“å­˜ä¸­å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å›ç©ºï¼Œè§¦å‘ä»åº“ä¸­æŸ¥è¯¢
        return null;
    }
    resStrs = resStrs.stream().filter(e -> Objects.nonNull(e)).collect(Collectors.toList());
    if(resStrs.size()!=keys.size()){
        //æ•°æ®æ¡æ•°å’Œè¯·æ±‚çš„æ¡æ•°å¯¹ä¸ä¸Šï¼Œè¯´æ˜æ²¡æœ‰ç¼“å­˜æˆ–ç¼“å­˜å·²è¿‡æœŸäº†ï¼Œè¿”å›ç©ºï¼Œè§¦å‘ä»åº“ä¸­æŸ¥è¯¢
        return null;
    }

    List<EmployeeAttendanceRuleDetailDto> ruleDtailList = new ArrayList<>();
    for(String resStr:resStrs){
        //å½“å¤©æœ‰è€ƒå‹¤è§„åˆ™æ‰è½¬æˆå¯¹åƒ
        if(!NONE_RULE.equals(resStr)){
            EmployeeAttendanceRuleDetailDto detailDto = JacksonUtils.fromJson(resStr,EmployeeAttendanceRuleDetailDto.class);
            ruleDtailList.add(dealRuleDetailDto(detailDto,attrType));
        }
    }
    log.info("ä»ç¼“å­˜ä¸­æŸ¥è¯¢è€ƒå‹¤è§„åˆ™è¯¦æƒ…,employeeIds:{},start:{},end:{}",employeeIds,DateUtils.format(start.toDate(),DatePattern.YMD),DateUtils.format(end.toDate(),DatePattern.YMD));
    return ruleDtailList;
}
```





2ã€å°†å‘˜å·¥åŠ å…¥åˆ°ç¼“å­˜é˜Ÿåˆ—

```java
        param.getEmployeeIds().forEach(employeeId -> {
            AddCacheMsg msg = AddCacheMsg.builder().employeeId(employeeId).entId(entId).buId(buId).build();
            boolean res = redisListTool.sendMsgToList(CacheConstants.getAddCacheQueueName(),JacksonUtils.toJson(msg),String.valueOf(employeeId));
            if(!res){
                log.warn("å‘˜å·¥åŠ ç¼“å­˜å¤±è´¥:{}",employeeId);
            }
        });





   public boolean sendMsgToList(String name, String msg, String key) {
    if (!StringUtils.isEmpty(name) && !StringUtils.isEmpty(key) && !StringUtils.isEmpty(msg)) {
        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨äºRedisä¸­
        Boolean existed = this.redisTemplate.opsForSet().isMember("hcm:absence:queue:" + name + "_unique", key);
        if (existed != null && existed) {
            log.warn("æ¶ˆæ¯å·²åœ¨Redisä¸­å­˜åœ¨ï¼Œä¸å‘é€");
            CountStatisticUtil.increment("msgExisted");
            return false;
        } else {
            // å°†æ¶ˆæ¯æ¨é€åˆ°Redisé˜Ÿåˆ—
            Long res = this.redisTemplate.opsForList().leftPush("hcm:absence:queue:" + name, JSONObject.toJSONString(new RedisQueueMsg(key, msg)));
            if (res != null && res > 0L) {
                // å°†æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†åŠ å…¥Redisé›†åˆ
                this.redisTemplate.opsForSet().add("hcm:absence:queue:" + name + "_unique", new String[]{key});
                // å‘é€é€šçŸ¥ï¼Œé€šçŸ¥æ¶ˆè´¹è€…æœ‰æ–°æ¶ˆæ¯
                this.redisTemplate.convertAndSend(this.config.getNoticeChannel(), name);
                CountStatisticUtil.increment("sendSuccess");
                return true;
            } else {
                return false;
            }
        }
    } else {
        CountStatisticUtil.increment("emptyMsg");
        return false;
    }
}

```





#### è€ƒå‹¤è§„åˆ™é™çº§è®¾è®¡



**ä¸€ã€é™çº§æ–¹æ¡ˆå›¾ç¤º**

**é™çº§çš„æ‰“å¡è®°åŒæ­¥åˆ°æ­£å¸¸æ‰“å¡è®°å½•è¡¨ç”Ÿå‘½å‘¨æœŸï¼šå…¥åº“ â†’ éªŒè¯æœ‰æ•ˆçŠ¶æ€ â†’ åŒæ­¥**

![è€ƒå‹¤è§„åˆ™é™çº§.drawio](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211805097.png)



**æ”¹åŠ¨ç‚¹è¯´æ˜ï¼š**

![image-20231221180646741](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211806926.png)





**äºŒã€éªŒè¯æµç¨‹**

éªŒè¯æµç¨‹åªåšéªŒè¯ï¼Œä¸åšåŒæ­¥

![éªŒè¯æµç¨‹.drawio](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211807932.png)



**ä¸‰ã€åŒæ­¥æµç¨‹**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312211808510.png" alt="image-20231221180807325" style="zoom:50%;" />







### **3ã€æ‰“å¡åˆ†è¡¨**



æ–¹æ¡ˆä¸€ï¼š æŒ‰ç§Ÿæˆ·åˆ†è¡¨

é…ç½®é‡Œé…ç½®å“ªäº›ç§Ÿæˆ·éœ€è¦å•ç‹¬åˆ†è¡¨ï¼Œå‰©ä¸‹ç§Ÿæˆ·ä½¿ç”¨åŸè¡¨ï¼›

å½“é…ç½®äº†ç§Ÿæˆ·åˆ†è¡¨åè°ƒç”¨æ¥å£åˆå§‹åŒ–ç§Ÿæˆ·çš„æ‰“å¡è¡¨ï¼Œç„¶åè¿ç§»ç§Ÿæˆ·æ•°æ®åˆ°ç›®çš„è¡¨ä¸­ï¼›

æ‰“å¡çš„`crud`é€šè¿‡`mybatis`æ’ä»¶ä¿®æ”¹è¡¨åï¼ŒæŒ‡å‘ç›®æ ‡è¡¨ï¼›

ä¼˜åŠ¿ï¼š

1ã€å¯ä»¥æ ¹æ®ç§Ÿæˆ·æ‰“å¡æ•°æ®é‡æ¥ç¡®å®šæ˜¯å¦éœ€è¦åˆ†åˆ°å•ç‹¬çš„è¡¨ï¼Œæˆ–è€…æŠŠå‡ ä¸ªç§Ÿæˆ·åˆåˆ°ä¸€ä¸ªè¡¨é‡Œé¢ï¼Œé˜²æ­¢æœ‰çš„è¡¨æ•°æ®å¤šï¼Œæœ‰çš„è¡¨æ•°æ®å°‘ï¼Œä¹Ÿå¯ä»¥æŠŠé‡ç‚¹ç§Ÿæˆ·å•ç‹¬æ‹‰å‡ºæ¥

2ã€åŒä¸€ä¸ªç§Ÿæˆ·çš„æ•°æ®åœ¨ä¸€ä¸ªè¡¨ä¸­ï¼Œå¯¹äºä¸šåŠ¡æŸ¥è¯¢æˆ–è½åº“æ— ä»»ä½•å½±å“ï¼Œä¸šåŠ¡å¥‘åˆåº¦å¾ˆé«˜ï¼ŒåŸºæœ¬ä¸Šä¸éœ€è¦ä¸Šå±‚æ”¹åŠ¨ä»€ä¹ˆä»£ç ã€‚

![image-20231128195839733](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281958881.png)



æ–¹æ¡ˆäºŒï¼š æŒ‰æ—¶é—´åˆ†è¡¨

2ä¸ªæœˆä¸€å¼ è¡¨ï¼Œä¸€å¼ è¡¨æ•°æ®é‡æ§åˆ¶åœ¨500Wä»¥ä¸‹ï¼Œå®šæ—¶ä»»åŠ¡åˆ›å»ºæœªæ¥çš„è¡¨ï¼Œåˆ†åº“åˆ†è¡¨æ¡†åŠ å¤„ç†æ•°æ®åº“è¯·æ±‚

ä¼˜åŠ¿ï¼šä¸éœ€è¦äººä¸ºå¹²é¢„åˆ†è¡¨ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®ä¹Ÿæ¯”è¾ƒå‡è¡¡ï¼Œä½†å¦‚æœè·¨è¡¨æŸ¥è¯¢å¯èƒ½æ¯”è¾ƒéº»çƒ¦ç‚¹

![image-20231128195923933](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311281959086.png)









## æ‰“å¡æ•…éšœå¤ç›˜





### äº‹æ•…æ¥é¾™å»è„‰



**å½±å“èŒƒå›´ï¼š**

- ä¸šåŠ¡å½±å“ï¼š
  - å—å½±å“çš„ä¸šåŠ¡åœºæ™¯ & ä¸¥é‡ç¨‹åº¦ï¼š å¤©ä¹å…±äº«ã€æµ™æ±ŸåŒ»å­¦ç§‘æŠ€å¼€å‘æœ‰é™å…¬å¸ã€è¿ˆæ ¼æ£®ç­‰éƒ¨åˆ†å‘˜å·¥æ‰“ä¸äº†å¡
- é‡åŒ–å½±å“ï¼š
  - å½±å“çš„å®¢æˆ·æ•°é‡ï¼š 3å®¶å®¢æˆ·ææŠ¥
  - å½±å“çš„æ•°æ®é‡ï¼š
  - å½±å“æ—¶é—´ï¼š**2023-03-10 17:36~2023-03-10 17:41ï¼ˆä»å‡ºé”™çš„æ—¥å¿—çœ‹ï¼‰**

é¡µé¢æ˜¾ç¤ºï¼š

1ã€æ‰“å¡é¡µé¢æç¤ºé”™è¯¯ï¼Œæ— æ³•æ‰“å¡

2ã€è¿›ä¸å»æ‰“å¡é¡µé¢

å½±å“ç§Ÿæˆ·ï¼š

| ç§Ÿæˆ·                       |
| :------------------------- |
| å¤©ä¹å…±äº«                   |
| æµ™æ±ŸåŒ»å­¦ç§‘æŠ€å¼€å‘æœ‰é™å…¬å¸   |
| æˆéƒ½è¿ˆæ ¼æ£®æ•™è‚²å’¨è¯¢æœ‰é™å…¬å¸ |
| å¹¿å·å°è¿ˆç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸   |
| åŒ—äº¬å¸Œç‘äºšæ–¯ç§‘æŠ€æœ‰é™å…¬å¸   |
| æ¬¢èšæ—¶ä»£æµ‹è¯•å…¬å¸           |
| åŒ—äº¬èœœè±åç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ |



**äº‹æ•…å‘ç°æ¸ é“**ï¼š

2023-03-10 17:33 å‘ç°sentryé¢‘ç¹æŠ¥é”™ ï¼Œ17:39ç¾¤é‡Œé¢åé¦ˆæœ‰å‘˜å·¥æ‰“ä¸äº†å¡



**äº‹æ•…æ—¶é—´çº¿ï¼ˆå°½é‡è¯¦å°½ï¼‰**ï¼š

| æ—¶é—´             | æ“ä½œ or æè¿°                                            |
| :--------------- | :------------------------------------------------------ |
| 2023-03-10 17:33 | çº¿ä¸Šsentryé—®é¢˜ç¾¤é¢‘ç¹æŠ¥é”™ï¼Œç ”å‘å¼€å§‹ä»‹å…¥æ’æŸ¥              |
| 2023-03-10 17:34 | å‘ç°attendanceæœ‰å¾ˆå¤šæ¨¡æ‹Ÿæ¨¡ç®—æŠ¥é”™ï¼ŒåŒ…æ‹¬äººäº‹æ¥å£æŠ¥é”™      |
| 2023-03-10 17:36 | clockè°ƒæ¨¡æ‹Ÿæ ¸ç®—æ¥å£ç†”æ–­                                 |
| 2023-03-10 17:39 | æœåŠ¡ä¾§åŒå­¦åœ¨ç¾¤é‡Œåé¦ˆç”¨æˆ·æ‰“ä¸äº†å¡ï¼Œäººäº‹åŒå­¦åˆ é™¤redisç¼“å­˜ |
| 2023-03-10 17:40 | æœ‰åŒå­¦åé¦ˆcorebaseæ¥å£æœ‰é—®é¢˜å·²å›æ»š                      |
| 2023-03-10 17:41 | é‡æ–°åˆ·æ–°ç¼“å­˜ï¼Œæ‰“å¡æ¢å¤æ­£å¸¸                              |
| 2023-03-10 18:10 | clockå’Œattendanceå¢åŠ ä¸€ä¸ªpod                            |









### äº‹æ•…ä¿®å¤



#### **ç ”å‘è§†è§’**



**ç›´æ¥åŸå› ï¼š**

  1ã€attendance æœåŠ¡çŸ­æ—¶é—´æœ‰å¤šä¸ªæ¨¡æ‹Ÿæ ¸ç®—çš„è¯·æ±‚è¶…è¿‡30sï¼Œclocké…ç½®çš„ç†”æ–­ç­–ç•¥æ˜¯è¶…æ—¶æ—¶é—´30sï¼Œçª—å£æœ€å°è¯·æ±‚æ•°é‡20ï¼Œå¤±è´¥é˜ˆå€¼æ˜¯50%ï¼Œè¶…æ—¶ç›´æ¥ç†”æ–­äº†

<img src="https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292000480.png" alt="image2023-3-14_20-53-40" style="zoom:67%;" />



- **é—´æ¥å› ç´ ï¼š**1ã€å¤©ä¹ï¼ˆ751ï¼‰åœ¨å½“å¤©æœ‰å¾ˆå¤šç»„ç»‡è°ƒæ•´ï¼Œè§¦å‘äº†è€ƒå‹¤è§„åˆ™ç¼“å­˜åˆ·æ–°

![image2023-3-16_19-34-34](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292000262.png)





éƒ¨é—¨å˜æ›´è§¦å‘åˆ·æ–°ç¼“å­˜è§„åˆ™çš„æ—¶å€™ä¼šåˆ·æ•´ä¸ªç§Ÿæˆ·çš„ç¼“å­˜ï¼Œéœ€è¦è°ƒäººäº‹æ¥å£æŸ¥æ‰€æœ‰éƒ¨é—¨æ‰€æœ‰äººå‘˜ï¼Œæ¥å£æŠ¥é”™ï¼Œå¯¼è‡´åˆ·æ–°ç¼“å­˜å¤±è´¥ï¼š 



![image2023-3-16_19-39-46](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292001613.png)



![image2023-3-16_19-36-12](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292002444.png)



åˆ·æ–°ç¼“å­˜å¤±è´¥æœ‰ä¸ªé€»è¾‘ï¼Œä¼šåˆ é™¤ç§Ÿæˆ·ç¼“å­˜æ ‡è¯†ï¼ŒæŸ¥è¯¢çš„æ—¶å€™å¦‚æœå‘ç°æ²¡æœ‰è¿™ä¸ªæ ‡è¯†ï¼Œä¼šç›´æ¥ä»dbä¸­æŸ¥è¯¢ï¼Œæ•´ä¸ªæ¥å£æ€§èƒ½å°±ä¼šä¸‹é™

![image2023-3-16_19-45-54](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292003240.png)



![image2023-3-16_19-47-0](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292003212.png)





å¤©ä¹æ‰€æœ‰æ‰“å¡å‘˜å·¥åœ¨17:37åéƒ½ç›´æ¥èµ°dbæŸ¥è¯¢ï¼Œå¹³å‡å“åº”æ—¶é—´è¶…è¿‡3sé’Ÿï¼Œå½“å‰è¯·æ±‚é‡å¾ˆå¤§ï¼Œå½±å“ä¸Šæ¸¸attendanceä¸šåŠ¡

![image2023-3-15_13-53-39](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292004193.png)





 17:39çš„æ—¶å€™é‡æ–°åˆ·æ–°ç¼“å­˜æŸ¥è¯¢æ­£å¸¸ï¼Œç¼“å­˜åˆ·æ–°æˆåŠŸï¼Œæ‰“å¡æ¢å¤



![image2023-3-16_20-16-57](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292004339.png)





2ã€attendanceæœåŠ¡ä¸‹ æ¨¡æ‹Ÿæ ¸ç®—æ¥å£(/`clockImitateCalculate`)è°ƒç”¨é‡çªå¢ï¼Œå•ä¸ªè¯·æ±‚æŸ¥åŸºç¡€æ•°æ®å¹¶å‘çº¿ç¨‹40ï¼Œä¸€ä¸ªè¯·æ±‚åŒæ—¶éœ€è¦æäº¤6ä¸ªä»»åŠ¡ï¼Œå®é™…é¢„æœŸå¹¶å‘7ä¸ªè¯·æ±‚å·¦å³ï¼Œå½“å¤©å¤©ä¹å¾ˆå¤šå‘˜å·¥æ‰“å¡ï¼Œä»–ä»¬å‰ä¸€å¤©å·¥ä½œæ—¥æ—¥æœŸã€è€ƒå‹¤è§„åˆ™ã€å¼‚å¸¸è§„åˆ™æŸ¥è¯¢ä¸‰ä¸ªabsenceæ¥å£ä¸²è¡ŒæŸ¥è¯¢ï¼Œæ•´ä¸ªåŸºç¡€æ•°æ®è€—æ—¶åœ¨6~7ç§’å·¦å³ï¼Œä¸èƒ½åŠæ—¶å“åº”æ‰“å¡è°ƒç”¨æ¨¡æ‹Ÿæ ¸ç®—æ¥å£çš„è¯·æ±‚ï¼Œè¯·æ±‚éƒ½å †åœ¨çº¿ç¨‹ä¸­ï¼Œåç»­è¯·æ±‚è¶…æ—¶å¯¼è‡´clockç†”æ–­

![image2023-3-15_14-1-55](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292006696.png)





![image2023-3-15_14-51-28](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292006905.png)





3ã€core-baseæ¥å£è¿”å›å¤±è´¥çš„åŸå›  :grey_question:

å¤©ä¹æ›´æ–°éƒ¨é—¨æ•°æ®ä¼šåˆ·æ–°ç¼“å­˜ï¼Œå…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°ç¼“å­˜ï¼Œåœ¨å¹¶å‘æ›´æ–°ç¼“å­˜æ—¶æŸ¥è¯¢ç¼“å­˜å¯èƒ½æœ‰æ•°æ®ç¼ºå¤±ï¼Œå¯¼è‡´æœ¬æ¬¡ç¼“å­˜æ›´æ–°å¤±è´¥ï¼ˆæœ¬åœ°ç¼“å­˜10Sæœ‰æ•ˆæœŸï¼‰è¿›è€Œå¯¼è‡´äººäº‹æ¥å£æŸ¥è¯¢é”™è¯¯ã€‚

![image2023-3-16_22-3-2](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292009688.png)









#### æµ‹è¯•è§†è§’



**æ‰“å¡é“¾è·¯**å¦‚ä¸‹ï¼š

![image-20231129201013201](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311292010526.png)













# æ‰“å¡ä¿¡æ¯è®¾ç½®
