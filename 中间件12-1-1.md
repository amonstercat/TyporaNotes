





# å®šæ—¶ä»»åŠ¡ CronJob



## Xxl-Job





# æ¶ˆæ¯é˜Ÿåˆ— Kafka



åœ¨è¿›è¡Œç¬¬ä¸‰æ–¹æ¸ é“æ‰“å¡æ•°æ®åŒæ­¥æ—¶ï¼Œåœ¨åŒæ­¥å®Œæˆæ—¶ï¼Œéœ€è¦é€šè¿‡mqå‘é€æ¶ˆæ¯ï¼š

![image-20231123160805854](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311231608917.png)







å…¶å¯¹åº”çš„æ ¸å¿ƒä»£ç ä¸ºï¼š

```java
/**
 * æ¨é€æ‰“å¡æ•°æ®
 * 1.åŸºäºå‘˜å·¥è¿›è¡Œåˆ†ç»„æ¨é€
 * 2.æ¯ä¸ªæ¶ˆæ¯æœ€å¤š600æ¡ ï¼› å¾ªç¯æ¨é€
 * 3.key ä½¿ç”¨å‘˜å·¥ID
 *
 * @param resList
 * @param entId
 */
public void pushMsg(List<ChannelCheckInDataRes> resList, Long entId) {
    if (CollectionUtils.isEmpty(resList)) {
        return;
    }

    // æ¯ä¸ªæ¶ˆæ¯çš„æœ€å¤§æ¡æ•°
    String countAbs = MokaConfig.getInstance().getStrPropertyFromDefault(ApolloConstants.HCM_MOBILE_MOKA_ABSENCE_MSG_COUNT);
    int partitionRecord = resList.size();
    if (StringUtils.isNotBlank(countAbs)) {
        partitionRecord = Integer.parseInt(countAbs);
    }

    // é€šè¿‡å‘˜å·¥å·è¿›è¡Œåˆ†ç»„
    Map<Long, List<ChannelCheckInDataRes>> employeeDataMap = resList.stream().collect(Collectors.groupingBy(ChannelCheckInDataRes::getEmployeeId));
    for (Long employeeId : employeeDataMap.keySet()) {
        List<ChannelCheckInDataRes> employeeCheckInDataList = employeeDataMap.get(employeeId);
        List<List<ChannelCheckInDataRes>> checkInLists = ListUtils.partition(employeeCheckInDataList, partitionRecord);
        for (List<ChannelCheckInDataRes> singleEmployeeDataList : checkInLists) {
            AbsClockCheckInDataDto absClockCheckInDataDto = new AbsClockCheckInDataDto();
            absClockCheckInDataDto.setEntId(entId);
            absClockCheckInDataDto.setBuId(singleEmployeeDataList.get(0).getBuId());
            absClockCheckInDataDto.setEmployeeId(employeeId);
            absClockCheckInDataDto.setCheckInDataResDtoList(singleEmployeeDataList);

            Message message = Message.builder().sendTime(new Date())
                    .msgId(employeeId)
                    .isSequential(false)
                    .topic(getTopic(entId))
                    .body(JacksonUtils.toJson(absClockCheckInDataDto))
                    .build();
            log.info("HcmAbsenceMsgProducer pushMsg -{}", JacksonUtils.toJson(message));
            defaultNoLogMsgProducer.pushMsg(message);
        }
    }

}
```







## ä½¿ç”¨ ContainerFactory æ‰¹é‡æ¶ˆè´¹



æ‰“å¡ä¸šåŠ¡ä¸­ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£å¾—åˆ°æ‰“å¡æ•°æ®åï¼Œä¼šå‘é€ä¸€ä¸ªkafkaæ¶ˆæ¯ï¼Œè€Œè¯¥æ¶ˆæ¯çš„æ¶ˆè´¹è€…å¦‚ä¸‹ï¼š

```java
@Slf4j
@Component
public class BatchSyncClockInRecordListener {


    @Resource
    private BatchSyncChannelRecordService batchSyncChannelRecordService;


    @KafkaListener(topics = {"${topic.hcm_abs_batch_sync_channel_record}"},
            groupId = "${group.hcm_abs_batch_sync_channel_record}",
            containerFactory = "batchConsumeListenContainerFactory")
    public void handleClockRecord(List<ConsumerRecord<String, String>> records, Acknowledgment ack) {

        ack.acknowledge();

        try {
            log.info("å½“å‰æ‰¹æ¬¡å¤„ç†çš„æ¶ˆæ¯: {}", records);
            Map<String, List<ChannelCheckInDataResDto>> employeeUniqkeyChannelRecordsMap = buildEmployeeUniqKeyChannelRecordsFromMsgs(records);

            batchSyncChannelRecordService.handleChannelRecords(employeeUniqkeyChannelRecordsMap);
        } catch (Exception e) {
            log.error("æ‰“å¡è®°å½•åŒæ­¥æ¶ˆè´¹å¤±è´¥ messages: {}", JacksonUtils.toJson(records), e);
        }
    }
  
  
  /*
  *
  * ä» Kafka æ¶ˆæ¯ä¸­æå–æ‰¹é‡åŒæ­¥çš„æ‰“å¡è®°å½•æ•°æ®ï¼ŒæŒ‰ç…§å‘˜å·¥çš„å”¯ä¸€é”®è¿›è¡Œåˆ†ç»„ï¼Œ
  * æ„å»ºä¸€ä¸ªæ˜ å°„å…³ç³»ï¼Œå…¶ä¸­é”®æ˜¯å‘˜å·¥çš„å”¯ä¸€é”®ï¼Œå€¼æ˜¯è¯¥å‘˜å·¥å¯¹åº”çš„æ‰“å¡è®°å½•åˆ—è¡¨
  */

    private Map<String, List<ChannelCheckInDataResDto>> buildEmployeeUniqKeyChannelRecordsFromMsgs(List<ConsumerRecord<String, String>> records) {
        if (CollectionUtils.isEmpty(records)) {
            log.warn("æ²¡æœ‰æ¶ˆè´¹çš„æ¶ˆæ¯");
            return Maps.newHashMap();
        }
        Map<String, List<ChannelCheckInDataResDto>> employeeUniqKeyChannelRecordsMap = Maps.newHashMap();
        for (ConsumerRecord<String, String> record : records) {
            try {
                Message message = JacksonUtils.fromJson(record.value(), Message.class);
                if (Objects.isNull(message)) {
                    log.warn("BatchSyncClockInRecordListener æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯ä¸ºç©º");
                    continue;
                }
                BatchSyncClockInRecordResDto batchChannelRecordDto = JacksonUtils.fromJson(message.getBody(), BatchSyncClockInRecordResDto.class);
                if (Objects.isNull(batchChannelRecordDto)) {
                    log.warn("BatchSyncClockInRecordListener æ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯ä½“ä¸ºç©º");
                    continue;
                }
                Tenant tenant = Tenant.of(batchChannelRecordDto.getEntId(), batchChannelRecordDto.getBuId());
                String employeeUniqKey = ClockRecordUtil.generateEmployeeUniqKey(tenant, batchChannelRecordDto.getEmployeeId());
                List<ChannelCheckInDataResDto> checkInDataResDtos = Optional.ofNullable(batchChannelRecordDto.getCheckInDataResDtoList()).orElse(Lists.newArrayList());
                checkInDataResDtos = checkInDataResDtos.stream().filter(channelRecord -> Objects.nonNull(channelRecord.getCheckInTime())).collect(Collectors.toList());
                List<ChannelCheckInDataResDto> list = employeeUniqKeyChannelRecordsMap.get(employeeUniqKey);
                if (CollectionUtils.isNotEmpty(list)){
                    list.addAll(checkInDataResDtos);
                }else {
                    employeeUniqKeyChannelRecordsMap.put(employeeUniqKey, checkInDataResDtos);
                }
            } catch (Exception e) {
                log.error("å½“å‰æ¶ˆæ¯è§£æå¤±è´¥ record: {}", record);
            }
        }
        log.info("å½“å‰å¤„ç†çš„å‘˜å·¥æ‰“å¡ä¿¡æ¯: {}", JacksonUtils.toJson(employeeUniqKeyChannelRecordsMap));
        return employeeUniqKeyChannelRecordsMap;
    }

}

```



å¯ä»¥çœ‹å‡ºæ¥ï¼Œ`@KafkaListener`æŒ‡å®šäº†`containerFactory`ï¼Œå³è‡ªå®šä¹‰é…ç½®äº†æ¶ˆæ¯ç›‘å¬å®¹å™¨å·¥å‚`bean`:

```java
package com.moka.hcm.absence.clock.common.kafka.consume.factory;

@Configuration
@EnableKafka
public class BatchConsumeConfigContainerFactory {

    private static final Logger log = LoggerFactory.getLogger(KafkaConsumerConfig.class);
    @Value("${kafka.broker.hosts}")
    private String brokers;
    @Value("${kafka.zk.hosts}")
    private String zkHosts;
    @Value("${kafka.consumer.enable.auto.commit}")
    private boolean enableAutoCommit;
    @Value("${kafka.consumer.session.timeout}")
    private String sessionTimeout;
    @Value("${kafka.consumer.auto.commit.interval}")
    private String autoCommitInterval;
    @Value("${kafka.consumer.group.id}")
    private String groupId;
    @Value("${kafka.consumer.auto.offset.reset}")
    private String autoOffsetReset;
    @Value("${kafka.consumer.concurrency}")
    private int concurrency;
    @Value("${kafka.consumer.max.poll.records:5}")
    private int maxPollRecords;
    @Value("${kafka.consumer.max.poll.interval:300000}")
    private int maxPollInterval;

    public BatchConsumeConfigContainerFactory() {
    }

    @Bean
    public KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>> batchConsumeListenContainerFactory() {
        log.info("---KafkaListenerContainerFactory---");
        ConcurrentKafkaListenerContainerFactory<String, String> factory = new ConcurrentKafkaListenerContainerFactory<>();
        log.info("---ConcurrentKafkaListenerContainerFactory---new");
        factory.getContainerProperties().setAckMode(AbstractMessageListenerContainer.AckMode.MANUAL);
        factory.setConsumerFactory(this.consumerFactory());
        log.info("---ConcurrentKafkaListenerContainerFactory---setConsumerFactory");
        factory.setConcurrency(this.concurrency); //æ¶ˆè´¹è€…å¹¶å‘æ¶ˆè´¹çº¿ç¨‹æ•°ä¸º6
        factory.getContainerProperties().setPollTimeout(2500L);
        factory.getContainerProperties().setIdleEventInterval(6000L);
        // å¼€å¯æ‰¹é‡æ¶ˆè´¹
        factory.setBatchListener(true);
        log.info("---ConcurrentKafkaListenerContainerFactory---return--");
        return factory;
    }

    public ConsumerFactory<String, String> consumerFactory() {
        log.info("---ConsumerFactory---");
        return new DefaultKafkaConsumerFactory<>(this.consumerConfigs());
    }

    public Map<String, Object> consumerConfigs() {
        log.info("---consumerConfigs---");
        Map<String, Object> propsMap = new HashMap<>();
        propsMap.put("bootstrap.servers", this.brokers);
        propsMap.put("max.poll.records", this.maxPollRecords);
        propsMap.put("enable.auto.commit", this.enableAutoCommit);
        propsMap.put("auto.commit.interval.ms", this.autoCommitInterval);
        propsMap.put("session.timeout.ms", this.sessionTimeout);
        propsMap.put("max.poll.interval.ms", this.maxPollInterval);
        propsMap.put("key.deserializer", LongDeserializer.class);
        propsMap.put("value.deserializer", StringDeserializer.class);
        propsMap.put("group.id", "pre-hcm_mobile_push");
        propsMap.put("auto.offset.reset", this.autoOffsetReset);
        return propsMap;
    }

}

```



å¯¹åº”çš„kafkaé…ç½®ä¸ºï¼š

```yaml
#-------------------------------kafka é…ç½®----------------------------------------------------------------
kafka:
  # è‡ªå®šä¹‰åˆ†åŒº
  partitioner.class: com.moka.hcm.kafka.paritioner.PushMsgPartitioner
  # zkHost
  zk.hosts:
  # topic
  ############ consumer ##########
  # è‡ªåŠ¨æäº¤offset
  consumer.enable.auto.commit: false
  # å®¢æˆ·ç«¯ä¼šè¯è¶…æ—¶æ—¶é—´
  consumer.session.timeout: 60000
  # kafkaæ‰¹é‡æäº¤å¤§å°
  consumer.auto.commit.interval: 10
  # æ— æäº¤offsetæ—¶ä»æœ€æ–°çš„ä½ç½®å¼€å§‹æ¶ˆè´¹
  consumer.auto.offset.reset: latest
  # æ¶ˆè´¹è€…åˆ†ç»„
  consumer.group.id: hcm_mobile
  # æ¶ˆè´¹è€…å¹¶å‘æ¶ˆè´¹çº¿ç¨‹æ•°
  consumer.concurrency: 6
  ############ producer #######
  producer.retries: 3
  # æ¶ˆæ¯æ‰¹é‡å‘é€å¤§å°
  producer.batch.size: 4096000
  # åœ¨æ¶ˆæ¯æ‰¹é‡å‘é€å‰ç­‰å¾…å…¶ä»–å…¶ä»–æ¶ˆæ¯åŠ å…¥çš„æ—¶é—´
  producer.linger: 1
  # æ¶ˆæ¯å‘é€å†…å­˜bufferå¤§å°
  producer.buffer.memory: 4096000
  # ä¸€æ¬¡æ€§æ‹‰å–çš„æ•°é‡å¾…å®š  ${kafka.consumer.max.poll.records:5}
  max.poll.records: 100
```







# WebSocket



å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæœåŠ¡ç«¯çš„èµ„æºç»å¸¸åœ¨æ›´æ–°ï¼Œå®¢æˆ·ç«¯éœ€è¦å°½é‡åŠæ—¶åœ°äº†è§£åˆ°è¿™äº›æ›´æ–°å‘ç”Ÿåå±•ç¤ºç»™ç”¨æˆ·ï¼Œå¦‚æœæ˜¯ HTTP 1.1ï¼Œé€šå¸¸ä¼šå¼€å¯ ajax è¯·æ±‚è¯¢é—®æœåŠ¡ç«¯æ˜¯å¦æœ‰æ›´æ–°ï¼Œé€šè¿‡å®šæ—¶å™¨åå¤è½®è¯¢æœåŠ¡ç«¯å“åº”çš„èµ„æºæ˜¯å¦æœ‰æ›´æ–°ã€‚

[![ajax è½®è¯¢](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241752280.png)](https://img-blog.csdnimg.cn/20200627220503451.png)

åœ¨é•¿æ—¶é—´ä¸æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œåå¤åœ°å»è¯¢é—®ä¼šå¯¹æœåŠ¡å™¨é€ æˆå¾ˆå¤§çš„å‹åŠ›ï¼Œå¯¹ç½‘ç»œä¹Ÿæœ‰å¾ˆå¤§çš„æ¶ˆè€—ï¼Œå¦‚æœå®šæ—¶çš„æ—¶é—´æ¯”è¾ƒå¤§ï¼ŒæœåŠ¡ç«¯æœ‰æ›´æ–°çš„è¯ï¼Œå®¢æˆ·ç«¯å¯èƒ½éœ€è¦ç­‰å¾…å®šæ—¶å™¨è¾¾åˆ°ä»¥åæ‰èƒ½è·çŸ¥ï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿä¸èƒ½å¾ˆåŠæ—¶åœ°è·å–åˆ°ã€‚

è€Œæœ‰äº† WebSocket åè®®ï¼Œå°±èƒ½å¾ˆå¥½åœ°è§£å†³è¿™äº›é—®é¢˜ï¼ŒWebSocket å¯ä»¥åå‘é€šçŸ¥çš„ï¼Œé€šå¸¸å‘æœåŠ¡ç«¯è®¢é˜…ä¸€ç±»æ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å‘ç°è¿™ç±»æ¶ˆæ¯æœ‰æ›´æ–°å°±ä¼šä¸åœåœ°é€šçŸ¥å®¢æˆ·ç«¯ã€‚

[![WebSocket](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241752463.png)](https://img-blog.csdnimg.cn/20200627220503449.png)



> **WebSocket** æ˜¯åŸºäº TCP çš„ä¸€ç§æ–°çš„åº”ç”¨å±‚ç½‘ç»œåè®®ã€‚å®ƒå®ç°äº†æµè§ˆå™¨ä¸æœåŠ¡å™¨å…¨åŒå·¥é€šä¿¡ï¼Œå³å…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œåœ¨ **WebSocket** ä¸­ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨åªéœ€è¦å®Œæˆä¸€æ¬¡æ¡æ‰‹ï¼Œä¸¤è€…ä¹‹é—´å°±ç›´æ¥å¯ä»¥åˆ›å»ºæŒä¹…æ€§çš„è¿æ¥ï¼Œå¹¶è¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ã€‚

ğŸŠWebSocketæ˜¯ä¸€ç§ç½‘ç»œé€šä¿¡åè®®ï¼Œå®ƒæä¾›äº†åœ¨å•ä¸ªTCPè¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„èƒ½åŠ›ã€‚è¿™æ„å‘³ç€åœ¨ä¸€ä¸ªè¿æ¥ä¸Šï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚

ğŸŠWebSocketä¸HTTPåè®®ä¸åŒï¼Œå®ƒä½¿ç”¨äº†ç‹¬ç«‹çš„ç«¯å£ï¼Œå¹¶ä¸”åœ¨å»ºç«‹è¿æ¥åï¼Œä¸éœ€è¦åœ¨æ¯æ¬¡æ•°æ®ä¼ è¾“æ—¶é‡æ–°å»ºç«‹è¿æ¥ã€‚è¿™ä½¿å¾—å®ƒç‰¹åˆ«é€‚åˆäºå®æ—¶åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚èŠå¤©ï¼Œåœ¨çº¿æ¸¸æˆå’Œè‚¡ç¥¨äº¤æ˜“ç­‰ï¼Œè¿™äº›åº”ç”¨ç¨‹åºéœ€è¦é«˜é€Ÿï¼ŒåŒå‘çš„æ•°æ®ä¼ è¾“ã€‚

ğŸŠWebSocketåè®®æ˜¯HTML5æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å®ƒå¯ä»¥åœ¨ç°ä»£æµè§ˆå™¨ä¸­ä½¿ç”¨ã€‚WebSocket APIå¯ä»¥åœ¨JavaScriptä¸­ä½¿ç”¨ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ç½‘é¡µä¸Šç›´æ¥ä½¿ç”¨WebSocketè¿›è¡Œé€šä¿¡ã€‚

ğŸŠWebSocketä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºæ¡æ‰‹çš„è¿æ¥å»ºç«‹æœºåˆ¶ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨å»ºç«‹è¿æ¥ä¹‹å‰éœ€è¦è¿›è¡Œæ¡æ‰‹ã€‚æ¡æ‰‹æ˜¯é€šè¿‡HTTPåè®®å®Œæˆçš„ï¼Œä½†æ˜¯ä¸€æ—¦å»ºç«‹è¿æ¥åï¼Œæ•°æ®ä¼ è¾“å°†ä½¿ç”¨WebSocketåè®®ã€‚



WebSocketé€šä¿¡çš„æµç¨‹å¦‚ä¸‹ï¼š

- å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œè¯·æ±‚çš„ç›®çš„æ˜¯ä¸ºäº†è¦å»ºç«‹ä¸€ä¸ªWebSocketè¿æ¥ã€‚

- æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œç»™å‡ºä¸€ä¸ªHTTPå“åº”ï¼Œå¹¶å‡çº§è¿æ¥åˆ°WebSocketåè®®ã€‚
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªWebSocketè¿æ¥ã€‚
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å¯ä»¥è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œå‘é€æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ã€‚
- å½“å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å…³é—­è¿æ¥æ—¶ï¼ŒWebSocketè¿æ¥ä¹Ÿä¼šå…³é—­ã€‚
- ä¸ HTTP é€šä¿¡ä¸åŒçš„æ˜¯ï¼ŒWebSocket é€šä¿¡æ˜¯åŸºäºTCPçš„ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªæŒä¹…è¿æ¥ã€‚å®ƒå…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘é€ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯ç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚è¿™ä½¿å¾— WebSocket é€šä¿¡æˆä¸ºäº†å®ç°å®æ—¶åº”ç”¨çš„ç†æƒ³é€‰æ‹©ã€‚
- å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‘èµ·ä¸€ä¸ªwebsocketé“¾æ¥ä¹‹åï¼Œè¯·æ±‚å’Œå“åº”çš„å‚æ•°é‡Œä¼šæœ‰ä¸€äº›websocketç›¸å…³çš„å‚æ•°ï¼Œè¯¥æŠ¥æ–‡ä¸­æœ‰ä¸€ä¸ªupgradeé¦–éƒ¨ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰æœåŠ¡ç«¯éœ€è¦å°†é€šä¿¡åè®®åˆ‡æ¢åˆ°websocket![image.png](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311241758205.png)









## ç›¸å¯¹äºhttpçš„åŒºåˆ«



**WebSocketåè®®å’ŒHTTPåè®®æœ‰ä»¥ä¸‹å‡ ç‚¹åŒºåˆ«ï¼š**

é€šä¿¡æ–¹å¼ä¸åŒ: HTTPåè®®æ˜¯ä¸€ç§è¯·æ±‚-å“åº”åè®®ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿”å›å“åº”ã€‚è€ŒWebSocketåè®®æ˜¯ä¸€ç§å…¨åŒå·¥åè®®ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¯ä»¥ä¸»åŠ¨å‘é€æ¶ˆæ¯ã€‚

é“¾æ¥çŠ¶æ€ä¸åŒ: HTTPåè®®æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚è€ŒWebSocketåè®®æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå»ºç«‹äº†è¿æ¥ä¹‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´å¯ä»¥ç»´æŒé•¿è¿æ¥ã€‚

æ•°æ®ä¼ è¾“ä¸åŒ: HTTPåè®®æ˜¯åŸºäºæ–‡æœ¬çš„ï¼Œè€ŒWebSocketåè®®æ˜¯åŸºäºäºŒè¿›åˆ¶çš„ã€‚

å»¶è¿Ÿä¸åŒ: HTTPåè®®æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦å»ºç«‹è¿æ¥ï¼Œç­‰å¾…å“åº”ï¼Œä¼ è¾“æ•°æ®ï¼Œé‡Šæ”¾è¿æ¥ï¼Œè¿™æ•´ä¸ªè¿‡ç¨‹éƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚è€ŒWebSocketåè®®åªéœ€è¦å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œä¹‹åå°±å¯ä»¥é«˜æ•ˆåœ°è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œæ‰€ä»¥å»¶è¿Ÿæ›´å°ã€‚









# Redisson





## Guava å•æœºé™æµ RateLimiter



Guavaçš„é™æµåŸºäº**ä»¤ç‰Œæ¡¶**ç®—æ³•å®ç°ï¼Œæä¾›äº†å¹³æ»‘çªå‘é™æµæ–¹æ¡ˆå’Œå¹³æ»‘é¢„çƒ­é™æµä¸¤ç§æ–¹å¼ã€‚

å¹³æ»‘çªå‘é™æµå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. ä»¥å›ºå®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œ

2. RateLimiterä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œä¼šè¿›è¡Œä»¤ç‰Œçš„ç´¯ç§¯ï¼Œå¦‚æœè·å–ä»¤ç‰Œçš„é¢‘ç‡æ¯”è¾ƒä½ï¼Œåˆ™ä¸ä¼šå¯¼è‡´ç­‰å¾…ï¼Œç›´æ¥è·å–ä»¤ç‰Œã€‚

3. RateLimiteråœ¨æ²¡æœ‰è¶³å¤Ÿä»¤ç‰Œå‘æ”¾æ—¶ï¼Œé‡‡ç”¨æ»åå¤„ç†çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å‰ä¸€ä¸ªè¯·æ±‚è·å–ä»¤ç‰Œæ‰€éœ€ç­‰å¾…çš„æ—¶é—´ç”±ä¸‹ä¸€æ¬¡è¯·æ±‚æ¥æ‰¿å—ï¼Œä¹Ÿå°±æ˜¯ä»£æ›¿å‰ä¸€ä¸ªè¯·æ±‚è¿›è¡Œç­‰å¾…ã€‚

å¹³æ»‘é¢„çƒ­é™æµï¼Œæ˜¯åœ¨å¹³æ»‘çªå‘é™æµçš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å¸¦æœ‰é¢„çƒ­æœŸçš„ä¸€ç§å¹³æ»‘é™æµï¼Œå³å®ƒå¯åŠ¨åä¼šæœ‰ä¸€æ®µé¢„çƒ­æœŸï¼Œé€æ­¥å°†åˆ†å‘é¢‘ç‡æå‡åˆ°é…ç½®çš„é€Ÿç‡ã€‚å¹³æ»‘é¢„çƒ­é™æµï¼Œé€šè¿‡åŠ¨æ€è°ƒæ•´ä»¤ç‰Œå‘æ”¾é€Ÿåº¦ï¼Œå¯ä»¥è®©æµé‡å˜åŒ–æ›´åŠ å¹³æ»‘ã€‚å‡è®¾ï¼Œç°åœ¨æœ‰ä¸€ä¸ªæ¥å£ï¼Œé™å®š100QPSï¼Œå½“å‰å¦‚æœæ²¡æœ‰è¯·æ±‚åˆ°æ¥ï¼Œä»¤ç‰Œæ¡¶å°±ä¼šæœ‰100ä¸ªä»¤ç‰Œï¼Œå¦‚æœçªå‘çš„åˆ°æ¥100ä¸ªè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šç¬é—´æ¶ˆè€—æ‰ä»¤ç‰Œï¼Œå¹¶äº§ç”Ÿè¾ƒå¤§çš„å†²å‡»åŠ›ã€‚è€Œå¹³æ»‘é¢„çƒ­é™æµï¼Œåˆ™å¯ä»¥æ ¹æ®æ¡¶å†…çš„ä»¤ç‰Œæ•°é‡åŠ¨æ€æ§åˆ¶ä»¤ç‰Œçš„å‘æ”¾é€Ÿç‡ï¼Œè®©å¿™æ—¶æµé‡å’Œé—²æ—¶æµé‡å¯ä»¥äº’ç›¸å¹³æ»‘è¿‡æ¸¡ã€‚








## åˆ†å¸ƒå¼é™æµ RRateLimiter



æˆ‘ä»¬åœ¨å¯¹æ¥é’‰é’‰ã€å¾®ä¿¡ç­‰ç”Ÿæ€æœåŠ¡ï¼ˆåŒæ­¥ç¬¬ä¸‰æ–¹æ¸ é“çš„æ‰“å¡æ•°æ®ï¼‰æ—¶ï¼Œéœ€è¦è°ƒç”¨å®ƒä»¬åœ¨å¼€æ”¾å¹³å°çš„APIï¼Œç„¶è€Œæ— è®ºæ˜¯larkã€è¿˜æ˜¯é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼Œéƒ½é™åˆ¶äº†å¤–éƒ¨è°ƒç”¨apiçš„é¢‘ç‡ï¼ˆé™æµè¦æ±‚ï¼‰ï¼Œå› ä¸ºä¸€æ—¦è°ƒç”¨é’‰é’‰APIé¢‘ç‡è¶…é™ï¼Œä¼šè§¦å‘è‡³å°‘5åˆ†é’Ÿçš„é™æµç†”æ–­ï¼Œè¿™5åˆ†é’Ÿå†…ä»»ä½•APIè°ƒç”¨éƒ½ä¼šæŠ¥é”™ã€‚æ‰€ä»¥æˆ‘ä»¬ä½œä¸ºæœåŠ¡è°ƒç”¨æ–¹ï¼Œæ›´è¦å°†è°ƒç”¨æœåŠ¡çš„è¯·æ±‚é™æµã€‚ä¾‹å¦‚é’‰é’‰å®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†å¦‚ä¸‹è§£é‡Šï¼š

[å¦‚ä½•å¤„ç†é’‰é’‰æœåŠ¡ç«¯APIé™æµ](https://open.dingtalk.com/document/orgapp/how-to-process-api-throttling-on-the-dingtalk-server)

**è§£å†³åŠæ³•ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼:**

- **é€šç”¨**
  - å› ä¸ºqpsé™æµé™åˆ¶æ—¶é—´æ˜¯1ç§’ï¼Œæ‰€ä»¥å½“é‡åˆ°é™æµé”™è¯¯æ—¶ï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­ sleep 1 ç§’ï¼Œç„¶åç»§ç»­æ‰§è¡Œ
  - **é˜Ÿåˆ—è°ƒç”¨**ï¼šé’ˆå¯¹å•ä¸ªåº”ç”¨APIçš„QPSé™æµï¼Œå¯é€šè¿‡é˜Ÿåˆ—è°ƒç”¨çš„æ–¹å¼è§£å†³
- **ä¸»åŠ¨å•æœºé™æµ**ï¼šè¿™ä¸ªæ˜¯æ ¹æœ¬ä¸Šè§£å†³é™æµçš„æ–¹æ³•ï¼Œå¦‚æœæ˜¯å•ä¸ªæœåŠ¡å™¨è°ƒç”¨é’‰é’‰çš„æœåŠ¡ç«¯apiï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼**Guava RateLimiter**çš„é™æµsdkï¼Œæ¥è‡ªç”±æ§åˆ¶è°ƒç”¨é¢‘ç‡ã€‚
- **ä¸»åŠ¨åˆ†å¸ƒå¼é™æµ**ï¼šå¦‚æœæ˜¯å¤šä¸ªæœåŠ¡å™¨è°ƒç”¨é’‰é’‰çš„æœåŠ¡ç«¯apiï¼Œå¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜ï¼Œå…¶ä¸­ç¼“å­˜çš„keyæ˜¯å½“å‰çš„ç§’çº§æ—¶é—´æˆ³ï¼Œvalueå°±æ˜¯è°ƒç”¨æ¬¡æ•°ã€‚



åŒæ­¥ç¬¬ä¸‰æ–¹æ¸ é“æ‰“å¡æ•°æ®æ—¶ï¼Œæ‰€æ¶‰åŠåˆ°çš„é™æµå™¨ï¼š

![image-20231123204008742](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202311232040895.png)

è¯¥**`larkAbsenceAcquireByEnt` æ–¹æ³•ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š**

- æ ¹æ®ä¼ä¸šï¼ˆ`entId`ï¼‰è¿›è¡Œé™æµã€‚
- å…ˆé€šè¿‡ `initRateLimiter` æ–¹æ³•åˆå§‹åŒ–æˆ–è·å–ä¸æŒ‡å®šé”®ç›¸å…³çš„é™æµå™¨ã€‚
- é€šè¿‡ `tryAcquire` æ–¹æ³•å°è¯•è·å–ä»¤ç‰Œï¼Œä»¥åˆ¤æ–­æ˜¯å¦å…è®¸æ‰§è¡Œå½“å‰è¯·æ±‚ã€‚
- `LIMIT_BUFFER` æ˜¯ä¸€ä¸ªç¼“å†²å€¼ï¼Œç”¨äºåœ¨è®¾ç½®é™æµé€Ÿç‡æ—¶è€ƒè™‘ä¸€äº›ä½™é‡ã€‚
- `LIMITER_WAIT_TIME` æ˜¯è·å–ä»¤ç‰Œçš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚
- å¦‚æœæ— æ³•è·å–ä»¤ç‰Œï¼Œåˆ™æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼Œå¹¶è®°å½•é™æµä¿¡æ¯ã€‚









# Shardingâ€”JDBC



## ä¸€ã€åˆ†åº“åˆ†è¡¨èƒŒæ™¯

ä¼ ç»Ÿçš„å°†æ•°æ®é›†ä¸­å­˜å‚¨è‡³å•â¼€æ•°æ®èŠ‚ç‚¹çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨æ€§èƒ½ã€å¯ç”¨æ€§å’Œè¿ç»´æˆæœ¬è¿™ä¸‰æ–¹é¢å·²ç»éš¾äºæ»¡è¶³äº’è”ç½‘çš„æµ·é‡æ•°æ®åœºæ™¯ã€‚

éšç€ä¸šåŠ¡æ•°æ®é‡çš„å¢åŠ ï¼ŒåŸæ¥æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸Šçš„ï¼Œç½‘ç»œIOåŠæ–‡ä»¶IOéƒ½é›†ä¸­åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸Šçš„ï¼Œå› æ­¤CPUã€å†…å­˜ã€æ–‡ä»¶IOã€ç½‘ç»œIOéƒ½å¯èƒ½ä¼šæˆä¸ºç³»ç»Ÿç“¶é¢ˆã€‚

å½“ä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®å®¹é‡æ¥è¿‘æˆ–è¶…è¿‡å•å°æœåŠ¡å™¨çš„å®¹é‡ã€QPS/TPSæ¥è¿‘æˆ–è¶…è¿‡å•ä¸ªæ•°æ®åº“å®ä¾‹çš„å¤„ç†æé™ç­‰ï¼Œæ­¤æ—¶ï¼Œå¾€å¾€æ˜¯é‡‡ç”¨å‚ç›´å’Œæ°´å¹³ç»“åˆçš„æ•°æ®æ‹†åˆ†æ–¹æ³•ï¼ŒæŠŠæ•°æ®æœåŠ¡å’Œæ•°æ®å­˜å‚¨åˆ†å¸ƒåˆ°å¤šå°æ•°æ®åº“æœåŠ¡å™¨ä¸Šã€‚

> é€»è¾‘åº“ä¸ç‰©ç†åº“çš„åŒºåˆ« :astonished:

## äºŒã€åˆ†åº“åˆ†è¡¨ç»„ä»¶æ¯”å¯¹

| ç»„ä»¶          | ä½¿ç”¨æ–¹å¼                                                     | ä¼˜ç‚¹                                                         | ç¼ºç‚¹                                                         |
| ------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| mycat         | ç‹¬ç«‹ä¸šåŠ¡æœåŠ¡éƒ¨ç½²,ä½¿ç”¨æ–¹é›¨mycatæ¨¡æ‹Ÿçš„è™šæ‹Ÿåº“ã€è™šæ‹Ÿè¡¨äº¤äº’ï¼ˆåå‘ä»£ç†ï¼‰ | 1ã€åˆ†åº“åˆ†è¡¨çš„é€»è¾‘å¯¹å¤–å±‚éšè—ï¼Œä½¿ç”¨æ–¹ä¸ç”¨å…³æ³¨å†…éƒ¨å®ç°é€»è¾‘ï¼Œå¯ä»¥æŒ‰ç…§å•åº“ã€å•è¡¨çš„æ–¹å¼ä½¿ç”¨ï¼Œæ¥å…¥ç®€å•2ã€ä¸­é—´å±‚æ›´ä¾¿äºå®ç°ç›‘æ§ã€æ•°æ®è¿ç§»ã€è¿æ¥ç®¡ç†ç­‰åŠŸèƒ½ | éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„éƒ¨ç½²ï¼Œä¸”æœ‰å•ç‚¹æ•…éšœé£é™©éœ€è¦æ³¨æ„ï¼Œè¿ç»´æˆæœ¬é«˜ï¼Œä¸”å•åº“åˆ†è¡¨ä¸æ”¯æŒjoinåˆ†åº“åˆ†è¡¨ç­–ç•¥é…ç½®æ¯”è¾ƒè½åã€ä¸”ç¹çç¤¾åŒºä¸å¤ªæ´»è·ƒ |
| sharding-jdbc | å®¢æˆ·ç«¯ç›´è¿ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªjdbcçš„å¢å¼ºå®ç°ï¼Œä½¿ç”¨æ–¹å¼å’Œæ™®é€šçš„jdbcç›¸ä¼¼ï¼Œé…ç½®æ•°æ®è®¿é—®å¯¹åº”çš„è¡¨ç»“æ„ï¼ˆæ­£å‘ä»£ç†ï¼‰ | 1ã€å®¢æˆ·ç«¯ç›´è¿ï¼Œæ€§èƒ½æ›´å¥½2ã€åˆ†åº“åˆ†è¡¨ç­–ç•¥ä¸°å¯Œï¼Œæ¥å…¥åä½¿ç”¨ç®€å•3ã€è‡ªå®šä¹‰ç­–ç•¥æ–¹ä¾¿4ã€è¯¥ç»„ä»¶ä¸éœ€è¦å•ç‹¬çš„è¿ç»´æˆæœ¬5ã€ç¤¾åŒºæ´»è·ƒåº¦é«˜ | ä½¿ç”¨éœ€è¦å¯¹è¯¥ç»„ä»¶æœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬ï¼Œéœ€è¦ä½¿ç”¨æ–¹æ¥æ§åˆ¶åˆ†åº“åˆ†è¡¨æ¥å…¥ |





## ä¸‰ã€sharding-jdbcå®æˆ˜

### 1ã€ç¯å¢ƒå‡†å¤‡

ä»¥å‡å‹¤é¡¹ç›®æ•°æ®é‡å¤§ä¸”å¸¸ç”¨çš„æ•°æ®è¡¨æ—¥æŠ¥è®°å½•ä¸ºä¾‹

ä¸¤ä¸ªæ•°æ®åº“ï¼šhcm-pp,hcm-pp1ï¼Œ

å‡å‹¤æ—¥æŠ¥è®°å½•è¡¨ï¼šhcm_pp_daily_reportï¼Œä¸¤ä¸ªåº“ä¸­éƒ½æœ‰hcm_pp_daily_report_0,hcm_pp_daily_report_1,hcm_pp_daily_report_2,hcm_pp_daily_report_3,hcm_pp_daily_report_4,hcm_pp_daily_report_5ï¼Œå…±12å¼ è¡¨

åˆ†åº“é€šè¿‡ï¼šdaily_report_dateå­—æ®µï¼Œæ—¥æŠ¥æ•°æ®æ˜¯2023å¹´ä¹‹å‰çš„æ•°æ®æ”¾å…¥hcm-ppåº“ä¸­çš„è¡¨ï¼Œæ•°æ®æ˜¯2023å¹´ä¹‹åçš„æ”¾å…¥hcm-pp1åº“ä¸­

åˆ†è¡¨é€šè¿‡ï¼šemployee_idè¿›è¡Œåˆ†è¡¨

![image2023-11-30_20-23-3](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011632664.png)

é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–ï¼š

![image2023-11-30_20-24-8](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011633479.png)



é…ç½®æ–‡ä»¶ï¼š

![image2023-11-30_20-29-4](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011633595.png)



åˆ†åº“ç®—æ³•å®ç°ï¼š

![image2023-11-30_20-29-41](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011634002.png)







åˆ†è¡¨ç®—æ³•å®ç°ï¼š

![image2023-11-30_20-30-5](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011634620.png)









### 2ã€åˆ†è¡¨æ–¹æ³•åˆ†æä¸é€‰å–



| æ–¹æ³•åç§° | è¯´æ˜                                                         | æ³¨æ„ç‚¹                                       |
| -------- | ------------------------------------------------------------ | -------------------------------------------- |
| æ—¶é—´     | é€‚åˆæœ‰å½’æ¡£éœ€æ±‚ï¼ŒæŸ¥è¯¢çš„åœºæ™¯æœ‰æ˜æ˜¾çš„æ—¶é—´å±æ€§ï¼Œä¸”æŸ¥è¯¢åœºæ™¯éƒ½æ˜¯æ—¶é—´çƒ­ç‚¹æ•°æ® | å¦‚æœä¸šåŠ¡ä¸ç¨³å®šï¼Œå¯èƒ½ä¼šé€ æˆæ¯”è¾ƒä¸¥é‡çš„æ•°æ®å€¾æ–œ |
| èŒƒå›´     | ä½¿ç”¨æ•°å­—ç±»å‹çš„å­—æ®µè¿›è¡Œåˆ†è¡¨ï¼Œä¸€èˆ¬è‡ªå¢å‹ï¼Œä¸»é”®ID               | æ³¨æ„æ¯ä¸ªè¡¨çš„åˆå§‹åŒ–idä»¥åŠè‡ªå¢æœåŠ¡ï¼ŒåæœŸæ‰©å®¹   |
| å–æ¨¡     | ä¸€èˆ¬ä½¿ç”¨ä¸€äº›ä¸ä¸šåŠ¡ç›¸å…³çš„idï¼Œæ¯”å¦‚ç”¨æˆ·idï¼Œå¯¹æˆ‘ä»¬çš„è¡¨æ•°é‡è¿›è¡Œå–æ¨¡ï¼Œç„¶åç¡®è®¤è·¯ç”±åˆ°è¡¨ã€‚ä½¿ç”¨å¾—æ¯”è¾ƒå¤šæ–¹æ³• | å‰æœŸéœ€è¦è§„åˆ’å¥½æ•°é‡å’Œæ‰©å®¹æ–¹æ¡ˆä»¥åŠè¿ç§»æ–¹æ¡ˆ     |

### 3ã€åˆ†ç‰‡ç­–ç•¥

**æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼ˆStandardShardingStrategyï¼‰**ï¼š åªæ”¯æŒå¯¹å•ä¸ªåˆ†ç‰‡é”®ä¸ºä¾æ®çš„åˆ†åº“åˆ†è¡¨ï¼Œå¹¶æä¾›äº†ä¸¤ç§åˆ†ç‰‡ç®—æ³•ï¼š

- **PreciseShardingAlgorithmï¼ˆç²¾å‡†åˆ†ç‰‡ï¼‰**ï¼šåœ¨ä½¿ç”¨æ ‡å‡†åˆ†ç‰‡ç­–ç•¥æ—¶ï¼Œç²¾å‡†åˆ†ç‰‡ç®—æ³•æ—¶å¿…é¡»å®ç°çš„ç®—æ³•ï¼Œç”¨äºSQLå«æœ‰ = å’Œ IN çš„åˆ†ç‰‡å¤„ç†ï¼›è¿”å›ç›®æ ‡çš„åº“åç§°æˆ–è€…è¡¨åç§°ä¸ºå•ä¸ªåç§°

  ![image2023-12-1_14-38-51](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011636406.png)



- **RangeShardingAlgorithmï¼ˆèŒƒå›´åˆ†ç‰‡ï¼‰**ï¼šéå¿…é€‰çš„ï¼Œç”¨äºå¤„ç†å«æœ‰ BETWEEN AND çš„åˆ†ç‰‡å¤„ç†ã€‚ï¼Œå¦‚ä¸‹å›¾ï¼Œè¿”å›çš„ç›®æ ‡åº“æˆ–è€…è¡¨åç§°æ˜¯ä¸€ä¸ªé›†åˆ

  ![image2023-12-1_14-36-1](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011636781.png)





æ³¨æ„ :exclamation::exclamation: ä¸€æ—¦æˆ‘ä»¬æ²¡é…ç½®èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼Œè€ŒSQLä¸­åˆç”¨åˆ° BETWEEN AND æˆ–è€… LIKE ç­‰ï¼Œé‚£ä¹ˆ SQL å°†æŒ‰å…¨åº“ã€è¡¨è·¯ç”±çš„æ–¹å¼é€ä¸€æ‰§è¡Œï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šå¾ˆå·®ã€‚



**å¤åˆåˆ†ç‰‡ç­–ç•¥**

(1)ä½¿ç”¨åœºæ™¯
ä½¿ç”¨åœºæ™¯ï¼šSQL è¯­å¥ä¸­æœ‰>ï¼Œ>=, <=ï¼Œ<ï¼Œ=ï¼ŒIN å’Œ BETWEEN AND ç­‰æ“ä½œç¬¦ï¼Œä¸åŒçš„æ˜¯å¤åˆåˆ†ç‰‡ç­–ç•¥æ”¯æŒå¯¹å¤šä¸ªåˆ†ç‰‡å¥æ“ä½œã€‚
æ ‡å‡†åˆ†ç‰‡ç­–ç•¥ï¼Œæˆ‘ä»¬åªæ˜¯æ ¹æ®ä¸€ä¸ªå­—æ®µæ¥æŸ¥è¯¢ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåˆ†ç‰‡é”®ã€‚ä¸‹è¾¹æˆ‘ä»¬åŒæ—¶å®ç°ä»¥idå’Œtypeä¸ºæ¡ä»¶æ¥å®ç°æŸ¥è¯¢

(2)é…ç½®
æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹åŸé…ç½®ï¼Œ`standard.sharding-column` åˆ‡æ¢æˆ `complex.sharding-columns` å¤æ•°ï¼Œåˆ†ç‰‡å¥ä¸Šå†åŠ ä¸€ä¸ª user_id ï¼Œåˆ†ç‰‡ç­–ç•¥åå˜æ›´ä¸º complex ï¼Œ`complex.algorithm-class-name` æ›¿æ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„å¤åˆåˆ†ç‰‡ç®—æ³•ã€‚

```yaml
#spring.shardingsphere.sharding.tables.course.table-strategy.complex.sharding-columns=sharding-column=employee_id,daily_report_date

```

å½“æˆ‘ä»¬å®ç°åˆ†ç‰‡ç­–ç•¥æ˜¯ï¼Œä¼ å…¥çš„å‚æ•°å°±æ˜¯å„å­—æ®µé›†åˆ

![image2023-12-1_14-53-51](https://cdn.jsdelivr.net/gh/amonstercat/PicGo/202312011639133.png)





(3)å¤åˆåˆ†ç‰‡æƒ…å†µä¸‹ï¼Œæ¶‰åŠè·¨åº“äº‹åŠ¡è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ
