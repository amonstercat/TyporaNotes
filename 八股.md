# ğŸ®ReviewğŸ®



# JavaSE





qw

## è‡ªåŠ¨è£…ç®±ä¸è‡ªåŠ¨æ‹†ç®±åŸç†



**è‡ªåŠ¨è£…ç®±ï¼š**

> è‡ªåŠ¨è£…ç®±å°±æ˜¯Javaè‡ªåŠ¨å°†åŸå§‹ç±»å‹å€¼è½¬æ¢æˆå¯¹åº”çš„**åŒ…è£…ç±»å¯¹è±¡**ï¼Œæ¯”å¦‚å°†intçš„å˜é‡è½¬æ¢æˆIntegerå¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšè£…ç®±ï¼Œåä¹‹å°†Integerç±»å¯¹è±¡è½¬æ¢æˆå¯¹åº”åŸºæœ¬ç±»å‹intå€¼ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšæ‹†ç®±ï¼›
>


ä»Java SE5å¼€å§‹å°±æä¾›äº†è‡ªåŠ¨è£…ç®±ç‰¹æ€§ï¼Œå¦‚æœè¦ç”Ÿæˆä¸€ä¸ªæ•°å€¼ä¸º`10`çš„`Integer`å¯¹è±¡ï¼Œåªéœ€è¦è¿™æ ·å°±å¯ä»¥äº†:

 ```java
 Integer i=10;  
 //è¿™ä¸ªè¿‡ç¨‹ä¼šè‡ªåŠ¨æ ¹æ®æ•°å€¼çš„ç±»å‹åˆ›å»ºIntegerå¯¹è±¡(å‰ææ˜¯æ•°å€¼èŒƒå›´åœ¨IntegerCacheå†…éƒ¨ç±»å®šä¹‰çš„low-highèŒƒå›´å†…ï¼ï¼)ï¼Œå³è‡ªåŠ¨è£…ç®±
     
 // åŒç†
 Integer i=10;  
 int j=i;
 ç¬¬äºŒè¡Œä»£ç åˆ™æ¶‰åŠåˆ°è‡ªåŠ¨æ‹†ç®±ï¼Œå°†Integerå¯¹è±¡iè‡ªåŠ¨æ‹†ç®±ä¸ºintåŸºæœ¬ç±»å‹çš„j
 ```

JavaåŸºæœ¬åŒ…è£…ç±»å‹éƒ½æä¾›äº†ç¼“å­˜æœºåˆ¶ï¼Œè£…ç®±è°ƒç”¨çš„æ˜¯åŒ…è£…ç±»ä¸­çš„**`ValueOf`**æ–¹æ³•ã€‚

1. **`Integer`Â ç¼“å­˜æºç :	**

```java
public static Integer valueOf(int i) {
        if (i >= IntegerCache.low && i <= IntegerCache.high)
            return IntegerCache.cache[i + (-IntegerCache.low)];//ç›´æ¥éšæœºè®¿é—®
        return new Integer(i);
    }
//
private static class IntegerCache {
    static final Integer[] cache; //å­˜å‚¨å…ƒç´ ç±»å‹ä¸ºIntegerçš„æ•°ç»„
    static final int low = -128;
    static final int high;
    static {
        // high value may be configured by property
        int h = 127;
        high = h;
        cache = new Integer[(high - low) + 1];  //åˆå§‹åŒ–
        int j = low;
        for(int k = 0; k < cache.length; k++)
            cache[k] = new Integer(j++); //ä¸ºè¯¥æ•°ç»„èµ‹å€¼
    }
}
```

2. **`Character`Â ç¼“å­˜æºç :**

```java
public static Character valueOf(char c) {
    if (c <= 127) { //  æ£€æŸ¥ä¼ å…¥çš„å­—ç¬¦æ˜¯å¦åœ¨ ASCII ç èŒƒå›´å†…ï¼ˆå³ 0 åˆ° 127ï¼‰
      return CharacterCache.cache[(int)c];
    }
    return new Character(c);
}

//ç±»åŠ è½½æ—¶å°±åˆå§‹åŒ–äº†cacheæ•°ç»„
private static class CharacterCache {
    private CharacterCache(){}
    static final Character cache[] = new Character[127 + 1];
    static {
        for (int i = 0; i < cache.length; i++)
            cache[i] = new Character((char)i);
    }
}
```

```java
Integer i1 = 40;  //ç­‰ä»·äº Integer i2=Integer.valueOf(40)

//ä½¿ç”¨äº†æ„é€ å‡½æ•°new Integer(40)ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Integerå¯¹è±¡ï¼Œå³ä½¿è¯¥å€¼åœ¨ç¼“å­˜èŒƒå›´å†…
Integer i2 = new Integer(40);

System.out.println(i1==i2);  //false

```

`Integer i1=40` è¿™ä¸€è¡Œä»£ç ä¼šå‘ç”Ÿè£…ç®±ï¼Œç­‰ä»·äº `Integer i1=Integer.valueOf(40)ï¼›` å› æ­¤ï¼Œ`i1` ç›´æ¥ä½¿ç”¨çš„æ˜¯ç¼“å­˜ä¸­çš„å¯¹è±¡ã€‚è€Œ`Integer i2 = new Integer(40)` ä¼šç›´æ¥åˆ›å»ºæ–°çš„å¯¹è±¡

å†è¡¥å……ä¸€å¥:å¦‚æœæƒ³è¦æ¯”è¾ƒä¸¤ä¸ª`Integer`ç±»å¯¹è±¡çš„æ•°å€¼å¤§å°ï¼Œåº”è¯¥è°ƒç”¨`equals()`æ–¹æ³•ï¼š

```java
//Integerç±»é‡å†™äº†equalsæ–¹æ³•
public boolean equals(Object obj) {
        if (obj instanceof Integer) {
            return value == ((Integer)obj).intValue();
        }
        return false;
    }
```



---



**è‡ªåŠ¨æ‹†ç®±ï¼š**

```java
Integer i=10;
int j=i;  //æ‹†ç®±
è£…ç®±è°ƒç”¨äº†åŒ…è£…ç±»çš„valueOf()æ–¹æ³•ï¼Œè€Œæ‹†ç®±å®é™…ä¸Šè°ƒç”¨äº†xxxValue()æ–¹æ³•
```

â€¢ `Integer i = 10`Â ç­‰ä»·äºÂ `Integer i = Integer.valueOf(10)ï¼›`

â€¢ `int n = i`Â ç­‰ä»·äºÂ `int n = i.intValue()ï¼›`

æ¥çœ‹çœ‹`Integer`ç±»çš„æºç ï¼š

```java
private final int value;  //valueä¸€æ—¦èµ‹å€¼å³ä¸å¯æ”¹å˜
public Integer(int value) {
        this.value = value;  //æ¯ä¸ªIntegerå¯¹è±¡æœ‰ä¸€ä¸ªvalueæˆå‘˜å±æ€§
    }

public int intValue() {
        return value; //è¿”å›è¯¥Integerå¯¹è±¡çš„valueæˆå‘˜å±æ€§å€¼
    }
```



>  é—®é¢˜å­˜ç–‘ï¼š 
>
> ```java
> Integer i=100;  
> i=10;
> ```
>
> è¿™æ®µä»£ç æ‰§è¡Œæ—¶ï¼Œå¼•ç”¨iæŒ‡å‘å¯¹è±¡çš„å†…å­˜åœ°å€å˜åŒ–äº†å—ï¼Ÿ ä¸ªäººè§‰å¾—æ˜¯å˜åŒ–äº†çš„ï¼Œåªæ˜¯æ²¡æœ‰åˆ›å»ºæ–°å¯¹è±¡ğŸ¤”   

åœ¨Javaä¸­ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆå¦‚intï¼‰æ˜¯æŒ‰å€¼ä¼ é€’çš„ï¼Œè€Œä¸æ˜¯æŒ‰å¼•ç”¨ä¼ é€’çš„ã€‚å› æ­¤ï¼Œå½“ä½ æ‰§è¡Œ `Integer i = 100;` åï¼Œ`i` ä¸­å­˜å‚¨çš„æ˜¯ä¸€ä¸ªæŒ‡å‘å†…å­˜ä¸­å€¼ä¸º100çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥å­˜å‚¨100è¿™ä¸ªå€¼ã€‚å½“ä½ æ‰§è¡Œ `i = 10;` æ—¶ï¼Œå®é™…ä¸Šæ˜¯å°† `i` ä¸­å­˜å‚¨çš„å¼•ç”¨ä»æŒ‡å‘å€¼ä¸º100çš„å¯¹è±¡æ”¹å˜ä¸ºæŒ‡å‘å€¼ä¸º10çš„å¯¹è±¡ã€‚è¿™æ„å‘³ç€ `i` æŒ‡å‘çš„å†…å­˜åœ°å€ç¡®å®å‘ç”Ÿäº†å˜åŒ–ã€‚





## ä¸åŒç±»å‹å˜é‡åœ¨JVMä¸­çš„å­˜å‚¨æ–¹å¼



ç›´æ¥ä¸Šä¾‹å­ï¼š

```java
package å†…å­˜åˆ†é…åŸç†;
 
public class Demo {
    
    
    
    
    
    /*
    1.æˆå‘˜å˜é‡(éš¶å±äºå¯¹è±¡å®ä¾‹)
    åˆ†é…æ—¶æœºï¼šnewåˆ›å»ºå¯¹è±¡æ—¶
    åˆ†é…ä½ç½®ï¼šå †
     */
     // ä¸¾ä¾‹è¯´æ˜ï¼šåœ¨åˆ›å»ºå¯¹è±¡æ—¶ï¼ˆC1 c = new C1();ï¼‰ä¼šç»™å¯¹è±¡cçš„æˆå‘˜å˜é‡åˆ†é…å†…å­˜ï¼Œå…¶ä¸­åŸºæœ¬ç±»å‹æ•°æ®iåŠå¼•ç”¨sã€s1ä½œä¸ºå¯¹è±¡cçš„å®ä¾‹æ•°æ®å­˜å‚¨åœ¨å †ä¸­ï¼›å¼•ç”¨sæŒ‡å‘çš„å¯¹è±¡new String("a")å­˜å‚¨åœ¨å¦ä¸€å—å †ç©ºé—´
    private int i = 1; // å †
    private String s/*å¼•ç”¨ï¼šå †*/ = new String("a")/*å¯¹è±¡å®ä¾‹ï¼šå¦ä¸€å—å †ç©ºé—´ä¸­*/;
    private String s1/*å¼•ç”¨ï¼šå †*/ = "aa"/*å­—é¢é‡aaï¼šå­—ç¬¦ä¸²å¸¸é‡æ± */; // å­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯è¿è¡Œæ—¶å¸¸é‡æ± çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨jdk7ä¹‹å‰ä½äºæ–¹æ³•åŒºï¼Œjdk7å¼€å§‹ç§»è‡³å †ä¸­
 
    
    
    
    /*
    2.ç±»ï¼ˆé™æ€ï¼‰å˜é‡&å¸¸é‡&é™æ€å¸¸é‡
    åˆ†é…æ—¶æœºï¼šç±»åŠ è½½æ—¶
    åˆ†é…ä½ç½®ï¼šæ–¹æ³•åŒº(jdk7ä¹‹å‰) -> å †(jdk7åŠä»¥å)
     */
    // é™æ€å˜é‡
    private static int ii = 2; // æ–¹æ³•åŒº(jdk7ä¹‹å‰) -> å †(jdk7åŠä»¥å)
    private static String ss/*å¼•ç”¨ï¼šæ–¹æ³•åŒº(jdk7ä¹‹å‰) -> å †(jdk7åŠä»¥å)*/ = new String("b")/*å¯¹è±¡å®ä¾‹ï¼šå †*/;
    
    
    
    // å¸¸é‡
    private final int iii = 3;// æ–¹æ³•åŒº(jdk7ä¹‹å‰) -> å †(jdk7åŠä»¥å)
    private final String sss/*å¼•ç”¨ï¼šæ–¹æ³•åŒº(jdk7ä¹‹å‰) -> å †(jdk7åŠä»¥å)*/ = new String("c")/*å¯¹è±¡å®ä¾‹ï¼šå †*/;
    
    
    
    // é™æ€å¸¸é‡
    private final static String ssss/*å¼•ç”¨ï¼šæ–¹æ³•åŒº(jdk7ä¹‹å‰) -> å †(jdk7åŠä»¥å)*/ = new String("d")/*å¯¹è±¡å®ä¾‹ï¼šå †*/;
 
    
    
    
    /*
    3.å±€éƒ¨å˜é‡
    åˆ†é…æ—¶æœºï¼šçº¿ç¨‹æ‰§è¡Œæ–¹æ³•æ—¶
    åˆ†é…ä½ç½®ï¼šæ ˆ
    æ³¨ï¼šå¯¹äºå¼•ç”¨ç±»å‹ï¼Œå…¶å¼•ç”¨å­˜åœ¨æ ˆä¸­ï¼Œå…¶å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡å®ä¾‹å­˜åœ¨å †ä¸­
     */
    void m() {
        int i4 = 4; // JAVAè™šæ‹Ÿæœºæ ˆ
        Demo d/*å¼•ç”¨ï¼šJAVAè™šæ‹Ÿæœºæ ˆ*/ = new Demo()/*å †*/;
    }
}
```

æ€»ç»“èµ·æ¥ï¼š

- **å®ä¾‹å˜é‡å­˜å‚¨åœ¨å †å†…å­˜ä¸­çš„å¯¹è±¡å®ä¾‹ä¸­**ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰è‡ªå·±çš„å‰¯æœ¬ï¼›
- é™æ€å˜é‡å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ï¼Œå®ƒä»¬è¢«æ‰€æœ‰ç±»çš„å®ä¾‹å…±äº«(`java7`åŠä¹‹åé™æ€å˜é‡è¢«åˆ†é…åˆ°å †ä¸­)ï¼›
- å±€éƒ¨å˜é‡å­˜å‚¨åœ¨æ¯ä¸ªçº¿ç¨‹çš„jvmæ ˆçš„æ ˆå¸§ä¸­ï¼Œå®ƒä»¬åªåœ¨æ–¹æ³•æˆ–ä»£ç å—çš„ä½œç”¨åŸŸå†…å¯è§ï¼›







## æ·±æ‹·è´ æµ…æ‹·è´ å¼•ç”¨æ‹·è´



å…ˆæ¥äº†è§£ä¸€ä¸‹`Object`ç±»ä¸­çš„`clone()`æ–¹æ³•ï¼š

```java
protected native Object clone() throws CloneNotSupportedException;
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`clone()` æ–¹æ³•åŒæ—¶æ˜¯ä¸€ä¸ªæœ¬åœ°ï¼ˆ`native`ï¼‰æ–¹æ³•ï¼Œå®ƒçš„å…·ä½“å®ç°ä¼šäº¤ç»™ `HotSpot` è™šæ‹Ÿæœºï¼Œé‚£å°±æ„å‘³ç€**è™šæ‹Ÿæœºåœ¨è¿è¡Œè¯¥æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šå°†å…¶æ›¿æ¢ä¸ºæ›´é«˜æ•ˆçš„ C/C++ ä»£ç ï¼Œè¿›è€Œè°ƒç”¨æ“ä½œç³»ç»Ÿå»å®Œæˆå¯¹è±¡çš„å…‹éš†å·¥ä½œ**

è€Œ`age`æ˜¯ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯å¼•ç”¨ç±»å‹ã€‚å› æ­¤ï¼Œå³ä½¿è¿›è¡Œäº†æµ…æ‹·è´ï¼Œæ‹·è´å¯¹è±¡å’ŒåŸå¯¹è±¡éƒ½ä¼šæœ‰å„è‡ªç‹¬ç«‹çš„`age`å€¼ã€‚ä¿®æ”¹æ‹·è´å¯¹è±¡çš„`age`ä¸ä¼šå½±å“åŸå¯¹è±¡çš„`age`ï¼Œå› ä¸ºåŸºæœ¬æ•°æ®ç±»å‹åœ¨Javaä¸­æ˜¯æŒ‰å€¼ä¼ é€’çš„ï¼Œæ‹·è´å¯¹è±¡å’ŒåŸå¯¹è±¡å„è‡ªæŒæœ‰çš„æ˜¯`age`çš„å€¼ï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚



### **æµ…æ‹·è´**

**å¦‚æœåŸå¯¹è±¡å†…éƒ¨çš„å±æ€§æ˜¯å¼•ç”¨ç±»å‹çš„è¯ï¼Œæµ…æ‹·è´ä¼šç›´æ¥å¤åˆ¶å†…éƒ¨å¯¹è±¡çš„å¼•ç”¨åœ°å€**ï¼ˆä¼ é€’è¯¥å¼•ç”¨çš„å‰¯æœ¬ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æ‹·è´å¯¹è±¡å’ŒåŸå¯¹è±¡å…±ç”¨åŒä¸€ä¸ªå†…éƒ¨å¯¹è±¡ï¼Œ**å¯¹æ‹·è´å¯¹è±¡æ‰€æ‹¥æœ‰çš„å¼•ç”¨ç±»å‹çš„å†…éƒ¨å±æ€§è¿›è¡Œä¿®æ”¹åï¼ŒåŒæ ·ä¼šå½±å“åˆ°åŸå¯¹è±¡çš„å±æ€§å€¼**

```java
class Writer implements Cloneable{
    private int age;
    private String name;
            //çœç•¥å…¶ä»–
    }
```

`Cloneable` æ¥å£æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œåªæ˜¯ï¼Œå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰å®ç° `Cloneable` æ¥å£ï¼Œå³ä¾¿å®ƒé‡å†™äº† `clone()` æ–¹æ³•ï¼Œä¾ç„¶æ˜¯æ— æ³•è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œå¯¹è±¡å…‹éš†çš„ï¼Œç¨‹åºåœ¨æ‰§è¡Œ `clone()` æ–¹æ³•çš„æ—¶å€™ä¼šæŠ›å‡º `CloneNotSupportedException` å¼‚å¸¸

æµ‹è¯•ç±»å¦‚ä¸‹ï¼š

```java
    class TestClone {
        public static void main(String[] args) throws CloneNotSupportedException {
            Writer writer1 = new Writer(18,"äºŒå“¥");
            Writer writer2 = (Writer) writer1.clone();  //æµ…æ‹·è´

            System.out.println("æµ…æ‹·è´åï¼š");
            System.out.println("writer1ï¼š" + writer1);
            System.out.println("writer2ï¼š" + writer2);

            writer2.setName("ä¸‰å¦¹");

            System.out.println("è°ƒæ•´äº† writer2 çš„ name åï¼š");
            System.out.println("writer1ï¼š" + writer1);
            System.out.println("writer2ï¼š" + writer2);
        }
    }

```

æ¥çœ‹ä¸€ä¸‹è¾“å‡ºç»“æœï¼š

```
æµ…æ‹·è´åï¼š
writer1ï¼šWriter@68837a77{age=18, name='äºŒå“¥'}
writer2ï¼šWriter@b97c004{age=18, name='äºŒå“¥'}
è°ƒæ•´äº† writer2 çš„ name åï¼š
writer1ï¼šWriter@68837a77{age=18, name='äºŒå“¥'}
writer2ï¼šWriter@b97c004{age=18, name='ä¸‰å¦¹'}
```

å¯ä»¥çœ‹å¾—å‡ºï¼Œæµ…æ‹·è´åï¼Œ`writer1` å’Œ `writer2` å¼•ç”¨äº†ä¸åŒçš„å¯¹è±¡ï¼Œä½†å€¼æ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜æ‹·è´æˆåŠŸã€‚

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/core-points/deep-copy-01.png" alt="img" style="zoom: 50%;" />







å†æ¥çœ‹ä¸€ä¸ªåŒ…å«å†…éƒ¨å¼•ç”¨çš„ä¾‹å­ï¼šä¸º `Writer` ç±»å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„å¼•ç”¨ç±»å‹å­—æ®µ **`Book`**

```java
class Writer implements Cloneable{
    private int age;
    private String name;
    private Book book;
    
     @Override
    protected Object clone() throws CloneNotSupportedException {
        /*
     ç¡®ä¿åœ¨æ‹·è´å¯¹è±¡æ—¶ï¼Œå…ˆæ‰§è¡Œçˆ¶ç±»çš„ clone() æ–¹æ³•ï¼Œ
     å†å¯¹å­ç±»çš„ç‰¹æ®Šå±æ€§è¿›è¡Œæ‹·è´ã€‚è¿™æ ·å¯ä»¥ä¿è¯å­ç±»å¯¹è±¡çš„ç‰¹æ®Šå±æ€§ä¹Ÿèƒ½æ­£ç¡®åœ°è¿›è¡Œæ‹·è´   
        */
        return super.clone();
    }
}

class Book {
    private String bookName;
    private int price;

    // getter/setter å’Œæ„é€ æ–¹æ³•éƒ½å·²çœç•¥
}

```



æµ‹è¯•ç±»ï¼š

```java
class TestClone {
    public static void main(String[] args) throws CloneNotSupportedException {
        Writer writer1 = new Writer(18,"äºŒå“¥");
        Book book1 = new Book("ç¼–è¯‘åŸç†",100);
        writer1.setBook(book1);

        Writer writer2 = (Writer) writer1.clone();
        System.out.println("æµ…æ‹·è´åï¼š");

        System.out.println("writer1ï¼š" + writer1);
        System.out.println("writer2ï¼š" + writer2);

        Book book2 = writer2.getBook();
        book2.setBookName("æ°¸æ’çš„å›¾çµ");
        book2.setPrice(70);
        System.out.println("writer2.book å˜æ›´åï¼š");

        System.out.println("writer1ï¼š" + writer1);
        System.out.println("writer2ï¼š" + writer2);
    }
}

```



è¾“å‡ºç»“æœä¸ºï¼š

```java

æµ…æ‹·è´åï¼š
writer1ï¼šWriter@68837a77 age=18, name='äºŒå“¥', book=Book@32e6e9c3 bookName='ç¼–è¯‘åŸç†', price=100}}
writer2ï¼šWriter@6d00a15d age=18, name='äºŒå“¥', book=Book@32e6e9c3 bookName='ç¼–è¯‘åŸç†', price=100}}


writer2.book å˜æ›´åï¼š
writer1ï¼šWriter@68837a77 age=18, name='äºŒå“¥', book=Book@32e6e9c3 bookName='æ°¸æ’çš„å›¾çµ', price=70}}
writer2ï¼šWriter@36d4b5c age=18, name='äºŒå“¥', book=Book@32e6e9c3 bookName='æ°¸æ’çš„å›¾çµ', price=70}}
```

ä¸ä¹‹å‰ä¾‹å­ä¸åŒçš„æ˜¯ï¼Œ`writer2.book` å˜æ›´åï¼Œ`writer1.book` ä¹Ÿå‘ç”Ÿäº†æ”¹å˜ã€‚è¿™æ˜¯å› ä¸ºå­—ç¬¦ä¸² `String` æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œä¸€ä¸ªæ–°çš„å€¼å¿…é¡»åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å¼€è¾Ÿä¸€æ®µæ–°çš„å†…å­˜ç©ºé—´ï¼Œè€Œè‡ªå®šä¹‰å¯¹è±¡`Book`çš„å†…å­˜åœ°å€å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œåªæ˜¯å¯¹åº”çš„å­—æ®µå€¼å‘ç”Ÿäº†æ”¹å˜(æµ…æ‹·è´)



> æµ…æ‹·è´å¤åˆ¶å¯¹è±¡æ—¶ï¼Œ**åªå¤åˆ¶å¯¹è±¡æœ¬èº«åŠå…¶æ‰€æœ‰ç›´æ¥å¼•ç”¨çš„å¯¹è±¡å¼•ç”¨ï¼Œè€Œä¸ä¼šå¤åˆ¶å¯¹è±¡å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡**ã€‚å› æ­¤ï¼Œæµ…æ‹·è´å¾—åˆ°çš„æ˜¯ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œä½†**è¯¥æ–°å¯¹è±¡ä¸­çš„æˆå‘˜å¼•ç”¨å˜é‡æŒ‡å‘çš„æ˜¯åŸå¯¹è±¡ä¸­ç›¸åŒå¼•ç”¨çš„å¯¹è±¡**







### **æ·±æ‹·è´**

æ·±æ‹·è´ä¼šå®Œå…¨å¤åˆ¶æ•´ä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬è¿™ä¸ªå¯¹è±¡æ‰€åŒ…å«çš„å†…éƒ¨å¯¹è±¡ï¼Œè¿™æ ·**å¯¹åŸå¯¹è±¡å†…éƒ¨å¼•ç”¨å˜é‡æŒ‡å‘çš„å¯¹è±¡å±æ€§çš„ä¿®æ”¹ä¸ä¼šå½±å“å¦ä¸€ä¸ªé€šè¿‡æ·±æ‹·è´ç”Ÿæˆçš„å¯¹è±¡**

å³æ·±æ‹·è´ä¸ä»…å¤åˆ¶å¯¹è±¡æœ¬èº«ï¼Œè¿˜å¤åˆ¶å¯¹è±¡å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚æ·±æ‹·è´å¾—åˆ°çš„æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç‹¬ç«‹å¯¹è±¡ï¼Œå…¶ä¸­çš„å¼•ç”¨æŒ‡å‘çš„æ˜¯å¤åˆ¶åçš„å¯¹è±¡ï¼Œè¿˜æ˜¯ä¸Šé¢é‚£ä¸ªä¾‹å­ï¼š`Book`ç±»ä¹Ÿé‡å†™`clone()`æ–¹æ³•

```java
class Book implements Cloneable{
    private String bookName;
    private int price;

    // getter/setter å’Œæ„é€ æ–¹æ³•éƒ½å·²çœç•¥

    @Override
    protected Object clone() throws CloneNotSupportedException {
        return super.clone();
    }
}


class Writer implements Cloneable{
    private int age;
    private String name;
    private Book book;

    // getter/setter å’Œæ„é€ æ–¹æ³•éƒ½å·²çœç•¥

    @Override
    protected Object clone() throws CloneNotSupportedException {
        Writer writer = (Writer) super.clone();
        writer.setBook((Book) writer.getBook().clone());//æ ¸å¿ƒ
        return writer;
    }
}

```

- æ­¤æ—¶çš„ `Book` ç±»å’Œæµ…æ‹·è´æ—¶ä¸åŒï¼Œé‡å†™äº† `clone()` æ–¹æ³•ï¼Œå¹¶å®ç°äº† `Cloneable` æ¥å£ã€‚ä¸ºçš„å°±æ˜¯æ·±æ‹·è´çš„æ—¶å€™ä¹Ÿèƒ½å¤Ÿå…‹éš†è¯¥å­—æ®µ
- æ­¤æ—¶çš„ `Writer` ç±»ä¹Ÿä¸ä¹‹å‰çš„ä¸åŒï¼Œ`clone()` æ–¹æ³•å½“ä¸­ï¼Œä¸å†åªè°ƒç”¨ `Object` çš„ `clone()` æ–¹æ³•å¯¹ `Writer` è¿›è¡Œå…‹éš†äº†ï¼Œ**è¿˜å¯¹ `Book` ä¹Ÿè¿›è¡Œäº†å…‹éš†**â€”â€”â€”â€”å¤–éƒ¨å¯¹è±¡è°ƒç”¨å†…éƒ¨å¯¹è±¡çš„`clone()`æ–¹æ³•



æ¥çœ‹æµ‹è¯•ç±»ï¼š

```java
class TestClone {
    public static void main(String[] args) throws CloneNotSupportedException {
        Writer writer1 = new Writer(18,"äºŒå“¥");
        Book book1 = new Book("ç¼–è¯‘åŸç†",100);
        writer1.setBook(book1);

        Writer writer2 = (Writer) writer1.clone();
        System.out.println("æ·±æ‹·è´åï¼š");

        System.out.println("writer1ï¼š" + writer1);
        System.out.println("writer2ï¼š" + writer2);

        Book book2 = writer2.getBook();
        book2.setBookName("æ°¸æ’çš„å›¾çµ");
        book2.setPrice(70);
        System.out.println("writer2.book å˜æ›´åï¼š");

        System.out.println("writer1ï¼š" + writer1);
        System.out.println("writer2ï¼š" + writer2);
    }
}

```

è¿™ä¸ªæµ‹è¯•ç±»å’Œä¹‹å‰çš„æµ…æ‹·è´çš„æµ‹è¯•ç±»å®Œå…¨ä¸€æ ·ï¼Œä½†è¿è¡Œç»“æœæ˜¯ä¸åŒçš„:

```
æ·±æ‹·è´åï¼š

writer1ï¼šWriter@6be46e8f age=18, name='äºŒå“¥', book=Book@5056dfcb bookName='ç¼–è¯‘åŸç†', price=100}}
writer2ï¼šWriter@6d00a15d age=18, name='äºŒå“¥', book=Book@51efea79 bookName='ç¼–è¯‘åŸç†', price=100}}


writer2.book å˜æ›´åï¼š
writer1ï¼šWriter@6be46e8f age=18, name='äºŒå“¥', book=Book@5056dfcb bookName='ç¼–è¯‘åŸç†', price=100}}
writer2ï¼šWriter@6d00a15d age=18, name='äºŒå“¥', book=Book@51efea79 bookName='æ°¸æ’çš„å›¾çµ', price=70}}

```

ä¸åªæ˜¯ writer1 å’Œ writer2 æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œå®ƒä»¬ä¸­çš„ book ä¹Ÿæ˜¯ä¸åŒçš„å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œæ”¹å˜äº† writer2 ä¸­çš„ book å¹¶ä¸ä¼šå½±å“åˆ° writer1

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/core-points/deep-copy-03.png" alt="img" style="zoom: 50%;" />

é€šè¿‡ `clone()` æ–¹æ³•å®ç°çš„æ·±æ‹·è´æ¯”è¾ƒç¬¨é‡ï¼Œå› ä¸ºè¦å°†æ‰€æœ‰çš„å¼•ç”¨ç±»å‹éƒ½é‡å†™ `clone()` æ–¹æ³•ï¼Œå½“åµŒå¥—çš„å¯¹è±¡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå°±éå¸¸ç¹çäº†ï¼Œå¯ä»¥åˆ©ç”¨åºåˆ—åŒ–(æ¯ä¸ªè¦åºåˆ—åŒ–çš„ç±»éƒ½è¦å®ç°`Serializable`æ¥å£â€”â€”æ ‡è®°å‹æ¥å£)æ¥å®ç°æ·±æ‹·è´









å®ç°æµ…æ‹·è´/æ·±æ‹·è´ï¼Œå¯ä»¥å®ç°`Cloneable`æ¥å£å¹¶é‡å†™`clone()`ï¼Œä¸¤è€…å®ç°çš„ä¸åŒä¹‹å¤„åˆ™åœ¨äºæ˜¯å¦è¦åœ¨å¤–éƒ¨å¯¹è±¡çš„`cloneï¼ˆï¼‰`å†…éƒ¨è°ƒç”¨å†…éƒ¨å¯¹è±¡çš„`clone()`ï¼š

```java
public class Address implements Cloneable{
    private String name;
    // çœç•¥æ„é€ å‡½æ•°ã€Getter&Setteræ–¹æ³•
    @Override
    public Address clone() {
        try {
            return (Address) super.clone();
        } catch (CloneNotSupportedException e) {
            throw new AssertionError();
        }
    }
}


public class Person implements Cloneable {
    private Address address;
    // çœç•¥æ„é€ å‡½æ•°ã€Getter&Setteræ–¹æ³•
    
    
    //æµ…æ‹·è´
    @Override
    public Person clone() {
        try {
            Person person = (Person) super.clone();
            return person;
        } catch (CloneNotSupportedException e) {
            throw new AssertionError();
        }
    }
---------------------------------------------------------------------------------------------------  
    //æ·±æ‹·è´
    @Override
    public Person clone() {
    try {
        Person person = (Person) super.clone();
        person.setAddress(person.getAddress().clone());//è°ƒç”¨å†…éƒ¨å¯¹è±¡çš„cloneæ–¹æ³•ï¼Œæ‹·è´å‡ºä¸€ä¸ªæ–°çš„Addresså¯¹è±¡ä½œä¸ºå…¶æ–°å¯¹è±¡çš„å†…éƒ¨å±æ€§
        return person;
    } catch (CloneNotSupportedException e) {
        throw new AssertionError();
    }
}
}
```









### **å¼•ç”¨æ‹·è´**

 ç®€å•æ¥è¯´ï¼Œå¼•ç”¨æ‹·è´å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„å¼•ç”¨æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/shallow&deep-copy.png)

è¿™æ ·ï¼Œå¯¹å…¶ä¸­ä¸€ä¸ªå¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œå¦ä¸€ä¸ªå¼•ç”¨ä¹Ÿä¼šåæ˜ å‡ºç›¸åŒçš„ä¿®æ”¹

```java
Person person1 = new Person("Alice");

// å¼•ç”¨æ‹·è´  person1å’Œperson2ä¸¤ä¸ªå¼•ç”¨æŒ‡å‘åŒä¸€å¯¹è±¡å®ä¾‹
Person person2 = person1;

// ä¿®æ”¹ person2 çš„å±æ€§   person1.nameä¹Ÿä¼šä¸€èµ·æ›´æ”¹
person2.setName("Bob");
```









## Javaçš„å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’

**Java ä¸­çš„å¯¹è±¡å¼•ç”¨ä¼ é€’ï¼Œå®é™…ä¸Šæ˜¯å°†å¯¹è±¡çš„å¼•ç”¨ï¼ˆå†…å­˜åœ°å€ï¼‰å¤åˆ¶ä¸€ä»½ä¼ é€’ç»™æ–¹æ³•ï¼Œæ–¹æ³•å†…éƒ¨å¯¹å‚æ•°çš„æ“ä½œä¼šå½±å“åŸå§‹å¯¹è±¡ï¼›è€Œå¦‚æœä¼ é€’çš„æ•°æ®ç±»å‹æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ™ä¼ é€’çš„æ˜¯åŸºæœ¬æ•°æ®ç±»å‹å‚æ•°å€¼çš„å‰¯æœ¬**  :exclamation: :exclamation: :exclamation:

å…ˆæ¥çœ‹çœ‹åŸºæœ¬æ•°æ®ç±»å‹å’Œå¼•ç”¨æ•°æ®ç±»å‹ä¹‹é—´çš„å·®åˆ«ï¼š

```java
int age = 18;
String name = "äºŒå“¥";
```

age æ˜¯åŸºæœ¬ç±»å‹ï¼Œå€¼å°±ä¿å­˜åœ¨å˜é‡ä¸­ï¼Œè€Œ name æ˜¯å¼•ç”¨ç±»å‹ï¼Œå˜é‡ä¸­ä¿å­˜çš„æ˜¯å¯¹è±¡çš„åœ°å€ã€‚ä¸€èˆ¬ç§°è¿™ç§å˜é‡ä¸ºå¯¹è±¡çš„å¼•ç”¨ï¼Œå¼•ç”¨(å¦‚æœå£°æ˜åœ¨æ–¹æ³•é‡Œâ€”â€”å±€éƒ¨å˜é‡)å­˜æ”¾åœ¨æ ˆä¸­ï¼Œè€Œå¯¹è±¡å­˜æ”¾åœ¨å †ä¸­ã€‚

å½“ç”¨ = èµ‹å€¼è¿ç®—ç¬¦æ”¹å˜ age å’Œ name çš„å€¼æ—¶

```java
age = 16;
name = "ä¸‰å¦¹";
```

å¯¹äºåŸºæœ¬ç±»å‹ ageï¼Œèµ‹å€¼è¿ç®—ç¬¦ä¼šç›´æ¥æ”¹å˜å˜é‡çš„å€¼ï¼ŒåŸæ¥çš„å€¼è¢«è¦†ç›–ã€‚

å¯¹äºå¼•ç”¨ç±»å‹ nameï¼Œèµ‹å€¼è¿ç®—ç¬¦ä¼šæ”¹å˜å¯¹è±¡å¼•ç”¨ä¸­ä¿å­˜çš„åœ°å€ï¼Œå¼•ç”¨æŒ‡å‘çš„åœ°å€å˜åŒ–äº†ï¼Œä½†**åŸæ¥çš„å¯¹è±¡ä¸ä¼šè¢«è¦†ç›–**ã€‚

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/core-points/pass-by-value-02.png" alt="img" style="zoom: 50%;" />

> åœ¨javaä¸­ï¼š
>
> **å¦‚æœå‚æ•°æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¼ é€’çš„æ˜¯åŸºæœ¬ç±»å‹çš„å­—é¢é‡å€¼çš„æ‹·è´**
>
> 
>
> **å¦‚æœå‚æ•°æ˜¯å¼•ç”¨ç±»å‹ï¼Œä¼ é€’çš„æ˜¯å¼•ç”¨çš„å¯¹è±¡åœ¨å †ä¸­åœ°å€çš„æ‹·è´ï¼Œå³æ–°çš„å¼•ç”¨å’Œæ—§çš„å¼•ç”¨æŒ‡å‘åŒä¸€å †ä¸­å¯¹è±¡**



ç„¶åå†æ¥çœ‹ä¸€çœ‹æ•°æ®ç±»å‹çš„ä¼ é€’ï¼š



### åŸºæœ¬æ•°æ®ç±»å‹ä¼ é€’

```java
class PrimitiveTypeDemo {
    public static void main(String[] args) {
        int age = 18;
        modify(age);
        System.out.println(age);
    }

    private static void modify(int age1) {
        age1 = 30;
    }
}
```

1ï¼‰`main()` æ–¹æ³•ä¸­çš„ age ä¸ºåŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥å®ƒçš„å€¼ 18 ç›´æ¥å­˜å‚¨åœ¨å˜é‡ä¸­ã€‚

2ï¼‰è°ƒç”¨ `modify()` æ–¹æ³•çš„æ—¶å€™ï¼Œå°†ä¼šæŠŠ age çš„å€¼ 18 å¤åˆ¶ç»™å½¢å‚ age1ï¼ˆ**ä¼ é€’äº†å€¼çš„æ‹·è´**ï¼‰ã€‚

3ï¼‰`modify()` æ–¹æ³•ä¸­ï¼Œå¯¹ age1 åšå‡ºäº†ä¿®æ”¹ã€‚

4ï¼‰å›åˆ° `main()` æ–¹æ³•ä¸­ï¼Œage çš„å€¼ä»ç„¶ä¸º 18ï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚



å¦‚ä½•ä»`JVM`çš„è§’åº¦æ¥ç†è§£ï¼Ÿ

åœ¨ Java ä¸­ï¼Œæ–¹æ³•å‚æ•°çš„ä¼ é€’æ˜¯é€šè¿‡æ ˆå¸§ï¼ˆStack Frameï¼‰æ¥å®ç°çš„ã€‚æ¯ä¸ªæ–¹æ³•åœ¨è¢«è°ƒç”¨æ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºå­˜å‚¨æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€å‚æ•°å’Œè¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚æ ˆå¸§åœ¨æ–¹æ³•æ‰§è¡Œå®Œæ¯•åä¼šè¢«é”€æ¯ã€‚

å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ–¹æ³•å‚æ•°å­˜å‚¨çš„æ˜¯å®é™…å€¼çš„æ‹·è´ã€‚å½“è°ƒç”¨ `modify(age)` æ–¹æ³•æ—¶ï¼Œ`age` çš„å€¼ 18 ä¼šè¢«æ‹·è´åˆ° `modify` æ–¹æ³•çš„æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡ `age1` ä¸­ã€‚å› æ­¤ï¼Œ`age1` æ˜¯ `age` çš„ä¸€ä»½æ‹·è´ï¼Œå®ƒä»¬åˆ†åˆ«åœ¨ä¸åŒçš„æ ˆå¸§ä¸­å­˜å‚¨ã€‚

ä¿®æ”¹ `modify` æ–¹æ³•å†…éƒ¨çš„ `age1` å¯¹ `age` æ²¡æœ‰å½±å“ï¼Œå› ä¸º**å®ƒä»¬æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å˜é‡å­˜å‚¨åœ¨ä¸åŒçš„æ ˆå¸§ä¸­**ã€‚æ‰€ä»¥ï¼Œå½“æ–¹æ³• `modify` æ‰§è¡Œå®Œæ¯•åï¼Œ`age1` æ‰€åœ¨çš„æ ˆå¸§è¢«é”€æ¯ï¼Œè€Œ `age` æ‰€åœ¨çš„æ ˆå¸§ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤ `age` çš„å€¼ä»ç„¶æ˜¯ 18

å¯ä»¥å°†æ–¹æ³•çš„æ ˆå¸§çœ‹ä½œä¸€ä¸ªä¸´æ—¶çš„å·¥ä½œåŒºåŸŸï¼Œæ¯ä¸ªæ–¹æ³•è°ƒç”¨éƒ½æœ‰è‡ªå·±çš„æ ˆå¸§ã€‚**æ–¹æ³•å‚æ•°çš„ä¼ é€’å°±æ˜¯å°†å€¼ä»ä¸€ä¸ªæ ˆå¸§æ‹·è´åˆ°å¦ä¸€ä¸ªæ ˆå¸§ä¸­ï¼Œè€Œä¸ä¼šå½±å“åˆ°åŸå§‹æ ˆå¸§ä¸­çš„å€¼ã€‚è¿™æ ·ï¼Œæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œæ—¶éƒ½å¯ä»¥ç‹¬ç«‹æ“ä½œè‡ªå·±çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼Œäº’ä¸å¹²æ‰°ï¼Œå®ç°äº†æ–¹æ³•ä¹‹é—´çš„éš”ç¦»å’Œå®‰å…¨æ€§ã€‚**







### å¼•ç”¨ç±»å‹ä¼ é€’

ç›´æ¥çœ‹ä¾‹å­

ä¾‹å­1ï¼šä¼ é€’æ•°ç»„ç±»å‹

```java
	public static void main(String[] args) {
      int[] arr = { 1, 2, 3, 4, 5 };
      System.out.println(arr[0]);
      change(arr);
      System.out.println(arr[0]);
	}

	public static void change(int[] array) {
      // å°†æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ å˜ä¸º0
      array[0] = 0;
	}
```

ä»¥ä¸Šä»£ç è¾“å‡ºç»“æœä¸ºï¼š

```java
1
0
```

å®é™…ä¸Š`change()`ä¼ é€’çš„æ˜¯å®å‚arrçš„åœ°å€ï¼Œæ­¤æ—¶åœ¨jvmä¸­æœ‰ä¸¤ä¸ªå¼•ç”¨arrã€arrayåŒæ—¶æŒ‡å‘å †ä¸­çš„æ•°ç»„ï¼Œå› æ­¤å¯¹array[]çš„ä¿®æ”¹å°†ä¼šå½±å“åˆ°åŸæ¥arr[]çš„å€¼ï¼› **æ•°ç»„ä¹Ÿå±äºå¼•ç”¨ç±»å‹(éåŸºæœ¬æ•°æ®ç±»å‹ï¼Œå› æ­¤ä¼ é€’çš„æ˜¯å¼•ç”¨å¯¹è±¡çš„å†…å­˜åœ°å€)**





ä¾‹å­2ï¼šä¼ é€’å¼•ç”¨ç±»å‹å˜é‡(`String`)

```java
class ReferenceTypeDemo {
    public static void main(String[] args) {
        String name = "äºŒå“¥";
        modify(name);
        System.out.println(name);
    }

    private static void modify(String name1) {
        name1 = "ä¸‰å¦¹";
    }
}
```

åˆšåˆšè¿›å…¥`modify()`æ–¹æ³•æ—¶ï¼Œä¼šåœ¨å½“å‰çº¿ç¨‹(è¿™é‡Œåº”è¯¥æ˜¯ä¸»çº¿ç¨‹)çš„è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºä¸€ä¸ªæ–°æ ˆå¸§

> `main()` æ–¹æ³•åœ¨ä¸»çº¿ç¨‹æ‰€æ‹¥æœ‰çš„è™šæ‹Ÿæœºæ ˆä¸­å¯¹åº”ä¸€ä¸ªæ ˆå¸§ã€‚
>
> å½“è¿è¡Œä¸€ä¸ª Java ç¨‹åºæ—¶ï¼ŒJVM ä¼šåœ¨ä¸»çº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆä¸Šæ‰§è¡Œ `main()` æ–¹æ³•ã€‚**`main()` æ–¹æ³•ä½œä¸ºç¨‹åºçš„å…¥å£ç‚¹ï¼Œä¼šåœ¨ä¸»çº¿ç¨‹çš„æ ˆä¸Šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºå­˜å‚¨ `main()` æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€å‚æ•°å’Œæ“ä½œæ•°æ ˆç­‰ä¿¡æ¯**ã€‚è¿™ä¸ªæ ˆå¸§ä»£è¡¨äº† `main()` æ–¹æ³•çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒ…å«äº† `main()` æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆï¼Œä»¥åŠä¸€äº›ç”¨äºæ–¹æ³•è°ƒç”¨å’Œè¿”å›çš„ä¿¡æ¯ã€‚
>
> å½“ `main()` æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œæˆ–è€…**åœ¨å…¶ä¸­è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œå°±ä¼šåœ¨ä¸»çº¿ç¨‹çš„æ ˆä¸Šåˆ›å»ºæ–°çš„æ ˆå¸§ï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–æ–¹æ³•çš„ä»£ç ã€‚æ¯å½“æ–¹æ³•è°ƒç”¨å‘ç”Ÿï¼Œå°±ä¼šåˆ›å»ºæ–°çš„æ ˆå¸§ï¼›æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œå¯¹åº”çš„æ ˆå¸§å°±ä¼šè¢«é”€æ¯ï¼Œå›åˆ°ä¸Šä¸€ä¸ªæ ˆå¸§ï¼Œç›´åˆ°å›åˆ°ä¸»çº¿ç¨‹çš„æ ˆé¡¶**ï¼Œä¹Ÿå°±æ˜¯å›åˆ° `main()` æ–¹æ³•çš„æ ˆå¸§
>
> æ‰€ä»¥ï¼Œ`main()` æ–¹æ³•åœ¨ä¸»çº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆä¸­å¯¹åº”ä¸€ä¸ªæ ˆå¸§ï¼Œå®ƒæ˜¯ç¨‹åºæ‰§è¡Œçš„èµ·ç‚¹å’Œå…¥å£ã€‚æ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨éƒ½å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹çš„æ ˆä¸Šï¼Œç›´åˆ°æ•´ä¸ªç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/core-points/pass-by-value-03.png" alt="img" style="zoom:50%;" />z

**æ³¨ï¼šä¸Šå›¾ä¸­çš„ æ ˆ æŒ‡çš„æ˜¯main()æ–¹æ³•å¯¹åº”çš„ä¸»çº¿ç¨‹æ‰€æ‹¥æœ‰çš„jvmæ ˆä¸­  å­˜æ”¾çš„ä¸åŒçš„æ ˆå¸§**

åœ¨è¿›å…¥ `modify()` æ–¹æ³•æ—¶ï¼Œå½¢å‚ `name1` çš„æŒ‡å‘å¤åˆ¶äº†`name` çš„åœ°å€ï¼ŒæŒ‡å‘çš„åŒæ ·æ˜¯å †ä¸­â€œäºŒå“¥â€çš„ä½ç½®





è€Œåœ¨å®Œæˆ`modify()`æ–¹æ³•åï¼Œå˜åŒ–å¦‚ä¸‹æ‰€ç¤ºï¼š

``<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/core-points/pass-by-value-04.png" alt="img" style="zoom:50%;" />



**å› æ­¤main()æ–¹æ³•ä¸­çš„å¼•ç”¨ç±»å‹å˜é‡nameçš„å€¼ è‡ªç„¶æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œä¾ç„¶æŒ‡å‘çš„æ˜¯å †ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡"äºŒå“¥"**







ä¾‹å­3(è¿™ä¸ªå®¹æ˜“æ··æ·†)ï¼š

```java
public class Person {
    private String name;
   // çœç•¥æ„é€ å‡½æ•°ã€Getter&Setteræ–¹æ³•
}

public static void main(String[] args) {
    Person xiaoZhang = new Person("å°å¼ ");
    Person xiaoLi = new Person("å°æ");
    swap1(xiaoZhang, xiaoLi);
    System.out.println("xiaoZhang:" + xiaoZhang.getName());
    System.out.println("xiaoLi:" + xiaoLi.getName());
    
    swap2(xiaoZhang, xiaoLi);
    System.out.println("xiaoZhang:" + xiaoZhang.getName());
    System.out.println("xiaoLi:" + xiaoLi.getName());
}

public static void swap1(Person person1, Person person2) {
    Person temp = person1;
    person1 = person2;
    person2 = temp;
}

 public static void swap2(Person person1, Person person2) {
        Person temp = person1;
        temp.setName("xiaowang");
        person1=person2;
        person2 = temp;
    }

```

åœ¨è°ƒç”¨`swap1()`å‡½æ•°æ—¶ï¼š

(1) Mainçº¿ç¨‹å¼€è¾Ÿçš„æ–°æ ˆå¸§ä¸­çš„å±€éƒ¨å¼•ç”¨å˜é‡`person1`ï¼Œæœ€å¼€å§‹å­˜æ”¾çš„æ˜¯`Person`å‹å¼•ç”¨å˜é‡`xiaozhang`å­˜æ”¾çš„å †ç©ºé—´åœ°å€(æŒ‡å‘å †ç©ºé—´ä¸­çš„ `new Person("å°å¼ ")` )ï¼Œ`person2`åŒç†

(2) tempå¼•ç”¨æŒ‡å‘äº†å †ç©ºé—´ä¸­çš„ `new Person("å°å¼ ")`ï¼Œ`person1`æŒ‡å‘äº†å †ç©ºé—´ä¸­çš„ `new Person("å°æ")`ï¼Œæœ€å`person2`æŒ‡å‘äº†å †ç©ºé—´ä¸­çš„ `new Person("å°å¼ ")`

(3) å› æ­¤`swap1()`è¿™ä¸€æ ˆå¸§ä¸­å¼•ç”¨å˜é‡æŒ‡å‘çš„å˜åŒ–å¯¹`main()`æ–¹æ³•å¯¹åº”çš„æ ˆå¸§ä¸­çš„å±€éƒ¨å¼•ç”¨ç±»å‹å˜é‡`xiaoLi`ã€`xiaoZhang`å®Œå…¨æ²¡æœ‰å½±å“ï¼ï¼ï¼





åœ¨è°ƒç”¨`swap2()`å‡½æ•°æ—¶ï¼š

`temp.setName("xiaowang")`è¿™ä¸€è¡Œä»£ç æ”¹å˜äº†`temp`æŒ‡å‘çš„å †ä¸­å¯¹è±¡çš„å±æ€§å€¼ï¼Œå³è¯¥`swap2()`æ–¹æ³•è¿›å…¥æ—¶`person1`æŒ‡å‘çš„å †ä¸­å¯¹è±¡â€”â€”`new Person("å°å¼ ")`ï¼Œè¯¥å¯¹è±¡çš„æˆå‘˜å±æ€§`name`çš„å€¼ï¼Œå› æ­¤æœ€å`person2`å¼•ç”¨æŒ‡å‘çš„å †ä¸­å¯¹è±¡æ‰€æ‹¥æœ‰çš„nameå±æ€§å€¼å°±æ˜¯"`xiaowang`"

æ•…ä»¥ä¸Šä»£ç è¾“å‡ºç»“æœä¸ºï¼š

```java
xiaoZhang:å°å¼ 
xiaoLi:å°æ
    
xiaoZhang:xiaowang
xiaoLi:å°æ
```



**å¯ä»¥çœ‹å‡ºæ¥JVMçš„ç›¸å…³çŸ¥è¯†èƒ½å¤Ÿå¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬ç†è§£ä¸ºä»€ä¹ˆJavaåªæœ‰å€¼ä¼ é€’ ** :happy:





## Javaå¼‚å¸¸æœºåˆ¶



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/types-of-exceptions-in-java.png" style="zoom: 80%;" />



`Exception` å’Œ `Error` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çš„å¼‚å¸¸éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç¥–å…ˆ `java.lang` åŒ…ä¸­çš„ `Throwable` ç±»ã€‚`Throwable` ç±»æœ‰ä¸¤ä¸ªé‡è¦çš„å­ç±»:

- **`Exception`**:ç¨‹åºæœ¬èº«å¯ä»¥å¤„ç†çš„å¼‚å¸¸ï¼Œå¯ä»¥é€šè¿‡ `try-catch` æ¥è¿›è¡Œæ•è·ã€‚`Exception` åˆå¯ä»¥åˆ†ä¸º `Checked Exception` (å—æ£€æŸ¥å¼‚å¸¸ï¼Œå¿…é¡»å¤„ç†,**å¦‚æœå—æ£€æŸ¥å¼‚å¸¸æ²¡æœ‰è¢« `catch`æˆ–è€…`throws` å…³é”®å­—å¤„ç†çš„è¯ï¼Œå°±æ²¡åŠæ³•é€šè¿‡ç¼–è¯‘**) å’Œ `Unchecked Exception` (åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå³ä½¿**ä¸å¤„ç†ä¸å—æ£€æŸ¥å¼‚å¸¸ä¹Ÿå¯ä»¥æ­£å¸¸é€šè¿‡ç¼–è¯‘**)
- **`Error`ï¼š**`Error` å±äº**ç¨‹åºæ— æ³•å¤„ç†çš„é”™è¯¯** ï¼Œä¸å»ºè®®é€šè¿‡`catch`æ•è·ã€‚ä¾‹å¦‚ Java è™šæ‹Ÿæœºè¿è¡Œé”™è¯¯ï¼ˆ`Virtual MachineError`ï¼‰ã€è™šæ‹Ÿæœºå†…å­˜ä¸å¤Ÿé”™è¯¯(`OutOfMemoryError`)ã€ç±»å®šä¹‰é”™è¯¯ï¼ˆ`NoClassDefFoundError`ï¼‰ç­‰ ã€‚è¿™äº›å¼‚å¸¸å‘ç”Ÿæ—¶ï¼ŒJava è™šæ‹Ÿæœºä¸€èˆ¬ä¼šé€‰æ‹©çº¿ç¨‹ç»ˆæ­¢

**Checked Exception** å³**å—æ£€æŸ¥å¼‚å¸¸**(éœ€è¦`try catch`æ•è·ï¼ï¼) ï¼ŒJavaä»£ç åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå—æ£€æŸ¥å¼‚å¸¸æ²¡æœ‰è¢« `catch`æˆ–è€…`throws` å…³é”®å­—å¤„ç†çš„è¯ï¼Œå°±æ²¡åŠæ³•é€šè¿‡ç¼–è¯‘,é™¤äº†`RuntimeException`åŠå…¶å­ç±»ä»¥å¤–ï¼Œå…¶ä»–çš„`Exception`ç±»åŠå…¶å­ç±»éƒ½å±äºå—æ£€æŸ¥å¼‚å¸¸ã€‚å¸¸è§çš„å—æ£€æŸ¥å¼‚å¸¸æœ‰ï¼š`IOException`ã€`ClassNotFoundException` ã€`SQLException`ç­‰

**Unchecked Exception** å³**ä¸å—æ£€æŸ¥å¼‚å¸¸**ï¼ŒJavaä»£ç åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­,æˆ‘ä»¬å³ä½¿ä¸å¤„ç†ä¸å—æ£€æŸ¥å¼‚å¸¸ä¹Ÿå¯ä»¥æ­£å¸¸é€šè¿‡ç¼–è¯‘,`RuntimeException` åŠå…¶å­ç±»éƒ½ç»Ÿç§°ä¸ºéå—æ£€æŸ¥å¼‚å¸¸ï¼Œå¸¸è§çš„æœ‰ï¼ˆå»ºè®®è®°ä¸‹æ¥ï¼Œæ—¥å¸¸å¼€å‘ä¸­ä¼šç»å¸¸ç”¨åˆ°ï¼‰ï¼š

- `NullPointerException`(ç©ºæŒ‡é’ˆé”™è¯¯)
- `IllegalArgumentException`(å‚æ•°é”™è¯¯æ¯”å¦‚æ–¹æ³•å…¥å‚ç±»å‹é”™è¯¯)
- `NumberFormatException`ï¼ˆå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—æ ¼å¼é”™è¯¯ï¼Œ`IllegalArgumentException`çš„å­ç±»ï¼‰
- `ArrayIndexOutOfBoundsException`ï¼ˆæ•°ç»„è¶Šç•Œé”™è¯¯ï¼‰
- `ClassCastException`ï¼ˆç±»å‹è½¬æ¢é”™è¯¯ï¼‰

**Errorï¼š** `Error` æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å¼‚å¸¸ï¼Œä¸å±äºç¨‹åºé€»è¾‘çš„ä¸€éƒ¨åˆ†ï¼Œè¡¨ç¤ºç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹(**ä¸€ä¸ªjavaæ–‡ä»¶æ‰§è¡Œè¿‡ç¨‹åŒ…æ‹¬.javaç¼–è¯‘ç”Ÿæˆ.classå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶ååœ¨è¿è¡Œé˜¶æ®µç¿»è¯‘æˆæœºå™¨ç **)ä¸­é‡åˆ°äº†ä¸¥é‡çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æ— æ³•æ¢å¤æˆ–å¤„ç†çš„ã€‚é€šå¸¸`Error` è¡¨ç¤º `JVM` æˆ–è€…åº•å±‚ç³»ç»Ÿå‘ç”Ÿäº†ä¸€äº›ä¸å¯é¢„æœŸçš„é—®é¢˜ï¼Œå¯¼è‡´ç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œ,ä¾‹å¦‚ï¼š

`OutOfMemoryError`:å †å†…å­˜æº¢å‡º

`StackOverflowError`:javaè™šæ‹Ÿæœºæ ˆæº¢å‡º



> **`try-with-resources`æ˜¯ä»€ä¹ˆï¼Ÿ**

`try-with-resources` æ˜¯ Java 7 å¼•å…¥çš„ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œç”¨äºç®€åŒ–èµ„æºçš„ç®¡ç†å’Œå…³é—­ã€‚å®ƒå¯ä»¥åœ¨ä»£ç å—ç»“æŸæ—¶è‡ªåŠ¨å…³é—­èµ„æºï¼Œæ— éœ€æ˜¾å¼åœ°ä½¿ç”¨ `finally` å—æ¥å…³é—­èµ„æºï¼Œä»è€Œä½¿ä»£ç æ›´åŠ ç®€æ´å’Œæ˜“äºç»´æŠ¤ã€‚

ä¼ ç»Ÿçš„èµ„æºå…³é—­æ–¹å¼éœ€è¦åœ¨ `finally` å—ä¸­æ‰‹åŠ¨å…³é—­èµ„æºï¼Œä¾‹å¦‚å…³é—­æ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥ç­‰ã€‚ä½¿ç”¨ `try-with-resources` åï¼Œå¯ä»¥å°†èµ„æºçš„å£°æ˜æ”¾åœ¨ `try` è¯­å¥åçš„æ‹¬å·ä¸­ï¼Œ`Java` ä¼šåœ¨ä»£ç å—æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨å…³é—­è¿™äº›èµ„æºï¼Œæ— è®ºä»£ç å—æ˜¯æ­£å¸¸æ‰§è¡Œå®Œæ¯•è¿˜æ˜¯å› ä¸ºå¼‚å¸¸è€Œè·³å‡ºã€‚

`try-with-resources` ä½¿ç”¨ `AutoCloseable` æ¥å£æ¥æ ‡è¯†éœ€è¦è‡ªåŠ¨å…³é—­çš„èµ„æºã€‚`AutoCloseable` æ¥å£ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³• `close()`ï¼Œç”¨äºæ‰§è¡Œèµ„æºçš„å…³é—­æ“ä½œã€‚å¸¸è§çš„èµ„æºç±»å¦‚ `java.io.Closeable` å’Œ `java.sql.Connection` éƒ½å®ç°äº† `AutoCloseable` æ¥å£ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åœ¨ `try-with-resources` ä¸­ä½¿ç”¨

ä»¥ä¸‹æ˜¯ä½¿ç”¨ `try-with-resources` çš„ç¤ºä¾‹ï¼š

```java
import java.io.*;

public class TryWithResourcesExample {
    public static void main(String[] args) {
        // ä½¿ç”¨ try-with-resources æ¥è‡ªåŠ¨å…³é—­èµ„æº
        try (FileReader fileReader = new FileReader("example.txt");
             BufferedReader bufferedReader = new BufferedReader(fileReader)) {

            // è¯»å–æ–‡ä»¶å†…å®¹
            String line;
            while ((line = bufferedReader.readLine()) != null) {
                System.out.println(line);
            }

        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```





## Javaåå°„æœºåˆ¶ä¸ä»£ç†æ¨¡å¼

### åå°„

åå°„æ˜¯åœ¨ç¨‹åº**è¿è¡Œ**æ—¶æ£€æŸ¥ã€è®¿é—®å’Œä¿®æ”¹ç±»ã€æ–¹æ³•ã€å±æ€§ç­‰ä¿¡æ¯ã€‚é€šè¿‡åå°„ï¼Œä½ å¯ä»¥**åœ¨è¿è¡Œæ—¶è·å–ç±»å¯¹è±¡çš„å®ä¾‹ã€æ–¹æ³•å’Œå±æ€§ï¼Œè€Œä¸éœ€è¦åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šè¿™äº›ä¿¡æ¯**

ä¸ºäº†è·å–ä¸€ä¸ªç±»çš„æ–¹æ³•ã€æ–¹æ³•å‚æ•°ã€å±æ€§ç­‰ä¿¡æ¯ï¼Œé¦–å…ˆéœ€è·å–è¯¥ç±»çš„classå¯¹è±¡ï¼ŒJavaæä¾›äº†å››ç§æ–¹å¼è·å– `Class` å¯¹è±¡:

å‡è®¾éœ€è¦è·å–çš„ç›®æ ‡ç±»ä¸ºä¸‹ï¼š

```java
public class TargetObject {
    private String value;
    public TargetObject() {
        value = "JavaGuide";
    }
    public void publicMethod(String s ,Integer times) {
        System.out.println("I hate" + s+" "+times+" æ¬¡");
    }
    
    private void privateMethod() {
        System.out.println("value is " + value);
    }
    private void privateMethod2() {
        System.out.println("ç¬¬äºŒä¸ªç§æœ‰æ–¹æ³•");
    }
}
```





**1. çŸ¥é“å…·ä½“ç±»çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ï¼š**

```java
Class alunbarClass = TargetObject.class;
```

ä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä¸çŸ¥é“å…·ä½“ç±»çš„ï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡**éå†åŒ…ä¸‹é¢çš„ç±»æ¥è·å– Class å¯¹è±¡**ï¼Œé€šè¿‡æ­¤æ–¹å¼è·å– Class å¯¹è±¡ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–

**2. é€šè¿‡ `Class.forName()`ä¼ å…¥ç±»çš„å…¨è·¯å¾„è·å–ï¼š**

```java
Class alunbarClass1 = Class.forName("cn.javaguide.TargetObject");
```

**3. é€šè¿‡å¯¹è±¡å®ä¾‹`instance.getClass()`è·å–(ä¼šåˆå§‹åŒ–)ï¼š**

```java
TargetObject o = new TargetObject();
Class alunbarClass2 = o.getClass();
```

**4. é€šè¿‡ç±»åŠ è½½å™¨`xxxClassLoader.loadClass()`ä¼ å…¥ç±»è·¯å¾„è·å–:**

```java
ClassLoader.getSystemClassLoader().loadClass("cn.javaguide.TargetObject");
```

é€šè¿‡ç±»åŠ è½½å™¨è·å– Class å¯¹è±¡ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œæ„å‘³ç€ä¸è¿›è¡ŒåŒ…æ‹¬åˆå§‹åŒ–ç­‰ä¸€ç³»åˆ—æ­¥éª¤ï¼Œé™æ€ä»£ç å—å’Œé™æ€å¯¹è±¡ä¸ä¼šå¾—åˆ°æ‰§è¡Œ



åå°„è°ƒç”¨åŸç±»çš„`public/private`æ–¹æ³•ï¼š

```java
class TestReflect {
//åå°„è·å–æŸä¸ªç±»çš„æ‰€ä»¥æ–¹æ³•+å±æ€§
public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
    //å·²çŸ¥å¯¹åº”ç±»çš„æƒ…å†µä¸‹(åˆå§‹åŒ–å¯¹è±¡)ï¼š
    TargetObject targetObject = new TargetObject();
    Class alunbarClass2 = targetObject.getClass();
    
    //æœªçŸ¥å¯¹åº”ç±»çš„æƒ…å†µä¸‹ï¼ˆä¸åšåˆå§‹åŒ–ï¼‰ï¼š
    Class<?> targetClass = Class.forName("cn.javaguide.TargetObject"); 
    //å£°æ˜ä¸€ä¸ªå¯ä»¥æ˜¯ä»»ä½•typesçš„Classå¯¹è±¡(?æ˜¯é€šé…ç¬¦)
    TargetObject targetObject = (TargetObject) targetClass.newInstance();

    
    Method[] methods = alunbarClass2.getDeclaredMethods(); //åå°„è·å–ç±»çš„æ‰€æœ‰æ–¹æ³•
    for (Method method : methods) {
        System.out.println(method.getName());
    }
    //è·å–ç§æœ‰æ–¹æ³•å¹¶è°ƒç”¨
    Method privateMethod2= alunbarClass2.getDeclaredMethod("privateMethod2");//è¯¥å‡½æ•°æ— å…¥å‚ 
    privateMethod2.setAccessible(true); //è®¾ç½®ç§æœ‰æ–¹æ³•çš„è®¿é—®æƒé™
    privateMethod2.invoke(targetObject); //privateMethod2æ— å½¢å‚

    //è·å–å…¬æœ‰æ–¹æ³•å¹¶è°ƒç”¨
    Method publicMethod = alunbarClass2.getDeclaredMethod("publicMethod",
            String.class,Integer.class); //ä¼ å…¥æ‰€è¦è°ƒç”¨çš„æ–¹æ³•åï¼Œä»¥åŠè¯¥æ–¹æ³•æ‰€éœ€è¦çš„å‚æ•°ç±»å‹
    publicMethod.invoke(targetObject,"harry",50); //ä¼ å…¥å®å‚,ç¬¬ä¸€ä¸ªå‚æ•°ä¸€å®šæ˜¯å¯¹åº”ç±»çš„å®ä¾‹
}
}
```

æ§åˆ¶å°è¾“å‡ºä¸ºï¼š

```java
//è·å–åˆ°çš„ç±»ä¸­æ‰€æœ‰æ–¹æ³•
privateMethod2
publicMethod
privateMethod
    
//invoke()è°ƒç”¨è¢«ä»£ç†ç±»ä¸­çš„privateMethod2()æ–¹æ³•
ç¬¬äºŒä¸ªç§æœ‰æ–¹æ³•

//invoke()è°ƒç”¨è¢«ä»£ç†ç±»ä¸­çš„publicMethod()æ–¹æ³•
I hateharry 50 æ¬¡
```



åå°„çš„ç¼ºç‚¹ä¸»è¦æœ‰ä¸¤ä¸ª:

- **ç ´åå°è£…**ï¼šç”±äº**åå°„å…è®¸è®¿é—®ç§æœ‰å­—æ®µå’Œç§æœ‰æ–¹æ³•**ï¼Œæ‰€ä»¥å¯èƒ½ä¼šç ´åå°è£…è€Œå¯¼è‡´å®‰å…¨é—®é¢˜ã€‚
- **æ€§èƒ½å¼€é”€**ï¼šç”±äºåå°„æ¶‰åŠåˆ°åŠ¨æ€è§£æï¼Œå› æ­¤æ— æ³•æ‰§è¡Œ Java è™šæ‹Ÿæœºä¼˜åŒ–ï¼Œå†åŠ ä¸Šåå°„çš„å†™æ³•çš„ç¡®è¦å¤æ‚å¾—å¤šï¼Œæ‰€ä»¥æ€§èƒ½è¦æ¯”â€œæ­£å°„â€å·®å¾ˆå¤šï¼Œåœ¨ä¸€äº›æ€§èƒ½æ•æ„Ÿçš„ç¨‹åºä¸­åº”è¯¥é¿å…ä½¿ç”¨åå°„ã€‚





åå°„çš„ä¸»è¦åº”ç”¨åœºæ™¯æœ‰ï¼š

- **å¼€å‘é€šç”¨æ¡†æ¶**ï¼šåƒ`Spring`ä¸ºäº†ä¿æŒé€šç”¨æ€§ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶æ¥åŠ è½½ä¸åŒçš„å¯¹è±¡ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚
- **åŠ¨æ€ä»£ç†**ï¼šåœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹ä¸­ï¼Œéœ€è¦æ‹¦æˆªç‰¹å®šçš„æ–¹æ³•ï¼Œå°±ä¼šé€‰æ‹©åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œè€ŒåŠ¨æ€ä»£ç†çš„åº•å±‚æŠ€æœ¯å°±æ˜¯åå°„ã€‚
- **æ³¨è§£**ï¼šæ³¨è§£æœ¬èº«åªæ˜¯èµ·åˆ°ä¸€ä¸ªæ ‡è®°ç¬¦çš„ä½œç”¨ï¼Œå®ƒéœ€è¦åˆ©ç”¨åå°„æœºåˆ¶ï¼Œæ ¹æ®æ ‡è®°ç¬¦å»æ‰§è¡Œç‰¹å®šçš„è¡Œä¸º,ä¾‹å¦‚RPCæ¡†æ¶ä¸­çš„`@ScanServices`æ³¨è§£ï¼š  

```java
Set<Class<?>> classSet = ReflectUtil.getClasses(basePackage);
        for(Class<?> clazz : classSet) {
            if(clazz.isAnnotationPresent(Service.class)) {
                //åœ¨æŸä¸ªç±»ä¸Šæ ‡æ³¨äº† @Service æ³¨è§£ï¼Œå¹¶è®¾ç½®äº† name å±æ€§å€¼ï¼Œ
      //å¯ä»¥ä½¿ç”¨ class.getAnnotation(Service.class).name() æ¥è·å–è¯¥å±æ€§çš„å€¼
      //è¯¥nameçš„å€¼å°±æ˜¯Nacosæ³¨å†Œä¸­å¿ƒé‡Œçš„æœåŠ¡å
      String serviceName = clazz.getAnnotation(Service.class).name();
                Object obj;
                try {
                    obj = clazz.newInstance();
                } catch (InstantiationException | IllegalAccessException e) {
                    logger.error("åˆ›å»º " + clazz + " æ—¶æœ‰é”™è¯¯å‘ç”Ÿ");
                    continue;
                }
                if("".equals(serviceName)) {
                    Class<?>[] interfaces = clazz.getInterfaces();
                    for (Class<?> oneInterface: interfaces){
              publishService(obj, oneInterface.getCanonicalName());
                    }
                } else {
             publishService(obj, serviceName); //æŠŠæ‰«æåˆ°çš„æœåŠ¡æ³¨å†Œåˆ°Nacos
                }
            }
        }
```



åå°„çš„ä¼˜ç‚¹å†æ€»ç»“ä¸€ä¸‹ï¼š

1. è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥å’ŒåŠ¨æ€åŠ è½½ï¼šé€šè¿‡åå°„ï¼Œå¯ä»¥**åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–å’ŒåŠ è½½ç±»ï¼Œè€Œä¸éœ€è¦åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šç±»çš„ä¿¡æ¯ã€‚è¿™å¯¹äºä¸€äº›æ¡†æ¶ã€åº“å’Œæ’ä»¶ç³»ç»Ÿéå¸¸æœ‰ç”¨ï¼Œå¯ä»¥æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ è½½ä¸åŒçš„ç±»**ã€‚
2. åŠ¨æ€åˆ›å»ºå¯¹è±¡ï¼šåå°„**å…è®¸åœ¨è¿è¡Œæ—¶åˆ›å»ºå¯¹è±¡çš„å®ä¾‹ï¼Œå³ä½¿åœ¨ç¼–è¯‘æ—¶æ²¡æœ‰æ˜ç¡®çŸ¥é“ç±»çš„åç§°**ã€‚è¿™åœ¨ä¸€äº›é€šç”¨çš„ä»£ç å’Œå·¥å…·ä¸­å¾ˆæœ‰ç”¨ã€‚
3. åŠ¨æ€è°ƒç”¨æ–¹æ³•ï¼šé€šè¿‡åå°„ï¼Œå¯ä»¥**åœ¨è¿è¡Œæ—¶è°ƒç”¨ç±»çš„æ–¹æ³•ï¼Œè€Œä¸éœ€è¦æå‰çŸ¥é“ç±»çš„ç»“æ„**ã€‚è¿™æ ·å¯ä»¥å®ç°çµæ´»çš„è°ƒç”¨æœºåˆ¶ï¼Œä¾‹å¦‚æ ¹æ®é…ç½®æ–‡ä»¶æ¥å†³å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•ã€‚
4. åŠ¨æ€è®¿é—®å’Œä¿®æ”¹å±æ€§ï¼šé€šè¿‡åå°„ï¼Œå¯ä»¥**åœ¨è¿è¡Œæ—¶è·å–å’Œä¿®æ”¹ç±»çš„å­—æ®µï¼ˆå±æ€§ï¼‰å€¼ï¼Œè€Œä¸éœ€è¦ä¾èµ–ç¼–è¯‘æ—¶çš„ç¡¬ç¼–ç **



å…¶å®å°±æ˜¯å¯ä»¥åœ¨è¿è¡ŒæœŸæ—¶é€šè¿‡æ“ä½œå­—èŠ‚ç æ–‡ä»¶æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰é€»è¾‘





### JDKåŠ¨æ€ä»£ç†



ç†è§£åŠ¨æ€ä»£ç†ä¹‹å‰ï¼Œå…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯é™æ€ä»£ç†ï¼Ÿ

é™æ€ä»£ç†æ˜¯æŒ‡**åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šä»£ç†ç±»çš„ä»£ç **ï¼Œå¹¶ä¸”ä»£ç†ç±»å’Œè¢«ä»£ç†ç±»çš„å…³ç³»åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šã€‚**ä»£ç†ç±»å’Œè¢«ä»£ç†ç±»é€šå¸¸éƒ½è¦å®ç°åŒä¸€ä¸ªæ¥å£æˆ–è€…ç»§æ‰¿åŒä¸€ä¸ªçˆ¶ç±»**ã€‚åœ¨é™æ€ä»£ç†ä¸­ï¼Œä»£ç†ç±»æ˜¯ç”±ç¨‹åºå‘˜ç¼–å†™çš„ï¼Œæ‰‹åŠ¨å®ç°äº†æ¥å£æˆ–è€…ç»§æ‰¿äº†çˆ¶ç±»ï¼Œå¹¶åœ¨ä»£ç†ç±»ä¸­è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•ã€‚

å‡è®¾æœ‰ä¸€ä¸ª `UserService` æ¥å£ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªæ–¹æ³• `getUserById(int userId)`ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è°ƒç”¨è¯¥æ–¹æ³•å‰åè¿›è¡Œä¸€äº›æ“ä½œï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨é™æ€ä»£ç†å®ç°è¯¥åŠŸèƒ½çš„ä»£ç ï¼š

```java
public interface UserService {
    User getUserById(int userId);
}

public class UserServiceImpl implements UserService {
    public User getUserById(int userId) {
        // å®ç°è·å–ç”¨æˆ·ä¿¡æ¯çš„é€»è¾‘
    }
}

public class UserServiceProxy implements UserService {

    // ç›®æ ‡å¯¹è±¡
    private UserService target;

    // æ„é€ å‡½æ•°ï¼Œä¼ å…¥ç›®æ ‡å¯¹è±¡
    public UserServiceProxy(UserService target) {
        this.target = target;
    }

    // é‡å†™ getUserById æ–¹æ³•ï¼Œåœ¨æ–¹æ³•è°ƒç”¨å‰åè¿›è¡Œä¸€äº›æ“ä½œ
    public User getUserById(int userId) {
        
        System.out.println("è°ƒç”¨æ–¹æ³•å‰ï¼Œæ‰“å°æ—¥å¿—...");  
        //è¿™é‡Œçš„targetå®é™…ä¸Šæ˜¯UserServiceçš„å®ç°ç±»å¯¹è±¡UserServiceImpl     
        User result = target.getUserById(userId);
        System.out.println("è°ƒç”¨æ–¹æ³•åï¼Œæ‰“å°æ—¥å¿—...");
        
        return result;
    }
}
```

ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¥æµ‹è¯•è¯¥é™æ€ä»£ç†ç±»ï¼š

```java
public class Test {
    public static void main(String[] args) {
        UserService userService = new UserServiceImpl();
        UserService proxy = new UserServiceProxy(userService);//é™æ€ä»£ç†æ ¸å¿ƒ
        User user = proxy.getUserById(1); //è°ƒç”¨
    }
}
```

ä¸Šè¿°æµ‹è¯•ä»£ç ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç›®æ ‡å¯¹è±¡ `userService`ï¼Œç„¶åå°†å…¶ä¼ å…¥ `UserServiceProxy` ä¸­ï¼Œè·å–ä»£ç†å¯¹è±¡ `proxy`ã€‚å½“è°ƒç”¨ `proxy.getUserById(1)` æ–¹æ³•æ—¶ï¼Œ`UserServiceProxy` ä¸­çš„ `getUserById` æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œåœ¨æ–¹æ³•è°ƒç”¨å‰åæ‰“å°æ—¥å¿—ï¼Œå¹¶è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ `getUserById` æ–¹æ³•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å®ç°äº†å¯¹ç›®æ ‡å¯¹è±¡æ–¹æ³•çš„é™æ€ä»£ç†ï¼Œå¹¶åœ¨æ–¹æ³•è°ƒç”¨å‰åè¿›è¡Œäº†ä¸€äº›æ“ä½œã€‚





>  **åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†çš„åŒºåˆ«**
>
> 
>
> é™æ€ä»£ç†çš„ä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡åœ¨ä»£ç†ä¹‹å‰å°±å·²ç»ç¡®å®šï¼Œå®ƒä»¬éƒ½**å®ç°ç›¸åŒçš„æ¥å£æˆ–ç»§æ‰¿ç›¸åŒçš„æŠ½è±¡ç±»**ã€‚é™æ€ä»£ç†æ¨¡å¼ä¸€èˆ¬ç”±ä¸šåŠ¡å®ç°ç±»å’Œä¸šåŠ¡ä»£ç†ç±»ç»„æˆï¼Œä¸šåŠ¡å®ç°ç±»é‡Œé¢å®ç°ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡ä»£ç†ç±»è´Ÿè´£åœ¨ä¸šåŠ¡æ–¹æ³•è°ƒç”¨çš„å‰åä½œä¸€äº›ä½ éœ€è¦çš„å¤„ç†ï¼Œä»¥å®ç°ä¸šåŠ¡é€»è¾‘ä¸ä¸šåŠ¡æ–¹æ³•å¤–çš„åŠŸèƒ½è§£è€¦ï¼Œå‡å°‘äº†å¯¹ä¸šåŠ¡æ–¹æ³•çš„å…¥ä¾µã€‚é™æ€ä»£ç†åˆå¯ç»†åˆ†ä¸ºï¼šåŸºäºç»§æ‰¿çš„æ–¹å¼å’ŒåŸºäºèšåˆçš„æ–¹å¼å®ç°
>
> 
>
> é™æ€ä»£ç†æ¨¡å¼çš„ä»£ç†ç±»ï¼Œåªæ˜¯å®ç°äº†ç‰¹å®šç±»çš„ä»£ç†ï¼Œä»£ç†ç±»å¯¹è±¡çš„æ–¹æ³•è¶Šå¤šï¼Œä½ å°±å¾—å†™è¶Šå¤šçš„é‡å¤çš„ä»£ç ã€‚åŠ¨æ€ä»£ç†å°±å¯ä»¥åŠ¨æ€çš„ç”Ÿæˆä»£ç†ç±»ï¼Œå®ç°å¯¹ä¸åŒç±»ä¸‹çš„ä¸åŒæ–¹æ³•çš„ä»£ç†ã€‚
>
> JDK åŠ¨æ€ä»£ç†æ˜¯åˆ©ç”¨åå°„æœºåˆ¶ç”Ÿæˆä¸€ä¸ªå®ç°ä»£ç†æ¥å£çš„åŒ¿åç±»ï¼Œåœ¨è°ƒç”¨ä¸šåŠ¡æ–¹æ³•å‰è°ƒç”¨`InvocationHandler` å¤„ç†ã€‚ä»£ç†ç±»å¿…é¡»å®ç° `InvocationHandler` æ¥å£ï¼Œå¹¶ä¸”ï¼ŒJDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»



















**åŠ¨æ€ä»£ç†ï¼š**

åŠ¨æ€ä»£ç†é€šä¿—ç‚¹è¯´å°±æ˜¯ï¼š**æ— éœ€å£°æ˜å¼çš„åˆ›å»ºjavaä»£ç†ç±»**ï¼Œè€Œæ˜¯**åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆ"è™šæ‹Ÿ"çš„ä»£ç†ç±»**ï¼Œè¢«`ClassLoader`åŠ è½½ã€‚ä»è€Œé¿å…äº†é™æ€ä»£ç†é‚£æ ·éœ€è¦å£°æ˜å¤§é‡çš„ä»£ç†ç±»

**åœ¨ Java åŠ¨æ€ä»£ç†æœºåˆ¶ä¸­ `InvocationHandler` æ¥å£å’Œ `Proxy` ç±»æ˜¯æ ¸å¿ƒ**

`Proxy` ç±»ä¸­ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„æ–¹æ³•æ˜¯ï¼š`newProxyInstance()` ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨æ¥ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡(åœ¨javaç¨‹åºè¿è¡ŒæœŸç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡å¯ä»¥æ‹¦æˆªå¹¶è½¬å‘å¯¹è¢«ä»£ç†ç±»å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨)

```java
 public static Object newProxyInstance(ClassLoader loader,
                                          Class<?>[] interfaces,
                                          InvocationHandler h)
     throws IllegalArgumentException
 {
     ............
 }
```

è¿™ä¸ªæ–¹æ³•ä¸€å…±æœ‰ 3 ä¸ªå‚æ•°ï¼š

1. **loader** :ç›®æ ‡å¯¹è±¡çš„ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½ä»£ç†å¯¹è±¡ã€‚
2. **interfaces** : `è¢«ä»£ç†ç±»`å®ç°çš„ä¸€äº›æ¥å£ï¼›
3. **h** : å®ç°äº† `InvocationHandler` æ¥å£çš„å¯¹è±¡ï¼›

è¦å®ç°åŠ¨æ€ä»£ç†çš„è¯ï¼Œè¿˜å¿…é¡»éœ€è¦å®ç°`InvocationHandler` æ¥è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚å½“æˆ‘ä»¬çš„åŠ¨æ€ä»£ç†å¯¹è±¡è°ƒç”¨è¢«ä»£ç†ç±»ä¸­çš„æ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨å°±ä¼šè¢«è½¬å‘åˆ°å®ç°`InvocationHandler` æ¥å£ç±»ä¸­çš„ `invoke` æ–¹æ³•æ¥è°ƒç”¨

```java
public interface InvocationHandler {

    /**
     * å½“ä½ ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•çš„æ—¶å€™å®é™…ä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•
     */
    public Object invoke(Object proxy, Method method, Object[] args)
        throws Throwable;
}
```

`invoke()` æ–¹æ³•æœ‰ä¸‹é¢ä¸‰ä¸ªå‚æ•°ï¼š

1. **proxy** :åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¯¹è±¡ï¼ˆçœ‹ä¸åˆ°ï¼‰
2. **method** : ä¸ä»£ç†ç±»å¯¹è±¡è°ƒç”¨çš„æ–¹æ³•ç›¸å¯¹åº”
3. **args** : å½“å‰ method æ–¹æ³•çš„å‚æ•°

ä¹Ÿå°±æ˜¯è¯´ï¼š**ä½ é€šè¿‡`Proxy` ç±»çš„ `newProxyInstance()` åˆ›å»ºçš„ä»£ç†å¯¹è±¡åœ¨è°ƒç”¨è¢«ä»£ç†ç±»ä¸­çš„(ä»»ä½•)æ–¹æ³•æ—¶ï¼Œå®é™…ä¼šè°ƒç”¨åˆ°å®ç°`InvocationHandler` æ¥å£çš„ç±»çš„ `invoke()`æ–¹æ³•ã€‚** ä½ å¯ä»¥åœ¨ `invoke()` æ–¹æ³•ä¸­è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ååšä»€ä¹ˆäº‹æƒ…,ä¾‹å¦‚ï¼š

```java
public class DebugInvocationHandler implements InvocationHandler {
    
    public DebugInvocationHandler(Object target) {
        this.target = target;
    }
  
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws InvocationTargetException, IllegalAccessException {
        //è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method " + method.getName());
        Object result = method.invoke(target, args); //é€šè¿‡åå°„å®é™…è°ƒç”¨åŸæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¯¹åº”ç±»çš„å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè°ƒç”¨æ–¹æ³•æ‰€éœ€è¦çš„å…¥å‚
        //è°ƒç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method " + method.getName());
        return result;
    }
}
```



**å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š**

é¦–å…ˆæ˜¯æ¥å£ç±»:

```java

public interface FoodService {
    public void makeNoodle();
    public void makeChicken();
}

//ä»£ç†ç±»ï¼Œå®ç°å®šä¹‰çš„æ¥å£
public class FoodServiceImpl implements FoodService {
    @Override
    public void makeNoodle() {
        System.out.println("make noodle");
    }

    @Override
    public void makeChicken() {
        System.out.println("make Chicken");
    }
}
```

å…¶æ¬¡æ˜¯å®ç°äº†`InvocationHandler`çš„å¤„ç†ç±»ï¼š

```java
public class JDKProxyFactory implements InvocationHandler {
    private Object target;

    public JDKProxyFactory(Object target) {
        super();
        this.target = target;
    }

    // åˆ›å»ºæœ€ç»ˆç”Ÿæˆçš„ä»£ç†å¯¹è±¡
    public Object createProxy() {
        // 1.å¾—åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»åŠ è½½å™¨
        ClassLoader classLoader = target.getClass().getClassLoader();
        // 2.å¾—åˆ°ç›®æ ‡å¯¹è±¡çš„å®ç°æ¥å£
        Class<?>[] interfaces = target.getClass().getInterfaces();
        // 3.ç¬¬ä¸‰ä¸ªå‚æ•°éœ€è¦ä¸€ä¸ªå®ç°invocationHandleræ¥å£çš„å¯¹è±¡
        Object newProxyInstance = Proxy.newProxyInstance(classLoader, interfaces, this);//ç”Ÿæˆä»£ç†å¯¹è±¡
        return newProxyInstance;
    }


    // ç¬¬ä¸€ä¸ªå‚æ•°:ä»£ç†å¯¹è±¡.ä¸€èˆ¬ä¸ä½¿ç”¨;ç¬¬äºŒä¸ªå‚æ•°:éœ€è¦å¢å¼ºçš„æ–¹æ³•;ç¬¬ä¸‰ä¸ªå‚æ•°:æ–¹æ³•ä¸­çš„å‚æ•°
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("è¿™æ˜¯å¢å¼ºæ–¹æ³•å‰......");
        Object invoke = method.invoke(target, args);//é€šè¿‡åå°„å®é™…è°ƒç”¨åŸæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå¯¹åº”ç±»çš„å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè°ƒç”¨æ–¹æ³•æ‰€éœ€è¦çš„å…¥å‚
        System.out.println("è¿™æ˜¯å¢å¼ºæ–¹æ³•å......");
        return invoke;
    }

    public static void main(String[] args) {
        // 1.åˆ›å»ºå¯¹è±¡
        FoodServiceImpl foodService = new FoodServiceImpl();
        // 2.åˆ›å»ºä»£ç†å¯¹è±¡
        JDKProxyFactory proxy = new JDKProxyFactory(foodService); //ä¼ å…¥è¢«ä»£ç†ç±»å¯¹è±¡
        // 3.è°ƒç”¨ä»£ç†å¯¹è±¡çš„å¢å¼ºæ–¹æ³•,å¾—åˆ°å¢å¼ºåçš„å¯¹è±¡
        FoodService createProxy = (FoodService) proxy.createProxy();
        createProxy.makeChicken();//æ‰§è¡Œè¢«ä»£ç†ç±»ä¸­çš„ä»»ä½•æ–¹æ³•æ—¶ï¼Œä¼šè‡ªåŠ¨èµ°invoke()
    }

}
```

è®°ä½ä»¥ä¸‹å‡ ä¸ªè¦ç‚¹ï¼š

1. `Proxy.newInstance(ClassLoader loader,Class<?>[] interfaces, InvocationHandler h)`è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¹¶ç”±æ­¤ä»£ç†å¯¹è±¡è°ƒç”¨è¢«ä»£ç†ç±»çš„æ–¹æ³•;

>loader: ç”¨å“ªä¸ªç±»åŠ è½½å™¨å»åŠ è½½ä»£ç†å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯è·å–è¢«ä»£ç†ç±»(è¯¥ç±»å¿…é¡»å®ç°æ¥å£)çš„ç±»åŠ è½½å™¨
>
>interfaces:è¢«ä»£ç†ç±»æ‰€å®ç°çš„æ¥å£
>
>h:åŠ¨æ€ä»£ç†æ–¹æ³•åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨hé‡Œé¢çš„invokeæ–¹æ³•å»æ‰§è¡Œ

2. å¯¹äº`public Object invoke(Object proxy, Method method, Object[] args)`æ–¹æ³•ï¼Œå…¶ä¸­proxyä¸ºä»£ç†è¿‡ä¹‹åçš„å¯¹è±¡(å¹¶ä¸æ˜¯åŸå¯¹è±¡)ï¼Œ`method`ä¸ºè¢«ä»£ç†çš„æ–¹æ³•ï¼Œ`args`ä¸ºæ–¹æ³•çš„å‚æ•°





å¦‚æœè¿˜æ˜¯ä¸æ˜ç™½çš„è¯å†ç»™ä¸€ä¸ª`ChatGPT`çš„ä¾‹å­ï¼š

ä½¿ç”¨Javaä¸­çš„åŠ¨æ€ä»£ç†æ—¶ï¼ŒJDKæä¾›äº†ä¸€ä¸ª`java.lang.reflect.Proxy`ç±»æ¥å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆä»£ç†å¯¹è±¡ã€‚åŠ¨æ€ä»£ç†å…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡å¯ä»¥æ‹¦æˆªå¹¶è½¬å‘å¯¹ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ã€‚ä¸‹é¢æ˜¯JDKè‡ªå¸¦çš„åŠ¨æ€ä»£ç†çš„åŸºæœ¬æµç¨‹ï¼š



1ã€å®šä¹‰æ¥å£ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œå®ƒåŒ…å«äº†æˆ‘ä»¬æƒ³è¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡æ‰€å…·æœ‰çš„æ–¹æ³•

```java
public interface Subject {
    void doSomething();
}
```



2ã€å®ç°ç›®æ ‡å¯¹è±¡ï¼šæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç°è¿™ä¸ªæ¥å£ï¼Œåˆ›å»ºä¸€ä¸ª**ç›®æ ‡å¯¹è±¡**(æœ€ç»ˆè¢«ä»£ç†çš„ç±»å¯¹è±¡)ï¼Œå³å®é™…æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„å¯¹è±¡

```java
public class RealSubject implements Subject {
    @Override
    public void doSomething() {
        System.out.println("RealSubject is doing something.");
    }
}
```



3ã€ç¼–å†™ `InvocationHandler`ï¼šæ¥ä¸‹æ¥ï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ªå®ç°äº†`java.lang.reflect.InvocationHandler`æ¥å£çš„ä»£ç†å¤„ç†å™¨ç±»ã€‚è¯¥æ¥å£ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•`invoke(Object proxy, Method method, Object[] args)`ï¼Œ**å½“æœ€ç»ˆç”Ÿæˆçš„ä»£ç†å¯¹è±¡å»è°ƒç”¨è¢«ä»£ç†ç±»æ‰€å®ç°çš„æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥`invoke()`æ–¹æ³•**ï¼š

```java
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;

public class MyInvocationHandler implements InvocationHandler {
    private Object target;

    public MyInvocationHandler(Object target) {
        this.target = target;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // åœ¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•æ‰§è¡Œå‰è¿›è¡Œä¸€äº›æ“ä½œï¼ˆè¿™é‡Œå¯ä»¥åŠ å…¥åˆ‡é¢é€»è¾‘ï¼‰
        System.out.println("Before method execution.");

        // è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
        Object result = method.invoke(target, args);

        // åœ¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•æ‰§è¡Œåè¿›è¡Œä¸€äº›æ“ä½œï¼ˆè¿™é‡Œå¯ä»¥åŠ å…¥åˆ‡é¢é€»è¾‘ï¼‰
        System.out.println("After method execution.");

        // è¿”å›æ–¹æ³•çš„æ‰§è¡Œç»“æœ
        return result;
    }
}
```

> `invoke()`æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š
>
> 1. `Object proxy`ï¼šä»£ç†å¯¹è±¡ã€‚åœ¨`invoke()`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`proxy`å‚æ•°æ¥è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸‹ï¼Œé€šå¸¸å¾ˆå°‘ä¼šç”¨åˆ°è¯¥å‚æ•°ã€‚
> 2. `Method method`ï¼šè¢«ä»£ç†æ–¹æ³•çš„`Method`å¯¹è±¡ã€‚`Method`å¯¹è±¡è¡¨ç¤ºäº†è¢«ä»£ç†æ–¹æ³•çš„ä¿¡æ¯ï¼Œå¦‚æ–¹æ³•åã€å‚æ•°ç±»å‹ç­‰ã€‚é€šè¿‡`method`å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`invoke()`æ–¹æ³•ä¸­è·å–å’Œè°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚
> 3. `Object[] args`ï¼šæ–¹æ³•çš„å‚æ•°æ•°ç»„ã€‚`args`å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼ŒåŒ…å«äº†è°ƒç”¨è¢«ä»£ç†æ–¹æ³•æ—¶ä¼ é€’çš„å‚æ•°ã€‚åœ¨`invoke()`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦è·å–å’Œæ“ä½œè¿™äº›å‚æ•°ã€‚





---------

å‚æ•°`proxy`æ˜¯ä»€ä¹ˆï¼Ÿ

`proxy`å‚æ•°æ˜¯åŠ¨æ€ä»£ç†å¯¹è±¡çš„å¼•ç”¨ã€‚å®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œä»£è¡¨äº†ä»£ç†ç±»çš„å®ä¾‹ã€‚é€šè¿‡è¿™ä¸ª`proxy`å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`invoke()`æ–¹æ³•ä¸­è°ƒç”¨ä»£ç†å¯¹è±¡è‡ªå·±çš„æ–¹æ³•ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¾ˆå°‘ç›´æ¥è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡`proxy`æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚



è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ`proxy`å¯¹è±¡æ˜¯ä¸€ä¸ªåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„å®ä¾‹ï¼Œå®ƒå®ç°äº†æˆ‘ä»¬åœ¨`Proxy.newProxyInstance()`æ–¹æ³•çš„`interfaces`å‚æ•°ä¸­æŒ‡å®šçš„æ¥å£åˆ—è¡¨ã€‚å› æ­¤ï¼Œ`proxy`å¯¹è±¡å¯ä»¥å¼ºåˆ¶è½¬æ¢ä¸ºä»»ä½•åœ¨`interfaces`ä¸­æŒ‡å®šçš„æ¥å£ç±»å‹ã€‚



ä¾‹å¦‚ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨`Proxy.newProxyInstance()`æ–¹æ³•ä¸­æŒ‡å®šäº†ç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£`Subject`ï¼Œæ‰€ä»¥ä»£ç†å¯¹è±¡`proxySubject`å®é™…ä¸Šæ˜¯`Subject`æ¥å£ç±»å‹çš„ä¸€ä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è½¬æ¢ä¸º`Subject`æ¥å£ç±»å‹ï¼Œç„¶åè°ƒç”¨`Subject`æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•

```java
Subject proxySubject = (Subject) Proxy.newProxyInstance(
        realSubject.getClass().getClassLoader(),
        realSubject.getClass().getInterfaces(),
        handler
);

// è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨ä»£ç†å¤„ç†å™¨çš„ invoke() æ–¹æ³•
proxySubject.doSomething(); // è¿™é‡Œè°ƒç”¨çš„æ˜¯ Subject æ¥å£ä¸­çš„ doSomething() æ–¹æ³•
```







-----------------

4ã€åˆ›å»ºä»£ç†å¯¹è±¡ï¼šåœ¨ä¸»ç¨‹åºä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨`Proxy.newProxyInstance(ClassLoader loader, Class<?>[] interfaces, InvocationHandler h)`æ–¹æ³•æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚è¿™ä¸ªæ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š

- `ClassLoader loader`ï¼šç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½æ‰€è¦ä»£ç†çš„ç±»
- `Class<?>[] interfaces`ï¼šç›®æ ‡å¯¹è±¡å®ç°çš„æ¥å£åˆ—è¡¨(è¿™é‡Œæ˜¯æ¥å£`Subject`)
- `InvocationHandler h`ï¼šä»£ç†å¤„ç†å™¨å¯¹è±¡

```java
import java.lang.reflect.Proxy;

public class Main {
    public static void main(String[] args) {
        RealSubject realSubject = new RealSubject();  //è¢«ä»£ç†çš„ç±»å¯¹è±¡

        // åˆ›å»ºä»£ç†å¤„ç†å™¨å¯¹è±¡
        MyInvocationHandler handler = new MyInvocationHandler(realSubject);

        // åˆ›å»ºä»£ç†å¯¹è±¡
        Subject proxySubject = (Subject) Proxy.newProxyInstance(
                realSubject.getClass().getClassLoader(),
                realSubject.getClass().getInterfaces(),
                handler
        );

        // è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨ä»£ç†å¤„ç†å™¨çš„ invoke() æ–¹æ³•
        proxySubject.doSomething();
    }
}

```





> æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆJDKåŠ¨æ€ä»£ç†è¦æ±‚è¢«ä»£ç†ç±»å¿…é¡»å®ç°æ¥å£å‘¢ï¼Ÿ

è¦æ‰©å±•ä¸€ä¸ªç±»æœ‰å¸¸è§çš„ä¸¤ç§æ–¹å¼ï¼Œç»§æ‰¿çˆ¶ç±»æˆ–å®ç°æ¥å£ã€‚è¿™ä¸¤ç§æ–¹å¼éƒ½å…è®¸æˆ‘ä»¬å¯¹æ–¹æ³•çš„é€»è¾‘è¿›è¡Œå¢å¼ºï¼Œä½†ç°åœ¨ä¸æ˜¯ç”±æˆ‘ä»¬è‡ªå·±æ¥é‡å†™æ–¹æ³•ï¼Œè€Œæ˜¯è¦æƒ³åŠæ³•è®©jvmå»è°ƒç”¨`InvocationHandler`ä¸­çš„`invoke`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ä»£ç†ç±»éœ€è¦å’Œä¸¤ä¸ªä¸œè¥¿å…³è”åœ¨ä¸€èµ·ï¼š

- è¢«ä»£ç†ç±»
- InvocationHandler

è€Œ`jdk`å¤„ç†è¿™ä¸ªé—®é¢˜çš„æ–¹å¼æ˜¯é€‰æ‹©ä»£ç†ç±»ç»§æ‰¿çˆ¶ç±»`Proxy`ï¼Œå¹¶æŠŠ`InvocationHandler`å­˜åœ¨çˆ¶ç±»çš„å¯¹è±¡ä¸­ï¼Œå³`JVM`ä¼šåŠ¨æ€åœ°ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œè¯¥ä»£ç†ç±»å®ç°äº†`interfaces`ä¸­æŒ‡å®šçš„æ¥å£åˆ—è¡¨ï¼Œå¹¶åœ¨è¿è¡Œæ—¶é€šè¿‡`InvocationHandler`æ¥å¤„ç†æ–¹æ³•è°ƒç”¨ã€‚



æœ€ä¸»è¦çš„åŸå› æ˜¯ï¼š**å› ä¸ºJavaä¸­ä¸æ”¯æŒå¤šç»§æ‰¿ï¼Œè€ŒJDKåŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»åœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶ï¼Œé»˜è®¤è®©ä»£ç†å¯¹è±¡ç»§æ‰¿äº†Proxyç±»ï¼Œæ‰€ä»¥JDKåªèƒ½é€šè¿‡æ¥å£å»å®ç°åŠ¨æ€ä»£ç†**





### CGlibåŠ¨æ€ä»£ç†

Springåœ¨5.Xä¹‹å‰é»˜è®¤çš„åŠ¨æ€ä»£ç†å®ç°ä¸€ç›´æ˜¯jdkåŠ¨æ€ä»£ç†ã€‚ä½†æ˜¯ä»5.Xå¼€å§‹ï¼Œspringå°±å¼€å§‹é»˜è®¤ä½¿ç”¨Cglibæ¥ä½œä¸ºåŠ¨æ€ä»£ç†å®ç°ã€‚å¹¶ä¸”springbootä»2.Xå¼€å§‹ä¹Ÿè½¬å‘äº†CglibåŠ¨æ€ä»£ç†å®ç°ã€‚Cglibæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒçš„åº•å±‚æ˜¯å­—èŠ‚ç å¤„ç†æ¡†æ¶`ASM`ï¼ŒCglibæä¾›äº†æ¯”jdkæ›´ä¸ºå¼ºå¤§çš„åŠ¨æ€ä»£ç†ã€‚ä¸»è¦ç›¸æ¯”jdkåŠ¨æ€ä»£ç†çš„ä¼˜åŠ¿æœ‰ï¼š

- jdkåŠ¨æ€ä»£ç†åªèƒ½åŸºäºæ¥å£ï¼Œä»£ç†ç”Ÿæˆçš„å¯¹è±¡åªèƒ½èµ‹å€¼ç»™æ¥å£å˜é‡ï¼Œè€ŒCglibå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜
- Cglibæ˜¯é€šè¿‡ç”Ÿæˆå­ç±»æ¥å®ç°çš„ï¼Œä»£ç†å¯¹è±¡æ—¢å¯ä»¥èµ‹å€¼ç»™å®ç°ç±»ï¼Œåˆå¯ä»¥èµ‹å€¼ç»™æ¥å£
- Cglibé€Ÿåº¦æ¯”jdkåŠ¨æ€ä»£ç†æ›´å¿«ï¼Œæ€§èƒ½æ›´å¥½





æ ¸å¿ƒè¦ç‚¹ï¼šåœ¨ç”Ÿæˆä»£ç†ç±»æ—¶ï¼Œ`CGLIB` ä¼šå…ˆé€šè¿‡ `ASM` åº“æ¥è¯»å–ç›®æ ‡ç±»çš„å­—èŠ‚ç ï¼Œç„¶åæ ¹æ®ä»£ç†éœ€æ±‚ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç ï¼Œå¹¶å°†å…¶åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚åœ¨ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç æ—¶ï¼Œ`CGLIB` ä¼šé€šè¿‡å­—èŠ‚ç æŠ€æœ¯æ¥ä¿®æ”¹ç›®æ ‡ç±»çš„å­—èŠ‚ç ï¼Œä»è€Œå®ç°ä»£ç†ã€‚

> **è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç **æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œ**åŠ¨æ€ç”Ÿæˆæ–°çš„å­—èŠ‚ç å¹¶å°†å…¶åŠ è½½åˆ° JVM ä¸­æ‰§è¡Œ**ã€‚è¿™ç§æŠ€æœ¯é€šå¸¸è¢«ç”¨äºå®ç°åŠ¨æ€ä»£ç†ã€AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ç­‰åŠŸèƒ½ã€‚**ä¸ç¨‹åºç¼–è¯‘æ—¶ç”Ÿæˆçš„å­—èŠ‚ç ä¸åŒï¼Œè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œå› æ­¤ä¹Ÿç§°ä¸ºåŠ¨æ€å­—èŠ‚ç **ã€‚
>
> åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç çš„è¿‡ç¨‹é€šå¸¸ä½¿ç”¨ä»£ç ç”Ÿæˆåº“ï¼ˆå¦‚ CGLIBã€ASM ç­‰ï¼‰æ¥å®ç°ã€‚ä»£ç ç”Ÿæˆåº“å¯ä»¥é€šè¿‡ç”Ÿæˆç±»çš„å­—èŠ‚ç æ¥å®ç°åŠ¨æ€ä»£ç†ã€åŠ¨æ€ç”Ÿæˆç±»ç­‰åŠŸèƒ½ã€‚åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä»£ç ç”Ÿæˆåº“é€šå¸¸ä¼šä½¿ç”¨ä¸€äº›ä»£ç æ¨¡æ¿å’Œå…ƒæ•°æ®ï¼Œç„¶åæ ¹æ®è¿™äº›æ¨¡æ¿å’Œå…ƒæ•°æ®ç”Ÿæˆæ–°çš„å­—èŠ‚ç ã€‚ç”Ÿæˆçš„å­—èŠ‚ç å¯ä»¥é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½åˆ° JVM ä¸­ï¼Œå¹¶åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰§è¡Œã€‚
>
> åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶æ ¹æ®éœ€è¦ç”Ÿæˆæ–°çš„ç±»æˆ–è€…ä»£ç†ç±»ï¼Œä»è€Œå®ç°æ›´åŠ çµæ´»å’ŒåŠ¨æ€çš„åŠŸèƒ½ã€‚åŒæ—¶ï¼ŒåŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ä¹Ÿå¯ä»¥é¿å…åœ¨ç¨‹åºç¼–è¯‘æ—¶ç”Ÿæˆè¿‡å¤šçš„ä»£ç ï¼Œå‡å°ç¨‹åºçš„ä½“ç§¯å’Œå¤æ‚åº¦ã€‚







æ¥ç€å†æ¥çœ‹çœ‹`Cglib`å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„åŠ¨æ€ä»£ç†



ä¸åŒäºjdkè‡ªå¸¦çš„ä½¿ç”¨`Proxy.newProxyInstanceï¼ˆï¼‰`æ¥åˆ›å»ºä»£ç†å¯¹è±¡çš„æ–¹å¼ï¼ŒCglibä½¿ç”¨`Enhancer`æ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆEnhanceræ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç±»ï¼Œå®ƒå…è®¸ä¸ºéæ¥å£ç±»å‹åˆ›å»ºä¸€ä¸ªJAVAä»£ç†ï¼Œ`Enhancer`åŠ¨æ€çš„åˆ›å»ºç»™å®šç±»çš„å­ç±»å¹¶ä¸”æ‹¦æˆªä»£ç†ç±»çš„æ‰€æœ‰çš„æ–¹æ³•ï¼‰ï¼š

```java
        //è¦ä»£ç†çš„çœŸå®å¯¹è±¡
        private Object obj;

        public Object createProxy(Object target) {
		this.obj = target;
		Enhancer enhancer = new Enhancer();
		// è®¾ç½®çˆ¶ç±»ä¸ºç›®æ ‡ç±»
		enhancer.setSuperclass(this.obj.getClass());
            
            
		//è®¾ç½®å•ä¸€å›è°ƒå¯¹è±¡ï¼Œåœ¨è°ƒç”¨ä¸­æ‹¦æˆªå¯¹ç›®æ ‡æ–¹æ³•çš„è°ƒç”¨ ï¼Œæ‹¦æˆªåæ‰ä¼šæ‰§è¡Œintercept()çš„æ–¹æ³•
		enhancer.setCallback(this);
		//è®¾ç½®ç±»åŠ è½½å™¨
		enhancer.setClassLoader(this.obj.getClass().getClassLoader());
            
            
		//é€šè¿‡å­—èŠ‚ç æŠ€æœ¯åŠ¨æ€åˆ›å»ºä¸€ä¸ªå­ç±»å®ä¾‹
		return enhancer.create();
	}
```



åŒæ—¶éœ€è¦è‡ªå®šä¹‰ `MethodInterceptor` å¹¶é‡å†™ `intercept()` æ–¹æ³•ï¼Œ`intercept()` ç”¨äºæ‹¦æˆªå¢å¼ºè¢«ä»£ç†ç±»çš„æ–¹æ³•ï¼Œå’Œ JDK åŠ¨æ€ä»£ç†ä¸­çš„ `invoke` æ–¹æ³•ç±»ä¼¼:

```java
/*
     * @param o           è¢«ä»£ç†çš„å¯¹è±¡ï¼ˆéœ€è¦å¢å¼ºçš„å¯¹è±¡ï¼‰
     * @param method      è¢«æ‹¦æˆªçš„æ–¹æ³•ï¼ˆéœ€è¦å¢å¼ºçš„æ–¹æ³•ï¼‰
     * @param args        æ–¹æ³•å…¥å‚
     * @param methodProxy ç”¨äºè°ƒç”¨åŸå§‹æ–¹æ³•
     */
    @Override
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {
        //è°ƒç”¨æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("before method " + method.getName());
        Object object = methodProxy.invokeSuper(obj, args);
        //è°ƒç”¨æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥æ·»åŠ è‡ªå·±çš„æ“ä½œ
        System.out.println("after method " + method.getName());
        return object;
    }
```

ä»¥ä¸‹ä¸ºä½¿ç”¨cglibå®ç°åŠ¨æ€ä»£ç†çš„ä¾‹å­1ï¼š

```java
public class CglibProxyFactory implements MethodInterceptor {
    //å¾—åˆ°ç›®æ ‡å¯¹è±¡
    private Object target;

    //ä½¿ç”¨æ„é€ æ–¹æ³•ä¼ é€’ç›®æ ‡å¯¹è±¡
    public CglibProxyFactory(Object target) {
        super();
        this.target = target;
    }

    //åˆ›å»ºä»£ç†å¯¹è±¡    ç±»ä¼¼jdkè‡ªå¸¦åŠ¨æ€ä»£ç†ä¸­çš„Proxy.newProxyInstance()æ–¹æ³•
    public Object createProxy(){
        //1.åˆ›å»ºEnhancer
        Enhancer enhancer = new Enhancer();
        //2.ä¼ é€’ç›®æ ‡å¯¹è±¡çš„class
        enhancer.setSuperclass(target.getClass());
        //3.è®¾ç½®å›è°ƒæ“ä½œ
        enhancer.setCallback(this);

        return enhancer.create();
    }


    //å‚æ•°ä¸€:ä»£ç†è¿‡åçš„å¯¹è±¡;å‚æ•°äºŒ:éœ€è¦æ‹¦æˆªå¢å¼ºçš„æ–¹æ³•;å‚æ•°ä¸‰:éœ€è¦å¢å¼ºæ–¹æ³•çš„å‚æ•°;å‚æ•°å››:éœ€è¦å¢å¼ºçš„æ–¹æ³•çš„ä»£ç†
    public Object intercept(Object proxy, Method method, Object[] args, MethodProxy methodProxy) throws Throwable {
        System.out.println("è¿™æ˜¯å¢å¼ºæ–¹æ³•å‰......");
        Object invoke = methodProxy.invoke(target, args); //  è¿™é‡Œé€‰ç”¨invokeè¿˜æ˜¯invokeSuper()æœ‰æ‰€å•†æ¦·
        System.out.println("è¿™æ˜¯å¢å¼ºæ–¹æ³•å......");
        return invoke;
    }

    public static void main(String[] args) {
        // 1.åˆ›å»ºå¯¹è±¡
        FoodServiceImpl foodService = new FoodServiceImpl();
        // 2.åˆ›å»ºä»£ç†å¯¹è±¡
        CglibProxyFactory proxy = new CglibProxyFactory(foodService); //ä¼ å…¥çš„foodServiceå¯¹åº”Object
        // 3.è°ƒç”¨ä»£ç†å¯¹è±¡çš„å¢å¼ºæ–¹æ³•,å¾—åˆ°å¢å¼ºåçš„å¯¹è±¡
        FoodService createProxy = (FoodService) proxy.createProxy();
        createProxy.makeChicken();  //èµ°intercept()
    }
}
```



ä¾‹å­2ï¼š

```java
import net.sf.cglib.proxy.Enhancer;
import net.sf.cglib.proxy.MethodInterceptor;
import net.sf.cglib.proxy.MethodProxy;

import java.lang.reflect.Method;

// ç›®æ ‡ç±»ï¼Œå³è¢«ä»£ç†ç±»
class RealSubject {
    public void doSomething() {
        System.out.println("RealSubject: Doing something.");
    }
}

// æ‹¦æˆªå™¨ç±»
class ProxySubject implements MethodInterceptor {
    
    private Object target; // è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡

    public ProxySubject(Object target) {
        this.target = target;
    }

    // æ‹¦æˆªå™¨æ–¹æ³•ï¼Œä»£ç†å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½ä¼šç»è¿‡è¿™ä¸ªæ–¹æ³•
    @Override
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {
        System.out.println("Before method: " + method.getName());
        Object result = method.invoke(target, args); // è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
        System.out.println("After method: " + method.getName());
        return result;
    }
}

public class CglibDynamicProxyExample {
    public static void main(String[] args) {
        RealSubject realSubject = new RealSubject();

        // è®¾ç½®è¢«ä»£ç†çš„ç±» å¯¹åº”çš„æ‹¦æˆªå™¨
        ProxySubject proxy = new ProxySubject(realSubject);

        // åˆ›å»ºEnhancerå¯¹è±¡ï¼Œç”¨äºåˆ›å»ºä»£ç†ç±»
        Enhancer enhancer = new Enhancer();
        enhancer.setSuperclass(realSubject.getClass()); // è®¾ç½®çˆ¶ç±»ä¸ºç›®æ ‡ç±»
        enhancer.setCallback(proxy); // ä¸ºä»£ç†å¯¹è±¡è®¾ç½®å›è°ƒæ‹¦æˆªå™¨

        // åˆ›å»ºä»£ç†ç±»å®ä¾‹
        RealSubject proxySubject = (RealSubject) enhancer.create();

        // è°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•
        proxySubject.doSomething();
    }
}

```

ä¸Šè¿°ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç›®æ ‡ç±»`RealSubject`å’Œä¸€ä¸ªä»£ç†ç±»`ProxySubject`ã€‚é€šè¿‡CGLIBçš„`Enhancer`ç±»ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶å°†ç›®æ ‡ç±»ä½œä¸ºå…¶çˆ¶ç±»ï¼Œç„¶åè®¾ç½®ä»£ç†æ‹¦æˆªå™¨ä¸º`ProxySubject`å¯¹è±¡ã€‚å½“è°ƒç”¨ä»£ç†ç±»çš„æ–¹æ³•æ—¶ï¼Œæ‹¦æˆªå™¨çš„`intercept`æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®ç°å¯¹ç›®æ ‡ç±»æ–¹æ³•çš„æ‹¦æˆªå’Œå¢å¼º



æµç¨‹å¦‚ä¸‹ï¼š

- å…ˆé€šè¿‡`enhancer`å¯¹è±¡è®¾ç½®è¢«ä»£ç†çš„ç±»ä¸ºçˆ¶ç±»
- è€ƒè™‘åˆ°ä»¥åç”Ÿæˆçš„ä»£ç†å¯¹è±¡è¦æ‰§è¡Œè¢«ä»£ç†ç±»ä¸­æ–¹æ³•ï¼Œè¦è®¾ç½®æ‹¦æˆªå™¨ç±»æ‹¦æˆªæ–¹æ³•è°ƒç”¨(`implements MethodInterceptor`)
- é€šè¿‡`enhancer.create()`åˆ›å»ºçœŸæ­£çš„ä»£ç†å¯¹è±¡
- ç”Ÿæˆçš„ä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œè¢«ä»£ç†ç±»ä¸­çš„æ–¹æ³•æ—¶ä¼šé»˜è®¤èµ°æ‹¦æˆªå™¨ç±»ä¸­çš„`intercept()`æ–¹æ³•



æ€»ç»“ï¼šCGLIBçš„åŸç†ä¸»è¦æ¶‰åŠä¸¤ä¸ªæ ¸å¿ƒæŠ€æœ¯

1. **å­—èŠ‚ç ç”Ÿæˆï¼š** **CGLIBé€šè¿‡ç”Ÿæˆæ–°çš„Javaç±»çš„å­—èŠ‚ç æ¥å®ç°ä»£ç†**ã€‚å®ƒä½¿ç”¨äº†`ASM`ï¼ˆä¸€ä¸ªJavaå­—èŠ‚ç æ“ä½œæ¡†æ¶ï¼‰æ¥åŠ¨æ€ç”Ÿæˆæ–°çš„ç±»çš„å­—èŠ‚ç ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒCGLIBä¼šæ ¹æ®ç›®æ ‡ç±»æˆ–æ¥å£åˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç†ç±»ï¼Œå¹¶å°†å…¶å­—èŠ‚ç åŠ è½½åˆ°JVMä¸­ã€‚
2. **æ–¹æ³•æ‹¦æˆªï¼š** CGLIBé€šè¿‡ç»§æ‰¿ç›®æ ‡ç±»ï¼Œå¹¶è¦†ç›–ç›®æ ‡ç±»ä¸­çš„æ–¹æ³•æ¥å®ç°ä»£ç†ã€‚ç”Ÿæˆçš„ä»£ç†ç±»ä¼šç»§æ‰¿ç›®æ ‡ç±»ï¼Œå¹¶é‡å†™å…¶ä¸­çš„æ–¹æ³•ã€‚åœ¨ä»£ç†ç±»çš„é‡å†™æ–¹æ³•ä¸­ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨æ–¹æ³•æ‹¦æˆªå™¨ï¼ˆ`MethodInterceptor`ï¼‰çš„å›è°ƒæ–¹æ³•ï¼Œå®ç°å¯¹ç›®æ ‡æ–¹æ³•çš„æ‹¦æˆªå’Œå¢å¼ºã€‚





ä¸¤è€…æ¯”è¾ƒï¼š

- `JDK` åŠ¨æ€ä»£ç†åªéœ€è¦å®ç° `InvocationHandler` æ¥å£ï¼Œé‡å†™ `invoke()` æ–¹æ³•ä¾¿å¯ä»¥å®Œæˆä»£ç†çš„å®ç°ï¼Œ

- `jdk`çš„ä»£ç†æ˜¯åˆ©ç”¨åå°„**è¿è¡Œæ—¶**ç”Ÿæˆä»£ç†ç±» `Proxyxx.class` ä»£ç†ç±»å­—èŠ‚ç ï¼Œå¹¶ç”Ÿæˆå¯¹è±¡

- `jdk`åŠ¨æ€ä»£ç†ä¹‹æ‰€ä»¥**åªèƒ½ä»£ç†æ¥å£**æ˜¯å› ä¸º**ä»£ç†ç±»æœ¬èº«å·²ç»`extends`äº†`Proxy`ï¼Œè€Œjavaæ˜¯ä¸å…è®¸å¤šé‡ç»§æ‰¿çš„**ï¼Œä½†æ˜¯å…è®¸å®ç°å¤šä¸ªæ¥å£

- CGLib é‡‡ç”¨äº†éå¸¸åº•å±‚çš„å­—èŠ‚ç æŠ€æœ¯ï¼Œå…¶åŸç†æ˜¯é€šè¿‡å­—èŠ‚ç å¢å¼ºæŠ€æœ¯(`ASMç±»åº“`)ä¸ºä¸€ä¸ªç±»åˆ›å»ºå­ç±»ï¼Œå¹¶åœ¨å­ç±»ä¸­é‡‡ç”¨æ–¹æ³•æ‹¦æˆªçš„æŠ€æœ¯æ‹¦æˆªæ‰€æœ‰çˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œé¡ºåŠ¿ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ï¼Œæ¥å®ŒæˆåŠ¨æ€ä»£ç†çš„å®ç°ã€‚

- å®ç°æ–¹å¼ä¸Šcglibéœ€è¦å®ç° `MethodInterceptor` æ¥å£ï¼Œé‡å†™ `intercept()` æ–¹æ³•ï¼Œé€šè¿‡ `Enhancer` ç±»çš„å›è°ƒæ–¹æ³•æ¥åˆ›å»ºä»£ç†

- ä½†æ˜¯CGLibåœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶æ‰€èŠ±è´¹çš„æ—¶é—´å´æ¯”JDKå¤šå¾—å¤šï¼Œæ‰€ä»¥å¯¹äºå•ä¾‹çš„å¯¹è±¡ï¼Œå› ä¸ºæ— éœ€é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼Œç”¨CGLibåˆé€‚

  


 [Spring Boot2 ä¸ºå•¥é»˜è®¤CGlibä¸å†ä½¿ç”¨JDKä»£ç†?](https://www.bilibili.com/video/BV1Tz4y1t7DV/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&vd_source=b14e177936642415d7e4c5110d4d4bb7)







### Javassistä»£ç†

å½“ä½¿ç”¨`Javassist`ç›´æ¥æ“ä½œå­—èŠ‚ç å®ç°åŠ¨æ€ä»£ç†æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å¹¶åœ¨è¯¥ç±»ä¸­åŠ¨æ€ç”Ÿæˆæ–¹æ³•çš„å­—èŠ‚ç ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨`Javassist`ç›´æ¥æ“ä½œå­—èŠ‚ç å®ç°åŠ¨æ€ä»£ç†çš„ä¾‹å­ï¼š

```java
import javassist.*;
import java.lang.reflect.Method;

interface Subject {
    void doSomething();
}

public class JavassistBytecodeProxyExample {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºClassPoolå¯¹è±¡ï¼Œç”¨äºç®¡ç†ç”Ÿæˆçš„ç±»
        ClassPool classPool = ClassPool.getDefault();

        
        CtClass proxyClass = classPool.makeClass("DynamicProxy");

        // è®¾ç½®ç±»çš„æ¥å£
        proxyClass.addInterface(classPool.get(Subject.class.getName()));

        // æ·»åŠ MethodHandlerå­—æ®µ
        CtField handlerField = new CtField(classPool.get(MethodHandler.class.getName()), "handler", proxyClass);
        proxyClass.addField(handlerField);

        // æ·»åŠ doSomething()æ–¹æ³•ï¼Œå¹¶åœ¨æ–¹æ³•ä½“ä¸­å®ç°ä»£ç†é€»è¾‘
        CtMethod method = CtNewMethod.make(
                "public void doSomething() { " +
                        "try { " +
                        "handler.invoke(this, this.getClass().getMethod(\"doSomething\"), null); " +
                        "} catch (Throwable e) { " +
                        "e.printStackTrace(); " +
                        "}" +
                        "}", proxyClass);
        proxyClass.addMethod(method);

        // åˆ›å»ºä»£ç†ç±»çš„Classå¯¹è±¡
        Class<?> proxyClassObject = proxyClass.toClass();

        // åˆ›å»ºä»£ç†å®ä¾‹
        Subject proxySubject = (Subject) proxyClassObject.getDeclaredConstructor().newInstance();

        // è®¾ç½®MethodHandler
        MethodHandler handler = (self, thisMethod, proceed, args1) -> {
            System.out.println("Before method: " + thisMethod.getName());
            self.doSomething(); // è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
            System.out.println("After method: " + thisMethod.getName());
            return null;
        };
        proxySubject.getClass().getField("handler").set(proxySubject, handler);

        // è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•
        proxySubject.doSomething();
    }
}
```



> å‡ ç§å­—èŠ‚ç ç”Ÿæˆåº“çš„æ¯”è¾ƒ

åœ¨ Java ä¸­ï¼Œå¸¸ç”¨çš„ä»£ç ç”Ÿæˆåº“åŒ…æ‹¬ CGLIBã€ASMã€Javassist ç­‰ï¼Œå®ƒä»¬éƒ½å¯ä»¥ç”¨æ¥ç”Ÿæˆå­—èŠ‚ç ï¼Œå®ç°åŠ¨æ€ä»£ç†ã€åŠ¨æ€ç”Ÿæˆç±»ç­‰åŠŸèƒ½ã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. ç”Ÿæˆæ–¹å¼ï¼š**CGLIB å’Œ Javassist é‡‡ç”¨çš„æ˜¯åŸºäºå­ç±»çš„æ–¹å¼ï¼Œå³ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»æ¥å®ç°ä»£ç†æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»**ï¼›è€Œ **ASM é‡‡ç”¨çš„æ˜¯åŸºäºä¿®æ”¹å­—èŠ‚ç çš„æ–¹å¼ï¼Œå³ç›´æ¥ä¿®æ”¹ç›®æ ‡ç±»çš„å­—èŠ‚ç æ¥å®ç°ä»£ç†æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»**ã€‚

2. æ€§èƒ½ï¼šASM é€šå¸¸è¢«è®¤ä¸ºæ˜¯æœ€å¿«çš„ä»£ç ç”Ÿæˆåº“ï¼Œå› ä¸ºå®ƒç›´æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œé¿å…äº†åˆ›å»ºä¸­é—´å¯¹è±¡çš„å¼€é”€ï¼›è€Œ CGLIB å’Œ Javassist çš„æ€§èƒ½ç›¸å¯¹è¾ƒå·®ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦åˆ›å»ºä¸­é—´å¯¹è±¡æ¥ç”Ÿæˆå­—èŠ‚ç ã€‚

3. ç®€æ´æ€§ï¼šCGLIB å’Œ Javassist çš„ç¼–ç¨‹æ¥å£ç›¸å¯¹è¾ƒä¸ºç®€å•ï¼Œæ˜“äºä¸Šæ‰‹å’Œä½¿ç”¨ï¼›è€Œ ASM çš„ç¼–ç¨‹æ¥å£ç›¸å¯¹è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦å¯¹å­—èŠ‚ç æœ‰ä¸€å®šçš„äº†è§£ã€‚

   















## Objectç±»å¸¸è§é—®é¢˜



Objectç±»çš„å†…éƒ¨æ–¹æ³•å¦‚ä¸‹(è¦æ±‚å…¨éƒ¨æŒæ¡)ï¼š

```java
/**
 * native æ–¹æ³•ï¼Œç”¨äºè¿”å›å½“å‰è¿è¡Œæ—¶å¯¹è±¡çš„ Class å¯¹è±¡ï¼Œä½¿ç”¨äº† final å…³é”®å­—ä¿®é¥°ï¼Œæ•…ä¸å…è®¸å­ç±»é‡å†™ã€‚
 */
public final native Class<?> getClass();


/**
 * native æ–¹æ³•ï¼Œç”¨äºè¿”å›å¯¹è±¡çš„å“ˆå¸Œç ï¼Œä¸»è¦ä½¿ç”¨åœ¨å“ˆå¸Œè¡¨ä¸­ï¼Œæ¯”å¦‚ JDK ä¸­çš„HashMapã€‚
 * hashCode() æ–¹æ³•çš„å®ç°é€šå¸¸æ˜¯åŸºäºå¯¹è±¡çš„å†…å­˜åœ°å€è®¡ç®—å‡ºä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼å¯ä»¥ä½œä¸ºå¯¹è±¡çš„å“ˆå¸Œç 
 * hashCode() æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª 32 ä½çš„æ•´æ•°ï¼ˆint ç±»å‹ï¼‰
 */
public native int hashCode();



/**
 * ç”¨äºæ¯”è¾ƒ 2 ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€æ˜¯å¦ç›¸ç­‰(å³æ¯”è¾ƒä¸¤ä¸ªå¼•ç”¨å˜é‡æŒ‡å‘çš„å†…å­˜åœ°å€æ˜¯å¦ç›¸ç­‰)
 * String ç±»å¯¹è¯¥æ–¹æ³•è¿›è¡Œäº†é‡å†™ä»¥ç”¨äºæ¯”è¾ƒå­—ç¬¦ä¸²çš„å€¼æ˜¯å¦ç›¸ç­‰ã€‚
 */
public boolean equals(Object obj){
return (this == obj);  //é»˜è®¤æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¼•ç”¨ç±»å‹æŒ‡å‘çš„å†…å­˜åœ°å€ä¸€ä¸ä¸€è‡´
}


/**
 * native æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºå¹¶è¿”å›å½“å‰å¯¹è±¡çš„ä¸€ä»½æ‹·è´ã€‚
 */
protected native Object clone() throws CloneNotSupportedException;



/**
 * è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ï¼Œå»ºè®® Object æ‰€æœ‰çš„å­ç±»éƒ½é‡å†™è¿™ä¸ªæ–¹æ³•
é»˜è®¤è¿”å›æ ¼å¼ä¸ºï¼šå¯¹è±¡çš„ class åç§° + @ + hashCode çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚
 */
public String toString()
{
  return getClass().getName() + "@" + Integer.toHexString(hashCode());  
}


/**
 * native æ–¹æ³•ï¼Œå¹¶ä¸”ä¸èƒ½é‡å†™ã€‚å”¤é†’ä¸€ä¸ªåœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„çº¿ç¨‹(ç›‘è§†å™¨ç›¸å½“äºå°±æ˜¯é”çš„æ¦‚å¿µ)ã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åªä¼šä»»æ„å”¤é†’ä¸€ä¸ªã€‚
 * å¾ˆæ˜æ˜¾è¯¥æ–¹æ³•éœ€è¦ä¾èµ–äºç‰¹å®šçš„Objectå¯¹è±¡
 */
public final native void notify();



/**
 * native æ–¹æ³•ï¼Œå¹¶ä¸”ä¸èƒ½é‡å†™ã€‚è·Ÿ notify ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ä¼šå”¤é†’åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚
 */
public final native void notifyAll();


/**
 * nativeæ–¹æ³•ï¼Œå¹¶ä¸”ä¸èƒ½é‡å†™ã€‚æš‚åœçº¿ç¨‹çš„æ‰§è¡Œã€‚æ³¨æ„ï¼šsleep æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ wait æ–¹æ³•é‡Šæ”¾äº†é” ï¼Œtimeout æ˜¯ç­‰å¾…æ—¶é—´ã€‚
 */
public final native void wait(long timeout) throws InterruptedException;


/**
 * å¤šäº† nanos å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°è¡¨ç¤ºé¢å¤–æ—¶é—´ï¼ˆä»¥æ¯«å¾®ç§’ä¸ºå•ä½ï¼ŒèŒƒå›´æ˜¯ 0-999999ï¼‰ã€‚ æ‰€ä»¥è¶…æ—¶çš„æ—¶é—´è¿˜éœ€è¦åŠ ä¸Š nanos æ¯«ç§’ã€‚ã€‚
 */
public final void wait(long timeout, int nanos) throws InterruptedException;


/**
 * è·Ÿä¹‹å‰çš„2ä¸ªwaitæ–¹æ³•ä¸€æ ·ï¼Œåªä¸è¿‡è¯¥æ–¹æ³•ä¸€ç›´ç­‰å¾…ï¼Œæ²¡æœ‰è¶…æ—¶æ—¶é—´è¿™ä¸ªæ¦‚å¿µ
 */
public final void wait() throws InterruptedException;



/**
 * å®ä¾‹è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„æ—¶å€™è§¦å‘çš„æ“ä½œ
 */
protected void finalize() throws Throwable { };

```



å¯¹äº`toString()`,å…¶è¿”å›ä¸€ä¸ªå¯¹è±¡å¯¹åº”çš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼ï¼Œä¾‹å¦‚ï¼š

```java
Review review1=new Review();
Review review2=new Review();
System.out.println(review1);
System.out.println(review1.toString());
System.out.println(review2.toString());
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
test.Review@6576fe71
test.Review@6576fe71
test.Review@76fb509a
```

å¯ä»¥çœ‹å‡ºæ‰“å°ä¸€ä¸ªå¯¹è±¡æ—¶ä¼šé»˜è®¤è°ƒç”¨è¯¥å¯¹è±¡çš„`toString()`æ–¹æ³•





### ä¸ºä»€ä¹ˆè¦æœ‰hashcode()æ–¹æ³•ï¼Ÿ



å½“æŠŠä¸€ä¸ªå¯¹è±¡åŠ å…¥ `HashSet` æ—¶ï¼Œ`HashSet` ä¼šå…ˆè®¡ç®—å¯¹è±¡çš„ `hashCode` å€¼æ¥åˆ¤æ–­å¯¹è±¡åŠ å…¥çš„ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿä¼šä¸å…¶ä»–å·²ç»åŠ å…¥çš„å¯¹è±¡çš„ `hashCode` å€¼ä½œæ¯”è¾ƒï¼Œ**å¦‚æœæ²¡æœ‰ç›¸ç¬¦çš„ `hashCode`ï¼Œ`HashSet` ä¼šå‡è®¾å¯¹è±¡æ²¡æœ‰é‡å¤å‡ºç°ã€‚**ä½†æ˜¯å¦‚æœå‘ç°æœ‰ç›¸åŒ `hashCode` å€¼çš„å¯¹è±¡ï¼Œè¿™æ—¶ä¼šè°ƒç”¨ `equals()` æ–¹æ³•æ¥æ£€æŸ¥ `hashCode` ç›¸ç­‰çš„å¯¹è±¡æ˜¯å¦çœŸçš„ç›¸åŒã€‚å¦‚æœä¸¤è€…ç›¸åŒï¼Œ`HashSet` å°±ä¸ä¼šè®©å…¶åŠ å…¥æ“ä½œæˆåŠŸã€‚å¦‚æœä¸åŒçš„è¯ï¼Œå°±ä¼šé‡æ–°æ•£åˆ—åˆ°å…¶ä»–ä½ç½®ã€‚è¿™æ ·æˆ‘ä»¬å°±å¤§å¤§å‡å°‘äº† `equals` çš„æ¬¡æ•°ï¼Œç›¸åº”å°±å¤§å¤§æé«˜äº†æ‰§è¡Œé€Ÿåº¦ï¼Œæ€»ç»“ä¸‹æ¥å°±æ˜¯ï¼š

- å¦‚æœä¸¤ä¸ªå¯¹è±¡çš„`hashCode` å€¼ç›¸ç­‰ï¼Œé‚£è¿™ä¸¤ä¸ªå¯¹è±¡ä¸ä¸€å®šç›¸ç­‰ï¼ˆå“ˆå¸Œç¢°æ’ï¼‰
- å¦‚æœä¸¤ä¸ªå¯¹è±¡çš„`hashCode` å€¼ç›¸ç­‰å¹¶ä¸”`equals()`æ–¹æ³•ä¹Ÿè¿”å› `true`ï¼Œæ‰è®¤ä¸ºè¿™ä¸¤ä¸ªå¯¹è±¡ç›¸ç­‰
- å¦‚æœä¸¤ä¸ªå¯¹è±¡çš„`hashCode` å€¼ä¸ç›¸ç­‰ï¼Œå°±å¯ä»¥ç›´æ¥è®¤ä¸ºè¿™ä¸¤ä¸ªå¯¹è±¡ä¸ç›¸ç­‰



(å“ˆå¸Œç æ˜¯ä¸€ä¸ª int ç±»å‹çš„å€¼ï¼Œå®ƒçš„å–å€¼èŒƒå›´æ˜¯ -2147483648 åˆ° 2147483647)





> ä¸ºä»€ä¹ˆä¸€æ—¦é‡å†™äº†`equals`()å¿…é¡»è¦é‡å†™`hashcode`()æ–¹æ³•ï¼Ÿ

é‚£ä¹ˆä¸é‡å†™çš„åæœæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

ä¸¾ä¸€ä¸ªä¾‹å­ï¼š

å¦‚æœä¸€ä¸ªåªé‡å†™äº†**equals(æ¯”è¾ƒæ‰€æœ‰å±æ€§æ˜¯å¦ç›¸ç­‰)**çš„ç±» `new` å‡ºäº†ä¸¤ä¸ª**å±æ€§ç›¸åŒçš„å¯¹è±¡**ã€‚è¿™æ—¶å¯ä»¥å¾—åˆ°çš„ä¿¡æ¯æ˜¯è¿™ä¸¤ä¸ªå±æ€§ç›¸åŒçš„å¯¹è±¡åœ°å€è‚¯å®šä¸åŒï¼Œä½†æ˜¯`equals`æ˜¯`true`ï¼Œ`hashCode`è¿”å›çš„æ˜¯ä¸ç›¸ç­‰çš„(ä¸€èˆ¬ä¸ä¼šå‡ºç°hashç¢°æ’)ã€‚è¿™æ ·å°±è¿èƒŒäº†`equals`ç›¸ç­‰åˆ™`hashcode`å€¼ä¸€å®šç›¸ç­‰çš„çº¦å®šï¼

æ€»ç»“æ¥è¯´ï¼š

- equals ä¸º true ï¼Œ hashCode å¿…é¡»ç›¸ç­‰(é»˜è®¤è®¾è®¡åŸåˆ™)
- hashCode ç›¸ç­‰æ—¶ ï¼Œ equals å¯ä»¥ä¸ç”¨ä¸º true ï¼ˆä¹Ÿå°±æ˜¯hashç¢°æ’çš„æ—¶å€™ï¼‰













## Stringç±»å¸¸è§é—®é¢˜



### Stringå¯¹è±¡ä¸ºä»€ä¹ˆæ˜¯ä¸å¯å˜çš„ï¼Ÿ



> å‰è¨€ï¼šfinalå…³é”®å­—çš„ä½œç”¨ï¼Ÿ
>
> 
>
> åœ¨ Java ä¸­ï¼Œ`final` å…³é”®å­—å¯ä»¥ç”¨äºä¿®é¥°ç±»ã€æ–¹æ³•å’Œå˜é‡ï¼Œç”¨äºè¡¨ç¤ºä¸å¯ç»§æ‰¿æ€§ã€ä¸å¯é‡å†™æ€§ã€**(å¼•ç”¨æŒ‡å‘ )ä¸å¯å˜æ€§**
>
> 1. å¯¹äºå¼•ç”¨ç±»å‹ï¼Œfinal ä½¿å¼•ç”¨æŒ‡å‘ä¸å˜ï¼Œä¹Ÿå°±ä¸èƒ½å¼•ç”¨å…¶å®ƒå¯¹è±¡ï¼Œä½†æ˜¯è¢«å¼•ç”¨çš„å¯¹è±¡æœ¬èº«æ˜¯å¯ä»¥ä¿®æ”¹çš„
> 2. å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œè¢«finalä¿®é¥°çš„å˜é‡å°±å˜æˆäº†å¸¸é‡ï¼Œä¸€æ—¦è¢«èµ‹å€¼åˆ™æ— æ³•å†æ¬¡è¢«ä¿®æ”¹

`final`å¹¶ä¸èƒ½ä¿è¯å¯¹è±¡çš„ä¸å¯å˜æ€§ï¼Œåªèƒ½ä¿è¯è¯¥å¼•ç”¨ä¸èƒ½æŒ‡å‘ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼š

```java
final char[] name = new char[]{'s', 'o', 'n', 'n', 'y'};
System.out.println(name);  //sonny
name[0] = 'h';
System.out.println(name);  //honny
name=new char[]{'h','a','r','r','y'}; // is not allowed!
```





> ä»€ä¹ˆå«Stringä¸å¯å˜ï¼Ÿ

æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

```java
public void testString(){
String name="harry";
name="kane";
}

```

å¯¹äºä»¥ä¸Šä»£ç ï¼Œ`jvm`ä¼šå…ˆåœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡"`harry`"ï¼ŒåŒæ—¶åœ¨æ ˆä¸­åˆ›å»ºä¸€ä¸ªå¼•ç”¨`name`æŒ‡å‘å †ä¸­å®ä¾‹ï¼Œè€Œå¦‚æœæƒ³è¦ä¿®æ”¹`name`æŒ‡å‘çš„å †ä¸­`String`å¯¹è±¡å®ä¾‹ï¼Œè¿™æ˜¯ä¸å¯è¡Œçš„ï¼Œ`jvm`åªä¼šå¦å¤–åœ¨å †ä¸­é‡æ–°åˆ›å»ºä¸€ä¸ª`String`ç±»å¯¹è±¡"`kane`"ï¼Œç„¶åè®©å¼•ç”¨å˜é‡`name`æŒ‡å‘æ–°çš„å †ä¸­å­—ç¬¦ä¸²å¸¸é‡"`kane`"

**æ‰€ä»¥è¯´çš„`String`ä¸å¯å˜å®é™…ä¸ŠæŒ‡çš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„"harry"æ˜¯ä¸èƒ½è¢«ä¿®æ”¹çš„äº†**



ä½†æ˜¯å¦‚æœè¿™æ ·å£°æ˜ï¼Œå°±æ˜¯éæ³•çš„äº†ï¼š

```java
final String name="harry";
name="kane"; //error   è¢«finalä¿®é¥°çš„Stringç±»å‹çš„å¼•ç”¨ æ— æ³•æ”¹å˜å…¶æŒ‡å‘
```

ä¹Ÿå°±æ˜¯è¯´ï¼šå¦‚æœåœ¨`String`ç±»å‹å¼•ç”¨å‰ä¸ç”¨`final`ä¿®é¥°ï¼Œé‚£ä¹ˆè¯¥å¼•ç”¨è¿˜æ˜¯å¯ä»¥æ”¹å˜æŒ‡å‘çš„







> å›åˆ°é—®é¢˜ä¸Šæ¥ï¼Œ`String`ä¸ºä»€ä¹ˆä¸å¯å˜ï¼Ÿ

`String` ç±»ä¸­ä½¿ç”¨ `final` å…³é”®å­—ä¿®é¥°å­—ç¬¦æ•°ç»„ `value` æ¥ä¿å­˜å­—ç¬¦ä¸²ï¼š

```java
public final class String
    implements java.io.Serializable, Comparable<String>, CharSequence,
               Constable, ConstantDesc {
       private final char value[]; //Java 9 ä¹‹å‰Stringã€StringBuilderï¼ˆBufferï¼‰ä½¿ç”¨char[]æ•°ç»„å­˜æ”¾å­—ç¬¦ä¸²
       private final byte[] value; //Java 9 ä¹‹åï¼Œæ”¹ç”¨byte[]æ•°ç»„å­˜å‚¨å­—ç¬¦ä¸²            
               }
```



`String` çœŸæ­£ä¸å¯å˜æœ‰ä¸‹é¢å‡ ç‚¹åŸå› ï¼š

1. ä¿å­˜å­—ç¬¦ä¸²çš„æ•°ç»„(char[]ã€byte[])è¢« `final` ä¿®é¥°ä¸”ä¸ºç§æœ‰çš„ï¼Œè¯¥æ•°ç»„è¢«å£°æ˜ä¸º `final`ï¼Œè¿™æ„å‘³ç€ `value` **æ•°ç»„åˆå§‹åŒ–ä¹‹å ï¼Œvalueå°±ä¸èƒ½å†æŒ‡å‘å…¶å®ƒå †ä¸­å­—ç¬¦ä¸²å¸¸é‡äº†(å…¶å®è¿™ä¸ªæ˜¯æœ€ä¸é‡è¦çš„åŸå› äº†ï¼)**ï¼Œ**è€Œä¸”ç”±äº byteæ•°ç»„ è¢«`private`ä¿®é¥°ï¼Œä¸”æ²¡æœ‰æä¾›`setXXX()`æ–¹æ³•ï¼Œé˜»æ­¢äº†å¤–éƒ¨ç±»ä¿®æ”¹ï¼ï¼(è¿™ä¸ªæ‰æ˜¯ä¸»è¦åŸå› )**	

2. `String` ç±»è¢« `final` ä¿®é¥°å¯¼è‡´å…¶ä¸èƒ½è¢«ç»§æ‰¿ï¼Œè¿›è€Œé¿å…äº†å­ç±»ç ´å `String` ä¸å¯å˜ï¼ˆé˜²æ­¢å­ç±»é‡å†™`String`ç±»ä¸­æ–¹æ³•ï¼Œå°†å­ç±»è®¾è®¡ä¸ºå¯å˜å¯¹è±¡ï¼‰

3. `String`**ç±»ä¸­çš„æ–¹æ³•ä¸ä¼šå»æ”¹åŠ¨valueæ•°ç»„ä¸­çš„å…ƒç´ **ï¼Œè‹¥**éœ€ä¿®æ”¹éƒ½æ˜¯ç›´æ¥æ–°åˆ›å»ºä¸€ä¸ªStringå¯¹è±¡**ï¼Œæ ¹æœ¬æ²¡æœ‰åœ¨åŸå­—ç¬¦ä¸²å¯¹è±¡ä¸Šåšæ”¹å˜ï¼Œä¾‹å¦‚`subString()`ã€`replace()`ï¼š

   ```java
   public String substring(int beginIndex) {
   //ç•¥å»å¼‚å¸¸å¤„ç†
   int subLen = value.length - beginIndex;
   return (beginIndex == 0) ? this : new String(value, beginIndex, subLen);
   }
   
     public String replace(char oldChar, char newChar) {
           if (oldChar != newChar) {
              //è¿›è¡Œå­—ç¬¦æ›¿æ¢çš„é€»è¾‘
                   }
                   return new String(buf, true); //åˆ›å»ºä¸€ä¸ªæ–°çš„Stringå¯¹è±¡
               }
           }
           return this;  //oldCharå’ŒnewCharä¸€è‡´ï¼Œä¸ç”¨ä¿®æ”¹ï¼Œç›´æ¥è¿”å›å³å¯
       }
   ```





é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•æ”¹å˜`String`å‘¢ï¼Ÿå½“ç„¶æ˜¯æœ‰çš„ï¼Œé€šè¿‡åå°„å¯ä»¥å®ç°ï¼š

```java
public class Test2 {
    public static void main(String[] args) {
        String str ="å¼ ä¸‰"
            System.out.println(str);
        try {
            //æˆ‘ä»¬é€šè¿‡åå°„è·å–å†…éƒ¨çš„valueå­—ç¬¦æ•°ç»„
            Field field =String.class.getDeclaredField("value");
            field.setAccessible(true);
            char[] value;
            value = (char[]) field.get(str);
            //æŠŠå­—ç¬¦ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦å˜æˆç‹
            value[0] ='ç‹';
            System.out.println(str); 
            catch (Exception e) {
                e.printstackTrace();
            }
        }
    }
    //output:
    //å¼ ä¸‰
    //ç‹ä¸‰
```







é—®é¢˜æ¥äº†ï¼š**ä¸ºä»€ä¹ˆè¦å°†`String`è®¾è®¡ä¸ºä¸å¯å˜çš„ï¼Ÿ**

(1) ç¬¬ä¸€ä¸ªåŸå› å°±æ˜¯å¯ä»¥èŠ‚çœç©ºé—´--å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š

```java
String club="chelsa";
String club2="chelsa";
```

**å¯¹äºä»¥ä¸Šä»£ç ï¼š`club`å’Œ`club2`ä¸¤ä¸ªå¼•ç”¨æŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„åŒä¸€å­—ç¬¦ä¸²å¯¹è±¡**





(2) å…¶æ¬¡ï¼Œç”±äº`String`å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œè€Œä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¦‚æœ`String`å¯¹è±¡æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆåœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ª`String`å¯¹è±¡æ—¶ï¼Œå°±ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ç­‰é—®é¢˜



(3) ä¸”ç”±äº`String`å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œå› æ­¤å¯ä»¥è¢«ç¼“å­˜ï¼Œå¹¶ä¸”åœ¨å¤šä¸ªåœ°æ–¹é‡å¤ä½¿ç”¨ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ä¾‹å¦‚å½“ä¸€ä¸ªå­—ç¬¦ä¸²è¢«åˆ›å»ºåï¼Œå®ƒçš„å“ˆå¸Œå€¼å°±å¯ä»¥è¢«ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶å¿«é€ŸæŸ¥æ‰¾ã€‚å¦‚æœ`String`å¯¹è±¡æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆæ¯æ¬¡ä¿®æ”¹`String`å¯¹è±¡æ—¶éƒ½éœ€è¦é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼Œè¿™ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™



æ­¤å¤–ï¼Œä¸å¯å˜çš„`String`å¯¹è±¡è¿˜æœ‰å…¶ä»–ä¸€äº›ä¼˜ç‚¹ï¼Œä¾‹å¦‚å¯ä»¥ä½œä¸º`Map`çš„`Key`æ¥ä½¿ç”¨ï¼Œå› ä¸º`Key`éœ€è¦æ˜¯ä¸å¯å˜çš„å¯¹è±¡ã€‚åŒæ—¶ï¼Œ`Java`ä¸­çš„å­—ç¬¦ä¸²è¿æ¥æ“ä½œä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨`StringBuilder`æˆ–`StringBuffer`æ¥å®ç°ï¼Œè¿™äº›ç±»å¯ä»¥åŠ¨æ€åœ°ä¿®æ”¹å­—ç¬¦ä¸²ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨å¯å˜çš„`String`å¯¹è±¡







### ç›¸å…³ç±»çš„çº¿ç¨‹å®‰å…¨

**`String` ä¸­çš„å¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œä¹Ÿå°±å¯ä»¥ç†è§£ä¸ºå¸¸é‡ï¼Œçº¿ç¨‹å®‰å…¨**ã€‚`AbstractStringBuilder` æ˜¯ `StringBuilder` ä¸ `StringBuffer` çš„å…¬å…±çˆ¶ç±»ï¼Œå®šä¹‰äº†ä¸€äº›å­—ç¬¦ä¸²çš„åŸºæœ¬æ“ä½œï¼Œå¦‚ `expandCapacity`ã€`append`ã€`insert`ã€`indexOf` ç­‰å…¬å…±æ–¹æ³•ã€‚`StringBuffer` å¯¹æ–¹æ³•åŠ äº†åŒæ­¥é”ï¼ˆ`synchronized`ï¼‰æˆ–è€…å¯¹è°ƒç”¨çš„æ–¹æ³•åŠ äº†åŒæ­¥é”ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„,è€Œ`StringBuilder` å¹¶æ²¡æœ‰å¯¹æ–¹æ³•è¿›è¡ŒåŠ åŒæ­¥é”ï¼Œæ‰€ä»¥æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼š

```java
//StringBufferç±»ä¸­ä¸€äº›å¸¸ç”¨æ–¹æ³•:

    @Override
    public synchronized int length() {
        return count;
    }


   @Override
   public synchronized StringBuffer append(Object obj) {
        toStringCache = null;
        super.append(String.valueOf(obj));
        return this;
    }
    

   @Override
   public synchronized char charAt(int index) {
        return super.charAt(index);
    }
```





### String str=new String("abc") åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ï¼Ÿ



> è¿™è¡Œä»£ç åˆ›å»ºäº†å‡ ä¸ªå¯¹è±¡ï¼Ÿ

```java
String s = new String("äºŒå“¥");
```

â€œä½¿ç”¨ new å…³é”®å­—åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼ŒJava è™šæ‹Ÿæœºä¼š**å…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰â€˜äºŒå“¥â€™è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡**ï¼Œå¦‚æœæœ‰ï¼Œå°±ä¸ä¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºâ€˜äºŒå“¥â€™è¿™ä¸ªå¯¹è±¡äº†ï¼Œ**ç›´æ¥åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªâ€˜äºŒå“¥â€™çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç„¶åå°†å †ä¸­è¿™ä¸ªâ€˜äºŒå“¥â€™çš„å¯¹è±¡åœ°å€è¿”å›èµ‹å€¼ç»™å˜é‡ sã€‚â€**

â€œå¦‚æœæ²¡æœ‰ï¼Œå…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºä¸€ä¸ªâ€˜äºŒå“¥â€™çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç„¶åå†åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªâ€˜äºŒå“¥â€™çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç„¶å**å°†å †ä¸­è¿™ä¸ªâ€˜äºŒå“¥â€™çš„å­—ç¬¦ä¸²å¯¹è±¡åœ°å€è¿”å›èµ‹å€¼ç»™å˜é‡ s**ã€‚â€



å¯ä»¥çœ‹çš„å‡ºæ¥æ— è®ºå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰æ²¡æœ‰å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåªè¦æ˜¯`new String()`çš„è¯éƒ½ä¼šè¿”å›å †ä¸­å¯¹è±¡åœ°å€



<img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/string//constant-pool-6dee151e-3a13-4f85-b870-3c9d1797557a.png" alt="img" style="zoom:50%;" />



åœ¨Javaä¸­ï¼Œæ ˆä¸Šå­˜å‚¨çš„æ˜¯åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡å’Œå¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œå¯¹è±¡æœ¬èº«åˆ™å­˜å‚¨åœ¨å †ä¸Š



å¯¹äºè¿™è¡Œä»£ç  `String s = new String("äºŒå“¥");`ï¼Œå®ƒåˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ï¼šä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²å¯¹è±¡ "äºŒå“¥"ï¼Œå®ƒè¢«æ·»åŠ åˆ°äº†å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œå¦ä¸€ä¸ªæ˜¯é€šè¿‡ `new String()` æ„é€ å‡½æ•°åˆ›å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡ "äºŒå“¥"ï¼Œå®ƒè¢«åˆ†é…åœ¨å †å†…å­˜ä¸­ï¼ŒåŒæ—¶å¼•ç”¨å˜é‡ s å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå®ƒæŒ‡å‘å †å†…å­˜ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡ "äºŒå“¥"

â€œ**ä¸ºä»€ä¹ˆè¦å…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºå¯¹è±¡ï¼Œç„¶åå†åœ¨å †ä¸Šåˆ›å»ºå‘¢**ï¼Ÿè¿™æ ·ä¸å°±å¤šæ­¤ä¸€ä¸¾äº†ï¼Ÿ(æ‰€ä»¥æ²¡å¿…è¦ä½¿ç”¨new String()æ¥åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡)

ç”±äºå­—ç¬¦ä¸²çš„ä½¿ç”¨é¢‘ç‡å®åœ¨æ˜¯å¤ªé«˜äº†ï¼Œæ‰€ä»¥ Java è™šæ‹Ÿæœºä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å¼€é”€ï¼Œåœ¨åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡çš„æ—¶å€™è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œç‰¹æ„ä¸ºå­—ç¬¦ä¸²å¼€è¾Ÿäº†ä¸€å—ç©ºé—´â€”â€”ä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨åŒå¼•å·çš„æ–¹å¼æ¥åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œè€Œä¸æ˜¯é€šè¿‡ new å…³é”®å­—çš„æ–¹å¼(**new çš„æ–¹å¼å§‹ç»ˆä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œä¸ç®¡å­—ç¬¦ä¸²çš„å†…å®¹æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œè€ŒåŒå¼•å·çš„æ–¹å¼ä¼šé‡å¤åˆ©ç”¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨çš„å¯¹è±¡**)ï¼Œå°±åƒä¸‹é¢ğŸ‘‡ğŸ»è¿™æ ·ï¼Œè¿™æ ·å°±ä¸ä¼šå¤šæ­¤ä¸€ä¸¾ï¼š

```java
 String s = "ä¸‰å¦¹";
```

å½“æ‰§è¡Œ `String s = "ä¸‰å¦¹"` æ—¶ï¼ŒJava è™šæ‹Ÿæœºä¼šå…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰â€œä¸‰å¦¹â€è¿™ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¸åˆ›å»ºä»»ä½•å¯¹è±¡ï¼Œç›´æ¥å°†å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­è¿™ä¸ªâ€œä¸‰å¦¹â€çš„å¯¹è±¡åœ°å€è¿”å›ï¼Œèµ‹ç»™å˜é‡ sï¼›å¦‚æœæ²¡æœ‰ï¼Œåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºâ€œä¸‰å¦¹â€è¿™ä¸ªå¯¹è±¡ï¼Œç„¶åå°†å…¶åœ°å€è¿”å›ï¼Œèµ‹ç»™å˜é‡ sã€‚

<img src="http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/string//constant-pool-80ca8b18-2446-431e-98e3-b194e1c608e3.png" alt="img" style="zoom:50%;" />

ä¾‹å­1ï¼š

```java
String s = new String("äºŒå“¥");
String s1 = new String("äºŒå“¥");
```

æŒ‰ç…§æˆ‘ä»¬ä¹‹å‰çš„åˆ†æï¼Œè¿™ä¸¤è¡Œä»£ç ä¼šåˆ›å»ºä¸‰ä¸ªå¯¹è±¡ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¸€ä¸ªï¼Œå †ä¸Šä¸¤ä¸ª



ä¾‹å­2ï¼š

```java
String s = "ä¸‰å¦¹";
String s1 = "ä¸‰å¦¹";
```

è¿™ä¸¤è¡Œä»£ç åªä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°±æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„é‚£ä¸ª



ä¾‹å­3ï¼š

```java
String s0="äºŒå“¥";  //å…ˆåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»º"äºŒå“¥"
String s = new String("äºŒå“¥"); //å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»æœ‰äº†ï¼Œåªéœ€è¦åœ¨å †ä¸­åˆ›å»ºnew String()
String s1 = new String("äºŒå“¥"); //å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»æœ‰äº†ï¼ŒåŒæ ·åªéœ€è¦åœ¨å †ä¸­åˆ›å»º
```

`s0`ã€`s` å’Œ `s1` è¿™ä¸‰ä¸ªå¼•ç”¨æŒ‡å‘çš„æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œå³ä½¿å®ƒä»¬çš„å†…å®¹éƒ½æ˜¯ "äºŒå“¥"ã€‚å› æ­¤ï¼Œå°½ç®¡å®ƒä»¬çš„å“ˆå¸Œç ç›¸åŒï¼ˆå› ä¸º`hashCode()`æ˜¯åŸºäºå†…å®¹è®¡ç®—çš„ï¼ŒStringç±»é‡å†™äº†`hashcode()`æ–¹æ³•ï¼‰ï¼Œä½†å®ƒä»¬æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡









### String.intern()ç”¨æ³•

> å‰è¨€ï¼š
>
> ç¬¬ä¸€ï¼Œä½¿ç”¨åŒå¼•å·å£°æ˜çš„å­—ç¬¦ä¸²å¯¹è±¡ä¼šä¿å­˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­
>
> ç¬¬äºŒï¼Œä½¿ç”¨ `new` å…³é”®å­—åˆ›å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡ä¼šå…ˆä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°å°±åˆ›å»ºä¸€ä¸ªæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œç„¶åå†åœ¨å †ä¸­åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡ï¼›å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±åªéœ€è¦åœ¨å †ä¸­åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡å³å¯
>
> 
>
> Java 7 ä¹‹å‰ï¼Œæ‰§è¡Œ `String.intern()` æ–¹æ³•çš„æ—¶å€™ï¼Œä¸ç®¡å¯¹è±¡åœ¨å †ä¸­æ˜¯å¦å·²ç»åˆ›å»ºï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä»ç„¶ä¼šåˆ›å»ºä¸€ä¸ªå†…å®¹å®Œå…¨ç›¸åŒçš„æ–°å¯¹è±¡ï¼Œç„¶åè¿”å›å¸¸é‡æ± ä¸­è¯¥å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨ï¼› Java 7 ä¹‹åå‘¢ï¼Œç”±äºå­—ç¬¦ä¸²å¸¸é‡æ± æ”¾åœ¨äº†å †ä¸­ï¼Œæ‰§è¡Œ `String.intern()` æ–¹æ³•çš„æ—¶å€™ï¼Œ**å¦‚æœå¯¹è±¡åœ¨å †ä¸­å·²ç»åˆ›å»ºäº†ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å°±ä¸éœ€è¦å†åˆ›å»ºæ–°çš„å¯¹è±¡äº†ï¼Œè€Œæ˜¯ç›´æ¥ä¿å­˜å †ä¸­å¯¹è±¡çš„å¼•ç”¨**ï¼Œä¹Ÿå°±èŠ‚çœäº†ä¸€éƒ¨åˆ†çš„å†…å­˜ç©ºé—´
>
> 

`String.intern()` æ˜¯ä¸€ä¸ª nativeï¼ˆæœ¬åœ°ï¼‰æ–¹æ³•ï¼Œå…¶ä½œç”¨æ˜¯**è¿”å›æŒ‡å®šå­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€**ï¼Œå…·ä½“è¿”å›å“ªä¸ªï¼Œå¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š

- **å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¿å­˜äº†å¯¹åº”çš„å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨ï¼Œå°±ç›´æ¥è¿”å›è¯¥å¼•ç”¨**

- å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ²¡æœ‰ä¿å­˜äº†å¯¹åº”çš„å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£å°±åœ¨å¸¸é‡æ± ä¸­åˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥å­—ç¬¦ä¸²å¯¹è±¡(**è¿™æ—¶çš„å­—ç¬¦ä¸²å¯¹è±¡ä¸Šå­˜åœ¨äºå †ä¸­ï¼Œå³å¸¸é‡æ± ä¸­çš„å¼•ç”¨æŒ‡å‘å †ä¸­Stringç±»å¯¹è±¡**)çš„å¼•ç”¨å¹¶è¿”å›



è¿˜æ˜¯ä»¥ä¾‹å­æ¥è¯´æ˜å§ï¼Œä¾‹å­1ï¼š

```java
String s1 = new String("äºŒå“¥ä¸‰å¦¹");
String s2 = s1.intern();
System.out.println(s1 == s2);   //false
```

ç¬¬ä¸€è¡Œä»£ç ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¼šå…ˆåˆ›å»ºä¸€ä¸ªâ€œäºŒå“¥ä¸‰å¦¹â€çš„å¯¹è±¡ï¼Œç„¶åå †ä¸­ä¼šå†åˆ›å»ºä¸€ä¸ªâ€œäºŒå“¥ä¸‰å¦¹â€çš„å¯¹è±¡ï¼Œs1 å¼•ç”¨çš„æ˜¯å †ä¸­çš„å¯¹è±¡ã€‚

ç¬¬äºŒè¡Œä»£ç ï¼Œå¯¹ s1 æ‰§è¡Œ `intern()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥æ‰¾â€œäºŒå“¥ä¸‰å¦¹â€è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œæ­¤æ—¶æ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥ s2 å¼•ç”¨çš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡ã€‚

ä¹Ÿå°±æ„å‘³ç€ s1 å’Œ s2 çš„å¼•ç”¨åœ°å€æ˜¯ä¸åŒçš„ï¼Œä¸€ä¸ªæ¥è‡ªå †ï¼Œä¸€ä¸ªæ¥è‡ªå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œæ‰€ä»¥è¾“å‡ºçš„ç»“æœä¸º `false`





ä¸Šé¢çš„ä¾‹å­1é’ˆå¯¹çš„æ˜¯**å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æœ‰ç›¸åº”å¯¹è±¡å®ä¾‹**çš„æƒ…å†µï¼Œå†æ¥çœ‹çœ‹ä¾‹å­2ï¼š

```java
String s1 = new String("äºŒå“¥") + new String("ä¸‰å¦¹");
String s2 = s1.intern();
System.out.println(s1 == s2);  //true
```

ç¬¬ä¸€è¡Œä»£ç ï¼Œä¼šåœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯â€œäºŒå“¥â€ï¼Œä¸€ä¸ªæ˜¯â€œä¸‰å¦¹â€ï¼Œç„¶ååœ¨å †ä¸­ä¼šåˆ›å»ºä¸¤ä¸ªåŒ¿åå¯¹è±¡â€œäºŒå“¥â€å’Œâ€œä¸‰å¦¹â€ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªâ€œäºŒå“¥ä¸‰å¦¹â€çš„å¯¹è±¡ï¼ˆç¨åä¼šè§£é‡Šï¼‰ï¼Œs1 å¼•ç”¨çš„æ˜¯å †ä¸­â€œäºŒå“¥ä¸‰å¦¹â€è¿™ä¸ªå¯¹è±¡ã€‚

ç¬¬äºŒè¡Œä»£ç ï¼Œå¯¹ `s1` æ‰§è¡Œ `intern()` æ–¹æ³•ï¼Œ**è¯¥æ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥æ‰¾â€œäºŒå“¥ä¸‰å¦¹â€è¿™ä¸ªå¯¹è±¡æ˜¯å¦å­˜åœ¨ï¼Œæ­¤æ—¶ä¸å­˜åœ¨çš„ï¼Œä½†å †ä¸­å·²ç»å­˜åœ¨äº†ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¿å­˜çš„æ˜¯å †ä¸­è¿™ä¸ªâ€œäºŒå“¥ä¸‰å¦¹â€å¯¹è±¡çš„å¼•ç”¨**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`s2` å’Œ `s1` çš„å¼•ç”¨åœ°å€æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥è¾“å‡ºçš„ç»“æœä¸º `true`!!



è¯´çš„è¯¦ç»†ç‚¹å°±æ˜¯ï¼š

1. åˆ›å»º "äºŒå“¥" å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚

2. åˆ›å»º "ä¸‰å¦¹" å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå­˜å‚¨åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚

3. æ‰§è¡Œ `new String("äºŒå“¥")`ï¼Œåœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå†…å®¹ä¸º "äºŒå“¥"ã€‚

4. æ‰§è¡Œ `new String("ä¸‰å¦¹")`ï¼Œåœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå†…å®¹ä¸º "ä¸‰å¦¹"ã€‚

5. æ‰§è¡Œ `new String("äºŒå“¥") + new String("ä¸‰å¦¹")`ï¼Œä¼šåˆ›å»ºä¸€ä¸ª `StringBuilder` å¯¹è±¡ï¼Œå¹¶å°† "äºŒå“¥" å’Œ "ä¸‰å¦¹" è¿½åŠ åˆ°å…¶ä¸­ï¼Œç„¶åè°ƒç”¨ `StringBuilder` å¯¹è±¡çš„ `toString()` æ–¹æ³•ï¼Œ**å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå†…å®¹ä¸º "äºŒå“¥ä¸‰å¦¹"ã€‚è¿™ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡å­˜å‚¨åœ¨å †ä¸Š**

   ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ç¼–è¯‘å™¨é‡åˆ° `+` å·è¿™ä¸ªæ“ä½œç¬¦çš„æ—¶å€™ï¼Œä¼šå°† `new String("äºŒå“¥") + new String("ä¸‰å¦¹")` è¿™è¡Œä»£ç ç¼–è¯‘ä¸ºä»¥ä¸‹ä»£ç ï¼š

   ```java
   new StringBuilder().append("äºŒå“¥").append("ä¸‰å¦¹").toString();
   ```

   å®é™…æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

   - åˆ›å»ºä¸€ä¸ª StringBuilder å¯¹è±¡ã€‚
   - åœ¨ StringBuilder å¯¹è±¡ä¸Šè°ƒç”¨ append("äºŒå“¥")ï¼Œå°† "äºŒå“¥" è¿½åŠ åˆ° StringBuilder ä¸­ã€‚
   - åœ¨ StringBuilder å¯¹è±¡ä¸Šè°ƒç”¨ append("ä¸‰å¦¹")ï¼Œå°† "ä¸‰å¦¹" è¿½åŠ åˆ° StringBuilder ä¸­ã€‚
   - åœ¨ StringBuilder å¯¹è±¡ä¸Šè°ƒç”¨ toString() æ–¹æ³•ï¼Œå°† StringBuilder è½¬æ¢ä¸ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå†…å®¹ä¸º "äºŒå“¥ä¸‰å¦¹"ã€‚







ä¾‹å­3(å®æˆ˜ä¸€ä¸‹)ï¼š


```java
// åœ¨å †ä¸­åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡â€Javaâ€œ
// å°†å­—ç¬¦ä¸²å¯¹è±¡â€Javaâ€œçš„å¼•ç”¨ä¿å­˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­
String s1 = "Java";
// ç›´æ¥è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­—ç¬¦ä¸²å¯¹è±¡â€Javaâ€œå¯¹åº”çš„å¼•ç”¨
String s2 = s1.intern();
// ä¼šåœ¨å †ä¸­åœ¨å•ç‹¬åˆ›å»ºä¸€ä¸ªStringå¯¹è±¡
String s3 = new String("Java");
// ç›´æ¥è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­—ç¬¦ä¸²å¯¹è±¡â€Javaâ€œå¯¹åº”çš„å¼•ç”¨
String s4 = s3.intern();
// s1 å’Œ s2 æŒ‡å‘çš„æ˜¯å †ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡
System.out.println(s1 == s2); // true


/* s3æŒ‡å‘çš„æ˜¯å †ä¸­(éå­—ç¬¦ä¸²å¸¸é‡æ± )new String("Java")å¯¹è±¡ï¼Œ
*  s3.intern()è¿”å›çš„åˆ™æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ "Java" çš„å¼•ç”¨ ï¼Œæ•…ä¸ç›¸ç­‰
*/
System.out.println(s3 == s4); // false


// s1 å’Œ s4 æŒ‡å‘çš„æ˜¯å †ä¸­çš„åŒä¸€ä¸ªå¯¹è±¡
System.out.println(s1 == s4); //true

```

  





```java
åœºæ™¯1ï¼š
String s1 = new String("ab")+new String("c");
s1.intern(); //å°†å †ä¸­é€šè¿‡StringBuilderåˆ›å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡"abc"çš„å¼•ç”¨æ¨é€åˆ°å¸¸é‡æ± ä¸­å»
String s2 = "abc";
System.out.println( s1 == s2);// true å› ä¸ºå¸¸é‡æ± åœ¨è¢«æ¨é€å¼•ç”¨ä¹‹å‰æ²¡æœ‰å­˜æ”¾"abc"å¯¹è±¡


åœºæ™¯2ï¼š

String s1 = new String("ab")+new String("c");
String s2 = "abc";
s1.intern();
System.out.println( s1 == s2);// false

```

åœºæ™¯1å’Œåœºæ™¯2çš„ä»£ç éƒ½æ˜¯å•ç‹¬æ‰§è¡Œçš„ï¼Œä½†æ˜¯å› ä¸º`s1.intern()`åœ¨çš„ä½ç½®ä¸ä¸€æ ·ï¼Œæ‰§è¡Œç»“æœå°±ä¸ä¸€æ ·ï¼Œå½“ç„¶å¯¹äºå†…å­˜ä¸­çš„æ´»åŠ¨ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼š

(1) åœºæ™¯1ä¸­ç¬¬ä¸€è¡Œè§£æçš„æ—¶å€™ä¼šåœ¨å †ä¸­åˆ›å»º"ab","c","abc"ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œæ­¤æ—¶s1æŒ‡å‘çš„æ˜¯å †ä¸­çš„"abc"ï¼Œè§£æåˆ°`s1.intern()`æ—¶ï¼Œä¼šå°†`s1`ä¸­çš„å¼•ç”¨æ¨é€åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚ç„¶ååœ¨è§£æ`String s2 = "abc"`æ—¶;**JVMä¼šå»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ£€æŸ¥"abc"çš„å¼•ç”¨ï¼Œå‘ç°å­˜åœ¨ï¼Œç›´æ¥è¿”å›ç»™`s2`**ï¼›

(2) åœºæ™¯2ä¸­`String s1 = new String("ab")+new String("c"); String s2 = "abc";`è§£æå®Œä¹‹ås1æŒ‡å‘çš„æ˜¯å †å†…å­˜ä¸­å­—ç¬¦ä¸²å¯¹è±¡ï¼Œs2æŒ‡å‘çš„æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­"abc"å¯¹è±¡ï¼Œå½“æ‰§è¡Œ`s1.intern();`çš„æ—¶å€™å‘ç°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»å­˜åœ¨"abc"çš„å¼•ç”¨ï¼Œæ•…ä»€ä¹ˆéƒ½ä¸åšã€‚æœ€åæ¯”è¾ƒ`s1 == s2`å®é™…æ˜¯æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å€¼ï¼Œæ‰€ä»¥ç»“æœæ˜¯falseã€‚ä½†æ˜¯å¦‚æœåœ¨åœºæ™¯2ä¸­åŠ ä¸€å¥`String s3=s1.intern();`ç„¶åæ¯”è¾ƒ`s2==s3`ï¼Œç»“æœä¼šæ˜¯trueï¼Œæ¯”è¾ƒ`s1==s3`ï¼Œç»“æœä¾ç„¶ä¼šæ˜¯falseï¼ŒåŸå› å°±ä¸èµ˜è¿°äº†





æ³¨æ„äº‹é¡¹ :grey_exclamation::grey_exclamation:

ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡ intern å¯ä»¥ç¡®ä¿æ‰€æœ‰å…·æœ‰ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²å…±äº«ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä½†ä¹Ÿä¸è¦æ»¥ç”¨ `intern()`ï¼Œå› ä¸ºä»»ä½•çš„ç¼“å­˜æ± éƒ½æ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œä¸èƒ½æ— ç¼˜æ— æ•…å°±å ç”¨ç›¸å¯¹ç¨€ç¼ºçš„ç¼“å­˜ç©ºé—´ï¼Œå¯¼è‡´å…¶ä»–å­—ç¬¦ä¸²æ²¡æœ‰å‘ä½å¯å ã€‚å› ä¸ºå­—ç¬¦ä¸²å¸¸é‡æ± æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„ `StringTable`ï¼Œå¦‚æœæ”¾è¿›å»çš„å­—ç¬¦ä¸²è¿‡å¤šï¼Œå°±ä¼šé€ æˆä¸¥é‡çš„å“ˆå¸Œå†²çªï¼Œä»è€Œå¯¼è‡´é“¾è¡¨å˜é•¿ï¼Œé“¾è¡¨å˜é•¿ä¹Ÿå°±æ„å‘³ç€å­—ç¬¦ä¸²å¸¸é‡æ± çš„æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ã€‚ã€‚ã€‚











## IOæ¨¡å‹(RPCè¦ç”¨ æœ€åå†çœ‹ :grey_exclamation: )



å¹³å¸¸å¼€å‘è¿‡ç¨‹ä¸­æ¥è§¦æœ€å¤šçš„å°±æ˜¯ **ç£ç›˜ IOï¼ˆè¯»å†™æ–‡ä»¶ï¼‰** å’Œ **ç½‘ç»œ IOï¼ˆç½‘ç»œè¯·æ±‚å’Œå“åº”ï¼‰**

UNIX ç³»ç»Ÿä¸‹ioæ¨¡å‹å…±æœ‰5ç§ï¼š**åŒæ­¥é˜»å¡ I/O**ã€**åŒæ­¥éé˜»å¡ I/O**ã€**I/O å¤šè·¯å¤ç”¨**ã€**ä¿¡å·é©±åŠ¨ I/O** å’Œ**å¼‚æ­¥ I/O**



### æ¶‰åŠåˆ°çš„è®¾è®¡æ¨¡å¼

æ€»ä½“æ¥è¯´è®¾è®¡æ¨¡å¼åˆ†ä¸ºä¸‰å¤§ç±»ï¼š

åˆ›å»ºå‹æ¨¡å¼ï¼Œå…±äº”ç§ï¼šå·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼ã€åŸå‹æ¨¡å¼

ç»“æ„å‹æ¨¡å¼ï¼Œå…±ä¸ƒç§ï¼šé€‚é…å™¨æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼ã€ä»£ç†æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€æ¡¥æ¥æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€äº«å…ƒæ¨¡å¼

è¡Œä¸ºå‹æ¨¡å¼ï¼Œå…±åä¸€ç§ï¼šç­–ç•¥æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€è¿­ä»£å­æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€å¤‡å¿˜å½•æ¨¡å¼ã€çŠ¶æ€æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼ã€ä¸­ä»‹è€…æ¨¡å¼ã€è§£é‡Šå™¨æ¨¡å¼


#### è£…é¥°å™¨æ¨¡å¼

**è£…é¥°å™¨ï¼ˆDecoratorï¼‰æ¨¡å¼** å¯ä»¥åœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹æ‹“å±•å…¶åŠŸèƒ½

è£…é¥°å™¨æ¨¡å¼é€šè¿‡**ç»„åˆæ›¿ä»£ç»§æ‰¿**æ¥æ‰©å±•åŸå§‹ç±»çš„åŠŸèƒ½ï¼Œåœ¨ä¸€äº›ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼ˆ`IO` è¿™ä¸€åœºæ™¯å„ç§ç±»çš„ç»§æ‰¿å…³ç³»å°±æ¯”è¾ƒå¤æ‚ï¼‰æ›´åŠ å®ç”¨ï¼Œé€‚åˆåœ¨ä¸æƒ³å¢åŠ å¾ˆå¤šå­ç±»çš„æƒ…å†µä¸‹æ‰©å±•ç±»

åœ¨è£…é¥°å™¨æ¨¡å¼ä¸­çš„è§’è‰²æœ‰ï¼š

- **æŠ½è±¡æ„ä»¶(Component)è§’è‰²ï¼š**ç»™å‡ºä¸€ä¸ªæŠ½è±¡æ¥å£ï¼Œå·²è§„èŒƒå‡†å¤‡æ¥æ”¶é™„åŠ è´£ä»»çš„å¯¹è±¡ã€‚
- **å…·ä½“æ„ä»¶(ConcreteComponent)è§’è‰²ï¼š**å®šä¹‰ä¸€ä¸ª**å°†è¦æ¥æ”¶é™„åŠ è´£ä»»**çš„ç±»
- **è£…é¥°å™¨(Decorator)è§’è‰²ï¼š**æŒæœ‰ä¸€ä¸ªæ„ä»¶(Component)å¯¹è±¡çš„å®ä¾‹ï¼Œå¹¶å®šä¹‰ä¸€ä¸ªä¸æŠ½è±¡æ„ä»¶æ¥å£ä¸€è‡´çš„æ¥å£
- **å…·ä½“è£…é¥°å™¨(ConcreteDecorator)è§’è‰²ï¼š**è´Ÿè´£ç»™å…·ä½“æ„ä»¶å¯¹è±¡â€œè´´ä¸Šâ€é™„åŠ çš„è´£ä»»

ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚å¥¶èŒ¶åº—æœ‰å¾ˆå¤šå¥¶èŒ¶ï¼Œæˆ‘å»ç‚¹ä¸€æ¯æ³¢éœ¸å¥¶èŒ¶ï¼Œå¥¶èŒ¶é‡Œé¢å¯ä»¥åŠ å„ç§é…æ–™ï¼Œæˆ‘éœ€è¦åœ¨æˆ‘çš„æ³¢éœ¸å¥¶èŒ¶é‡Œé¢åŠ çç ã€æ¤°æœé…æ–™ï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ï¼Œåˆ†æä¸€ä¸‹ï¼š

**å¥¶èŒ¶å±äºæŠ½è±¡æ„ä»¶**

**æ³¢éœ¸å¥¶èŒ¶å±äºå…·ä½“æ„ä»¶**

**é…æ–™å±äºè£…é¥°å™¨è§’è‰²**

**çç ã€æ¤°æœå±äºå…·ä½“è£…é¥°å™¨è§’è‰²**

çœ‹ä¸‹å›¾ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F.png)

å¯¹äºå­—èŠ‚æµæ¥è¯´ï¼Œ `FilterInputStream` ï¼ˆå¯¹åº”è¾“å…¥æµï¼‰å’Œ`FilterOutputStream`ï¼ˆå¯¹åº”è¾“å‡ºæµï¼‰æ˜¯è£…é¥°å™¨æ¨¡å¼çš„æ ¸å¿ƒï¼Œå¯ä»¥è¢«çœ‹ä½œä¸ºè£…é¥°å™¨`Decorator`,è¯¥`Decorator`åˆ†åˆ«è¢«ç”¨äºå¢å¼º `InputStream(æŠ½è±¡æ„ä»¶)` å’Œ`OutputStream`çš„å­ç±»å¯¹è±¡(**å…·ä½“æ„ä»¶**)çš„åŠŸèƒ½ï¼›

å¸¸è§çš„`BufferedInputStream`(å­—èŠ‚ç¼“å†²è¾“å…¥æµ)ã€`DataInputStream` ç­‰ç­‰éƒ½æ˜¯`FilterInputStream` çš„å­ç±»ï¼Œ`BufferedOutputStream`ï¼ˆå­—èŠ‚ç¼“å†²è¾“å‡ºæµï¼‰ã€`DataOutputStream`ç­‰ç­‰éƒ½æ˜¯`FilterOutputStream`çš„å­ç±»

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/DP-Decorator-java.io.png"  />

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `BufferedInputStream`ï¼ˆå­—èŠ‚ç¼“å†²è¾“å…¥æµï¼Œ**æ­¤å¤„ä½œä¸ºå…·ä½“è£…é¥°è§’è‰²**ï¼‰æ¥å¢å¼º `FileInputStream`(æ­¤å¤„æ˜¯**å…·ä½“æ„ä»¶**) çš„åŠŸèƒ½ï¼Œå³ï¼š

- `InputStream` æ˜¯æŠ½è±¡ç»„ä»¶ï¼›
- `FileInputStream` æ˜¯ `InputStream` çš„å­ç±»ï¼Œå±äºå…·ä½“ç»„ä»¶ï¼Œ**æä¾›äº†å­—èŠ‚æµçš„è¾“å…¥æ“ä½œ**ï¼›
- `FilterInputStream` å±äºæŠ½è±¡è£…é¥°è€…ï¼Œè£…é¥°è€…ç”¨äºè£…é¥°ç»„ä»¶ï¼Œä¸ºç»„ä»¶æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ **`BufferedInputStream` ä¸º `FileInputStream` æä¾›ç¼“å­˜çš„åŠŸèƒ½**

å®ä¾‹åŒ–ä¸€ä¸ªå…·æœ‰ç¼“å­˜åŠŸèƒ½çš„å­—èŠ‚æµå¯¹è±¡æ—¶ï¼Œåªéœ€è¦åœ¨ `FileInputStream` å¯¹è±¡ä¸Šå†å¥—ä¸€å±‚ `BufferedInputStream` å¯¹è±¡å³å¯ï¼Œ

```java
FileInputStream fileInputStream = new FileInputStream(filePath);
BufferedInputStream bufferedInputStream = new BufferedInputStream(fileInputStream);
```



å†æ¯”å¦‚`ZipInputStream` å’Œ`ZipOutputStream` è¿˜å¯ä»¥åˆ†åˆ«å¢å¼º `BufferedInputStream` å’Œ `BufferedOutputStream` çš„èƒ½åŠ›(éœ€è¦è¢«å¢å¼ºçš„å…·ä½“æ„ä»¶ä½œä¸ºå‚æ•°è¢«ä¼ å…¥)ï¼š

```java
BufferedInputStream bis = new BufferedInputStream(new FileInputStream(fileName));
ZipInputStream zis = new ZipInputStream(bis);//æ ¸å¿ƒ

BufferedOutputStream bos = new BufferedOutputStream(new FileOutputStream(fileName));
ZipOutputStream zipOut = new ZipOutputStream(bos);//æ ¸å¿ƒ
```







#### é€‚é…å™¨æ¨¡å¼(ä¸å¤ªä¼š)

**é€‚é…å™¨ï¼ˆAdapter Patternï¼‰æ¨¡å¼** ä¸»è¦**ç”¨äºæ¥å£äº’ä¸å…¼å®¹**çš„ç±»çš„åè°ƒå·¥ä½œ

é€‚é…å™¨æ¨¡å¼ï¼ˆAdapterï¼‰åŒ…å«ä»¥ä¸‹ä¸»è¦è§’è‰²ï¼š

- ç›®æ ‡ï¼ˆTargetï¼‰æ¥å£ï¼šå½“å‰ç³»ç»Ÿä¸šåŠ¡æ‰€æœŸå¾…çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–æ¥å£
- è¢«é€‚é…è€…ï¼ˆAdapteeï¼‰ç±»ï¼šå®ƒæ˜¯è¢«è®¿é—®å’Œé€‚é…çš„ç°å­˜ç»„ä»¶åº“ä¸­çš„ç»„ä»¶æ¥å£(è¢«é€‚é…çš„å¯¹è±¡)
- é€‚é…å™¨ï¼ˆAdapterï¼‰ç±»ï¼šå®ƒæ˜¯ä¸€ä¸ªè½¬æ¢å™¨ï¼Œé€šè¿‡ç»§æ‰¿æˆ–å¼•ç”¨é€‚é…è€…çš„å¯¹è±¡ï¼Œ**æŠŠé€‚é…è€…æ¥å£è½¬æ¢æˆç›®æ ‡æ¥å£ï¼Œè®©å®¢æˆ·æŒ‰ç›®æ ‡æ¥å£çš„æ ¼å¼è®¿é—®è¢«é€‚é…è€…**

IO æµä¸­çš„å­—ç¬¦æµå’Œå­—èŠ‚æµçš„æ¥å£ä¸åŒï¼Œå®ƒä»¬ä¹‹é—´å¯ä»¥åè°ƒå·¥ä½œå°±æ˜¯åŸºäºé€‚é…å™¨æ¨¡å¼æ¥åšçš„ï¼Œæ›´å‡†ç¡®ç‚¹æ¥è¯´æ˜¯å¯¹è±¡é€‚é…å™¨ã€‚é€šè¿‡é€‚é…å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å­—èŠ‚æµå¯¹è±¡(é€‚é…è€…)é€šè¿‡é€‚é…å™¨æˆä¸€ä¸ªå­—ç¬¦æµå¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å­—èŠ‚æµå¯¹è±¡æ¥è¯»å–æˆ–è€…å†™å…¥å­—ç¬¦æ•°æ®

`InputStreamReader` å’Œ `OutputStreamWriter` å°±æ˜¯ä¸¤ä¸ªé€‚é…å™¨(Adapter)ï¼Œ åŒæ—¶å®ƒä»¬ä¸¤ä¸ªä¹Ÿæ˜¯å­—èŠ‚æµå’Œå­—ç¬¦æµä¹‹é—´çš„æ¡¥æ¢ã€‚`InputStreamReader` ä½¿ç”¨ `StreamDecoder` ï¼ˆæµè§£ç å™¨ï¼‰å¯¹å­—èŠ‚è¿›è¡Œè§£ç ï¼Œ**å®ç°å­—èŠ‚æµåˆ°å­—ç¬¦æµçš„è½¬æ¢ï¼Œ**`OutputStreamWriter` ä½¿ç”¨`StreamEncoder`ï¼ˆæµç¼–ç å™¨ï¼‰å¯¹å­—ç¬¦è¿›è¡Œç¼–ç ï¼Œå®ç°å­—ç¬¦æµåˆ°å­—èŠ‚æµçš„è½¬æ¢

`InputStream` å’Œ `OutputStream` çš„**å­ç±»**(**FileInputStream**)æ˜¯è¢«é€‚é…è€…ï¼Œ `InputStreamReader` å’Œ `OutputStreamWriter`æ˜¯é€‚é…å™¨

```JAVA
// InputStreamReader æ˜¯é€‚é…å™¨ï¼ŒFileInputStream æ˜¯è¢«é€‚é…çš„ç±»
InputStreamReader isr = new InputStreamReader(new FileInputStream(fileName), "UTF-8");
// BufferedReader å¢å¼º InputStreamReader çš„åŠŸèƒ½ï¼ˆè£…é¥°å™¨æ¨¡å¼ï¼‰
BufferedReader bufferedReader = new BufferedReader(isr);
```



**é€‚é…å™¨æ¨¡å¼å’Œè£…é¥°å™¨æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ**

**è£…é¥°å™¨æ¨¡å¼** æ›´ä¾§é‡äºåŠ¨æ€åœ°å¢å¼ºåŸå§‹ç±»çš„åŠŸèƒ½ï¼Œ**è£…é¥°å™¨ç±»**éœ€è¦è·Ÿ**å…·ä½“æ„ä»¶ç±»**ç»§æ‰¿ç›¸åŒçš„æŠ½è±¡ç±»æˆ–è€…å®ç°ç›¸åŒçš„æ¥å£ã€‚å¹¶ä¸”ï¼Œè£…é¥°å™¨æ¨¡å¼æ”¯æŒå¯¹åŸå§‹ç±»(**å…·ä½“æ„ä»¶ç±»**)åµŒå¥—ä½¿ç”¨å¤šä¸ªè£…é¥°å™¨(`Decorator`)

**é€‚é…å™¨æ¨¡å¼** æ›´ä¾§é‡äºè®©æ¥å£ä¸å…¼å®¹è€Œä¸èƒ½äº¤äº’çš„ç±»å¯ä»¥ä¸€èµ·å·¥ä½œï¼Œå½“æˆ‘ä»¬è°ƒç”¨é€‚é…å™¨å¯¹åº”çš„æ–¹æ³•æ—¶ï¼Œé€‚é…å™¨å†…éƒ¨ä¼šè°ƒç”¨é€‚é…è€…ç±»æˆ–è€…å’Œé€‚é…ç±»ç›¸å…³çš„ç±»çš„æ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹é€æ˜çš„ã€‚å°±æ¯”å¦‚è¯´ `StreamDecoder` ï¼ˆæµè§£ç å™¨ï¼‰å’Œ`StreamEncoder`ï¼ˆæµç¼–ç å™¨ï¼‰å°±æ˜¯åˆ†åˆ«åŸºäº `InputStream` å’Œ `OutputStream` æ¥è·å– `FileChannel`å¯¹è±¡å¹¶è°ƒç”¨å¯¹åº”çš„ `read` æ–¹æ³•å’Œ `write` æ–¹æ³•è¿›è¡Œå­—èŠ‚æ•°æ®çš„è¯»å–å’Œå†™å…¥

é€‚é…å™¨å’Œé€‚é…è€…ä¸¤è€…ä¸éœ€è¦ç»§æ‰¿ç›¸åŒçš„æŠ½è±¡ç±»æˆ–è€…å®ç°ç›¸åŒçš„æ¥å£





#### è§‚å¯Ÿè€…æ¨¡å¼

è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œè¿™ä¸ªä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€ä¸Šå‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œè®©ä»–ä»¬èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°è‡ªå·±ï¼Œè§‚å¯Ÿè€…æ¨¡å¼ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»è§’è‰²:

1. æŠ½è±¡ä¸»é¢˜ï¼ˆSubjectï¼‰è§’è‰²ï¼šä¹Ÿå«æŠ½è±¡ç›®æ ‡ç±»ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª**ç”¨äºä¿å­˜è§‚å¯Ÿè€…å¯¹è±¡çš„èšé›†ç±»**å’Œå¢åŠ ã€åˆ é™¤è§‚å¯Ÿè€…å¯¹è±¡çš„æ–¹æ³•ï¼Œä»¥åŠé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…çš„æŠ½è±¡æ–¹æ³•
2. å…·ä½“ä¸»é¢˜ï¼ˆConcrete Subjectï¼‰è§’è‰²ï¼šä¹Ÿå«å…·ä½“ç›®æ ‡ç±»ï¼Œå®ƒå®ç°æŠ½è±¡ç›®æ ‡ä¸­çš„é€šçŸ¥æ–¹æ³•ï¼Œå½“å…·ä½“ä¸»é¢˜çš„å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰æ³¨å†Œè¿‡çš„è§‚å¯Ÿè€…å¯¹è±¡
3. æŠ½è±¡è§‚å¯Ÿè€…ï¼ˆObserverï¼‰è§’è‰²ï¼šå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»æˆ–æ¥å£ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæ›´æ–°è‡ªå·±çš„æŠ½è±¡æ–¹æ³•ï¼Œå½“æ¥åˆ°å…·ä½“ä¸»é¢˜çš„æ›´æ”¹é€šçŸ¥æ—¶è¢«è°ƒç”¨
4. å…·ä½“è§‚å¯Ÿè€…ï¼ˆConcrete Observerï¼‰è§’è‰²ï¼šå®ç°æŠ½è±¡è§‚å¯Ÿè€…ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨å¾—åˆ°ç›®æ ‡çš„æ›´æ”¹é€šçŸ¥æ—¶æ›´æ–°è‡ªèº«çš„çŠ¶æ€

åœ¨ Java ä¸­ï¼Œé€šè¿‡ `java.util.Observable` ç±»å’Œ `java.util.Observer` æ¥å£å®šä¹‰äº†è§‚å¯Ÿè€…æ¨¡å¼ï¼Œåªè¦å®ç°å®ƒä»¬çš„å­ç±»å°±å¯ä»¥ç¼–å†™è§‚å¯Ÿè€…æ¨¡å¼å®ä¾‹

`Observable` ç±»æ˜¯æŠ½è±¡ç›®æ ‡ç±»ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰ï¼Œå®ƒæœ‰ä¸€ä¸ª Vector é›†åˆæˆå‘˜å˜é‡ï¼Œç”¨äºä¿å­˜æ‰€æœ‰è¦é€šçŸ¥çš„è§‚å¯Ÿè€…å¯¹è±¡ä¸‹é¢æ¥ä»‹ç»å®ƒæœ€é‡è¦çš„ 3 ä¸ªæ–¹æ³•:

- void `addObserver`(Observer o) æ–¹æ³•ï¼šç”¨äºå°†æ–°çš„è§‚å¯Ÿè€…å¯¹è±¡æ·»åŠ åˆ°é›†åˆä¸­ã€‚
- void `notifyObservers`(Object arg) æ–¹æ³•ï¼š**è°ƒç”¨é›†åˆä¸­çš„æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„ update æ–¹æ³•**ï¼Œé€šçŸ¥å®ƒä»¬æ•°æ®å‘ç”Ÿæ”¹å˜ã€‚é€šå¸¸è¶Šæ™šåŠ å…¥é›†åˆçš„è§‚å¯Ÿè€…è¶Šå…ˆå¾—åˆ°é€šçŸ¥
- void `setChange`() æ–¹æ³•ï¼šç”¨æ¥è®¾ç½®ä¸€ä¸ª boolean ç±»å‹çš„å†…éƒ¨æ ‡å¿—ï¼Œæ³¨æ˜ç›®æ ‡å¯¹è±¡å‘ç”Ÿäº†å˜åŒ–ã€‚**å½“å®ƒä¸ºtrueæ—¶ï¼ŒnotifyObservers() æ‰ä¼šé€šçŸ¥è§‚å¯Ÿè€…**,å³`notifyObservers`()è¦é¦–å…ˆæ£€æŸ¥è¯¥å˜é‡æ˜¯å¦ä¸ºtrue,å¦‚æœä¸ºfalseå°±ä¸æ‰§è¡Œè€Œç›´æ¥è¿”å›äº†

`Observer` æ¥å£æ˜¯æŠ½è±¡è§‚å¯Ÿè€…ï¼Œå®ƒç›‘è§†ç›®æ ‡å¯¹è±¡çš„å˜åŒ–ï¼Œå½“ç›®æ ‡å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§‚å¯Ÿè€…å¾—åˆ°é€šçŸ¥ï¼Œå¹¶è°ƒç”¨ `update` æ–¹æ³•ï¼Œè¿›è¡Œç›¸åº”çš„å·¥ä½œ

æ ¹æ®ä¸Šè¿°æè¿°ï¼Œ**å¦‚ä½•åŸºäºJavaå†…ç½®çš„è§‚å¯Ÿè€…æ¨¡å¼æ¡†æ¶å®ç°ä¸€ä¸ªè§‚å¯Ÿè€…æ¨¡å¼å‘¢ï¼Ÿ**

1. å†™ä¸€ä¸ªç±»(å…·ä½“ä¸»é¢˜è§’è‰²)ç»§æ‰¿Observableï¼ˆæŠ½è±¡ä¸»é¢˜è§’è‰²ï¼‰ï¼Œåªéœ€è¦å†™ä¸€ä¸ªchangeæ–¹æ³•å³å¯ (è¯¥æ–¹æ³•ä½œç”¨æ˜¯é€šçŸ¥å·²æ³¨å†Œçš„å…·ä½“ä¸»é¢˜è§’è‰²æ›´æ–°è‡ªå·±)
2. å†™ä¸€ä¸ªç±»(å…·ä½“è§‚å¯Ÿè€…è§’è‰²)å®ç°Observerï¼ˆæŠ½è±¡è§‚å¯Ÿè€…è§’è‰²ï¼‰ï¼Œåªéœ€è¦å®ç°æ–¹æ³•update(Observable o, Object arg)å³å¯
3. å†™ä¸€ä¸ªæµ‹è¯•ç±»è¿›è¡Œæµ‹è¯•



ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè­¦å¯Ÿç›‘è§†å°å·ï¼Œè­¦å¯Ÿå……å½“è§‚å¯Ÿè€…ï¼Œå°å·å……å½“è¢«è§‚å¯Ÿè€…ï¼Œä»£ç å¦‚ä¸‹ï¼š

å°å·æ˜¯ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ï¼Œæ‰€ä»¥éœ€è¦ç»§æ‰¿`Observable`ç±»ï¼š

```java
import java.util.Observable;

public class Thief extends Observable {
    private String name;
//çœç•¥ getã€setï¼Œæ„é€ æ–¹æ³•

    public void steal() {
        System.out.println("å°å·ï¼šæˆ‘å·ä¸œè¥¿ï¼Œæœ‰æ²¡æœ‰äººæ¥æŠ“æˆ‘ï¼ï¼ï¼");
        super.setChanged();//é»˜è®¤ä¸ºtrue
        super.notifyObservers();
    }
}
```

è­¦å¯Ÿæ˜¯ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œæ‰€ä»¥éœ€è¦è®©å…¶å®ç°Observeræ¥å£

```java
import java.util.Observable;
import java.util.Observer;
public class Policemen implements Observer {

    private String name;
    //çœç•¥
    @Override
    public void update(Observable o, Object arg) {
        System.out.println("è­¦å¯Ÿï¼š" + ((Thief) o).getName() + "ä½ è¢«æˆ‘æŠ“åˆ°äº†å“ˆå“ˆå“ˆå“ˆï¼ï¼ï¼");
    }
}
```



å®¢æˆ·ç«¯ä»£ç ï¼š

```java
public class Client {
    public static void main(String[] args) {
        //å°å·å¯¹è±¡
        Thief thief = new Thief("æ³•å¤–ç‹‚å¾’å¼ ä¸‰");
        //è­¦å¯Ÿå¯¹è±¡
        Policemen policemen = new Policemen("å°åº„è­¦å¯Ÿ");
        //æŠŠè­¦å¯Ÿæ³¨å†Œä¸ºå°å·çš„è§‚å¯Ÿè€…
        thief.addObserver(policemen);
        //å…ˆè®¾ç½®setChanged()çš„flagä¸ºtrueï¼Œéšåè°ƒç”¨notifyObnservers()ï¼Œæ¥é€šçŸ¥é›†åˆä¸­æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡è°ƒç”¨å…¶çš„update() æ–¹æ³•
        thief.steal();
    }
}
```



### Unixä¸­çš„IOæ¨¡å‹



é˜»å¡å’Œéé˜»å¡çš„æ¦‚å¿µæè¿°çš„æ˜¯ç”¨æˆ·çº¿ç¨‹è°ƒç”¨å†…æ ¸IOæ“ä½œçš„æ–¹å¼ï¼Œé˜»å¡æ—¶æŒ‡IOæ“ä½œéœ€è¦å½»åº•å®Œæˆåæ‰èƒ½è¿”å›ç”¨æˆ·ç©ºé—´ï¼Œ**éé˜»å¡æ—¶æŒ‡IOæ“ä½œè¢«è°ƒç”¨åç«‹å³è¿”å›ç»™ç”¨æˆ·ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œæ— éœ€ç­‰å¾…IOæ“ä½œå½»åº•å®Œæˆ**





**é˜»å¡å¼IOï¼š**

åº”ç”¨è¿›ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå°†æ•°æ®å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºä¸­æ‰è¿”å›ï¼Œæ³¨æ„**åœ¨é˜»å¡çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®ƒç¨‹åºè¿˜å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤é˜»å¡ä¸æ„å‘³ç€æ•´ä¸ªæ“ä½œç³»ç»Ÿéƒ½è¢«é˜»å¡ã€‚å› ä¸ºå…¶ä»–ç¨‹åºè¿˜å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤ä¸æ¶ˆè€— CPU æ—¶é—´**ï¼Œè¿™ç§æ¨¡å‹çš„æ‰§è¡Œæ•ˆç‡ä¼šæ¯”è¾ƒé«˜ã€‚

ä¸‹å›¾ä¸­ï¼Œ`recvfrom` ç”¨äºæ¥æ”¶ `Socket` ä¼ æ¥çš„æ•°æ®ï¼Œå¹¶å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹çš„ç¼“å†²åŒºbufä¸­ã€‚è¿™é‡ŒæŠŠ `recvfrom()` å½“æˆç³»ç»Ÿè°ƒç”¨

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-io-model-0.png)





**éé˜»å¡å¼IOï¼š**

åº”ç”¨è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†…æ ¸ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ç ï¼Œåº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ï¼Œ**ä½†æ˜¯éœ€è¦ä¸æ–­çš„æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ¥è·çŸ¥ I/O æ˜¯å¦å®Œæˆ**ï¼Œè¿™ç§æ–¹å¼ç§°ä¸º**è½®è¯¢(polling)**ï¼Œç”±äº CPU è¦å¤„ç†æ›´å¤šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤è¿™ç§æ¨¡å‹æ˜¯æ¯”è¾ƒä½æ•ˆçš„

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-io-model-1.png)





**ä¿¡å·é©±åŠ¨IO**ï¼š

åº”ç”¨è¿›ç¨‹ä½¿ç”¨ `sigaction` ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸ç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´**ç­‰å¾…æ•°æ®é˜¶æ®µåº”ç”¨è¿›ç¨‹æ˜¯éé˜»å¡çš„**ã€‚å†…æ ¸åœ¨æ•°æ®åˆ°è¾¾æ—¶å‘åº”ç”¨è¿›ç¨‹å‘é€ SIGIO ä¿¡å·**ï¼Œåº”ç”¨è¿›ç¨‹æ”¶åˆ°ä¹‹ååœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­è°ƒç”¨ `recvfrom` å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹ä¸­**ï¼Œå³åº”ç”¨è¿›ç¨‹æƒ³å‘é€/æ¥æ”¶æ•°æ®å‰å…ˆå‘ä¸ªä¿¡å·è¡¨ç¤ºæ„æ„¿ï¼Œç­‰å¾…å†…æ ¸é€šçŸ¥å¯ä»¥è¿›è¡Œæ“ä½œæ—¶å†é˜»å¡è‡ªå·±å®Œæˆæ•°æ®ä¼ è¾“

ç›¸æ¯”äºéé˜»å¡å¼ I/O çš„è½®è¯¢æ–¹å¼ï¼Œä¿¡å·é©±åŠ¨ I/O çš„ CPU åˆ©ç”¨ç‡æ›´é«˜

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-io-model-3.png" style="zoom:100%;" />



**å¼‚æ­¥IOï¼š**

åº”ç”¨è¿›ç¨‹è¿›è¡Œ `aio_read` ç³»ç»Ÿè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œåº”ç”¨è¿›ç¨‹ç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œå†…æ ¸ä¼šåœ¨æ‰€æœ‰æ“ä½œå®Œæˆä¹‹åå‘åº”ç”¨è¿›ç¨‹å‘é€ä¿¡å·

å¼‚æ­¥ I/O ä¸ä¿¡å·é©±åŠ¨ I/O çš„åŒºåˆ«åœ¨äºï¼š**å¼‚æ­¥ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹ I/O å®Œæˆï¼Œè€Œä¿¡å·é©±åŠ¨ I/O çš„ä¿¡å·æ˜¯é€šçŸ¥åº”ç”¨è¿›ç¨‹å¯ä»¥å¼€å§‹ I/O**

å¼‚æ­¥I/Oä¸åŒæ­¥I/Oçš„åŒºåˆ«åœ¨äºï¼šåŒæ­¥ I/Oåº”ç”¨è¿›ç¨‹åœ¨è°ƒç”¨ `recvfrom` æ“ä½œæ—¶(å³æ•°æ®ä¼ è¾“çš„è¿‡ç¨‹)ä¼šé˜»å¡ï¼Œè€Œå¼‚æ­¥ I/O**ä¸ä¼šé˜»å¡**è¿›ç¨‹ï¼Œä¸”é˜»å¡å¼ I/Oã€éé˜»å¡å¼ I/Oã€I/O å¤ç”¨å’Œä¿¡å·é©±åŠ¨ I/O éƒ½æ˜¯åŒæ­¥ I/Oï¼Œè™½ç„¶**éé˜»å¡å¼ I/O å’Œä¿¡å·é©±åŠ¨ I/O åœ¨ç­‰å¾…æ•°æ®é˜¶æ®µä¸ä¼šé˜»å¡(é˜»å¡å¼I/Oå’Œ I/Oå¤ç”¨åœ¨ç­‰å¾…æ•°æ®æ—¶å°±ä¼šè¿›å…¥é˜»å¡)ï¼Œä½†æ˜¯åœ¨ä¹‹åçš„å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨è¿›ç¨‹è¿™ä¸ªæ“ä½œä¼šé˜»å¡**





> å†æ¥ä¸€ä¸ªä¾‹å­åŠ æ·±ä¸€ä¸‹ç†è§£ï¼š
>
> åŒæ­¥é˜»å¡æ¨¡å¼ï¼šè¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬çš„å·¥ä½œæ¨¡å¼æ˜¯å…ˆæ¥åˆ°å¨æˆ¿ï¼Œå¼€å§‹çƒ§æ°´ï¼Œå¹¶ååœ¨æ°´å£¶é¢å‰ä¸€ç›´ç­‰ç€æ°´çƒ§å¼€ã€‚
>
> åŒæ­¥éé˜»å¡æ¨¡å¼ï¼šè¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬çš„å·¥ä½œæ¨¡å¼æ˜¯å…ˆæ¥åˆ°å¨æˆ¿ï¼Œå¼€å§‹çƒ§æ°´ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸ä¸€ç›´ååœ¨æ°´å£¶å‰é¢ç­‰ï¼Œè€Œæ˜¯å›åˆ°å®¢å…çœ‹ç”µè§†ï¼Œç„¶åæ¯éš”å‡ åˆ†é’Ÿåˆ°å¨æˆ¿çœ‹ä¸€ä¸‹æ°´æœ‰æ²¡æœ‰çƒ§å¼€ã€‚
>
> å¼‚æ­¥éé˜»å¡ I/O æ¨¡å‹ï¼šè¿™ç§æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬çš„å·¥ä½œæ¨¡å¼æ˜¯å…ˆæ¥åˆ°å¨æˆ¿ï¼Œå¼€å§‹çƒ§æ°´ï¼Œæˆ‘ä»¬ä¸ä¸€ç›´ååœ¨æ°´å£¶å‰é¢ç­‰ï¼Œä¹Ÿä¸éš”ä¸€æ®µæ—¶é—´å»çœ‹ä¸€ä¸‹ï¼Œè€Œæ˜¯åœ¨å®¢å…çœ‹ç”µè§†ï¼Œæ°´å£¶ä¸Šé¢æœ‰ä¸ªå¼€å…³ï¼Œæ°´çƒ§å¼€ä¹‹åä»–ä¼šé€šçŸ¥æˆ‘ã€‚
>
> é˜»å¡ VS éé˜»å¡ï¼šäººæ˜¯å¦ååœ¨æ°´å£¶å‰é¢ä¸€ç›´ç­‰ã€‚
>
> åŒæ­¥ VS å¼‚æ­¥ï¼šæ°´å£¶æ˜¯ä¸æ˜¯åœ¨æ°´çƒ§å¼€ä¹‹åä¸»åŠ¨é€šçŸ¥äººã€‚







### **IOå¤šè·¯å¤ç”¨**



IOå¤šè·¯å¤ç”¨å®é™…ä¸Šå±äº`NIO`



ä½¿ç”¨ `select` ã€ `poll` ã€`epoll`ç­‰å¾…æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ä¸­çš„ä»»ä½•ä¸€ä¸ªå˜ä¸ºå¯è¯»ï¼Œè¿™ä¸€è¿‡ç¨‹ä¼šè¢«é˜»å¡ï¼Œ**å½“æŸä¸€ä¸ªå¥—æ¥å­—å¯è¯»æ—¶è¿”å›**ï¼Œä¹‹åå†ä½¿ç”¨ `recvfrom` æŠŠæ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨ç¼“å†²åŒºä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹æœŸé—´ç›‘å¬çš„è¿›ç¨‹é˜»å¡ï¼Œ**IOå¤šè·¯å¤ç”¨ä½¿ç”¨ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨**ï¼ˆ`select/poll/epoll`å’Œ`recvfrom`ï¼‰ï¼Œ`blocking IO`è°ƒç”¨äº†`recvfrom`ï¼Œ`select/poll/epoll`æ ¸å¿ƒæ˜¯å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ª`connection`ï¼Œè€Œä¸æ˜¯æ›´å¿«ï¼Œæ‰€ä»¥è¿æ¥æ•°ä¸é«˜çš„è¯ï¼Œæ€§èƒ½ä¸ä¸€å®šæ¯”å¤šçº¿ç¨‹+é˜»å¡IOå¥½

**å®ƒå¯ä»¥è®©å•ä¸ªè¿›ç¨‹å…·æœ‰å¤„ç†å¤šä¸ª I/O äº‹ä»¶çš„èƒ½åŠ›**

å¦‚æœä¸€ä¸ª Web æœåŠ¡å™¨æ²¡æœ‰ I/O å¤ç”¨ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ª `Socket` è¿æ¥éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ã€‚å¦‚æœåŒæ—¶æœ‰å‡ ä¸‡ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ›å»ºç›¸åŒæ•°é‡çš„çº¿ç¨‹ã€‚å¹¶ä¸”ç›¸æ¯”äºå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ï¼ŒI/O å¤ç”¨ä¸éœ€è¦è¿›ç¨‹çº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢çš„å¼€é”€ï¼Œç³»ç»Ÿå¼€é”€æ›´å°

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-io-model-2.png)

å…¸å‹çš„å¤šè·¯å¤ç”¨IOå®ç°æœ‰ä»¥ä¸‹å‡ ç§ï¼š

| IOæ¨¡å‹ | ç›¸å¯¹æ€§èƒ½ | å…³é”®æ€è·¯         | æ“ä½œç³»ç»Ÿ      | JAVAæ”¯æŒæƒ…å†µ                                                 |
| ------ | -------- | ---------------- | ------------- | ------------------------------------------------------------ |
| select | è¾ƒé«˜     | Reactor          | windows/Linux | æ”¯æŒ,Reactoræ¨¡å¼(ååº”å™¨è®¾è®¡æ¨¡å¼)ã€‚Linuxæ“ä½œç³»ç»Ÿçš„ kernels 2.4å†…æ ¸ç‰ˆæœ¬ä¹‹å‰ï¼Œé»˜è®¤ä½¿ç”¨selectï¼›è€Œç›®å‰windowsä¸‹å¯¹åŒæ­¥IOçš„æ”¯æŒï¼Œéƒ½æ˜¯selectæ¨¡å‹ |
| poll   | è¾ƒé«˜     | Reactor          | Linux         | Linuxä¸‹çš„JAVA NIOæ¡†æ¶ï¼ŒLinux kernels 2.6å†…æ ¸ç‰ˆæœ¬ä¹‹å‰ä½¿ç”¨pollè¿›è¡Œæ”¯æŒã€‚ä¹Ÿæ˜¯ä½¿ç”¨çš„Reactoræ¨¡å¼ |
| epoll  | é«˜       | Reactor/Proactor | Linux         | Linux kernels 2.6å†…æ ¸ç‰ˆæœ¬åŠä»¥åä½¿ç”¨epollè¿›è¡Œæ”¯æŒï¼›Linux kernels 2.6å†…æ ¸ç‰ˆæœ¬ä¹‹å‰ä½¿ç”¨pollè¿›è¡Œæ”¯æŒï¼›å¦å¤–ä¸€å®šæ³¨æ„ï¼Œç”±äºLinuxä¸‹æ²¡æœ‰Windowsä¸‹çš„IOCPæŠ€æœ¯æä¾›çœŸæ­£çš„ å¼‚æ­¥IO æ”¯æŒï¼Œæ‰€ä»¥Linuxä¸‹ä½¿ç”¨epollæ¨¡æ‹Ÿå¼‚æ­¥IO |
| kqueue | é«˜       | Proactor         | Linux         | ç›®å‰JAVAçš„ç‰ˆæœ¬ä¸æ”¯æŒ                                         |



`select`ï¼Œ`poll`ï¼Œ`epoll`éƒ½æ˜¯IOå¤šè·¯å¤ç”¨çš„æœºåˆ¶ã€‚I/Oå¤šè·¯å¤ç”¨å°±æ˜¯é€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªæè¿°ç¬¦ï¼ˆsocketï¼‰ï¼Œä¸€æ—¦æŸä¸ªæè¿°ç¬¦å°±ç»ªï¼ˆä¸€èˆ¬æ˜¯è¯»å°±ç»ªæˆ–è€…å†™å°±ç»ªï¼‰ï¼Œèƒ½å¤Ÿé€šçŸ¥ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œã€‚è™½è¯´IOå¤šè·¯å¤ç”¨è¢«ç§°ä¸ºå¼‚æ­¥é˜»å¡IOï¼Œä½†**selectï¼Œpollï¼Œepollæœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥IOï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦åœ¨ç»­å†™äº‹ä»¶å°±ç»ªåè‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œè€ŒçœŸæ­£æ„ä¹‰ä¸Šçš„å¼‚æ­¥IOæ— éœ€è‡ªå·±è´Ÿè´£è¿›è¡Œè¯»å†™**





**select**

```c++
int select(int n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);
```

`select`å‡½æ•°ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ä¸‰ç±»ï¼Œ`readfdsï¼Œwritefdsï¼Œexceptfds(é”™è¯¯ä¿¡æ¯)`ï¼Œè°ƒç”¨åå‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æè¿°ç¬¦å°±ç»ªï¼ˆæœ‰æ•°æ®è¯»ã€å†™ã€æˆ–è€…æœ‰exceptï¼‰ï¼Œæˆ–è€…è¶…æ—¶ï¼ˆtimeoutæŒ‡å®šæ—¶é—´ï¼Œå¦‚æœç«‹å³è¿”å›è®¾ç½®nullï¼‰ï¼Œå‡½æ•°è¿”å›ã€‚å½“selectå‡½æ•°è¿”å›åï¼Œå¯ä»¥é€šè¿‡ä¾¿åˆ©fdsetï¼Œæ¥æ‰¾åˆ°å°±ç»ªçš„æè¿°ç¬¦ã€‚

 ä¼˜ç‚¹ï¼šè‰¯å¥½çš„è·¨å¹³å°æ€§

 ç¼ºç‚¹ï¼šå•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶ï¼Œåœ¨Linuxä¸Šä¸º1024ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å®å®šä¹‰ç”šè‡³é‡æ–°ç¼–è¯‘å†…æ ¸çš„æ–¹å¼æå‡è¿™ä¸€é™åˆ¶ï¼Œä½†è¿™æ ·ä¼šé€ æˆæ•ˆç‡çš„é™ä½



**poll**

```c++
int poll(struct poll *fds, unsigned int nfds, int timeout);
struct pollfd{
  int fd;
  short events;
  short revents;
};
```

pollfdç»“æ„åŒ…å«äº†è¦ç›‘è§†çš„eventå’Œå‘ç”Ÿçš„eventï¼Œ**ä¸å†ä½¿ç”¨selectå‚æ•°ä¼ å€¼çš„æ–¹å¼ã€‚åŒæ—¶pollfdå¹¶æ²¡æœ‰æœ€å¤§æ•°é‡çš„é™åˆ¶**ï¼ˆä½†æ•°é‡è¿‡å¤§æ€§èƒ½ä¹Ÿä¼šä¸‹é™ï¼‰ã€‚å’Œselectä¸€æ ·ï¼Œpollè¿”å›åï¼Œéœ€è¦è½®è¯¢pollfdæ¥æˆ–è®¸å°±ç»ªçš„æè¿°ç¬¦ã€‚å’Œepollçš„æ¯”è¾ƒï¼š

1. äº‹ä»¶æ³¨å†Œï¼š
   - `poll()`ä½¿ç”¨`pollfd`ç»“æ„æ¥æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œå¹¶é€šè¿‡`poll()`ç³»ç»Ÿè°ƒç”¨ç­‰å¾…äº‹ä»¶å°±ç»ªã€‚
   - `epoll()`ä½¿ç”¨`epoll_event`ç»“æ„æ¥æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œå¹¶é€šè¿‡`epoll_wait()`ç³»ç»Ÿè°ƒç”¨ç­‰å¾…äº‹ä»¶å°±ç»ªã€‚
2. æ•°æ®ç»“æ„ï¼š
   - `poll()`ä½¿ç”¨çº¿æ€§æ•°ç»„æ¥å­˜å‚¨æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œéœ€è¦éå†æ•´ä¸ªæ•°ç»„æ¥æŸ¥æ‰¾å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
   - `epoll()`ä½¿ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä½¿ç”¨åŒé“¾è¡¨æ¥å­˜å‚¨å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥å¿«é€ŸæŸ¥æ‰¾å’Œå¤„ç†å°±ç»ªäº‹ä»¶ã€‚
3. æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼š
   - `poll()`å°†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå› æ­¤æœ‰ä¸€ä¸ªæœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼ˆé€šå¸¸æ˜¯1024ï¼‰
   - `epoll()`ä½¿ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€‚













**epoll**

`epoll`æ˜¯selectå’Œpollçš„å¢å¼ºç‰ˆæœ¬ï¼Œç›¸æ¯”äºå‰ä¸¤è€…ï¼Œå®ƒæ›´åŠ çš„çµæ´»ï¼Œæ²¡æœ‰æè¿°ç¬¦çš„é™åˆ¶ã€‚epollä½¿ç”¨ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç®¡ç†å¤šä¸ªæè¿°ç¬¦ï¼Œå°†ç”¨æˆ·å…³ç³»çš„æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å­˜æ”¾åˆ°å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­ï¼Œè¿™æ ·åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„copyåªéœ€è¦ä¸€æ¬¡

`epoll()`æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç”¨äºå¤„ç†å¤§é‡å¹¶å‘è¿æ¥çš„æƒ…å†µ,`epoll()`ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ç§éé˜»å¡çš„I/Oæ¨¡å‹ï¼Œå¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å¹¶ä¸”åœ¨è¿™äº›æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œ

`epoll()`çš„ç”¨æ³•å¦‚ä¸‹ï¼š

1. åˆ›å»º`epoll`å®ä¾‹ï¼šé¦–å…ˆï¼Œéœ€è¦é€šè¿‡`epoll_create()`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ª`epoll`å®ä¾‹ï¼Œè¯¥å®ä¾‹ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºæ ‡è¯†è¿™ä¸ª`epoll`å®ä¾‹ã€‚
2. æ·»åŠ æ–‡ä»¶æè¿°ç¬¦åˆ°`epoll`ï¼šä½¿ç”¨`epoll_ctl()`ç³»ç»Ÿè°ƒç”¨å°†éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°`epoll`å®ä¾‹ä¸­ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®äº‹ä»¶ç±»å‹ï¼ˆä¾‹å¦‚å¯è¯»äº‹ä»¶ã€å¯å†™äº‹ä»¶ç­‰ï¼‰æ¥æŒ‡å®šç›‘è§†çš„äº‹ä»¶ã€‚
3. ç­‰å¾…äº‹ä»¶å°±ç»ªï¼š**ä½¿ç”¨`epoll_wait()`ç³»ç»Ÿè°ƒç”¨ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ª**ã€‚**å½“æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ªæ—¶ï¼Œ`epoll_wait()`ä¼šé˜»å¡ï¼Œå¹¶è¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ä»¥åŠå¯¹åº”çš„äº‹ä»¶ç±»å‹ã€‚**
4. å¤„ç†äº‹ä»¶ï¼šä¸€æ—¦`epoll_wait()`è¿”å›æœ‰å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è¯»å–æˆ–å†™å…¥æ•°æ®æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚

ä½¿ç”¨`epoll()`çš„ä¼˜åŠ¿åœ¨äºå®ƒé¿å…äº†ä¼ ç»Ÿçš„é˜»å¡å¼I/Oæ¨¡å‹ä¸­çš„å¤§é‡çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä»è€Œå‡å°‘äº†çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€ã€‚å®ƒå¯ä»¥åŒæ—¶ç›‘è§†å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œååé‡ã€‚å› æ­¤ï¼Œå¯¹äºé«˜å¹¶å‘çš„ç½‘ç»œç¼–ç¨‹ï¼Œ`epoll()`æ˜¯ä¸€ç§é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶





###  Reactoræ¨¡å‹



https://pdai.tech/md/java/io/java-io-nio-select-epoll.html#reactor%E6%A8%A1%E5%9E%8B%E5%92%8Cproactor%E6%A8%A1%E5%9E%8B





`Reactor`æ¨¡å¼ç”±`Reactor`çº¿ç¨‹ã€`Handler` å¤„ç†å™¨ä¸¤å¤§è§’è‰²ç»„æˆï¼Œä¸¤å¤§è§’è‰²çš„èŒè´£åˆ†åˆ«å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰`Reactor`ï¼šè´Ÿè´£æŸ¥è¯¢IOäº‹ä»¶ï¼Œå½“æ£€æµ‹åˆ°ä¸€ä¸ªIOäº‹ä»¶æ—¶å°†å…¶ä»¶åˆ†å‘ç»™ç›¸åº”çš„Handlerå¤„ç†å™¨å»å¤„ç†ã€‚è¿™é‡Œçš„IOäº‹ä»¶å°±æ˜¯NIOä¸­é€‰æ‹©å™¨æŸ¥è¯¢å‡ºæ¥çš„é€šé“IOäº‹ä»¶

ï¼ˆ2ï¼‰å¤šç§`Handler`ï¼šä¸IOäº‹ä»¶ï¼ˆæˆ–è€…é€‰æ‹©é”®ï¼‰ç»‘å®šï¼Œè´Ÿè´£IOäº‹ä»¶çš„å¤„ç†ï¼Œå®ŒæˆçœŸæ­£çš„è¿æ¥å»ºç«‹ã€é€šé“çš„è¯»å–ã€å¤„ç†ä¸šåŠ¡é€»è¾‘ã€è´Ÿè´£å°†ç»“æœå†™åˆ°é€šé“ç­‰





**å•çº¿ç¨‹Reactorï¼š**

Reactorå•çº¿ç¨‹æ¨¡å‹ï¼ŒæŒ‡çš„æ˜¯**ç›‘å¬I/Oäº‹ä»¶+å¤„ç†æ‰€æœ‰çš„I/Oæ“ä½œ**éƒ½åœ¨åŒä¸€ä¸ªNIOçº¿ç¨‹ä¸­å®Œæˆ

Reactorå¯¹è±¡ç›‘å¬socketè¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡Dispatchè¿›è¡Œåˆ†å‘ï¼›

å¦‚æœæ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™ç”±Acceptoré€šè¿‡acceptå¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºHandlerå¯¹è±¡å¤„ç†è¿æ¥å®Œæˆåçš„åç»­ä¸šåŠ¡å¤„ç†ï¼›

å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥è¯·æ±‚äº‹ä»¶ï¼Œåˆ™Reactoråˆ™ä¼šåˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„Handleræ¥å“åº”ï¼›

Handlerä¼šå®Œæˆ Read è§£ç -> ä¸šåŠ¡å¤„ç† -> ç¼–ç  Send çš„å®Œæ•´ä¸šåŠ¡é€»è¾‘ 



ç¼ºç‚¹ï¼š

1.æ€§èƒ½é—®é¢˜ï¼Œæ— æ³•å®Œå…¨å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚

2.**è€Œä¸”ä¸€æ—¦Handler åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶å®ƒè¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ**ï¼›

3.å¯é æ€§é—®é¢˜ï¼Œçº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ 





**å•Reactorå¤šhandler:**

ç›‘å¬socketäº‹ä»¶è¿˜æ˜¯ä¸€ä¸ª Reactor å¯¹è±¡,ä½†æ˜¯åœ¨å®é™…çš„ä¸šåŠ¡å¤„ç†çš„æ—¶å€™ï¼Œä½¿ç”¨äº†çº¿ç¨‹æ± è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚è¿™æ ·ï¼Œ**ä¸šåŠ¡å¤„ç†çº¿ç¨‹ä¸è´Ÿè´£æ–°è¿æ¥ç›‘å¬çš„`Reactor`ååº”å™¨çº¿ç¨‹å°±èƒ½ç›¸äº’éš”ç¦»**ï¼Œé¿å…æœåŠ¡å™¨çš„è¿æ¥ç›‘å¬å—åˆ°é˜»å¡

1. Reactorå¯¹è±¡ç›‘å¬socketè¯·æ±‚äº‹ä»¶ï¼Œå½“è¯·æ±‚äº‹ä»¶è¾¾åˆ°åï¼Œé€šè¿‡dispatchåˆ†å‘è¯·æ±‚ï¼›

2. è‹¥æ˜¯å»ºç«‹è¿æ¥çš„äº‹ä»¶ï¼Œåˆ™é€šè¿‡Acceptorçš„acceptå¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºHandleräº‹ä»¶æ¥å¤„ç†åç»­é€»è¾‘

3. å¦‚æœä¸æ˜¯å»ºç«‹è¿æ¥äº‹ä»¶ï¼Œåˆ™é€šè¿‡Reactoråˆ†å‘åˆ°è¿æ¥å¯¹åº”çš„handleræ¥å¤„ç†ï¼›

4. handleråªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡readè¯»å–æ•°æ®åï¼Œåˆ†å‘ç»™workerçº¿ç¨‹æ± å»å¤„ç†ä¸šåŠ¡ï¼›

5. å¯¹åº”ä¸šåŠ¡çš„`worker`çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹å»å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™handlerï¼›

6. handleræ”¶åˆ°å“åº”åï¼Œé€šè¿‡sendæ–¹æ³•å°†ç»“æœè¿”å›ç»™clientï¼›



ç¼ºç‚¹ï¼š

å¤šçº¿ç¨‹ä¼šè¿›è¡Œæ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ï¼Œè€Œå¤„ç†æ‰€æœ‰çš„äº‹ä»¶ç›‘å¬å’Œå“åº”äº‹ä»¶çš„`Reactor`æ˜¯åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆ





**ä¸»ä» Reactor:**

å®ƒçš„ä¸»è¦æ€æƒ³æ˜¯:

- å°†å¤„ç†äº‹ä»¶çš„ä»»åŠ¡åˆ†è§£ä¸ºä¸¤ä¸ªéƒ¨åˆ†:äº‹ä»¶æ¥æ”¶å’Œäº‹ä»¶å¤„ç†ã€‚

- è®¾è®¡ä¸€ä¸ªä¸»Reactorè´Ÿè´£äº‹ä»¶çš„ç›‘å¬å’Œæ¥æ”¶ã€‚

- è®¾è®¡ä¸€ä¸ªæˆ–å¤šä¸ªä»Reactorè´Ÿè´£äº‹ä»¶çš„çœŸæ­£å¤„ç†

- ä¸‰å¤§ç»„ä»¶æœ‰ï¼š

  Reactorï¼šæŠŠIOäº‹ä»¶åˆ†é…ç»™å¯¹åº”çš„ handler å¤„ç†
  Acceptorï¼šå¤„ç†å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶
  Handlerï¼šå¤„ç†éé˜»å¡çš„ä»»åŠ¡

å…·ä½“æ¥è¯´ï¼Œæ¢³ç†ä¸‹åŸºäºä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹çš„äº‹ä»¶å¤„ç†è¿‡ç¨‹ï¼š

    Reactorä¸»çº¿ç¨‹å¯¹è±¡é€šè¿‡selectç›‘å¬è¿æ¥äº‹ä»¶ï¼Œé€šè¿‡Acceptorå¤„ç†è¿æ¥äº‹ä»¶
    
    å½“Acceptorå¤„ç†è¿æ¥äº‹ä»¶åï¼Œä¸»reactorå°†è¿æ¥åˆ†é…ç»™ä»Reactor
    
    ä»Reactorå°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»ºhandlerè¿›è¡Œå„ç§äº‹ä»¶å¤„ç†
    
    å½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä»reactorå°±ä¼šå¯¹ç”¨å¯¹åº”çš„handlerå¤„ç†
    
    handlerè¯»å–æ•°æ®åï¼Œåˆ†å‘ç»™åé¢çš„workerçº¿ç¨‹å¤„ç†
    
    workerçº¿ç¨‹æ± åˆ†é…ç‹¬ç«‹çš„workerçº¿ç¨‹è¿›è¡Œå¤„ç†å¹¶è¿”å›ç»“æœ
    
    handleræ”¶åˆ°ç»“æœåå†è®²ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯



















### IOç±»å‹

####  BIO (Blocking I/O)

**åº”ç”¨ç¨‹åºå‘èµ· read è°ƒç”¨åï¼Œä¼šä¸€ç›´é˜»å¡**ï¼Œç›´åˆ°å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´



####  NIO (Non-blocking/New I/O)

Java ä¸­çš„ NIO å¯ä»¥çœ‹ä½œæ˜¯ **I/O å¤šè·¯å¤ç”¨æ¨¡å‹**ã€‚ä¹Ÿæœ‰å¾ˆå¤šäººè®¤ä¸ºï¼ŒJava ä¸­çš„ NIO å±äºåŒæ­¥éé˜»å¡ IO æ¨¡å‹,åŒæ­¥éé˜»å¡ IO æ¨¡å‹ä¸­ï¼Œåº”ç”¨ç¨‹åºä¼šä¸€ç›´å‘èµ· read è°ƒç”¨ï¼Œç­‰å¾…æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„è¿™æ®µæ—¶é—´é‡Œï¼Œçº¿ç¨‹ä¾ç„¶æ˜¯é˜»å¡çš„ï¼Œç›´åˆ°å†…æ ¸æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´,å³é€šè¿‡è½®è¯¢æ“ä½œé¿å…äº†ä¸€ç›´é˜»å¡(ç±»ä¼¼è‡ªæ—‹)ï¼Œä½†æ˜¯ï¼Œè¿™ç§ IO æ¨¡å‹åŒæ ·å­˜åœ¨é—®é¢˜ï¼š**åº”ç”¨ç¨‹åºä¸æ–­è¿›è¡Œ I/O ç³»ç»Ÿè°ƒç”¨è½®è¯¢æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å¥½çš„è¿‡ç¨‹æ˜¯ååˆ†æ¶ˆè€— CPU èµ„æºçš„**



NIO å®ç°äº† IO å¤šè·¯å¤ç”¨ä¸­çš„ `Reactor` æ¨¡å‹ï¼Œä¸€ä¸ªçº¿ç¨‹ Thread ä½¿ç”¨ä¸€ä¸ªé€‰æ‹©å™¨ Selector é€šè¿‡è½®è¯¢çš„æ–¹å¼å»ç›‘å¬å¤šä¸ªé€šé“ Channel ä¸Šçš„äº‹ä»¶ï¼Œä»è€Œè®©ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å¤„ç†å¤šä¸ªäº‹ä»¶ã€‚

é€šè¿‡**é…ç½®ç›‘å¬çš„é€šé“ `Channel` ä¸ºéé˜»å¡**ï¼Œé‚£ä¹ˆå½“ Channel ä¸Šçš„ I/O äº‹ä»¶è¿˜æœªåˆ°è¾¾æ—¶ï¼Œå°±ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ä¸€ç›´ç­‰å¾…ï¼Œè€Œæ˜¯ç»§ç»­è½®è¯¢å…¶å®ƒ `Channel`ï¼Œæ‰¾åˆ° IO äº‹ä»¶å·²ç»åˆ°è¾¾çš„ `Channel` æ‰§è¡Œ



Java ä¸­çš„ NIO ï¼Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„**é€‰æ‹©å™¨ ( `Selector` )** çš„æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥è¢«ç§°ä¸º**å¤šè·¯å¤ç”¨å™¨**ã€‚é€šè¿‡å®ƒï¼Œåªéœ€è¦ä¸€ä¸ªçº¿ç¨‹ä¾¿å¯ä»¥ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å½“å®¢æˆ·ç«¯æ•°æ®åˆ°äº†ä¹‹åï¼Œæ‰ä¼šä¸ºå…¶æœåŠ¡ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/channel-buffer-selector.png"  />

NIO ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

- **Bufferï¼ˆç¼“å†²åŒºï¼‰**ï¼šNIO è¯»å†™æ•°æ®éƒ½æ˜¯é€šè¿‡ç¼“å†²åŒºè¿›è¡Œæ“ä½œçš„ã€‚å®¢æˆ·ç«¯è¯»æ“ä½œçš„æ—¶å€™å°† `Channel` ä¸­çš„æ•°æ®å¡«å……åˆ° `Buffer`ä¸­ï¼Œè€Œå®¢æˆ·ç«¯å†™æ“ä½œæ—¶å°† Bufferä¸­çš„æ•°æ®å†™å…¥åˆ° `Channel`ä¸­

  Java NIO ä½¿ç”¨äº†`ByteBuffer`ï¼Œè€ŒNettyåˆ™ä½¿ç”¨äº†`ByteBuf`

- **Channelï¼ˆé€šé“ï¼‰**ï¼š`Channel` æ˜¯ä¸€ä¸ªåŒå‘çš„ã€å¯è¯»å¯å†™çš„æ•°æ®ä¼ è¾“é€šé“ï¼ŒNIO é€šè¿‡Channelæ¥å®ç°æ•°æ®çš„è¾“å…¥è¾“å‡ºã€‚é€šé“æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥ä»£è¡¨æ–‡ä»¶ã€å¥—æ¥å­—æˆ–è€…å…¶ä»–æ•°æ®æºä¹‹é—´çš„è¿æ¥,Channel æ˜¯ä¸€ä¸ªé€šé“ï¼Œå®ƒå»ºç«‹äº†ä¸æ•°æ®æºï¼ˆå¦‚æ–‡ä»¶ã€ç½‘ç»œå¥—æ¥å­—ç­‰ï¼‰ä¹‹é—´çš„è¿æ¥,Clientè¯»æ“ä½œçš„æ—¶å€™å°† Channel ä¸­çš„æ•°æ®å¡«å……åˆ° Bufferä¸­ï¼Œè€Œè¿›è¡Œå†™æ“ä½œæ—¶å°† Bufferä¸­çš„æ•°æ®å†™å…¥åˆ° Channel ä¸­

- **Selectorï¼ˆé€‰æ‹©å™¨ï¼‰**ï¼šå…è®¸ä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ª `Channel`ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨çš„ I/O å¤šè·¯å¤ç”¨æ¨¡å‹ã€‚æ‰€æœ‰çš„ `Channel` éƒ½å¯ä»¥æ³¨å†Œåˆ°`Selector`ä¸Šï¼Œç”±`Selector`æ¥åˆ†é…çº¿ç¨‹(`Select`)æ¥å¤„ç†äº‹ä»¶,`Selector` æ˜¯**åŸºäºäº‹ä»¶é©±åŠ¨çš„ I/O å¤šè·¯å¤ç”¨æ¨¡å‹**ï¼Œä¸»è¦è¿ä½œåŸç†æ˜¯ï¼šé€šè¿‡ `Selector` æ³¨å†Œé€šé“çš„äº‹ä»¶ï¼Œ`Selector` ä¼šä¸æ–­åœ°è½®è¯¢æ³¨å†Œåœ¨å…¶ä¸Šçš„ `Channel`ã€‚å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ¯”å¦‚ï¼š**æŸä¸ª `Channel`ä¸Šé¢æœ‰æ–°çš„ TCP è¿æ¥æ¥å…¥ã€è¯»å’Œå†™äº‹ä»¶ï¼Œè¿™ä¸ª `Channel`å°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œä¼šè¢« `Selector` è½®è¯¢å‡ºæ¥**ã€‚`Selector` ä¼šå°†ç›¸å…³çš„ `Channel`åŠ å…¥åˆ°å°±ç»ªé›†åˆä¸­ã€‚é€šè¿‡ `SelectionKey`å¯ä»¥è·å–å°±ç»ª `Channel`çš„é›†åˆï¼Œç„¶åå¯¹è¿™äº›å°±ç»ªçš„ `Channel`è¿›è¡Œå“åº”çš„ I/O æ“ä½œ,**ç”±äº JDKä½¿ç”¨äº† `epoll()` ä»£æ›¿ä¼ ç»Ÿçš„ `select` å®ç°ï¼Œæ‰€ä»¥å®ƒå¹¶æ²¡æœ‰æœ€å¤§è¿æ¥å¥æŸ„ `1024/2048` çš„é™åˆ¶ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€åªéœ€è¦ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ `selector` çš„è½®è¯¢ï¼Œå°±å¯ä»¥æ¥å…¥æˆåƒä¸Šä¸‡çš„å®¢æˆ·ç«¯**

  



#### AIO (Asynchronous I/O)

AIO ä¹Ÿå°±æ˜¯ NIO 2ï¼Œå®ƒæ˜¯**å¼‚æ­¥** I/O æ¨¡å‹ï¼Œå¼‚æ­¥ I/O æ˜¯**åŸºäºäº‹ä»¶å’Œå›è°ƒæœºåˆ¶å®ç°**çš„ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨æ“ä½œä¹‹åä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå µå¡åœ¨é‚£é‡Œï¼Œå½“åå°å¤„ç†å®Œæˆï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥ç›¸åº”çš„çº¿ç¨‹è¿›è¡Œåç»­çš„æ“ä½œ







### **é›¶æ‹·è´**

é›¶æ‹·è´æ˜¯æŒ‡è®¡ç®—æœºæ‰§è¡Œ `I/O` æ“ä½œæ—¶ï¼Œ**CPU ä¸éœ€è¦å°†æ•°æ®ä»ä¸€ä¸ªå­˜å‚¨åŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªå­˜å‚¨åŒºåŸŸï¼Œä»è€Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢(ç”¨æˆ·æ€<â€”>å†…æ ¸æ€åˆ‡æ¢)ä»¥åŠ CPU çš„æ‹·è´æ—¶é—´**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé›¶æ‹·è´ä¸»è¦è§£å†³æ“ä½œç³»ç»Ÿåœ¨å¤„ç† I/O æ“ä½œæ—¶é¢‘ç¹å¤åˆ¶æ•°æ®çš„é—®é¢˜ã€‚é›¶æ‹·è´çš„å¸¸è§å®ç°æŠ€æœ¯æœ‰ï¼š `mmap+write`ã€`sendfile`å’Œ `sendfile + DMA gather copy`

ä¸‹å›¾å±•ç¤ºäº†å„ç§é›¶æ‹·è´æŠ€æœ¯çš„å¯¹æ¯”å›¾ï¼š

|                            | CPU æ‹·è´ | DMA æ‹·è´ | ç³»ç»Ÿè°ƒç”¨   | ä¸Šä¸‹æ–‡åˆ‡æ¢ |
| -------------------------- | -------- | -------- | ---------- | ---------- |
| ä¼ ç»Ÿæ–¹æ³•                   | 2        | 2        | read+write | 4          |
| **mmap+write**             | 1        | 2        | mmap+write | 4          |
| **sendfile**               | 1        | 2        | sendfile   | 2          |
| sendfile + DMA gather copy | 0        | 2        | sendfile   | 2          |

å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºæ˜¯ä¼ ç»Ÿçš„ I/O æ–¹å¼ï¼Œè¿˜æ˜¯å¼•å…¥äº†é›¶æ‹·è´ä¹‹åï¼Œ2 æ¬¡ DMA(Direct Memory Access) æ‹·è´æ˜¯éƒ½å°‘ä¸äº†çš„ã€‚å› ä¸ºä¸¤æ¬¡ DMA éƒ½æ˜¯ä¾èµ–ç¡¬ä»¶å®Œæˆçš„ã€‚é›¶æ‹·è´ä¸»è¦æ˜¯å‡å°‘äº† CPU æ‹·è´åŠä¸Šä¸‹æ–‡çš„åˆ‡æ¢



(1) **mmap+write**ï¼šå®é™…ä¸Šæ˜¯ä½¿ç”¨mmapæ›¿æ¢äº†ä¼ ç»Ÿæ“ä½œread+writeä¸­çš„readæ“ä½œï¼Œmmapä¸»è¦æ˜¯å°†è¯»ç¼“å†²åŒºä¸­çš„åœ°å€(ç£ç›˜æ–‡ä»¶åœ°å€)å’Œç”¨æˆ·ç¼“å†²åŒºçš„åœ°å€(è¿›ç¨‹è™šæ‹Ÿåœ°å€)è¿›è¡Œæ˜ å°„ï¼Œå†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºå…±äº«ï¼Œä»è€Œå‡å°‘äº†è¯»ç¼“å†²åŒºåˆ°ç”¨æˆ·ç¼“å†²åŒºçš„ä¸€æ¬¡CPUæ‹·è´(**å‡å°‘äº†å†…æ ¸æ€â€”â€”ç”¨æˆ·æ€çš„æ‹·è´**)ï¼š

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%9B%B6%E6%8B%B7%E8%B4%9D/mmap%20%2B%20write%20%E9%9B%B6%E6%8B%B7%E8%B4%9D.png)

å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

- åº”ç”¨è¿›ç¨‹è°ƒç”¨äº† `mmap()` åï¼ŒDMA ä¼šæŠŠç£ç›˜çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸çš„ç¼“å†²åŒºé‡Œã€‚æ¥ç€ï¼Œåº”ç”¨è¿›ç¨‹è·Ÿæ“ä½œç³»ç»Ÿå†…æ ¸ã€Œå…±äº«ã€è¿™ä¸ªç¼“å†²åŒºï¼›
- åº”ç”¨è¿›ç¨‹å†è°ƒç”¨ `write()`ï¼Œæ“ä½œç³»ç»Ÿç›´æ¥å°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œç”± CPU æ¥æ¬è¿æ•°æ®ï¼›
- æœ€åï¼ŒæŠŠå†…æ ¸çš„ socket ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œæ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± DMA æ¬è¿çš„ã€‚

æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œé€šè¿‡ä½¿ç”¨ `mmap()` æ¥ä»£æ›¿ `read()`ï¼Œ å¯ä»¥å‡å°‘ä¸€æ¬¡æ•°æ®æ‹·è´çš„è¿‡ç¨‹ã€‚

ä½†è¿™è¿˜ä¸æ˜¯æœ€ç†æƒ³çš„é›¶æ‹·è´ï¼Œå› ä¸º**ä»ç„¶éœ€è¦é€šè¿‡ CPU æŠŠå†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œ**ï¼Œè€Œä¸”ä»ç„¶éœ€è¦ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ 2 æ¬¡







(2) **sendfile**:ä½¿ç”¨`sendfile`æ•°æ®å¯ä»¥ç›´æ¥åœ¨å†…æ ¸ç©ºé—´è¿›è¡Œä¼ è¾“ï¼Œå› æ­¤é¿å…äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ‹·è´ï¼ŒåŒæ—¶ç”±äº`sendfile`æ›¿ä»£äº†`read+write`,ä»è€ŒèŠ‚çœäº†ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨(å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢)ï¼Œ`sendfile`æ“ä½œå¯¹ç”¨æˆ·ç©ºé—´å®Œå…¨ä¸å¯è§(IOæ•°æ®å¯¹ç”¨æˆ·å®Œå…¨ä¸å¯è§)ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæ— éå°±æ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°mq,ç„¶åå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç„¶åæ¶ˆè´¹è€…ä»mqä¸­è¯»å–æ¶ˆæ¯ï¼Œå¯¹äº`rocketmq`è€Œè¨€ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤ä½¿ç”¨çš„æ˜¯`mmap+write`,è€Œ`kafka`åˆ™æ˜¯ä½¿ç”¨`mmap+write`æ¥æŒä¹…åŒ–æ•°æ®ï¼Œå‘é€æ•°æ®åˆ™ä½¿ç”¨çš„`sendfile`



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/MMAP2.png" style="zoom:67%;" />



ä» Linux å†…æ ¸ `2.4` ç‰ˆæœ¬å¼€å§‹èµ·ï¼Œå¯¹äºæ”¯æŒç½‘å¡æ”¯æŒ SG-DMA æŠ€æœ¯çš„æƒ…å†µä¸‹ï¼Œ `sendfile()` ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å‘ç”Ÿäº†ç‚¹å˜åŒ–ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œé€šè¿‡ DMA å°†ç£ç›˜ä¸Šçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºé‡Œï¼›
- ç¬¬äºŒæ­¥ï¼Œç¼“å†²åŒºæè¿°ç¬¦å’Œæ•°æ®é•¿åº¦ä¼ åˆ° socket ç¼“å†²åŒºï¼Œè¿™æ ·ç½‘å¡çš„ SG-DMA æ§åˆ¶å™¨å°±å¯ä»¥ç›´æ¥å°†å†…æ ¸ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡çš„ç¼“å†²åŒºé‡Œï¼Œæ­¤è¿‡ç¨‹ä¸éœ€è¦å°†æ•°æ®ä»æ“ä½œç³»ç»Ÿå†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ° socket ç¼“å†²åŒºä¸­ï¼Œè¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡æ•°æ®æ‹·è´ï¼›

æ‰€ä»¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹‹ä¸­ï¼Œåªè¿›è¡Œäº† 2 æ¬¡æ•°æ®æ‹·è´ï¼Œå¦‚ä¸‹å›¾ï¼š

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%9B%B6%E6%8B%B7%E8%B4%9D/senfile-%E9%9B%B6%E6%8B%B7%E8%B4%9D.png)

è¿™å°±æ˜¯æ‰€è°“çš„**é›¶æ‹·è´ï¼ˆ\*Zero-copy\*ï¼‰æŠ€æœ¯ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨å†…å­˜å±‚é¢å»æ‹·è´æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å…¨ç¨‹æ²¡æœ‰é€šè¿‡ CPU æ¥æ¬è¿æ•°æ®ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ DMA æ¥è¿›è¡Œä¼ è¾“çš„ã€‚**

é›¶æ‹·è´æŠ€æœ¯çš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ç›¸æ¯”ä¼ ç»Ÿæ–‡ä»¶ä¼ è¾“çš„æ–¹å¼ï¼Œå‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œ**åªéœ€è¦ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå°±å¯ä»¥å®Œæˆæ–‡ä»¶çš„ä¼ è¾“ï¼Œè€Œä¸” 2 æ¬¡çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œéƒ½ä¸éœ€è¦é€šè¿‡ CPUï¼Œ2 æ¬¡éƒ½æ˜¯ç”± DMA æ¥æ¬è¿ã€‚**



åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªä¸“é—¨å‘é€æ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•° `sendfile()`ï¼Œå‡½æ•°å½¢å¼å¦‚ä¸‹ï¼š

```c
#include <sys/socket.h>
ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count);
```

å®ƒçš„å‰ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ç›®çš„ç«¯å’Œæºç«¯çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåé¢ä¸¤ä¸ªå‚æ•°æ˜¯æºç«¯çš„åç§»é‡å’Œå¤åˆ¶æ•°æ®çš„é•¿åº¦ï¼Œè¿”å›å€¼æ˜¯å®é™…å¤åˆ¶æ•°æ®çš„é•¿åº¦ã€‚

é¦–å…ˆï¼Œå®ƒå¯ä»¥æ›¿ä»£å‰é¢çš„ `read()` å’Œ `write()` è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±å‡å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚

å…¶æ¬¡ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥æŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºé‡Œï¼Œä¸å†æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œè¿™æ ·å°±åªæœ‰ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå’Œ 3 æ¬¡æ•°æ®æ‹·è´ã€‚å¦‚ä¸‹å›¾ï¼š

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%9B%B6%E6%8B%B7%E8%B4%9D/senfile-3%E6%AC%A1%E6%8B%B7%E8%B4%9D.png)





Java å¯¹é›¶æ‹·è´çš„æ”¯æŒï¼š

- `MappedByteBuffer` æ˜¯ NIO åŸºäº**å†…å­˜æ˜ å°„**ï¼ˆ`mmap`ï¼š**mmap æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»**ï¼‰è¿™ç§é›¶æ‹·â»‰â½…å¼çš„æä¾›çš„â¼€ç§å®ç°ï¼Œåº•å±‚å®é™…æ˜¯è°ƒç”¨äº† Linux å†…æ ¸çš„ `mmap` ç³»ç»Ÿè°ƒç”¨ã€‚å®ƒå¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ–‡ä»¶çš„ä¸€éƒ¨åˆ†æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œå½¢æˆä¸€ä¸ªè™šæ‹Ÿå†…å­˜æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ“ä½œå†…å­˜ä¸­çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥è¯»å†™æ–‡ä»¶ã€‚

- `FileChannel` çš„`transferTo()/transferFrom()`æ˜¯ NIO åŸºäºå‘é€æ–‡ä»¶ï¼ˆ`sendfile`ï¼‰è¿™ç§é›¶æ‹·è´æ–¹å¼çš„æä¾›çš„ä¸€ç§å®ç°ï¼Œåº•å±‚å®é™…æ˜¯è°ƒç”¨äº† Linux å†…æ ¸çš„ `sendfile`ç³»ç»Ÿè°ƒç”¨ã€‚å®ƒå¯ä»¥ç›´æ¥å°†æ–‡ä»¶æ•°æ®ä»ç£ç›˜å‘é€åˆ°ç½‘ç»œï¼Œè€Œä¸éœ€è¦ç»è¿‡ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒº

  åœ¨ Linux ä¸­ç³»ç»Ÿè°ƒç”¨ sendfile() å¯ä»¥å®ç°å°†æ•°æ®ä»ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼ è¾“åˆ°å¦ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå®ç°äº†é›¶æ‹·è´æŠ€æœ¯ã€‚åœ¨ Java ä¸­ä¹Ÿä½¿ç”¨äº†é›¶æ‹·è´æŠ€æœ¯ï¼Œå®ƒå°±æ˜¯ NIO FileChannel ç±»ä¸­çš„ transferTo() æ–¹æ³•ï¼Œ`transferTo()` **åº•å±‚å°±ä¾èµ–äº†æ“ä½œç³»ç»Ÿé›¶æ‹·è´çš„æœºåˆ¶ï¼Œå®ƒå¯ä»¥å°†æ•°æ®ä» `FileChannel` ç›´æ¥ä¼ è¾“åˆ°å¦å¤–ä¸€ä¸ª `Channel`**



æ€»ç»“ä¸€ä¸‹ï¼Œåœ¨å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„å®ç°æ–¹å¼æ˜¯ï¼š

```c++
1.  `File.read(bytes)`
2.  `Socket.send(bytes)`
```

è¿™ç§æ–¹å¼éœ€è¦å››æ¬¡æ•°æ®æ‹·è´å’Œå››æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š

1. æ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…æ ¸çš„read buffer(DMAæ–¹å¼)
2. æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº(å†…æ ¸æ€â€”â€”>ç”¨æˆ·æ€çš„åˆ‡æ¢)
3. æ•°æ®ä»ç”¨æˆ·ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸çš„socket buffer(ç”¨æˆ·æ€â€”â€”>å†…æ ¸æ€çš„åˆ‡æ¢)
4. æ•°æ®ä»å†…æ ¸çš„socket bufferæ‹·è´åˆ°ç½‘å¡æ¥å£çš„ç¼“å†²åŒº(DMAæ–¹å¼)

æ˜æ˜¾ä¸Šé¢çš„ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œé€šè¿‡javaçš„`FileChannel.transferTo`æ–¹æ³•ï¼Œå¯ä»¥é¿å…ä¸Šé¢ä¸¤æ¬¡å¤šä½™çš„æ‹·è´ï¼ˆå½“ç„¶è¿™éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿæ”¯æŒï¼‰

1. è°ƒç”¨transferTo,æ•°æ®ä»æ–‡ä»¶ç”±DMAå¼•æ“æ‹·è´åˆ°å†…æ ¸read buffer(å†…æ ¸ç¼“å†²åŒº)
2. æ¥ç€DMAä»å†…æ ¸read bufferå°†æ•°æ®æ‹·è´åˆ°ç½‘å¡æ¥å£buffer(è·³è¿‡Socketç¼“å†²åŒº)

ä¸Šé¢çš„ä¸¤æ¬¡æ“ä½œéƒ½ä¸éœ€è¦CPUå‚ä¸ï¼Œæ‰€ä»¥å°±è¾¾åˆ°äº†é›¶æ‹·è´ã€‚







### `Netty`ä¸­çš„**é›¶æ‹·è´**



åœ¨ä»‹ç» Netty é›¶æ‹·è´ç‰¹æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å­¦ä¹ ä¸‹ä¼ ç»Ÿ Linux ä¸­é›¶æ‹·è´çš„å·¥ä½œåŸç†ã€‚æ‰€è°“é›¶æ‹·è´ï¼Œå°±æ˜¯åœ¨æ•°æ®æ“ä½œæ—¶ï¼Œä¸éœ€è¦å°†æ•°æ®ä»ä¸€ä¸ªå†…å­˜ä½ç½®æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªå†…å­˜ä½ç½®ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜æ‹·è´çš„æŸè€—ï¼Œä»è€ŒèŠ‚çœäº† CPU æ—¶é’Ÿå‘¨æœŸå’Œå†…å­˜å¸¦å®½ã€‚

æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªåœºæ™¯ï¼Œä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå°†æ•°æ®ä¼ è¾“åˆ°ç½‘ç»œä¸Šï¼Œé‚£ä¹ˆä¼ ç»Ÿçš„æ•°æ®æ‹·è´è¿‡ç¨‹ä¼šåˆ†ä¸ºå“ªå‡ ä¸ªé˜¶æ®µå‘¢ï¼Ÿå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Netty%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%E4%B8%8E%20RPC%20%E5%AE%9E%E8%B7%B5-%E5%AE%8C/assets/Ciqc1F_Qbz2AD4uMAARnlgeSFc4993.png" alt="Drawing 0.png" style="zoom:50%;" />

ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œä»æ•°æ®è¯»å–åˆ°å‘é€ä¸€å…±ç»å†äº†**å››æ¬¡æ•°æ®æ‹·è´**ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

1. å½“ç”¨æˆ·è¿›ç¨‹å‘èµ· read() è°ƒç”¨åï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢è‡³å†…æ ¸æ€ã€‚ DMA å¼•æ“ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å­˜å‚¨åˆ°å†…æ ¸æ€ç¼“å†²åŒºï¼Œè¿™é‡Œæ˜¯**ç¬¬ä¸€æ¬¡æ•°æ®æ‹·è´**
2. è¯·æ±‚çš„æ•°æ®ä»å†…æ ¸æ€ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·æ€ç¼“å†²åŒºï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ã€‚ç¬¬äºŒæ¬¡æ•°æ®æ‹·è´çš„è¿‡ç¨‹åŒæ—¶ï¼Œä¼šå¯¼è‡´ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€å†æ¬¡åˆ‡æ¢åˆ°ç”¨æˆ·æ€
3. ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ send() æ–¹æ³•æœŸæœ›å°†æ•°æ®å‘é€åˆ°ç½‘ç»œä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘ç¬¬ä¸‰æ¬¡çº¿ç¨‹åˆ‡æ¢ï¼Œç”¨æˆ·æ€ä¼šå†æ¬¡åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œè¯·æ±‚çš„æ•°æ®ä»ç”¨æˆ·æ€ç¼“å†²åŒºè¢«æ‹·è´åˆ° Socket ç¼“å†²åŒº
4. æœ€ç»ˆ send() ç³»ç»Ÿè°ƒç”¨ç»“æŸè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ï¼Œå‘ç”Ÿäº†ç¬¬å››æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ç¬¬å››æ¬¡æ‹·è´ä¼šå¼‚æ­¥æ‰§è¡Œï¼Œä» Socket ç¼“å†²åŒºæ‹·è´åˆ°åè®®å¼•æ“ä¸­

ä¼ ç»Ÿçš„æ•°æ®æ‹·è´è¿‡ç¨‹ä¸ºä»€ä¹ˆä¸æ˜¯å°†æ•°æ®ç›´æ¥ä¼ è¾“åˆ°ç”¨æˆ·ç¼“å†²åŒºå‘¢ï¼Ÿå…¶å®å¼•å…¥å†…æ ¸ç¼“å†²åŒºå¯ä»¥å……å½“ç¼“å­˜çš„ä½œç”¨ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ–‡ä»¶æ•°æ®çš„é¢„è¯»ï¼Œæå‡ I/O çš„æ€§èƒ½ã€‚ä½†æ˜¯å½“è¯·æ±‚æ•°æ®é‡å¤§äºå†…æ ¸ç¼“å†²åŒºå¤§å°æ—¶ï¼Œåœ¨å®Œæˆä¸€æ¬¡æ•°æ®çš„è¯»å–åˆ°å‘é€å¯èƒ½è¦ç»å†æ•°å€æ¬¡æ•°çš„æ•°æ®æ‹·è´ï¼Œè¿™å°±é€ æˆä¸¥é‡çš„æ€§èƒ½æŸè€—ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ä¸‹ä½¿ç”¨é›¶æ‹·è´æŠ€æœ¯ä¹‹åæ•°æ®ä¼ è¾“çš„æµç¨‹ã€‚é‡æ–°å›é¡¾ä¸€éä¼ ç»Ÿæ•°æ®æ‹·è´çš„è¿‡ç¨‹ï¼Œå¯ä»¥å‘ç°ç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡æ‹·è´æ˜¯å¯ä»¥å»é™¤çš„ï¼Œ**DMA å¼•æ“ä»æ–‡ä»¶è¯»å–æ•°æ®åæ”¾å…¥åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åå¯ä»¥ç›´æ¥ä»å†…æ ¸ç¼“å†²åŒºä¼ è¾“åˆ° Socket ç¼“å†²åŒº(è·³è¿‡å†…æ ¸ç¼“å†²åŒºâ€”ç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ‹·è´)**ï¼Œä»è€Œå‡å°‘å†…å­˜æ‹·è´çš„æ¬¡æ•°ã€‚



ä»‹ç»å®Œä¼ ç»Ÿ Linux çš„é›¶æ‹·è´æŠ€æœ¯ä¹‹åï¼Œæˆ‘ä»¬å†æ¥å­¦ä¹ ä¸‹ Netty ä¸­çš„é›¶æ‹·è´å¦‚ä½•å®ç°



å‰ç½®çŸ¥è¯†ï¼š

**åœ¨ JVM å†…éƒ¨æ‰§è¡Œ I/O æ“ä½œæ—¶ï¼Œå¿…é¡»å°†æ•°æ®æ‹·è´åˆ°å †å¤–å†…å­˜ï¼Œæ‰èƒ½æ‰§è¡Œç³»ç»Ÿè°ƒç”¨**ã€‚è¿™æ˜¯æ‰€æœ‰ VM è¯­è¨€éƒ½ä¼šå­˜åœ¨çš„é—®é¢˜ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæ“ä½œç³»ç»Ÿä¸èƒ½ç›´æ¥ä½¿ç”¨ JVM å †å†…å­˜è¿›è¡Œ I/O çš„è¯»å†™å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤ç‚¹åŸå› ï¼šç¬¬ä¸€ï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸æ„ŸçŸ¥ JVM çš„å †å†…å­˜ï¼Œè€Œä¸” JVM çš„å†…å­˜å¸ƒå±€ä¸æ“ä½œç³»ç»Ÿæ‰€åˆ†é…çš„æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸ä¼šæŒ‰ç…§ JVM çš„è¡Œä¸ºæ¥è¯»å†™æ•°æ®ã€‚ç¬¬äºŒï¼ŒåŒä¸€ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€éšç€ JVM GC çš„æ‰§è¡Œå¯èƒ½ä¼šéšæ—¶å‘ç”Ÿå˜åŒ–ï¼Œä¾‹å¦‚ JVM GC çš„è¿‡ç¨‹ä¸­ä¼šé€šè¿‡å‹ç¼©æ¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œè¿™å°±æ¶‰åŠå¯¹è±¡ç§»åŠ¨çš„é—®é¢˜äº†ã€‚

**Netty åœ¨è¿›è¡Œ I/O æ“ä½œæ—¶éƒ½æ˜¯ä½¿ç”¨çš„å †å¤–å†…å­˜ï¼Œå¯ä»¥é¿å…æ•°æ®ä» JVM å †å†…å­˜åˆ°å †å¤–å†…å­˜çš„æ‹·è´**



Nettyçš„é›¶æ‹·è´ä½“ç°åœ¨ä¸‰ä¸ªæ–¹é¢ï¼š

1. Nettyçš„æ¥æ”¶å’Œå‘é€ByteBufferé‡‡ç”¨`DIRECT BUFFERS`ï¼Œ**ä½¿ç”¨å †å¤–ç›´æ¥å†…å­˜è¿›è¡ŒSocketè¯»å†™**ï¼Œä¸éœ€è¦è¿›è¡Œå­—èŠ‚ç¼“å†²åŒºçš„äºŒæ¬¡æ‹·è´ã€‚**å¦‚æœä½¿ç”¨ä¼ ç»Ÿçš„å †å†…å­˜ï¼ˆHEAP BUFFERSï¼‰è¿›è¡ŒSocketè¯»å†™ï¼ŒJVMä¼šå°†å †å†…å­˜Bufferæ‹·è´ä¸€ä»½åˆ°ç›´æ¥å†…å­˜(å †å¤–å†…å­˜)ä¸­ï¼Œç„¶åæ‰å†™å…¥`Socket`ä¸­å»ã€‚ç›¸æ¯”äºå †å¤–ç›´æ¥å†…å­˜ï¼Œæ¶ˆæ¯åœ¨å‘é€è¿‡ç¨‹ä¸­å¤šäº†ä¸€æ¬¡ç¼“å†²åŒºçš„å†…å­˜æ‹·è´ã€‚**





2. Nettyæä¾›äº†ç»„åˆBufferå¯¹è±¡ï¼Œå¯ä»¥èšåˆå¤šä¸ªByteBufferå¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥åƒæ“ä½œä¸€ä¸ªBufferé‚£æ ·æ–¹ä¾¿çš„å¯¹ç»„åˆBufferè¿›è¡Œæ“ä½œï¼Œé¿å…äº†ä¼ ç»Ÿé€šè¿‡å†…å­˜æ‹·è´çš„æ–¹å¼å°†å‡ ä¸ªå°Bufferåˆå¹¶æˆä¸€ä¸ªå¤§çš„Bufferã€‚

CompositeByteBuf æ˜¯ Netty ä¸­å®ç°é›¶æ‹·è´æœºåˆ¶éå¸¸é‡è¦çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼ŒCompositeByteBuf å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè™šæ‹Ÿçš„ Buffer å¯¹è±¡ï¼Œå®ƒæ˜¯ç”±å¤šä¸ª ByteBuf ç»„åˆè€Œæˆï¼Œä½†æ˜¯åœ¨ CompositeByteBuf å†…éƒ¨ä¿å­˜ç€æ¯ä¸ª ByteBuf çš„å¼•ç”¨å…³ç³»ï¼Œä»é€»è¾‘ä¸Šæ„æˆä¸€ä¸ªæ•´ä½“ã€‚æ¯”è¾ƒå¸¸è§çš„åƒ HTTP åè®®æ•°æ®å¯ä»¥åˆ†ä¸º**å¤´éƒ¨ä¿¡æ¯ header**å’Œ**æ¶ˆæ¯ä½“æ•°æ® body**ï¼Œåˆ†åˆ«å­˜åœ¨ä¸¤ä¸ªä¸åŒçš„ ByteBuf ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬éœ€è¦å°†ä¸¤ä¸ª ByteBuf åˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„åè®®æ•°æ®è¿›è¡Œå‘é€ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å®Œæˆï¼š

```java
ByteBuf httpBuf = Unpooled.buffer(header.readableBytes() + body.readableBytes());

httpBuf.writeBytes(header);

httpBuf.writeBytes(body);
```

å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæƒ³å®ç° header å’Œ body è¿™ä¸¤ä¸ª ByteBuf çš„åˆå¹¶ï¼Œéœ€è¦å…ˆåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ httpBufï¼Œç„¶åå†å°† header å’Œ body åˆ†åˆ«æ‹·è´åˆ°æ–°çš„ httpBufã€‚åˆå¹¶è¿‡ç¨‹ä¸­æ¶‰åŠä¸¤æ¬¡ CPU æ‹·è´ï¼Œè¿™éå¸¸æµªè´¹æ€§èƒ½ã€‚å¦‚æœä½¿ç”¨ CompositeByteBuf å¦‚ä½•å®ç°ç±»ä¼¼çš„éœ€æ±‚å‘¢ï¼Ÿå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
CompositeByteBuf httpBuf = Unpooled.compositeBuffer();

httpBuf.addComponents(true, header, body);
```





3. `Netty` ä¸­ä½¿ç”¨ `FileRegion` å®ç°æ–‡ä»¶ä¼ è¾“çš„é›¶æ‹·è´, ä¸è¿‡åœ¨åº•å±‚ `FileRegion` æ˜¯ä¾èµ–äº Java NIOä¸­çš„ `FileChannel.transfer` çš„é›¶æ‹·è´åŠŸèƒ½

å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„å®ç°æ–¹å¼æ˜¯ï¼š

```c++
1.  `File.read(bytes)`
2.  `Socket.send(bytes)`
```

è¿™ç§æ–¹å¼éœ€è¦å››æ¬¡æ•°æ®æ‹·è´å’Œå››æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š

1. æ•°æ®ä»ç£ç›˜è¯»å–åˆ°å†…æ ¸çš„read buffer
2. æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº
3. æ•°æ®ä»ç”¨æˆ·ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸çš„socket buffer
4. æ•°æ®ä»å†…æ ¸çš„socket bufferæ‹·è´åˆ°ç½‘å¡æ¥å£çš„ç¼“å†²åŒº

æ˜æ˜¾ä¸Šé¢çš„ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œé€šè¿‡javaçš„`FileChannel.transferTo`æ–¹æ³•ï¼Œå¯ä»¥é¿å…ä¸Šé¢ä¸¤æ¬¡å¤šä½™çš„æ‹·è´ï¼ˆå½“ç„¶è¿™éœ€è¦åº•å±‚æ“ä½œç³»ç»Ÿæ”¯æŒï¼‰

1. è°ƒç”¨**transferTo**,æ•°æ®ä»æ–‡ä»¶ç”±DMAå¼•æ“æ‹·è´åˆ°å†…æ ¸read buffer
2. æ¥ç€DMAä»å†…æ ¸read bufferå°†æ•°æ®æ‹·è´åˆ°ç½‘å¡æ¥å£buffer

ä¸Šé¢çš„ä¸¤æ¬¡æ“ä½œéƒ½ä¸éœ€è¦CPUå‚ä¸ï¼Œæ‰€ä»¥å°±è¾¾åˆ°äº†é›¶æ‹·è´ã€‚

> transferToæ–¹æ³•åº•å±‚æ˜¯linuxä¸­çš„sendfile()ï¼šä¸€æ¬¡DMAæ“ä½œä»ç£ç›˜è¯»å–fileåˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åç›´æ¥è·³è¿‡Socketç¼“å†²åŒºå‘é€è‡³ç½‘å¡æ¥å£

Netty ä½¿ç”¨ FileRegion å®ç°æ–‡ä»¶ä¼ è¾“çš„é›¶æ‹·è´ã€‚FileRegion çš„é»˜è®¤å®ç°ç±»æ˜¯ DefaultFileRegionï¼Œé€šè¿‡ DefaultFileRegion å°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ° `NioSocketChannel`ã€‚é‚£ä¹ˆ FileRegion æ˜¯å¦‚ä½•å®ç°é›¶æ‹·è´çš„å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡æºç çœ‹çœ‹ FileRegion åˆ°åº•ä½¿ç”¨äº†ä»€ä¹ˆé»‘ç§‘æŠ€:

```java
public class DefaultFileRegion extends AbstractReferenceCounted implements FileRegion {

    private final File f; // ä¼ è¾“çš„æ–‡ä»¶

    private final long position; // æ–‡ä»¶çš„èµ·å§‹ä½ç½®

    private final long count; // ä¼ è¾“çš„å­—èŠ‚æ•°

    private long transferred; // å·²ç»å†™å…¥çš„å­—èŠ‚æ•°

    private FileChannel file; // æ–‡ä»¶å¯¹åº”çš„ FileChannel
    @Override

    public long transferTo(WritableByteChannel target, long position) throws IOException {

        long count = this.count - position;

        if (count < 0 || position < 0) {

            throw new IllegalArgumentException(

                    "position out of range: " + position +

                    " (expected: 0 - " + (this.count - 1) + ')');

        }

        if (count == 0) {

            return 0L;

        }

        if (refCnt() == 0) {

            throw new IllegalReferenceCountException(0);

        }

        open();

        long written = file.transferTo(this.position + position, count, target);

        if (written > 0) {

            transferred += written;

        } else if (written == 0) {

            validate(this, position);

        }

        return written;

    }
    // çœç•¥å…¶ä»–ä»£ç 

}
```

ä»æºç å¯ä»¥çœ‹å‡ºï¼ŒFileRegion å…¶å®å°±æ˜¯å¯¹ FileChannel çš„åŒ…è£…ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šæ“ä½œï¼Œåº•å±‚ä½¿ç”¨çš„æ˜¯ JDK NIO ä¸­çš„ `FileChannel.transferTo()` æ–¹æ³•å®ç°æ–‡ä»¶ä¼ è¾“ï¼Œæ‰€ä»¥ FileRegion æ˜¯æ“ä½œç³»ç»Ÿçº§åˆ«çš„é›¶æ‹·è´ï¼Œå¯¹äºä¼ è¾“å¤§æ–‡ä»¶ä¼šå¾ˆæœ‰å¸®åŠ©











## Java8 æ–°ç‰¹æ€§



### Default()æ–¹æ³•

é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£Aï¼Œç„¶å`Clazz`ç±»å®ç°äº†æ¥å£A

```java
public interface A {
    default void foo(){
       System.out.println("Calling A.foo()");
    }
}

public class Clazz implements A {
    public static void main(String[] args){
       Clazz clazz = new Clazz();
       clazz.foo();//è°ƒç”¨A.foo()
    }
}
```

ä»£ç æ˜¯å¯ä»¥ç¼–è¯‘çš„ï¼Œå³ä½¿`Clazz`ç±»å¹¶æ²¡æœ‰å®ç°`foo()`æ–¹æ³•ã€‚åœ¨æ¥å£Aä¸­æä¾›äº†`foo()`æ–¹æ³•çš„é»˜è®¤å®ç°

> ä»€ä¹ˆæ˜¯é»˜è®¤æ–¹æ³•?

ç®€å•è¯´ï¼Œå°±æ˜¯æ¥å£**å¯ä»¥æœ‰å®ç°æ–¹æ³•ï¼Œè€Œä¸”ä¸éœ€è¦å®ç°ç±»å»å®ç°å…¶æ–¹æ³•**ã€‚åªéœ€åœ¨æ–¹æ³•åå‰é¢åŠ ä¸ª`default`å…³é”®å­—å³å¯

- `Interface` çš„è®¾è®¡åˆè¡·æ˜¯é¢å‘æŠ½è±¡ï¼Œæé«˜æ‰©å±•æ€§ã€‚è¿™ä¹Ÿç•™æœ‰ä¸€ç‚¹é—æ†¾ï¼Œ`Interface` ä¿®æ”¹çš„æ—¶å€™ï¼Œå®ç°å®ƒçš„ç±»ä¹Ÿå¿…é¡»è·Ÿç€æ”¹

- ä¸ºäº†è§£å†³æ¥å£çš„ä¿®æ”¹ä¸ç°æœ‰çš„å®ç°ä¸å…¼å®¹çš„é—®é¢˜ã€‚æ–° `Interface` çš„æ–¹æ³•å¯ä»¥ç”¨`default` æˆ– `static`ä¿®é¥°ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ–¹æ³•ä½“ï¼Œå®ç°ç±»ä¹Ÿä¸å¿…é‡å†™æ­¤æ–¹æ³•

- `default`ä¿®é¥°çš„æ–¹æ³•ï¼Œ**æ˜¯æ™®é€šå®ä¾‹æ–¹æ³•**ï¼Œå¯ä»¥ç”¨`this`è°ƒç”¨ï¼Œå¯ä»¥è¢«å­ç±»ç»§æ‰¿ã€é‡å†™

- `static`ä¿®é¥°çš„æ–¹æ³•ï¼Œä½¿ç”¨ä¸Šå’Œä¸€èˆ¬ç±»é™æ€æ–¹æ³•ä¸€æ ·ã€‚ä½†å®ƒä¸èƒ½è¢«å­ç±»ç»§æ‰¿ï¼Œåªèƒ½ç”¨`Interface`è°ƒç”¨

  > åœ¨ Java ä¸­ï¼Œå­ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œä½†æ˜¯å®ƒä»¬ä¸èƒ½è¢«é‡å†™ã€‚å½“å­ç±»è°ƒç”¨ç»§æ‰¿è‡ªçˆ¶ç±»çš„é™æ€æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„é™æ€æ–¹æ³•ï¼Œè€Œä¸æ˜¯å­ç±»çš„é™æ€æ–¹æ³•ã€‚è¿™æ˜¯å› ä¸ºé™æ€æ–¹æ³•æ˜¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šçš„ï¼Œå®ƒä»¬çš„è°ƒç”¨æ˜¯é€šè¿‡ç±»åæ¥å®ç°çš„ï¼Œè€Œä¸æ˜¯é€šè¿‡å¯¹è±¡å¼•ç”¨æ¥å®ç°çš„ã€‚



å†æ¥çœ‹çœ‹æ¥å£å’ŒæŠ½è±¡ç±»çš„åŒºåˆ«ï¼š

| ç›¸åŒç‚¹                                                       | ä¸åŒç‚¹                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| éƒ½æ˜¯æŠ½è±¡ç±»å‹                                                 | æŠ½è±¡ç±»ä¸å¯ä»¥å¤šé‡ç»§æ‰¿ï¼Œæ¥å£å¯ä»¥å¤šå®ç°                         |
| éƒ½å¯ä»¥æœ‰å®ç°æ–¹æ³•(ä»¥å‰æ¥å£ä¸è¡Œ java8ååŠ å…¥äº†default æ–¹æ³•ï¼Œä¸éœ€è¦å®ç°ç±»æ¥å®ç°äº†) | æŠ½è±¡ç±»å’Œæ¥å£æ‰€åæ˜ å‡ºçš„**è®¾è®¡ç†å¿µ**ä¸åŒã€‚å…¶å®æŠ½è±¡ç±»è¡¨ç¤ºçš„æ˜¯â€is-aâ€å…³ç³»ï¼Œæ¥å£è¡¨ç¤ºçš„æ˜¯â€like-aâ€å…³ç³»ï¼› ä¾‹å¦‚: Class Cat Extends Animal implement Eat  è¡¨ç¤ºCatåªå±Animalè¿™ä¸€ç±»ç‰©ç§(å•ç»§æ‰¿)ï¼Œä½†æ˜¯å®ƒæœ‰Eatçš„åŠŸèƒ½ï¼Œè¿˜å¯ä»¥åŒæ—¶å…·å¤‡Runã€Sleepè¿™æ ·çš„åŠŸèƒ½ (å¯¹åº”æ¥å£çš„å¤šå®ç°ï¼) |
| éƒ½å¯ä»¥ä¸éœ€è¦å®ç°ç±»æˆ–è€…ç»§æ‰¿è€…å»å®ç°æ‰€æœ‰æ–¹æ³•ï¼Œ(ä»¥å‰ä¸è¡Œï¼Œç°åœ¨æ¥å£ä¸­é»˜è®¤æ–¹æ³•ä¸éœ€è¦å®ç°è€…å®ç°) | æ¥å£ä¸­å®šä¹‰çš„å˜é‡é»˜è®¤æ˜¯public static final å‹ï¼Œä¸”å¿…é¡»ç»™å…¶åˆå€¼ï¼Œæ‰€ä»¥å®ç°ç±»ä¸­ä¸èƒ½æ”¹å˜å…¶å€¼ï¼›æŠ½è±¡ç±»ä¸­çš„å˜é‡é»˜è®¤æ˜¯ friendly å‹ï¼Œå…¶å€¼å¯ä»¥åœ¨å­ç±»ä¸­é‡æ–°å®šä¹‰ï¼Œä¹Ÿå¯ä»¥é‡æ–°èµ‹å€¼ |
| æŠ½è±¡ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼šæŠ½è±¡ç±»ä¸èƒ½ç›´æ¥åˆ›å»ºå¯¹è±¡ï¼Œå³ä¸èƒ½ä½¿ç”¨`new`å…³é”®å­—æ¥å®ä¾‹åŒ–æŠ½è±¡ç±»ã€‚**åªèƒ½é€šè¿‡å…¶å­ç±»æ¥å®ä¾‹åŒ–**ï¼Œå­ç±»å¿…é¡»å®ç°æŠ½è±¡ç±»ä¸­çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ï¼›                        æ¥å£æœ¬èº«åŒæ ·ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œ**æ¥å£çš„å®ç°ç±»å¯ä»¥è¢«å®ä¾‹åŒ–**ã€‚**å½“ä¸€ä¸ªç±»å®ç°äº†ä¸€ä¸ªæ¥å£æ—¶ï¼Œå®ƒå¿…é¡»æä¾›æ¥å£ä¸­å®šä¹‰çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•çš„å…·ä½“å®ç°** | æ¥å£çš„æ–¹æ³•æ˜¯ `public abstract` ä¿®é¥°ï¼Œå˜é‡æ˜¯ `public static final` ä¿®é¥°ã€‚ `abstract class` å¯ä»¥ç”¨å…¶ä»–ä¿®é¥°ç¬¦ |











###  å‡½æ•°å¼ç¼–ç¨‹ :crying_cat_face:

å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´é‡Œï¼ŒJavaä¸€ç›´æ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œä¸€åˆ‡çš†å¯¹è±¡ï¼Œå¦‚æœæƒ³è¦è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°å¿…é¡»å±äºä¸€ä¸ªç±»æˆ–å¯¹è±¡ï¼Œç„¶åå†ä½¿ç”¨ç±»æˆ–å¯¹è±¡è¿›è¡Œè°ƒç”¨ã€‚ä½†æ˜¯åœ¨å…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¦‚JSã€C++ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œè°ƒç”¨ï¼Œæ—¢å¯ä»¥è¯´æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯å‡½æ•°å¼ç¼–ç¨‹ã€‚ä»åŠŸèƒ½ä¸Šæ¥çœ‹ï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹æ²¡ä»€ä¹ˆä¸å¥½çš„åœ°æ–¹ï¼Œä½†æ˜¯ä»å¼€å‘çš„è§’åº¦æ¥çœ‹ï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹ä¼šå¤šå†™å¾ˆå¤šå¯èƒ½æ˜¯é‡å¤çš„ä»£ç è¡Œã€‚æ¯”å¦‚åˆ›å»ºä¸€ä¸ª`Runnable`çš„åŒ¿åç±»çš„æ—¶å€™ï¼š

```java
Runnable runnable = new Runnable() {
    @Override
    public void run() {
        System.out.println("do something...");
    }
};

```

> åŒ¿åå†…éƒ¨ç±»é€šå¸¸ç”¨äºå®ç°æ¥å£ã€ç»§æ‰¿æŠ½è±¡ç±»æˆ–è€…ä½œä¸ºæ–¹æ³•å‚æ•°ï¼Œå¯ä»¥åœ¨ä¸€è¡Œä»£ç ä¸­å®šä¹‰å’Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡
>
> new çˆ¶ç±»æ„é€ å™¨/æ¥å£() {
>     // åŒ¿åå†…éƒ¨ç±»çš„ç±»ä½“éƒ¨åˆ†
> };  // è¿”å›ä¸€ä¸ªå®ç°äº†è¯¥æ¥å£çš„å®ä¾‹å¯¹è±¡ï¼Œä½†æ˜¯è¯¥æ¥å£çš„å®ç°ç±»æ²¡æœ‰å®šä¹‰åå­—ï¼Œæ‰€ä»¥å«åŒ¿åå†…éƒ¨ç±»



è¿™ä¸€æ®µä»£ç ä¸­çœŸæ­£æœ‰ç”¨çš„åªæœ‰`run()`æ–¹æ³•ä¸­çš„å†…å®¹ï¼Œå‰©ä½™çš„éƒ¨åˆ†éƒ½æ˜¯å±äº`Java`ç¼–ç¨‹è¯­è¨€çš„ç»“æ„éƒ¨åˆ†ï¼Œæ²¡ä»€ä¹ˆç”¨ï¼Œä½†æ˜¯è¦å†™ã€‚å¹¸è¿çš„æ˜¯`Java 8`å¼€å§‹ï¼Œå¼•å…¥äº†å‡½æ•°å¼ç¼–ç¨‹æ¥å£ä¸`Lambda`è¡¨è¾¾å¼ï¼Œå¸®åŠ©æˆ‘ä»¬å†™æ›´å°‘æ›´ä¼˜é›…çš„ä»£ç ï¼š

```java
// ä¸€è¡Œå³å¯
Runnable runnable = () -> System.out.println("do something...");
```

å‡½æ•°å¼ç¼–ç¨‹è®¤ä¸ºç¨‹åºå¯ä»¥ç”¨ä¸€ç³»åˆ—æ•°å­¦å‡½æ•°æˆ–è¡¨è¾¾å¼çš„ç»„åˆæ¥è¡¨ç¤ºã€‚å‡½æ•°å¼ç¼–ç¨‹æ˜¯ç¨‹åºé¢å‘æ•°å­¦çš„æ›´åº•å±‚çš„æŠ½è±¡ï¼Œå°†è®¡ç®—è¿‡ç¨‹æè¿°ä¸ºè¡¨è¾¾å¼





å®ç°é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸ä¸€å®šéå¾—ä½¿ç”¨é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼ŒåŒç†ï¼Œå®ç°å‡½æ•°å¼ç¼–ç¨‹ä¹Ÿä¸ä¸€å®šéå¾—ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ã€‚ç°åœ¨ï¼Œå¾ˆå¤šé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿæä¾›äº†ç›¸åº”çš„è¯­æ³•ã€ç±»åº“æ¥æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹ã€‚Javaè¿™ç§é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼Œå¯¹å‡½æ•°å¼ç¼–ç¨‹çš„æ”¯æŒå¯ä»¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æè¿°ï¼š

```java
public class Demo {
  public static void main(String[] args) {
    Optional<Integer> result = 
        Stream.of("a", "be", "hello") // ofè¿”å›Stream<String>å¯¹è±¡
            .map(s -> s.length()) // mapè¿”å›Stream<Integer>å¯¹è±¡
            .filter(l -> l <= 3)  // filterè¿”å›Stream<Integer>å¯¹è±¡
            .max((o1, o2) -> o1-o2);  // maxç»ˆæ­¢æ“ä½œï¼šè¿”å›Optional<Integer>
    System.out.println(result.get()); // è¾“å‡º2
  }
}
```

è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ä»ä¸€ç»„å­—ç¬¦ä¸²æ•°ç»„ä¸­ï¼Œè¿‡æ»¤å‡ºé•¿åº¦å°äºç­‰äº3çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æ±‚å¾—è¿™å…¶ä¸­çš„æœ€å¤§é•¿åº¦ã€‚

Javaä¸ºå‡½æ•°å¼ç¼–ç¨‹å¼•å…¥äº†ä¸‰ä¸ªæ–°çš„è¯­æ³•æ¦‚å¿µï¼š`Stream`ç±»ã€`Lambda`è¡¨è¾¾å¼å’Œå‡½æ•°å¼æ¥å£ï¼ˆ`Functional Inteface`ï¼‰ã€‚`Stream`**ç±»ç”¨æ¥æ”¯æŒé€šè¿‡â€œ.â€çº§è”å¤šä¸ªå‡½æ•°æ“ä½œçš„ä»£ç ç¼–å†™æ–¹å¼**ï¼›å¼•å…¥Lambdaè¡¨è¾¾å¼çš„ä½œç”¨æ˜¯ç®€åŒ–ä»£ç ç¼–å†™ï¼›å‡½æ•°æ¥å£çš„ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¯ä»¥æŠŠå‡½æ•°åŒ…è£¹æˆå‡½æ•°æ¥å£ï¼Œæ¥å®ç°æŠŠå‡½æ•°å½“åšå‚æ•°ä¸€æ ·æ¥ä½¿ç”¨ï¼ˆJava ä¸åƒCé‚£æ ·æ”¯æŒå‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥æŠŠå‡½æ•°ç›´æ¥å½“å‚æ•°æ¥ä½¿ç”¨ï¼‰



#### **Streamç±»**

>  è¿™é‡Œåªæ˜¯ç®€å•è®²äº†ä¸‹Streamçš„æµå¼å¤„ç†ç‰¹æ€§ï¼Œ`Stream` ç±»ä¸»è¦è¿˜æ˜¯ç”¨äºæ“ä½œé›†åˆï¼ˆCollectionï¼‰å’Œæ•°ç»„ï¼ˆArrayï¼‰çš„ï¼Œåé¢å†ç»†è®²

å‡è®¾æˆ‘ä»¬è¦è®¡ç®—è¿™æ ·ä¸€ä¸ªè¡¨è¾¾å¼ï¼š(3-1)*2+5ã€‚å¦‚æœæŒ‰ç…§æ™®é€šçš„å‡½æ•°è°ƒç”¨çš„æ–¹å¼å†™å‡ºæ¥ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š

```
add(multiply(subtract(3,1),2),5);
```

ä¸è¿‡ï¼Œè¿™æ ·ç¼–å†™ä»£ç çœ‹èµ·æ¥ä¼šæ¯”è¾ƒéš¾ç†è§£ï¼Œæˆ‘ä»¬æ¢ä¸ªæ›´æ˜“è¯»çš„å†™æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
subtract(3,1).multiply(2).add(5);
```

åœ¨Javaä¸­ï¼Œâ€œ.â€è¡¨ç¤ºè°ƒç”¨æŸä¸ªå¯¹è±¡çš„æ–¹æ³•ã€‚**ä¸ºäº†æ”¯æŒä¸Šé¢è¿™ç§çº§è”è°ƒç”¨æ–¹å¼ï¼Œæˆ‘ä»¬è®©æ¯ä¸ªå‡½æ•°éƒ½è¿”å›ä¸€ä¸ªé€šç”¨çš„Streamç±»å¯¹è±¡ã€‚åœ¨Streamç±»ä¸Šçš„æ“ä½œæœ‰ä¸¤ç§ï¼šä¸­é—´æ“ä½œå’Œç»ˆæ­¢æ“ä½œã€‚ä¸­é—´æ“ä½œè¿”å›çš„ä»ç„¶æ˜¯Streamç±»å¯¹è±¡ï¼Œè€Œç»ˆæ­¢æ“ä½œè¿”å›çš„æ˜¯ç¡®å®šçš„å€¼ç»“æœ**

ä¸Šè¿°ä¾‹å­ä¸­çš„

```java
 Optional<Integer> result = 
     Stream.of("f", "ba", "hello") // ofè¿”å›Stream<String>å¯¹è±¡
            .map(s -> s.length()) // mapè¿”å›Stream<Integer>å¯¹è±¡
            .filter(l -> l <= 3) // filterè¿”å›Stream<Integer>å¯¹è±¡
            .max((o1, o2) -> o1-o2); // maxç»ˆæ­¢æ“ä½œï¼šè¿”å›Optional<Integer>
    System.out.println(result.get()); // è¾“å‡º
```

å…¶ä¸­`mapã€filter`æ˜¯ä¸­é—´æ“ä½œï¼Œè¿”å›`Stream`ç±»å¯¹è±¡ï¼Œå¯ä»¥ç»§ç»­çº§è”å…¶ä»–æ“ä½œï¼›`max`æ˜¯ç»ˆæ­¢æ“ä½œï¼Œè¿”å›çš„ä¸æ˜¯`Stream`ç±»å¯¹è±¡ï¼Œæ— æ³•å†ç»§ç»­å¾€ä¸‹çº§è”å¤„ç†äº†



> åœ¨ Java ä¸­ï¼Œçº§è”è°ƒç”¨ï¼ˆchained callï¼‰æ˜¯ä¸€ç§è¿ç»­è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ªæ–¹æ³•çš„è¯­æ³•å½¢å¼ï¼Œé€šå¸¸ä½¿ç”¨ç‚¹å·ï¼ˆ`.`ï¼‰è¿æ¥æ¯ä¸ªæ–¹æ³•è°ƒç”¨ã€‚çº§è”è°ƒç”¨å¯ä»¥ä½¿ä»£ç æ›´åŠ ç®€æ´å’Œå¯è¯»ï¼Œå°¤å…¶æ˜¯åœ¨æ–¹æ³•é“¾å¼è°ƒç”¨ä¸­éå¸¸å¸¸è§ã€‚
>
> è¡¥å……ä¸€ä¸ªä¾‹å­ï¼ŒåŠ æ·±å¯¹çº§è”è°ƒç”¨çš„ç†è§£ï¼š
>
> ```java
> StringBuilder sb = new StringBuilder();
> sb.append("Hello").append(" ").append("world").append("!");
> String result = sb.toString();
> System.out.println(result);
> ```
>
> å¯¹äºæ–¹æ³•é“¾å¼è°ƒç”¨ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½åº”è¯¥è¿”å›åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·æ‰èƒ½ä½¿çº§è”è°ƒç”¨æœ‰æ•ˆã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ¯ä¸ª `append()` æ–¹æ³•éƒ½è¿”å› `StringBuilder` å¯¹è±¡æœ¬èº«ï¼Œå› æ­¤å¯ä»¥è¿›è¡Œçº§è”è°ƒç”¨ã€‚å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªæ–¹æ³•è¿”å›äº†ä¸åŒçš„å¯¹è±¡ï¼Œé‚£ä¹ˆçº§è”è°ƒç”¨å°±ä¼šå¤±æ•ˆã€‚









#### **Lambdaè¡¨è¾¾å¼**

å‰é¢æåˆ°Javaå¼•å…¥Lambdaè¡¨è¾¾å¼çš„ä¸»è¦ä½œç”¨æ˜¯ç®€åŒ–ä»£ç ç¼–å†™ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨Lambdaè¡¨è¾¾å¼æ¥ä¹¦å†™ä¾‹å­ä¸­çš„ä»£ç ã€‚æˆ‘ä»¬æ‹¿å…¶ä¸­çš„mapå‡½æ•°æ¥ä¸¾ä¾‹è¯´æ˜ã€‚ä¸‹é¢ä¸‰æ®µä»£ç ï¼Œç¬¬ä¸€æ®µä»£ç å±•ç¤ºäº†mapå‡½æ•°çš„å®šä¹‰ï¼Œå®é™…ä¸Šï¼Œmapå‡½æ•°æ¥æ”¶çš„å‚æ•°æ˜¯ä¸€ä¸ª`Function`æ¥å£(è¯¥æ¥å£æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£)ã€‚ç¬¬äºŒæ®µä»£ç å±•ç¤ºäº†mapå‡½æ•°çš„ä½¿ç”¨æ–¹å¼ã€‚ç¬¬ä¸‰æ®µä»£ç æ˜¯é’ˆå¯¹ç¬¬äºŒæ®µä»£ç ç”¨Lambdaè¡¨è¾¾å¼ç®€åŒ–ä¹‹åçš„å†™æ³•ã€‚å®é™…ä¸Šï¼ŒLambdaè¡¨è¾¾å¼åœ¨Javaä¸­åªæ˜¯ä¸€ä¸ªè¯­æ³•ç³–è€Œå·²ï¼Œåº•å±‚æ˜¯åŸºäºå‡½æ•°å¼æ¥å£æ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬äºŒæ®µä»£ç å±•ç¤ºçš„å†™æ³•ã€‚

```java
// Streamç±»ä¸­mapå‡½æ•°çš„å®šä¹‰ï¼š
public interface Stream<T> extends BaseStream<T, Stream<T>> {
  <R> Stream<R> map(Function<? super T, ? extends R> mapper);
  //...çœç•¥å…¶ä»–å‡½æ•°...
}

// Streamç±»ä¸­mapçš„ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹ï¼š
Stream.of("fo", "bar", "hello").map(new Function<String, Integer>() {
  @Override
  public Integer apply(String s) {
    return s.length();
  }
});

// ç”¨Lambdaè¡¨è¾¾å¼ç®€åŒ–åçš„å†™æ³•ï¼š
Stream.of("fo", "bar", "hello").map(s -> s.length()); 
```

Lambdaè¡¨è¾¾å¼åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š**è¾“å…¥ã€å‡½æ•°ä½“ã€è¾“å‡º**ã€‚è¡¨ç¤ºå‡ºæ¥çš„è¯å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š

```
(a, b) -> { è¯­å¥1ï¼›è¯­å¥2ï¼›...; return è¾“å‡º; } //a,bæ˜¯è¾“å…¥å‚æ•°
```

å®é™…ä¸ŠLambdaè¡¨è¾¾å¼çš„å†™æ³•éå¸¸çµæ´»ã€‚æ¯”å¦‚å¦‚æœè¾“å…¥å‚æ•°åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥çœç•¥ ()ï¼Œç›´æ¥å†™æˆ a->{â€¦}ï¼›å¦‚æœæ²¡æœ‰å…¥å‚ï¼Œå¯ä»¥ç›´æ¥å°†è¾“å…¥å’Œç®­å¤´éƒ½çœç•¥æ‰ï¼Œåªä¿ç•™å‡½æ•°ä½“ï¼›å¦‚æœå‡½æ•°ä½“åªæœ‰ä¸€ä¸ªè¯­å¥ï¼Œé‚£å¯ä»¥å°†{}çœç•¥æ‰ï¼›å¦‚æœå‡½æ•°æ²¡æœ‰è¿”å›å€¼ï¼Œreturnè¯­å¥å°±å¯ä»¥ä¸ç”¨å†™äº†ï¼š

```java
Optional<Integer> result = Stream.of("f", "ba", "hello")
        .map(s -> s.length())
        .filter(l -> l <= 3)
        .max((o1, o2) -> o1-o2);
        
// è¿˜åŸä¸ºåŒ¿åå†…éƒ¨ç±»çš„å®ç°æ–¹å¼
Optional<Integer> result2 = Stream.of("fo", "bar", "hello")
        .map(new Function<String, Integer>() {
          @Override
          public Integer apply(String s) {
            return s.length();
          }
        })
        .filter(new Predicate<Integer>() {
          @Override
          public boolean test(Integer l) {
            return l <= 3;
          }
        })
        .max(new Comparator<Integer>() {
          @Override
          public int compare(Integer o1, Integer o2) {
            return o1 - o2;
          }
        });
```

`Lambda`è¡¨è¾¾å¼ä¸åŒ¿åç±»çš„å¼‚åŒé›†ä¸­ä½“ç°åœ¨ä»¥ä¸‹ä¸‰ç‚¹ä¸Šï¼š

- `Lambda`å°±æ˜¯ä¸ºäº†ä¼˜åŒ–åŒ¿åå†…éƒ¨ç±»è€Œç”Ÿï¼Œ`Lambda`è¦æ¯”åŒ¿åç±»ç®€æ´çš„å¤šå¾—å¤šã€‚
- `Lambda`ä»…é€‚ç”¨äºå‡½æ•°å¼æ¥å£ï¼ŒåŒ¿åç±»ä¸å—é™ã€‚
- å³åŒ¿åç±»ä¸­çš„thisæ˜¯â€œåŒ¿åç±»å¯¹è±¡â€æœ¬èº«ï¼›`Lambda`è¡¨è¾¾å¼ä¸­çš„thisæ˜¯æŒ‡â€œè°ƒç”¨`Lambda`è¡¨è¾¾å¼çš„å¯¹è±¡â€



æ³¨æ„ï¼š

1.å¦‚æœ Lambda è¡¨è¾¾å¼çš„ä¸»ä½“åªæœ‰ä¸€æ¡è¡¨è¾¾å¼,é‚£ä¹ˆè¯¥è¡¨è¾¾å¼çš„å€¼å°±æ˜¯ Lambda è¡¨è¾¾å¼çš„è¿”å›å€¼ã€‚

2.å¦‚æœ Lambda è¡¨è¾¾å¼çš„ä¸»ä½“æœ‰å¤šæ¡è¯­å¥ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨å¤§æ‹¬å· `{}` åŒ…å«è¿™äº›è¯­å¥ï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨ `return` å…³é”®å­—æ¥æŒ‡å®šè¿”å›å€¼ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒLambda è¡¨è¾¾å¼çš„è¿”å›ç±»å‹å¿…é¡»ä¸å¯¹åº”çš„å‡½æ•°å¼æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•çš„è¿”å›ç±»å‹ç›¸åŒæˆ–å…¼å®¹ã€‚





#### **å‡½æ•°å¼æ¥å£**

å®é™…ä¸Šï¼Œä¸Šé¢ä¸€æ®µä»£ç ä¸­çš„`Function`ã€`Predicate`ã€`Comparator`éƒ½æ˜¯å‡½æ•°å¼æ¥å£ã€‚

1. **å‡½æ•°æ¥å£å°±æ˜¯æ¥å£ã€‚ä¸è¿‡å®ƒä¹Ÿæœ‰è‡ªå·±ç‰¹åˆ«çš„åœ°æ–¹ï¼Œé‚£å°±æ˜¯è¦æ±‚åªåŒ…å«ä¸€ä¸ªæœªå®ç°çš„æ–¹æ³•ã€‚å› ä¸ºåªæœ‰è¿™æ ·ï¼ŒLambdaè¡¨è¾¾å¼æ‰èƒ½æ˜ç¡®çŸ¥é“åŒ¹é…çš„æ˜¯å“ªä¸ªæ–¹æ³•ã€‚å¦‚æœæœ‰ä¸¤ä¸ªæœªå®ç°çš„æ–¹æ³•ï¼Œå¹¶ä¸”æ¥å£å…¥å‚ã€è¿”å›å€¼éƒ½ä¸€æ ·ï¼Œé‚£Javaåœ¨ç¿»è¯‘Lambdaè¡¨è¾¾å¼çš„æ—¶å€™ï¼Œå°±ä¸çŸ¥é“è¡¨è¾¾å¼å¯¹åº”å“ªä¸ªæ–¹æ³•äº†ã€‚**
2. **è€Œä¸”æ¢ä¸ªè§’åº¦ç†è§£ï¼Œç”¨lambdaè¡¨è¾¾å¼æ¥åˆ›å»ºä¸€ä¸ªæ¥å£çš„å®ä¾‹ï¼Œé‚£ä¹ˆè¯¥å®ä¾‹å¿…ç„¶è¦å®ç°æ¥å£çš„æ‰€æœ‰æŠ½è±¡æ–¹æ³•ï¼Œè‡ªç„¶æŠ½è±¡æ–¹æ³•ä¹Ÿå°±åªèƒ½æœ‰ä¸€ä¸ªäº†ï¼Œä¸ç„¶æ€ä¹ˆåŒ¹é…å‘¢ï¼Ÿ**

å‡½æ•°å¼æ¥å£æ˜¯`interface`ï¼Œä½†è¿˜éœ€è¦æ»¡è¶³ï¼š

- ä¸€ä¸ªå‡½æ•°å¼æ¥å£åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•(`single abstract method` è€Œä¸”å¿…é¡»æ˜¯é`Object`ç±»ä¸‹çš„ï¼Œç¬¬äºŒç‚¹ä¹Ÿæåˆ°äº†)ï¼›
- **Objectç±»ä¸­çš„`public abstract method`ä¸ä¼šè¢«è§†ä¸ºå•ä¸€çš„æŠ½è±¡æ–¹æ³•**ï¼›
- å‡½æ•°å¼æ¥å£å¯ä»¥æœ‰é»˜è®¤æ–¹æ³•å’Œé™æ€æ–¹æ³•ï¼›
- å‡½æ•°å¼æ¥å£å¯ä»¥ç”¨`@FunctionalInterface`æ³¨è§£è¿›è¡Œä¿®é¥°ã€‚

æ»¡è¶³è¿™äº›æ¡ä»¶çš„`interface`ï¼Œå°±å¯ä»¥è¢«è§†ä¸º**å‡½æ•°å¼æ¥å£**ã€‚ä¾‹å¦‚Java 8ä¸­çš„`Comparator`æ¥å£ï¼š

```java
@FunctionalInterface
public interface Comparator<T> {
    
    /**
     * single abstract method
     * @since 1.8
     */
    int compare(T o1, T o2);
    
    

    /**
     * Objectç±»ä¸­çš„public abstract method 
     * é‡å†™äº†è¶…ç±»Objectç±»ä¸­ä»»æ„ä¸€ä¸ªpublicæ–¹æ³•çš„æ–¹æ³•å¹¶ä¸ç®—æ¥å£ä¸­çš„æŠ½è±¡æ–¹æ³•
     * @since 1.8
     */
    boolean equals(Object obj);
    
    

    /**
     * é»˜è®¤æ–¹æ³•
     * @since 1.8
     */
    default Comparator<T> reversed() {
        return Collections.reverseOrder(this);
    }

    
    
    /**
     * é™æ€æ–¹æ³•
     * @since 1.8
     */
    public static <T extends Comparable<? super T>> Comparator<T> reverseOrder() {
        return Collections.reverseOrder();
    }

    //çœç•¥...
}
```

å‡½æ•°å¼æ¥å£æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸€å¥è¯ï¼Œå‡½æ•°å¼æ¥å£å¸¦ç»™æˆ‘ä»¬æœ€å¤§çš„å¥½å¤„å°±æ˜¯ï¼šå¯ä»¥ä½¿ç”¨æç®€çš„`lambda`è¡¨è¾¾å¼å®ä¾‹åŒ–æ¥å£ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬æˆ–å¤šæˆ–å°‘ä½¿ç”¨è¿‡ä¸€äº›åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œæ¯”å¦‚`Runnable`ã€`ActionListener`ã€`Comparator`ç­‰ç­‰ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦ç”¨`Comparator`å®ç°æ’åºç®—æ³•ï¼Œæˆ‘ä»¬çš„å¤„ç†æ–¹å¼é€šå¸¸æ— å¤–ä¹ä¸¤ç§ï¼š

- è§„è§„çŸ©çŸ©çš„å†™ä¸€ä¸ªå®ç°äº†`Comparator`æ¥å£çš„`Java`ç±»å»å°è£…æ’åºé€»è¾‘ã€‚è‹¥ä¸šåŠ¡éœ€è¦å¤šç§æ’åºæ–¹å¼ï¼Œé‚£å°±å¾—å†™å¤šä¸ªç±»æä¾›å¤šç§å®ç°ï¼Œè€Œè¿™äº›å®ç°å¾€å¾€åªéœ€ä½¿ç”¨ä¸€æ¬¡ã€‚

- å¦å¤–ä¸€ç§èªæ˜ä¸€äº›çš„åšæ³•æ— å¤–ä¹å°±æ˜¯åœ¨éœ€è¦çš„åœ°æ–¹æä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œæ¯”å¦‚:

  ```java
  public class Test { 
      public static void main(String args[]) { 
          List<Person> persons = new ArrayList<Person>();
          Collections.sort(persons, new Comparator<Person>(){
              @Override
              public int compare(Person o1, Person o2) {
                  return Integer.compareTo(o1.getAge(), o2.getAge());
              }
          });
      } 
  }
  ```

- åŒ¿åå†…éƒ¨ç±»å®ç°çš„ä»£ç é‡æ²¡æœ‰å¤šåˆ°å“ªé‡Œå»ï¼Œç»“æ„ä¹Ÿè¿˜ç®—æ¸…æ™°ã€‚`Comparator`æ¥å£åœ¨`Jdk 1.8`çš„å®ç°å¢åŠ äº†`FunctionalInterface`æ³¨è§£ï¼Œä»£è¡¨`Comparator`æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œä½¿ç”¨è€…å¯æ”¾å¿ƒçš„é€šè¿‡`lambda`è¡¨è¾¾å¼æ¥å®ä¾‹åŒ–ã€‚é‚£æˆ‘ä»¬æ¥çœ‹çœ‹ä½¿ç”¨`lambda`è¡¨è¾¾å¼æ¥å¿«é€Ÿ`new`ä¸€ä¸ªè‡ªå®šä¹‰æ¯”è¾ƒå™¨æ‰€éœ€è¦ç¼–å†™çš„ä»£ç ï¼š

- ```java
  Comparator<Person> comparator = (p1, p2) -> Integer.compareTo(p1.getAge(), p2.getAge());
  
  //Comparatoræ¥å£ä¸­çš„å”¯ä¸€æŠ½è±¡æ–¹æ³•
  int compare(T o1, T o2);
  ```

  -> å‰é¢çš„()æ˜¯`Comparator`æ¥å£ä¸­`compare`æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ï¼Œ-> åé¢åˆ™æ˜¯`compare`æ–¹æ³•çš„æ–¹æ³•ä½“

  ç„¶åç›´æ¥ä¼ å…¥`Collections.sort()`å³å¯ï¼š

  ```java
  Collections.sort(persons,comparator)ï¼›
  ```

  å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥åˆä¸ºä¸€æ­¥ï¼š

  ```java
  Collections.sort(persons,(p1, p2) -> Integer.compareTo(p1.getAge(), p2.getAge()))ï¼›
  ```



å†æ¥çœ‹ä¸€ä¸ªéå¸¸ç»å…¸çš„**é€šè¿‡lambdaè¡¨è¾¾å¼åˆ›å»ºçº¿ç¨‹**çš„ä¾‹å­ï¼š

```java
//ä¸å£°æ˜å˜é‡çš„æƒ…å†µä¸‹ï¼š
new Thread(() ->{
    System.out.println("å­çº¿ç¨‹å¯åŠ¨");
     /*è¿™é‡Œå…¶å®çœç•¥äº†  return;  
     
     lambdaè¡¨è¾¾å¼çš„ä¸»ä½“æœ‰å¤šæ¡è¯­å¥æ—¶ï¼š
     éœ€è¦ä½¿ç”¨å¤§æ‹¬å· {} åŒ…å«è¿™äº›è¯­å¥ï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨ return å…³é”®å­—æ¥æŒ‡å®šè¿”å›å€¼ï¼›
     Runnableæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œè‡ªåŠ¨åŒ¹é…äº†å”¯ä¸€éObjectç±»çš„æŠ½è±¡æ–¹æ³•run()ï¼Œä¸”æ²¡æœ‰è¿”å›å€¼ï¼›
}    */
     
).start();


//å£°æ˜å¼•ç”¨å˜é‡çš„æƒ…å†µä¸‹ï¼š
Thread t2=new Thread( ()->{
    System.out.println("å­çº¿ç¨‹2å¯åŠ¨");
});
t2.start();
```







#### å‡½æ•°å¼ç¼–ç¨‹å®æˆ˜

1ã€ä¾‹å¦‚ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªç®€å•çš„å‡½æ•°æ¥å£ `MathOperation`ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³• `int operate(int a, int b)`ï¼Œè¡¨ç¤ºä¸¤ä¸ªæ•´æ•°çš„æ“ä½œã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `lambda` è¡¨è¾¾å¼æ¥å®ç°è¿™ä¸ªæ¥å£å¹¶è¿›è¡Œè°ƒç”¨:

```java
@FunctionalInterface
interface MathOperation {
    int operate(int a, int b);
}

public class LambdaExample {
    public static void main(String[] args) {
        // ä½¿ç”¨ lambda è¡¨è¾¾å¼åˆ›å»º MathOperation æ¥å£çš„å®ä¾‹
        
        /*
        å¦‚æœ Lambda è¡¨è¾¾å¼çš„ä¸»ä½“åªæœ‰ä¸€æ¡è¡¨è¾¾å¼ï¼Œ
        é‚£ä¹ˆè¯¥è¡¨è¾¾å¼çš„å€¼å°±æ˜¯ Lambda è¡¨è¾¾å¼çš„è¿”å›å€¼ã€‚
        *ä¸‹åˆ—å››æ¡è¯­å¥åˆ›å»ºäº†å››ä¸ªMathOperationçš„å®ä¾‹
            */
        MathOperation add = (a, b) -> a + b;
        MathOperation subtract = (a, b) -> a - b;
        MathOperation multiply = (a, b) -> a * b;
        MathOperation divide = (a, b) -> a / b;

        int num1 = 10;
        int num2 = 5;

        // è°ƒç”¨ MathOperation æ¥å£çš„å®ç°æ–¹æ³•
        System.out.println("Addition: " + add.operate(num1, num2));
        System.out.println("Subtraction: " + subtract.operate(num1, num2));
        System.out.println("Multiplication: " + multiply.operate(num1, num2));
        System.out.println("Division: " + divide.operate(num1, num2));
    }
}

```

ä¸Šè¿°å‡ºç°çš„ `Lambda` è¡¨è¾¾å¼éƒ½æ˜¯å‡½æ•°å¼æ¥å£ `MathOperation` çš„å®ä¾‹ï¼Œå®ƒä»¬å¹¶ä¸æ˜¯ `MathOperation` çš„**å…·ä½“å®ç°ç±»**ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒJava ç¼–è¯‘å™¨ä¼šæ ¹æ® `Lambda` è¡¨è¾¾å¼çš„ç»“æ„**è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒ¿åç±»æˆ–è€…ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»æ¥å®ç°å‡½æ•°å¼æ¥å£çš„æŠ½è±¡æ–¹æ³•**ï¼Œ**å¹¶å°† `Lambda` è¡¨è¾¾å¼è½¬æ¢ä¸ºè¯¥åŒ¿åç±»æˆ–åŠ¨æ€ä»£ç†ç±»çš„å®ä¾‹**







2ã€é›†åˆè¿­ä»£æŸ¥è¯¢ï¼š

```java
void lamndaFor() {
        List<String> strings = Arrays.asList("1", "2", "3");
        //ä¼ ç»Ÿforeach
        for (String s : strings) {
            System.out.println(s);
        }
    
        //Lambda foreach
        strings.forEach((s) -> System.out.println(s));
    
    
        //or
        strings.forEach(System.out::println);
    
    
 		//map
        Map<Integer, String> map = new HashMap<>();
        map.forEach((k,v)->System.out.println(v));
}

```

(1) å¯¹äº `strings.forEach((s) -> System.out.println(s))ï¼›`ï¼š

`forEach` æ–¹æ³•æ¥å—ä¸€ä¸ª `Consumer` å‡½æ•°å¼æ¥å£ä½œä¸ºå‚æ•°(å³æœ€ç»ˆè¦è¿”å›ä¸€ä¸ª`Consumer`æ¥å£çš„å®ä¾‹)ï¼Œè¯¥æ¥å£ä¸­åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³• `void accept(T t)`ï¼Œè¡¨ç¤ºæ¶ˆè´¹ä¸€ä¸ªæŒ‡å®šç±»å‹çš„å¯¹è±¡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Lambda` è¡¨è¾¾å¼ `(s) -> System.out.println(s)` æ¥åˆ›å»ºä¸€ä¸ª `Consumer` å®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•° `s`ï¼Œå¹¶å°†å…¶æ‰“å°åˆ°æ§åˆ¶å°ä¸Šã€‚



(2) å¯¹äº `strings.forEach(System.out::println);`ï¼š

`System.out::println` è¡¨ç¤ºå¼•ç”¨äº† `System.out` å¯¹è±¡çš„ `println` æ–¹æ³•ï¼Œå¹¶å°†è¯¥æ–¹æ³•ä½œä¸º `Consumer` æ¥å£çš„æŠ½è±¡æ–¹æ³• `void accept(T t)` çš„å®ç°,å³ä½¿ç”¨äº†æ–¹æ³•å¼•ç”¨ `System.out::println` åˆ›å»ºä¸€ä¸ª `Consumer` å®ä¾‹









### Stream

`java.util.Stream` è¡¨ç¤ºèƒ½åº”ç”¨åœ¨ä¸€ç»„å…ƒç´ ä¸Šä¸€æ¬¡æ‰§è¡Œçš„æ“ä½œåºåˆ—ã€‚`Stream` æ“ä½œåˆ†ä¸ºä¸­é—´æ“ä½œæˆ–è€…æœ€ç»ˆæ“ä½œä¸¤ç§ï¼Œæœ€ç»ˆæ“ä½œè¿”å›ä¸€ç‰¹å®šç±»å‹çš„è®¡ç®—ç»“æœï¼Œè€Œä¸­é—´æ“ä½œè¿”å› `Stream` æœ¬èº«ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å°†å¤šä¸ªæ“ä½œä¾æ¬¡ä¸²èµ·æ¥ã€‚`Stream` çš„åˆ›å»ºéœ€è¦æŒ‡å®šä¸€ä¸ªæ•°æ®æºï¼Œæ¯”å¦‚` java.util.Collection` çš„å­ç±»ï¼ŒList æˆ–è€… Setï¼Œ Map ä¸æ”¯æŒã€‚`Stream` çš„æ“ä½œå¯ä»¥ä¸²è¡Œæ‰§è¡Œæˆ–è€…å¹¶è¡Œæ‰§è¡Œ



Java 8 å¼•å…¥äº† Stream APIï¼Œå®ƒæ˜¯**ç”¨äºå¤„ç†é›†åˆæ•°æ®çš„ä¸€ç§æ–°çš„æŠ½è±¡å±‚**ã€‚Stream API æä¾›äº†ä¸€ç§ç±»ä¼¼äº SQL æŸ¥è¯¢è¯­å¥çš„æ–¹å¼æ¥æ“ä½œæ•°æ®é›†åˆï¼Œå¯ä»¥è½»æ¾åœ°å®ç°å¯¹é›†åˆæ•°æ®çš„è¿‡æ»¤ã€æ˜ å°„ã€æ’åºã€èšåˆç­‰æ“ä½œ

Stream æ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œå®ƒä¸æ˜¯æ•°æ®ç»“æ„ï¼Œä¹Ÿä¸æ˜¯é›†åˆï¼Œè€Œæ˜¯æ•°æ®åœ¨æŸä¸ªé˜¶æ®µçš„ä¸€ä¸ªè§†å›¾ã€‚Stream ä¸ä¼šä¿®æ”¹åŸå§‹çš„æ•°æ®é›†åˆï¼Œè€Œæ˜¯é€šè¿‡ç®¡é“æ“ä½œå°†æ•°æ®è½¬åŒ–ä¸ºæ–°çš„ Stream è¿›è¡Œå¤„ç†

ä½¿ç”¨ Stream API çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºä»£ç æ›´åŠ ç®€æ´ã€æ˜“è¯»ï¼Œå¯ä»¥é€šè¿‡é“¾å¼è°ƒç”¨ä¸€ç³»åˆ—çš„æ“ä½œæ¥å®ç°æ•°æ®å¤„ç†ï¼ŒåŒæ—¶å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨æé«˜æ€§èƒ½

Stream API ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. å»¶è¿Ÿæ‰§è¡Œï¼šStream ä¸­çš„æ“ä½œä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ç»ˆç«¯æ“ä½œæ—¶æ‰è¿›è¡Œè®¡ç®—ã€‚
2. æµæ°´çº¿ï¼šStream ä¸­çš„æ“ä½œå¯ä»¥è¿æ¥èµ·æ¥å½¢æˆä¸€ä¸ªæµæ°´çº¿ï¼Œæ¯ä¸ªæ“ä½œéƒ½æ˜¯æµæ°´çº¿ä¸­çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå¯ä»¥ä¾æ¬¡è¿›è¡Œå¤„ç†ã€‚
3. å†…éƒ¨è¿­ä»£ï¼šStream é‡‡ç”¨å†…éƒ¨è¿­ä»£çš„æ–¹å¼ï¼Œå³ç”± Stream API æ¥å¤„ç†è¿­ä»£è¿‡ç¨‹ï¼Œå¼€å‘è€…åªéœ€å…³æ³¨æ•°æ®çš„å¤„ç†é€»è¾‘ï¼Œè€Œæ— éœ€å…³æ³¨å…·ä½“çš„è¿­ä»£è¿‡ç¨‹ã€‚
4. å‡½æ•°å¼ç¼–ç¨‹ï¼š**Stream API æ”¯æŒå‡½æ•°å¼ç¼–ç¨‹çš„é£æ ¼**ï¼Œå¯ä»¥ä½¿ç”¨ lambda è¡¨è¾¾å¼æ¥å®ç°æ•°æ®å¤„ç†é€»è¾‘ï¼Œä»£ç æ›´åŠ ç®€æ´ã€‚

ä½¿ç”¨ Stream API å¯ä»¥å¤§å¤§ç®€åŒ–é›†åˆæ•°æ®çš„å¤„ç†ä»£ç 



ä¾‹1ï¼š

```java
List<Integer> numbers = Arrays.asList(1, 2, 3, 4, 5);

// ä½¿ç”¨ Stream API å¯¹é›†åˆè¿›è¡Œè¿‡æ»¤ã€æ˜ å°„å’Œæ±‚å’Œæ“ä½œ
int sum = numbers.stream()   //è¿”å›ä¸€ä¸ªStreamå¯¹è±¡
    .filter(n -> n % 2 == 0) //å¼€å§‹çº§è”æµå¼è°ƒç”¨ï¼š 1ã€ è¿‡æ»¤å¶æ•°  ç”¨åˆ°äº†lambdaè¡¨è¾¾å¼
    .mapToInt(n -> n * 2)    // 2ã€æ˜ å°„ä¸ºåŸå€¼çš„ä¸¤å€
    .sum();                  // é€€å‡ºStreamæµ ï¼š 3ã€æ±‚å’Œ    è¿”å›intç±»å‹

System.out.println(sum); // è¾“å‡ºç»“æœï¼š12    2*2+4*2=12

```



ä¾‹2ï¼š

å…ˆåˆ›å»ºå®ä¾‹ä»£ç éœ€è¦ç”¨åˆ°çš„æ•°æ® Listï¼š

```java
List<String> stringList = new ArrayList<>();
stringList.add("ddd2");
stringList.add("aaa2");
stringList.add("bbb1");
stringList.add("aaa1");
stringList.add("bbb3");
stringList.add("ccc");
stringList.add("bbb2");
stringList.add("ddd1");
```



**Filter(è¿‡æ»¤)**:

è¿‡æ»¤é€šè¿‡ä¸€ä¸ª `predicate` æ¥å£æ¥è¿‡æ»¤å¹¶åªä¿ç•™ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œ**è¯¥æ“ä½œå±äºä¸­é—´æ“ä½œ**ï¼Œ**æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿‡æ»¤åçš„ç»“æœæ¥åº”ç”¨å…¶ä»– `Stream` æ“ä½œï¼ˆæ¯”å¦‚ `forEach`ï¼‰, `forEach` éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥å¯¹è¿‡æ»¤åçš„å…ƒç´ ä¾æ¬¡æ‰§è¡Œã€‚forEach æ˜¯ä¸€ä¸ªæœ€ç»ˆæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åœ¨ forEach ä¹‹åæ¥æ‰§è¡Œå…¶ä»– `Stream` æ“ä½œ**

```java
// æµ‹è¯• Filter(è¿‡æ»¤)
stringList
    .stream()
    .filter((s) -> s.startsWith("a"))  //è¿‡æ»¤å‡º'a'å¼€å¤´çš„å­—ç¬¦ä¸²
    .forEach(System.out::println);//aaa2 aaa1
```

`forEach` æ˜¯ä¸º `Lambda` è€Œè®¾è®¡çš„ï¼Œä¿æŒäº†æœ€ç´§å‡‘çš„é£æ ¼ã€‚è€Œä¸” Lambda è¡¨è¾¾å¼æœ¬èº«æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œéå¸¸æ–¹ä¾¿



**Sorted(æ’åº):**

æ’åºæ˜¯ä¸€ä¸ª **ä¸­é—´æ“ä½œ**ï¼Œè¿”å›çš„æ˜¯æ’åºå¥½åçš„`Stream`ï¼Œ**å¦‚æœä¸æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„ `Comparator` åˆ™ä¼šä½¿ç”¨é»˜è®¤æ’åºæ–¹å¼**

```java
// æµ‹è¯• Sort (æ’åº)
stringList
    .stream()
    .sorted()
    .filter((s) -> s.startsWith("a"))
    .forEach(System.out::println);// aaa1 aaa2    
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ’åºåªåˆ›å»ºäº†ä¸€ä¸ªæ’åˆ—å¥½åçš„ `Stream`ï¼Œ**è€Œä¸ä¼šå½±å“åŸæœ‰çš„æ•°æ®æº**ï¼Œæ’åºä¹‹ååŸæ•°æ® `stringList` æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„ï¼š

```java
System.out.println(stringList);// ddd2, aaa2, bbb1, aaa1, bbb3, ccc, bbb2, ddd1
```





> è¿™é‡Œè§£é‡Šä¸€ä¸‹`forEach(System.out::println)`
>
> forEach()ä¼ å…¥å‚æ•°æ˜¯`Consumer<? super E>`;
>
> **Consumer<T>æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£**ï¼Œä¸”å”¯ä¸€æŠ½è±¡æ–¹æ³•ä¸º**`void accept(T t)`**
>
> ```java
> Consumer<Object> consumer = new Consumer<Object>() 
> {
>     
>     @Override
>     public void accept(Object o) {
>         System.out.println(o);
>     }
> };
> ```
>
> ä½†æ˜¯åœ¨Java8åï¼Œæ”¯æŒLamdbaè¡¨è¾¾å¼ï¼Œæ‰€ä»¥å®ç°æ¥å£çš„åŒ¿åç±»å¯ä»¥è¿™ä¹ˆå†™:
>
> ```java
> Consumer<Object> consumer = s-> System.out.println(s);//Lamdbaè¡¨è¾¾å¼
> list.forEach(consumer);
> ```
>
> `System`ç±»é‡Œæœ‰ä¸ª`PrintStream`å¯¹è±¡çš„é™æ€å¼•ç”¨outâ€”â€”â€”â€”â€”>`System.out`
>
> å¯¹è±¡`PrintStream`é‡Œé¢æœ‰`println`æ–¹æ³•, `System.out::println`
>
> `containingObject::instanceMethodName`è¡¨ç¤º**å¼•ç”¨ç‰¹å®šå¯¹è±¡çš„å®ä¾‹æ–¹æ³•** è¿™é‡Œæ˜¯ï¼š`java.io.PrintStream::println`
>
> ![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/println.png)





**Map(æ˜ å°„):**

ä¸­é—´æ“ä½œ `map` ä¼šå°†å…ƒç´ æ ¹æ®æŒ‡å®šçš„`Function`æ¥å£æ¥ä¾æ¬¡å°†å…ƒç´ è½¬æˆå¦å¤–çš„å¯¹è±¡

ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™å­—ç¬¦ä¸²ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `map` æ¥å°†å¯¹è±¡è½¬æ¢æˆå…¶ä»–ç±»å‹ï¼Œ`map` è¿”å›çš„ `Stream` ç±»å‹æ˜¯æ ¹æ®ä½  `map` ä¼ é€’è¿›å»çš„å‡½æ•°çš„è¿”å›å€¼å†³å®šçš„

```java
// æµ‹è¯• Map æ“ä½œ
stringList
    .stream()
    .map(String::toUpperCase)
    .sorted((a, b) -> b.compareTo(a))  //é™åºæ’åˆ—ç›¸å½“äº
    .forEach(System.out::println);// "DDD2", "DDD1", "CCC", "BBB3", "BBB2", "BBB1"
```



**Count(è®¡æ•°)ï¼š**

è®¡æ•°æ˜¯ä¸€ä¸ª **æœ€ç»ˆæ“ä½œ**ï¼Œè¿”å› `Stream` ä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œ**è¿”å›å€¼ç±»å‹æ˜¯ long**

```java
      //æµ‹è¯• Count (è®¡æ•°)æ“ä½œ
        long startsWithB =
                stringList
                        .stream()
                        .filter((s) -> s.startsWith("b"))
                        .count();
        System.out.println(startsWithB);    // 3
```



















### Optional























# Javaé›†åˆ

## List

### ArrayList

#### åˆå§‹åŒ–

`ArrayList`åº•å±‚å­˜å‚¨æ•°æ®ä½¿ç”¨çš„æ˜¯`Object[]`æ•°ç»„ï¼š

```java
transient Object[] elementData;
//ArrayList ä¸­å­˜å‚¨æ•°æ®çš„æ•°ç»„ elementData æ˜¯ç”¨ transient ä¿®é¥°çš„ï¼Œå› ä¸ºè¿™ä¸ªæ•°ç»„æ˜¯åŠ¨æ€æ‰©å±•çš„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç©ºé—´éƒ½è¢«ä½¿ç”¨ï¼Œå› æ­¤å°±ä¸éœ€è¦æ‰€æœ‰çš„å†…å®¹éƒ½è¢«åºåˆ—åŒ–ã€‚é€šè¿‡é‡å†™åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•ï¼Œä½¿å¾—å¯ä»¥åªåºåˆ—åŒ–æ•°ç»„ä¸­æœ‰å†…å®¹çš„é‚£éƒ¨åˆ†æ•°æ®

private static final int DEFAULT_CAPACITY = 10;  //å®šä¹‰ä¸€ä¸ªé»˜è®¤å®¹é‡
```

> 
>
> `transient` æ˜¯ Java ä¸­çš„å…³é”®å­—ï¼Œç”¨äºä¿®é¥°ç±»çš„æˆå‘˜å˜é‡ã€‚å½“ä¸€ä¸ªå˜é‡è¢« `transient` ä¿®é¥°æ—¶ï¼Œè¯¥å˜é‡å°†**ä¸ä¼šè¢«é»˜è®¤çš„åºåˆ—åŒ–æœºåˆ¶åºåˆ—åŒ–**ï¼Œå³å¯¹è±¡ä½¿ç”¨é»˜è®¤åºåˆ—åŒ–æœºåˆ¶åºåˆ—åŒ–ä¸ºå­—èŠ‚æµæ—¶ï¼Œè¯¥å˜é‡çš„å€¼ä¸ä¼šè¢«å†™å…¥åˆ°å­—èŠ‚æµä¸­
>
> 
>
> å¦‚æœæƒ³è¦åºåˆ—åŒ– `ArrayList` ä¸­çš„ `elementData` æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶æ¥å®ç°



**å¸¦åˆå§‹å®¹é‡å‚æ•°çš„æ•°ç»„åˆå§‹åŒ–ï¼š**

```java
 public ArrayList(int initialCapacity) {
        if (initialCapacity > 0) {
            //å¦‚æœä¼ å…¥çš„å‚æ•°å¤§äº0ï¼Œåˆ›å»ºinitialCapacityå¤§å°çš„æ•°ç»„
            this.elementData = new Object[initialCapacity];
        } else if (initialCapacity == 0) {
            this.elementData = EMPTY_ELEMENTDATA;//å¦åˆ™åˆ›å»ºç©ºæ•°ç»„
        } else {
            throw new IllegalArgumentException("Illegal Capacity: "+
                                               initialCapacity);
        }
    }

```



**é»˜è®¤æ„é€ æ–¹æ³•**ï¼š

```java
// DEFAULTCAPACITY_EMPTY_ELEMENTDATA æ˜¯ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œå› æ­¤å…¶é•¿åº¦ä¸º 0
//è¿™ä¸ªç©ºçš„ Object æ•°ç»„ä¸å ç”¨ä»»ä½•å†…å­˜ç©ºé—´ï¼Œåªæ˜¯ä½œä¸ºä¸€ä¸ªå ä½ç¬¦å­˜åœ¨ï¼Œç”¨äºå æ® elementData æ•°ç»„çš„å¼•ç”¨
public ArrayList() {
    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
}


private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = {};
```





#### æ·»åŠ å…ƒç´ æ“ä½œ



1ã€æ·»åŠ è‡³æŒ‡å®šä½ç½®ä¸Šï¼š

```java
public void add(int index, E element) {
    // æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¶Šç•Œï¼Œç”¨äºæ’å…¥å…ƒç´ çš„ä½ç½®
    rangeCheckForAdd(index);  //  0=< index <=size

    //sizeè¡¨ç¤ºï¼šthe number of elements it containsâ€”â€”â€”â€”æœ‰æ•ˆå…ƒç´ çš„æ•°é‡
    // ç¡®ä¿å®¹é‡è¶³å¤Ÿä»¥å®¹çº³æ–°å…ƒç´ ï¼Œä¸è¶³åˆ™éœ€è¦è¿›è¡Œæ‰©å®¹
    ensureCapacityInternal(size + 1); // ä¼šå¢åŠ  modCount    
    

// å°†å…ƒç´ ä»æŒ‡å®šç´¢å¼•ä½ç½®å¼€å§‹çš„éƒ¨åˆ†å‘å³ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œä¸ºæ–°å…ƒç´ è…¾å‡ºç©ºé—´(ç›´æ¥åœ¨åŸæ•°ç»„ä¸Šè¿›è¡Œç§»åŠ¨)
    System.arraycopy(elementData, index, elementData, index + 1, size - index);

    
    // åœ¨æŒ‡å®šç´¢å¼•ä½ç½®æ’å…¥æ–°å…ƒç´ 
    elementData[index] = element;

    // æ›´æ–°é›†åˆå¤§å°
    size++;
}




private void ensureCapacityInternal(int minCapacity) {
    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));
}

/*
*åˆ¤æ–­æŒ‡å®šçš„æœ€å°å®¹é‡ minCapacity æ˜¯å¦å¤§äºå½“å‰æ•°ç»„ elementData çš„é•¿åº¦(éæœ‰æ•ˆå…ƒç´ é•¿åº¦)
å¦‚æœæ˜¯ï¼Œè¯´æ˜å½“å‰å®¹é‡ä¸è¶³ä»¥å®¹çº³ minCapacity ä¸ªå…ƒç´ ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹
*/
private void ensureExplicitCapacity(int minCapacity) {
    modCount++;
    //modCount ç”¨äºè®°å½•å¯¹é›†åˆè¿›è¡Œç»“æ„ä¿®æ”¹çš„æ¬¡æ•°ã€‚
   //åœ¨éå†é›†åˆæ—¶ï¼Œå¦‚æœ modCount å‘ç”Ÿäº†æ”¹å˜ï¼Œå°±ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸ï¼Œç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹ã€‚
    
    
    //å½“å‰æ‰€éœ€æœ€å°å®¹é‡æ˜¯å¦å¤§äºæ•°ç»„çš„é•¿åº¦,å¤§äºåˆ™éœ€è¦è¿›è¡Œæ‰©å®¹
    if (minCapacity - elementData.length > 0)
        grow(minCapacity);
}




private void grow(int minCapacity) {
    int oldCapacity = elementData.length;
    int newCapacity = oldCapacity + (oldCapacity >> 1);//è®¡ç®—æ–°æ•°ç»„çš„å®¹é‡ 1.5å€
    
    //åˆ¤æ–­è®¡ç®—å‡ºçš„æ–°æ•°ç»„å®¹é‡èƒ½ä¸èƒ½æ»¡è¶³æ‰€éœ€æœ€å°å®¹é‡minCapacityçš„è¦æ±‚ï¼Ÿ
    if (newCapacity - minCapacity < 0)
        newCapacity = minCapacity; //ä¸æ»¡è¶³åˆ™ç›´æ¥å°†minCapacityèµ‹å€¼ç»™æ–°æ•°ç»„çš„å®¹é‡
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    
    //æœ€ç»ˆæ‰§è¡Œæ•°ç»„å¤åˆ¶
    /*
    * elementData è¡¨ç¤ºåŸå§‹æ•°ç»„ï¼Œéœ€è¦å¤åˆ¶çš„æ•°ç»„
    * newCapacity è¡¨ç¤ºæ–°æ•°ç»„çš„é•¿åº¦ï¼Œå³è¦åˆ›å»ºçš„æ–°æ•°ç»„çš„å¤§å°ã€‚
    *
    *
    */
    elementData = Arrays.copyOf(elementData, newCapacity);
}
```

> - `elementData.length` è¡¨ç¤ºæ•°ç»„çš„å®¹é‡ï¼Œå®ƒæ˜¯å›ºå®šçš„ï¼Œåˆ›å»ºæ•°ç»„æ—¶å°±ç¡®å®šäº†(å¤§äºä¸‹é¢`size`)
> - `size` è¡¨ç¤ºé›†åˆä¸­å®é™…åŒ…å«çš„å…ƒç´ ä¸ªæ•°ï¼Œå®ƒæ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œéšç€å…ƒç´ çš„æ·»åŠ å’Œåˆ é™¤è€Œæ”¹å˜

æœ€åå†æ¥çœ‹ä¸€ä¸‹ `Arrays.copyOf(elementData,newCapacity)`æ–°æ•°ç»„çš„å¤åˆ¶ï¼š

å°† `elementData` æ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„ä¸­ï¼Œå¹¶å°†æ–°æ•°ç»„çš„å¤§å°è®¾ç½®ä¸º `newCapacity`ï¼Œå³æ‰©å®¹åçš„å¤§å°

è¿™æ ·ï¼Œ`elementData` å˜é‡ç°åœ¨å¼•ç”¨çš„æ˜¯ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå®ƒçš„å®¹é‡å·²ç»å¢åŠ åˆ°äº† `newCapacity`ï¼Œå¹¶ä¸”åŸæ¥æ•°ç»„ä¸­çš„å…ƒç´ éƒ½è¢«ä¿ç•™åœ¨æ–°æ•°ç»„ä¸­ã€‚åŸå§‹æ•°ç»„ `elementData` ä¸å†è¢«å¼•ç”¨ï¼Œå› æ­¤åœ¨æ²¡æœ‰å…¶ä»–å¼•ç”¨æŒ‡å‘å®ƒçš„æƒ…å†µä¸‹ï¼Œä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶ã€‚è€Œæ–°çš„æ•°ç»„ `elementData` ç”¨äºå­˜å‚¨é›†åˆä¸­çš„å…ƒç´ ï¼Œå¹¶å…·æœ‰æ›´å¤§çš„å®¹é‡ï¼Œä»¥ä¾¿ç»§ç»­æ·»åŠ æ›´å¤šçš„å…ƒç´ 





> ä¸€ä¸ªå°é—®é¢˜ï¼šå¦‚æœæ’å…¥å…ƒç´ æ—¶`minCapacity`>`elementData.length`, å³æ¶‰åŠåˆ°äº†æ•°ç»„æ‰©å®¹ã€‚é‚£ä¹ˆindexç´¢å¼•åçš„å…ƒç´ åœ¨æ•´ä¸ªæ’å…¥è¿‡ç¨‹ä¸­æ˜¯ä¸æ˜¯ç§»åŠ¨äº†ä¸¤æ¬¡å‘¢ï¼Ÿ

 (1)ç¬¬ä¸€æ¬¡ç§»åŠ¨æ˜¯åœ¨æ‰©å®¹æ—¶ï¼šé€šè¿‡`Arrays.copyOf(elementData, newCapacity)`ä»æ—§`elementData`æ•°ç»„è¿ç§»åˆ°æ–°çš„`elementData`æ•°ç»„

 (2)ç¬¬äºŒæ¬¡ç§»åŠ¨æ˜¯åœ¨æ‰§è¡Œ`System.arraycopy(elementData, index, elementData, index + 1, size - index);`æ—¶ï¼Œåœ¨åŸæ•°ç»„ä¸Šè¿›è¡Œå…ƒç´ çš„ç§»åŠ¨ï¼Œè®©`index`ç´¢å¼•å¤„å¼€å§‹çš„å…ƒç´ ç§»åŠ¨åˆ°`index+1`ä½ç½®å¼€å§‹ï¼Œæ€»å…±æ¶‰åŠåˆ°çš„ç§»åŠ¨å…ƒç´ æ•°é‡ä¸º`size-index`



> ç¬¬äºŒä¸ªå°é—®é¢˜ï¼šå¦‚æœè°ƒç”¨é»˜è®¤æ„é€ æ–¹æ³•æ¥åˆå§‹åŒ–ArrayList,ç¬¬ä¸€æ¬¡æ‰©å®¹æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ

é»˜è®¤æ„é€ æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªç©º`Object[]`æ•°ç»„ï¼Œæ­¤æ—¶å½“æ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šåˆ¤æ–­`size+1` å’Œ `elementData.length`çš„å¤§å°ï¼Œç»“æœæ˜¯å¤§äºï¼Œæ•…ä¼šè§¦å‘ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œç¬¬ä¸€æ¬¡æ‰©å®¹ä¼šæ‰©åˆ°é•¿åº¦ä¸º10ï¼š

```java
private void ensureCapacityInternal(int minCapacity) {
    // å¦‚æœå½“å‰æ•°ç»„ä¸ºç©ºï¼Œåˆå§‹åŒ–å®¹é‡ä¸ºé»˜è®¤å®¹é‡ï¼ˆä¸€èˆ¬ä¸º10ï¼‰
    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);
    }

    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹
    ensureExplicitCapacity(minCapacity);
}
```







2ã€è¿½åŠ åˆ°æ•°ç»„çš„æœ«å°¾ï¼š(å…¶å®åˆ†æè¿‡ç¨‹å’Œæ’å…¥åˆ°æŒ‡å®šIndexç´¢å¼•å¤„å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡æ’å…¥å…ƒç´ æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå°±ä¼šæ¶‰åŠåˆ°æ•°ç»„çš„æ‰©å®¹)

```java
/**
 * å°†æŒ‡å®šå…ƒç´ æ·»åŠ åˆ° ArrayList çš„æœ«å°¾
 * @param e è¦æ·»åŠ çš„å…ƒç´ 
 * @return æ·»åŠ æˆåŠŸè¿”å› true
 */
public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // ç¡®ä¿ ArrayList èƒ½å¤Ÿå®¹çº³æ–°çš„å…ƒç´ 
    elementData[size++] = e;//åœ¨ ArrayList çš„æœ«å°¾æ·»åŠ æŒ‡å®šå…ƒç´ â€”â€”å®¹æ˜“äº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜
    return true;
}


/**
 * ç¡®ä¿ ArrayList èƒ½å¤Ÿå®¹çº³æŒ‡å®šå®¹é‡çš„å…ƒç´ 
 * @param minCapacity æŒ‡å®šå®¹é‡çš„æœ€å°å€¼
 * private static final int DEFAULT_CAPACITY = 10;  //å®šä¹‰ä¸€ä¸ªé»˜è®¤å®¹é‡
 */
private void ensureCapacityInternal(int minCapacity) {
    // å¦‚æœ elementData è¿˜æ˜¯é»˜è®¤çš„ç©ºæ•°ç»„ ç¬¬ä¸€æ¬¡æ’å…¥å…ƒç´ æ—¶
    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) { 
        
        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity); 
        // ä½¿ç”¨ DEFAULT_CAPACITY å’ŒæŒ‡å®šå®¹é‡çš„æœ€å°å€¼ä¸­çš„è¾ƒå¤§å€¼ Math.max(10ï¼Œ1)
    }

    ensureExplicitCapacity(minCapacity); // ç¡®ä¿å®¹é‡èƒ½å¤Ÿå®¹çº³æŒ‡å®šå®¹é‡çš„å…ƒç´ 
}
```

æ­¤æ—¶ï¼š

- å‚æ•° `minCapacity` ä¸º 1ï¼ˆsize+1 ä¼ è¿‡æ¥çš„   0+1 ï¼‰ 
- `elementData` ä¸ºå­˜æ”¾ `ArrayList` å…ƒç´ çš„åº•å±‚æ•°ç»„ï¼Œå‰é¢å£°æ˜ `ArrayList` çš„æ—¶å€™è®²è¿‡äº†ï¼Œæ­¤æ—¶ä¸ºç©º `{}`
- `DEFAULTCAPACITY_EMPTY_ELEMENTDATA` å‰é¢ä¹Ÿè®²è¿‡äº†ï¼Œä¸º `{}`



æ‰€ä»¥ï¼Œif æ¡ä»¶æ­¤æ—¶ä¸º trueï¼Œif è¯­å¥`minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity)`è¦æ‰§è¡Œã€‚`DEFAULT_CAPACITY` ä¸º 10ï¼Œæ‰€ä»¥æ‰§è¡Œå®Œè¿™è¡Œä»£ç åï¼Œ`minCapacity` ä¸º 10ï¼Œ`Math.max()` æ–¹æ³•çš„ä½œç”¨æ˜¯å–ä¸¤ä¸ªå½“ä¸­æœ€å¤§çš„é‚£ä¸ª

```java
/**
 * æ£€æŸ¥å¹¶ç¡®ä¿é›†åˆå®¹é‡è¶³å¤Ÿï¼Œå¦‚æœéœ€è¦åˆ™å¢åŠ é›†åˆå®¹é‡ã€‚
 *
 * @param minCapacity æ‰€éœ€æœ€å°å®¹é‡
 */
private void ensureExplicitCapacity(int minCapacity) {
    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºäº†æ•°ç»„èŒƒå›´ï¼Œç¡®ä¿ä¸ä¼šæº¢å‡º
    if (minCapacity - elementData.length > 0)
        // å¦‚æœéœ€è¦å¢åŠ å®¹é‡ï¼Œåˆ™è°ƒç”¨ grow æ–¹æ³•
        grow(minCapacity);
}

```

æ­¤æ—¶ï¼š

- å‚æ•° `minCapacity` ä¸º 10
- `elementData.length` ä¸º 0ï¼ˆæ•°ç»„ä¸ºç©ºï¼‰

æ‰€ä»¥ 10-0>0ï¼Œif æ¡ä»¶ä¸º trueï¼Œè¿›å…¥ if è¯­å¥æ‰§è¡Œ `grow()` æ–¹æ³•ï¼Œæ¥çœ‹æºç ï¼š

```java
/**
 * æ‰©å®¹ ArrayList çš„æ–¹æ³•ï¼Œç¡®ä¿èƒ½å¤Ÿå®¹çº³æŒ‡å®šå®¹é‡çš„å…ƒç´ 
 * @param minCapacity æŒ‡å®šå®¹é‡çš„æœ€å°å€¼
 */
private void grow(int minCapacity) {
    // æ£€æŸ¥æ˜¯å¦ä¼šå¯¼è‡´æº¢å‡ºï¼ŒoldCapacity ä¸ºå½“å‰æ•°ç»„é•¿åº¦
    int oldCapacity = elementData.length;
    int newCapacity = oldCapacity + (oldCapacity >> 1); // æ‰©å®¹è‡³åŸæ¥çš„1.5å€
    if (newCapacity - minCapacity < 0) // å¦‚æœè¿˜æ˜¯å°äºæŒ‡å®šå®¹é‡çš„æœ€å°å€¼
   newCapacity = minCapacity;//ç›´æ¥æ‰©å®¹è‡³æŒ‡å®šå®¹é‡çš„æœ€å°å€¼(ç¬¬ä¸€æ¬¡æ‰©å®¹æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œï¼ï¼)
    if (newCapacity - MAX_ARRAY_SIZE > 0) // å¦‚æœè¶…å‡ºäº†æ•°ç»„çš„æœ€å¤§é•¿åº¦
        newCapacity = hugeCapacity(minCapacity); // æ‰©å®¹è‡³æ•°ç»„çš„æœ€å¤§é•¿åº¦
    // å°†å½“å‰æ•°ç»„å¤åˆ¶åˆ°ä¸€ä¸ªæ–°æ•°ç»„ä¸­ï¼Œé•¿åº¦ä¸º newCapacityï¼Œåé¢ç©ºå‡ºæ¥çš„å…ƒç´ è¡¥nullå€¼
    elementData = Arrays.copyOf(elementData, newCapacity);
}

```

æ­¤æ—¶ï¼š

- å‚æ•° `minCapacity` ä¸º 10
- å˜é‡ `oldCapacity` ä¸º 0

æ‰€ä»¥ `newCapacity` ä¹Ÿä¸º 0ï¼Œäºæ˜¯ `newCapacity - minCapacity` ç­‰äº -10 å°äº 0ï¼Œäºæ˜¯ç¬¬ä¸€ä¸ª if æ¡ä»¶ä¸º trueï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ª if è¯­å¥ `newCapacity = minCapacity`ï¼Œç„¶å `newCapacity` ä¸º 10

ç´§æ¥ç€æ‰§è¡Œ `elementData = Arrays.copyOf(elementData, newCapacity);`ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œæ•°ç»„çš„ç¬¬ä¸€æ¬¡æ‰©å®¹ï¼Œé•¿åº¦ä¸º 10ã€‚



`ArrayList` åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ add åä¼šæ‰©å®¹ä¸º 10ï¼Œé‚£ `ArrayList` ç¬¬äºŒæ¬¡æ‰©å®¹å‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶å€™å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯æ·»åŠ ç¬¬ 11 ä¸ªå…ƒç´ æ—¶ï¼Œå¤§å®¶å¯ä»¥å°è¯•åˆ†æä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹









#### **æ‰©å®¹æœºåˆ¶**

é¦–å…ˆéœ€è¦çŸ¥é“æ•°ç»„çš„é»˜è®¤æŒ‡å®šå®¹é‡ä¸º10ï¼š

```java
private static final int DEFAULT_CAPACITY = 10;
```

å¦‚æœæœ€å¼€å§‹è°ƒç”¨æ— å‚æ„é€ åˆå§‹åŒ–`elementdata`æ•°ç»„ï¼Œå®é™…ä¸Šåˆå§‹åŒ–äº†ä¸€ä¸ªç©ºæ•°ç»„ï¼Œ**å½“çœŸæ­£å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ æ—¶ï¼ˆå³æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰**ï¼Œæ‰ä¼šçœŸæ­£çš„åˆ†é…å®¹é‡ï¼Œ**å³å‘æ•°ç»„ä¸­æ·»åŠ ç¬¬ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œæ•°ç»„å®¹é‡æ‰©ä¸º 10**ï¼Œéšåä¸æ–­å¾€æ•°ç»„é‡Œæ·»åŠ å…ƒç´ ï¼Œå½“æ•°ç»„å…ƒç´ å®¹é‡åˆ°è¾¾10æ—¶ä¼šå†æ¬¡è§¦å‘æ‰©å®¹â€”â€”æ·»åŠ ç¬¬ 11 ä¸ªå…ƒç´ ï¼Œ`minCapacity`(ä¸º 11)æ¯” `elementData.length`ï¼ˆä¸º 10ï¼‰è¦å¤§ã€‚è¿›å…¥ `grow()` æ–¹æ³•è¿›è¡Œæ‰©å®¹:

**`ensureCapacity()æ–¹æ³•:`**

```java
public void ensureCapacity(int minCapacity) {
        if (minCapacity > elementData.length
            && !(elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA
                 && minCapacity <= DEFAULT_CAPACITY)) {
            modCount++;
            grow(minCapacity);
        }
    }
```

`grow()æ–¹æ³•`ï¼š

```java
private Object[] grow(int minCapacity) {
        int oldCapacity = elementData.length;
        if (oldCapacity > 0 || elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
            int newCapacity = ArraysSupport.newLength(oldCapacity,
                    minCapacity - oldCapacity, /* minimum growth */
                    oldCapacity >> 1           /* preferred growth */);
            return elementData = Arrays.copyOf(elementData, newCapacity);
        } else 
            return elementData = new Object[Math.max(DEFAULT_CAPACITY, minCapacity)];
        }
    }
```

ç”±`grow()`å¯ä»¥çœ‹å‡ºï¼Œ é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ‰©å®¹åçš„å®¹é‡newCapacity`ä¸º`oldCapacity+oldCapacity>>1`,å³æ—§å®¹é‡çš„1.5å€ï¼Œå¹¶ä¸”æ¯”è¾ƒè¿™ä¸ªæ–°å®¹é‡`newCapacity`å’Œé¢„æœŸçš„æœ€å°æ‰€éœ€å®¹é‡`minCapacity`å¤§å°ï¼Œå¦‚æœå°äº`minCapacity`ï¼Œåˆ™ç›´æ¥å°†minCapacityèµ‹å€¼ç»™`newCapacityï¼Œæœ€åè°ƒç”¨`Arrays.copyOf()`æ¥å®ç°æ—§æ•°ç»„å‘æ–°æ•°ç»„çš„è¿ç§»:

```java
  public static <T,U> T[] copyOf(U[] original, int newLength, Class<? extends T[]> newType) {
        @SuppressWarnings("unchecked")
    //    T[] copy = ((Object)newType == (Object)Object[].class)
    //        ? (T[]) new Object[newLength]
    //        : (T[]) Array.newInstance(newType.getComponentType(), newLength);
       
    /*æ ¸å¿ƒ*/  System.arraycopy(original, 0, copy, 0,
                         Math.min(original.length, newLength));
        return copy;
    }
```

æ³¨æ„ï¼Œ`Arrays.copyOf()`å®é™…ä¸Šæ˜¯è°ƒç”¨äº†`System.arraycopy()`æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼š

```java
/**
    *   å¤åˆ¶æ•°ç»„
    * @param src æºæ•°ç»„
    * @param srcPos æºæ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®
    * @param dest ç›®æ ‡æ•°ç»„
    * @param destPos ç›®æ ‡æ•°ç»„ä¸­çš„èµ·å§‹ä½ç½®
    * @param length è¦å¤åˆ¶çš„æ•°ç»„å…ƒç´ çš„æ•°é‡
    */
public static native void arraycopy(Object src,  int  srcPos,
                                    Object dest, int destPos,
                                    int length);
```



#### åˆ é™¤å…ƒç´ æ“ä½œ

å…¶å®å’Œæ·»åŠ å…ƒç´ å°±æ˜¯åç€æ¥çš„ï¼Œè€Œä¸”å®ç°é€»è¾‘ç›¸å¯¹ç®€å•äº†è®¸å¤šï¼š

(1) åˆ é™¤æŒ‡å®šç´¢å¼•ä½ç½®å…ƒç´ ï¼š

```java
public E remove(int index) {
        rangeCheck(index); //æ£€æŸ¥ç´¢å¼•çš„åˆç†æ€§

        modCount++;  //ä¿®æ”¹æ¬¡æ•°åŠ 1
        E oldValue = elementData(index);

        int numMoved = size - index - 1;
       
        //å°†indexä½ç½®åçš„å…ƒç´ å‰ç§»1ä½ï¼Œç›´æ¥è¦†ç›–çš„
        if (numMoved > 0)
            System.arraycopy(elementData, index+1, elementData, index,
                             numMoved);
        elementData[--size] = null; // åŸæœ€å¤§æœ‰æ•ˆå…ƒç´ ä½ç½®ç½®ä¸ºnull

        return oldValue;
    }
```



æ³¨æ„è¿™ä¸€è¡Œä»£ç ï¼š

```java
elementData[--size] = null;
```

å°†é›†åˆä¸­æœ€åä¸€ä¸ªå…ƒç´ ç½®ä¸º `null`ï¼Œå°±æ˜¯åœ¨å‘Šè¯‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼šè¿™ä¸ªå…ƒç´ ä¸å†è¢«é›†åˆå¼•ç”¨äº†ï¼Œä½ å¯ä»¥å°†å®ƒå›æ”¶å¹¶é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å¸®åŠ©åƒåœ¾å›æ”¶æœºåˆ¶æ›´æ—©åœ°å›æ”¶ä¸å†éœ€è¦çš„å¯¹è±¡ï¼Œä»è€Œæé«˜å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚





(2) ä»é›†åˆä¸­åˆ é™¤æŒ‡å®šçš„å…ƒç´  `o`ï¼š

```java
/**
 * åˆ é™¤åˆ—è¡¨ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„æŒ‡å®šå…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚
 *
 * @param o è¦åˆ é™¤çš„å…ƒç´ 
 * @return å¦‚æœåˆ—è¡¨åŒ…å«æŒ‡å®šå…ƒç´ ï¼Œåˆ™è¿”å› trueï¼›å¦åˆ™è¿”å› false
 */
public boolean remove(Object o) {
    if (o == null) { // å¦‚æœè¦åˆ é™¤çš„å…ƒç´ æ˜¯ null
        for (int index = 0; index < size; index++) // éå†åˆ—è¡¨
            if (elementData[index] == null) { // å¦‚æœæ‰¾åˆ°äº† null å…ƒç´ 
                fastRemove(index); // è°ƒç”¨ fastRemove æ–¹æ³•å¿«é€Ÿåˆ é™¤å…ƒç´ 
                return true; // è¿”å› trueï¼Œè¡¨ç¤ºæˆåŠŸåˆ é™¤å…ƒç´ 
            }
    } else { // å¦‚æœè¦åˆ é™¤çš„å…ƒç´ ä¸æ˜¯ null
        for (int index = 0; index < size; index++) // éå†åˆ—è¡¨
            if (o.equals(elementData[index])) { // å¦‚æœæ‰¾åˆ°äº†è¦åˆ é™¤çš„å…ƒç´ 
                fastRemove(index); // è°ƒç”¨ fastRemove æ–¹æ³•å¿«é€Ÿåˆ é™¤å…ƒç´ 
                return true; // è¿”å› trueï¼Œè¡¨ç¤ºæˆåŠŸåˆ é™¤å…ƒç´ 
            }
    }
    return false; // å¦‚æœæ‰¾ä¸åˆ°è¦åˆ é™¤çš„å…ƒç´ ï¼Œåˆ™è¿”å› false
}

```

é€šè¿‡éå†çš„æ–¹å¼æ‰¾åˆ°è¦åˆ é™¤çš„å…ƒç´ ï¼Œnull çš„æ—¶å€™ä½¿ç”¨ == æ“ä½œç¬¦åˆ¤æ–­ï¼Œé null çš„æ—¶å€™ä½¿ç”¨ `equals()` æ–¹æ³•ï¼Œç„¶åè°ƒç”¨ `fastRemove()` æ–¹æ³•ï¼Œæ³¨æ„ï¼š

- æœ‰ç›¸åŒå…ƒç´ æ—¶ï¼Œåªä¼šåˆ é™¤ç¬¬ä¸€ä¸ª,å› ä¸ºæ˜¯ä»å‰å¾€åé¡ºåºéå†ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªç›´æ¥return

å†æ¥çœ‹ä¸€ä¸‹ `fastRemove()` æ–¹æ³•ï¼š

```java
/**
 * å¿«é€Ÿåˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚
 *
 * @param index è¦åˆ é™¤çš„å…ƒç´ çš„ç´¢å¼•
 */
private void fastRemove(int index) {
    int numMoved = size - index - 1; // è®¡ç®—éœ€è¦ç§»åŠ¨çš„å…ƒç´ ä¸ªæ•°
    if (numMoved > 0) // å¦‚æœéœ€è¦ç§»åŠ¨å…ƒç´ ï¼Œå°±ç”¨ System.arraycopy æ–¹æ³•å®ç°
        System.arraycopy(elementData, index+1, elementData, index,
                         numMoved);
    elementData[--size] = null; // å°†æ•°ç»„æœ«å°¾çš„å…ƒç´ ç½®ä¸º nullï¼Œè®© GC å›æ”¶è¯¥å…ƒç´ å ç”¨çš„ç©ºé—´
}
```

å¯ä»¥çœ‹å‡ºæ¥`fastRemove()`æ–¹æ³•çš„å®ç°å’Œ`remove(int index)`çš„å®ç°é€»è¾‘å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œå°±ä¸èµ˜è¿°äº†





#### çº¿ç¨‹å®‰å…¨é—®é¢˜

æƒ…æ™¯1ï¼šæ·»åŠ å…ƒç´ 

```java
elementData[size++] = e;
//å¯æ‹†åˆ†ä¸ºï¼š
elementData[size] = e; 
size++;
```

åœ¨å•çº¿ç¨‹æ‰§è¡Œè¿™ä¸¤æ¡ä»£ç æ—¶æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯å½“å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ‰§è¡Œæ—¶ï¼Œå¯èƒ½å°±ä¼šå‘ç”Ÿä¸€ä¸ªçº¿ç¨‹çš„å€¼è¦†ç›–å¦ä¸€ä¸ªçº¿ç¨‹æ·»åŠ çš„å€¼ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

1. åˆ—è¡¨å¤§å°ä¸º0ï¼Œå³size=0ï¼›
2. çº¿ç¨‹Aå¼€å§‹æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå€¼ä¸ºAã€‚æ­¤æ—¶å®ƒæ‰§è¡Œç¬¬ä¸€æ¡æ“ä½œï¼Œå°†Aæ”¾åœ¨äº†`elementData`ä¸‹æ ‡ä¸º0çš„ä½ç½®ä¸Šï¼Œåœ¨æ‰§è¡Œ`size++`æ“ä½œä¹‹å‰è®©å‡ºäº†æ—¶é—´ç‰‡ï¼›
3. æ¥ç€çº¿ç¨‹Bæ‹¿åˆ°æ—¶é—´ç‰‡ï¼Œåˆšå¥½ä¹Ÿè¦å¼€å§‹æ·»åŠ ä¸€ä¸ªå€¼ä¸ºBçš„å…ƒç´ ï¼Œä¸”èµ°åˆ°äº†ç¬¬ä¸€æ­¥æ“ä½œã€‚æ­¤æ—¶çº¿ç¨‹Bè·å–åˆ°sizeçš„å€¼ä¾ç„¶ä¸º0ï¼Œäºæ˜¯å®ƒå°†Bä¹Ÿæ”¾åœ¨äº†`elementData`ä¸‹æ ‡ä¸º0çš„ä½ç½®ä¸Š
4. çº¿ç¨‹Aå¼€å§‹å°†sizeçš„å€¼å¢åŠ ä¸º1
5. çº¿ç¨‹Bå¼€å§‹å°†sizeçš„å€¼å¢åŠ ä¸º2

è¿™æ ·çº¿ç¨‹A Bæ‰§è¡Œå®Œæ¯•åï¼Œç†æƒ³ä¸­æƒ…å†µä¸º`size`ä¸º2ï¼Œ`elementData`ä¸‹æ ‡0çš„ä½ç½®ä¸ºAï¼Œä¸‹æ ‡1çš„ä½ç½®ä¸ºBã€‚è€Œå®é™…æƒ…å†µå˜æˆäº†`size`ä¸º2ï¼Œ`elementData`ä¸‹æ ‡ä¸º0çš„ä½ç½®å˜æˆäº†Bï¼Œä¸‹æ ‡1çš„ä½ç½®ä¸Šä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚å¹¶ä¸”åç»­é™¤éä½¿ç”¨`set()`æ–¹æ³•ä¿®æ”¹æ­¤ä½ç½®çš„å€¼ï¼Œå¦åˆ™å°†ä¸€ç›´ä¸º`null`ï¼Œå› ä¸º`size`ä¸º2ï¼Œæ·»åŠ å…ƒç´ æ—¶ä¼šä»ä¸‹æ ‡ä¸º2çš„ä½ç½®ä¸Šå¼€å§‹



æƒ…æ™¯2ï¼šæ•°ç»„è¶Šç•Œ

åœ¨å¤šä¸ªçº¿ç¨‹è¿›è¡Œaddæ“ä½œæ—¶å¯èƒ½ä¼šå¯¼è‡´elementDataæ•°ç»„è¶Šç•Œã€‚å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

1. åˆ—è¡¨å¤§å°ä¸º9ï¼Œå³size=9
2. çº¿ç¨‹Aå¼€å§‹è¿›å…¥addæ–¹æ³•ï¼Œè¿™æ—¶å®ƒè·å–åˆ°sizeçš„å€¼ä¸º9ï¼Œè°ƒç”¨`ensureCapacityInternal`æ–¹æ³•è¿›è¡Œå®¹é‡åˆ¤æ–­ã€‚
3. **çº¿ç¨‹Bæ­¤æ—¶ä¹Ÿè¿›å…¥addæ–¹æ³•**ï¼Œå®ƒè·å–åˆ°sizeçš„å€¼ä¹Ÿä¸º9ï¼Œä¹Ÿå¼€å§‹è°ƒç”¨`ensureCapacityInternal`æ–¹æ³•ã€‚
4. çº¿ç¨‹Aå‘ç°éœ€æ±‚å¤§å°ä¸º10ï¼Œè€Œ`elementData`çš„å¤§å°å°±ä¸º10ï¼Œå¯ä»¥å®¹çº³ã€‚äºæ˜¯å®ƒä¸å†æ‰©å®¹ï¼Œè¿”å›ã€‚
5. çº¿ç¨‹Bä¹Ÿå‘ç°éœ€æ±‚å¤§å°ä¸º10ï¼Œä¹Ÿå¯ä»¥å®¹çº³ï¼Œè¿”å›ã€‚
6. çº¿ç¨‹Aå¼€å§‹è¿›è¡Œè®¾ç½®å€¼æ“ä½œï¼Œ elementData[size++] = e æ“ä½œã€‚æ­¤æ—¶sizeå˜ä¸º10ã€‚
7. çº¿ç¨‹Bä¹Ÿå¼€å§‹è¿›è¡Œè®¾ç½®å€¼æ“ä½œï¼Œå®ƒå°è¯•è®¾ç½®`elementData`[10] = eï¼Œè€Œ`elementData`æ²¡æœ‰è¿›è¡Œè¿‡æ‰©å®¹ï¼Œå®ƒçš„ä¸‹æ ‡æœ€å¤§ä¸º9ã€‚äºæ˜¯æ­¤æ—¶ä¼šæŠ¥å‡ºä¸€ä¸ªæ•°ç»„è¶Šç•Œçš„å¼‚å¸¸`ArrayIndexOutOfBoundsException`

ç©¶å…¶åŸå› å°±æ˜¯çº¿ç¨‹Aå…ˆå®Œæˆäº†èµ‹å€¼æ“ä½œï¼Œå¹¶å°†sizeè‡ªå¢åï¼Œçº¿ç¨‹Bæ‰å¼€å§‹è¿›è¡Œèµ‹å€¼ï¼Œè¿™æ—¶åœ¨`elementData[size]`ä½ç½®å†è¿›è¡Œèµ‹å€¼æ“ä½œå°±å·²ç»è¶Šç•Œäº†ã€‚ã€‚ã€‚ã€‚



è¿˜æœ‰ç±»ä¼¼çš„æƒ…æ™¯å°±ä¸è¯´äº†ï¼Œæ€»ä¹‹å°±æ˜¯`ArrayList`åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¦‚æœä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨`Vector`ã€`Collections.synchronizedList()`ã€`CopyOnWriteArrayList`(å»ºè®®ä½¿ç”¨)





### LinkedList

åº•å±‚æ•°æ®ç»“æ„ä½¿ç”¨äº†åŒå‘é“¾è¡¨(é™æ€å†…éƒ¨ç±»)ï¼š

```java
/**
 * é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ç±»ã€‚
 */
private static class Node<E> {
    E item; // èŠ‚ç‚¹ä¸­å­˜å‚¨çš„å…ƒç´ 
    Node<E> next; // æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ
    Node<E> prev; // æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ

    /**
     * æ„é€ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ã€‚
     *
     * @param prev å‰ä¸€ä¸ªèŠ‚ç‚¹
     * @param element èŠ‚ç‚¹ä¸­è¦å­˜å‚¨çš„å…ƒç´ 
     * @param next åä¸€ä¸ªèŠ‚ç‚¹
     */
    Node(Node<E> prev, E element, Node<E> next) {
        this.item = element; // å­˜å‚¨å…ƒç´ 
        this.next = next; // è®¾ç½®ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
        this.prev = prev; // è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹
    }
}
```





(2)`add` æ’å…¥å…ƒç´ (åœ¨è¡¨å°¾)ï¼š

```java
/**
 * å°†æŒ‡å®šçš„å…ƒç´ æ·»åŠ åˆ°åˆ—è¡¨çš„å°¾éƒ¨ã€‚
 *
 * @param e è¦æ·»åŠ åˆ°åˆ—è¡¨çš„å…ƒç´ 
 * @return å§‹ç»ˆä¸º trueï¼ˆæ ¹æ® Java é›†åˆæ¡†æ¶è§„èŒƒï¼‰
 */
public boolean add(E e) {
    linkLast(e); // åœ¨åˆ—è¡¨çš„å°¾éƒ¨æ·»åŠ å…ƒç´ 
    return true; // æ·»åŠ å…ƒç´ æˆåŠŸï¼Œè¿”å› true
}


/**
 * åœ¨åˆ—è¡¨çš„å°¾éƒ¨æ·»åŠ æŒ‡å®šçš„å…ƒç´ ã€‚
 *
 * @param e è¦æ·»åŠ åˆ°åˆ—è¡¨çš„å…ƒç´ 
 */
void linkLast(E e) {
    final Node<E> l = last; // è·å–é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
    final Node<E> newNode = new Node<>(l, e, null); // åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºé“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
    last = newNode; // å°†æ–°çš„èŠ‚ç‚¹è®¾ç½®ä¸ºé“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
    if (l == null) // å¦‚æœé“¾è¡¨ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹
        first = newNode;
    else
        l.next = newNode; // å¦åˆ™å°†æ–°èŠ‚ç‚¹é“¾æ¥åˆ°é“¾è¡¨çš„å°¾éƒ¨
    size++; // å¢åŠ é“¾è¡¨çš„å…ƒç´ ä¸ªæ•°
}

```





(3)`add/get/remove` ä½†æ˜¯åœ¨æŒ‡å®šindexç´¢å¼•å¤„ï¼š

`LinkedList`åº•å±‚ä½¿ç”¨çš„æ˜¯åŒå‘é“¾è¡¨ï¼Œå› æ­¤åœ¨**è·å–å¤´å°¾å…ƒç´ /å‘é“¾è¡¨è¡¨å°¾æ’å…¥å…ƒç´ **æ—¶çš„æ—¶é—´å¤æ‚åº¦ä¸º`O(1)`

è€Œè‹¥è¦è·å–æŒ‡å®š`index`çš„å…ƒç´ ï¼Œåˆ™é¦–å…ˆéœ€è¦å®šä½åˆ°è¯¥ä½ç½®ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦å°±æ˜¯`O(n)`,`get(int index)` 

ã€`remove(int index)` ç­‰æ–¹æ³•å†…éƒ¨éƒ½è°ƒç”¨äº† `node(int index)` è¿™ä¸ªæ–¹æ³•æ¥è·å–å¯¹åº”çš„èŠ‚ç‚¹ï¼š

```Java
Node<E> node(int index) {
        // assert isElementIndex(index);

        if (index < (size >> 1)) {
            Node<E> x = first;
            for (int i = 0; i < index; i++)
                x = x.next;
            return x;
        } else {
            Node<E> x = last;
            for (int i = size - 1; i > index; i--)
                x = x.prev;
            return x;
        }
    }
```

ä»ä¸Šçœ‹å‡ºï¼Œè¯¥æ–¹æ³•é€šè¿‡æ¯”è¾ƒç´¢å¼•å€¼ä¸é“¾è¡¨`size`ä¸€åŠçš„å¤§å°ï¼Œæ¥**ç¡®å®šä»é“¾è¡¨å¤´è¿˜æ˜¯å°¾å¼€å§‹éå†**ã€‚å¦‚æœç´¢å¼•å€¼å°äº `size` çš„ä¸€åŠï¼Œå°±ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œåä¹‹ä»é“¾è¡¨å°¾å¼€å§‹éå†ã€‚è¿™æ ·å¯ä»¥åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå……åˆ†åˆ©ç”¨äº†åŒå‘é“¾è¡¨çš„ç‰¹æ€§æ¥æé«˜æ•ˆç‡











### CopyOnWriteArrayList



> ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒï¼Ÿ
>
> Javaå­¦ä¹ è€…éƒ½æ¸…æ¥š`ArrayList`å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨è¯»çº¿ç¨‹åœ¨è¯»å–`ArrayList`çš„æ—¶å€™å¦‚æœæœ‰å†™çº¿ç¨‹åœ¨å†™æ•°æ®çš„æ—¶å€™ï¼ŒåŸºäº**`fast-fail`**æœºåˆ¶ï¼Œä¼šæŠ›å‡º**`ConcurrentModificationException`**å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯è¯´`ArrayList`å¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼Œå½“ç„¶å¯ä»¥ç”¨`Vector`,æˆ–è€…ä½¿ç”¨`Collections`çš„é™æ€æ–¹æ³•å°†`ArrayList`åŒ…è£…æˆä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç±»ï¼Œä½†æ˜¯è¿™äº›æ–¹å¼éƒ½æ˜¯é‡‡ç”¨å…³é”®å­—`synchronzied`å¯¹æ–¹æ³•è¿›è¡Œä¿®é¥°ï¼Œåˆ©ç”¨ç‹¬å å¼é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯ï¼Œ**ç”±äºç‹¬å å¼é”åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°å¯¹è±¡ç›‘è§†å™¨**ï¼Œå¾ˆæ˜¾ç„¶è¿™ç§æ–¹å¼æ•ˆç‡å¹¶ä¸æ˜¯å¤ªé«˜
>
> 
>
> åœ¨ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæœ‰å¾ˆå¤šä¸šåŠ¡å¾€å¾€æ˜¯è¯»å¤šå†™å°‘çš„ï¼Œå¦‚æœåœ¨è¿™ç§æƒ…å†µç”¨åˆ°ä¸Šè¿°çš„æ–¹æ³•ï¼Œä½¿ç”¨`Vector`,`Collections`è½¬æ¢çš„è¿™äº›æ–¹å¼æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºå°½ç®¡å¤šä¸ªè¯»çº¿ç¨‹ä»åŒä¸€ä¸ªæ•°æ®å®¹å™¨ä¸­è¯»å–æ•°æ®ï¼Œä½†æ˜¯è¯»çº¿ç¨‹å¯¹æ•°æ®å®¹å™¨çš„æ•°æ®å¹¶ä¸ä¼šå‘ç”Ÿå‘ç”Ÿä¿®æ”¹ï¼Œè¿™æ ·æå°±å˜ç›¸é˜»å¡äº†è¯»çº¿ç¨‹çš„è¯»æ“ä½œ
>
> 
>
> å¾ˆè‡ªç„¶è€Œç„¶çš„æˆ‘ä»¬ä¼šè”æƒ³åˆ°`ReenTrantReadWriteLock`ï¼Œé€šè¿‡**è¯»å†™åˆ†ç¦»**çš„æ€æƒ³ï¼Œä½¿å¾—è¯»è¯»ä¹‹é—´ä¸ä¼šé˜»å¡ï¼Œæ— ç–‘å¦‚æœä¸€ä¸ªlistèƒ½å¤Ÿåšåˆ°è¢«å¤šä¸ªè¯»çº¿ç¨‹è¯»å–çš„è¯ï¼Œæ€§èƒ½ä¼šå¤§å¤§æå‡ä¸å°‘ã€‚ä½†æ˜¯ï¼Œå¦‚æœä»…ä»…æ˜¯å°†listé€šè¿‡è¯»å†™é”ï¼ˆ`ReentrantReadWriteLock`ï¼‰è¿›è¡Œå†ä¸€æ¬¡å°è£…çš„è¯ï¼Œç”±äºè¯»å†™é”çš„ç‰¹æ€§ï¼Œå½“å†™é”è¢«å†™çº¿ç¨‹è·å–åï¼Œè¯»å†™çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚
>
> 
>
> å¦‚æœæƒ³listçš„è¯»æ•ˆç‡æ›´é«˜çš„è¯ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„çªç ´å£ï¼Œå¦‚æœæˆ‘ä»¬**ä¿è¯è¯»çº¿ç¨‹æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½ä¸è¢«é˜»å¡**ï¼Œæ•ˆç‡å²‚ä¸æ˜¯ä¼šæ›´é«˜ï¼Ÿ è¿™å°±å¼•å‡ºäº†`CopyOnWriteArrayList`



`ReenTrantReadWriteLock`ï¼Œé€šè¿‡**è¯»å†™åˆ†ç¦»**çš„æ€æƒ³ï¼Œä½¿å¾—è¯»è¯»ä¹‹é—´ä¸ä¼šé˜»å¡ï¼Œæ— ç–‘å¦‚æœä¸€ä¸ªlistèƒ½å¤Ÿåšåˆ°è¢«å¤šä¸ªè¯»çº¿ç¨‹è¯»å–çš„è¯ï¼Œæ€§èƒ½ä¼šå¤§å¤§æå‡ä¸å°‘ã€‚ä½†æ˜¯ï¼Œå¦‚æœä»…ä»…æ˜¯å°†listé€šè¿‡è¯»å†™é”ï¼ˆ`ReentrantReadWriteLock`ï¼‰è¿›è¡Œå†ä¸€æ¬¡å°è£…çš„è¯ï¼Œç”±äºè¯»å†™é”çš„ç‰¹æ€§ï¼Œå½“å†™é”è¢«å†™çº¿ç¨‹è·å–åï¼Œè¯»å†™çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚

(1) è¯»é”`ReadLock`:

```java
public void lock() {
    sync.acquireShared(1);
}
//AQSä¸‹çš„å…±äº«æ¨¡å¼
```

(1) å†™é”`WriteLock`:

```java
public void lock() {
sync.acquire(1);
}
//AQSä¸‹çš„äº’æ–¥æ¨¡å¼
```



#### COW

å›åˆ°ä¸Šé¢æ‰€è¯´çš„ï¼Œå¦‚æœç®€å•çš„ä½¿ç”¨è¯»å†™é”çš„è¯ï¼Œåœ¨å†™é”è¢«è·å–ä¹‹åï¼Œè¯»å†™çº¿ç¨‹è¢«é˜»å¡ï¼Œåªæœ‰å½“å†™é”è¢«é‡Šæ”¾åè¯»çº¿ç¨‹æ‰æœ‰æœºä¼šè·å–åˆ°é”ä»è€Œè¯»åˆ°æœ€æ–°çš„æ•°æ®ï¼Œç«™åœ¨**è¯»çº¿ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œå³è¯»çº¿ç¨‹ä»»ä½•æ—¶å€™éƒ½æ˜¯è·å–åˆ°æœ€æ–°çš„æ•°æ®ï¼Œæ»¡è¶³æ•°æ®å®æ—¶æ€§**ã€‚

æ—¢ç„¶æˆ‘ä»¬è¯´åˆ°è¦è¿›è¡Œä¼˜åŒ–ï¼Œå¿…ç„¶æœ‰trade-off,æˆ‘ä»¬å°±å¯ä»¥**ç‰ºç‰²æ•°æ®å®æ—¶æ€§æ»¡è¶³æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§å³å¯**ã€‚è€Œ`CopyOnWriteArrayList`å°±æ˜¯é€šè¿‡Copy-On-Write(COW)ï¼Œå³å†™å…¥æ—¶å¤åˆ¶çš„æ€æƒ³æ¥é€šè¿‡å»¶æ—¶æ›´æ–°çš„ç­–ç•¥æ¥å®ç°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¿è¯è¯»çº¿ç¨‹é—´ä¸é˜»å¡ã€‚

COWé€šä¿—çš„ç†è§£æ˜¯å½“æˆ‘ä»¬å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨è¿›è¡ŒCopyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç„¶åæ–°çš„å®¹å™¨é‡Œæ·»åŠ å…ƒç´ ï¼Œæ·»åŠ å®Œå…ƒç´ ä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ã€‚

å¯¹`CopyOnWrite`å®¹å™¨è¿›è¡Œå¹¶å‘çš„è¯»çš„æ—¶å€™ï¼Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚æ‰€ä»¥`CopyOnWrite`å®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œå»¶æ—¶æ›´æ–°çš„ç­–ç•¥æ˜¯é€šè¿‡**åœ¨å†™çš„æ—¶å€™é’ˆå¯¹çš„æ˜¯æ–°åˆ›å»ºçš„æ•°æ®å®¹å™¨**æ¥å®ç°çš„ï¼Œ**æ”¾å¼ƒæ•°æ®å®æ—¶æ€§è¾¾åˆ°æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§**



`CopyOnWriteArrayList`çš„æ€æƒ³ä¸`ReentrantReadWriteLock` è¯»å†™é”çš„è®¾è®¡æ€æƒ³(**è¯»è¯»ä¸äº’æ–¥ã€è¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥**)éå¸¸ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶å†™å…¥æ“ä½œä¹Ÿä¸ä¼šé˜»å¡è¯»å–æ“ä½œ(è¯»æ“ä½œæ°¸è¿œä¸ä¼šè¢«é˜»å¡ï¼Œå³ä½¿è¯»åˆ°çš„æ—§æ•°æ®ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§)ã€‚

å†™å…¥æ—¶å¤åˆ¶éå¸¸é€‚åˆ**è¯»å¤šå†™å°‘**çš„å¹¶å‘åœºæ™¯ï¼Œå½“éœ€è¦ä¿®æ”¹ï¼ˆ `add`ï¼Œ`set`ã€`remove` ç­‰æ“ä½œï¼‰ `CopyOnWriteArrayList` çš„å†…å®¹æ—¶ï¼Œçº¿ç¨‹ä¸ä¼šç›´æ¥ä¿®æ”¹åŸæ•°ç»„ï¼Œè€Œæ˜¯ä¼šå…ˆåˆ›å»ºåº•å±‚æ•°ç»„çš„å‰¯æœ¬ï¼Œå¯¹å‰¯æœ¬æ•°ç»„è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹å®Œä¹‹åå†å°†ä¿®æ”¹åçš„æ•°ç»„èµ‹å€¼å›å»ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å†™æ“ä½œä¸ä¼šå½±å“è¯»æ“ä½œ









`CopyOnWriteArrayList`åº•å±‚ä½¿ç”¨`Object[]`æ•°ç»„æ¥å­˜å‚¨å…ƒç´ ï¼š

```java
private transient volatile Object[] array;  //volatileä¿è¯å¯è§æ€§
```



#### å†™å…¥æ“ä½œ  :astonished:

> `CopyOnWriteArrayList` åœ¨æ’å…¥å…ƒç´ æ—¶å¹¶ä¸æ¶‰åŠæ‰©å®¹ï¼ï¼
>
> 
>
> åœ¨ `CopyOnWriteArrayList` ä¸­ï¼Œæ¯å½“è¿›è¡Œå†™æ“ä½œï¼ˆæ’å…¥ã€åˆ é™¤ã€ä¿®æ”¹ç­‰ï¼‰æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„æ¥ä»£æ›¿åŸå§‹æ•°ç»„ï¼Œå¹¶åœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œå†™æ“ä½œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯è¯»æ“ä½œä¸ä¼šå—åˆ°å†™æ“ä½œçš„å½±å“ï¼Œä»è€Œå®ç°è¯»å†™åˆ†ç¦»çš„çº¿ç¨‹å®‰å…¨æ€§ã€‚
>
> 
>
> åœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œ`CopyOnWriteArrayList` ä¼šåœ¨å½“å‰æ•°ç»„çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå¹¶å°†è¦æ’å…¥çš„å…ƒç´ æ·»åŠ åˆ°æ–°æ•°ç»„çš„æœ«å°¾ã€‚è¿™ç§æ“ä½œä¸ä¼šå½±å“åˆ°åŸå§‹æ•°ç»„ï¼Œå› ä¸ºè¯»æ“ä½œä»ç„¶åœ¨ä½¿ç”¨åŸå§‹æ•°ç»„ã€‚åªæœ‰å½“æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯»æ“ä½œå®Œæˆåï¼Œ`CopyOnWriteArrayList` æ‰ä¼šå°†å†…éƒ¨æ•°ç»„æŒ‡å‘æ–°çš„æ•°ç»„ï¼Œä»è€Œå®Œæˆæ’å…¥æ“ä½œçš„æ›´æ–°ã€‚



åœ¨æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ æ—¶è°ƒç”¨çš„`add(E e)`æ–¹æ³•(ä¸¤ç§ç‰ˆæœ¬)ï¼š

(1) ä½¿ç”¨`synchronized`å®ç°åŒæ­¥(æ–°ç‰ˆæœ¬çš„`synchronized`å·²ä¸æ˜¯é‡é‡çº§é”)ï¼š

```java
public boolean add(E e) {
        synchronized (lock) {
            Object[] es = getArray();  // è·å–å½“å‰çš„å†…éƒ¨æ•°ç»„arrayå¼•ç”¨
            int len = es.length;  //è·å–å½“å‰çš„å†…éƒ¨æ•°ç»„arrayçš„é•¿åº¦
            
            //æ¯æ’å…¥å…ƒç´ éƒ½æ¶‰åŠåˆ°æ–°æ•°ç»„çš„æ‹·è´ï¼Œå¹¶ä¸”è®©æ•°ç»„å¼•ç”¨esæŒ‡å‘æ–°çš„å †ä¸­æ•°ç»„å®ä¾‹
            es = Arrays.copyOf(es, len + 1); 
            
            es[len] = e;
            setArray(es);  //å°†åŸæ•°ç»„å¼•ç”¨array æŒ‡å‘æ–°çš„å †ä¸­æ•°ç»„
            return true;
        }
    }
```





(2) ä½¿ç”¨ `ReentrantLock`å®ç°çº¿ç¨‹åŒæ­¥ï¼š

```java
final transient ReentrantLock lock = new ReentrantLock();

// æ’å…¥å…ƒç´ åˆ° CopyOnWriteArrayList çš„å°¾éƒ¨
public boolean add(E e) {
    /*
    è·å–å½“å‰ CopyOnWriteArrayList å¯¹è±¡çš„é”ï¼Œ
    å¹¶ä¸”ä½¿ç”¨ final å…³é”®å­—æ¥ç¡®ä¿åœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­é”å¯¹è±¡çš„å¼•ç”¨ä¸å¯å˜
    */
    final ReentrantLock lock = this.lock;
    
    
    // åŠ é”  ä¿è¯å†™çº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª(å¤šä¸ªå†™çº¿ç¨‹éœ€è¦ç«äº‰ä¸€ä¸ªCopyOnWriteArrayListå¯¹è±¡çš„æˆå‘˜å˜é‡é”â€”â€”this.lockï¼Œç«äº‰åˆ°çš„æ‰å¯ä»¥ä¿®æ”¹)
    lock.lock();
    try {
        // è·å–åŸæ¥çš„æ•°ç»„
        Object[] elements = getArray();
        // åŸæ¥æ•°ç»„çš„é•¿åº¦
        int len = elements.length;
        // åˆ›å»ºä¸€ä¸ªé•¿åº¦+1çš„æ–°æ•°ç»„ï¼Œå¹¶å°†åŸæ¥æ•°ç»„çš„å…ƒç´ å¤åˆ¶ç»™æ–°æ•°ç»„(ä¸å½±å“å…¶ä»–çº¿ç¨‹è¿›è¡Œè¯»æ“ä½œ~)
        Object[] newElements = Arrays.copyOf(elements, len + 1);
        // å…ƒç´ æ”¾åœ¨æ–°æ•°ç»„æœ«å°¾
        newElements[len] = e;
        // arrayå¼•ç”¨æŒ‡å‘æ–°æ•°ç»„
        setArray(newElements);
        return true;
    } finally {
        // è§£é”
        lock.unlock();
    }
}

```

ä»ä¸Šå¯ä»¥çœ‹å‡ºï¼Œ`add`æ–¹æ³•å†…éƒ¨ç”¨åˆ°äº† `ReentrantLock` åŠ é”ï¼Œä¿è¯äº†åŒæ­¥ï¼Œé¿å…äº†å¤šçº¿ç¨‹å†™çš„æ—¶å€™ä¼šå¤åˆ¶å‡ºå¤šä¸ªå‰¯æœ¬å‡ºæ¥ã€‚é”è¢«`final`ä¿®é¥°ä¿è¯äº†é”çš„å†…å­˜åœ°å€è‚¯å®šä¸ä¼šè¢«ä¿®æ”¹ï¼Œå¹¶ä¸”ï¼Œé‡Šæ”¾é”çš„é€»è¾‘æ”¾åœ¨ `finally` ä¸­ï¼Œå¯ä»¥ä¿è¯é”èƒ½è¢«é‡Šæ”¾ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š

- æ¯æ¬¡å†™æ“ä½œéƒ½éœ€è¦é€šè¿‡ `Arrays.copyOf` å¤åˆ¶åº•å±‚æ•°ç»„ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n) çš„ï¼Œä¸”ä¼šå ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´ã€‚å› æ­¤ï¼Œ`CopyOnWriteArrayList` é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œåœ¨å†™æ“ä½œä¸é¢‘ç¹ä¸”å†…å­˜èµ„æºå……è¶³çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æå‡ç³»ç»Ÿçš„æ€§èƒ½è¡¨ç°ï¼›

- `CopyOnWriteArrayList` ä¸­æ²¡æœ‰ç±»ä¼¼äº `ArrayList`çš„ `grow()` æ‰©å®¹çš„æ“ä½œ, æ¯æ¬¡æ·»åŠ å…ƒç´ å‡è¦åˆ›å»ºä¸€ä¸ª`length+1`çš„æ•°ç»„ï¼›
- é‡‡ç”¨`ReentrantLock`ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹æ­£åœ¨è¿›è¡Œæ•°ç»„çš„å¤åˆ¶ï¼Œå¦åˆ™çš„è¯å†…å­˜ä¸­ä¼šæœ‰å¤šä»½è¢«å¤åˆ¶çš„æ•°æ®ï¼›
- å‰é¢è¯´è¿‡æ•°ç»„å¼•ç”¨æ˜¯`volatile`ä¿®é¥°çš„ï¼Œå› æ­¤å°†æ—§çš„æ•°ç»„å¼•ç”¨æŒ‡å‘æ–°çš„æ•°ç»„ï¼Œ**æ ¹æ®volatileçš„`happens-before`è§„åˆ™ï¼Œå†™çº¿ç¨‹å¯¹æ•°ç»„å¼•ç”¨çš„ä¿®æ”¹å¯¹è¯»çº¿ç¨‹æ˜¯å¯è§çš„**ã€‚ç”±äºåœ¨å†™æ•°æ®çš„æ—¶å€™ï¼Œæ˜¯åœ¨æ–°çš„æ•°ç»„ä¸­æ’å…¥æ•°æ®çš„ï¼Œä»è€Œä¿è¯è¯»å†™æ˜¯åœ¨ä¸¤ä¸ªä¸åŒçš„æ•°æ®å®¹å™¨ä¸­è¿›è¡Œæ“ä½œ

> **happen-beforeåŸåˆ™ä¸­çš„volatile å˜é‡è§„åˆ™**ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œï¼Œhappen-before äºåç»­å¯¹è¯¥å˜é‡çš„è¯»æ“ä½œã€‚è¿™ç¡®ä¿äº† volatile å˜é‡çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„





####  è¯»å–æ“ä½œ

`get`æ“ä½œæ˜¯å¼±ä¸€è‡´æ€§çš„ï¼ï¼

```java
private transient volatile Object[] array;  //volatileä¿®é¥° â€”â€” å¯è§æ€§

public E get(int index) {
        return elementAt(getArray(), index);
}

static <E> E elementAt(Object[] a, int index) {
        return (E) a[index];
}

final Object[] getArray() {
    return array;
}


```

`get(int index)`æ–¹æ³•æ˜¯åˆ†ä¸¤æ­¥è¿›è¡Œçš„ï¼š

1. é€šè¿‡`getArray()`è·å–å½“å‰æ•°ç»„çš„å¼•ç”¨
2. ç›´æ¥ä»æ•°ç»„ä¸­è·å–ä¸‹æ ‡ä¸º `index` çš„å…ƒç´ 
3. `get()`æ˜¯å¼±ä¸€è‡´æ€§çš„ï¼Œå¯èƒ½è¯»åˆ°æ—§çš„å…ƒç´ å€¼ï¼Œä¾‹å¦‚çº¿ç¨‹ 1 æƒ³è¦é€šè¿‡è°ƒç”¨`get(int index)`æ–¹æ³•è·å–å€¼ï¼Œå†…éƒ¨é€šè¿‡`getArray()`æ–¹æ³•è·å–åˆ°äº† `array` å±æ€§å€¼ï¼›æ­¤æ—¶çº¿ç¨‹ 2 è°ƒç”¨äº†`CopyOnWriteArrayList`çš„`add`ã€`set`ã€`remove` ç­‰ä¿®æ”¹æ–¹æ³•ï¼Œå†…éƒ¨é€šè¿‡`setArray`æ–¹æ³•ä¿®æ”¹äº†`array`å±æ€§çš„å€¼ï¼Œè€Œçº¿ç¨‹1 ä¾ç„¶æ˜¯ä»æ—§çš„ `array` æ•°ç»„ä¸­è¯»å–çš„å€¼ï¼Œå¯¼è‡´è¯»å–åˆ°çš„å€¼ä¸æ˜¯æœ€æ–°çš„



 



#### åˆ é™¤æ“ä½œ

**åˆ é™¤æŒ‡å®šç´¢å¼•å…ƒç´ çš„æ“ä½œåˆ™é‡‡ç”¨äº†åˆ†æ®µå¤åˆ¶çš„æ–¹æ³•ï¼š**

```java
public E remove(int index) {
    // è·å–å¯é‡å…¥é”  
    final ReentrantLock lock = this.lock;
    // åŠ é”  ä¿è¯å†™çº¿ç¨‹åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª
    lock.lock();
    try {
    	   //è·å–å½“å‰arrayæ•°ç»„
        Object[] elements = getArray();
        // è·å–å½“å‰arrayé•¿åº¦
        int len = elements.length;
        //è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ (æ—§å€¼)
        E oldValue = get(elements, index);
        int numMoved = len - index - 1;
        // åˆ¤æ–­åˆ é™¤çš„æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªå…ƒç´ 
        if (numMoved == 0)
        	   // å¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥å¤åˆ¶è¯¥å…ƒç´ å‰çš„æ‰€æœ‰å…ƒç´ åˆ°æ–°çš„æ•°ç»„
            setArray(Arrays.copyOf(elements, len - 1));
        else {
            // åˆ†æ®µå¤åˆ¶ï¼Œå°†indexå‰çš„å…ƒç´ å’Œindex+1åçš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„
            // æ–°æ•°ç»„é•¿åº¦ä¸ºæ—§æ•°ç»„é•¿åº¦-1
            Object[] newElements = new Object[len - 1];
            System.arraycopy(elements, 0, newElements, 0, index);
            System.arraycopy(elements, index + 1, newElements, index,
                             numMoved);// int numMoved = len - index - 1;
            //å°†æ–°æ•°ç»„èµ‹å€¼ç»™arrayå¼•ç”¨
            setArray(newElements);
        }
        return oldValue;
    } finally {
       	// è§£é”
        lock.unlock();
    }
}

```



å½“ç„¶æ·»åŠ æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ åŒæ ·ä½¿ç”¨åˆ†æ®µå¤åˆ¶çš„æ€æƒ³ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ :question:





## Map



### HashMap



#### å“ˆå¸Œè¿ç®—

åœ¨å‘Mapé›†åˆæ·»åŠ ä¸€ä¸ª`<key,value>`é”®å€¼å¯¹æ—¶ï¼Œé¦–å…ˆå¯¹è¯¥`key`å¯¹è±¡è¿›è¡Œ`hashcode()`å¾—åˆ°`hashcode`å€¼ï¼Œç„¶åé€šè¿‡**æ‰°åŠ¨å‡½æ•°(ä¸åŒjdkç‰ˆæœ¬å‡½æ•°ä¸åŒ)**çš„å¤„ç†å¾—åˆ° `hash` å€¼,ç„¶åé€šè¿‡ `(n - 1) & hash` (æ³¨æ„è¿™é‡Œä¸ºä»€ä¹ˆæ˜¯ [å’Œæ¡¶æ•°ç»„é•¿åº¦-1æ¥è¿›è¡Œ'ä½ä¸'è¿ç®—](https://blog.csdn.net/LLF_1241352445/article/details/81321991) )åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆè¿™é‡Œçš„ n æŒ‡çš„æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰ï¼Œå¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ çš„è¯ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥çš„å…ƒç´ çš„ `hash` å€¼ä»¥åŠ `key` æ˜¯å¦ç›¸åŒï¼Œ**å¦‚æœhashå€¼ç›¸åŒä¸”keyä¹Ÿç›¸åŒï¼Œåˆ™ç›´æ¥è¦†ç›–**ï¼Œä¸ç›¸åŒåˆ™è¯´æ˜äº§ç”Ÿäº†å†²çªï¼Œéšåå¼€å§‹éå†é“¾è¡¨æ’å…¥(**éå†ä»¥è¿™ä¸ªå…ƒç´ ä¸ºå¤´ç»“ç‚¹çš„é“¾è¡¨ï¼Œä¾æ¬¡å’Œéœ€è¦æ’å…¥çš„ key æ¯”è¾ƒï¼Œå¦‚æœ key ç›¸åŒå°±ç›´æ¥è¦†ç›–å½“å‰èŠ‚ç‚¹ï¼Œéå†åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¾æ—§æ²¡æœ‰ç›¸åŒkeyçš„è¯å°±é‡‡ç”¨å°¾æ’æ³•ï¼ˆjava8ï¼‰æ’å…¥å…ƒç´ **)

**JDK 1.8 HashMapçš„hash()æ–¹æ³•:**

```java
    static final int hash(Object key) {
      int h;
      // key.hashCode()ï¼šè¿”å›æ•£åˆ—å€¼ä¹Ÿå°±æ˜¯hashcode
      // ^ï¼šæŒ‰ä½å¼‚æˆ–
      // >>>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½
      // å°†å˜é‡ h ä¸å®ƒæ— ç¬¦å·å³ç§» 16 ä½åçš„ç»“æœè¿›è¡ŒæŒ‰ä½å¼‚æˆ–è¿ç®—
      return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
  }

```

> ä¸ºä»€ä¹ˆæ˜¯ `h = key.hashCode()) ^ (h >>> 16)`ï¼Ÿ
>
> 
>
> ä½¿ç”¨ `h >>> 16` æ¥å°† `h` å˜é‡çš„é«˜ä½ä¿¡æ¯æ··å…¥ä½ä½ï¼Œä»¥å¢åŠ å“ˆå¸Œå€¼çš„éšæœºæ€§å’Œé™ä½å“ˆå¸Œå†²çªçš„æ¦‚ç‡ï¼Œ
>
> ç›¸å½“äºå°†åŸæ¥çš„å“ˆå¸Œç åˆ†æˆ äº†ä¸¤ä¸ª16ä½çš„éƒ¨åˆ†ã€‚ä¸€äº›å“ˆå¸Œç å¯èƒ½åœ¨é«˜ä½æœ‰æ›´å¤šçš„0ï¼Œè€Œå…¶ä»–å“ˆå¸Œç å¯èƒ½åœ¨é«˜ä½æœ‰æ›´å¤šçš„1ã€‚ä½¿ç”¨å¼‚æˆ–æ“ä½œå¯ä»¥å¸®åŠ©åœ¨ä½ä½å’Œé«˜ä½ä¹‹é—´æ··åˆä¿¡æ¯ï¼Œä»è€Œå‡å°‘èšé›†ç°è±¡ï¼Œå¢åŠ å“ˆå¸Œç çš„éšæœºæ€§ã€‚
>
> 
>
> ç†è®ºä¸Šï¼Œå“ˆå¸Œå€¼ï¼ˆå“ˆå¸Œç ï¼‰æ˜¯ä¸€ä¸ª int ç±»å‹ï¼ŒèŒƒå›´ä»-2147483648 åˆ° 2147483648ã€‚å‰ååŠ èµ·æ¥å¤§æ¦‚ 40 äº¿çš„æ˜ å°„ç©ºé—´ï¼Œåªè¦å“ˆå¸Œå€¼æ˜ å°„å¾—æ¯”è¾ƒå‡åŒ€æ¾æ•£ï¼Œä¸€èˆ¬æ˜¯ä¸ä¼šå‡ºç°å“ˆå¸Œç¢°æ’ï¼ˆå“ˆå¸Œå†²çªä¼šé™ä½ HashMap çš„æ•ˆç‡ï¼‰ã€‚
>
> ä½†é—®é¢˜æ˜¯ä¸€ä¸ª 40 äº¿é•¿åº¦çš„æ•°ç»„ï¼Œå†…å­˜æ˜¯æ”¾ä¸ä¸‹çš„ã€‚`HashMap` æ‰©å®¹ä¹‹å‰çš„æ•°ç»„åˆå§‹å¤§å°åªæœ‰ 16ï¼Œæ‰€ä»¥è¿™ä¸ªå“ˆå¸Œå€¼æ˜¯ä¸èƒ½ç›´æ¥æ‹¿æ¥ç”¨çš„ï¼Œç”¨ä¹‹å‰è¦å’Œæ•°ç»„çš„é•¿åº¦åšå–æ¨¡è¿ç®—ï¼ˆä¹‹å‰æåˆ°çš„ `(n - 1) & hash`ï¼‰ï¼Œç”¨å¾—åˆ°çš„ä½™æ•°æ¥è®¿é—®æ•°ç»„ä¸‹æ ‡æ‰è¡Œã€‚



**jdk1.7çš„`hash()`åˆ™æ˜¯ç»è¿‡äº†å››æ¬¡å¤„ç†**ï¼š

```java
static int hash(int h) {
    // This function ensures that hashCodes that differ only by
    // constant multiples at each bit position have a bounded
    // number of collisions (approximately 8 at default load factor).

    h ^= (h >>> 20) ^ (h >>> 12);
    return h ^ (h >>> 7) ^ (h >>> 4);
}

```



>  ä¸ºä»€ä¹ˆ`putVal()`æ–¹æ³•ä¸­ç”¨åˆ°äº†ï¼š `(n - 1) & hash`è€Œæ²¡æœ‰ç”¨`%`è¿ç®—ï¼Ÿ

è¿™æ˜¯å› ä¸º`&` è¿ç®—æ¯” `%` æ›´åŠ é«˜æ•ˆï¼Œå¹¶ä¸”å½“ b ä¸º 2 çš„ n æ¬¡æ–¹æ—¶ï¼Œå­˜åœ¨ä¸‹é¢è¿™æ ·ä¸€ä¸ªå…¬å¼ï¼š

```java
a % b = a & (b-1)
```

æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š

å‡å¦‚ a = 14ï¼Œb = 8ï¼Œé‚£ä¹ˆ 14%8 å–æ¨¡çš„ç»“æœä¸º 6

14 çš„äºŒè¿›åˆ¶ä¸º 1110ï¼Œ8 çš„äºŒè¿›åˆ¶ 1000ï¼Œ8-1 = 7ï¼Œ7 çš„äºŒè¿›åˆ¶ä¸º 0111ï¼Œ1110&0111=0110ï¼Œä½è¿ç®—&å¾—åˆ°çš„ç»“æœä¹Ÿä¸º6ï¼Œ**è¿™æ ·è®¡ç®—æœºè®¡ç®—&è¿ç®—æ—¶åªéœ€å…³æ³¨hashå€¼çš„æœ€ä½Nä½å³å¯ï¼Œè¿™æ‰æ˜¯æ ¸å¿ƒï¼ï¼**



>  **è¿™ä¹Ÿæ­£å¥½è§£é‡Šäº†ä¸ºä»€ä¹ˆ `HashMap` çš„æ•°ç»„é•¿åº¦è¦å– 2 çš„Næ•´æ¬¡æ–¹ï¼Ÿ**

æ¥çœ‹ä¸ªä¾‹å­ï¼š å‡è®¾hashå€¼ä¸º20ï¼ŒhashMapçš„å®¹é‡ä¸ºlength=16

åè¿›åˆ¶å–ä½™ç®—æ³•ï¼š20%16 = 4ï¼›æ‰€ä»¥ä»»ä½•çš„hashå€¼å¾—å–ä½™éƒ½åœ¨0-15ä¹‹é—´ï¼Œè¾¾åˆ°äº†æœ€æœ‰å¯èƒ½å¾—å¹³å‡åˆ†é…ï¼›

äºŒè¿›åˆ¶ç®—æ³•ï¼š20è½¬ä¸ºäºŒè¿›åˆ¶ä½10100ï¼Œlength-1=15 = 01111ï¼›æ‰€ä»¥äºŒè¿›åˆ¶ç®—æ³•ä¸º10100 & 01111 = 0100 = 4ï¼Œ**é«˜ä½å’Œlength-1çš„0ç›¸ä¸åå…¨éƒ¨èˆå¼ƒï¼Œç›´æ¥ä¿ç•™äº†hashå€¼æœ€åNä½**ï¼Œè€Œæœ€åNä½åˆšå¥½å°±æ˜¯åè¿›åˆ¶çš„å–ä½™è¿ç®—çš„ç»“æœï¼›ä»»ä½•hashå€¼éƒ½æ˜¯è¿™æ ·ï¼›



å‡å¦‚ä¸æ˜¯æ¡¶æ•°ç»„é•¿åº¦ä¸æ˜¯æŒ‰2çš„å¹‚æ¬¡æ–¹è®¾ç½®ï¼Œä¾‹å¦‚length = 15ï¼Œhash= 17ï¼Œåˆ™10è¿›åˆ¶å–ä½™è¿ç®—ä¸º2ï¼ŒäºŒè¿›åˆ¶ä½è¿ç®—ä¸º10001&01110 =0ï¼Œä¸ä¼šç­‰äº10è¿›åˆ¶çš„çš„è¿ç®—ç»“æœï¼›è€Œ**å®é™…ä¸Šlength-1 = 14 = 01110å’Œä»»ä½•çš„hashç›¸ä¸ï¼Œæœ€åçš„ä¸€ä½çš„0éƒ½ä¼šè¢«èˆå¼ƒï¼Œæ‰€ä»¥ä»»ä½•çš„hashå€¼å’Œ01110ç›¸ä¸çš„ç»“æœéƒ½ä¸ä¼šå‡ºç°1101ï¼ˆ13ï¼‰ï¼Œ1001ï¼ˆ9ï¼‰ç­‰æ•°æ®ï¼Œæ‰€ä»¥ç›¸å½“äºtableçš„æ•°ç»„ä¸­index =13æˆ–è€…9çš„ä½ç½®æ°¸è¿œä¸ä¼šä¿å­˜åˆ°æ•°æ®**ï¼Œé€ æˆç©ºé—´æµªè´¹ï¼›æ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±ä¸èƒ½ç”¨ä½è¿ç®—æ¥è®¡ç®—keyåº”è¯¥æ”¾å…¥æ¡¶æ•°ç»„ä¸­çš„å“ªä¸ªç´¢å¼•å¤„ï¼Œå°±åªèƒ½é‡‡ç”¨10è¿›åˆ¶è®¡ç®—ï¼Œä½†æ˜¯è¿™æ ·é€Ÿåº¦å°±è¿œè¿œæ¯”ä¸ä¸ŠäºŒè¿›åˆ¶è¿ç®—ï¼Œæ¯•ç«Ÿå¦‚æœæ¡¶æ•°ç»„é•¿åº¦ä¸º2çš„Næ¬¡æ–¹çš„è¯ï¼Œé€šè¿‡&è¿ç®—æ¥è®¡ç®—è¯¥<Key,Value>çš„ä½ç½®æ—¶åªéœ€è¦ç›´æ¥è¯»å–Keyçš„Hashå€¼çš„ä½Nä½å°±å¯ä»¥äº†ï¼





#### put/get åˆ†æ

`put` æ“ä½œï¼š

```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

// ç¬¬å››ä¸ªå‚æ•° onlyIfAbsent å¦‚æœæ˜¯ trueï¼Œé‚£ä¹ˆåªæœ‰åœ¨ä¸å­˜åœ¨è¯¥ key æ—¶æ‰ä¼šè¿›è¡Œ put æ“ä½œ
// ç¬¬äº”ä¸ªå‚æ•° evict æˆ‘ä»¬è¿™é‡Œä¸å…³å¿ƒ
final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
               boolean evict) {
    Node<K,V>[] tab; Node<K,V> p; int n, i;
    // ç¬¬ä¸€æ¬¡ put å€¼çš„æ—¶å€™ï¼Œä¼šè§¦å‘ä¸‹é¢çš„ resize()ï¼Œç±»ä¼¼ java7 çš„ç¬¬ä¸€æ¬¡ put ä¹Ÿè¦åˆå§‹åŒ–æ•°ç»„é•¿åº¦
    // ç¬¬ä¸€æ¬¡ resize å’Œåç»­çš„æ‰©å®¹æœ‰äº›ä¸ä¸€æ ·ï¼Œå› ä¸ºè¿™æ¬¡æ˜¯æ•°ç»„ä» null åˆå§‹åŒ–åˆ°é»˜è®¤çš„ 16 æˆ–è‡ªå®šä¹‰çš„åˆå§‹å®¹é‡
    if ((tab = table) == null || (n = tab.length) == 0)
        n = (tab = resize()).length;
    
    
    // æ‰¾åˆ°å…·ä½“çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¦‚æœæ­¤ä½ç½®æ²¡æœ‰å€¼,ç¬¬ä¸€æ¬¡æ”¾å…¥è¯¥ç´¢å¼•å¤„
    //ï¼Œé‚£ä¹ˆç›´æ¥åˆå§‹åŒ–ä¸€ä¸‹ Node å¹¶æ”¾ç½®åœ¨è¿™ä¸ªä½ç½®å°±å¯ä»¥äº†
    if ((p = tab[i = (n - 1) & hash]) == null)
        tab[i] = newNode(hash, key, value, null);

    else {// æ•°ç»„è¯¥ä½ç½®æœ‰æ•°æ® å“ˆå¸Œå†²çª
        Node<K,V> e; K k;
        // é¦–å…ˆï¼Œåˆ¤æ–­è¯¥ä½ç½®çš„ç¬¬ä¸€ä¸ªæ•°æ®å’Œæˆ‘ä»¬è¦æ’å…¥çš„æ•°æ®ï¼Œkey æ˜¯ä¸æ˜¯"ç›¸ç­‰"ï¼Œå¦‚æœæ˜¯ï¼Œå–å‡ºè¿™ä¸ªèŠ‚ç‚¹
        if (p.hash == hash &&
            ((k = p.key) == key || (key != null && key.equals(k))))
            e = p;
        // å¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ä»£è¡¨çº¢é»‘æ ‘çš„èŠ‚ç‚¹ï¼Œè°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´çº¢é»‘æ ‘
        else if (p instanceof TreeNode)
            e = ((TreeNode<K,V>)p).putTreeVal(this, tab, hash, key, value);
        else {
            // åˆ°è¿™é‡Œï¼Œè¯´æ˜æ•°ç»„è¯¥ä½ç½®ä¸Šæ˜¯ä¸€ä¸ªé“¾è¡¨
            for (int binCount = 0; ; ++binCount) {
                // æ’å…¥åˆ°é“¾è¡¨çš„æœ€åé¢(Java7 æ˜¯æ’å…¥åˆ°é“¾è¡¨çš„æœ€å‰é¢) //å°¾æ’æ³•
                if ((e = p.next) == null) {
                    p.next = newNode(hash, key, value, null);
                    // TREEIFY_THRESHOLD ä¸º 8ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæ–°æ’å…¥çš„å€¼æ˜¯é“¾è¡¨ä¸­çš„ç¬¬ 8 ä¸ª
                    // ä¼šè§¦å‘ä¸‹é¢çš„ treeifyBinï¼Œä¹Ÿå°±æ˜¯å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘
                    if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                        treeifyBin(tab, hash);
                    break;
                }
                // å¦‚æœåœ¨è¯¥é“¾è¡¨ä¸­æ‰¾åˆ°äº†"ç›¸ç­‰"çš„ key(== æˆ– equals)
                if (e.hash == hash &&
                    ((k = e.key) == key || (key != null && key.equals(k))))
                    // æ­¤æ—¶ breakï¼Œé‚£ä¹ˆ e ä¸ºé“¾è¡¨ä¸­[ä¸è¦æ’å…¥çš„æ–°å€¼çš„ key "ç›¸ç­‰"]çš„ node
                    break;
                p = e;
            }
        }
        // e!=null è¯´æ˜å­˜åœ¨æ—§å€¼çš„keyä¸è¦æ’å…¥çš„key"ç›¸ç­‰"
        // å¯¹äºæˆ‘ä»¬åˆ†æçš„putæ“ä½œï¼Œä¸‹é¢è¿™ä¸ª if å…¶å®å°±æ˜¯è¿›è¡Œ "å€¼è¦†ç›–"ï¼Œç„¶åè¿”å›æ—§å€¼
        if (e != null) {
            V oldValue = e.value;
            if (!onlyIfAbsent || oldValue == null)
                e.value = value;
            afterNodeAccess(e);
            return oldValue;
        }
    }
    ++modCount;
    // å¦‚æœ HashMap ç”±äºæ–°æ’å…¥è¿™ä¸ªå€¼å¯¼è‡´ size å·²ç»è¶…è¿‡äº†é˜ˆå€¼ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹
    if (++size > threshold)
        resize();
    afterNodeInsertion(evict);
    return null;
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

- jdk7åœ¨ä½¿ç”¨é“¾åœ°å€æ³•å¤„ç†å“ˆå¸Œå†²çªæ—¶ï¼Œé‡‡ç”¨çš„æ˜¯å¤´æ’æ³•ï¼Œè€Œjdk8åˆ™é‡‡ç”¨äº†å°¾æ’æ³•

- é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„æ ¹æ®ç”±`TREEIFY_THRESHOLD`å†³å®šï¼š

  ```java
  static final int TREEIFY_THRESHOLD = 8;   // é“¾è¡¨è¿›åŒ–ä¸ºçº¢é»‘æ ‘é˜ˆå€¼
  static final int UNTREEIFY_THRESHOLD = 6; // çº¢é»‘æ ‘é€€åŒ–ä¸ºé“¾è¡¨é˜ˆå€¼
  ```

  

ä»¥JDK 8ä¸ºä¾‹ï¼Œç®€è¦æµç¨‹å¦‚ä¸‹ï¼š

1ã€é¦–å…ˆæ ¹æ® key çš„å€¼è®¡ç®— hash å€¼ï¼Œæ‰¾åˆ°è¯¥å…ƒç´ åœ¨æ•°ç»„ä¸­å­˜å‚¨çš„ä¸‹æ ‡ï¼›

2ã€å¦‚æœæ•°ç»„æ˜¯ç©ºçš„ï¼Œåˆ™è°ƒç”¨ **`resize`** è¿›è¡Œåˆå§‹åŒ–ï¼›

3ã€å¦‚æœæ²¡æœ‰å“ˆå¸Œå†²çªç›´æ¥æ”¾åœ¨å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡é‡Œï¼›

4ã€å¦‚æœå†²çªäº†ï¼Œä¸” key å·²ç»å­˜åœ¨ï¼Œå°±è¦†ç›–æ‰ valueï¼›

5ã€å¦‚æœå†²çªåï¼Œå‘ç°è¯¥èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘ï¼Œå°±å°†è¿™ä¸ªèŠ‚ç‚¹æŒ‚åœ¨æ ‘ä¸Šï¼›

6ã€å¦‚æœå†²çªåæ˜¯é“¾è¡¨ï¼Œ**åˆ¤æ–­è¯¥é“¾è¡¨æ˜¯å¦å¤§äº 8 ï¼Œå¦‚æœå¤§äº 8åˆ™è¿›å…¥treeifyBinæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨éœ€è¦å…ˆåˆ¤æ–­æ¡¶æ•°ç»„é•¿åº¦æ˜¯å¦å°äº64ï¼Œå°äº64åˆ™ä¼˜å…ˆè¿›è¡Œæ‰©å®¹ï¼›å¦‚æœé“¾è¡¨èŠ‚ç‚¹å¤§äº 8 å¹¶ä¸”æ•°ç»„çš„å®¹é‡å¤§äº 64ï¼Œåˆ™å°†è¿™ä¸ªç»“æ„è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼›**å¦åˆ™ï¼Œé“¾è¡¨æ’å…¥é”®å€¼å¯¹ï¼Œè‹¥ key å­˜åœ¨ï¼Œå°±è¦†ç›–æ‰ valueã€‚













`get` æ“ä½œï¼š

ç›¸å¯¹äº put æ¥è¯´ï¼Œget æ“ä½œç®€å•äº†è®¸å¤šï¼š

- è®¡ç®— key çš„ hash å€¼ï¼Œæ ¹æ® hash å€¼æ‰¾åˆ°å¯¹åº”æ•°ç»„ä¸‹æ ‡: hash & (length-1)
- åˆ¤æ–­æ•°ç»„è¯¥ä½ç½®å¤„çš„å…ƒç´ æ˜¯å¦åˆšå¥½å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œèµ°ç¬¬ä¸‰æ­¥
- åˆ¤æ–­è¯¥å…ƒç´ ç±»å‹æ˜¯å¦æ˜¯ TreeNodeï¼Œå¦‚æœæ˜¯ï¼Œç”¨çº¢é»‘æ ‘çš„æ–¹æ³•å–æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œèµ°ç¬¬å››æ­¥
- éå†é“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸ç­‰(==æˆ–equals)çš„ key

```java
public V get(Object key) {
    Node<K,V> e;
    return (e = getNode(hash(key), key)) == null ? null : e.value;
}
final Node<K,V> getNode(int hash, Object key) {
    Node<K,V>[] tab; Node<K,V> first, e; int n; K k;
    if ((tab = table) != null && (n = tab.length) > 0 &&
        (first = tab[(n - 1) & hash]) != null) {
        // åˆ¤æ–­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯å°±æ˜¯éœ€è¦çš„
        if (first.hash == hash && // always check first node
            ((k = first.key) == key || (key != null && key.equals(k))))
            return first;
        if ((e = first.next) != null) {
            // åˆ¤æ–­æ˜¯å¦æ˜¯çº¢é»‘æ ‘
            if (first instanceof TreeNode)
                return ((TreeNode<K,V>)first).getTreeNode(hash, key);

            // é“¾è¡¨éå†
            do {
                if (e.hash == hash &&
                    ((k = e.key) == key || (key != null && key.equals(k))))
                    return e;
            } while ((e = e.next) != null);
        }
    }
    return null;
}
```







#### resize æ‰©å®¹:grey_exclamation:

å†³å®š`HashMap`ä½•æ—¶æ‰©å®¹çš„å› ç´ æœ‰ä¸¤ä¸ªï¼š`loadFactor`å’Œ`threshold`

```java
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4;// é»˜è®¤æ•°ç»„çš„åˆå§‹å®¹é‡æ˜¯16
static final float DEFAULT_LOAD_FACTOR = 0.75f;

final float loadFactor;//è´Ÿè½½å› å­
int threshold; // è®¾å®šçš„é˜ˆå€¼(å®¹é‡*è´Ÿè½½å› å­)   å½“æ•°ç»„çš„å®é™…å¤§å°è¶…è¿‡è®¾å®šé˜ˆå€¼æ—¶ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹
```

> loadFactor è´Ÿè½½å› å­æ˜¯æ§åˆ¶æ•°ç»„å­˜æ”¾æ•°æ®çš„ç–å¯†ç¨‹åº¦ï¼ŒloadFactor è¶Šè¶‹è¿‘äº 1ï¼Œé‚£ä¹ˆ æ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®(entry)ä¹Ÿå°±è¶Šå¤šï¼Œä¹Ÿå°±è¶Šå¯†ï¼Œä¹Ÿå°±æ˜¯ä¼šè®©é“¾è¡¨çš„é•¿åº¦å¢åŠ ï¼ŒloadFactor è¶Šå°ï¼Œä¹Ÿå°±æ˜¯è¶‹è¿‘äº 0ï¼Œæ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®(entry)ä¹Ÿå°±è¶Šå°‘ï¼Œä¹Ÿå°±è¶Šç¨€ç–ã€‚**loadFactor å¤ªå¤§å¯¼è‡´æŸ¥æ‰¾å…ƒç´ æ•ˆç‡ä½ï¼Œå¤ªå°å¯¼è‡´æ•°ç»„çš„åˆ©ç”¨ç‡ä½ï¼Œå­˜æ”¾çš„æ•°æ®ä¼šå¾ˆåˆ†æ•£**

å¯ä»¥çœ‹åˆ°æ¡¶æ•°ç»„é»˜è®¤åˆå§‹é•¿åº¦ä¸º16ï¼Œ`loadFactor`ä¸º0.75f,åœ¨ä¸æ–­å¾€Mapä¸­å­˜æ”¾æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå½“æ¡¶æ•°ç»„ä¸­æœ‰æ•ˆå…ƒç´ æ•°é‡è¾¾åˆ°`16*0.75=12`æ—¶ï¼Œå°±éœ€è¦å¯¹æ¡¶æ•°ç»„è¿›è¡Œ`resize()`æ‰©å®¹(æ‰©å®¹è‡³åŸæ¥é•¿åº¦çš„ä¸¤å€)ï¼Œç”±äº`resize()`æ–¹æ³•å®ç°ç•¥å¾®å¤æ‚ï¼Œè¿™é‡Œåªè´´ä¸Šæ ¸å¿ƒä»£ç ï¼š

```java
final Node<K,V>[] resize() {
    Node<K,V>[] oldTab = table;
    int oldCap = (oldTab == null) ? 0 : oldTab.length;
    int oldThr = threshold;
    int newCap, newThr = 0;
    if (oldCap > 0) {
        // è¶…è¿‡æœ€å¤§å€¼å°±ä¸å†æ‰©å……äº†ï¼Œå°±åªå¥½éšä½ ç¢°æ’å»å§
        if (oldCap >= MAXIMUM_CAPACITY) {
            threshold = Integer.MAX_VALUE;
            return oldTab;
        }
        // æ²¡è¶…è¿‡æœ€å¤§å€¼ï¼Œå°±æ‰©å……ä¸ºåŸæ¥çš„2å€
        else if ((newCap = oldCap << 1) < MAXIMUM_CAPACITY && oldCap >= DEFAULT_INITIAL_CAPACITY)
            newThr = oldThr << 1; // double threshold
    }
    else if (oldThr > 0) // initial capacity was placed in threshold
        // åˆ›å»ºå¯¹è±¡æ—¶åˆå§‹åŒ–å®¹é‡å¤§å°æ”¾åœ¨thresholdä¸­ï¼Œæ­¤æ—¶åªéœ€è¦å°†å…¶ä½œä¸ºæ–°çš„æ•°ç»„å®¹é‡
        newCap = oldThr;
    else {
        // signifies using defaults æ— å‚æ„é€ å‡½æ•°åˆ›å»ºçš„å¯¹è±¡åœ¨è¿™é‡Œè®¡ç®—å®¹é‡å’Œé˜ˆå€¼
        newCap = DEFAULT_INITIAL_CAPACITY;
        newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
    }
    if (newThr == 0) {
        // åˆ›å»ºæ—¶æŒ‡å®šäº†åˆå§‹åŒ–å®¹é‡æˆ–è€…è´Ÿè½½å› å­ï¼Œåœ¨è¿™é‡Œè¿›è¡Œé˜ˆå€¼åˆå§‹åŒ–ï¼Œ
    	// æˆ–è€…æ‰©å®¹å‰çš„æ—§å®¹é‡å°äº16ï¼Œåœ¨è¿™é‡Œè®¡ç®—æ–°çš„resizeä¸Šé™
        float ft = (float)newCap * loadFactor;
        newThr = (newCap < MAXIMUM_CAPACITY && ft < (float)MAXIMUM_CAPACITY ? (int)ft : Integer.MAX_VALUE);
    }
    threshold = newThr;
    @SuppressWarnings({"rawtypes","unchecked"})
        Node<K,V>[] newTab = (Node<K,V>[])new Node[newCap];
    table = newTab;
    if (oldTab != null) {
        // æŠŠæ¯ä¸ªbucketéƒ½ç§»åŠ¨åˆ°æ–°çš„bucketsä¸­
        for (int j = 0; j < oldCap; ++j) {
            Node<K,V> e;
            if ((e = oldTab[j]) != null) {
                oldTab[j] = null;
                if (e.next == null)
                    // åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›´æ¥è®¡ç®—å…ƒç´ æ–°çš„ä½ç½®å³å¯
                    newTab[e.hash & (newCap - 1)] = e;
                else if (e instanceof TreeNode)
                    // å°†çº¢é»‘æ ‘æ‹†åˆ†æˆ2æ£µå­æ ‘ï¼Œæ‹†åˆ†åçš„å­æ ‘èŠ‚ç‚¹æ•°å°äºç­‰äº6ï¼Œåˆ™å°†æ ‘è½¬åŒ–æˆé“¾è¡¨
                    ((TreeNode<K,V>)e).split(this, newTab, j, oldCap);
                else {
                    Node<K,V> loHead = null, loTail = null;
                    Node<K,V> hiHead = null, hiTail = null;
                    Node<K,V> next;
                    do {
                        next = e.next;
                        // åŸç´¢å¼•
                        if ((e.hash & oldCap) == 0) {
                            if (loTail == null)
                                loHead = e;
                            else
                                loTail.next = e;
                            loTail = e;
                        }
                        // åŸç´¢å¼•+oldCap
                        else {
                            if (hiTail == null)
                                hiHead = e;
                            else
                                hiTail.next = e;
                            hiTail = e;
                        }
                    } while ((e = next) != null);
                    // åŸç´¢å¼•æ”¾åˆ°bucketé‡Œ
                    if (loTail != null) {
                        loTail.next = null;
                        newTab[j] = loHead;
                    }
                    // åŸç´¢å¼•+oldCapæ”¾åˆ°bucketé‡Œ
                    if (hiTail != null) {
                        hiTail.next = null;
                        newTab[j + oldCap] = hiHead;
                    }
                }
            }
        }
    }
    return newTab;
}
```

æµç¨‹å¦‚ä¸‹ï¼š

1ã€è·å–åŸæ¥çš„æ•°ç»„ tableã€æ•°ç»„é•¿åº¦ oldCap å’Œé˜ˆå€¼ oldThrã€‚

**2ã€å¦‚æœåŸæ¥çš„æ•°ç»„ table ä¸ä¸ºç©ºï¼Œåˆ™æ ¹æ®æ‰©å®¹è§„åˆ™è®¡ç®—æ–°æ•°ç»„é•¿åº¦ newCap å’Œæ–°é˜ˆå€¼ newThrï¼Œç„¶åå°†åŸæ•°ç»„ä¸­çš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ã€‚**

**3ã€å¦‚æœåŸæ¥çš„æ•°ç»„ table ä¸ºç©ºä½†é˜ˆå€¼ oldThr ä¸ä¸ºé›¶ï¼Œåˆ™è¯´æ˜æ˜¯é€šè¿‡å¸¦å‚æ•°æ„é€ å‡½æ•°åˆ›å»ºçš„ HashMapï¼Œæ­¤æ—¶å°†é˜ˆå€¼ä½œä¸ºæ–°æ•°ç»„é•¿åº¦ newCapã€‚**

**4ã€å¦‚æœåŸæ¥çš„æ•°ç»„ `table` å’Œé˜ˆå€¼ `oldThr` éƒ½ä¸ºé›¶ï¼Œåˆ™è¯´æ˜æ˜¯é€šè¿‡æ— å‚æ•°æ„é€ å‡½æ•°åˆ›å»ºçš„ HashMapï¼Œæ­¤æ—¶å°†é»˜è®¤åˆå§‹å®¹é‡ DEFAULT_INITIAL_CAPACITYï¼ˆ16ï¼‰å’Œé»˜è®¤è´Ÿè½½å› å­ DEFAULT_LOAD_FACTORï¼ˆ0.75ï¼‰è®¡ç®—å‡ºæ–°æ•°ç»„é•¿åº¦ newCap å’Œæ–°é˜ˆå€¼ newThrã€‚**

5ã€è®¡ç®—æ–°é˜ˆå€¼ thresholdï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™æˆå‘˜å˜é‡ thresholdã€‚

6ã€åˆ›å»ºæ–°æ•°ç»„ newTabï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™æˆå‘˜å˜é‡ tableã€‚

7ã€å¦‚æœæ—§æ•°ç»„ oldTab ä¸ä¸ºç©ºï¼Œåˆ™éå†æ—§æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œå°†å…¶å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ã€‚

8ã€è¿”å›æ–°æ•°ç»„ newTab





æ‰©å®¹è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. è®¡ç®—æ–°çš„å®¹é‡ï¼šå°†åŸå§‹å®¹é‡ä¹˜ä»¥ 2ï¼Œå¾—åˆ°æ–°çš„å®¹é‡
2. åˆ›å»ºæ–°æ•°ç»„ï¼šæ ¹æ®æ–°çš„å®¹é‡åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œç”¨äºå­˜æ”¾å…ƒç´ 
3. é‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼šéå†åŸæ•°ç»„ä¸­çš„å…ƒç´ ï¼Œé‡æ–°è®¡ç®—æ¯ä¸ªå…ƒç´ çš„å“ˆå¸Œå€¼ï¼Œå¹¶æ ¹æ®æ–°çš„å®¹é‡å–æ¨¡ï¼Œå¾—åˆ°æ–°çš„ç´¢å¼•ä½ç½®
4. æ’å…¥åˆ°æ–°æ•°ç»„ï¼šæ ¹æ®æ–°çš„ç´¢å¼•ä½ç½®ï¼Œå°†å…ƒç´ æ’å…¥åˆ°æ–°çš„æ•°ç»„ä¸­(å¦‚æœhashå†²çªï¼Œjdk8é‡‡ç”¨å°¾æ’æ³•è§£å†³)
5. æ›´æ–°å¼•ç”¨ï¼šå°† `HashMap` å†…éƒ¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„æ•°ç»„ï¼ŒåŸæ•°ç»„å°†è¢«åƒåœ¾å›æ”¶







å½“ç„¶è¿˜æœ‰å¦å¤–ä¸€ç§æƒ…å†µï¼Œåˆå§‹åŒ–hashmapæ—¶ï¼Œå¦‚æœè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼Œå³ä¸ä¼ å…¥initalCapacityï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ è‡³Nodeæ•°ç»„æ—¶æ‰§è¡Œæ‰©å®¹`resize()`æ–¹æ³•ï¼š
![image-20240403013539935](https://cdn.jsdelivr.net/gh/amonstercat/PicGo@master/202404030135308.png)

å†æ¥çœ‹ä¸€ä¸‹resize()æ–¹æ³•ä¸­é’ˆå¯¹ç©ºNodeæ•°ç»„æ‰§è¡Œæ‰©å®¹çš„æ ¸å¿ƒé€»è¾‘ï¼š
![image-20240403013746933](https://cdn.jsdelivr.net/gh/amonstercat/PicGo@master/202404030137136.png)


#### rE


#### å¤„ç†å†²çª

jdk1.8åœ¨è§£å†³å“ˆå¸Œå†²çªæ—¶,**å½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰æ—¶**ï¼Œä¼šé¦–å…ˆè°ƒç”¨ `treeifyBin()`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ® HashMap æ•°ç»„æ¥å†³å®šæ˜¯å¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚åªæœ‰å½“æ•°ç»„é•¿åº¦å¤§äºæˆ–è€…ç­‰äº 64 çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ‰§è¡Œè½¬æ¢çº¢é»‘æ ‘æ“ä½œä»¥å‡å°‘æœç´¢æ—¶é—´ã€‚å¦åˆ™å°±åªæ˜¯æ‰§è¡Œ `resize()` æ–¹æ³•å¯¹æ•°ç»„æ‰©å®¹ï¼š

```java
static final int MIN_TREEIFY_CAPACITY = 64; //æ•°ç»„é•¿åº¦å¤§äº64æ—¶æ‰ä¼šè½¬æ¢çº¢é»‘æ ‘
static final int TREEIFY_THRESHOLD = 8; //é“¾è¡¨é•¿åº¦è½¬æ¢ä¸ºçº¢é»‘æ ‘çš„é˜ˆå€¼ï¼ˆä½†ä¹Ÿä¸ä¸€å®šè½¬æ¢ï¼ï¼‰
static final int UNTREEIFY_THRESHOLD = 6;// å½“æ¡¶(bucket)ä¸Šçš„ç»“ç‚¹æ•°å°äºç­‰äºè¿™ä¸ªå€¼æ—¶çº¢é»‘æ ‘é€€åŒ–ä¸ºè½¬é“¾è¡¨

 final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict){
     p.next = newNode(hash, key, value, null);
     if (binCount >= TREEIFY_THRESHOLD - 1) //  é“¾è¡¨é•¿åº¦å¤§äºè®¾å®šçš„é˜ˆå€¼8æ—¶ï¼Œæ‰§è¡ŒtreeiftBin()æ–¹æ³•æ¥å†³å®šæ˜¯å¦è½¬æ¢
       treeifyBin(tab, hash);
       break;
 }


final void treeifyBin(Node<K,V>[] tab, int hash) {
        int n, index; Node<K,V> e;
        if (tab == null || (n = tab.length) < MIN_TREEIFY_CAPACITY)
            resize(); //åˆ¤æ–­æ­¤æ—¶çš„æ¡¶æ•°ç»„é•¿åº¦ï¼Œå¦‚æœå°äº64ï¼Œåˆ™ä¼˜å…ˆå¯¹æ•°ç»„è¿›è¡Œæ‰©å®¹
        else if ((e = tab[index = (n - 1) & hash]) != null) {
            TreeNode<K,V> hd = null, tl = null;
            do {
                TreeNode<K,V> p = replacementTreeNode(e, null);
                if (tl == null)
                    hd = p;
                else {
                    p.prev = tl;
                    tl.next = p;
                }
                tl = p;
            } while ((e = e.next) != null);
            if ((tab[index] = hd) != null)
                hd.treeify(tab);
        }
    }

```



æˆ–è®¸æœ‰äººä¼šç–‘æƒ‘ï¼šä¸ºä»€ä¹ˆä¸€å¼€å§‹ä¸ä½¿ç”¨çº¢é»‘æ ‘æ¥è§£å†³é“¾è¡¨å†²çªï¼Œä¸ºä»€ä¹ˆtreeifybinçš„é˜ˆå€¼ä¸º8 è€Œä¸æ˜¯å…¶ä»–å€¼ï¼Ÿæ¨èé˜…è¯»è¿™ç¯‡æ–‡ç« ï¼š

https://cnblogs.com/liaowenhui/p/15055596.html

https://segmentfault.com/a/1190000023308658





#### çº¿ç¨‹å®‰å…¨é—®é¢˜

(1)å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ‰©å®¹å¯¼è‡´æ­»å¾ªç¯ï¼š

JDK1.7 åŠä¹‹å‰ç‰ˆæœ¬çš„ `HashMap` åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ‰©å®¹æ“ä½œå¯èƒ½å­˜åœ¨æ­»å¾ªç¯é—®é¢˜ï¼Œè¿™æ˜¯ç”±äºå½“ä¸€ä¸ªæ¡¶ä½ä¸­æœ‰å¤šä¸ªå…ƒç´ éœ€è¦è¿›è¡Œæ‰©å®¹æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹é“¾è¡¨è¿›è¡Œæ“ä½œï¼Œ**å¤´æ’æ³•**å¯èƒ½ä¼šå¯¼è‡´é“¾è¡¨ä¸­çš„èŠ‚ç‚¹æŒ‡å‘é”™è¯¯çš„ä½ç½®ï¼Œä»è€Œå½¢æˆä¸€ä¸ªç¯å½¢é“¾è¡¨ï¼Œè¿›è€Œä½¿å¾—æŸ¥è¯¢å…ƒç´ çš„æ“ä½œé™·å…¥æ­»å¾ªç¯æ— æ³•ç»“æŸã€‚å½“æœ‰æ•°æ®è¦æ’å…¥æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥å®¹é‡æœ‰æ²¡æœ‰è¶…è¿‡è®¾å®šçš„`threshold`ï¼Œå¦‚æœè¶…è¿‡ï¼Œéœ€è¦å¢å¤§`HashMap`çš„å°ºå¯¸ï¼Œè¿™æ ·ä¸€æ¥æ•´ä¸ªHashè¡¨é‡Œçš„å…ƒç´ éƒ½éœ€è¦è¢«é‡ç®—ä¸€é ï¼Œè¿™å°±æ˜¯`rehash`ï¼Œè€Œ`HashMap`çš„æ­»å¾ªç¯é—®é¢˜å°±å‘ç”Ÿåœ¨è¿™é‡Œï¼š

æ­£å¸¸æƒ…å†µ(å•çº¿ç¨‹)ä¸‹`HashMap`çš„`rehash`è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼ˆé“¾è¡¨ä½¿ç”¨å¤´æ’æ³•ï¼‰ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/hashmap1.jpg)





è€Œåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ T1 å’Œçº¿ç¨‹ T2 è¦å¯¹ HashMap è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œæ­¤æ—¶ T1 å’Œ T2 æŒ‡å‘çš„æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹å…ƒç´  Aï¼Œè€Œ T1 å’Œ T2 çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ T1.next å’Œ T2.next æŒ‡å‘çš„æ˜¯ B èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/hashmap2.jpg)



çº¿ç¨‹ T2 æ—¶é—´ç‰‡ç”¨å®Œè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè€Œçº¿ç¨‹ T1 å¼€å§‹æ‰§è¡Œæ‰©å®¹æ“ä½œï¼ˆä¸”ä¸€ç›´åˆ°çº¿ç¨‹ T1 æ‰©å®¹å®Œæˆåï¼Œçº¿ç¨‹ T2 æ‰è¢«å”¤é†’ï¼‰ï¼Œä¸Šå›¾å¯çŸ¥çº¿ç¨‹ T1 æ‰§è¡Œä¹‹åï¼Œå› ä¸ºæ˜¯å¤´æ’æ³•ï¼Œæ‰€ä»¥ `HashMap` å†²çªé“¾è¡¨ä¸­å…ƒç´ çš„é¡ºåºå·²ç»å‘ç”Ÿäº†æ”¹å˜(**(æ’å…¥é¡ºåºæ˜¯A->B->C,æ•…æ’å…¥å®Œæˆåä¼šæœ‰Bâ€”â€”>Açš„æŒ‡é’ˆ)**)ï¼Œä½†çº¿ç¨‹ T2 å¯¹äºå‘ç”Ÿçš„ä¸€åˆ‡æ˜¯ä¸å¯çŸ¥çš„ï¼Œæ‰€ä»¥å®ƒçš„æŒ‡å‘å…ƒç´ ä¾ç„¶æ²¡å˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçš„é‚£æ ·ï¼ŒT2 æŒ‡å‘çš„æ˜¯ A å…ƒç´ ï¼ŒT2.next æŒ‡å‘çš„èŠ‚ç‚¹æ˜¯ B å…ƒç´ ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/hashmap3.jpg)

è¿™æ ·å½“çº¿ç¨‹ T1 æ‰§è¡Œå®Œï¼Œè€Œçº¿ç¨‹ T2 æ¢å¤æ‰§è¡Œæ—¶ï¼Œæ­»å¾ªç¯å°±å»ºç«‹äº†ï¼Œå› ä¸º T1 æ‰§è¡Œå®Œæ‰©å®¹ä¹‹å B èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ Aï¼Œè€Œ T2 çº¿ç¨‹æŒ‡å‘çš„é¦–èŠ‚ç‚¹æ˜¯ Aï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯ Bï¼Œè¿™ä¸ªé¡ºåºåˆšå¥½å’Œ T1 æ‰©å®Œå®¹å®Œä¹‹åçš„èŠ‚ç‚¹é¡ºåºæ˜¯ç›¸åçš„ã€‚T1 æ‰§è¡Œå®Œä¹‹åçš„é¡ºåºæ˜¯ B åˆ° Aï¼Œè€Œ T2 çš„é¡ºåºæ˜¯ A åˆ° Bï¼Œè¿™æ · A èŠ‚ç‚¹å’Œ B èŠ‚ç‚¹å°±å½¢æˆæ­»å¾ªç¯äº†ï¼Œå³ **å¤´æ’æ³• + é“¾è¡¨ + å¤šçº¿ç¨‹å¹¶å‘ + HashMap æ‰©å®¹ ** ï¼Œè¿™å‡ ä¸ªç‚¹åŠ åœ¨ä¸€èµ·å°±å½¢æˆäº† HashMap çš„æ­»å¾ªç¯



ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJDK1.8 ç‰ˆæœ¬çš„ HashMap é‡‡ç”¨äº†å°¾æ’æ³•è€Œä¸æ˜¯å¤´æ’æ³•æ¥é¿å…é“¾è¡¨å€’ç½®ï¼Œä½¿å¾—æ’å…¥çš„èŠ‚ç‚¹æ°¸è¿œéƒ½æ˜¯æ”¾åœ¨é“¾è¡¨çš„æœ«å°¾ï¼Œé¿å…äº†é“¾è¡¨ä¸­çš„ç¯å½¢ç»“æ„ã€‚ä½†æ˜¯è¿˜æ˜¯ä¸å»ºè®®åœ¨å¤šçº¿ç¨‹ä¸‹ä½¿ç”¨ `HashMap`ï¼Œå› ä¸ºå¤šçº¿ç¨‹ä¸‹ä½¿ç”¨ `HashMap` è¿˜æ˜¯ä¼šå­˜åœ¨æ•°æ®è¦†ç›–çš„é—®é¢˜ã€‚å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæ¨èä½¿ç”¨ `ConcurrentHashMap` 





(2)`put`æ“ä½œé€ æˆæ•°æ®ä¸¢å¤±

å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œ put æ“ä½œæ—¶ï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„ç´¢å¼•ä½ç½®æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¼šé€ æˆå‰ä¸€ä¸ª key è¢«åä¸€ä¸ª key è¦†ç›–ï¼Œä»è€Œå¯¼è‡´å…ƒç´ çš„ä¸¢å¤±ã€‚

åœ¨ `HashMap` ä¸­ï¼Œå¤šä¸ªé”®å€¼å¯¹å¯èƒ½ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ¡¶ï¼ˆ`bucket`ï¼‰ï¼Œå¹¶ä»¥é“¾è¡¨æˆ–çº¢é»‘æ ‘çš„å½¢å¼å­˜å‚¨ã€‚å¤šä¸ªçº¿ç¨‹å¯¹ `HashMap` çš„ `put` æ“ä½œä¼šå¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ï¼Œå…·ä½“æ¥è¯´ä¼šæœ‰æ•°æ®è¦†ç›–çš„é£é™©ï¼š

1. çº¿ç¨‹ 1,2 åŒæ—¶è¿›è¡Œ `put` æ“ä½œ
2. ä¸åŒçš„çº¿ç¨‹å¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´ç‰‡è·å¾— `CPU` æ‰§è¡Œçš„æœºä¼šï¼Œå½“å‰çº¿ç¨‹ 1 æ‰§è¡Œå®Œå“ˆå¸Œå†²çªåˆ¤æ–­å(å‘ç°æ²¡æœ‰å†²çªï¼)ï¼Œç”±äºæ—¶é—´ç‰‡è€—å°½æŒ‚èµ·ã€‚çº¿ç¨‹ 2å¼€å§‹æ‰§è¡Œåˆ¤æ–­å†²çª(**ä¹Ÿå‘ç°æ²¡æœ‰å†²çªï¼Œå› ä¸ºçº¿ç¨‹1éƒ½æ²¡æœ‰å®Œæˆæ’å…¥æ“ä½œå‘¢**) ï¼Œå‘ç°æ— å†²çªåå…ˆå®Œæˆäº†æ’å…¥å…ƒç´ æ“ä½œ
3. éšåï¼Œçº¿ç¨‹ 1 è·å¾—æ—¶é—´ç‰‡ï¼Œç”±äº**ä¹‹å‰å·²ç»è¿›è¡Œè¿‡ hash ç¢°æ’çš„åˆ¤æ–­ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šç›´æ¥è¿›è¡Œæ’å…¥**ï¼Œè¿™å°±å¯¼è‡´çº¿ç¨‹ 2 æ’å…¥çš„æ•°æ®è¢«çº¿ç¨‹ 1 è¦†ç›–äº†ï¼ˆ**æ­£å¸¸æƒ…å†µä¸‹ä¼šåˆ¤æ–­å†²çªå¹¶åœ¨é“¾è¡¨ä¸­æ–°æ·»åŠ ä¸€ä¸ªå†²çªèŠ‚ç‚¹çš„**ï¼‰









#### éå†æ–¹å¼



å…ˆå®šä¹‰å¥½ä¸€ä¸ªHashMapé›†åˆå¹¶é‡‡ç”¨å¤šç§æ–¹å¼å¯¹å…¶è¿›è¡Œéå†ï¼š

```java
//åˆ›å»ºå¹¶èµ‹å€¼ HashMap
        Map<Integer, String> map = new HashMap();
        map.put(1, "Java");
        map.put(2, "JDK");
        map.put(3, "Spring Framework");
        map.put(4, "MyBatis framework");
        map.put(5, "Javaä¸­æ–‡ç¤¾ç¾¤");
```

ï¼ˆ1ï¼‰è¿­ä»£å™¨**`EntrySet`**ï¼š

```java
//è·å–åˆ°é’ˆå¯¹é”®å€¼å¯¹Entryçš„Iterator
Iterator<Map.Entry<Integer, String>> iterator = map.entrySet().iterator();
    while (iterator.hasNext()) {
        Map.Entry<Integer, String> entry = iterator.next();
        System.out.println(entry.getKey());
        System.out.println(entry.getValue());
    }
```

ï¼ˆ2ï¼‰è¿­ä»£å™¨`KeySet`ï¼š

```java
//è·å–åˆ°é’ˆå¯¹Entryä¸­Keyçš„Iterator
Iterator<Integer> iterator = map.keySet().iterator();
        while (iterator.hasNext()) {
            Integer key = iterator.next();
            System.out.println(key);
            System.out.println(map.get(key));
        }
```

ï¼ˆ3ï¼‰ForEach EntrySetï¼š

```java
 for (Map.Entry<Integer, String> entry : map.entrySet()) {
            System.out.println(entry.getKey());
            System.out.println(entry.getValue());
        }
```

ï¼ˆ4ï¼‰ForEach KeySetï¼š

```java
 for (Integer key : map.keySet()) {
            System.out.println(key);
            System.out.println(map.get(key));
        }
```

ï¼ˆ5ï¼‰Lambdaè¡¨è¾¾å¼ï¼š

```java
 map.forEach((key, value) -> {
            System.out.println(key);
            System.out.println(value);
        });
```

ï¼ˆ6ï¼‰Streams API ï¼š

å•çº¿ç¨‹

```java
 map.entrySet().stream().forEach((entry) -> {
            System.out.println(entry.getKey());
            System.out.println(entry.getValue());
        });
```

å¤šçº¿ç¨‹

```java
map.entrySet().parallelStream().forEach((entry) -> {
            System.out.println(entry.getKey());
            System.out.println(entry.getValue());
        });
```







### ConcurrentHashMap:face_with_head_bandage:



Java7 ä¸­ `ConcurrentHashMap` ä½¿ç”¨çš„åˆ†æ®µé”(**æ¯ä¸ªæ®µå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª `ReentrantLock` é”**)ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ª Segment ä¸ŠåŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ“ä½œï¼Œ**æ¯ä¸€ä¸ª `Segment` éƒ½æ˜¯ä¸€ä¸ªç±»ä¼¼ `HashMap` æ•°ç»„çš„ç»“æ„**ï¼Œå®ƒå¯ä»¥æ‰©å®¹ï¼Œå®ƒçš„å†²çªä¼šè½¬åŒ–ä¸ºé“¾è¡¨ã€‚ä½†æ˜¯ `Segment` çš„ä¸ªæ•°ä¸€ä½†åˆå§‹åŒ–å°±ä¸èƒ½æ”¹å˜ã€‚

Java8 ä¸­çš„ `ConcurrentHashMap` ä½¿ç”¨çš„ `Synchronized` é”åŠ  `CAS` çš„æœºåˆ¶ã€‚ç»“æ„ä¹Ÿç”± Java7 ä¸­çš„ **`Segment` æ•°ç»„ + `HashEntry` æ•°ç»„ + é“¾è¡¨** è¿›åŒ–æˆäº† **Node æ•°ç»„ + é“¾è¡¨ / çº¢é»‘æ ‘**ï¼ŒNode æ˜¯ç±»ä¼¼äºä¸€ä¸ª `HashEntry` çš„ç»“æ„ã€‚å®ƒçš„å†²çªå†è¾¾åˆ°ä¸€å®šå¤§å°æ—¶ä¼šè½¬åŒ–æˆçº¢é»‘æ ‘ï¼Œåœ¨å†²çªå°äºä¸€å®šæ•°é‡æ—¶åˆé€€å›é“¾è¡¨



`jdk1.8`ä¹‹å‰`ConcurrentHashMap`çš„åº•å±‚ç»“æ„å¦‚ä¸‹ï¼š![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-thread-x-concurrent-hashmap-1.png)

`ConcurrentHashMap` æ˜¯ç”± `Segment` æ•°ç»„ç»“æ„ï¼ˆ`Segment` çš„ä¸ªæ•°ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½æ”¹å˜ï¼Œå¤§å°é»˜è®¤æ˜¯ 16ï¼Œä¹Ÿå°±æ˜¯è¯´é»˜è®¤å¯ä»¥åŒæ—¶æ”¯æŒ**16**ä¸ªçº¿ç¨‹å¹¶å‘å†™ï¼‰å’Œ `HashEntry` æ•°ç»„ç»“æ„ç»„æˆ

å…¶ä¸­`Segment` (å°†æ•°æ®åˆ†ä¸ºä¸€æ®µä¸€æ®µ,è¿™ä¸ªâ€œæ®µâ€å°±æ˜¯ `Segment`çš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®æ—¶ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®) ç»§æ‰¿äº† `ReentrantLock`,æ‰€ä»¥ `Segment` ä¹Ÿæ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œè€Œ`HashEntry` æ•°ç»„åˆ™ç”¨äºå­˜å‚¨é”®å€¼å¯¹æ•°æ®



**`jdk1.8`åä½¿ç”¨äº†Nodeæ•°ç»„æ¥å­˜å‚¨æ•°æ®**ï¼š

```java
transient volatile Node<K,V>[] table;
```

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-thread-x-concurrent-hashmap-2.png)

Java8å`ConcurrentHashMap` å–æ¶ˆäº† `Segment` åˆ†æ®µé”ï¼Œé‡‡ç”¨ `Nodeæ•°ç»„ + CAS + synchronized` æ¥ä¿è¯å¹¶å‘å®‰å…¨ã€‚æ•°æ®ç»“æ„è·Ÿ `HashMap` åœ¨`jdk1.8` çš„å®ç°ç»“æ„ç±»ä¼¼ï¼Œæ•°ç»„+é“¾è¡¨/çº¢é»‘äºŒå‰æ ‘ã€‚Java 8 åœ¨é“¾è¡¨é•¿åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼ˆ8ï¼‰æ—¶å°†é“¾è¡¨ï¼ˆå¯»å€æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼‰è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œåœ¨1.8åï¼Œ`ConcurrentHashMap`é”çš„ç²’åº¦æ›´ç»†ï¼Œ`synchronized` åªé”å®šå½“å‰é“¾è¡¨æˆ–çº¢é»‘äºŒå‰æ ‘çš„é¦–èŠ‚ç‚¹ï¼Œè¿™æ ·åªè¦ hash ä¸å†²çªï¼Œå°±ä¸ä¼šäº§ç”Ÿå¹¶å‘ï¼Œå°±ä¸ä¼šå½±å“å…¶ä»– `Node` çš„è¯»å†™





#### åˆå§‹åŒ–



ç”±äº`ConcurrentHashMap`çš„åº•å±‚å®ç°åœ¨`java8`å‰ååŒºåˆ«æ¯”è¾ƒå¤§ï¼Œæ•…éœ€è¦åˆ†åˆ«è¿›è¡Œåˆ†æï¼Œé¦–å…ˆæ˜¯

**JAVA8ä¹‹å‰**:

é€šè¿‡`ConcurrentHashMap`çš„æ„é€ æ–¹æ³•æ¥è¿›è¡Œæ•°ç»„åˆå§‹åŒ–ï¼š

```java
  private static final int DEFAULT_CAPACITY = 16; //åˆå§‹é»˜è®¤å®¹é‡ åŒhashmap
  private static final float LOAD_FACTOR = 0.75f; //é»˜è®¤è´Ÿè½½å› å­ åŒhashmap
  static final int DEFAULT_CONCURRENCY_LEVEL = 16;//é»˜è®¤å¹¶å‘çº§åˆ« å¯¹åº”å¤šå°‘ä¸ªæ¡¶
   //æ— å‚æ„é€ 
  public ConcurrentHashMap() {
        this(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR, DEFAULT_CONCURRENCY_LEVEL);
    }
  

@SuppressWarnings("unchecked")
public ConcurrentHashMap(int initialCapacity,float loadFactor, int concurrencyLevel) {
    // å‚æ•°æ ¡éªŒ
    if (!(loadFactor > 0) || initialCapacity < 0 || concurrencyLevel <= 0)
        throw new IllegalArgumentException();
    // æ ¡éªŒå¹¶å‘çº§åˆ«å¤§å°ï¼Œå¤§äº 1<<16ï¼Œé‡ç½®ä¸º 65536
    if (concurrencyLevel > MAX_SEGMENTS)
        concurrencyLevel = MAX_SEGMENTS;
    // Find power-of-two sizes best matching arguments
    // 2çš„å¤šå°‘æ¬¡æ–¹
    int sshift = 0;
    int ssize = 1;
    
    while (ssize < concurrencyLevel) { // è¿™ä¸ªå¾ªç¯å¯ä»¥æ‰¾åˆ° concurrencyLevel ä¹‹ä¸Šæœ€è¿‘çš„ 2çš„æ¬¡æ–¹å€¼
        ++sshift;
        ssize <<= 1;
    }
    // è®°å½•æ®µåç§»é‡
    this.segmentShift = 32 - sshift;
    // è®°å½•æ®µæ©ç 
    this.segmentMask = ssize - 1;
    // è®¾ç½®å®¹é‡
    if (initialCapacity > MAXIMUM_CAPACITY)
        initialCapacity = MAXIMUM_CAPACITY;
    // c = å®¹é‡ / ssize ï¼Œé»˜è®¤ 16 / 16 = 1ï¼Œè¿™é‡Œæ˜¯è®¡ç®—æ¯ä¸ª Segment ä¸­çš„ç±»ä¼¼äº HashMap çš„å®¹é‡
    int c = initialCapacity / ssize;
    if (c * ssize < initialCapacity)
        ++c;
    int cap = MIN_SEGMENT_TABLE_CAPACITY;
    //Segment ä¸­çš„ç±»ä¼¼äº HashMap çš„å®¹é‡è‡³å°‘æ˜¯2æˆ–è€…2çš„å€æ•°
    while (cap < c)
        cap <<= 1;
    // create segments and segments[0]
    // åˆ›å»º Segment æ•°ç»„ï¼Œè®¾ç½® segments[0]
    Segment<K,V> s0 = new Segment<K,V>(loadFactor, (int)(cap * loadFactor),
                         (HashEntry<K,V>[])new HashEntry[cap]);
    Segment<K,V>[] ss = (Segment<K,V>[])new Segment[ssize];
    UNSAFE.putOrderedObject(ss, SBASE, s0); // ordered write of segments[0]
    this.segments = ss;
}

```

å³åœ¨Java7 ä¸­ `ConcurrentHashMap` çš„åˆå§‹åŒ–é€»è¾‘å¦‚ä¸‹ï¼š

1. å¿…è¦å‚æ•°æ ¡éªŒ

2. æ ¡éªŒå¹¶å‘çº§åˆ« `concurrencyLevel` å¤§å°ï¼Œå¦‚æœå¤§äºæœ€å¤§å€¼ï¼Œé‡ç½®ä¸ºæœ€å¤§å€¼ã€‚æ— å‚æ„é€ **é»˜è®¤å€¼æ˜¯ 16.**

3. **å¯»æ‰¾ç»™å®šçš„å¹¶å‘çº§åˆ« `concurrencyLevel` ä¹‹ä¸Šæœ€è¿‘çš„ 2 çš„å¹‚æ¬¡æ–¹å€¼**ï¼Œå°†è¯¥å€¼ä½œä¸ºæ•°ç»„åˆå§‹åŒ–å®¹é‡å¤§å°(ä¾‹å¦‚ç”¨æˆ·è¾“å…¥çš„`concurrencyLevel`ä¸º20ï¼Œåˆ™ä¼šåˆå§‹åŒ–`Segment`æ•°ç»„é•¿åº¦ä¸º32)

   ```java
   Segment<K,V>[] ss = (Segment<K,V>[])new Segment[ssize];
   //ssizeä¸º`concurrencyLevel` ä¹‹ä¸Šæœ€è¿‘çš„ 2 çš„å¹‚æ¬¡æ–¹å€¼
   ```

4. **åˆå§‹åŒ– `segments[0]`**ï¼Œ**é»˜è®¤å¤§å°ä¸º 2**ï¼Œ**è´Ÿè½½å› å­ 0.75**ï¼Œ**æ‰©å®¹é˜€å€¼æ˜¯ 2\*0.75=1.5**ï¼Œæ’å…¥ç¬¬äºŒä¸ªå€¼æ—¶æ‰ä¼šå¯¹è¯¥`segement[0]`å¯¹åº”çš„`HashMap`è¿›è¡Œæ‰©å®¹







**`JAVA8`ä¹‹å**:

**é€šè¿‡`initTable()`æ¥è¿›è¡ŒNodeæ•°ç»„çš„åˆå§‹åŒ–**ï¼Œ åˆå§‹åŒ–ä¸­çš„å¹¶å‘é—®é¢˜æ˜¯é€šè¿‡å¯¹å˜é‡`sizeCtl` è¿›è¡Œä¸€ä¸ª `CAS` æ“ä½œæ¥æ§åˆ¶çš„ï¼š

```java
private transient volatile int sizeCtl;  //è¯¥å±æ€§ç”¨æ¥æ§åˆ¶tableæ•°ç»„çš„å¤§å°ï¼Œ  
/*
è¯¥å±æ€§ç”¨æ¥æ§åˆ¶tableæ•°ç»„çš„å¤§å°ï¼Œæ ¹æ®æ˜¯å¦åˆå§‹åŒ–å’Œæ˜¯å¦æ­£åœ¨æ‰©å®¹æœ‰å‡ ç§æƒ…å†µï¼š
å½“å€¼ä¸ºè´Ÿæ•°æ—¶ï¼š å¦‚æœä¸º-1è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–ï¼Œå¦‚æœä¸º-Nåˆ™è¡¨ç¤ºå½“å‰æ­£æœ‰N-1ä¸ªçº¿ç¨‹è¿›è¡Œæ‰©å®¹æ“ä½œï¼›
å½“å€¼ä¸ºæ­£æ•°æ—¶ï¼š å¦‚æœå½“å‰æ•°ç»„ä¸ºnullçš„è¯è¡¨ç¤ºtableåœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼ŒsizeCtlè¡¨ç¤ºä¸ºéœ€è¦æ–°å»ºæ•°ç»„çš„é•¿åº¦ï¼›
è‹¥å·²ç»åˆå§‹åŒ–äº†ï¼Œè¡¨ç¤ºå½“å‰æ•°æ®å®¹å™¨ï¼ˆtableæ•°ç»„ï¼‰å¯ç”¨å®¹é‡ä¹Ÿå¯ä»¥ç†è§£æˆä¸´ç•Œå€¼ï¼ˆæ’å…¥èŠ‚ç‚¹æ•°è¶…è¿‡äº†è¯¥ä¸´ç•Œå€¼å°±éœ€è¦æ‰©å®¹ï¼‰ï¼Œå…·ä½“æŒ‡ä¸ºæ•°ç»„çš„é•¿åº¦n ä¹˜ä»¥ åŠ è½½å› å­loadFactorï¼›
å½“å€¼ä¸º0æ—¶ï¼Œå³æ•°ç»„é•¿åº¦ä¸ºé»˜è®¤åˆå§‹å€¼ã€‚

*/


//æ ¹æ®è¾“å…¥çš„åˆå§‹å®¹é‡æ¥æ‰¾åˆ°æœ€æ¥è¿‘çš„  //ç»™å®šmapçš„å¤§å°
  public ConcurrentHashMap(int initialCapacity) {
    if (initialCapacity < 0)
        throw new IllegalArgumentException();
    int cap = ((initialCapacity >= (MAXIMUM_CAPACITY >>> 1)) ?   //  >>>1æ— ç¬¦å·å³ç§»
               MAXIMUM_CAPACITY :
               tableSizeFor(initialCapacity + (initialCapacity >>> 1) + 1));
    this.sizeCtl = cap;
}
 


   //æœ‰å‚æ„é€ â€”â€”â€”â€”â€”â€”è‡ªå®šä¹‰å¹¶å‘çº§åˆ« 
   //ç»™å®šmapå¤§å°ï¼ŒåŠ è½½å› å­ä»¥åŠå¹¶å‘åº¦ï¼ˆé¢„è®¡åŒæ—¶æ“ä½œæ•°æ®çš„çº¿ç¨‹ï¼‰
   public ConcurrentHashMap(int initialCapacity,
                             float loadFactor, int concurrencyLevel) {
        if (!(loadFactor > 0.0f) || initialCapacity < 0 || concurrencyLevel <= 0)
            throw new IllegalArgumentException();
        if (initialCapacity < concurrencyLevel)   // Use at least as many bins
            initialCapacity = concurrencyLevel;   //è®¾ç½®çš„æ•°ç»„åˆå§‹å®¹é‡>=è®¾ç½®çš„å¹¶å‘çº§åˆ«ï¼
        long size = (long)(1.0 + (long)initialCapacity / loadFactor);
        int cap = (size >= (long)MAXIMUM_CAPACITY) ?
            MAXIMUM_CAPACITY : tableSizeFor((int)size);//æ‰¾åˆ°æœ€æ¥è¿‘çš„2çš„å¹‚æ¬¡æ–¹æ•°
        this.sizeCtl = cap;
    }



/**
 * Initializes table, using the size recorded in sizeCtl.
 */
private final Node<K,V>[] initTable() {
    Node<K,V>[] tab; int sc;
    while ((tab = table) == null || tab.length == 0) {
        // åˆå§‹åŒ–çš„"åŠŸåŠ³"è¢«å…¶ä»–çº¿ç¨‹"æŠ¢å»"äº†
        /*
        æœ‰å¯èƒ½å­˜åœ¨ä¸€ä¸ªæƒ…å†µæ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶èµ°åˆ°è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¸ºäº†ä¿è¯èƒ½å¤Ÿæ­£ç¡®åˆå§‹åŒ–ï¼Œåœ¨ç¬¬1æ­¥ä¸­         ä¼šå…ˆé€šè¿‡ifè¿›è¡Œåˆ¤æ–­ï¼Œè‹¥å½“å‰å·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆå§‹åŒ–å³sizeCtlå€¼å˜ä¸º-1ï¼Œè¿™ä¸ªæ—¶å€™å…¶         ä»–çº¿ç¨‹åœ¨Ifåˆ¤æ–­ä¸ºtrueä»è€Œè°ƒç”¨Thread.yield()è®©å‡ºCPUæ—¶é—´ç‰‡ã€‚
        */
        if ((sc = sizeCtl) < 0)
            Thread.yield(); // lost initialization race; just spin
        // CAS ä¸€ä¸‹ï¼Œå°† sizeCtl è®¾ç½®ä¸º -1ï¼Œä»£è¡¨æŠ¢åˆ°äº†é”
        else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {
            try {
                if ((tab = table) == null || tab.length == 0) {
                    // DEFAULT_CAPACITY é»˜è®¤åˆå§‹å®¹é‡æ˜¯ 16
                    int n = (sc > 0) ? sc : DEFAULT_CAPACITY;
                    // åˆå§‹åŒ–æ•°ç»„ï¼Œé•¿åº¦ä¸º 16 æˆ–åˆå§‹åŒ–æ—¶æä¾›çš„é•¿åº¦
                    Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];
                    // å°†è¿™ä¸ªæ•°ç»„èµ‹å€¼ç»™ tableï¼Œtable æ˜¯ volatile çš„
                    table = tab = nt;
                    // å¦‚æœ n ä¸º 16 çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œ sc = 12
                    // å…¶å®å°±æ˜¯ 0.75 * n
                    sc = n - (n >>> 2);
                }
            } finally {
                // è®¾ç½® sizeCtl ä¸º scï¼Œæˆ‘ä»¬å°±å½“æ˜¯ 12 å§
                sizeCtl = sc;
            }
            break;
        }
    }
    return tab;
}
```

å¯ä»¥çœ‹åˆ°ï¼š**`sizeCtl`çš„å¤§å°åº”è¯¥å°±ä»£è¡¨äº†`ConcurrentHashMap`çš„å¤§å°ï¼Œå³tableæ•°ç»„é•¿åº¦**ã€‚



`tableSizeFor`åšäº†å“ªäº›äº‹æƒ…äº†ï¼Ÿç›´æ¥çœ‹æºç ï¼š

```java
/**
 * Returns a power of two table size for the given desired capacity.
 * See Hackers Delight, sec 3.2
 */
private static final int tableSizeFor(int c) {
    int n = c - 1;
    n |= n >>> 1;
    n |= n >>> 2;
    n |= n >>> 4;
    n |= n >>> 8;
    n |= n >>> 16;
    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
}
```

è¯¥æ–¹æ³•ä¼šå°†è°ƒç”¨æ„é€ å™¨æ–¹æ³•æ—¶æŒ‡å®šçš„å¤§å°è½¬æ¢æˆä¸€ä¸ª2çš„å¹‚æ¬¡æ–¹æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´`ConcurrentHashMap`çš„å¤§å°ä¸€å®šæ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œæ¯”å¦‚ï¼Œå½“æŒ‡å®šå¤§å°ä¸º18æ—¶ï¼Œä¸ºäº†æ»¡è¶³2çš„å¹‚æ¬¡æ–¹ç‰¹æ€§ï¼Œå®é™…ä¸Š`concurrentHashMapd`çš„å¤§å°ä¸º2çš„5æ¬¡æ–¹ï¼ˆ32ï¼‰

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**è°ƒç”¨æ„é€ å™¨æ–¹æ³•çš„æ—¶å€™å¹¶æœªæ„é€ å‡º`table`æ•°ç»„ï¼ˆå¯ä»¥ç†è§£ä¸º`ConcurrentHashMap`çš„æ•°æ®å®¹å™¨ï¼‰ï¼Œåªæ˜¯ç®—å‡º`table`æ•°ç»„çš„é•¿åº¦ï¼Œå½“ç¬¬ä¸€æ¬¡å‘`ConcurrentHashMap`æ’å…¥æ•°æ®çš„æ—¶å€™æ‰çœŸæ­£çš„å®Œæˆåˆå§‹åŒ–åˆ›å»º`table`æ•°ç»„çš„å·¥ä½œ**





æ³¨æ„ä¸‹åˆ—ä»£ç ï¼š

```java
 if ((sc = sizeCtl) < 0)
            Thread.yield();
```

å…¶ä¸­`yield()`æ–¹æ³•è°ƒç”¨åçº¿ç¨‹åªæ˜¯æš‚æ—¶çš„å°†è°ƒåº¦æƒè®©ç»™åˆ«äººï¼Œä½†ç«‹åˆ»å¯ä»¥å›åˆ°ç«äº‰çº¿ç¨‹é”çš„çŠ¶æ€ï¼Œ

ä»æºç ä¸­å¯ä»¥å‘ç°Java8å`ConcurrentHashMap` çš„åˆå§‹åŒ–æ˜¯é€šè¿‡**è‡ªæ—‹å’Œ CAS **æ“ä½œå®Œæˆçš„ã€‚é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯å˜é‡ `sizeCtl` ï¼Œå®ƒçš„å€¼å†³å®šç€å½“å‰çš„åˆå§‹åŒ–çŠ¶æ€

1. -1 è¯´æ˜æ­£åœ¨åˆå§‹åŒ–
2. -N è¯´æ˜æœ‰ N-1 ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹
3. 0 è¡¨ç¤º table åˆå§‹åŒ–å¤§å°ï¼Œå¦‚æœ table æ²¡æœ‰åˆå§‹åŒ–
4. \>0 è¡¨ç¤º table æ‰©å®¹çš„é˜ˆå€¼ï¼Œå¦‚æœ table å·²ç»åˆå§‹åŒ–



è¿˜æœ‰è¿™è¡Œä»£ç ï¼š

```java
U.compareAndSwapInt(this, SIZECTL, sc, -1)
```

å…¸å‹çš„`CAS`æ“ä½œ





#### Put/Getæ“ä½œ

```java
//java8public V put(K key, V value) {
    return putVal(key, value, false);
}
final V putVal(K key, V value, boolean onlyIfAbsent) {
    if (key == null || value == null) throw new NullPointerException();
    // å¾—åˆ° hash å€¼
    int hash = spread(key.hashCode());
    // ç”¨äºè®°å½•ç›¸åº”é“¾è¡¨çš„é•¿åº¦
    int binCount = 0;
    for (Node<K,V>[] tab = table;;) {
        Node<K,V> f; int n, i, fh;
        // å¦‚æœæ•°ç»„"ç©º"ï¼Œè¿›è¡Œæ•°ç»„åˆå§‹åŒ–
        if (tab == null || (n = tab.length) == 0)
            // åˆå§‹åŒ–æ•°ç»„ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»
            tab = initTable();

        // æ‰¾è¯¥ hash å€¼å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ f
        else if ((f = tabAt(tab, i = (n - 1) & hash)) == null) {
            // å¦‚æœæ•°ç»„è¯¥ä½ç½®ä¸ºç©ºï¼Œ
            //ç”¨ä¸€æ¬¡ CAS æ“ä½œå°†è¿™ä¸ªæ–°å€¼æ”¾å…¥å…¶ä¸­å³å¯ï¼Œè¿™ä¸ª put æ“ä½œå·®ä¸å¤šå°±ç»“æŸäº†ï¼Œå¯ä»¥æ‹‰åˆ°æœ€åé¢äº†
            //å¦‚æœ CAS å¤±è´¥ï¼Œé‚£å°±æ˜¯æœ‰å¹¶å‘æ“ä½œï¼Œè¿›åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯å°±å¥½äº†
            if (casTabAt(tab, i, null,
                         new Node<K,V>(hash, key, value, null)))
                break;                   // no lock when adding to empty bin
        }
        // hash å±…ç„¶å¯ä»¥ç­‰äº MOVEDï¼Œè¿™ä¸ªéœ€è¦åˆ°åé¢æ‰èƒ½çœ‹æ˜ç™½ï¼Œä¸è¿‡ä»åå­—ä¸Šä¹Ÿèƒ½çŒœåˆ°ï¼Œè‚¯å®šæ˜¯å› ä¸ºåœ¨æ‰©å®¹
        else if ((fh = f.hash) == MOVED)
            // å¸®åŠ©æ•°æ®è¿ç§»
            tab = helpTransfer(tab, f);

        else { // åˆ°è¿™é‡Œå°±æ˜¯è¯´ï¼Œf æ˜¯è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹ï¼Œè€Œä¸”ä¸ä¸ºç©º

            V oldVal = null;
            // è·å–æ•°ç»„è¯¥ä½ç½®çš„å¤´èŠ‚ç‚¹çš„ç›‘è§†å™¨monitoré”
            synchronized (f) {
                if (tabAt(tab, i) == f) {
                    if (fh >= 0) { // å¤´èŠ‚ç‚¹çš„ hash å€¼å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨
                        // ç”¨äºç´¯åŠ ï¼Œè®°å½•é“¾è¡¨çš„é•¿åº¦
                        binCount = 1;
                        // éå†é“¾è¡¨
                        for (Node<K,V> e = f;; ++binCount) {
                            K ek;
                            // å¦‚æœå‘ç°äº†"ç›¸ç­‰"çš„ keyï¼Œåˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åä¹Ÿå°±å¯ä»¥ break äº†
                            if (e.hash == hash &&
                                ((ek = e.key) == key ||
                                 (ek != null && key.equals(ek)))) {
                                oldVal = e.val;
                                if (!onlyIfAbsent)
                                    e.val = value;
                                break;
                            }
                            // åˆ°äº†é“¾è¡¨çš„æœ€æœ«ç«¯ï¼Œå°†è¿™ä¸ªæ–°å€¼æ”¾åˆ°é“¾è¡¨çš„æœ€åé¢
                            Node<K,V> pred = e;
                            if ((e = e.next) == null) {
                                pred.next = new Node<K,V>(hash, key,
                                                          value, null);
                                break;
                            }
                        }
                    }
                    else if (f instanceof TreeBin) { // çº¢é»‘æ ‘
                        Node<K,V> p;
                        binCount = 2;
                        // è°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•æ’å…¥æ–°èŠ‚ç‚¹
                        if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,
                                                       value)) != null) {
                            oldVal = p.val;
                            if (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }

            if (binCount != 0) {
                // åˆ¤æ–­æ˜¯å¦è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œä¸´ç•Œå€¼å’Œ HashMap ä¸€æ ·ï¼Œä¹Ÿæ˜¯ 8
                if (binCount >= TREEIFY_THRESHOLD)
                    // è¿™ä¸ªæ–¹æ³•å’Œ HashMap ä¸­ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ä¸åŒï¼Œé‚£å°±æ˜¯å®ƒä¸æ˜¯ä¸€å®šä¼šè¿›è¡Œçº¢é»‘æ ‘è½¬æ¢ï¼Œ
                    // å¦‚æœå½“å‰æ•°ç»„çš„é•¿åº¦å°äº 64ï¼Œé‚£ä¹ˆä¼šé€‰æ‹©è¿›è¡Œæ•°ç»„æ‰©å®¹ï¼Œè€Œä¸æ˜¯è½¬æ¢ä¸ºçº¢é»‘æ ‘
                    treeifyBin(tab, i);
                if (oldVal != null)
                    return oldVal;
                break;
            }
        }
    }
    // 
    addCount(1L, binCount);
    return null;
}

```

1. æ ¹æ® key è®¡ç®—å‡º hashcode
2. åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œåˆå§‹åŒ–(`ConcurrentHashMap`è°ƒç”¨é»˜è®¤æ„é€ æ–¹æ³•åå¹¶æ²¡æœ‰åˆå§‹åŒ–æ•°ç»„ï¼Œå’Œ`ArrayList`ä¸€æ ·ç¬¬ä¸€æ¬¡æ’å…¥å…ƒç´ æ—¶æ‰åˆå§‹åŒ–)
3. å³ä¸ºå½“å‰ key å®šä½å‡ºçš„ Nodeï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ä½ç½®å¯ä»¥å†™å…¥æ•°æ®ï¼Œ**åˆ©ç”¨ CAS å°è¯•å†™å…¥**ï¼Œå¤±è´¥åˆ™**è‡ªæ—‹**ä¿è¯æˆåŠŸ
4. å¦‚æœå½“å‰ä½ç½®çš„ `hashcode == MOVED == -1`,åˆ™è¯´æ˜æ­£åœ¨æ‰§è¡Œæ‰©å®¹(é€šè¿‡åˆ¤æ–­è¯¥èŠ‚ç‚¹çš„hashå€¼æ˜¯ä¸æ˜¯ç­‰äº-1ï¼ˆMOVEDï¼‰,ä»£ç ä¸º`(fh = f.hash) == MOVED`)
5. åœ¨table[i]ä¸ä¸ºnullå¹¶ä¸”ä¸ä¸º`forwardingNode`(`f.hash==MOVED` æ ‡å¿—æ‰©å®¹ing)æ—¶ï¼Œå¹¶ä¸”å½“å‰Node fçš„hashå€¼å¤§äº`0ï¼ˆf.hash() >= 0ï¼‰`çš„è¯è¯´æ˜å½“å‰èŠ‚ç‚¹fä¸ºå½“å‰æ¡¶çš„æ‰€æœ‰çš„èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œè¦æƒ³å‘`ConcurrentHashMap`æ’å…¥æ–°å€¼çš„è¯å°±æ˜¯å‘è¿™ä¸ªé“¾è¡¨æ’å…¥æ–°å€¼ã€‚é€šè¿‡`synchronized(f)` çš„æ–¹å¼è¿›è¡ŒåŠ é”ä»¥å®ç°çº¿ç¨‹å®‰å…¨æ€§ï¼Œ**å¯ä»¥çœ‹å‡ºæ¥æ¯æ¬¡åŠ é”é”çš„æ˜¯é“¾è¡¨å¤´èŠ‚ç‚¹**
6. **å¦‚æœæ•°é‡å¤§äº `TREEIFY_THRESHOLD` åˆ™è¦æ‰§è¡Œæ ‘åŒ–æ–¹æ³•ï¼Œåœ¨ `treeifyBin` ä¸­ä¼šé¦–å…ˆåˆ¤æ–­å½“å‰æ•°ç»„é•¿åº¦ï¼Œ â‰¥64æ—¶æ‰ä¼šå°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘**

æ¯”è¾ƒä¸€ä¸‹`HashMap`ä¸`ConcurrentHashMap`ä¸­æ ‘åŒ–æ–¹æ³•çš„å¼‚åŒï¼š

```java
//ConcurrentHashMap
private final void treeifyBin(Node<K,V>[] tab, int index) {
        Node<K,V> b; int n;
        if (tab != null) {
            if ((n = tab.length) < MIN_TREEIFY_CAPACITY)
                tryPresize(n << 1);   //Nodeæ•°ç»„é•¿åº¦å°äº64æ—¶ä¼˜å…ˆæ‰©å®¹Nodeæ•°ç»„
            else if ((b = tabAt(tab, index)) != null && b.hash >= 0) {
                synchronized (b) {
                    if (tabAt(tab, index) == b) {
                        TreeNode<K,V> hd = null, tl = null;
                        for (Node<K,V> e = b; e != null; e = e.next) {
                            TreeNode<K,V> p =
                                new TreeNode<K,V>(e.hash, e.key, e.val,
                                                  null, null);
                            if ((p.prev = tl) == null)
                                hd = p;
                            else
                                tl.next = p;
                            tl = p;
                        }
                        setTabAt(tab, index, new TreeBin<K,V>(hd));
                    }
                }
            }
        }
    }


// HashMap
 final void treeifyBin(Node<K,V>[] tab, int hash) {
        int n, index; Node<K,V> e;
        if (tab == null || (n = tab.length) < MIN_TREEIFY_CAPACITY)
            resize();
        else if ((e = tab[index = (n - 1) & hash]) != null) {
            TreeNode<K,V> hd = null, tl = null;
            do {
                TreeNode<K,V> p = replacementTreeNode(e, null);
                if (tl == null)
                    hd = p;
                else {
                    p.prev = tl;
                    tl.next = p;
                }
                tl = p;
            } while ((e = e.next) != null);
            if ((tab[index] = hd) != null)
                hd.treeify(tab);
        }
    }
```



æ€»ç»“ï¼š

1. `CAS`å†™å…¥æ˜¯åœ¨å½“å‰Nodeæ•°ç»„ä¸­çš„å¤´èŠ‚ç‚¹ä¸ºnullæ—¶(`table[i]==null` æ²¡æœ‰å“ˆå¸Œå†²çª)ä½¿ç”¨çš„ç­–ç•¥
2. `synchronized`å†™å…¥æ˜¯åœ¨åˆ¤æ–­ä¸€ä¸ªæ¡¶å†…çš„å¤´èŠ‚ç‚¹æ²¡æœ‰æ­£åœ¨æ‰©å®¹,ä¸”å‘ç”Ÿäº†å“ˆå¸Œå†²çªçš„å‰æä¸‹ï¼Œå¯¹é“¾è¡¨å¤´èŠ‚ç‚¹è¿›è¡ŒåŠ é”synchronized(f)ï¼Œç„¶åéå†åˆ°å°¾èŠ‚ç‚¹æ‰§è¡Œæ’å…¥å…ƒç´  









å¯¹äº**Getæ“ä½œ**ï¼š

```java
public V get(Object key) {
    Node<K,V>[] tab; Node<K,V> e, p; int n, eh; K ek;
    // key æ‰€åœ¨çš„ hash ä½ç½®
    int h = spread(key.hashCode());
    if ((tab = table) != null && (n = tab.length) > 0 &&
        (e = tabAt(tab, (n - 1) & h)) != null) {
        // å¦‚æœæŒ‡å®šä½ç½®å…ƒç´ å­˜åœ¨ï¼Œå¤´ç»“ç‚¹hashå€¼ç›¸åŒ
        if ((eh = e.hash) == h) {
            if ((ek = e.key) == key || (ek != null && key.equals(ek)))
                // key hash å€¼ç›¸ç­‰ï¼Œkeyå€¼ç›¸åŒï¼Œç›´æ¥è¿”å›å…ƒç´  value
                return e.val;
        }
        else if (eh < 0)
            // å¤´ç»“ç‚¹hashå€¼å°äº0ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹æˆ–è€…æ˜¯çº¢é»‘æ ‘ï¼ŒfindæŸ¥æ‰¾
            return (p = e.find(h, key)) != null ? p.val : null;
        while ((e = e.next) != null) {
            // æ˜¯é“¾è¡¨ï¼Œéå†æŸ¥æ‰¾
            if (e.hash == h &&
                ((ek = e.key) == key || (ek != null && key.equals(ek))))
                return e.val;
        }
    }
    return null;
}

```

æŸ¥æ‰¾çš„æµç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š
1. è®¡ç®— key çš„ hash å€¼
2. æ ¹æ® hash å€¼æ‰¾åˆ°æ•°ç»„å¯¹åº”ä½ç½®: `(n - 1) & h`
3. æ ¹æ®è¯¥ä½ç½®å¤„ç»“ç‚¹æ€§è´¨è¿›è¡Œç›¸åº”æŸ¥æ‰¾ 

- å¦‚æœè¯¥ä½ç½®ä¸º nullï¼Œé‚£ä¹ˆç›´æ¥è¿”å› null å°±å¯ä»¥äº†
- å¦‚æœè¯¥ä½ç½®å¤„çš„èŠ‚ç‚¹åˆšå¥½å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œè¿”å›è¯¥èŠ‚ç‚¹çš„å€¼å³å¯
- **å¦‚æœè¯¥ä½ç½®èŠ‚ç‚¹çš„ hash å€¼å°äº 0ï¼Œè¯´æ˜æ­£åœ¨æ‰©å®¹ï¼Œæˆ–è€…æ˜¯çº¢é»‘æ ‘ï¼Œç„¶åæ¥ç€è°ƒç”¨`find()`æŸ¥æ‰¾**
- å¦‚æœä»¥ä¸Š 3 æ¡éƒ½ä¸æ»¡è¶³ï¼Œé‚£å°±æ˜¯é“¾è¡¨ï¼Œè¿›è¡Œéå†æ¯”å¯¹å³å¯







#### å®ƒä¸€å®šçº¿ç¨‹å®‰å…¨å—ï¼Ÿ

`ConcurrentHashMap` æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ„å‘³ç€å®ƒå¯ä»¥ä¿è¯å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹å®ƒè¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ JDK1.7 åŠä¹‹å‰ç‰ˆæœ¬çš„ `HashMap` å¤šçº¿ç¨‹æ“ä½œå¯¼è‡´æ­»å¾ªç¯é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€å®ƒå¯ä»¥ä¿è¯æ‰€æœ‰çš„å¤åˆæ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œä¸€å®šä¸è¦ææ··äº†ï¼

å¤åˆæ“ä½œæ˜¯æŒ‡ç”±å¤šä¸ªåŸºæœ¬æ“ä½œ(å¦‚`put`ã€`get`ã€`remove`ã€`containsKey`ç­‰)ç»„æˆçš„æ“ä½œï¼Œä¾‹å¦‚å…ˆåˆ¤æ–­æŸä¸ªé”®æ˜¯å¦å­˜åœ¨`containsKey(key)`ï¼Œç„¶åæ ¹æ®ç»“æœè¿›è¡Œæ’å…¥æˆ–æ›´æ–°`put(key, value)`ã€‚è¿™ç§æ“ä½œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ï¼Œå¯¼è‡´ç»“æœä¸ç¬¦åˆé¢„æœŸã€‚

ä¾‹å¦‚ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ B åŒæ—¶å¯¹ `ConcurrentHashMap` è¿›è¡Œå¤åˆæ“ä½œï¼Œå¦‚ä¸‹ï¼š

```
// çº¿ç¨‹ A
if (!map.containsKey(key)) {
map.put(key, value);
}
// çº¿ç¨‹ B
if (!map.containsKey(key)) {
map.put(key, anotherValue);
}
```

å¦‚æœçº¿ç¨‹ A å’Œ B çš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·ï¼š

1. çº¿ç¨‹ A åˆ¤æ–­ map ä¸­ä¸å­˜åœ¨ key
2. çº¿ç¨‹ B åˆ¤æ–­ map ä¸­ä¸å­˜åœ¨ key
3. çº¿ç¨‹ B å°† (key, anotherValue) æ’å…¥ map
4. çº¿ç¨‹ A å°† (key, value) æ’å…¥ map

é‚£ä¹ˆæœ€ç»ˆçš„ç»“æœæ˜¯ (key, value)ï¼Œè€Œä¸æ˜¯é¢„æœŸçš„ (key, anotherValue)ã€‚è¿™å°±æ˜¯å¤åˆæ“ä½œçš„éåŸå­æ€§å¯¼è‡´çš„é—®é¢˜ã€‚

**é‚£å¦‚ä½•ä¿è¯ `ConcurrentHashMap` å¤åˆæ“ä½œçš„åŸå­æ€§å‘¢ï¼Ÿ**

`ConcurrentHashMap` æä¾›äº†ä¸€äº›åŸå­æ€§çš„å¤åˆæ“ä½œï¼Œå¦‚ `putIfAbsent`ã€`compute`ã€`computeIfAbsent` ã€`computeIfPresent`ã€`merge`ç­‰ã€‚è¿™äº›æ–¹æ³•éƒ½å¯ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæ ¹æ®ç»™å®šçš„ key å’Œ value æ¥è®¡ç®—ä¸€ä¸ªæ–°çš„ valueï¼Œå¹¶ä¸”å°†å…¶æ›´æ–°åˆ° map ä¸­ã€‚

ä¸Šé¢çš„ä»£ç å¯ä»¥æ”¹å†™ä¸ºï¼š

```java
// çº¿ç¨‹ A
map.putIfAbsent(key, value);
// çº¿ç¨‹ B
map.putIfAbsent(key, anotherValue);
```

æˆ–è€…ï¼š

```java
// çº¿ç¨‹ A
map.computeIfAbsent(key, k -> value);
// çº¿ç¨‹ B
map.computeIfAbsent(key, k -> anotherValue);
```

å¾ˆå¤šåŒå­¦å¯èƒ½ä¼šè¯´äº†ï¼Œè¿™ç§æƒ…å†µä¹Ÿèƒ½åŠ é”åŒæ­¥å‘€ï¼ç¡®å®å¯ä»¥ï¼Œä½†ä¸å»ºè®®ä½¿ç”¨åŠ é”çš„åŒæ­¥æœºåˆ¶ï¼Œè¿èƒŒäº†ä½¿ç”¨ `ConcurrentHashMap` çš„åˆè¡·ã€‚åœ¨ä½¿ç”¨ `ConcurrentHashMap` çš„æ—¶å€™ï¼Œå°½é‡ä½¿ç”¨è¿™äº›åŸå­æ€§çš„å¤åˆæ“ä½œæ–¹æ³•æ¥ä¿è¯åŸå­æ€§ã€‚







## BlockingQueue

`BlockingQueue` é€šå¸¸ç”¨äºä¸€ä¸ªçº¿ç¨‹ç”Ÿäº§å¯¹è±¡ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹è¿™äº›å¯¹è±¡çš„åœºæ™¯ã€‚

ä¸€ä¸ªçº¿ç¨‹å°†ä¼šæŒç»­ç”Ÿäº§æ–°å¯¹è±¡å¹¶å°†å…¶æ’å…¥åˆ°é˜Ÿåˆ—ä¹‹ä¸­ï¼Œç›´åˆ°é˜Ÿåˆ—è¾¾åˆ°å®ƒæ‰€èƒ½å®¹çº³çš„ä¸´ç•Œç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯æœ‰é™çš„ã€‚å¦‚æœè¯¥é˜»å¡é˜Ÿåˆ—åˆ°è¾¾äº†å…¶ä¸´ç•Œç‚¹ï¼Œè´Ÿè´£ç”Ÿäº§çš„çº¿ç¨‹å°†ä¼šåœ¨å¾€é‡Œè¾¹æ’å…¥æ–°å¯¹è±¡æ—¶å‘ç”Ÿé˜»å¡ã€‚å®ƒä¼šä¸€ç›´å¤„äºé˜»å¡ä¹‹ä¸­ï¼Œç›´åˆ°è´Ÿè´£æ¶ˆè´¹çš„çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­æ‹¿èµ°ä¸€ä¸ªå¯¹è±¡ã€‚ è´Ÿè´£æ¶ˆè´¹çš„çº¿ç¨‹å°†ä¼šä¸€ç›´ä»è¯¥é˜»å¡é˜Ÿåˆ—ä¸­æ‹¿å‡ºå¯¹è±¡ã€‚å¦‚æœæ¶ˆè´¹çº¿ç¨‹å°è¯•å»ä»ä¸€ä¸ªç©ºçš„é˜Ÿåˆ—ä¸­æå–å¯¹è±¡çš„è¯ï¼Œè¿™ä¸ªæ¶ˆè´¹çº¿ç¨‹å°†ä¼šå¤„äºé˜»å¡ä¹‹ä¸­ï¼Œç›´åˆ°ä¸€ä¸ªç”Ÿäº§çº¿ç¨‹æŠŠä¸€ä¸ªå¯¹è±¡ä¸¢è¿›é˜Ÿåˆ—



ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬é˜»å¡é˜Ÿåˆ—å°±æ˜¯ï¼š**æ˜¯ä¸€ä¸ªæ”¯æŒé˜»å¡å¼çš„æ’å…¥å’Œç§»é™¤çš„FIFOé˜Ÿåˆ—**ï¼š

1. **æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼šå½“é˜Ÿåˆ—æ»¡äº†ï¼Œçº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­çš„å…ƒç´ è¢«å–å‡ºï¼Œç„¶åè¢«å”¤é†’ç»§ç»­å¾€é˜Ÿåˆ—é‡Œé¢æ’å…¥å…ƒç´ **ã€‚
2. **è·å–å…ƒç´ çš„æ—¶å€™ï¼šé˜Ÿåˆ—ä¸ºç©ºï¼Œçº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—æœ‰å…ƒç´ ï¼Œè¢«å”¤é†’**ã€‚

> å¦‚ä½•è¢«å”¤é†’çš„ï¼Ÿ ä¾èµ– `Condition`ç±»ä¸­çš„ `await`()å’Œ`signal()`æ–¹æ³•

`BlockingDeque` å…·æœ‰ 4 ç»„ä¸åŒçš„æ–¹æ³•ç”¨äºæ’å…¥ã€ç§»é™¤ä»¥åŠå¯¹åŒç«¯é˜Ÿåˆ—ä¸­çš„å…ƒç´ è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœè¯·æ±‚çš„æ“ä½œä¸èƒ½å¾—åˆ°ç«‹å³æ‰§è¡Œçš„è¯ï¼Œæ¯ä¸ªæ–¹æ³•çš„è¡¨ç°ä¹Ÿä¸åŒã€‚è¿™äº›æ–¹æ³•å¦‚ä¸‹:

|      | æŠ›å‡ºå¼‚å¸¸       | è¿”å›ç‰¹å®šå€¼    | ä¸€ç›´é˜»å¡     | è¶…æ—¶é€€å‡º                         |
| ---- | -------------- | ------------- | ------------ | -------------------------------- |
| æ’å…¥ | addFirst(o)    | offerFirst(o) | putFirst(o)  | offerFirst(o, timeout, timeunit) |
| ç§»é™¤ | removeFirst(o) | pollFirst(o)  | takeFirst(o) | pollFirst(timeout, timeunit)     |
| æ£€æŸ¥ | getFirst(o)    | peekFirst(o)  |              |                                  |

|      | æŠ›å‡ºå¼‚å¸¸      | è¿”å›ç‰¹å®šå€¼   | ä¸€ç›´é˜»å¡    | è¶…æ—¶é€€å‡º                        |
| ---- | ------------- | ------------ | ----------- | ------------------------------- |
| æ’å…¥ | addLast(o)    | offerLast(o) | putLast(o)  | offerLast(o, timeout, timeunit) |
| ç§»é™¤ | removeLast(o) | pollLast(o)  | takeLast(o) | pollLast(timeout, timeunit)     |
| æ£€æŸ¥ | getLast(o)    | peekLast(o)  |             |                                 |



- **æŠ›å‡ºå¼‚å¸¸**ï¼šå½“æ’å…¥æˆ–è€…è·å–å…ƒç´ çš„æ—¶å€™ï¼Œæ­¤æ—¶é˜Ÿåˆ—å·²ç»æ»¡äº†æˆ–è€…ä¸ºç©ºï¼Œé‚£ä¹ˆé˜»å¡é˜Ÿåˆ—å°±ä¼šæŠ›å‡º**new IllegalStateException("Queue full")**çš„å¼‚å¸¸ä¿¡æ¯
- **è¿”å›ç‰¹æ®Šå€¼**ï¼šå½“æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œæ’å…¥æˆåŠŸå°±è¿”å›trueï¼Œå½“æ’å…¥å¤±è´¥å°±è¿”å›false
- **ä¸€ç›´é˜»å¡**ï¼šå½“æ’å…¥å…ƒç´ æˆ–è€…è·å–å…ƒç´ çš„æ—¶å€™ï¼Œé˜Ÿåˆ—æ»¡äº†æˆ–è€…ä¸ºç©ºï¼Œçº¿ç¨‹å°±ä¼šå¤„äºé˜»å¡
- **è¶…æ—¶é€€å‡º**ï¼šå½“æ’å…¥å…ƒç´ æˆ–è€…è·å–å…ƒç´ çš„æ—¶å€™ï¼Œé˜Ÿåˆ—æ»¡äº†æˆ–è€…é˜Ÿåˆ—ä¸ºç©ºï¼Œçº¿ç¨‹å°±ä¼šæ ¹æ®ä¼ å…¥çš„è¶…æ—¶æ—¶é—´ï¼Œè¿›è¡Œåœ¨è¿™ä¸ªæ—¶é—´å†…è¿›è¡Œç­‰å¾…æ’å…¥æˆ–è€…ç­‰å¾…è·å–ï¼Œç›´åˆ°è¶…æ—¶é€€å‡º





### ArrayBlockingQueue



1ã€æ•°ç»„é˜»å¡é˜Ÿåˆ— `ArrayBlockingQueue`

`ArrayBlockingQueue` æ˜¯ä¸€ä¸ª**æœ‰ç•Œçš„é˜»å¡é˜Ÿåˆ—**ï¼Œå…¶å†…éƒ¨å®ç°æ˜¯å°†å¯¹è±¡æ”¾åˆ°ä¸€ä¸ªæ•°ç»„é‡Œã€‚æœ‰ç•Œä¹Ÿå°±æ„å‘³ç€ï¼Œå®ƒä¸èƒ½å¤Ÿå­˜å‚¨æ— é™å¤šæ•°é‡çš„å…ƒç´ ã€‚å®ƒæœ‰ä¸€ä¸ªåŒä¸€æ—¶é—´èƒ½å¤Ÿå­˜å‚¨å…ƒç´ æ•°é‡çš„ä¸Šé™ã€‚ä½ å¯ä»¥åœ¨å¯¹å…¶åˆå§‹åŒ–çš„æ—¶å€™è®¾å®šè¿™ä¸ªä¸Šé™ï¼Œä½†ä¹‹åå°±æ— æ³•å¯¹è¿™ä¸ªä¸Šé™è¿›è¡Œä¿®æ”¹äº†(è¯‘è€…æ³¨: å› ä¸ºå®ƒæ˜¯åŸºäºæ•°ç»„å®ç°çš„ï¼Œä¹Ÿå°±å…·æœ‰æ•°ç»„çš„ç‰¹æ€§: ä¸€æ—¦åˆå§‹åŒ–ï¼Œå¤§å°å°±æ— æ³•ä¿®æ”¹)ã€‚ `ArrayBlockingQueue` å†…éƒ¨ä»¥ FIFO(å…ˆè¿›å…ˆå‡º)çš„é¡ºåºå¯¹å…ƒç´ è¿›è¡Œå­˜å‚¨ã€‚é˜Ÿåˆ—ä¸­çš„å¤´å…ƒç´ åœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸­æ˜¯æ”¾å…¥æ—¶é—´æœ€ä¹…çš„é‚£ä¸ªï¼Œè€Œå°¾å…ƒç´ åˆ™æ˜¯æœ€çŸ­çš„é‚£ä¸ª



å…ˆæ¥çœ‹çœ‹`ArrayBlockingQueue`çš„`add`æ“ä½œï¼Œ`add`æ“ä½œæ˜¯é˜Ÿåˆ—æ»¡çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸ï¼Œæºç å®ç°æŒºç®€å•çš„ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5icNeOGPibXpogj3pmCUicQwXYGhUHxaUKJ5an2Sqe1XwibUShqSWhcibATQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

`ArrayBlockingQueue`çš„addæ“ä½œæ˜¯ç›´æ¥è°ƒç”¨çˆ¶ç±»**`AbstractQueue`**çš„`add`æ“ä½œï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR541gWjSEwiaA4j2yV3ybS4e3Nooul0BLUlFh1f7qiaicojqdbU3ic5gEwOQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

`add`æ“ä½œå°±æ˜¯é€šè¿‡è°ƒç”¨`offer`æ“ä½œè¿”å›çš„ç‰¹æ®Šå€¼è¿›è¡Œåˆ¤æ–­å®ç°ï¼Œæ¥çœ‹çœ‹`offer`çš„å®ç°ï¼š

```java
public boolean offer(E e) {
    checkNotNull(e);
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        if (count == items.length)  //é˜Ÿåˆ—å·²æ»¡ ç›´æ¥è¿”å›false  éé˜»å¡
            return false;
        else { 
            enqueue(e); //å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ 
            return true;
        }
    } finally {
        lock.unlock();
    }
}
```

`offer()`æ–¹æ³•å®ç°ä¸»è¦å¹²äº†ä»¥ä¸‹å››ä»¶äº‹ï¼š

1. `ReentrantLock`åŠ é”ï¼Œé¿å…å¤šçº¿ç¨‹çš„æ—¶å€™æ’å…¥æ“ä½œï¼Œå‡ºç°æ•°æ®çš„æ··ä¹±ã€‚
2. åˆ¤æ–­è‹¥æ˜¯é˜Ÿåˆ—æ»¡äº†å°±ç›´æ¥è¿”å›`false`ï¼Œè¡¨ç¤ºæ’å…¥ä¸æˆåŠŸã€‚
3. æœ€ååˆ™è¿›è¡Œæ’å…¥`enqueue(e)`
4. è§£é”

`enqueue`æ–¹æ³•æ˜¯çœŸæ­£å®ç°æ’å…¥å…ƒç´ çš„åŠ¨ä½œï¼Œå…·ä½“çš„æºç å®ç°å¦‚ä¸‹ï¼š

```java
private void enqueue(E x) {
   
    final Object[] items = this.items;
    items[putIndex] = x;
    if (++putIndex == items.length)
        putIndex = 0;  //é˜Ÿåˆ—æ»¡äº†ï¼Œé‡æ–°å¤åˆ¶putIndex=0 ,å³ä¸ºè¦†ç›–
    count++;
    //é˜Ÿåˆ—ä¸­å·²ç»å­˜åœ¨å…ƒç´ ï¼Œå”¤é†’è·å–å…ƒç´ çš„çº¿ç¨‹
    notEmpty.signal();  //Conditionå¿…é¡»ä¾èµ–äºå¤–éƒ¨Lock
}
```

ä¸Šé¢æˆ‘ä»¬èŠåˆ°åœ¨**`ArrayBlockingQueue`**çš„æºç å®ç°é‡Œé¢ä½¿ç”¨**Object[] items**æ¥å­˜å‚¨å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æºç å®ç°çš„**this.items**ï¼Œç›´æ¥é€šè¿‡**items[putIndex] = x;**çš„æ–¹å¼å°†å…ƒç´ æ’å…¥é˜Ÿåˆ—é‡Œé¢ã€‚

ç„¶åå†åˆ¤æ–­`putIndex`æ˜¯å¦å·²ç»è¾¾åˆ°é˜Ÿåˆ—çš„é•¿åº¦ï¼Œè‹¥æ˜¯å·²ç»è¾¾åˆ°é˜Ÿåˆ—é•¿åº¦å°±é‡æ–°èµ‹å€¼ä¸º0ã€‚

æœ€åè®°å½• **count++** ä¹Ÿå°±æ˜¯é˜Ÿåˆ—ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å°±æ˜¯**notEmpty.signal()** æ–¹æ³•ï¼Œä¸å®ƒå¯¹åº”å°±æ˜¯ï¼š**notEmpty.await()**



`notEmpty`æ˜¯ä¸€ä¸ª`Condition`ç±»å‹çš„å…ƒç´ ï¼Œå¯¹äº`Condition`è¿™é‡Œåˆ¶ä½œå¤§è‡´çš„ä»‹ç»ï¼Œåé¢çš„åŸåˆ›ä¼šè¯¦ç»†çš„ä»‹ç»ã€‚

```java
/* Condition for waiting takes */
private final Condition notEmpty;

/* Condition for waiting puts */
private final Condition notFull;
```



è¿™ä¸¤ä¸ªçš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š

`notEmpty`å¯ä»¥åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨`notEmpty.await()`ï¼Œé˜»å¡çº¿ç¨‹â€”â€”æ¶ˆè´¹è€…çº¿ç¨‹è¿›å…¥Conditionæ¡ä»¶é˜Ÿåˆ—ï¼š

```java
public E take() throws InterruptedException {
    final ReentrantLock lock = this.lock;
    lock.lockInterruptibly();
    try {
        while (count == 0)
           notEmpty.await();  //é˜Ÿåˆ—ä¸ºç©ºæ—¶æ— æ³•å†å–å…ƒç´ ï¼Œ ä½†æ˜¯çº¿ç¨‹ä¼šé˜»å¡ï¼Œä¸ä¼šç«‹å³é€€å‡º
        return dequeue();
    } finally {
        lock.unlock();
    }
}
```



å½“å‘é˜Ÿåˆ—é‡Œé¢æ·»åŠ äº†å…ƒç´ æ—¶ï¼Œåˆ™ä¼šè°ƒç”¨**`notEmpty.signal()`**ï¼Œé€šçŸ¥å› ä¸ºé˜Ÿåˆ—ä¸ºç©ºè€Œç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5FF0ziaBpxp0ukzTl4eSa4macvI5n3tB3qFia11wc93rRbAYVibQt4aicNw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

è€Œ**notFull**åˆ™æ˜¯åœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œå®ç°çº¿ç¨‹çš„é€šä¿¡ï¼Œå½“å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œå®ç°çº¿ç¨‹ç­‰å¾…ï¼›æˆ–è€…ä»é˜Ÿåˆ—ä¸­è·å–äº†å…ƒç´ ï¼Œåˆ™é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹å¾€å¯ä»¥å‘é˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ ã€‚

æ‰€ä»¥**æ€»çš„ä¸€å¥è¯æ¥æ¦‚æ‹¬`Condition`çš„ä½œç”¨å°±æ˜¯ï¼šå®ç°çº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶çš„é€šä¿¡**ï¼Œå…¶å®ç­‰å¾…é€šçŸ¥æœºåˆ¶æˆ‘ä»¬çŸ¥é“åœ¨Objectæ–¹æ³•é‡Œé¢ä¹Ÿæœ‰å¯¹åº”çš„`wait/notify`æ–¹æ³•å®ç°







æˆ‘ä»¬æ¥çœ‹çœ‹Conditionåˆæ˜¯æ€ä¹ˆå®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶çš„å‘¢ï¼Ÿåˆ†åˆ«æ¥çœ‹çœ‹await/signalçš„æºç å®ç°ï¼Œsignalè·Ÿè¸ªåˆ°åº•å±‚æºç çš„å®ç°ï¼Œæœ€ç»ˆå®ç°çš„é‡è¦æ–¹æ³•æ˜¯ï¼š

**`LockSupport.unpark(node.thread)`**ï¼š
![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5yBiaMdnTFkb2icaU5RcxgUD8wjHsVq7ZLjicaXBbiaS5sa3LfMG0IrULYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**LockSupport.unpark(node.thread)** è¿™ä¸ªå°±æ˜¯çœŸæ­£çš„å®ç°å”¤é†’çº¿ç¨‹çš„æ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„awaitçš„æ–¹æ³•ï¼Œè‚¯å®šæ˜¯å°±æ˜¯ï¼š**LockSupport.park()** æ–¹æ³•ã€‚å†å¾€ä¸‹é¢ç ”ç©¶å°±æ˜¯nativeæ–¹æ³•äº†ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR58grLHELCdChvUgXoL4WGbPicwibAnvt7TuTNaFXqGkCzcce1g7a1mtag/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**æ‰€ä»¥Conditionæ˜¯é€šè¿‡LockSupport.parkä¸LockSupport.unparkå®ç°çº¿ç¨‹çš„ç­‰å¾…é€šçŸ¥æœºåˆ¶ã€‚**

ç ”ç©¶è¿‡AQSçš„æºç çš„äººä¼šçŸ¥é“ï¼Œ**åœ¨AQSé‡Œé¢ä¹Ÿä¼šæœ‰Condition**ï¼Œå› ä¸ºAQSä¹Ÿæœ‰ç‹¬å å¼é”ï¼Œé˜»å¡å¼çš„è·å–é”èµ„æºã€‚

æ‰€ä»¥ï¼Œåˆ°è¿™é‡Œå¤§å®¶åº”è¯¥çŸ¥é“Conditionçš„ä½œç”¨äº†å§ï¼Œå°±æ˜¯å®ç°çº¿ç¨‹çš„ç­‰å¾…ä¸é€šçŸ¥ï¼Œå¯ä»¥ç”¨æ¥å®ç°é˜»å¡å¼çš„èµ„æºè·å–ã€‚



æˆ‘ä»¬æ¥çœ‹çœ‹`put`æ–¹æ³•ï¼Œé˜»å¡å¼çš„(**`add()`æ–¹æ³•æ˜¯éé˜»å¡å¼ï¼ï¼å³å‘ç°é˜Ÿåˆ—æ»¡åä¼šç›´æ¥`return false`é€€å‡º**)ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR57a0hdErKrK05gNlMQSWLyC0pLFDgaPwrKPy1mKvKXQibkh3e6cSwEjQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

ä»å®ƒçš„æºç é‡Œé¢å°±èƒ½å¤Ÿæ˜¾è€Œæ˜“è§çš„å‘ç°ï¼š**å½“é˜Ÿåˆ—æ»¡çš„æ—¶å€™ï¼Œè°ƒç”¨`notFull.await()`ï¼Œé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°çº¿ç¨‹è¢«ä¸­æ–­ï¼Œæˆ–è€…æœ‰å¦å¤–çš„çº¿ç¨‹å”¤é†’`notFull.signal()`**è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡å¯¹äºç†è§£çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œå®ç°é˜»å¡å¼çš„ç­‰å¾…è¿˜æ˜¯éå¸¸æœ‰å¸®åŠ©çš„

<img src="https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5icufRZ3BTE1Ca17aj9KwCNWxs2xWpyNkF30lgTiboxk4zbKibo92hTic7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="å›¾ç‰‡" style="zoom:67%;" />



æœ€åæ¥çœ‹çœ‹offerå®ç°è¶…æ—¶é€€å‡ºï¼Œå…·ä½“æºç å¦‚ä¸‹ï¼š


![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR59xjnfiaGHnMk2Mqepicia61wwUAiasWPFjLemcNSArL7J1AxJHic2saAwWw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

å…·ä½“çš„å®ç°ï¼Œè¿˜æ˜¯è°ƒç”¨**notFull.awaitNanos(nanos)**ï¼Œè¿›è¡Œè¶…æ—¶ç­‰å¾…ï¼Œè€Œå®ƒçš„åº•å±‚æ˜¯è°ƒç”¨**LockSupport.parkNanos(this, nanosTimeout)**ï¼Œæœ€ç»ˆè¿˜æ˜¯å›åˆ°äº†è¿™ä¸ªLockSupportç±»ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5pibkupXZmdEIauZ8hEnHfMvbMM9QdhHvkgPkXr4l27sPIMGnMLOpiaNg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

åœ¨è¶…æ—¶é€€å‡ºæ–¹æ³•offeré‡Œé¢æœ‰ä¸ªæœ‰æ„æ€çš„å°±æ˜¯è¿™ä¸ª**`lock.lockInterruptibly()`**ï¼Œåœ¨`ReentrantLock`è·å–é”çš„æ–¹æ³•æœ‰å¥½å‡ ä¸ªã€‚

**åˆ†åˆ«æœ‰lockã€tryLockã€lockInterruptiblyç­‰ï¼Œä»–ä»¬çš„åŒºåˆ«å°±æ˜¯lockæ˜¯æ˜¯é˜»å¡çš„ï¼ŒtryLockæ˜¯éé˜»å¡ï¼ˆè¿”å›ç‰¹æ®Šå€¼ï¼‰ã€lockInterruptiblyæ˜¯é˜»å¡å¯ä¸­æ–­çš„**ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5iaP4uYAOmmBaOquyiaNyUHJG6Qibvquqd6nK0lF8RaLqLW04AfDfOXz6g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

åœ¨lockçš„æºç ä¸­ä½œè€…ä¹Ÿæœ‰è§£é‡Šåˆ°ï¼š**å¦‚æœé”ç”±å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹å‡ºäºçº¿ç¨‹è°ƒåº¦ç›®çš„å°†è¢«ç¦ç”¨ï¼Œå¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å¾—é”ä¸ºæ­¢ï¼Œæ­¤æ—¶é”æŒæœ‰è®¡æ•°è®¾ç½®ä¸º1**

æ‰€ä»¥**`lockInterruptibly`**æ–¹æ³•åœ¨è·³å‡ºï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š

1. å¦‚æœè·å–é”æˆåŠŸï¼Œæ–¹æ³•ç»“æŸã€‚

2. å¦‚æœé”æ— æ³•è·å–ï¼Œå½“å‰çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°ä¸‹é¢æƒ…å†µå‘ç”Ÿï¼š

3. 1. å½“å‰çº¿ç¨‹(è¢«å”¤é†’å)æˆåŠŸè·å–é”( å…¶ä»–çº¿ç¨‹è°ƒç”¨`signal()`æ–¹æ³•å”¤é†’å®ƒ)
   2. å½“å‰çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹ä¸­æ–­

åœ¨**`lockInterruptibly`**åº•å±‚æºç è·Ÿè¸ªåä¹Ÿæ˜¯é€šè¿‡**`LockSupport.park(this)`**æ–¹æ³•æ¥å®ç°çº¿ç¨‹çš„é˜»å¡ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/IJUXwBNpKlgaIDeMWhv4aZDFicTZY3RR5qwkWjoOvqmSzt4lhIrBRBrDb6oylWv8emnSXn1nhSrlhefWOs4JvKw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

æ‰€ä»¥å¾ˆå¤šå¹¶å‘çš„å·¥å…·ç±»åº•å±‚å®ç°éƒ½åŸºæœ¬å·®ä¸å¤šï¼ˆConditionã€LockSupportï¼‰ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯é€šç”¨çš„ï¼Œåº”ç”¨å±‚çš„å·¥å…·ç±»éƒ½æ˜¯é€šè¿‡å„ç§å·²æœ‰çš„å·¥å…·ç±»å †å èµ·æ¥çš„



æ€»ç»“ï¼š `ArrayBlockingQueue`å¯¹äºæ’å…¥å…ƒç´ çš„æ–¹æ³•ï¼Œæä¾›äº†ä¸‰ç§ï¼š

> 1. éé˜»å¡å¼ï¼š `add(E e)`â€”â€”>`offer(E e)`â€”â€”>é˜Ÿåˆ—æ»¡å³è¿”å›false
>
> 2. é˜»å¡å¼ï¼š `put(E e)`
>
> ```java
>    final ReentrantLock lock = this.lock;
>    lock.lockInterruptibly();
>    try {
>        while (count == items.length)
>            notFull.await();  //é˜Ÿåˆ—æ»¡æ—¶é˜»å¡å¼ç­‰å¾…ï¼Œç›´åˆ°è¢«ä»åŒæ­¥é˜Ÿåˆ—ä¸­å–å‡º
>        enqueue(e);
>    } finally {
>        lock.unlock();
>    }
> 
> 
> ```
>
> 3. åŠé˜»å¡å¼(è¶…æ—¶é€€å‡º)ï¼š å‘ç°é˜Ÿåˆ—æ»¡ååœ¨`nanos`æ—¶é—´å†…ç­‰å¾…ï¼Œè¶…æ—¶é€€å‡º  
>
>    `offer(E e, long timeout, TimeUnit unit)`
> ```java
> final ReentrantLock lock = this.lock;
>     lock.lockInterruptibly();
>     try {
>         while (count == items.length) {
>             if (nanos <= 0)
>                 return false;
> 
>             //è¿›è¡Œç­‰å¾…nanosçº³ç§’  çŒœæµ‹è¿™é‡Œnanosä¼šè‡ªå‡--
>             nanos = notFull.awaitNanos(nanos);
>         }
>         enqueue(e);
>         return true;
>     } finally {
>         lock.unlock();
>     }
> 



è€Œå¯¹äºç§»é™¤å…ƒç´ çš„æ–¹æ³•ä¹Ÿå’Œæ’å…¥å…ƒç´ ç±»ä¼¼ï¼ŒåŒæ ·æä¾›äº†é˜»å¡å¼ã€éé˜»å¡å¼çš„æ–¹å¼æ¥æ‰§è¡Œ

- take()
- poll()
- ....









### LinkedBlockingQueue

1.`LinkedBlockingQueue`å’Œ`ArrayBlockingQueue`é¦–å…ˆæœ€æ˜æ˜¾çš„åŒºåˆ«å°±æ˜¯å…ƒç´ æ•°é‡ï¼š

- `ArrayBlockingQueue`ï¼šä½¿ç”¨æ™®é€šçš„æ•´æ•°(`int count`)æ¥è¡¨ç¤ºå…ƒç´ æ•°é‡ï¼Œå› ä¸ºå®¹é‡æ˜¯å›ºå®šçš„ï¼Œä¸æ¶‰åŠåŠ¨æ€æ‰©å®¹ã€‚

- `LinkedBlockingQueue`ï¼šä½¿ç”¨`AtomicInteger`æ¥è¡¨ç¤ºå…ƒç´ æ•°é‡ï¼Œä»¥ç¡®ä¿åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯¹å…ƒç´ æ•°é‡çš„å¢å‡æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹å’Œç¼©å®¹

2.å…¶æ¬¡`ArrayBlockingQueue`åœ¨æ’å…¥å…ƒç´ å’Œç§»é™¤å…ƒç´ æ—¶ç”¨åˆ°çš„æ˜¯åŒä¸€æŠŠé”(ç±»å˜é‡: `final ReentrantLock lock`)ï¼Œè€Œ`LinkedBlockingQueue`åˆ™ç”¨åˆ°äº†ä¸¤æŠŠä¸åŒçš„é”(`putLock`ã€`getLock`)ï¼ï¼â€”â€”â€”â€”å¯¹åº”ä¸¤ä¸ªCLHé˜Ÿåˆ—



ç±»çš„ä¸»è¦å±æ€§æœ‰ï¼š

```java
/** Current number of elements */
private final AtomicInteger count = new AtomicInteger();

/**
 * Head of linked list.
 * Invariant: head.item == null
 */
transient Node<E> head;

/**
 * Tail of linked list.
 * Invariant: last.next == null
 */
private transient Node<E> last;

/** Lock held by take, poll, etc */
private final ReentrantLock takeLock = new ReentrantLock();

/** Wait queue for waiting takes */
private final Condition notEmpty = takeLock.newCondition();

/** Lock held by put, offer, etc */
private final ReentrantLock putLock = new ReentrantLock();

/** Wait queue for waiting puts */
private final Condition notFull = putLock.newCondition();

```

å¯ä»¥çœ‹å‡ºä¸`ArrayBlockingQueue`ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼Œ`LinkedBlockingQueue`åœ¨æ’å…¥æ•°æ®å’Œåˆ é™¤æ•°æ®æ—¶åˆ†åˆ«æ˜¯ç”±ä¸¤ä¸ªä¸åŒçš„lockï¼ˆ`takeLock`å’Œ`putLock`ï¼‰æ¥æ§åˆ¶çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤ï¼Œä¹Ÿç”±è¿™ä¸¤ä¸ªlockç”Ÿæˆäº†ä¸¤ä¸ªå¯¹åº”çš„`condition`ï¼ˆ`notEmpty`å’Œ`notFull`ï¼‰æ¥å®ç°å¯é˜»å¡çš„æ’å…¥å’Œåˆ é™¤æ•°æ®ã€‚å¹¶ä¸”ï¼Œé‡‡ç”¨äº†é“¾è¡¨çš„æ•°æ®ç»“æ„æ¥å®ç°é˜Ÿåˆ—ï¼ŒNodeç»“ç‚¹çš„å®šä¹‰ä¸ºï¼š

```java
static class Node<E> {
    E item;
    Node<E> next;
    Node(E x) { item = x; }
}
```







ç„¶åæˆ‘ä»¬å†æ¥çœ‹çœ‹`LinkedBlockingQueue`ï¼š

1ã€å®¹é‡`Capacity`è®¾ç½®

`LinkedBlockingQueue`çš„æ„é€ å‡½æ•°å¯ä»¥é€‰æ‹©æ˜¯å¦æŒ‡å®šå®¹é‡ï¼Œå¦‚æœ**ä¸æŒ‡å®šå®¹é‡ï¼Œåˆ™é˜Ÿåˆ—é»˜è®¤ä¸ºæ— ç•Œé˜Ÿåˆ—**ï¼Œå¦åˆ™ä¸ºæœ‰ç•Œé˜Ÿåˆ—ã€‚åœ¨æ— ç•Œé˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—å¯ä»¥æ— é™å¢é•¿ï¼Œè€Œ**æœ‰ç•Œé˜Ÿåˆ—çš„å®¹é‡æ˜¯å›ºå®šçš„**

```java
/**
 * Creates a {@code LinkedBlockingQueue} with a capacity of
 * {@link Integer#MAX_VALUE}.
 */
public LinkedBlockingQueue() {
    this(Integer.MAX_VALUE);
}

/**
 * Creates a {@code LinkedBlockingQueue} with the given (fixed) capacity.
 *
 * @param capacity the capacity of this queue
 * @throws IllegalArgumentException if {@code capacity} is not greater
 *         than zero
 */
public LinkedBlockingQueue(int capacity) {
    if (capacity <= 0) throw new IllegalArgumentException();
    this.capacity = capacity;
    last = head = new Node<E>(null);
}
```





2ã€æ’å…¥å…ƒç´ ï¼š

`put()`ï¼šé˜»å¡å¼æ’å…¥å…ƒç´  

```java
public void put(E e) throws InterruptedException {
    if (e == null) throw new NullPointerException();
    // Note: convention in all put/take/etc is to preset local var
    // holding count negative to indicate failure unless set.
    int c = -1;
    Node<E> node = new Node<E>(e);
    final ReentrantLock putLock = this.putLock;
    final AtomicInteger count = this.count;
    putLock.lockInterruptibly();
    try {
        /*
         * Note that count is used in wait guard even though it is
         * not protected by lock. This works because count can
         * only decrease at this point (all other puts are shut
         * out by lock), and we (or some other waiting put) are
         * signalled if it ever changes from capacity. Similarly
         * for all other uses of count in other wait guards.
         */
		//å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå°†å…¶ç§»å…¥ç­‰å¾…é˜Ÿåˆ—
        while (count.get() == capacity) {
            notFull.await();
        }
		//å…¥é˜Ÿæ“ä½œï¼Œæ’å…¥æ•°æ®
        enqueue(node);
        c = count.getAndIncrement();
		//è‹¥é˜Ÿåˆ—æ»¡è¶³æ’å…¥æ•°æ®çš„æ¡ä»¶ï¼Œåˆ™é€šçŸ¥è¢«é˜»å¡çš„ç”Ÿäº§è€…çº¿ç¨‹å¯ä»¥ç»§ç»­æ’å…¥
        if (c + 1 < capacity)
            notFull.signal();
    } finally {
        putLock.unlock();
    }
    if (c == 0) 
        signalNotEmpty(); //åœ¨æ·»åŠ å…ƒç´ åï¼Œå¦‚æœé˜Ÿåˆ—ä¹‹å‰ä¸ºç©ºï¼Œåˆ™å”¤é†’ä¸€ä¸ªç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œè®©å…¶å¯ä»¥ç»§ç»­æ‰§è¡Œå–å‡ºæ“ä½œ
}

```





`offer()`ï¼šåŠé˜»å¡å¼æ’å…¥å…ƒç´ ï¼Œè¶…æ—¶é€€å‡º

```java
public boolean offer(E e, long timeout, TimeUnit unit)
        throws InterruptedException {

        if (e == null) throw new NullPointerException();
        long nanos = unit.toNanos(timeout);
        int c = -1;
        final ReentrantLock putLock = this.putLock;
        final AtomicInteger count = this.count;
        putLock.lockInterruptibly();
        try {
            while (count.get() == capacity) {
                if (nanos <= 0)
                    return false;
                nanos = notFull.awaitNanos(nanos);
            }
            enqueue(new Node<E>(e));
            c = count.getAndIncrement();
            if (c + 1 < capacity)
                notFull.signal(); //é€šçŸ¥ç”Ÿäº§è€…çº¿ç¨‹ç»§ç»­æ’å…¥å…ƒç´ 
        } finally {
            putLock.unlock();
        }
        if (c == 0)
            signalNotEmpty();//é€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹å¯ä»¥è·å–å…ƒç´ äº†
        return true;
    }
```



3ã€ç§»é™¤å…ƒç´ ï¼š

`take()`ï¼šé˜»å¡å¼å–å…ƒç´ ï¼Œå‘ç°é˜Ÿåˆ—ä¸ºç©ºåˆ™è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…

```java
public E take() throws InterruptedException {
    E x;
    int c = -1;
    final AtomicInteger count = this.count;
    final ReentrantLock takeLock = this.takeLock;
    takeLock.lockInterruptibly();
    try {
		//å½“å‰é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå°†å…¶ç§»å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç›´è‡³æ»¡è¶³æ¡ä»¶
        while (count.get() == 0) {
            notEmpty.await();
        }
		//ç§»é™¤é˜Ÿå¤´å…ƒç´ ï¼Œè·å–æ•°æ®
        x = dequeue();
        c = count.getAndDecrement();
        //å¦‚æœå½“å‰æ»¡è¶³ç§»é™¤å…ƒç´ çš„æ¡ä»¶(é˜Ÿåˆ—ä¸­è¿˜æœ‰å‰©ä½™å…ƒç´ )ï¼Œåˆ™é€šçŸ¥è¢«é˜»å¡çš„æ¶ˆè´¹è€…çº¿ç¨‹
		if (c > 1)
            notEmpty.signal();
    } finally {
        takeLock.unlock();
    }
    if (c == capacity)
        //åœ¨å–å‡ºå…ƒç´ åï¼Œåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸å†æ»¡ï¼Œå¦‚æœä¸å†æ»¡ï¼Œ
        //åˆ™å”¤é†’ä¸€ä¸ªç­‰å¾…çš„ç”Ÿäº§è€…çº¿ç¨‹ï¼Œè®©å…¶ç»§ç»­æ‰§è¡Œæ·»åŠ æ“ä½œ
        signalNotFull();
    return x;
}

```



`poll()`:éé˜»å¡å¼å–å…ƒç´ ï¼Œå‘ç°é˜Ÿåˆ—ä¸ºç©ºåˆ™ç›´æ¥é€€å‡ºï¼Œä¸ä¼šç­‰å¾…

```java
public E poll() {
    final AtomicInteger count = this.count;
    if (count.get() == 0)
        return null;
    E x = null;
    int c = -1;
    final ReentrantLock takeLock = this.takeLock;
    takeLock.lock();
    try {
        if (count.get() > 0) {
            x = dequeue();
            c = count.getAndDecrement();
            if (c > 1)
                notEmpty.signal();  //
        }
    } finally {
        takeLock.unlock();
    }
    if (c == capacity)
        signalNotFull();
    return x;
}
```



> ArrayBlockingQueue å’Œ LinkeBlockingQueue æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

`ArrayBlockingQueue` å’Œ `LinkedBlockingQueue` æ˜¯ Java å¹¶å‘åŒ…ä¸­å¸¸ç”¨çš„ä¸¤ç§é˜»å¡é˜Ÿåˆ—å®ç°ï¼Œå®ƒä»¬éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¸è¿‡ï¼Œä¸è¿‡å®ƒä»¬ä¹‹é—´ä¹Ÿå­˜åœ¨ä¸‹é¢è¿™äº›åŒºåˆ«ï¼š

- åº•å±‚å®ç°ï¼š`ArrayBlockingQueue` åŸºäºæ•°ç»„å®ç°ï¼Œè€Œ `LinkedBlockingQueue` åŸºäºé“¾è¡¨å®ç°ã€‚
- æ˜¯å¦æœ‰ç•Œï¼š`ArrayBlockingQueue` æ˜¯æœ‰ç•Œé˜Ÿåˆ—ï¼Œå¿…é¡»åœ¨åˆ›å»ºæ—¶æŒ‡å®šå®¹é‡å¤§å°ã€‚`LinkedBlockingQueue` åˆ›å»ºæ—¶å¯ä»¥ä¸æŒ‡å®šå®¹é‡å¤§å°ï¼Œé»˜è®¤æ˜¯`Integer.MAX_VALUE`ï¼Œä¹Ÿå°±æ˜¯æ— ç•Œçš„ã€‚ä½†ä¹Ÿå¯ä»¥æŒ‡å®šé˜Ÿåˆ—å¤§å°ï¼Œä»è€Œæˆä¸ºæœ‰ç•Œçš„ã€‚
- é”æ˜¯å¦åˆ†ç¦»ï¼š **`ArrayBlockingQueue`ä¸­çš„é”æ˜¯æ²¡æœ‰åˆ†ç¦»çš„ï¼Œå³ç”Ÿäº§å’Œæ¶ˆè´¹ç”¨çš„æ˜¯åŒä¸€ä¸ªé”ï¼›`LinkedBlockingQueue`ä¸­çš„é”æ˜¯åˆ†ç¦»çš„ï¼Œå³ç”Ÿäº§ç”¨çš„æ˜¯`putLock`ï¼Œæ¶ˆè´¹æ˜¯`takeLock`ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹ä¹‹é—´çš„é”äº‰å¤º**ã€‚
- å†…å­˜å ç”¨ï¼š`ArrayBlockingQueue` éœ€è¦æå‰åˆ†é…æ•°ç»„å†…å­˜ï¼Œè€Œ `LinkedBlockingQueue` åˆ™æ˜¯åŠ¨æ€åˆ†é…é“¾è¡¨èŠ‚ç‚¹å†…å­˜ã€‚è¿™æ„å‘³ç€ï¼Œ`ArrayBlockingQueue` åœ¨åˆ›å»ºæ—¶å°±ä¼šå ç”¨ä¸€å®šçš„å†…å­˜ç©ºé—´ï¼Œä¸”å¾€å¾€ç”³è¯·çš„å†…å­˜æ¯”å®é™…æ‰€ç”¨çš„å†…å­˜æ›´å¤§ï¼Œè€Œ`LinkedBlockingQueue` åˆ™æ˜¯æ ¹æ®å…ƒç´ çš„å¢åŠ è€Œé€æ¸å ç”¨å†…å­˜ç©ºé—´



æœ€åå†ä»‹ç»ä¸€ä¸‹çº¿ç¨‹é—´çš„ç­‰å¾…å’Œå”¤é†’å…·ä½“çš„å®ç°ï¼š

- å½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notFull.await()` æ–¹æ³•è®©ç”Ÿäº§è€…è¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…é˜Ÿåˆ—éæ»¡æ—¶æ’å…¥ï¼ˆéæ»¡æ¡ä»¶ï¼‰
- å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notEmpty.await()`æ–¹æ³•è®©æ¶ˆè´¹è€…è¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…é˜Ÿåˆ—éç©ºæ—¶æ¶ˆè´¹ï¼ˆéç©ºæ¡ä»¶ï¼‰
- **å½“æœ‰æ–°çš„å…ƒç´ è¢«æ·»åŠ æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notEmpty.signal()`æ–¹æ³•å”¤é†’æ­£åœ¨ç­‰å¾…æ¶ˆè´¹çš„æ¶ˆè´¹è€…çº¿ç¨‹**
- **å½“é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ è¢«å–å‡ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ä¼šè°ƒç”¨ `notFull.signal()`æ–¹æ³•å”¤é†’æ­£åœ¨ç­‰å¾…æ’å…¥å…ƒç´ çš„ç”Ÿäº§è€…çº¿ç¨‹**











# JUC

å…ˆä»å…¨å±€è§’åº¦çœ‹çœ‹Javaå¹¶å‘ç¼–ç¨‹ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/juc%E5%B9%B6%E5%8F%91.jpg)





> å®ç°çº¿ç¨‹åŒæ­¥çš„æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§(æŒç»­æ›´æ–°)ï¼š
>
> 1. join() ã€ notify()ã€notifyAll()
>
> 2. Synchronized
>
> 3. ReentrantLock
>
> 4. CAS AtomicåŸå­ç±»
>
> 5. ThreadLocal
>
> 6. LockSupportç±» park()ã€unpark()
>
> 7. AQS
>
> 8. Conditionç±» await()ã€signal()ã€signalAll()
>
> 
>
> ä¸å¯å˜(Immutable)çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦å†é‡‡å–ä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ã€‚åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®åœ°æ„å»ºå‡ºæ¥ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œä¸å¯å˜çš„ç±»å‹æœ‰:
>
> - final å…³é”®å­—ä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹
> - String
> - æšä¸¾ç±»å‹
> - Number éƒ¨åˆ†å­ç±»ï¼Œå¦‚ Long å’Œ Double ç­‰æ•°å€¼åŒ…è£…ç±»å‹ï¼Œ`BigInteger` å’Œ `BigDecimal` ç­‰å¤§æ•°æ®ç±»å‹ã€‚ä½†åŒä¸º Number çš„åŸå­ç±» `AtomicInteger` å’Œ `AtomicLong` åˆ™æ˜¯å¯å˜çš„
>
> 









## ä»Javaè§’åº¦ç†è§£è¿›ç¨‹ä¸çº¿ç¨‹

1. åœ¨javaä¸­ï¼Œå½“å¯åŠ¨ `main()` å‡½æ•°æ—¶å…¶å®å°±æ˜¯å¯åŠ¨äº†ä¸€ä¸ª JVM çš„è¿›ç¨‹ï¼Œè€Œ main å‡½æ•°æ‰€åœ¨çš„çº¿ç¨‹å°±æ˜¯è¿™ä¸ªè¿›ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿç§°ä¸»çº¿ç¨‹
2. ä¸€ä¸ªè¿›ç¨‹ä¸‹çš„å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº(java8åçš„å…ƒç©ºé—´)**èµ„æºï¼Œä½†æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨**ã€**è™šæ‹Ÿæœºæ ˆ**å’Œ**æœ¬åœ°æ–¹æ³•æ ˆ **
3. å¤šä¸ªè¿›ç¨‹é—´ä¸èƒ½å…±äº«èµ„æºï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„å †ã€æ ˆã€è™šå­˜ç©ºé—´ï¼ˆé¡µè¡¨ï¼‰ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ä¿¡æ¯ï¼Œè€Œçº¿ç¨‹å¯ä»¥å…±äº«è¿›ç¨‹èµ„æºæ–‡ä»¶ï¼ˆå †å’Œæ–¹æ³•åŒºï¼‰ï¼Œä¸”çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿåº¦å¾ˆå¿«ï¼ˆçº¿ç¨‹çŠ¶æ€çš„åˆ‡æ¢ï¼‰ï¼Œè€Œè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿåº¦è¾ƒæ…¢

> ä¸Šä¸‹æ–‡åˆ‡æ¢æ–¹å¼æœ‰ï¼š
>
> 
>
> è¯¥çº¿ç¨‹ä¸»åŠ¨è®©å‡ºCPUï¼Œä¾‹å¦‚è°ƒç”¨sleep() ä½†æ˜¯`sleep`ä¸é‡Šæ”¾é”ã€wait()
>
> 
>
> å…¶ä»–çº¿ç¨‹è°ƒç”¨`Thread.join()`æ’é˜Ÿ,å¯¼è‡´å½“å‰çº¿ç¨‹è¢«è¿«è®©å‡ºèµ„æº
>
> 
>
> æ“ä½œç³»ç»Ÿä¸ºäº†é˜²æ­¢ä¸€ä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹é•¿æ—¶é—´å ç”¨ CPU å¯¼è‡´å…¶ä»–çº¿ç¨‹æˆ–è€…è¿›ç¨‹é¥¿æ­»ï¼Œæ•…é‡‡ç”¨**æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦**çš„æ–¹å¼ï¼Œè°ƒç”¨äº†é˜»å¡ç±»å‹çš„ç³»ç»Ÿä¸­æ–­
>

4. Javaç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„ï¼Œ**ä¸€ä¸ª Java ç¨‹åºçš„è¿è¡Œæ˜¯ main çº¿ç¨‹å’Œå¤šä¸ªå…¶ä»–çº¿ç¨‹åŒæ—¶è¿è¡Œ**

5. çº¿ç¨‹å…±äº«ä»£ç æ®µã€æ•°æ®æ®µã€ï¼ˆåœ°å€ç©ºé—´ï¼‰æ‰“å¼€çš„æ–‡ä»¶èµ„æºï¼›ä½†æ¯ä¸ªçº¿ç¨‹å„è‡ªéƒ½æœ‰ä¸€å¥—ç‹¬ç«‹çš„å¯„å­˜å™¨å’Œæ ˆï¼Œç¡®ä¿çº¿ç¨‹æ§åˆ¶æµç›¸å¯¹ç‹¬ç«‹ï¼›

6. åŒä¸€è¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå¹¶é€šè¿‡å…±äº«å†…å­˜(`Java Memory Model`)æ¥å®ç°é€šä¿¡

```java
ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
// ä¸éœ€è¦è·å–åŒæ­¥çš„ monitor å’Œ synchronizer ä¿¡æ¯ï¼Œä»…è·å–çº¿ç¨‹å’Œçº¿ç¨‹å †æ ˆä¿¡æ¯
ThreadInfo[] threadInfo
        s = threadMXBean.dumpAllThreads(false, false);
// éå†çº¿ç¨‹ä¿¡æ¯ï¼Œä»…æ‰“å°çº¿ç¨‹ ID å’Œçº¿ç¨‹åç§°ä¿¡æ¯
for (ThreadInfo threadInfo : threadInfos) {
    System.out.println("[" + threadInfo.getThreadId() + "] " + threadInfo.getThreadName());
}

/****************/
[1] main
[2] Reference Handler
[3] Finalizer
[4] Signal Dispatcher
[5] Attach Listener
[13] Common-Cleaner
[14] Monitor Ctrl-Break
[15] Notification Thread
```









## çº¿ç¨‹çŠ¶æ€ä¸ç”Ÿå‘½å‘¨æœŸ



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/640.png)



éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. çº¿ç¨‹è¢«åˆ›å»ºå‡ºæ¥ä½†æ²¡æœ‰è¢«è°ƒç”¨ `start()`æ—¶å¤„äº`NEWæ€` 

2. çº¿ç¨‹è¢«è°ƒç”¨äº† `start()`ç­‰å¾…è¿è¡Œæ—¶è¿›å…¥`RUNNABLEæ€`ï¼Œä½†æ˜¯`JVM`ä¸ä¸¥æ ¼åŒºåˆ†`RUNNINGæ€`å’Œ `READYæ€`

3. `TIMED_WAITING`(è¶…æ—¶ç­‰å¾…)çŠ¶æ€ ç›¸å½“äºåœ¨`WAITINGçŠ¶æ€`çš„åŸºç¡€ä¸Šå¢åŠ äº†**è¶…æ—¶é™åˆ¶**ï¼Œæ¯”å¦‚é€šè¿‡ `sleepï¼ˆlong millisï¼‰`æ–¹æ³•æˆ– `waitï¼ˆlong millisï¼‰`æ–¹æ³•å¯ä»¥å°†çº¿ç¨‹ç½®äº `TIMED_WAITING` çŠ¶æ€ï¼Œå½“è¶…æ—¶æ—¶é—´ç»“æŸåï¼Œçº¿ç¨‹å°†ä¼šè¿”å›åˆ° `RUNNABLE` çŠ¶æ€

4. å½“çº¿ç¨‹å°è¯•è¿›å…¥`synchronized`æ–¹æ³•/å—æˆ–è€…è¢«å…¶ä»–çº¿ç¨‹`notify()`å é‡æ–°è¿›å…¥`synchronized` æ–¹æ³•/å—æ—¶æ²¡æœ‰æŠ¢å åˆ°é”ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å°±ä¼šè¿›å…¥`Blocking`çŠ¶æ€(**é˜»å¡æ€è¡¨ç¤ºçº¿ç¨‹åœ¨ç­‰å¾…è·å–æŸä¸ªé”è€Œè¢«é˜»å¡ï¼Œæˆ–è€…è¯´ç­‰å¾…I/Oæ“ä½œå®Œæˆ**)

5. **`RUNNING` çŠ¶æ€**ï¼š å½“çº¿ç¨‹å¤„äº `RUNNING` çŠ¶æ€æ—¶ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹æ­£åœ¨æ‰§è¡Œå®ƒçš„ä»£ç ï¼Œå ç”¨äº† CPU èµ„æºï¼Œå¹¶åœ¨è¿è¡Œä¸­

   **`READY` çŠ¶æ€**ï¼š å½“çº¿ç¨‹å¤„äº `READY` çŠ¶æ€æ—¶ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»å‡†å¤‡å¥½è¿è¡Œï¼Œä½†å½“å‰å¹¶æœªæ‰§è¡Œ

6. `WAITING` çŠ¶æ€åªè¡¨ç¤ºçº¿ç¨‹æ­£åœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶çš„å‘ç”Ÿï¼Œä¸ä¸€å®šæ¶‰åŠé”çš„é‡Šæ”¾ï¼Œè€Œå¤„äºé˜»å¡æ€çš„çº¿ç¨‹ä¸€å®šæ˜¯æ²¡æœ‰è·å–åˆ°é”çš„





## çº¿ç¨‹åˆ›å»ºæ–¹å¼

- æ— è®ºæ˜¯`Runnable`è¿˜æ˜¯`Callable`ï¼Œå®ƒä»¬å’Œçº¿ç¨‹åˆ›å»ºæ²¡å¤ªå¤§å…³ç³»ï¼Œå®ƒä»¬æ˜¯ä»»åŠ¡ç±»ï¼Œåªæœ‰Threadæ˜¯çº¿ç¨‹ç±»

  å¯ä»¥å°† `Runnable` æˆ– `Callable` ä»»åŠ¡ä½œä¸º `Thread` çš„æ„é€ å‡½æ•°å‚æ•°ï¼Œä»è€Œå°†ä»»åŠ¡å°è£…æˆçº¿ç¨‹ã€‚ä¾‹å¦‚ï¼š`new Thread(myRunnable).start()` æˆ– `new Thread(myCallable).start()`ï¼Œæ¥çœ‹çœ‹æºç å°±çŸ¥é“ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·äº†ï¼š

  ```java
  //ä¼ å…¥Runnableå®ä¾‹
  public Thread(Runnable target) {
          init(null, target, "Thread-" + nextThreadNum(), 0);
      }
  
  
  //Callableåˆ›å»ºçº¿ç¨‹
  <T> Future<T> submit(Callable<T> task);  //ExecutorServiceæ¥å£çš„æ–¹æ³•
  
  
  //æˆ–è€…å°†Callableå°è£…ä¸ºFutureTask ,FutureTaskå®ç°äº†Runnableæ¥å£
  public FutureTask(Callable<V> callable) {
          if (callable == null)
              throw new NullPointerException();
          this.callable = callable;
          this.state = NEW;       // ensure visibility of callable
      }
  
  
  //é€šè¿‡Callableåˆ›å»ºçº¿ç¨‹ï¼Œåº•å±‚å®é™…ä¸Šè¿˜æ˜¯start0()æ–¹æ³•
  
  Callable<Integer> callable = new MyCallable();
  FutureTask<Integer> futureTask = new FutureTask<>(callable);
  
  Thread thread = new Thread(futureTask);
  ```

  

- JDKé‚£ä¹ˆå¤šç±»ï¼Œæœ‰ä¸”ä»…æœ‰`Thread`ç±»èƒ½é€šè¿‡`start0()`æ–¹æ³•å‘æ“ä½œç³»ç»Ÿç”³è¯·çº¿ç¨‹èµ„æºï¼ˆæœ¬åœ°æ–¹æ³•ï¼‰

1ã€**ç»§æ‰¿ Thread ç±»**

é€šè¿‡ç»§æ‰¿ `Thread` ç±»ï¼Œå¹¶é‡å†™å®ƒçš„ `run` æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼š

```java
public static void main(String[] args) {
	// ç¬¬ä¸€ç§
    MyThread myThread = new MyThread();
}

public static class MyThread extends Thread {
    @Override
    public void run() {
        System.out.println("è‡ªå·±å®ç°çš„run-1");
    }
}
```





2ã€**å®ç°Runnableæ¥å£**

é€šè¿‡å®ç° `Runnable`æ¥å£ ï¼Œå¹¶é‡å†™ `run` æ–¹æ³•ï¼Œæœ€åå°†`Runnable`ç±»å¯¹è±¡ä¼ é€’ç»™`Thread`ç±»çš„æ„é€ æ–¹æ³•ï¼Œè°ƒç”¨`start()`**å¼€å¯çº¿ç¨‹**:

```java
public static void main(String[] args) {
	
	MyRunnable runnable2=new MyRunnable();
    MyThread myThread = new MyThread(runnable2);
    myThread.start();
}

public static class MyRunnable implements Runnable {
    @Override
    public void run() {
        System.out.println("è‡ªå·±å®ç°çš„run-2");
    }
}

//é€šè¿‡Threadç±»æ„é€ å‡½æ•°åˆ›å»ºçº¿ç¨‹
public Thread(Runnable target) {
        this(null, target, "Thread-" + nextThreadNum(), 0);
    }
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å®ç°`Runnable`æ¥å£çš„æ–¹å¼åˆ›å»ºçº¿ç¨‹å¯ä»¥æ›´åŠ çµæ´»ï¼Œå› ä¸ºä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œè€ŒJavaä¸­çš„ç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªç±»ã€‚æ­¤å¤–ï¼Œä½¿ç”¨å®ç°`Runnable`æ¥å£çš„æ–¹å¼å¯ä»¥å°†çº¿ç¨‹çš„ä»»åŠ¡é€»è¾‘ä¸çº¿ç¨‹çš„ç®¡ç†é€»è¾‘åˆ†ç¦»å¼€æ¥ï¼Œæ–¹ä¾¿è¿›è¡Œçº¿ç¨‹çš„ç®¡ç†å’Œå¤ç”¨

```java
//ç›´æ¥é€šè¿‡Lambdaè¡¨è¾¾å¼æ¥åˆ›å»ºçº¿ç¨‹æ¯”è¾ƒæ–¹ä¾¿ï¼š

Thread t1=new Thread(
    ()->{
        System.out.println("runnable+lambdaè¡¨è¾¾å¼ æ¥åˆ›å»ºçº¿ç¨‹");
    }
);
```



3ã€**å®ç° Callable æ¥å£ï¼Œå¹¶ç»“åˆ Future å®ç°**

**`Callable`**æ¥å£å¯ä»¥ä½œä¸ºä»»åŠ¡è¢«çº¿ç¨‹æ‰§è¡Œï¼Œå…¶ä¸**`Runnable`**æ¥å£çš„åŒºåˆ«åœ¨äº**`Callable`**ä»»åŠ¡å¯ä»¥æœ‰è¿”å›å€¼(é€šè¿‡`FutureTask`è·å–ä»»åŠ¡æ‰§è¡Œçš„è¿”å›å€¼**)ï¼Œè€Œ**`Runnable`ä»»åŠ¡æ²¡æœ‰è¿”å›å€¼ï¼š

ç”±äº**`Thread`**å¯¹è±¡åªèƒ½æ‰§è¡Œ**`Runnable`**ä»»åŠ¡ï¼Œå› æ­¤æ— æ³•ç›´æ¥è®©**`Thread`**æ‰§è¡Œ**`Callable`**ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥å…ˆå°†**`Callable`**å°è£…æˆ**`FutureTask`**ï¼Œè€Œ**`FutureTask`**æ˜¯å®ç°äº†**`Runnable`**æ¥å£çš„ï¼Œæ‰€ä»¥**`Thread`**å¯¹è±¡å¯ä»¥æ‰§è¡Œ**`FutureTask`**ä»»åŠ¡ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

- é¦–å…ˆå®šä¹‰ä¸€ä¸ª `Callable` çš„å®ç°ç±»ï¼Œå¹¶å®ç° `call` æ–¹æ³•(`call` æ–¹æ³•æ˜¯å¸¦è¿”å›å€¼çš„)
- ç„¶åé€šè¿‡ `FutureTask` çš„æ„é€ æ–¹æ³•ï¼ŒæŠŠè¿™ä¸ª `Callable` å®ç°ç±»ä¼ è¿›å»
- æŠŠ `FutureTask` ä½œä¸º `Thread` ç±»çš„ `target` ï¼Œåˆ›å»º `Thread` çº¿ç¨‹å¯¹è±¡
- é€šè¿‡ `FutureTask` çš„ `get` æ–¹æ³•è·å–çº¿ç¨‹çš„æ‰§è¡Œç»“æœ

```java
public class ThirdThreadIntf implements Callable<Integer> {
    int i = 0;
    @Override
    public Integer call() throws Exception {
        for (; i < 20; i++) {
            try {
                Thread.sleep(new Random().nextInt(100));
                System.out.println(Thread.currentThread().getName() + " å¾ªç¯å˜é‡içš„å€¼ï¼š" + i);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println(Thread.currentThread().getName() + "æ‰§è¡Œå®Œæˆ");
        return i;
    }

    public static void main(String[] args) {
        Callable a = new ThirdThreadIntf();
        Callable b = new ThirdThreadIntf();
        FutureTask<Integer> task1 = new FutureTask<>(a);
        FutureTask<Integer> task3 = new FutureTask<>(b);
        new Thread(task1, "çº¿ç¨‹ä¸€").start();
        new Thread(task3, "çº¿ç¨‹ä¸‰").start();
    }
}
```

æ³¨æ„ä¸Šä¸ªä¾‹å­ä¸­è°ƒç”¨çš„Threadç±»ä¸­æ„é€ å‡½æ•°ä¸ºï¼š

```java
 public Thread(Runnable target, String name) {
        this(null, target, name, 0);
    }
//FutureTaskå®ç°äº†Runnableæ¥å£
```





4ã€**é€šè¿‡çº¿ç¨‹æ± æ¥åˆ›å»ºçº¿ç¨‹**

```java
ExecutorService executorService =Executors.newFixedThreadPool(10);
for(int i=0;i<10;i++)
{
    executorService.execute(new Mythread());
}
executorService.shutdown();
```

åœ¨çº¿ç¨‹æ± ä¸­ï¼Œæˆ‘ä»¬å…¶å®æ˜¯æŠŠåˆ›å»ºå’Œç®¡ç†çº¿ç¨‹çš„ä»»åŠ¡éƒ½äº¤ç»™äº†çº¿ç¨‹æ± ã€‚è€Œåˆ›å»ºçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹å·¥å‚ç±» `DefaultThreadFactory` æ¥åˆ›å»ºçš„ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå·¥å‚ç±»çš„å†…éƒ¨å®ç°ï¼š

```java
public Thread newThread(Runnable r) {
            Thread t = new Thread(group, r,
                                  namePrefix + threadNumber.getAndIncrement(),
                                  0);
            if (t.isDaemon())
                t.setDaemon(false);
            if (t.getPriority() != Thread.NORM_PRIORITY)
                t.setPriority(Thread.NORM_PRIORITY);
            return t;
        }
```

å®ƒä¼šç»™çº¿ç¨‹è®¾ç½®ä¸€äº›é»˜è®¤å€¼ï¼Œå¦‚çº¿ç¨‹åç§°ï¼Œçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œçº¿ç¨‹ç»„ï¼Œæ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ç­‰ã€‚æœ€åè¿˜æ˜¯é€šè¿‡ `new Thread()` çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹çš„







## sleep() wait() park()åŒºåˆ«

1. **`sleep()` æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ `wait()` æ–¹æ³•é‡Šæ”¾å½“å‰çº¿ç¨‹æ‰€å æœ‰çš„å¯¹è±¡é”** ï¼Œæ­»é”çš„ä¾‹å­å°±æ˜¯é€šè¿‡è®©çº¿ç¨‹1è·å–åˆ°èµ„æº1åè°ƒç”¨`sleep()`æ–¹æ³•(ä¸é‡Šæ”¾é”)æ¥è®©çº¿ç¨‹2è·å–åˆ°èµ„æº2ï¼Œè¾¾åˆ°æ­»é”æ¡ä»¶

   å³ï¼š`sleep()`è®©çº¿ç¨‹ä¼‘çœ æŒ‡å®šæ—¶é—´,è¯¥çº¿ç¨‹ä¾ç„¶å¤„äºè¿è¡ŒçŠ¶æ€`Running`ã€‚`wait()`è®©çº¿ç¨‹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ä¾¿å¤„äº`Waiting`/`TIME_WAITING`æ€,é‡Šæ”¾å¯¹è±¡é”

2. `wait()` æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ `notify()`æˆ–è€… `notifyAll()` æ–¹æ³•ã€‚è€Œ`sleep(long millis)`æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ `wait(long timeout)` è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’

3. `sleep()` æ˜¯ `Thread` ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œ`wait()` åˆ™æ˜¯ `Object` ç±»çš„æœ¬åœ°æ–¹æ³•,`park()`æ˜¯`LockSupport`ç±»ä¸­è°ƒç”¨`UnSafe`ç±»ä¸­çš„`park()`å®ç°çš„

   ```java
   Thread.sleep(1000);  // è°ƒç”¨æ—¶éœ€è¦ä½¿ç”¨Threadç±» å½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œä½†æ˜¯ä¸é‡Šæ”¾é”
   
   /*
   wait()æ–¹æ³•é€šå¸¸éœ€è¦ç”±ä¸¤ä¸ªçº¿ç¨‹è¿›è¡Œè°ƒç”¨:
        ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨object.wait(),è¿›å…¥ç­‰å¾…;
        å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨object.notify()æˆ–object.notifyAll(),å”¤é†’æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹
   */
   
   
   ```

   

4. æ¯ä¸ªå¯¹è±¡ï¼ˆ`Object`ï¼‰éƒ½æ‹¥æœ‰**å¯¹è±¡é”**ï¼Œæ—¢ç„¶è¦é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”å¹¶è®©å…¶è¿›å…¥ `WAITING` çŠ¶æ€ï¼Œè‡ªç„¶æ˜¯è¦æ“ä½œå¯¹åº”çš„å¯¹è±¡ï¼ˆ`Object`ï¼‰è€Œéå½“å‰çš„çº¿ç¨‹ï¼ˆ`Thread`ï¼‰ï¼›è€Œ`sleep()` æ˜¯è®©å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡Œï¼Œä¸æ¶‰åŠåˆ°å¯¹è±¡ç±»ï¼Œä¹Ÿä¸éœ€è¦è·å¾—å¯¹è±¡é”

5. `Thread.sleep()`åˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å”¤é†’ï¼Œç„¶åç»§ç»­æ‰§è¡Œ(å¿…é¡»ä¼ å…¥æ—¶é—´å‚æ•°)

   `Object.wait()`ä¸å¸¦æ—¶é—´çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨`Object.notify()`å”¤é†’ï¼›

   `Object.wait()`å¸¦æ—¶é—´çš„ï¼Œå‡å¦‚æ²¡æœ‰è¢«`notify`ï¼Œåˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å”¤é†’ï¼Œè¿™æ—¶åˆåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯ç«‹å³è·å–åˆ°äº†é”ï¼Œçº¿ç¨‹è‡ªç„¶ä¼šç»§ç»­æ‰§è¡Œï¼›äºŒæ˜¯æ²¡æœ‰ç«‹å³è·å–é”ï¼Œçº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…è·å–é”ï¼›

6. `Object.wait()/notify()`æ–¹æ³•éœ€è¦åœ¨`synchronized`å—ä¸­æ‰§è¡Œï¼›`LockSupport.park()`å¯ä»¥åœ¨ä»»æ„åœ°æ–¹æ‰§è¡Œï¼›

7. `park()/unpark()`åº•å±‚çš„åŸç†æ˜¯â€œäºŒå…ƒä¿¡å·é‡â€ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåªæœ‰ä¸€ä¸ªè®¸å¯è¯çš„`Semaphore`ï¼Œåªä¸è¿‡è¿™ä¸ªä¿¡å·é‡åœ¨é‡å¤æ‰§è¡Œ`unpark()`çš„æ—¶å€™ä¹Ÿä¸ä¼šå†å¢åŠ è®¸å¯è¯ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªè®¸å¯è¯

8. å¦‚æœåœ¨`wait()`ä¹‹å‰æ‰§è¡Œäº†`notify()`ï¼š

   è‹¥å½“å‰çš„çº¿ç¨‹ä¸æ˜¯æ­¤å¯¹è±¡é”çš„æ‰€æœ‰è€…ï¼Œå´è°ƒç”¨è¯¥å¯¹è±¡çš„notify()æˆ–wait()æ–¹æ³•æ—¶æŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼›è‹¥å½“å‰çº¿ç¨‹æ˜¯æ­¤å¯¹è±¡é”çš„æ‰€æœ‰è€…ï¼Œwait()å°†ä¸€ç›´é˜»å¡ï¼Œå› ä¸ºåç»­å°†æ²¡æœ‰å…¶å®ƒnotify()å”¤é†’å®ƒ

   å¦‚æœåœ¨park()ä¹‹å‰æ‰§è¡Œäº†unpark()ï¼š

   çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œç›´æ¥è·³è¿‡park()ï¼Œç»§ç»­æ‰§è¡Œåç»­å†…å®¹(ç›¸å½“äºä¸ºè¯¥çº¿ç¨‹å¤šåŠ äº†ä¸€ä¸ªè®¸å¯è¯ï¼Œä¸”æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª)

   








## Synchronized

> å‰è¨€ï¼š
>
> åœ¨javaè™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªå¯¹è±¡å’Œç±»åœ¨é€»è¾‘ä¸Šéƒ½æ˜¯å’Œä¸€ä¸ªç›‘è§†å™¨ç›¸å…³è”çš„ã€‚
>
> 
>
> å¯¹äºå¯¹è±¡æ¥è¯´ï¼Œç›¸å…³è”çš„ç›‘è§†å™¨ä¿æŠ¤å¯¹è±¡çš„å®ä¾‹å˜é‡ã€‚
>
> å¯¹äºç±»æ¥è¯´ï¼Œç›‘è§†å™¨ä¿æŠ¤ç±»çš„ç±»å˜é‡ã€‚
>
> 
>
> ç±»é”å®é™…ä¸Šç”¨å¯¹è±¡é”æ¥å®ç°ã€‚å½“è™šæ‹Ÿæœºè£…è½½ä¸€ä¸ªclassæ–‡ä»¶çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šåˆ›å»ºä¸€ä¸ªjava.lang.Classç±»çš„å®ä¾‹ã€‚å½“é”ä½ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå®é™…ä¸Šé”ä½çš„æ˜¯é‚£ä¸ªç±»çš„Classå¯¹è±¡ã€‚
>
> 
>
> ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡å¯¹åŒä¸€ä¸ªå¯¹è±¡ä¸Šé”ã€‚å¯¹äºæ¯ä¸€ä¸ªå¯¹è±¡ï¼Œjavaè™šæ‹Ÿæœºç»´æŠ¤ä¸€ä¸ªåŠ é”è®¡æ•°å™¨ï¼Œçº¿ç¨‹æ¯è·å¾—ä¸€æ¬¡è¯¥å¯¹è±¡ï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼Œæ¯é‡Šæ”¾ä¸€æ¬¡ï¼Œè®¡æ•°å™¨å°±å‡ 1ï¼Œå½“è®¡æ•°å™¨å€¼ä¸º0æ—¶ï¼Œé”å°±è¢«å®Œå…¨é‡Šæ”¾äº†ã€‚





> æ¯ä¸ªå®ä¾‹éƒ½å¯¹åº”æœ‰è‡ªå·±çš„ä¸€æŠŠé”(this),ä¸åŒå®ä¾‹ä¹‹é—´äº’ä¸å½±å“ï¼›
>
> é”å¯¹è±¡æ˜¯`**.class`ä»¥åŠ`synchronized`ä¿®é¥°çš„æ˜¯`static`æ–¹æ³•çš„æ—¶å€™ï¼Œæ‰€æœ‰å¯¹è±¡å…¬ç”¨åŒä¸€æŠŠé”
>
> `synchronized`ä¿®é¥°çš„æ–¹æ³•ï¼Œæ— è®ºæ–¹æ³•æ­£å¸¸æ‰§è¡Œå®Œæ¯•è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šé‡Šæ”¾é”



`synchronized` å…³é”®å­—æœ€ä¸»è¦æœ‰ä»¥ä¸‹ 3 ç§åº”ç”¨æ–¹å¼ï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»ï¼š

- ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å®ä¾‹çš„é”ï¼›
- ä¿®é¥°é™æ€æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰ç±»å¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰ç±»å¯¹è±¡çš„é”ï¼›
- ä¿®é¥°ä»£ç å—ï¼Œåˆ™éœ€è¦æŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚











### å¯¹è±¡é”

1. æ‰‹åŠ¨æŒ‡å®šé”çš„å¯¹è±¡(å¯ä»¥æ˜¯this,å¯ä»¥æ˜¯è‡ªå®šä¹‰Object)



```java
public class SynchronizedObjectLock implements Runnable {
    static SynchronizedObjectLock instance = new SynchronizedObjectLock();

    @Override
    public void run() {
        // åŒæ­¥ä»£ç å—å½¢å¼â€”â€”é”ä¸ºthisï¼Œt1ã€t2éƒ½æºè‡ªäºinstanceå¯¹è±¡ï¼Œæ•…æ˜¯åŒä¸€æŠŠé”
        synchronized (this) {
            System.out.println("æˆ‘æ˜¯çº¿ç¨‹" + Thread.currentThread().getName());
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(Thread.currentThread().getName() + "ç»“æŸ");
        }
    }

    public static void main(String[] args) {
        Thread t1 = new Thread(instance);  //ä¼ å…¥runnableå®ä¾‹
        Thread t2 = new Thread(instance);
        
        //ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç«äº‰instanceçš„å¯¹è±¡é”
        t1.start();
        t2.start();
    }
}

//è¾“å‡ºç»“æœä¸ºï¼š
æˆ‘æ˜¯çº¿ç¨‹Thread-0
Thread-0ç»“æŸ
æˆ‘æ˜¯çº¿ç¨‹Thread-1
Thread-1ç»“æŸ
```

å¯ä»¥çœ‹å‡ºï¼š

1. ä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨çš„é”æ˜¯ä¸€æ ·çš„(éƒ½åœ¨ç«äº‰`instance`çš„å¯¹è±¡é”),çº¿ç¨‹t2å¿…é¡»è¦ç­‰åˆ°çº¿ç¨‹t1é‡Šæ”¾äº†è¯¥é”åæ‰èƒ½ç»§ç»­æ‰§è¡Œ
2. ä¸€ä¸ªå¯¹è±¡åªæœ‰ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†è¯¥å¯¹è±¡çš„é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å–è¯¥å¯¹è±¡çš„é”ï¼Œæ‰€ä»¥æ— æ³•è®¿é—®è¯¥å¯¹è±¡çš„å…¶ä»– `synchronized` å®ä¾‹æ–¹æ³•ï¼Œä½†æ˜¯å…¶ä»–çº¿ç¨‹è¿˜æ˜¯å¯ä»¥è®¿é—®è¯¥å®ä¾‹å¯¹è±¡çš„å…¶ä»–é `synchronized` æ–¹æ³•ã€‚



ä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹ A éœ€è¦è®¿é—®å®ä¾‹å¯¹è±¡ obj1 çš„ synchronized æ–¹æ³• f1(å½“å‰å¯¹è±¡é”æ˜¯ obj1)ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ B éœ€è¦è®¿é—®å®ä¾‹å¯¹è±¡ obj2 çš„ synchronized æ–¹æ³• f2(å½“å‰å¯¹è±¡é”æ˜¯ obj2)ï¼Œè¿™æ ·æ˜¯å…è®¸çš„ï¼š

```java
public class AccountingSyncBad implements Runnable {
    //å…±äº«èµ„æº(ä¸´ç•Œèµ„æº)
    static int i = 0;
    // synchronized ä¿®é¥°å®ä¾‹æ–¹æ³•
    public synchronized void increase() {
        i ++;
    }
    @Override
    public void run() {
        for(int j=0;j<1000000;j++){
            increase();
        }
    }
    public static void main(String args[]) throws InterruptedException {
        // new ä¸¤ä¸ªAccountingSyncæ–°å®ä¾‹
        Thread t1 = new Thread(new AccountingSyncBad());
        Thread t2 = new Thread(new AccountingSyncBad());
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println("static, i output:" + i);
    }
}
/**
 * è¾“å‡ºç»“æœ:
 * static, i output:1224617
 */
```

ä¸Šè¿°ä»£ç è™½ç„¶æˆ‘ä»¬ä½¿ç”¨ `synchronized` ä¿®é¥°äº† `increase` æ–¹æ³•ï¼Œä½†å´ new äº†ä¸¤ä¸ªä¸åŒçš„å®ä¾‹å¯¹è±¡ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å­˜åœ¨ç€ä¸¤ä¸ªä¸åŒçš„å®ä¾‹å¯¹è±¡é”ï¼Œå› æ­¤ t1 å’Œ t2 éƒ½ä¼šè¿›å…¥å„è‡ªçš„å¯¹è±¡é”ï¼Œä¹Ÿå°±æ˜¯è¯´ t1 å’Œ t2 çº¿ç¨‹ä½¿ç”¨çš„æ˜¯ä¸åŒçš„é”ï¼Œå› æ­¤çº¿ç¨‹å®‰å…¨æ˜¯æ— æ³•ä¿è¯çš„

> æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¯¹è±¡é”ï¼Œä¸åŒçš„å¯¹è±¡ï¼Œä»–ä»¬çš„é”ä¸ä¼šäº’ç›¸å½±å“ã€‚

è§£å†³è¿™ç§å›°å¢ƒçš„çš„æ–¹å¼æ˜¯å°† `synchronized` ä½œç”¨äºé™æ€çš„ `increase` æ–¹æ³•ï¼Œè¿™æ ·çš„è¯ï¼Œå¯¹è±¡é”å°±å½“å‰ç±»å¯¹è±¡(`AccountingSyncBad`ç±»)ï¼Œç”±äºæ— è®ºåˆ›å»ºå¤šå°‘ä¸ªå®ä¾‹å¯¹è±¡ï¼Œä½†å¯¹äºçš„ç±»å¯¹è±¡æ‹¥æœ‰åªæœ‰ä¸€ä¸ªï¼Œæ‰€æœ‰åœ¨è¿™æ ·çš„æƒ…å†µä¸‹å¯¹è±¡é”å°±æ˜¯å”¯ä¸€çš„ã€‚





ä¾‹äºŒ

```java
public class JUC implements Runnable {
    static JUC instance = new JUC();
    // åˆ›å»º2æŠŠé”
    Object block1 = new Object();
    Object block2 = new Object();

    @Override
    public void run() {
        // è¿™ä¸ªä»£ç å—ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€æŠŠé”ï¼Œå½“ä»–é‡Šæ”¾åï¼Œåé¢çš„ä»£ç å—ç”±äºä½¿ç”¨çš„æ˜¯ç¬¬äºŒæŠŠé”ï¼Œå› æ­¤å¯ä»¥é©¬ä¸Šæ‰§è¡Œ
        synchronized (block1) {
            System.out.println("çº¿ç¨‹ " + Thread.currentThread().getName()+" è·å–åˆ°äº†block1çš„å¯¹è±¡é”");
            try {
                Thread.sleep(10000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("çº¿ç¨‹ "+Thread.currentThread().getName() + "é‡Šæ”¾äº†block1å¯¹è±¡é”");
        }

        synchronized (block2) {
            System.out.println("çº¿ç¨‹ " + Thread.currentThread().getName()+" è·å–åˆ°äº†block2çš„å¯¹è±¡é”");
            try {
                Thread.sleep(3000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("çº¿ç¨‹ "+Thread.currentThread().getName() + "é‡Šæ”¾äº†block2å¯¹è±¡é”");
        }
    }

    public static void main(String[] args) {
        Thread t1 = new Thread(instance);
        Thread t2 = new Thread(instance);
        t1.start();
        t2.start();
    }
}

//è¾“å‡ºç»“æœä¸ºï¼š
çº¿ç¨‹ Thread-0 è·å–åˆ°äº†block1çš„å¯¹è±¡é”
çº¿ç¨‹ Thread-0é‡Šæ”¾äº†block1å¯¹è±¡é”
çº¿ç¨‹ Thread-1 è·å–åˆ°äº†block1çš„å¯¹è±¡é”
çº¿ç¨‹ Thread-0 è·å–åˆ°äº†block2çš„å¯¹è±¡é”
çº¿ç¨‹ Thread-0é‡Šæ”¾äº†block2å¯¹è±¡é”
çº¿ç¨‹ Thread-1é‡Šæ”¾äº†block1å¯¹è±¡é”
çº¿ç¨‹ Thread-1 è·å–åˆ°äº†block2çš„å¯¹è±¡é”
çº¿ç¨‹ Thread-1é‡Šæ”¾äº†block2å¯¹è±¡é”
```



é¦–å…ˆçº¿ç¨‹t1è·å–åˆ°`block1`å¯¹è±¡é”ï¼Œç„¶åæ‰§è¡Œ`Thread.sleep(10000);`åœ¨çº¿ç¨‹t1ä¼‘çœ çš„è¿‡ç¨‹ä¸­ï¼ˆ`sleep()`ä¸é‡Šæ”¾é”ï¼‰ï¼Œçº¿ç¨‹t2ä¹Ÿè¢«åˆ›å»ºä¹Ÿè¦å»æŠ¢å `block1`çš„å¯¹è±¡é”ï¼Œæ‰€ä»¥t2é™·å…¥é˜»å¡ã€‚**åœ¨t1ç»“æŸä¼‘çœ å¹¶é‡Šæ”¾`block1`çš„é”åï¼Œt2ç«‹é©¬è·å–åˆ°`block1`çš„å¯¹è±¡é”ï¼ŒåŒæ—¶t1ä¹Ÿç«‹åˆ»è·å–åˆ°`block2`çš„å¯¹è±¡é”**ï¼Œä¸¤ä¸ªçº¿ç¨‹æ­¤æ—¶åœ¨å¹¶è¡Œæ‰§è¡Œï¼Œåé¢t1å†æ¬¡è¿›å…¥ä¼‘çœ æ€ï¼Œå¦‚æœæ­¤æ—¶t2é‡Šæ”¾æ‰`block1`å¯¹è±¡é”å¹¶è¦ç«‹åˆ»è·å–`block2`çš„å¯¹è±¡é”æ—¶åˆ™ä¼šå†æ¬¡è¿›å…¥é˜»å¡æ€ï¼Œæœ€ç»ˆt1é‡Šæ”¾block2å¯¹è±¡é”ï¼Œt2è·å–åˆ°è¯¥é”åæ‰§è¡Œä¹‹åçš„é€»è¾‘



è‡³äºç±»é”è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼š

```java

//é”é™æ€æ–¹æ³•
synchronized static void method() {
    //ä¸šåŠ¡ä»£ç 
}



//é”ç±»çš„å®ä¾‹å¯¹è±¡
public class Task {
 public void method2()
 {
     synchronized (Task.class){
       //ä¸šåŠ¡é€»è¾‘
     }
 }
}
```



### Synchronized ç¦æ­¢æŒ‡ä»¤é‡æ’

```java
class MonitorExample {
    int a = 0;
    public synchronized void writer() {  //1
        a++;                             //2
    }                                    //3
    public synchronized void reader() {  //4
        int i = a;                       //5
        //â€¦â€¦
    }                                    //6
}
```

å‡è®¾çº¿ç¨‹ A æ‰§è¡Œ writer()æ–¹æ³•ï¼Œéšåçº¿ç¨‹ B æ‰§è¡Œ reader()æ–¹æ³•ã€‚æ ¹æ® happens before è§„åˆ™ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…å«çš„ happens before å…³ç³»å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

- æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼Œ1 happens before 2, 2 happens before 3; 4 happens before 5, 5 happens before 6ã€‚
- æ ¹æ®ç›‘è§†å™¨é”è§„åˆ™ï¼Œ3 happens before 4ã€‚
- æ ¹æ® happens before çš„ä¼ é€’æ€§ï¼Œ2 happens before 5ã€‚

åœ¨çº¿ç¨‹ A é‡Šæ”¾äº†é”ä¹‹åï¼Œéšåçº¿ç¨‹ B è·å–åŒä¸€ä¸ªé”ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œ2 happens before 5ã€‚å› æ­¤ï¼Œçº¿ç¨‹ A åœ¨é‡Šæ”¾é”ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨çº¿ç¨‹ B è·å–åŒä¸€ä¸ªé”ä¹‹åï¼Œå°†ç«‹åˆ»å˜å¾—å¯¹ B çº¿ç¨‹å¯è§





### Monitor

ä½¿ç”¨`synchronized{}`ä»£ç å—æˆ–è€…`synchronized()`æ–¹æ³•ç›¸å½“äºæ ‡å¿—äº†ä¸€ä¸ªç›‘è§†åŒºåŸŸ(Monitor)ã€‚å½“æ¯æ¬¡è¿›å…¥ä¸€ä¸ªç›‘è§†åŒºåŸŸæ—¶ï¼Œjava è™šæ‹Ÿæœºéƒ½ä¼šè‡ªåŠ¨é”ä¸Šå¯¹è±¡æˆ–è€…ç±»ï¼Œåœ¨HotSpot JVMå®ç°ä¸­ï¼Œ**é”æœ‰ä¸ªä¸“é—¨çš„åå­—ï¼šå¯¹è±¡ç›‘è§†å™¨ï¼ˆObject Monitorï¼‰**ï¼Œ**Monitorï¼ˆç›‘è§†å™¨é”ï¼‰**æœ¬è´¨æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock`ï¼ˆäº’æ–¥é”ï¼‰æ¥å®ç°çš„ã€‚`Mutex Lock` çš„åˆ‡æ¢éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€ä¸­ï¼Œå› æ­¤çŠ¶æ€è½¬æ¢éœ€è¦è€—è´¹å¾ˆå¤šçš„å¤„ç†å™¨æ—¶é—´ã€‚æ‰€ä»¥åœ¨æ—©æœŸçš„JAVAç‰ˆæœ¬é‡Œ`Synchronized`æ˜¯ä¸€ä¸ªè€—è´¹èµ„æºçš„é‡é‡çº§æ“ä½œ





1ã€ä½œç”¨åœ¨å¯¹è±¡ä¸Š(åŒ…æ‹¬ç±»classå’Œç±»çš„å¯¹è±¡å®ä¾‹)ï¼š

å†æ¥åˆ†æä¸€ä¸‹`Synchronized`çš„åº•å±‚åŸç†ï¼Œä»»ä½•ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª`Monitor`ä¸ä¹‹å…³è”ï¼Œå½“ä¸€ä¸ª`Monitor`è¢«æŒæœ‰åï¼Œå®ƒå°†å¤„äºè¢«é”å®šçŠ¶æ€ï¼Œç»™å®šä»¥ä¸‹ä»£ç ï¼š

```java
public class SynchronizedDemo {
    public void method() {
        synchronized (this) {
            System.out.println("synchronized ä»£ç å—");
        }
    }
}

```

é€šè¿‡javaåç¼–è¯‘å¯ä»¥å¾—å‡ºï¼š`synchronized` **åŒæ­¥è¯­å¥å—**çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®,å½“æ‰§è¡Œè‡³`monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å–**å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒï¼Œ**å³åœ¨æ‰§è¡Œ`monitorenter`æ—¶ï¼Œçº¿ç¨‹ä¼šå°è¯•è·å–å¯¹è±¡çš„é”**ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ï¼Œ**æ‹¥æœ‰è€…è¯¥å¯¹è±¡é”çš„çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡Œ `monitorexit` æŒ‡ä»¤æ¥é‡Šæ”¾é”**ã€‚åœ¨æ‰§è¡Œ `monitorexit` æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”





`monitorenteræŒ‡ä»¤`ï¼šå½“ä¸€ä¸ªçº¿ç¨‹åœ¨å°è¯•è·å¾—ä¸è¿™ä¸ªå¯¹è±¡ç›¸å…³è”çš„`Monitor`çš„æ‰€æœ‰æƒæ—¶ï¼Œä¼šè§¦å‘`monitorenter`æŒ‡ä»¤ï¼Œæ­¤æ—¶å¯èƒ½å‘ç”Ÿä»¥ä¸‹3ç§æƒ…å†µ

- monitorè®¡æ•°å™¨ä¸º0ï¼Œæ„å‘³ç€ç›®å‰è¯¥å¯¹è±¡çš„monitoré”è¿˜æ²¡æœ‰è¢«è·å¾—ï¼Œé‚£è¿™ä¸ª**çº¿ç¨‹å°±ä¼šç«‹åˆ»è·å–è¯¥é”ç„¶åæŠŠé”è®¡æ•°å™¨+1**ï¼Œä¸€æ—¦+1ï¼Œåˆ«çš„çº¿ç¨‹å†æƒ³è·å–ï¼Œå°±éœ€è¦ç­‰å¾…ï¼›
- å¦‚æœè¿™ä¸ªmonitorå·²ç»æ‹¿åˆ°äº†è¿™ä¸ªé”çš„æ‰€æœ‰æƒï¼Œåˆ**é‡å…¥**äº†è¿™æŠŠé”ï¼Œé‚£é”è®¡æ•°å™¨å°±ä¼šç´¯åŠ ï¼Œå˜æˆ2ï¼Œå¹¶ä¸”éšç€é‡å…¥çš„æ¬¡æ•°ï¼Œä¼šä¸€ç›´ç´¯åŠ ï¼›
- è¿™æŠŠé”å·²ç»è¢«åˆ«çš„çº¿ç¨‹è·å–äº†ï¼Œç­‰å¾…é”é‡Šæ”¾,åŒæ—¶è¯¥çº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…ï¼Œå˜ä¸ºé˜»å¡æ€

`monitorexitæŒ‡ä»¤`ï¼šä¼šé‡Šæ”¾å¯¹äºè¯¥monitoré”çš„æ‰€æœ‰æƒï¼Œé‡Šæ”¾è¿‡ç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯å°†`monitor`çš„è®¡æ•°å™¨å‡1ï¼Œå¦‚æœå‡å®Œä»¥åï¼Œè®¡æ•°å™¨ä¸æ˜¯0ï¼Œåˆ™ä»£è¡¨åˆšæ‰æ˜¯é‡å…¥è¿›æ¥çš„ï¼Œå½“å‰çº¿ç¨‹è¿˜ç»§ç»­æŒæœ‰è¿™æŠŠé”çš„æ‰€æœ‰æƒï¼Œå¦‚æœè®¡æ•°å™¨å˜æˆ0ï¼Œåˆ™ä»£è¡¨å½“å‰çº¿ç¨‹ä¸å†æ‹¥æœ‰è¯¥`monitor`çš„æ‰€æœ‰æƒï¼Œå°±ä¼šé‡Šæ”¾é”



ä»»æ„çº¿ç¨‹ä½¿ç”¨`synchronized`å¯¹ä¸€ä¸ª`Object`çš„è®¿é—®ï¼Œé¦–å…ˆè¦è·å¾—è¯¥`Object`çš„`monitor`ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œè¯¥çº¿ç¨‹å°±è¿›å…¥åŒæ­¥é˜Ÿåˆ—`SynchronizedQueue`ï¼Œçº¿ç¨‹çŠ¶æ€å˜ä¸º`BLOCKED`é˜»å¡æ€ï¼Œå½“`Object`çš„`monitor`è¢«å æœ‰è€…çº¿ç¨‹é‡Šæ”¾åï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å°±ä¼šé‡æ–°æŠ¢å è·å–è¯¥å¯¹è±¡çš„`monitor`é”ï¼š

```java
synchronized(Object){
//ä¸šåŠ¡é€»è¾‘
}
```

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/synchronized.png)





2ã€ä½œç”¨åœ¨æ–¹æ³•ä¸Š

è€Œå¦‚æœ`synchronized`ç›´æ¥ä½œç”¨åœ¨æ–¹æ³•è€Œä¸æ˜¯`Object`ä¸Šï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
public class SynchronizedDemo2 {
    public synchronized void synMethod() {
        System.out.println("synchronized æ–¹æ³•");
    }
}
```

å¯¹åº”çš„åæ±‡ç¼–æŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤º:

> Javaåæ±‡ç¼–æ˜¯é’ˆå¯¹Javaå­—èŠ‚ç (.classæ–‡ä»¶)è¿›è¡Œçš„ã€‚å®ƒé€šè¿‡åˆ†æå­—èŠ‚ç æŒ‡ä»¤,åç¼–è¯‘(Re-compile)å‡ºå¤§è‡´ç­‰ä»·çš„Javaæºç 

```java
  public synchronized void synMethod();

    descriptor: ()V

    flags: ACC_PUBLIC, ACC_SYNCHRONIZED

    Code:

      stack=0, locals=1, args_size=1

         0: return

      LineNumberTable:

        line 16: 0
```

å¯ä»¥çœ‹å‡ºï¼Œè¢«`synchronized`ä¿®é¥°çš„æ–¹æ³•ä¼šæœ‰ä¸€ä¸ª `ACC_SYNCHRONIZED` æ ‡å¿—,è¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚å¦‚æœè¯¥æ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVMä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVMåˆ™ä¼šå°è¯•è·å–å½“å‰`classç±»`çš„é”



**é”ç«äº‰å‘ç”Ÿåœ¨è¿è¡Œé˜¶æ®µ,è€Œä¸ç±»åŠ è½½å’Œç¼–è¯‘æ— å…³ã€‚å…·ä½“æ¥è¯´:**

åœ¨ä½¿ç”¨`synchronized`å…³é”®å­—ä¿®é¥°æ–¹æ³•æˆ–ä»£ç å—æ—¶,ä¼šè®¾ç½®`ACC_SYNCHRONIZED`æ ‡å¿—ã€‚

ä½†æ˜¯,è®¾ç½®è¿™ä¸ªæ ‡å¿—æœ¬èº«ä¸ä¼šäº§ç”Ÿä»»ä½•é”ç«äº‰ã€‚`ACC_SYNCHRONIZED`ä»…æ˜¯ä¸€ä¸ªç”¨äºJVMè¯†åˆ«çš„æ ‡å¿—ã€‚

é”ç«äº‰å‘ç”Ÿåœ¨å¤šä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒä¸€å—`synchronized`ä»£ç æ—¶ã€‚æ­¤æ—¶,å¤šä¸ªçº¿ç¨‹ä¼šç«äº‰åŒä¸€æŠŠé”ã€‚

ä¾‹å¦‚ï¼š

```java
public class Example {
    public synchronized void method() { ... }
}
```

åœ¨ç¼–è¯‘å’Œç±»åŠ è½½é˜¶æ®µ,ä»…ä»…è¯†åˆ«åˆ°`Example`ç±»ä½¿ç”¨äº†`synchronized`,å¹¶ä¼šè®¾ç½®`ACC_SYNCHRONIZED`æ ‡å¿—ã€‚æ­¤æ—¶è¿˜æ²¡æœ‰é”ç«äº‰ã€‚

> JVMæœ¬èº«åŒ…å«äº†ç¼–è¯‘å™¨(`Compiler`)å’Œç±»åŠ è½½å™¨(`ClassLoader`)ä¸¤ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†
>
> - ç¼–è¯‘å™¨(`Compiler`):JVMå†…ç½®äº†ä¸€å¥—Javaå­—èŠ‚ç ç¼–è¯‘å™¨,ç”¨äºå³æ—¶ç¼–è¯‘(*Just-In-Time,JIT*)
> - ç±»åŠ è½½å™¨(`ClassLoader`):ç±»åŠ è½½å™¨è´Ÿè´£è¯»å–classæ–‡ä»¶,å¹¶åŠ è½½åˆ°JVMä¸­,ä»¥å®Œæˆç±»çš„åˆå§‹åŒ–

ä½†å½“ä½¿ç”¨`Example`ç±»çš„å¤šä¸ªçº¿ç¨‹è°ƒç”¨method()æ–¹æ³•æ—¶,è¿™äº›çº¿ç¨‹å°±ä¼šè¯•å›¾è·å–method()æ–¹æ³•çš„é”ã€‚æ­¤æ—¶æ‰ä¼šå‘ç”ŸçœŸæ­£çš„é”ç«äº‰ã€‚æ‰€ä»¥,æ€»çš„æ¥è¯´:

- åŠ é”å‘ç”Ÿåœ¨ä½¿ç”¨`synchronized`å…³é”®å­—æ—¶ã€‚
- è®¾ç½®`ACC_SYNCHRONIZED`æ ‡å¿—ä»…æ˜¯ä¸ºäº†è®©JVMè¯†åˆ«`synchronized`ã€‚
- çœŸæ­£çš„é”ç«äº‰å‘ç”Ÿåœ¨è¿è¡Œé˜¶æ®µ,å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯•å›¾è·å–åŒä¸€æŠŠé”æ—¶ã€‚
- å› æ­¤,é”ç«äº‰çš„äº§ç”Ÿå’Œ`ACC_SYNCHRONIZED`æ ‡å¿—`setting`æœ¬èº«æ— å…³,å®ƒå®Œå…¨å–å†³äºä»£ç çš„æ‰§è¡Œã€‚



**æ€»ç»“ï¼š**

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–å¾—ä»£ä¹‹çš„ç¡®å®æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•

**ä¸è¿‡ä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–**







### å¯é‡å…¥åŸç†

**å¯é‡å…¥é”**ï¼šåˆåé€’å½’é”ï¼Œæ˜¯æŒ‡åœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œå†è¿›å…¥è¯¥çº¿ç¨‹çš„å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼ˆ**å‰æé”å¯¹è±¡è¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡æˆ–è€…class**ï¼‰ï¼Œä¸ä¼šå› ä¸ºä¹‹å‰å·²ç»è·å–è¿‡è¿˜æ²¡é‡Šæ”¾è€Œé˜»å¡ã€‚

**ä¾‹å­ï¼š**

```java
public class SynchronizedDemo {

    public static void main(String[] args) {
        SynchronizedDemo demo =  new SynchronizedDemo();
        
        demo.method1();
        //å¤šçº¿ç¨‹æ‰§è¡Œæ—¶ä¼šç«äº‰demoå®ä¾‹çš„å¯¹è±¡é”ï¼Œç«äº‰åˆ°åä¸æ–­é‡å…¥ï¼Œè®¡æ•°å™¨+1
    }

    private synchronized void method1() {
        System.out.println(Thread.currentThread().getId() + ": method1()");
        method2();
    }

    private synchronized void method2() {
        System.out.println(Thread.currentThread().getId()+ ": method2()");
        method3();
    }

    private synchronized void method3() {
        System.out.println(Thread.currentThread().getId()+ ": method3()");
    }
}
```



ç»“åˆå‰æ–‡ä¸­åŠ é”å’Œé‡Šæ”¾é”çš„åŸç†ï¼Œä¸éš¾ç†è§£ï¼š

- æ‰§è¡Œ`monitorenter`è·å–é” 
  - ï¼ˆmonitorè®¡æ•°å™¨=0ï¼Œå¯è·å–é”ï¼‰
  - æ‰§è¡Œmethod1()æ–¹æ³•ï¼Œmonitorè®¡æ•°å™¨+1 -> 1 ï¼ˆè·å–åˆ°é”ï¼‰
  - æ‰§è¡Œmethod2()æ–¹æ³•ï¼Œmonitorè®¡æ•°å™¨+1 -> 2
  - æ‰§è¡Œmethod3()æ–¹æ³•ï¼Œmonitorè®¡æ•°å™¨+1 -> 3
- æ‰§è¡Œ`monitorexit`å‘½ä»¤é‡Šæ”¾é”
  - method3()æ–¹æ³•æ‰§è¡Œå®Œï¼Œmonitorè®¡æ•°å™¨-1 -> 2
  - method2()æ–¹æ³•æ‰§è¡Œå®Œï¼Œmonitorè®¡æ•°å™¨-1 -> 1
  - method2()æ–¹æ³•æ‰§è¡Œå®Œï¼Œmonitorè®¡æ•°å™¨-1 -> 0 ï¼ˆé‡Šæ”¾äº†é”ï¼‰
  - ï¼ˆmonitorè®¡æ•°å™¨=0ï¼Œé”è¢«é‡Šæ”¾äº†ï¼‰

è¿™å°±æ˜¯`synchronized`çš„é‡å…¥æ€§ï¼Œå³åœ¨**åŒä¸€é”ç¨‹**ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ª`monitor`è®¡æ•°å™¨ï¼Œå½“çº¿ç¨‹è·å–è¯¥å¯¹è±¡é”ï¼ˆ`synchronized`ä¿®é¥°çš„æ˜¯**å®ä¾‹æ–¹æ³•éé™æ€æ–¹æ³•**ï¼Œæ•…è·å–çš„æ˜¯**å¯¹è±¡é”**ï¼‰åï¼Œ`monitor`è®¡æ•°å™¨å°±ä¼šåŠ ä¸€ï¼Œé‡Šæ”¾é”åå°±ä¼šå°†`monitor`è®¡æ•°å™¨å‡ä¸€ï¼Œçº¿ç¨‹ä¸éœ€è¦å†æ¬¡è·å–åŒä¸€æŠŠé”







### é”ä¼˜åŒ–ä¸æ”¹è¿›(å¿…çœ‹ğŸ‘€)



åœ¨JVMä¸­`monitorenter`å’Œ`monitorexit`å­—èŠ‚ç ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„`Mutex Lock`æ¥å®ç°çš„ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨`Mutex Lock`éœ€è¦å°†å½“å‰çº¿ç¨‹æŒ‚èµ·å¹¶ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ¥æ‰§è¡Œï¼Œè¿™ç§åˆ‡æ¢çš„ä»£ä»·æ˜¯éå¸¸æ˜‚è´µçš„ï¼›ç„¶è€Œåœ¨ç°å®ä¸­çš„å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼ŒåŒæ­¥æ–¹æ³•æ˜¯è¿è¡Œåœ¨å•çº¿ç¨‹ç¯å¢ƒ(æ— é”ç«äº‰ç¯å¢ƒ)å¦‚æœæ¯æ¬¡éƒ½è°ƒç”¨`Mutex Lock`é‚£ä¹ˆå°†ä¸¥é‡çš„å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚**ä¸è¿‡åœ¨jdk1.6ä¸­å¯¹é”çš„å®ç°å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–ï¼Œå¦‚é”ç²—åŒ–(Lock Coarsening)ã€é”æ¶ˆé™¤(Lock Elimination)ã€è½»é‡çº§é”(Lightweight Locking)ã€åå‘é”(Biased Locking)ã€é€‚åº”æ€§è‡ªæ—‹(Adaptive Spinning)ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€**

- `é”ç²—åŒ–(Lock Coarsening)`ï¼šä¹Ÿå°±æ˜¯**å‡å°‘ä¸å¿…è¦çš„ç´§è¿åœ¨ä¸€èµ·çš„unlockï¼Œlockæ“ä½œ**ï¼Œ**å°†å¤šä¸ªè¿ç»­çš„é”æ‰©å±•æˆä¸€ä¸ªèŒƒå›´æ›´å¤§çš„é”**
- `é”æ¶ˆé™¤(Lock Elimination)`ï¼šé€šè¿‡è¿è¡Œæ—¶JITç¼–è¯‘å™¨çš„**é€ƒé€¸åˆ†æ(**å½“JVMåˆ†æåˆ°ä¸€ä¸ª`synchronized`æ–¹æ³•ä¸­ä¸å­˜åœ¨å…±äº«æ•°æ®æ—¶,å®ƒå¯ä»¥æ¶ˆé™¤æ–¹æ³•å†…éƒ¨å¯¹é”çš„ä½¿ç”¨ã€‚è¿™å¯ä»¥ä½¿å¾—è¯¥æ–¹æ³•å³ä½¿è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨,ä¹Ÿä¸éœ€è¦è¿›è¡ŒåŒæ­¥,ä»è€Œæé«˜æ•ˆç‡ã€‚)æ¥æ¶ˆé™¤é”ä¿æŠ¤ï¼Œé€šè¿‡é€ƒé€¸åˆ†æä¹Ÿå¯ä»¥åœ¨æœ¬çº¿ç¨‹çš„`Stack`ä¸Šè¿›è¡Œå¯¹è±¡ç©ºé—´çš„åˆ†é…ï¼Œå‡å°‘Heapä¸Šçš„åƒåœ¾æ”¶é›†å¼€é”€(å³åˆ¤æ–­å¯¹è±¡æ˜¯å¦é€ƒé€¸å‡ºå½“å‰ä½œç”¨åŸŸã€‚å¦‚æœæ²¡æœ‰é€ƒé€¸ç›´æ¥åœ¨æ ˆä¸Šåˆ†é…)
- `è½»é‡çº§é”(Lightweight Locking)`ï¼šè¿™ç§é”å®ç°çš„èƒŒååŸºäºè¿™æ ·ä¸€ç§å‡è®¾ï¼Œå³åœ¨çœŸå®çš„æƒ…å†µä¸‹æˆ‘ä»¬ç¨‹åºä¸­çš„å¤§éƒ¨åˆ†åŒæ­¥ä»£ç ä¸€èˆ¬éƒ½å¤„äºæ— é”ç«äº‰çŠ¶æ€(å³å•çº¿ç¨‹æ‰§è¡Œç¯å¢ƒ)ï¼Œåœ¨æ— é”ç«äº‰çš„æƒ…å†µä¸‹å®Œå…¨å¯ä»¥é¿å…è°ƒç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„é‡é‡çº§äº’æ–¥é”ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åœ¨`monitorenter`å’Œ`monitorexit`ä¸­åªéœ€è¦ä¾é ä¸€æ¡CASåŸå­æŒ‡ä»¤å°±å¯ä»¥å®Œæˆé”çš„è·å–åŠé‡Šæ”¾ã€‚å½“å­˜åœ¨é”ç«äº‰çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡ŒCASæŒ‡ä»¤å¤±è´¥çš„çº¿ç¨‹å°†è°ƒç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é”è¿›å…¥åˆ°é˜»å¡çŠ¶æ€ï¼Œå½“é”è¢«é‡Šæ”¾çš„æ—¶å€™è¢«å”¤é†’(å…·ä½“å¤„ç†æ­¥éª¤ä¸‹é¢è¯¦ç»†è®¨è®º)ã€‚
- `åå‘é”(Biased Locking)`ï¼šæ˜¯ä¸ºäº†åœ¨æ— é”ç«äº‰çš„æƒ…å†µä¸‹é¿å…åœ¨é”è·å–è¿‡ç¨‹ä¸­æ‰§è¡Œä¸å¿…è¦çš„CASåŸå­æŒ‡ä»¤ï¼Œå› ä¸ºCASåŸå­æŒ‡ä»¤è™½ç„¶ç›¸å¯¹äºé‡é‡çº§é”æ¥è¯´å¼€é”€æ¯”è¾ƒå°ä½†è¿˜æ˜¯å­˜åœ¨éå¸¸å¯è§‚çš„æœ¬åœ°å»¶è¿Ÿã€‚
- `é€‚åº”æ€§è‡ªæ—‹(Adaptive Spinning)`ï¼šå½“çº¿ç¨‹åœ¨è·å–è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­æ‰§è¡ŒCASæ“ä½œå¤±è´¥æ—¶ï¼Œåœ¨è¿›å…¥ä¸monitorç›¸å…³è”çš„æ“ä½œç³»ç»Ÿé‡é‡çº§é”(mutex semaphore)å‰ä¼šè¿›å…¥å¿™ç­‰å¾…(Spinning)ç„¶åå†æ¬¡å°è¯•ï¼Œå½“å°è¯•ä¸€å®šçš„æ¬¡æ•°åå¦‚æœä»ç„¶æ²¡æœ‰æˆåŠŸåˆ™è°ƒç”¨ä¸è¯¥monitorå…³è”çš„semaphore(å³äº’æ–¥é”)è¿›å…¥åˆ°é˜»å¡çŠ¶æ€





#### **è‡ªæ—‹é”** 

è‡ªæ—‹é”çš„æ ¸å¿ƒå°±æ˜¯è®©çº¿ç¨‹ä¸è¿›å…¥`BLOCKED`æ€ï¼Œä¸€ç›´å¤„äº`Runnable`æ€ä¸æ–­å°è¯•

å…±äº«æ•°æ®çš„é”å®šçŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»**æŒ‚èµ·å’Œå›å¤é˜»å¡çº¿ç¨‹**å¹¶ä¸å€¼å¾—ã€‚åœ¨å¦‚ä»Šå¤šå¤„ç†å™¨ç¯å¢ƒä¸‹ï¼Œå®Œå…¨å¯ä»¥è®©å¦ä¸€ä¸ªæ²¡æœ‰è·å–åˆ°é”çš„çº¿ç¨‹åœ¨é—¨å¤–ç­‰å¾…ä¸€ä¼š(**è‡ªæ—‹**)ï¼Œä½†**ä¸æ”¾å¼ƒCPUçš„æ‰§è¡Œæ—¶é—´(å³çº¿ç¨‹ä¸è¿›å…¥BLOCKEDæ€)**ã€‚ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…ï¼Œæˆ‘ä»¬åªéœ€è¦è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯(è‡ªæ—‹)ï¼Œè¿™ä¾¿æ˜¯è‡ªæ—‹é”çš„ç”±æ¥

è‡ªæ—‹é”æœ¬è´¨ä¸Šä¸é˜»å¡å¹¶ä¸ç›¸åŒï¼Œå…ˆä¸è€ƒè™‘å…¶å¯¹å¤šå¤„ç†å™¨çš„è¦æ±‚ï¼Œå¦‚æœé”å ç”¨çš„æ—¶é—´éå¸¸çš„çŸ­ï¼Œé‚£ä¹ˆè‡ªæ—‹é”çš„æ€§èƒ½ä¼šéå¸¸çš„å¥½ï¼Œå¦‚æœé”è¢«å ç”¨æ—¶é—´è¾ƒé•¿æ—¶ï¼Œå…¶ä¼šå¸¦æ¥æ›´å¤šçš„æ€§èƒ½å¼€é”€(å› ä¸º**åœ¨çº¿ç¨‹è‡ªæ—‹æ—¶ï¼Œå§‹ç»ˆä¼šå ç”¨CPUçš„æ—¶é—´ç‰‡ï¼Œå¦‚æœé”å ç”¨çš„æ—¶é—´å¤ªé•¿ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹ä¼šç™½ç™½æ¶ˆè€—æ‰CPUèµ„æº**)ã€‚å› æ­¤è‡ªæ—‹ç­‰å¾…çš„æ—¶é—´å¿…é¡»è¦æœ‰ä¸€å®šçš„é™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å–åˆ°é”ï¼Œå°±åº”è¯¥ä½¿ç”¨ä¼ ç»Ÿçš„æ–¹å¼å»**æŒ‚èµ·çº¿ç¨‹**äº†ï¼Œåœ¨JDKå®šä¹‰ä¸­ï¼Œè‡ªæ—‹é”é»˜è®¤çš„è‡ªæ—‹æ¬¡æ•°ä¸º10æ¬¡ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å‚æ•°`-XX:PreBlockSpin`æ¥æ›´æ”¹



**è‡ªé€‚åº”è‡ªæ—‹é”ï¼š**

JDK 1.6ä¸­å¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ã€‚è¿™å°±æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸å†å›ºå®šäº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è¯¥çº¿ç¨‹çš„è‡ªæ—‹æ—¶é—´ä»¥åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šçš„ï¼š

(1)å¦‚æœåœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸Šï¼Œè‡ªæ—‹ç­‰å¾…æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œä½†æ˜¯è¯¥çº¿ç¨‹åˆšåˆšæˆåŠŸé€šè¿‡è‡ªæ—‹è·å–è¿‡è¯¥å¯¹è±¡é”ï¼Œå¹¶ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œä¸­ï¼Œé‚£ä¹ˆJVMä¼šè®¤ä¸ºè¯¥çº¿ç¨‹æ­¤æ—¶ç»§ç»­è‡ªæ—‹è·å–åˆ°é”çš„å¯èƒ½æ€§å¾ˆå¤§ï¼Œä¼šè‡ªåŠ¨å¢åŠ ç­‰å¾…æ—¶é—´ï¼›æ¯”å¦‚å¢åŠ åˆ°100æ¬¡å¾ªç¯ã€‚

(2)ç›¸åï¼Œå¦‚æœå¯¹äºæŸä¸ªé”ï¼Œè‡ªæ—‹å¾ˆå°‘æˆåŠŸè·å–é”ã€‚é‚£å†ä»¥åè¦è·å–è¿™ä¸ªé”æ—¶å°†å¯èƒ½çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥é¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼ŒJVMå¯¹ç¨‹åºçš„é”çš„çŠ¶æ€é¢„æµ‹ä¼šè¶Šæ¥è¶Šå‡†ç¡®





#### **é”æ¶ˆé™¤**

é”æ¶ˆé™¤æ˜¯æŒ‡è™šæ‹Ÿæœºçš„JITå³æ—¶ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ï¼Œå¯¹ä¸€äº›**ä»£ç ä¸Šå£°æ˜äº†åŒæ­¥æ“ä½œï¼Œä½†æ˜¯è¢«æ£€æµ‹åˆ°ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤**

é”æ¶ˆé™¤çš„ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäº**é€ƒé€¸åˆ†æ**çš„æ•°æ®æ”¯æŒã€‚æ„æ€å°±æ˜¯ï¼šJVMä¼šåˆ¤æ–­åœ¨ä¸€æ®µç¨‹åºä¸­å£°æ˜çš„åŒæ­¥æ“ä½œï¼Œ**å¦‚æœè¯¥æ“ä½œæ˜æ˜¾ä¸ä¼šé€ƒé€¸å‡ºå»ä»è€Œè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£JVMå°±æŠŠå®ƒä»¬å½“ä½œæ ˆä¸Šæ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºè¿™äº›æ•°æ®æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Œä¸éœ€è¦åŠ åŒæ­¥**ã€‚æ­¤æ—¶å°±ä¼šè¿›è¡Œé”æ¶ˆé™¤

ä¾‹å¦‚ `StringBuffer`ç±»ä¸­çš„`append()`ï¼š

```java
@Override
public synchronized StringBuffer append(String str) {
    toStringCache = null;
    super.append(str);
    return this;
}
```

ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œ`append()`æ–¹æ³•ç”¨äº†`synchronized`å…³é”®å­—ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æˆ‘ä»¬å¯èƒ½ä»…åœ¨çº¿ç¨‹å†…éƒ¨æŠŠ`StringBuffer`å½“ä½œå±€éƒ¨å˜é‡ä½¿ç”¨ï¼š

```java
public class LockClear {

    public static void main(String[] args) {
        LockClear test = new LockClear();
        for (int i = 0; i < 100; i++) {
            test.append("aaa", "bbb");
        }
    }
    public void appendString(String str1, String str2) {
        StringBuffer stringBuffer = new StringBuffer();
        stringBuffer.append(str1).append(str2);
    }
}

```

ä»£ç ä¸­`stringBuffer`æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡`stringBuffer`ï¼Œå°±åªåœ¨è¯¥æ–¹æ³•å†…çš„ä½œç”¨åŸŸæœ‰æ•ˆï¼Œä¸åŒçº¿ç¨‹åŒæ—¶è°ƒç”¨`stringBuffer`æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸åŒçš„`stringBuffer`å¯¹è±¡æ”¾åœ¨è‡ªå·±æ ˆå†…çš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œå› æ­¤æ­¤æ—¶çš„`append()`æ–¹æ³•è‹¥ä½¿ç”¨åŒæ­¥æ“ä½œï¼Œå°±æ˜¯ç™½ç™½æµªè´¹çš„ç³»ç»Ÿèµ„æºï¼ŒJVMåˆ¤æ–­è¯¥æ®µä»£ç å¹¶ä¸ä¼šé€ƒé€¸(`é€ƒé€¸åˆ†æ`)ï¼Œåˆ™å°†è¯¥ä»£ç å¸¦é»˜è®¤ä¸ºçº¿ç¨‹ç‹¬æœ‰çš„èµ„æºï¼Œå¹¶ä¸éœ€è¦åŒæ­¥ï¼Œæ‰€ä»¥æ‰§è¡Œäº†é”æ¶ˆé™¤æ“ä½œï¼Œä¸Šè¿°ä»£ç ä½¿ç”¨`javap -v LockClear.class ` åè§£æå­—èŠ‚ç æ–‡ä»¶çš„ç»“æœå¦‚ä¸‹ï¼š











#### é”ç²—åŒ–

å¦‚æœå­˜åœ¨è¿ä¸²çš„ä¸€ç³»åˆ—æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ—¶å‡ºç°åœ¨å¾ªç¯ä½“ä¸­ï¼Œé‚£å³ä½¿æ²¡æœ‰çº¿ç¨‹ç«äº‰ï¼Œé¢‘ç¹çš„è¿›è¡Œäº’æ–¥åŒæ­¥æ“ä½œä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æ“ä½œï¼Œæ­¤æ—¶jvmåœ¨è§£æä»£ç åå°±ä¼šè‡ªåŠ¨è¿›è¡Œé”æ¶ˆé™¤ä¼˜åŒ–:

```JAVA
public static String test04(String s1, String s2, String s3) {
    StringBuffer sb = new StringBuffer();
    sb.append(s1);
    sb.append(s2);
    sb.append(s3);
    return sb.toString();
}

```

ä¸Šè¿°çš„è¿ç»­`append()`æ“ä½œä¸­å°±å±äºè¿™ç±»æƒ…å†µã€‚JVMä¼šæ£€æµ‹åˆ°è¿™æ ·ä¸€è¿ä¸²çš„æ“ä½œéƒ½æ˜¯å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œé‚£ä¹ˆJVMä¼šå°†åŠ é”åŒæ­¥çš„èŒƒå›´æ‰©å±•(ç²—åŒ–)åˆ°æ•´ä¸ªä¸€ç³»åˆ—æ“ä½œçš„å¤–éƒ¨ï¼Œä½¿æ•´ä¸ªä¸€è¿ä¸²çš„`append()`æ“ä½œåªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥äº†:**å³åœ¨ç¬¬ä¸€æ¬¡appendæ–¹æ³•æ—¶è¿›è¡ŒåŠ é”ï¼Œæœ€åä¸€æ¬¡appendæ–¹æ³•ç»“æŸåè¿›è¡Œè§£é”**









#### é”çŠ¶æ€â€”â€”MarkWord

Java 6 ä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†â€œåå‘é”â€å’Œâ€œè½»é‡çº§é”â€œã€‚åœ¨Java 6 ä»¥å‰ï¼Œæ‰€æœ‰çš„é”éƒ½æ˜¯â€é‡é‡çº§â€œé”ã€‚æ‰€ä»¥åœ¨Java 6 åŠå…¶ä»¥åï¼Œä¸€ä¸ªå¯¹è±¡å…¶å®æœ‰å››ç§é”çŠ¶æ€ï¼Œå®ƒä»¬çº§åˆ«ç”±ä½åˆ°é«˜ä¾æ¬¡æ˜¯ï¼š

1. æ— é”çŠ¶æ€
2. åå‘é”çŠ¶æ€
3. è½»é‡çº§é”çŠ¶æ€
4. é‡é‡çº§é”çŠ¶æ€

æ— é”å°±æ˜¯æ²¡æœ‰å¯¹èµ„æºè¿›è¡Œé”å®šï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥å°è¯•å»ä¿®æ”¹å®ƒï¼Œæ— é”åœ¨è¿™é‡Œä¸å†ç»†è®²ã€‚

å‡ ç§é”ä¼šéšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ï¼Œé”çš„å‡çº§å¾ˆå®¹æ˜“å‘ç”Ÿï¼Œä½†æ˜¯é”é™çº§å‘ç”Ÿçš„æ¡ä»¶ä¼šæ¯”è¾ƒè‹›åˆ»ï¼Œé”é™çº§å‘ç”Ÿåœ¨`Stop The World`æœŸé—´ï¼Œå½“JVMè¿›å…¥å®‰å…¨ç‚¹çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰é—²ç½®çš„é”ï¼Œç„¶åè¿›è¡Œé™çº§ã€‚

> å…³äºé”é™çº§æœ‰ä¸¤ç‚¹è¯´æ˜ï¼š
>
> 1.ä¸åŒäºå¤§éƒ¨åˆ†æ–‡ç« è¯´é”ä¸èƒ½é™çº§ï¼Œå®é™…ä¸ŠHotSpot JVM æ˜¯æ”¯æŒé”é™çº§çš„ï¼Œæ–‡æœ«æœ‰é“¾æ¥ã€‚
>
> 2.ä¸Šé¢æåˆ°çš„Stop The WorldæœŸé—´ï¼Œä»¥åŠå®‰å…¨ç‚¹ï¼Œè¿™äº›çŸ¥è¯†æ˜¯å±äºJVMçš„çŸ¥è¯†èŒƒç•´ï¼Œæœ¬æ–‡ä¸åšç»†è®²ã€‚



| é”       | ä¼˜ç‚¹                                                         | ç¼ºç‚¹                                                         | ä½¿ç”¨åœºæ™¯                           |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------------------------------- |
| åå‘é”   | åŠ é”å’Œè§£é”ä¸éœ€è¦CASæ“ä½œï¼Œæ²¡æœ‰é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ï¼Œå’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•ç›¸æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è· | å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„é”æ’¤é”€çš„æ¶ˆè€—               | é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—çš„åœºæ™¯ |
| è½»é‡çº§é” | ç«äº‰çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜äº†å“åº”é€Ÿåº¦                           | å¦‚çº¿ç¨‹å§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ï¼Œä½¿ç”¨è‡ªæ—‹ä¼šæ¶ˆè€—CPUæ€§èƒ½          | è¿½æ±‚å“åº”æ—¶é—´ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦éå¸¸å¿« |
| é‡é‡çº§é” | çº¿ç¨‹ç«äº‰ä¸é€‚ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPU                              | çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢ï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œé¢‘ç¹çš„è·å–é‡Šæ”¾é”ï¼Œä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æ¶ˆè€— | è¿½æ±‚ååé‡ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒé•¿     |



JDK 1.6ä¹‹åå¼•å…¥äº†è½»é‡çº§é”ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯**è½»é‡çº§é”å¹¶ä¸æ˜¯æ›¿ä»£é‡é‡çº§é”**çš„ï¼Œè€Œæ˜¯å¯¹åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åŒæ­¥å—å¹¶ä¸ä¼šæœ‰ç«äº‰å‡ºç°æå‡ºçš„ä¸€ç§ä¼˜åŒ–ã€‚å®ƒå¯ä»¥å‡å°‘é‡é‡çº§é”å¯¹çº¿ç¨‹çš„é˜»å¡å¸¦æ¥çš„çº¿ç¨‹å¼€é”€ã€‚ä»è€Œæé«˜å¹¶å‘æ€§èƒ½

åœ¨JDK 1.6ä¹‹å‰,`synchronized`åªæœ‰ä¼ ç»Ÿçš„é”æœºåˆ¶ï¼Œç›´æ¥å…³è”åˆ°`monitor`å¯¹è±¡ï¼Œå­˜åœ¨æ€§èƒ½ä¸Šçš„ç“¶é¢ˆã€‚åœ¨JDK 1.6åï¼Œä¸ºäº†æé«˜é”çš„è·å–ä¸é‡Šæ”¾æ•ˆç‡ï¼ŒJVMå¼•å…¥äº†ä¸¤ç§é”æœºåˆ¶ï¼šåå‘é”å’Œè½»é‡çº§é”ã€‚å®ƒä»¬çš„å¼•å…¥æ˜¯ä¸ºäº†è§£å†³åœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰æˆ–åŸºæœ¬æ²¡æœ‰ç«äº‰çš„åœºæ™¯ä¸‹å› ä½¿ç”¨ä¼ ç»Ÿé”æœºåˆ¶å¸¦æ¥çš„æ€§èƒ½å¼€é”€é—®é¢˜ã€‚è¿™å‡ ç§é”çš„å®ç°å’Œè½¬æ¢æ­£æ˜¯ä¾é å¯¹è±¡å¤´ä¸­çš„`Mark Word`:

åœ¨ JVM ä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†ä¸ºä¸‰å—åŒºåŸŸï¼š

- å¯¹è±¡å¤´ï¼šç”±`Mark Word`å’Œ`Class Metadata Address`æ„æˆ

  - **Class Metadata Address**ï¼ˆç±»å‹æŒ‡é’ˆï¼‰ï¼šå¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚

  - **Mark Word**ï¼ˆæ ‡è®°å­—æ®µï¼‰ï¼šç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œä¾‹å¦‚å­˜å‚¨å¯¹è±¡çš„`HashCode`ï¼Œåˆ†ä»£å¹´é¾„ã€**é”æ ‡å¿—ä½**ç­‰ä¿¡æ¯ï¼Œè¿™ä¸ªæ ‡å¿—ä½åˆ™æ˜¯`synchronized`å®ç°è½»é‡çº§é”å’Œåå‘é”çš„å…³é”®ã€‚ 64ä½JVMçš„Mark Wordç»„æˆå¦‚ä¸‹ï¼š


![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/markword.png)

- å®ä¾‹æ•°æ®ï¼šè¿™éƒ¨åˆ†ä¸»è¦æ˜¯å­˜æ”¾ç±»çš„æ•°æ®ä¿¡æ¯ï¼Œçˆ¶ç±»çš„ä¿¡æ¯ã€‚

- å­—èŠ‚å¯¹é½ï¼šä¸ºäº†å†…å­˜çš„IOæ€§èƒ½ï¼ŒJVMè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚å¯¹äºä¸å¯¹é½çš„å¯¹è±¡ï¼Œéœ€è¦å¡«å……æ•°æ®è¿›è¡Œå¯¹é½



å¯ä»¥çœ‹åˆ°ï¼Œå½“å¯¹è±¡çŠ¶æ€ä¸ºåå‘é”æ—¶ï¼Œ`Mark Word`å­˜å‚¨çš„æ˜¯åå‘çš„çº¿ç¨‹IDï¼›å½“çŠ¶æ€ä¸ºè½»é‡çº§é”æ—¶ï¼Œ`Mark Word`å­˜å‚¨çš„æ˜¯æŒ‡å‘çº¿ç¨‹æ ˆä¸­`Lock Record`çš„æŒ‡é’ˆï¼›å½“çŠ¶æ€ä¸ºé‡é‡çº§é”æ—¶ï¼Œ`Mark Word`ä¸ºæŒ‡å‘å †ä¸­çš„`monitor`å¯¹è±¡çš„æŒ‡é’ˆ(æ­¤æ—¶æ‰å‡çº§ä¸ºè€ç‰ˆçš„`monitor`é‡é‡çº§é”) :imp:







å¤šçº¿ç¨‹ä¸‹ `synchronized` çš„åŠ é”å°±æ˜¯**å¯¹åŒä¸€ä¸ªå¯¹è±¡çš„å¯¹è±¡å¤´ä¸­çš„ `MarkWord` ä¸­çš„å˜é‡è¿›è¡ŒCASæ“ä½œ**

åœ¨çº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—ä¹‹å‰ï¼ŒJVMä¼šå…ˆåœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºé”è®°å½•(`Lock Record`)çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„`Mark Word`çš„æ‹·è´,å¦‚æœå½“å‰å¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œé‚£ä¹ˆé”æ ‡å¿—ä½ä¸º**01**çŠ¶æ€ï¼ŒJVMåœ¨æ‰§è¡Œå½“å‰çº¿ç¨‹æ—¶ï¼Œé¦–å…ˆä¼šåœ¨å½“å‰çº¿ç¨‹æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•`Lock Record`çš„ç©ºé—´ç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„`Mark Word`çš„æ‹·è´, ç„¶åï¼Œè™šæ‹Ÿæœºä½¿ç”¨`CAS`æ“ä½œå°†æ ‡è®°å­—æ®µ`Mark Word`æ‹·è´åˆ°é”è®°å½•ä¸­ï¼Œå¹¶ä¸”å°†`Mark Word`æ›´æ–°ä¸ºæŒ‡å‘å½“å‰çº¿ç¨‹æ ˆå¸§ä¸­`Lock Record`çš„æŒ‡é’ˆã€‚å¦‚æœæ›´æ–°æˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥ç”¨äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡`Mark Word`çš„é”æ ‡å¿—ä½æ›´æ–°ä¸º(`Mark Word`ä¸­æœ€åçš„2bit)00ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€:

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-thread-x-key-schronized-6.png)

å¦‚æœè¿™ä¸ªæ›´æ–°æ“ä½œå¤±è´¥ï¼ŒJVMä¼šæ£€æŸ¥å½“å‰çš„`Mark Word`ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§çš„æŒ‡é’ˆï¼Œå¦‚æœæœ‰ï¼Œè¯´æ˜è¯¥é”å·²ç»è¢«è·å–ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯´æ˜è¯¥é”è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ï¼Œå¦‚æœæœ‰ä¸¤æ¡ä»¥ä¸Šçš„çº¿ç¨‹ç«äº‰åŒä¸€ä¸ªé”ï¼Œé‚£è½»é‡çº§é”å°±ä¸å†æœ‰æ•ˆï¼Œç›´æ¥è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œæ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚æ­¤æ—¶ï¼Œé”çš„æ ‡å¿—ä½ä¸º`10 ï¼Œ Mark Word`ä¸­å­˜å‚¨çš„æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆ

 è½»é‡çº§è§£é”æ—¶ï¼Œä¼šä½¿ç”¨åŸå­çš„CASæ“ä½œå°†`Displaced Mark Word`æ›¿æ¢å›åˆ°å¯¹è±¡å¤´ä¸­ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¡¨ç¤ºæ²¡æœ‰å‘ç”Ÿç«äº‰å…³ç³»ã€‚å¦‚æœå¤±è´¥ï¼Œè¡¨ç¤ºå½“å‰é”å­˜åœ¨ç«äº‰å…³ç³»ï¼Œé‚£ä¹ˆé”å°±ä¼šè†¨èƒ€æˆé‡é‡çº§é”ã€‚







#### åå‘é”



> Hotspotçš„ä½œè€…ç»è¿‡ä»¥å¾€çš„ç ”ç©¶å‘ç°å¤§å¤šæ•°æƒ…å†µä¸‹**é”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—**ï¼Œäºæ˜¯å¼•å…¥äº†åå‘é”



ä¸€ä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€æ¬¡è¿›å…¥åŒæ­¥å—æ—¶ï¼Œä¼šåœ¨å¯¹è±¡å¤´å’Œæ ˆå¸§ä¸­çš„é”è®°å½•`Lock Record`é‡Œå­˜å‚¨é”çš„åå‘çš„çº¿ç¨‹IDã€‚å½“ä¸‹æ¬¡è¯¥çº¿ç¨‹è¿›å…¥è¿™ä¸ªåŒæ­¥å—æ—¶ï¼Œä¼š**å»æ£€æŸ¥è¯¥å¯¹è±¡çš„`Mark Word`é‡Œé¢æ˜¯ä¸æ˜¯æ”¾çš„è‡ªå·±çš„çº¿ç¨‹ID**

å¦‚æœæ˜¯ï¼Œè¡¨æ˜è¯¥çº¿ç¨‹å·²ç»è·å¾—äº†é”(**è¯´æ˜è¯¥å¯¹è±¡æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æ‰€ä½¿ç”¨è¿‡**)ï¼Œä»¥åè¯¥çº¿ç¨‹åœ¨è¿›å…¥å’Œé€€å‡ºåŒæ­¥å—æ—¶ä¸éœ€è¦èŠ±è´¹CASæ“ä½œæ¥åŠ é”å’Œè§£é” ï¼›å¦‚æœä¸æ˜¯ï¼Œå°±ä»£è¡¨æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ¥ç«äº‰è¿™ä¸ªåå‘é”ã€‚è¿™ä¸ªæ—¶å€™ä¼šå°è¯•ä½¿ç”¨CASæ¥æ›¿æ¢`Mark Word`é‡Œé¢çš„çº¿ç¨‹IDä¸ºæ–°çº¿ç¨‹çš„IDï¼Œè¿™ä¸ªæ—¶å€™è¦åˆ†ä¸¤ç§æƒ…å†µï¼š

- æˆåŠŸï¼Œè¡¨ç¤ºä¹‹å‰çš„çº¿ç¨‹ä¸å­˜åœ¨äº†ï¼ŒMark Wordé‡Œé¢çš„çº¿ç¨‹IDä¸ºæ–°çº¿ç¨‹çš„IDï¼Œé”ä¸ä¼šå‡çº§ï¼Œä»ç„¶ä¸ºåå‘é”ï¼›
- å¤±è´¥ï¼Œè¡¨ç¤ºä¹‹å‰çš„çº¿ç¨‹ä»ç„¶å­˜åœ¨ï¼Œé‚£ä¹ˆæš‚åœä¹‹å‰çš„çº¿ç¨‹ï¼Œè®¾ç½®åå‘é”æ ‡è¯†ä¸º0ï¼Œå¹¶è®¾ç½®é”æ ‡å¿—ä½ä¸º00ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ï¼Œä¼šæŒ‰ç…§è½»é‡çº§é”çš„æ–¹å¼è¿›è¡Œç«äº‰é”

**åå‘é”çš„åŠ é”ï¼š**

1. åå‘é”æ ‡å¿—æ˜¯æœªåå‘çŠ¶æ€ï¼Œçº¿ç¨‹ä¼šä½¿ç”¨ `CAS` å°† `MarkWord` ä¸­çš„çº¿ç¨‹IDè®¾ç½®ä¸ºè‡ªå·±çš„çº¿ç¨‹IDï¼Œ
   1. å¦‚æœæˆåŠŸï¼Œåˆ™è·å–åå‘é”æˆåŠŸ
   2. å¦‚æœå¤±è´¥ï¼Œè¯´æ˜å­˜åœ¨ç«äº‰ï¼Œåˆ™è¿›è¡Œé”å‡çº§
2. åå‘é”æ ‡å¿—æ˜¯å·²åå‘çŠ¶æ€ï¼š
   1. `MarkWord` ä¸­çš„çº¿ç¨‹ ID æ˜¯è‡ªå·±çš„çº¿ç¨‹ IDï¼ŒæˆåŠŸè·å–é”
   2. `MarkWord` ä¸­çš„çº¿ç¨‹ ID ä¸æ˜¯è‡ªå·±çš„çº¿ç¨‹ IDï¼Œéœ€è¦è¿›è¡Œé”å‡çº§





#### è½»é‡çº§é”

å¤šä¸ªçº¿ç¨‹åœ¨ä¸åŒæ—¶æ®µè·å–åŒä¸€æŠŠé”ï¼Œå³ä¸å­˜åœ¨é”ç«äº‰çš„æƒ…å†µï¼Œä¹Ÿå°±æ²¡æœ‰çº¿ç¨‹é˜»å¡ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒJVMé‡‡ç”¨è½»é‡çº§é”æ¥é¿å…çº¿ç¨‹çš„é˜»å¡ä¸å”¤é†’

JVMä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­åˆ›å»ºç”¨äºå­˜å‚¨é”è®°å½•çš„ç©ºé—´ï¼Œæˆ‘ä»¬ç§°ä¸ºDisplaced Mark Wordã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è·å¾—é”çš„æ—¶å€™å‘ç°æ˜¯è½»é‡çº§é”ï¼Œä¼šæŠŠé”çš„Mark Wordå¤åˆ¶åˆ°è‡ªå·±çš„Displaced Mark Wordé‡Œé¢ã€‚

ç„¶åçº¿ç¨‹å°è¯•ç”¨CAS**å°† Mark Wordä¸­çš„å†…å®¹ æ›¿æ¢ä¸ºæŒ‡å‘è‡ªå·±çº¿ç¨‹`Lock Record`çš„æŒ‡é’ˆã€‚**å¦‚æœæˆåŠŸï¼Œå½“å‰çº¿ç¨‹è·å¾—é”ï¼Œå¦‚æœå¤±è´¥ï¼Œè¡¨ç¤º `Mark Word` å·²ç»è¢«æ›¿æ¢æˆäº†å…¶ä»–çº¿ç¨‹çš„é”è®°å½•ï¼Œè¯´æ˜åœ¨ä¸å…¶å®ƒçº¿ç¨‹ç«äº‰é”ï¼Œå½“å‰çº¿ç¨‹å°±å°è¯•ä½¿ç”¨è‡ªæ—‹æ¥è·å–é”

> è‡ªæ—‹ï¼šä¸æ–­å°è¯•å»è·å–é”ï¼Œä¸€èˆ¬ç”¨å¾ªç¯æ¥å®ç°ã€‚

è‡ªæ—‹æ˜¯éœ€è¦æ¶ˆè€—CPUçš„ï¼Œå¦‚æœä¸€ç›´è·å–ä¸åˆ°é”çš„è¯ï¼Œé‚£è¯¥çº¿ç¨‹å°±ä¸€ç›´å¤„åœ¨è‡ªæ—‹çŠ¶æ€ï¼Œç™½ç™½æµªè´¹CPUèµ„æºã€‚è§£å†³è¿™ä¸ªé—®é¢˜æœ€ç®€å•çš„åŠæ³•å°±æ˜¯æŒ‡å®šè‡ªæ—‹çš„æ¬¡æ•°ï¼Œä¾‹å¦‚è®©å…¶å¾ªç¯10æ¬¡ï¼Œå¦‚æœè¿˜æ²¡è·å–åˆ°é”å°±è¿›å…¥é˜»å¡çŠ¶æ€ã€‚

ä½†æ˜¯JDKé‡‡ç”¨äº†æ›´èªæ˜çš„æ–¹å¼â€”â€”**é€‚åº”æ€§è‡ªæ—‹**ï¼Œç®€å•æ¥è¯´å°±æ˜¯çº¿ç¨‹å¦‚æœè‡ªæ—‹æˆåŠŸäº†ï¼Œåˆ™ä¸‹æ¬¡è‡ªæ—‹çš„æ¬¡æ•°ä¼šæ›´å¤šï¼Œå¦‚æœè‡ªæ—‹å¤±è´¥äº†ï¼Œåˆ™è‡ªæ—‹çš„æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚

è‡ªæ—‹ä¹Ÿä¸æ˜¯ä¸€ç›´è¿›è¡Œä¸‹å»çš„ï¼Œå¦‚æœè‡ªæ—‹åˆ°ä¸€å®šç¨‹åº¦ï¼ˆå’ŒJVMã€æ“ä½œç³»ç»Ÿç›¸å…³ï¼‰ï¼Œä¾ç„¶æ²¡æœ‰è·å–åˆ°é”ï¼Œç§°ä¸ºè‡ªæ—‹å¤±è´¥ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹ä¼šé˜»å¡ã€‚åŒæ—¶è¿™ä¸ªé”å°±ä¼š**å‡çº§æˆé‡é‡çº§é”**



#### æ€»ç»“

 `synchronized`é”å‡çº§çš„é¡ºåºä¸ºï¼šåå‘é”->è½»é‡çº§é”->é‡é‡çº§é”(Monitor)ï¼Œæ¯ä¸€æ­¥è§¦å‘é”å‡çº§çš„æƒ…å†µå¦‚ä¸‹ï¼š

**åå‘é”**

åœ¨ JDK1.8 ä¸­ï¼Œ`synchronized`é»˜è®¤æ˜¯è½»é‡çº§é”ï¼Œä½†å¦‚æœè®¾å®šäº† -XX:BiasedLockingStartupDelay = 0 ï¼Œé‚£åœ¨å¯¹ä¸€ä¸ª Object åš `synchronized` çš„æ—¶å€™ï¼Œä¼šç«‹å³ä¸Šä¸€æŠŠåå‘é”ã€‚å½“å¤„äºåå‘é”çŠ¶æ€æ—¶ï¼Œ `markword` ä¼šè®°å½•å½“å‰çº¿ç¨‹ ID 

**å‡çº§åˆ°è½»é‡çº§é”**

å½“ä¸‹ä¸€ä¸ªçº¿ç¨‹å‚ä¸åˆ°åå‘é”ç«äº‰æ—¶ï¼Œä¼šå…ˆ**åˆ¤æ–­ `markword` ä¸­ä¿å­˜çš„çº¿ç¨‹ ID æ˜¯å¦ä¸è¿™ä¸ªçº¿ç¨‹ ID ç›¸ç­‰**ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œä¼šç«‹å³æ’¤é”€åå‘é”ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚æ¯ä¸ªçº¿ç¨‹åœ¨è‡ªå·±çš„jvmæ ˆä¸­ç”Ÿæˆä¸€ä¸ª `LockRecord` ( LR )ï¼Œ**ç„¶åæ¯ä¸ªçº¿ç¨‹é€šè¿‡ CAS (è‡ªæ—‹)çš„æ“ä½œå°†é”å¯¹è±¡å¤´ä¸­çš„ `markword` è®¾ç½®ä¸ºæŒ‡å‘è‡ªå·±çš„ LR çš„æŒ‡é’ˆï¼Œå“ªä¸ªçº¿ç¨‹è®¾ç½®æˆåŠŸï¼Œå°±æ„å‘³ç€è·å¾—é”ã€‚**



**å‡çº§åˆ°é‡é‡çº§é”**

å¦‚æœé”ç«äº‰åŠ å‰§(å¦‚çº¿ç¨‹è‡ªæ—‹æ¬¡æ•°æˆ–è€…è‡ªæ—‹çš„çº¿ç¨‹æ•°è¶…è¿‡æŸé˜ˆå€¼ï¼Œ JDK1.6 ä¹‹åï¼Œç”± JVM è‡ªå·±æ§åˆ¶è¯¥è§„åˆ™)ï¼Œå°±ä¼šå‡çº§ä¸ºé‡é‡çº§é”ã€‚æ­¤æ—¶å°±ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·èµ„æºï¼Œçº¿ç¨‹æŒ‚èµ·ï¼Œè¿›å…¥åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸æ€çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œç„¶åæ˜ å°„å›ç”¨æˆ·æ€ã€‚åœ¨é‡é‡çº§é”ä¸­ï¼Œç”±äºéœ€è¦åšå†…æ ¸æ€åˆ°ç”¨æˆ·æ€çš„è½¬æ¢ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹ä¸­éœ€è¦æ¶ˆè€—è¾ƒå¤šæ—¶é—´ï¼Œä¹Ÿå°±æ˜¯"é‡"çš„åŸå› ä¹‹ä¸€





æ²‰é»˜ç‹äºŒä¸Šå¯¹é”å‡çº§æµç¨‹çš„æ€»ç»“ï¼š



æ¯ä¸€ä¸ªçº¿ç¨‹åœ¨å‡†å¤‡è·å–å…±äº«èµ„æºæ—¶ï¼š ç¬¬ä¸€æ­¥ï¼Œæ£€æŸ¥`MarkWord`é‡Œé¢æ˜¯ä¸æ˜¯æ”¾çš„è‡ªå·±çš„`ThreadId` ,å¦‚æœæ˜¯ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯å¤„äº â€œåå‘é”â€ 

ç¬¬äºŒæ­¥ï¼Œå¦‚æœ`MarkWord`ä¸æ˜¯è‡ªå·±çš„`ThreadId`ï¼Œé”å‡çº§ï¼Œè¿™æ—¶å€™ï¼Œç”¨CASæ¥æ‰§è¡Œåˆ‡æ¢ï¼Œæ–°çš„çº¿ç¨‹æ ¹æ®`MarkWord`é‡Œé¢ç°æœ‰çš„`ThreadId`ï¼Œé€šçŸ¥ä¹‹å‰çº¿ç¨‹æš‚åœï¼Œä¹‹å‰çº¿ç¨‹å°†Markwordçš„å†…å®¹ç½®ä¸ºç©ºã€‚

ç¬¬ä¸‰æ­¥ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½æŠŠé”å¯¹è±¡çš„`HashCode`å¤åˆ¶åˆ°è‡ªå·±æ–°å»ºçš„ç”¨äºå­˜å‚¨é”çš„è®°å½•ç©ºé—´ï¼Œæ¥ç€å¼€å§‹é€šè¿‡CASæ“ä½œï¼Œ æŠŠé”å¯¹è±¡çš„`MarKword`çš„å†…å®¹ä¿®æ”¹ä¸ºè‡ªå·±æ–°å»ºçš„è®°å½•ç©ºé—´LockRecordçš„åœ°å€çš„æ–¹å¼ç«äº‰`MarkWord`

ç¬¬å››æ­¥ï¼Œç¬¬ä¸‰æ­¥ä¸­æˆåŠŸæ‰§è¡ŒCASçš„è·å¾—èµ„æºï¼Œå¤±è´¥çš„åˆ™è¿›å…¥è‡ªæ—‹ (æˆåŠŸæ‹¿åˆ°è½»é‡çº§é”)

ç¬¬äº”æ­¥ï¼Œè‡ªæ—‹çš„çº¿ç¨‹åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼ŒæˆåŠŸè·å¾—èµ„æº(å³ä¹‹å‰è·çš„èµ„æºçš„çº¿ç¨‹æ‰§è¡Œå®Œæˆå¹¶é‡Šæ”¾äº†å…±äº«èµ„æº)ï¼Œåˆ™æ•´ä¸ªçŠ¶æ€ä¾ç„¶å¤„äº è½»é‡çº§é”çš„çŠ¶æ€ï¼Œå¦‚æœè‡ªæ—‹å¤±è´¥ ã€‚

ç¬¬å…­æ­¥ï¼Œè¿›å…¥é‡é‡çº§é”çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè‡ªæ—‹çš„çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œç­‰å¾…ä¹‹å‰çº¿ç¨‹æ‰§è¡Œå®Œæˆå¹¶å”¤é†’è‡ªå·±ã€‚













## Volatile



 **volatileçš„å®ç°åŸç†ï¼š**

- **é€šè¿‡å¯¹OpenJDKä¸­çš„unsafe.cppæºç çš„åˆ†æï¼Œä¼šå‘ç°è¢«volatileå…³é”®å­—ä¿®é¥°çš„å˜é‡ä¼šå­˜åœ¨ä¸€ä¸ªâ€œlock:â€çš„å‰ç¼€ã€‚**

- *Lockå‰ç¼€ï¼ŒLockä¸æ˜¯ä¸€ç§å†…å­˜å±éšœï¼Œä½†æ˜¯å®ƒèƒ½å®Œæˆç±»ä¼¼å†…å­˜å±éšœçš„åŠŸèƒ½ã€‚Lockä¼šå¯¹CPUæ€»çº¿å’Œé«˜é€Ÿç¼“å­˜åŠ é”ï¼Œå¯ä»¥ç†è§£ä¸ºCPUæŒ‡ä»¤çº§çš„ä¸€ç§é”ã€‚*

- åœ¨å…·ä½“çš„æ‰§è¡Œä¸Šï¼Œ**å®ƒå…ˆå¯¹æ€»çº¿å’Œç¼“å­˜åŠ é”**ï¼Œç„¶å**æ‰§è¡Œåé¢çš„æŒ‡ä»¤**ï¼Œåœ¨**Locké”ä½æ€»çº¿**çš„æ—¶å€™ï¼Œå…¶ä»–CPUçš„è¯»å†™è¯·æ±‚éƒ½ä¼š**è¢«é˜»å¡**ï¼Œ**ç›´åˆ°é”é‡Šæ”¾**ã€‚æœ€å**é‡Šæ”¾é”å**ä¼šæŠŠé«˜é€Ÿç¼“å­˜ä¸­çš„è„æ•°æ®å…¨éƒ¨**åˆ·æ–°å›ä¸»å†…å­˜**ï¼Œä¸”è¿™ä¸ª**å†™å›å†…å­˜çš„æ“ä½œ**ä¼šä½¿åœ¨å…¶ä»–CPUæ ¸å¿ƒé‡Œ**ç¼“å­˜äº†è¯¥åœ°å€çš„æ•°æ®æ— æ•ˆ**ï¼Œå¼ºåˆ¶ä»ä¸»å­˜ä¸­é‡æ–°è¯»å–åˆ°å„è‡ªçš„é«˜é€Ÿç¼“å­˜ä¸­ã€‚

  

- ç”¨`volatile`å…³é”®å­—ä¿®é¥°å˜é‡å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œ**é‚£ä¹ˆ`volatile`æ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„å‘¢ï¼Ÿé‚£å°±æ˜¯å†…å­˜å±éšœ**ï¼Œ**å†…å­˜å±éšœæ˜¯ç¡¬ä»¶å±‚çš„æ¦‚å¿µ**ï¼Œä¸åŒçš„ç¡¬ä»¶å¹³å°å®ç°å†…å­˜å±éšœçš„æ‰‹æ®µå¹¶ä¸æ˜¯ä¸€æ ·ï¼Œjavaé€šè¿‡å±è”½è¿™äº›å·®å¼‚ï¼Œ**ç»Ÿä¸€ç”±jvmæ¥ç”Ÿæˆå†…å­˜å±éšœçš„æŒ‡ä»¤**ï¼Œ**Lockæ˜¯è½¯ä»¶æŒ‡ä»¤ã€‚**





### Happens-BeforeåŸåˆ™

**happens-before åŸåˆ™** æƒ³è¡¨è¾¾çš„æ„ä¹‰æ˜¯å‰ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹äºåä¸€ä¸ªæ“ä½œæ˜¯å¯è§çš„ï¼Œ**æ— è®ºè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œ**ï¼Œä¾‹å¦‚`æ“ä½œ 1 happens-before æ“ä½œ 2`ï¼Œå³ä½¿æ“ä½œ 1 å’Œæ“ä½œ 2 ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒJMM ä¹Ÿä¼šä¿è¯æ“ä½œ 1 çš„ç»“æœå¯¹æ“ä½œ 2 **æ˜¯å¯è§çš„**ï¼Œä¸”å¦‚æœä¸¤ä¸ªæ“ä½œä¸æ»¡è¶³ä»»æ„ä¸€ä¸ª `happens-before` è§„åˆ™ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œå°±æ²¡æœ‰é¡ºåºçš„ä¿éšœï¼ŒJVM å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œè¿›è¡Œé‡æ’åº,å¸¸è§çš„`happens-before`åŸåˆ™æœ‰ä»¥ä¸‹å‡ æ¡ï¼š

(1) å•ä¸€çº¿ç¨‹åŸåˆ™:åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼Œåœ¨ç¨‹åºå‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢çš„æ“ä½œ

(2) ç®¡ç¨‹é”å®šè§„åˆ™: ä¸€ä¸ª `unlock` æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹**åŒä¸€ä¸ªé”**çš„ `lock` æ“ä½œ

(3) volatile å˜é‡è§„åˆ™:å¯¹ä¸€ä¸ª `volatile` å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œ,å°±æ˜¯å¯¹ `volatile` å˜é‡çš„å†™æ“ä½œçš„ç»“æœå¯¹äºå‘ç”Ÿäºå…¶åçš„ä»»ä½•æ“ä½œéƒ½æ˜¯å¯è§çš„

(4) çº¿ç¨‹å¯åŠ¨è§„åˆ™:Thread å¯¹è±¡çš„ `start()` æ–¹æ³•è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œ 



```java
//å‡è®¾çº¿ç¨‹Aæ‰§è¡Œwriteræ–¹æ³•ï¼Œçº¿ç¨‹Bæ‰§è¡Œreaderæ–¹æ³•
class VolatileExample {
    int a = 0;
    volatile boolean flag = false;
    
    public void writer() {
        a = 1;              // 1 çº¿ç¨‹Aä¿®æ”¹å…±äº«å˜é‡
        flag = true;        // 2 çº¿ç¨‹Aå†™volatileå˜é‡
    } 
    
    public void reader() {
        if (flag) {         // 3 çº¿ç¨‹Bè¯»åŒä¸€ä¸ªvolatileå˜é‡
        int i = a;          // 4 çº¿ç¨‹Bè¯»å…±äº«å˜é‡
        â€¦â€¦
        }
    }
}
```

æ ¹æ® happens-before è§„åˆ™ï¼Œä¸Šé¢è¿‡ç¨‹ä¼šå»ºç«‹ 3 ç±» happens-before å…³ç³»:

- æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ 1 happens-before 2 ä¸” 3 happens-before 4
- **æ ¹æ® volatile è§„åˆ™ 2 happens-before 3**
- æ ¹æ® happens-before çš„ä¼ é€’æ€§è§„åˆ™ 1 happens-before 4





### å¯è§æ€§

å¯è§æ€§å³ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡(**å¦‚æœæ˜¯æ–¹æ³•å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹ä½äºæ ˆå†…çš„å±€éƒ¨å˜é‡è¡¨éƒ½æ˜¯ç§æœ‰çš„ï¼**)çš„ä¿®æ”¹åï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°,å¯è§æ€§é—®é¢˜ä¸»è¦æ˜¯å› ä¸ºCPUé«˜é€Ÿç¼“å­˜`cache`ä¸ä¸»å­˜ä¸­çš„å€¼ä¸ä¸€è‡´ï¼Œå½“ä¸€ä¸ªå…±äº«å˜é‡è¢«`volatile`ä¿®é¥°æ—¶ï¼Œå®ƒä¼šä¿è¯ä¿®æ”¹çš„å€¼ä¼šç«‹å³è¢«æ›´æ–°åˆ°ä¸»å­˜ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¼šå»å†…å­˜ä¸­è¯»å–æ–°å€¼ï¼Œè€Œ**æ™®é€šçš„å…±äº«å˜é‡ä¸èƒ½ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºæ™®é€šå…±äº«å˜é‡è¢«ä¿®æ”¹ä¹‹åï¼Œä»€ä¹ˆæ—¶å€™è¢«å†™å…¥ä¸»å­˜æ˜¯ä¸ç¡®å®šçš„**ï¼Œå½“å…¶ä»–çº¿ç¨‹å»è¯»å–æ—¶ï¼Œæ­¤æ—¶å†…å­˜ä¸­å¯èƒ½è¿˜æ˜¯åŸæ¥çš„æ—§å€¼ï¼Œå› æ­¤æ— æ³•ä¿è¯å¯è§æ€§

å•æ ¸CPUä¸å­˜åœ¨å¯è§æ€§é—®é¢˜ï¼

**åœ¨å•æ ¸æ—¶ä»£ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯åœ¨ä¸€é¢—CPUä¸Šæ‰§è¡Œï¼ŒCPUç¼“å­˜ä¸å†…å­˜çš„æ•°æ®ä¸€è‡´æ€§å®¹æ˜“è§£å†³**,**æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯æ“ä½œåŒä¸€ä¸ªCPUçš„ç¼“å­˜ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ç¼“å­˜çš„å†™ï¼Œå¯¹å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥è¯´ä¸€å®šæ˜¯å¯è§çš„**,ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Béƒ½æ˜¯æ“ä½œåŒä¸€ä¸ªCPUé‡Œé¢çš„ç¼“å­˜ï¼Œæ‰€ä»¥çº¿ç¨‹Aæ›´æ–°äº†å˜é‡Vçš„å€¼ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¹‹åå†è®¿é—®å˜é‡Vï¼Œå¾—åˆ°çš„ä¸€å®šæ˜¯Vçš„æœ€æ–°å€¼ï¼ˆçº¿ç¨‹Aå†™è¿‡çš„å€¼ï¼‰:

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%8F%AF%E8%A7%81%E6%80%A7.jpg" style="zoom: 80%;" />

è€Œåœ¨å¤šæ ¸æ—¶ä»£ï¼Œæ¯é¢—CPUéƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œè¿™æ—¶CPUç¼“å­˜ä¸å†…å­˜çš„æ•°æ®ä¸€è‡´æ€§å°±æ²¡é‚£ä¹ˆå®¹æ˜“è§£å†³äº†ï¼Œå½“**å¤šä¸ªçº¿ç¨‹åœ¨ä¸åŒçš„CPUä¸Šæ‰§è¡Œæ—¶ï¼Œè¿™äº›çº¿ç¨‹æ“ä½œçš„æ˜¯ä¸åŒçš„CPUç¼“å­˜**ã€‚æ¯”å¦‚ä¸‹å›¾ä¸­ï¼Œçº¿ç¨‹Aæ“ä½œçš„æ˜¯CPU-1ä¸Šçš„ç¼“å­˜ï¼Œè€Œçº¿ç¨‹Bæ“ä½œçš„æ˜¯CPU-2ä¸Šçš„ç¼“å­˜ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/jike-03-02.jpg" style="zoom: 80%;" />

çº¿ç¨‹Aã€Bç›¸ç»§(æˆ–åŒæ—¶ ä¸å½±å“)å…ˆä»ä¸»å­˜ä¸­è¯»å–æœ€æ–°çš„å˜é‡å€¼Vï¼Œç„¶ååœ¨å„è‡ªçš„CPUé«˜é€Ÿç¼“å­˜ä¸Š(å¤šæ ¸CPU)æ“ä½œæ•°æ®ï¼Œç„¶åå†æ”¾å›ä¸»å­˜ï¼Œè¿™æ ·å°±å‡ºç°äº†å¯è§æ€§é—®é¢˜ï¼Œè§£å†³åŠæ³•æ˜¯ï¼š**å¦‚æœå…¶ä¸­ä¸€ä¸ªcpuä¿®æ”¹äº†æ•°æ®ï¼Œä¼šé€šè¿‡æ€»çº¿ç«‹å³å›å†™åˆ°ä¸»å†…å­˜ä¸­ï¼Œå…¶ä»–cpué€šè¿‡æ€»çº¿å—…æ¢æœºåˆ¶æ„ŸçŸ¥åˆ°ç¼“å­˜ä¸­æ•°æ®çš„å˜åŒ–åï¼Œä¼šç«‹å³å°†å·¥ä½œå†…å­˜ä¸­çš„æ•°æ®å¤±æ•ˆï¼ŒåŒæ—¶å»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°æ•°æ®**

ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š

```java
//çº¿ç¨‹1æ‰§è¡Œçš„ä»£ç 
int i = 0;
i = 10;
 
//çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç 
j = i;
```

å‡è‹¥æ‰§è¡Œçº¿ç¨‹1çš„æ˜¯CPU1ï¼Œæ‰§è¡Œçº¿ç¨‹2çš„æ˜¯CPU2,å½“çº¿ç¨‹1æ‰§è¡Œ i =10æ—¶ï¼Œä¼šå…ˆæŠŠiçš„åˆå§‹å€¼åŠ è½½åˆ°CPU1çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œç„¶åèµ‹å€¼ä¸º10ï¼Œé‚£ä¹ˆåœ¨CPU1çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼å˜ä¸º10äº†ï¼Œå´æ²¡æœ‰ç«‹å³å†™å…¥åˆ°ä¸»å­˜å½“ä¸­,æ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œ j = iï¼Œå®ƒä¼šå…ˆå»ä¸»å­˜è¯»å–içš„å€¼å¹¶åŠ è½½åˆ°CPU2çš„ç¼“å­˜å½“ä¸­ï¼Œæ³¨æ„æ­¤æ—¶å†…å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—jçš„å€¼ä¸º0ï¼Œè€Œä¸æ˜¯10



ä½¿ç”¨`volatile`å®ç°å¯è§æ€§ï¼š

```java
public class TestVolatile {
    
    // å¦‚æœä¸åœ¨stopå‰ç”¨volatileä¿®é¥°ï¼Œmainçº¿ç¨‹å¯¹stopçš„ä¿®æ”¹Thread Aä¸èƒ½åŠæ—¶çœ‹åˆ°
    private static volatile  boolean stop = false;  
    public static void main(String[] args) {
        // Thread-A
        new Thread("Thread A") {
            @Override
            public void run() {
                while (!stop) {
                }
                System.out.println(Thread.currentThread() + " stopped");
            }
        }.start();

        // Thread-main
        try {
            TimeUnit.SECONDS.sleep(1);
            System.out.println(Thread.currentThread() + " after 1 seconds");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        stop = true;
    }
}


```

æŒ‰ç…§`main`æ–¹æ³•çš„é€»è¾‘ï¼Œå¦‚æœä¸åœ¨stopå‰ç”¨volatileä¿®é¥°ï¼Œå³ä½¿ä¸»çº¿ç¨‹å·²ç»æŠŠstopè®¾ç½®ä¸ºtrueï¼Œä»é€»è¾‘ä¸Šè®²å­çº¿ç¨‹å°±åº”è¯¥è·³å‡ºwhileæ­»å¾ªç¯ï¼Œä½†äº‹å®å¹¶ä¸æ˜¯è¿™æ ·ï¼Œè¿™æ˜¯å› ä¸ºå­çº¿ç¨‹è¯»å–çš„æ˜¯å‰¯æœ¬ï¼Œæ²¡æœ‰åŠæ—¶è¯»å–åˆ°ä¸»å†…å­˜ä¸­çš„æœ€æ–°ç»“æœ





`volatile` å˜é‡çš„å†…å­˜å¯è§æ€§æ˜¯åŸºäº**å†…å­˜å±éšœ**(Memory Barrier)å®ç°ï¼šç¨‹åºè¿è¡Œæ—¶ï¼Œä¸ºäº†æé«˜æ‰§è¡Œæ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼š**å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åº**ï¼Œ`JMM` ä¸ºäº†ä¿è¯åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œ CPU ä¸Šæœ‰ç›¸åŒçš„ç»“æœï¼Œä¼šé€šè¿‡æ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœæ¥ç¦æ­¢ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºï¼Œå¦‚æœå¯¹å£°æ˜äº† `volatile` çš„å˜é‡è¿›è¡Œå†™æ“ä½œï¼ŒJVM å°±ä¼šå‘å¤„ç†å™¨å‘é€ä¸€æ¡ `lock` å‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªå˜é‡æ‰€åœ¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼š

`lock` å‰ç¼€çš„æŒ‡ä»¤åœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹ä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…:

- **å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜**
- **å†™å›å†…å­˜çš„æ“ä½œä¼šä½¿åœ¨å…¶ä»– CPU é‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®æ— æ•ˆ**

ä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼ŒCPUå®ç°äº†**ç¼“å­˜ä¸€è‡´æ€§åè®®(MESI)**ï¼šæ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜çš„å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æˆæ— æ•ˆçŠ¶æ€ï¼Œç„¶åä»å†…å­˜ä¸­é‡è¯»è¯¥å˜é‡æ•°æ®ï¼Œå³å¯ä»¥è·å–å½“å‰æœ€æ–°å€¼(å½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ç³»ç»Ÿå†…å­˜ä¸­æŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜é‡Œ)



> MESI ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼š
>
> MESIè¡¨ç¤ºç¼“å­˜è¡Œçš„å››ç§çŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ï¼š
>
> 1ã€M(Modify) è¡¨ç¤ºå…±äº«æ•°æ®åªç¼“å­˜åœ¨å½“å‰ CPU ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯è¢«ä¿®æ”¹çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜çš„æ•°æ®å’Œä¸»å†…å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´
> 2ã€E(Exclusive) è¡¨ç¤ºç¼“å­˜çš„ç‹¬å çŠ¶æ€ï¼Œæ•°æ®åªç¼“å­˜åœ¨å½“å‰CPUç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«ä¿®æ”¹
> 3ã€S(Shared) è¡¨ç¤ºæ•°æ®å¯èƒ½è¢«å¤šä¸ª CPU ç¼“å­˜ï¼Œå¹¶ä¸”å„ä¸ªç¼“å­˜ä¸­çš„æ•°æ®å’Œä¸»å†…å­˜æ•°æ®ä¸€è‡´
> 4ã€I(Invalid) è¡¨ç¤ºç¼“å­˜å·²ç»å¤±æ•ˆ
>
> åœ¨ MESI åè®®ä¸­ï¼Œæ¯ä¸ªç¼“å­˜çš„ç¼“å­˜æ§åˆ¶å™¨ä¸ä»…çŸ¥é“è‡ªå·±çš„è¯»å†™æ“ä½œï¼Œè€Œä¸”ä¹Ÿç›‘å¬(snoop)å…¶å®ƒCPUçš„è¯»å†™æ“ä½œã€‚
>
> å¯¹äº MESI åè®®ï¼Œä» CPU è¯»å†™è§’åº¦æ¥è¯´ä¼šéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
>
> **CPUè¯»è¯·æ±‚**ï¼šç¼“å­˜å¤„äº Mã€Eã€S çŠ¶æ€éƒ½å¯ä»¥è¢«è¯»å–ï¼ŒI çŠ¶æ€CPU åªèƒ½ä»ä¸»å­˜ä¸­è¯»å–æ•°æ®
> **CPUå†™è¯·æ±‚**ï¼šç¼“å­˜å¤„äº Mã€E çŠ¶æ€æ‰å¯ä»¥è¢«å†™ã€‚å¯¹äºSçŠ¶æ€çš„å†™ï¼Œéœ€è¦å°†å…¶ä»–CPUä¸­ç¼“å­˜è¡Œç½®ä¸ºæ— æ•ˆæ‰è¡Œã€‚







### åŸå­æ€§ :astonished::astonished:

ä¼—æ‰€å‘¨çŸ¥ `volatile`ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼š**å¯¹`volatile`å˜é‡çš„å•æ¬¡è¯»/å†™æ“ä½œå¯ä»¥ä¿è¯åŸå­æ€§çš„**ï¼Œå¦‚longå’Œdoubleç±»å‹å˜é‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯i++è¿™ç§æ“ä½œçš„åŸå­æ€§ï¼Œå› ä¸ºæœ¬è´¨ä¸Ši++æ˜¯è¯»ã€å†™ä¸¤æ¬¡æ“ä½œï¼ŒJavaä¸­åªæœ‰å¯¹åŸºæœ¬ç±»å‹å˜é‡çš„èµ‹å€¼å’Œè¯»å–æ˜¯åŸå­æ“ä½œ(å¦‚i = 1çš„èµ‹å€¼æ“ä½œï¼Œä½†æ˜¯åƒj = iæˆ–è€…i++è¿™æ ·çš„æ“ä½œéƒ½ä¸æ˜¯åŸå­æ“ä½œ)ï¼Œå¦‚æœä¸€ä¸ªå˜é‡è¢«volatileä¿®é¥°äº†ï¼Œé‚£ä¹ˆè‚¯å®šå¯ä»¥ä¿è¯æ¯æ¬¡è¯»å–è¿™ä¸ªå˜é‡å€¼çš„æ—¶å€™å¾—åˆ°çš„å€¼æ˜¯æœ€æ–°çš„â€”â€”å•æ¬¡è¯»/å†™æ“ä½œå¯ä»¥ä¿è¯åŸå­æ€§ï¼Œè€Œä¸€æ—¦éœ€è¦å¯¹å˜é‡è¿›è¡Œè‡ªå¢è¿™æ ·çš„éåŸå­æ“ä½œï¼Œå°±ä¸ä¼šä¿è¯è¿™ä¸ªå˜é‡çš„åŸå­æ€§



**ç–‘é—®â“â“â“**

ç½‘ä¸Šå¤§å¤šæ•°åšå®¢æ˜¯è¿™æ ·è§£é‡Šçš„ï¼šâ€œå‡è®¾æŸä¸€æ—¶åˆ»i=5ï¼Œæ­¤æ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä»ä¸»å­˜ä¸­è¯»å–äº†içš„å€¼ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹ä¿å­˜çš„içš„å€¼éƒ½æ˜¯5ï¼Œ æ­¤æ—¶Açº¿ç¨‹å¯¹iè¿›è¡Œäº†è‡ªå¢è®¡ç®—ï¼Œç„¶åBä¹Ÿå¯¹iè¿›è¡Œè‡ªå¢è®¡ç®—ï¼Œæ­¤æ—¶ä¸¤æ¡çº¿ç¨‹æœ€ååˆ·æ–°å›ä¸»å­˜çš„içš„å€¼éƒ½æ˜¯6ï¼ˆæœ¬æ¥ä¸¤æ¡çº¿ç¨‹è®¡ç®—å®Œåº”å½“æ˜¯7ï¼‰ï¼Œæ‰€ä»¥è¯´`volatile`ä¿è¯ä¸äº†åŸå­æ€§â€

ä¸Šè¿°è¿™ç§è§£é‡Šæ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘çš„ä¸è§£ä¹‹å¤„åœ¨äºï¼š

æ—¢ç„¶iæ˜¯è¢«volatileä¿®é¥°çš„å˜é‡ï¼Œé‚£ä¹ˆå¯¹äºiçš„æ“ä½œåº”è¯¥æ˜¯çº¿ç¨‹ä¹‹é—´æ˜¯å¯è§çš„å•Šï¼Œå°±ç®—A Bä¸¤ä¸ªçº¿ç¨‹éƒ½åŒæ—¶è¯»åˆ°içš„å€¼æ˜¯5ï¼Œ**ä½†æ˜¯å¦‚æœAçº¿ç¨‹æ‰§è¡Œå®Œiçš„æ“ä½œä»¥ååº”è¯¥ä¼šæŠŠBçº¿ç¨‹è¯»åˆ°çš„içš„å€¼ç½®ä¸ºæ— æ•ˆå¹¶å¼ºåˆ¶Bé‡æ–°è¯»å…¥içš„æ–°å€¼**ï¼Œä¹Ÿå°±æ˜¯6ç„¶åæ‰ä¼šè¿›è¡Œè‡ªå¢æ“ä½œæ‰å¯¹ï¼Œåæ¥å‚ç…§å…¶ä»–åšå®¢ç»ˆäºæƒ³é€šäº†ï¼Œå› ä¸ºi++çš„æ“ä½œåº•å±‚å®ç°å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š

```
1ã€çº¿ç¨‹è¯»å–i

2ã€temp = i + 1

3ã€i = temp
```

**æ­£ç¡®è§£é‡Šä¸ºï¼š**

(1) å½“ i=5 çš„æ—¶å€™A,Bä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¯»å…¥äº† i çš„å€¼ï¼Œ ç„¶åAçº¿ç¨‹æ‰§è¡Œäº† `temp = i + 1`çš„æ“ä½œï¼Œæ³¨æ„æ­¤æ—¶i çš„å€¼è¿˜æ²¡æœ‰å˜åŒ–

(2) ç„¶å B çº¿ç¨‹ä¹Ÿæ‰§è¡Œäº† `temp = i + 1`çš„æ“ä½œï¼Œ**æ­¤æ—¶Aï¼ŒBä¸¤ä¸ªçº¿ç¨‹ä¿å­˜çš„ i çš„å€¼éƒ½æ˜¯ 5ï¼Œtemp çš„å€¼éƒ½æ˜¯ 6** 

(3) æ¥ç€ A çº¿ç¨‹æ‹¿åˆ°CPUä½¿ç”¨æƒï¼Œæ‰§è¡Œäº† `i = temp ï¼ˆ6ï¼‰`æ“ä½œï¼Œæ­¤æ—¶içš„å€¼ä¼šç«‹å³åˆ·æ–°åˆ°ä¸»å­˜å¹¶é€šçŸ¥å…¶ä»–çº¿ç¨‹ä¿å­˜çš„ i å€¼å¤±æ•ˆï¼Œæ­¤æ—¶Bçº¿ç¨‹éœ€è¦é‡æ–°è¯»å–içš„å€¼ é‚£ä¹ˆæ­¤æ—¶Bçº¿ç¨‹ä¿å­˜çš„iå€¼ä¸º6ï¼ŒåŒæ—¶Bçº¿ç¨‹ä¿å­˜çš„tempå€¼ä»ç„¶æ˜¯6

(4) ç„¶åBçº¿ç¨‹æ‰§è¡Œ i=tempï¼ˆ6ï¼‰ï¼Œæ‰€ä»¥å¯¼è‡´äº†è®¡ç®—ç»“æœæ¯”é¢„æœŸå°‘äº†1

å®é™…ä¸Šä¹Ÿæ˜¯ç›¸å½“äºAçš„æ“ä½œè¢«è¦†ç›–æ‰äº†ï¼Œä½†æ˜¯è¿™ç§ç†è§£åœ¨è§£é‡Šäº†`volatile`èƒ½ä¿è¯å¯è§æ€§çš„åŒæ—¶ï¼Œä¹ŸéªŒè¯äº†ä¸ä¸€å®šèƒ½ä¿è¯åŸå­æ€§ï¼



### æœ‰åºæ€§ :computer:

å†æ¥åˆ†ææœ‰åºæ€§ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å•ä¾‹å®ç°æ–¹å¼ï¼Œé€šå¸¸å¯ä»¥é‡‡ç”¨åŒé‡æ ¡éªŒæ£€æŸ¥åŠ é”(DCL)çš„æ–¹å¼æ¥å®ç°ï¼š

```java
public class Singleton {
    public static volatile Singleton singleton;
    /**
     * æ„é€ å‡½æ•°ç§æœ‰ï¼Œç¦æ­¢å¤–éƒ¨å®ä¾‹åŒ–
     */
    private Singleton() {};
    public static Singleton getInstance() {
        if (singleton == null) {
            synchronized (singleton.class) {
                if (singleton == null) {
                    singleton = new Singleton();
                }
            }
        }
        return singleton;
    }
}
```

> è¡¥å……:
>
> å•ä¾‹æ¨¡å¼åˆ†ä¸º**éå»¶è¿ŸåŠ è½½ï¼ˆé¥¿æ±‰å¼ï¼‰å’Œå»¶è¿ŸåŠ è½½ï¼ˆæ‡’æ±‰å¼ï¼‰**ï¼Œå»¶è¿ŸåŠ è½½å¯ä»¥æœ‰æ•ˆæé«˜ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨æ•ˆç‡ï¼Œæ‰€ä»¥é€šå¸¸ä½¿ç”¨å»¶è¿ŸåŠ è½½æ¥å®ç°,ä½†æ˜¯å»¶è¿ŸåŠ è½½æ¶‰åŠåˆ°çº¿ç¨‹å®‰å…¨é—®é¢˜(å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥`getInstance()`æ–¹æ³•å†…ï¼Œæ•…éœ€è¦åŠ åŒæ­¥é”æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨)



ç°åœ¨åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åœ¨å¼•ç”¨å˜é‡`singleton`ä¹‹é—´åŠ ä¸Š`volatile`å…³é”®å­— ï¼Œè¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå…ˆè¦äº†è§£å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å…¶å®å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

- åˆ†é…å†…å­˜ç©ºé—´
- åˆå§‹åŒ–å¯¹è±¡
- å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨





ä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿå¯ä»¥`å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åº`ï¼Œæ‰€ä»¥ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šå˜æˆå¦‚ä¸‹è¿‡ç¨‹ï¼š

- åˆ†é…å†…å­˜ç©ºé—´
- å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨
- åˆå§‹åŒ–å¯¹è±¡

å¦‚æœæ˜¯è¿™ä¸ªæµç¨‹ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±å¯èƒ½å°†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å¯¹è±¡å¼•ç”¨æš´éœ²å‡ºæ¥ï¼Œå› æ­¤ä¸ºäº†é˜²æ­¢è¿™ä¸ªè¿‡ç¨‹çš„é‡æ’åºï¼Œéœ€è¦å°†å˜é‡è®¾ç½®ä¸º`volatile`ç±»å‹çš„å˜é‡



`happens-before` è§„åˆ™ä¸­æœ‰ä¸€æ¡ `volatile` å˜é‡è§„åˆ™ï¼š**å¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens-before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»**



ä¸ºäº†å®ç° `volatile` å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­**æ’å…¥å†…å­˜å±éšœ**æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºï¼š

- åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª StoreStore å±éšœ
- åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœ
- åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœ
- åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadStore å±éšœ

volatile å†™æ“ä½œæ˜¯åœ¨å‰é¢å’Œåé¢åˆ†åˆ«æ’å…¥å†…å­˜å±éšœï¼Œè€Œ volatile è¯»æ“ä½œæ˜¯åœ¨åé¢æ’å…¥ä¸¤ä¸ªå†…å­˜å±éšœ

| å†…å­˜å±éšœ        | è¯´æ˜                                                        |
| --------------- | ----------------------------------------------------------- |
| StoreStore å±éšœ | ç¦æ­¢å‰é¢çš„æ™®é€šå†™å’Œåé¢çš„ volatile å†™é‡æ’åºã€‚                |
| StoreLoad å±éšœ  | é˜²æ­¢å‰é¢çš„ volatile å†™ä¸åé¢å¯èƒ½æœ‰çš„ volatile è¯»/å†™é‡æ’åºã€‚ |
| LoadLoad å±éšœ   | ç¦æ­¢å‰é¢æ‰€æœ‰çš„æ™®é€šè¯»æ“ä½œå’Œåé¢çš„ volatile è¯»é‡æ’åºã€‚        |
| LoadStore å±éšœ  | ç¦æ­¢åé¢æ‰€æœ‰çš„æ™®é€šå†™æ“ä½œå’Œå‰é¢çš„ volatile è¯»é‡æ’åºã€‚        |









### ä¸synchronizedåŒºåˆ«ï¼Ÿ

> å•ä¾‹æ¨¡å¼çš„åŒé‡æ£€éªŒé”ä¸­ï¼Œ`synchronized`å·²ç»å…·å¤‡äº†åŸå­æ€§ã€æœ‰åºæ€§å’Œå¯è§æ€§ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦`volatile`ï¼Ÿ

é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼š`synchronized`æ˜¯æ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’å’Œå¤„ç†å™¨ä¼˜åŒ–çš„ã€‚é‚£ä¹ˆ`synchronized`å¦‚ä½•ä¿è¯æœ‰åºæ€§å‘¢ï¼Ÿ

è¿™é‡Œéœ€è¦æ‰©å±•ä¸€ä¸‹æœ‰åºæ€§çš„æ¦‚å¿µï¼ŒJavaç¨‹åºä¸­å¤©ç„¶çš„æœ‰åºæ€§å¯ä»¥æ€»ç»“æˆä¸€å¥è¯ï¼šå¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯å¤©ç„¶æœ‰åºçš„ã€‚å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚ä»¥ä¸Šè¿™å¥è¯æ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­çš„åŸå¥ï¼Œä½†æ˜¯æ€ä¹ˆç†è§£å‘¢ï¼Ÿè¿™é‡Œå…¶å®å’Œ `as-if-serial`çš„è¯­ä¹‰æœ‰å…³

`as-if-serial`çš„è¯­ä¹‰æ˜¯ï¼šä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœéƒ½ä¸èƒ½è¢«æ”¹å˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`as-if-serial`ä¿è¯äº†åœ¨å•çº¿ç¨‹ä¸­ï¼Œä¸ç®¡æŒ‡ä»¤æ€ä¹ˆé‡æ’ï¼Œæœ€ç»ˆçš„æ‰§è¡Œç»“æœæ˜¯ä¸èƒ½è¢«æ”¹å˜çš„ã€‚å› æ­¤ï¼Œ`synchronized`ä¿è¯çš„æœ‰åºæ€§å®é™…ä¸Šæ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„æœ‰åºæ€§ï¼Œå³è¢«åŠ é”çš„å†…å®¹è¦æŒ‰ç…§é¡ºåºè¢«å¤šä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä½†æ˜¯å…¶å†…éƒ¨çš„åŒæ­¥ä»£ç è¿˜æ˜¯ä¼šå‘ç”Ÿé‡æ’åºï¼Œå› æ­¤è¿˜æ˜¯éœ€è¦`volatile`



https://blog.csdn.net/bochuangli/article/details/122862651











## ThreadLocal

å®ç°çº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- äº’æ–¥åŒæ­¥: `synchronized` å’Œ `ReentrantLock`
- éé˜»å¡åŒæ­¥: `CAS`ã€ `AtomicXXXX`
- æ— åŒæ­¥æ–¹æ¡ˆ: æ ˆå°é—­ï¼Œ**æœ¬åœ°å­˜å‚¨**(Thread Local)ï¼Œå¯é‡å…¥ä»£ç 

è€Œ`ThreadLocal`ç±»åœ¨å¤šçº¿ç¨‹ä¸­ä¼šä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å˜é‡å‰¯æœ¬; å½“ä½¿ç”¨`ThreadLocal`æ¥ç»´æŠ¤å˜é‡æ—¶, `ThreadLocal`ä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºå•ç‹¬çš„å˜é‡å‰¯æœ¬, é¿å…å› å¤šçº¿ç¨‹æ“ä½œå…±äº«å˜é‡è€Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚å³`ThreadLocal`ç±»å¯ä»¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡`get()`å’Œ`set()`æ¥è·å–é»˜è®¤å€¼æˆ–å°†å…¶å€¼æ›´æ”¹ä¸ºå½“å‰çº¿ç¨‹æ‰€å­˜çš„å‰¯æœ¬çš„å€¼



### ç”¨æ³•

ä¾‹å¦‚ç®¡ç†æ•°æ®åº“è¿æ¥æ—¶ï¼Œå¦‚æœä¸€ç›´æ˜¯å•çº¿ç¨‹æ“ä½œï¼Œä¸‹åˆ—ä»£ç æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š

```java
class ConnectionManager {
    private static Connection connect = null; 

    public static Connection openConnection() {
        if (connect == null) {
            connect = DriverManager.getConnection(); //å»ºç«‹æ•°æ®åº“è¿æ¥
        }
        return connect;
    }

    public static void closeConnection() {
        if (connect != null)
            connect.close();
    }
}

```

è€Œåœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š

ç¬¬ä¸€ï¼Œè¿™é‡Œé¢çš„2ä¸ªæ–¹æ³•éƒ½æ²¡æœ‰è¿›è¡ŒåŒæ­¥ï¼Œå¾ˆå¯èƒ½åœ¨`openConnection()`æ–¹æ³•ä¸­ä¼šå¤šæ¬¡åˆ›å»º`connect`

ç¬¬äºŒï¼Œç”±äº`connect`æ˜¯å…±äº«å˜é‡(å®é™…ä¸Šä¹Ÿä¸éœ€è¦è®¾è®¡ä¸ºå…±äº«å˜é‡,å› ä¸ºå„ä¸ªçº¿ç¨‹ä¹‹é—´å¯¹connectå˜é‡çš„è®¿é—®å®é™…ä¸Šæ˜¯æ²¡æœ‰ä¾èµ–å…³ç³»çš„ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¸éœ€è¦å…³å¿ƒå…¶ä»–çº¿ç¨‹æ˜¯å¦å¯¹è¿™ä¸ª`connect`è¿›è¡Œäº†ä¿®æ”¹)ï¼Œé‚£ä¹ˆå¿…ç„¶åœ¨è°ƒç”¨`connect`çš„åœ°æ–¹éœ€è¦ä½¿ç”¨åˆ°åŒæ­¥æ¥ä¿éšœçº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºå¾ˆå¯èƒ½ä¸€ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨`connect`è¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨`closeConnection()`å…³é—­è¿æ¥

è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨`ThreaLocal`ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªè¯¥è¿æ¥å˜é‡çš„å‰¯æœ¬ï¼Œçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ï¼š

```java
public class ConnectionManager {

    //ç±»ä¼¼hashmap 
    private static final ThreadLocal<Connection> dbConnectionLocal = new ThreadLocal<Connection>()
    {
        @Override
        protected Connection initialValue() {
            try {
                return DriverManager.getConnection("", "", ""); //åˆ›å»ºçº¿ç¨‹å±€éƒ¨å˜é‡
            } catch (SQLException e) {
                e.printStackTrace();
            }
            return null;
        }
    };

    public Connection getConnection() {
        return dbConnectionLocal.get();
    }
}
```

ä¸Šè¿°ä»£ç é‡Œ`dbConnectionLocal` è¿™ä¸ªå˜é‡ä¸ºKey, ä»¥æ–°å»ºçš„`Connectionå¯¹è±¡`ä¸º`Value`; ï¼Œ`ThreadLocal`ç±»æä¾›äº†ä¸€ä¸ª`initialValue()`æ–¹æ³•ï¼Œç”¨äºåœ¨æ¯ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è¯¥å˜é‡æ—¶æä¾›ä¸€ä¸ªåˆå§‹å€¼ã€‚è¯¥æ–¹æ³•æ˜¯`ThreadLocal`ç±»çš„æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªåˆå§‹å€¼ï¼Œç”¨äºåˆå§‹åŒ–è°ƒç”¨çº¿ç¨‹çš„å±€éƒ¨å˜é‡ã€‚å½“ç¬¬ä¸€æ¬¡è®¿é—®`ThreadLocal`å¯¹è±¡çš„`get()`æˆ–`set()`æ–¹æ³•æ—¶ï¼Œ**å¦‚æœè¯¥çº¿ç¨‹å°šæœªä½¿ç”¨set()æ–¹æ³•è®¾ç½®è¿‡åˆå§‹å€¼ï¼Œé‚£ä¹ˆ`initialValue()`æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨**

```java
protected T initialValue() {
        return null;
    }
```



### ThreadLocalMap

`Thread` ç±»ä¸­æœ‰ä¸€ä¸ª `threadLocals` å’Œ ä¸€ä¸ª `inheritableThreadLocals` å˜é‡ï¼Œå®ƒä»¬éƒ½æ˜¯ `ThreadLocalMap` ç±»å‹çš„å˜é‡,å¯ä»¥æŠŠ `ThreadLocalMap` ç†è§£ä¸º`ThreadLocal` ç±»å®ç°çš„å®šåˆ¶åŒ–çš„ `HashMap`:

```java
  //Threadç±»ä¸­æœ‰ä¸¤ä¸ªThreadLocalMapç±»å‹çš„å˜é‡
  ThreadLocal.ThreadLocalMap threadLocals = null;
  ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
```

é»˜è®¤æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå˜é‡éƒ½æ˜¯ nullï¼Œåªæœ‰å½“å‰çº¿ç¨‹è°ƒç”¨ `ThreadLocal` ç±»çš„ `set`æˆ–`get`æ–¹æ³•æ—¶æ‰åˆ›å»ºå®ƒä»¬ï¼Œå½“å½“å‰çº¿ç¨‹è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯`ThreadLocalMap`ç±»å¯¹åº”çš„ `get()`ã€`set()`æ–¹æ³•ï¼š

`ThreadLocal`ç±»ä¸­çš„`set()`æ–¹æ³•ï¼Œæ³¨æ„[ThreadLocalMapçº¿æ€§æ¢æµ‹æ³•è§£å†³hashå†²çª](https://blog.csdn.net/xiaoxiaodaxiake/article/details/107732928)ï¼š

```java
public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t); //è·å–åˆ°å½“å‰çº¿ç¨‹çš„threadlocalmapå˜é‡
        if (map != null) {
            map.set(this, value);   //è°ƒç”¨ThreadLocalçš„é™æ€å†…éƒ¨ç±»ThreadLocalMapä¸­çš„set()æ–¹æ³•
        } else {
            createMap(t, value);
        }
    }


ThreadLocalMap getMap(Thread t) {
        return t.threadLocals;
    }

  
private void set(ThreadLocal<?> key, Object value) {
            Entry[] tab = table;
            int len = tab.length;
            int i = key.threadLocalHashCode & (len-1); //æ ¹æ®ThreadLocalå¯¹è±¡çš„hashå€¼ï¼Œå®šä½åˆ°tableä¸­çš„ä½ç½®i

            for (Entry e = tab[i];
                 e != null;
                 e = tab[i = nextIndex(i, len)]) {
                if (e.refersTo(key)) {
                    //å¦‚æœä½ç½®iä¸ä¸ºç©ºï¼Œä¸”è¿™ä¸ªEntryå¯¹è±¡çš„keyæ­£å¥½æ˜¯å³å°†è®¾ç½®çš„keyï¼Œé‚£ä¹ˆå°±åˆ·æ–°Entryä¸­çš„value
                    e.value = value;
                    return;
                }

                if (e.refersTo(null)) {//å¦‚æœå½“å‰ä½ç½®æ˜¯ç©ºçš„ï¼Œå°±åˆå§‹åŒ–ä¸€ä¸ªEntryå¯¹è±¡æ”¾åœ¨ä½ç½®iä¸Šï¼›
                    replaceStaleEntry(key, value, i);
                    return;
                }
            }

            tab[i] = new Entry(key, value);
            int sz = ++size;
            if (!cleanSomeSlots(i, sz) && sz >= threshold)
                rehash();
        }   
```

`ThreadLocal`ç±»ä¸­çš„`get()`æ–¹æ³•åŒç†ï¼š

```java
public T get() {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;
                return result;
            }
        }
        return setInitialValue();//å¦‚æœçº¿ç¨‹æ²¡æœ‰è°ƒç”¨set()æ–¹æ³•å¯¹threadlocalå˜é‡èµ‹å€¼ï¼Œåˆ™è¿”å›é»˜è®¤å€¼
    }


ThreadLocalMap getMap(Thread t) {
        return t.threadLocals;
    }


private Entry getEntry(ThreadLocal<?> key) {
            int i = key.threadLocalHashCode & (table.length - 1);
            Entry e = table[i];
            if (e != null && e.refersTo(key))
                return e;
            else
                return getEntryAfterMiss(key, i, e);
        }
```



å†æ¥çœ‹ä¸€ä¸ªå£°æ˜äº†å¤šä¸ª`ThreadLocal`å˜é‡çš„ä¾‹å­ï¼š

```java
public class ThreadLocalExample {
    private static ThreadLocal<String> threadLocal1 = new ThreadLocal<>();
    private static ThreadLocal<Integer> threadLocal2 = new ThreadLocal<>();

    public static void main(String[] args) {
        threadLocal1.set("Hello");
        threadLocal2.set(42);

        Thread thread1 = new Thread(() -> {
            threadLocal1.set("Thread 1");
            threadLocal2.set(10);

            System.out.println("Thread 1 - ThreadLocal1: " + threadLocal1.get());
            System.out.println("Thread 1 - ThreadLocal2: " + threadLocal2.get());
        });

        Thread thread2 = new Thread(() -> {
            threadLocal1.set("Thread 2");
            threadLocal2.set(20);

            System.out.println("Thread 2 - ThreadLocal1: " + threadLocal1.get());
            System.out.println("Thread 2 - ThreadLocal2: " + threadLocal2.get());
        });

        thread1.start();
        thread2.start();

        System.out.println("Main Thread - ThreadLocal1: " + threadLocal1.get());
        System.out.println("Main Thread - ThreadLocal2: " + threadLocal2.get());
    }
}

```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸¤ä¸ª`ThreadLocal`å˜é‡(å±äºç±»)ï¼š`threadLocal1`å’Œ`threadLocal2`ï¼Œæ¯ä¸ª`ThreadLocal`å˜é‡éƒ½ä¸å½“å‰çº¿ç¨‹çš„`ThreadLocalMap`å®ä¾‹ç›¸å…³è”

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥åˆ†æä¸»çº¿ç¨‹çš„`ThreadLocalMap`æƒ…å†µï¼š

```java
Main Thread:
ThreadLocal1 -> "Hello"
ThreadLocal2 -> 42
```

ä¸»çº¿ç¨‹çš„`ThreadLocalMap`ä¸­å­˜å‚¨äº†ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œåˆ†åˆ«æ˜¯`ThreadLocal1 -> "Hello"`å’Œ`ThreadLocal2 -> 42`ã€‚è¿™äº›å€¼æ˜¯åœ¨`main`æ–¹æ³•ä¸­é€šè¿‡`threadLocal1.set("Hello")`å’Œ`threadLocal2.set(42)`è®¾ç½®çš„

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æ`thread1`çº¿ç¨‹çš„`ThreadLocalMap`æƒ…å†µï¼š

```java
Thread 1:
ThreadLocal1 -> "Thread 1"
ThreadLocal2 -> 10
```

`thread1`çº¿ç¨‹çš„`ThreadLocalMap`ä¸­å­˜å‚¨äº†ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œåˆ†åˆ«æ˜¯`ThreadLocal1 -> "Thread 1"`å’Œ`ThreadLocal2 -> 10`ã€‚è¿™äº›å€¼æ˜¯åœ¨`thread1`çš„çº¿ç¨‹ä½“å†…é€šè¿‡`threadLocal1.set("Thread 1")`å’Œ`threadLocal2.set(10)`è®¾ç½®çš„



æœ€åï¼Œæˆ‘ä»¬åˆ†æthread2çº¿ç¨‹çš„ThreadLocalMapæƒ…å†µï¼š

```java
Thread 2:
ThreadLocal1 -> "Thread 2"
ThreadLocal2 -> 20

```

thread2çº¿ç¨‹çš„`ThreadLocalMap`ä¸­ä¹Ÿå­˜å‚¨äº†ä¸¤ä¸ªé”®å€¼å¯¹ï¼Œåˆ†åˆ«æ˜¯`ThreadLocal1 -> "Thread 2"`å’Œ`ThreadLocal2 -> 20`ã€‚è¿™äº›å€¼æ˜¯åœ¨`thread2`çš„çº¿ç¨‹ä½“å†…é€šè¿‡`threadLocal1.set("Thread 2")`å’Œ`threadLocal2.set(20)`è®¾ç½®çš„ã€‚

æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹åœ°ç®¡ç†å…¶è‡ªå·±çš„`ThreadLocalMap`ï¼Œå› æ­¤æ¯ä¸ªçº¿ç¨‹å¯¹`ThreadLocal`å˜é‡çš„æ›´æ”¹ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„`ThreadLocal`å˜é‡ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å…·æœ‰ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

```java
private static ThreadLocal<String> ThreadLocal1 = new ThreadLocal<>();
private static ThreadLocal<Integer> ThreadLocal2 = new ThreadLocal<>();
private static ThreadLocal<Character> ThreadLocal3 = new ThreadLocal<>();

/*å¼€å¯ä¸‰ä¸ªçº¿ç¨‹å¹¶è°ƒç”¨set()æ–¹æ³•*/
 Thread thread1 = new Thread(() -> {
            ThreadLocal1.set(value1);
            ThreadLocal2.set(value4);
            ThreadLocal2.set(value7);
        });

//åé¢çœç•¥
```

ä¾‹å¦‚æ‰§è¡Œä»¥ä¸Šä»£ç åï¼Œ`threadlocalmap`çš„å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/threadlocalmap.webp)



### Javaå¼•ç”¨

Javaæ•°æ®ç±»å‹åªæœ‰ä¸¤ç§ï¼šåŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹ï¼Œä¾‹å¦‚ï¼š

```java
Object obj=new Object();
```

`obj`å°±æ˜¯å¼•ç”¨ç±»å‹ï¼ŒæŒ‡å‘å †ä¸­çš„å®ä¾‹å¯¹è±¡

è€ŒJavaä¸ºäº†é¿å…å‡ºç°`OutOfMemoryError`é”™è¯¯ï¼Œä¼šæ‰§è¡Œ`Garbage Collection`æ¥ä¸å®šæ—¶å›æ”¶**æ— ä»»ä½•å¯¹è±¡å¼•ç”¨**çš„å¯¹è±¡å æ®çš„å†…å­˜ç©ºé—´ï¼ŒJVMå¦‚ä½•æ‰¾åˆ°éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼š

- å¼•ç”¨è®¡æ•°æ³•ï¼šæ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°å±æ€§ï¼Œæ–°å¢ä¸€ä¸ªå¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨æ—¶è®¡æ•°å™¨åŠ 1ï¼Œå¼•ç”¨é‡Šæ”¾æ—¶è®¡æ•°å‡1ï¼Œè®¡æ•°ä¸º0æ—¶åˆ™å¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶
- å¯è¾¾æ€§åˆ†ææ³•ï¼šä» `GC Roots` å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ã€‚å½“ä¸€ä¸ªå¯¹è±¡åˆ° `GC Roots` æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±åˆ¤æ–­æ˜¯å¯å›æ”¶å¯¹è±¡



ä»`JDK 1.2`ç‰ˆæœ¬å¼€å§‹ï¼Œå¯¹è±¡çš„å¼•ç”¨è¢«åˆ’åˆ†ä¸º`4`ç§çº§åˆ«ï¼Œä»è€Œä½¿ç¨‹åºèƒ½æ›´åŠ çµæ´»åœ°æ§åˆ¶**å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ**ã€‚è¿™`4`ç§çº§åˆ«**ç”±é«˜åˆ°ä½**ä¾æ¬¡ä¸ºï¼š**å¼ºå¼•ç”¨**ã€**è½¯å¼•ç”¨**ã€**å¼±å¼•ç”¨**å’Œ**è™šå¼•ç”¨**ï¼š

1. **å¼ºå¼•ç”¨ ** æ˜¯ä½¿ç”¨æœ€æ™®éçš„å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼ºå¼•ç”¨ï¼Œé‚£**åƒåœ¾å›æ”¶å™¨**ç»ä¸ä¼šå›æ”¶å®ƒã€‚å¦‚ä¸‹ï¼š

```java
   Object strongReference = new Object();
```

 å¦‚æœå¼ºå¼•ç”¨å¯¹è±¡**ä¸ä½¿ç”¨æ—¶**ï¼Œéœ€è¦å¼±åŒ–ä»è€Œä½¿`GC`èƒ½å¤Ÿå›æ”¶ï¼Œæ˜¾å¼åœ°è®¾ç½®`strongReference`æŒ‡å‘ä¸º`null`ï¼Œåˆ™JVMè®¤ä¸ºè¯¥å¯¹è±¡**ä¸å­˜åœ¨å¼•ç”¨**ï¼Œè¿™æ—¶å°±å¯ä»¥å›æ”¶è¿™ä¸ªå¯¹è±¡ï¼š

```java
strongReference = null;
```



å¦‚æœåœ¨ä¸€ä¸ª**æ–¹æ³•çš„å†…éƒ¨**æœ‰ä¸€ä¸ª**å¼ºå¼•ç”¨**ï¼Œè¿™ä¸ªå¼•ç”¨ä¿å­˜åœ¨`Java`**æ ˆ**ä¸­ï¼Œè€ŒçœŸæ­£çš„å®ä¾‹(`Object`)ä¿å­˜åœ¨`Java`**å †**ä¸­ã€‚ å½“è¿™ä¸ª**æ–¹æ³•è¿è¡Œå®Œæˆ**åï¼Œå°±ä¼šé€€å‡º**æ–¹æ³•æ ˆ**ï¼Œåˆ™å¼•ç”¨å¯¹è±¡çš„**å¼•ç”¨æ•°**ä¸º`0`ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«å›æ”¶

```java
public void test() {
        Object strongReference = new Object();
        // çœç•¥å…¶ä»–æ“ä½œ
    }
```

ä½†æ˜¯å¦‚æœè¿™ä¸ª`strongReference`æ˜¯**å…¨å±€å˜é‡**æ—¶ï¼Œå°±éœ€è¦åœ¨ä¸ç”¨è¿™ä¸ªå¯¹è±¡æ—¶èµ‹å€¼ä¸º`null`ï¼Œå› ä¸º**å¼ºå¼•ç”¨**ä¸ä¼šè¢«åƒåœ¾å›æ”¶ï¼



2. **è½¯å¼•ç”¨** å¦‚æœä¸€ä¸ªå¯¹è±¡åªå…·æœ‰**è½¯å¼•ç”¨**ï¼Œåˆ™**å†…å­˜ç©ºé—´å……è¶³**æ—¶ï¼Œ**åƒåœ¾å›æ”¶å™¨**å°±**ä¸ä¼š**å›æ”¶å®ƒï¼›å¦‚æœ**å†…å­˜ç©ºé—´ä¸è¶³**äº†ï¼Œå°±ä¼š**å›æ”¶**è¿™äº›å¯¹è±¡çš„å†…å­˜ã€‚åªè¦åƒåœ¾å›æ”¶å™¨æ²¡æœ‰å›æ”¶å®ƒï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«ç¨‹åºä½¿ç”¨ï¼Œå¯¹æ¯”ä¸€ä¸‹å¼ºå¼•ç”¨å’Œè½¯å¼•ç”¨ï¼Œè½¯å¼•ç”¨éœ€è¦å€ŸåŠ©`SoftReference`ï¼š

```
// å¼ºå¼•ç”¨
String strongReference = new String("abc");
// è½¯å¼•ç”¨
String str = new String("abc");
SoftReference<String> softReference = new SoftReference<String>(str);

```

**è½¯å¼•ç”¨**å¯ä»¥å’Œä¸€ä¸ª**å¼•ç”¨é˜Ÿåˆ—**(`ReferenceQueue`)è”åˆä½¿ç”¨ã€‚å¦‚æœ**è½¯å¼•ç”¨**æ‰€å¼•ç”¨å¯¹è±¡è¢«**åƒåœ¾å›æ”¶**ï¼Œ`JAVA`è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ª**è½¯å¼•ç”¨**åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„**å¼•ç”¨é˜Ÿåˆ—**ï¼š

```java
ReferenceQueue<String> referenceQueue = new ReferenceQueue<>();//å¼•ç”¨é˜Ÿåˆ—
String str = new String("abc");
SoftReference<String> softReference = new SoftReference<>(str, referenceQueue);
str = null;
// Notify GC
/*
ä¸‹é¢è°ƒç”¨System.gc()æ–¹æ³•åªæ˜¯èµ·é€šçŸ¥ä½œç”¨ï¼ŒJVMä»€ä¹ˆæ—¶å€™æ‰«æå›æ”¶å¯¹è±¡æ˜¯JVMè‡ªå·±çš„çŠ¶æ€å†³å®šçš„ï¼Œå³ä½¿æ‰«æåˆ°è½¯å¼•ç”¨å¯¹è±¡ä¹Ÿä¸ä¸€å®šä¼šå›æ”¶å®ƒï¼Œåªæœ‰å†…å­˜ä¸å¤Ÿçš„æ—¶å€™æ‰ä¼šå›æ”¶
*/
System.gc();
System.out.println(softReference.get()); // abc
Reference<? extends String> reference = referenceQueue.poll();//å¼¹å‡ºé˜Ÿåˆ—å…ƒç´ 
System.out.println(reference); //null
```

å³å½“å†…å­˜ä¸è¶³æ—¶ï¼Œ`JVM`é¦–å…ˆå°†**è½¯å¼•ç”¨**ä¸­çš„**å¯¹è±¡**å¼•ç”¨ç½®ä¸º`null`ï¼Œç„¶åé€šçŸ¥**åƒåœ¾å›æ”¶å™¨**è¿›è¡Œå›æ”¶ï¼Œä¸”**åƒåœ¾æ”¶é›†çº¿ç¨‹**ä¼šåœ¨`JVM`æŠ›å‡º`OutOfMemoryError`ä¹‹å‰å›**æ”¶è½¯å¼•ç”¨å¯¹è±¡**ï¼Œè€Œä¸”**è™šæ‹Ÿæœº**ä¼šå°½å¯èƒ½ä¼˜å…ˆå›æ”¶**é•¿æ—¶é—´é—²ç½®ä¸ç”¨**çš„**è½¯å¼•ç”¨å¯¹è±¡**ï¼ˆå¼•å…¥å¼•ç”¨é˜Ÿåˆ—çš„åŸå› ï¼‰



3. **å¼±å¼•ç”¨**  **å¼±å¼•ç”¨**ä¸**è½¯å¼•ç”¨**çš„åŒºåˆ«åœ¨äºï¼šåªå…·æœ‰**å¼±å¼•ç”¨**çš„å¯¹è±¡æ‹¥æœ‰**æ›´çŸ­æš‚**çš„**ç”Ÿå‘½å‘¨æœŸ**ã€‚åœ¨åƒåœ¾å›æ”¶å™¨çº¿ç¨‹æ‰«æå®ƒæ‰€ç®¡è¾–çš„å†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°äº†åªå…·æœ‰**å¼±å¼•ç”¨**çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰**å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦**ï¼Œéƒ½ä¼š**å›æ”¶**å®ƒçš„å†…å­˜

```java
String str = new String("abc");
WeakReference<String> weakReference = new WeakReference<>(str);
```

å¼±å¼•ç”¨åŒæ ·ä¼šå…³è”ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—,å¦‚æœ**å¼±å¼•ç”¨**æ‰€å¼•ç”¨çš„**å¯¹è±¡**è¢«**åƒåœ¾å›æ”¶**ï¼Œ`Java`è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ª**å¼±å¼•ç”¨**åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„**å¼•ç”¨é˜Ÿåˆ—**ä¸­,`WeakReference`å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåŸºæœ¬ç”±**åƒåœ¾å›æ”¶å™¨**å†³å®šï¼Œä¸€æ—¦åƒåœ¾å›æ”¶çº¿ç¨‹å‘ç°äº†**å…·æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡**ï¼Œåœ¨ä¸‹ä¸€æ¬¡`GC`è¿‡ç¨‹ä¸­å°±ä¼šå¯¹å…¶è¿›è¡Œå›æ”¶ï¼Œæœ¬æ–‡æ‰€è¦è®¨è®ºçš„`ThreadLocalMap`ä¸­`Entry`çš„`Key`å°±æ˜¯å¼±å¼•ç”¨ï¼š



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/ThreadLocal.jpg)



### å­çº¿ç¨‹å˜é‡ä¼ é€’é—®é¢˜

https://blog.csdn.net/hbtj_1216/article/details/100511851



###  å†…å­˜æ³„æ¼

ä¸å†ä¼šè¢«ä½¿ç”¨çš„å¯¹è±¡æˆ–è€…å˜é‡å ç”¨çš„å†…å­˜**ä¸èƒ½è¢«æœ‰æ•ˆåƒåœ¾å›æ”¶**ï¼Œå°±æ˜¯å†…å­˜æ³„éœ²

```java
private static ThreadLocal<String> threadLocal1 = new ThreadLocal<>();
threadLocal1.set("Hello");
```

è§‚å¯Ÿä»¥ä¸Šä»£ç ï¼š`ThreadLocalMap`åœ¨ä¿å­˜æ—¶ï¼Œ``keyâ€”threadlocal1`æ˜¯ä¸€ä¸ª**å¼±å¼•ç”¨**ï¼ŒæŒ‡å‘çœŸæ­£çš„å †ä¸­`ThreadLocal`å®ä¾‹ï¼Œè€Œ`value`â€”`"hello"`ä¸ºå½“å‰çº¿ç¨‹å˜é‡çš„å‰¯æœ¬ï¼Œæ˜¯å¼ºå¼•ç”¨ã€‚`key`è¢«è®¾è®¡æˆ`WeakReference`**å¼±å¼•ç”¨**ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼š`Entry`ä¸­çš„`value`æ˜¯**å¼ºå¼•ç”¨**ã€è€Œ`key`æ˜¯å¼±å¼•ç”¨ï¼Œåœ¨`JVM`å‘ç”Ÿ`GC`æ—¶`key`ä¼šè¢«å›æ”¶ï¼Œè€Œ`value`ç”±äºæ˜¯å¼ºå¼•ç”¨ä¸ä¼šï¼Œè¿™æ ·ä¸€æ¥ï¼Œ`ThreadLocalMap` ä¸­å°±ä¼šå‡ºç° `key` ä¸º `null` çš„ `Entry`ï¼Œåªæœ‰**å½“å‰Threadçº¿ç¨‹é€€å‡ºä»¥å,valueçš„å¼ºå¼•ç”¨é“¾æ¡æ‰ä¼šæ–­æ‰**ã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œ**value** æ°¸è¿œæ— æ³•è¢« `GC` å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±äº§ç”Ÿäº†å†…å­˜æ³„éœ²

åœ¨`TheadLocal`ä¸­å†…å­˜æ³„æ¼æ˜¯æŒ‡`TheadLocalMap`ä¸­çš„`Entry`ä¸­çš„`key`ä¸º`null`ï¼Œè€Œ`value`ä¸ä¸ºnullã€‚å› ä¸ºkeyä¸ºnullå¯¼è‡´valueä¸€ç›´è®¿é—®ä¸åˆ°ï¼Œè€Œæ ¹æ®å¯è¾¾æ€§åˆ†æï¼Œå§‹ç»ˆæœ‰`threadRef`->`currentThread`->`threadLocalMap`->`entry`->`valueRef`->`valueMemory`,å¯¼è‡´åƒåœ¾å›æ”¶åœ¨è¿›è¡Œå¯è¾¾æ€§åˆ†ææ—¶,valueå¯è¾¾ä»è€Œä¸ä¼šè¢«å›æ”¶æ‰ï¼Œä½†æ˜¯è¯¥`value`æ°¸è¿œä¸èƒ½è¢«è®¿é—®åˆ°ï¼Œè¿™æ ·å°±å­˜åœ¨äº†å†…å­˜æ³„æ¼

è¯´ä¸€ä¸‹è‡ªå·±çš„ç¼ºç‚¹



JVMå¦‚ä½•æ‰¾åˆ°éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼š

- å¼•ç”¨è®¡æ•°æ³•ï¼šæ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°å±æ€§ï¼Œæ–°å¢ä¸€ä¸ªå¼•ç”¨æ—¶è®¡æ•°åŠ 1ï¼Œå¼•ç”¨é‡Šæ”¾æ—¶è®¡æ•°å‡1ï¼Œè®¡æ•°ä¸º0æ—¶å¯ä»¥å›æ”¶
- å¯è¾¾æ€§åˆ†ææ³•ï¼šä» `GC Roots` å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ã€‚å½“ä¸€ä¸ªå¯¹è±¡åˆ° GC Roots æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°±åˆ¤æ–­æ˜¯å¯å›æ”¶å¯¹è±¡

> å¼•ç”¨è®¡æ•°æ³•ï¼Œå¯èƒ½ä¼šå‡ºç°A å¼•ç”¨äº† Bï¼ŒB åˆå¼•ç”¨äº† Aï¼Œè¿™æ—¶å€™å°±ç®—ä»–ä»¬éƒ½ä¸å†ä½¿ç”¨äº†ï¼Œä½†å› ä¸ºç›¸äº’å¼•ç”¨ ï¼Œè®¡æ•°å™¨=1 æ°¸è¿œæ— æ³•è¢«å›æ”¶

`ThreadLocal`åœ¨ä¿å­˜çš„æ—¶å€™`key`ä¸ºä½¿ç”¨**å¼±å¼•ç”¨**çš„`ThreadLocal`å®ä¾‹ï¼Œvalueä¸ºçº¿ç¨‹å˜é‡çš„å‰¯æœ¬ï¼Œå­˜åœ¨`ThreadLocalMap`ä¸­ï¼Œ`key`è¢«è®¾è®¡æˆ`WeakReference`**å¼±å¼•ç”¨**ï¼Œè¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼šEntryä¸­çš„valueæ˜¯**å¼ºå¼•ç”¨**ã€è€Œkeyæ˜¯å¼±å¼•ç”¨ï¼Œåœ¨JVMå‘ç”ŸGC(`Garbage Collection`)æ—¶keyä¼šè¢«å›æ”¶ï¼Œè€Œvalueç”±äºæ˜¯å¼ºå¼•ç”¨ä¸ä¼šï¼Œè¿™æ ·ä¸€æ¥ï¼Œ`ThreadLocalMap` ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryï¼Œåªæœ‰**Threadçº¿ç¨‹é€€å‡ºä»¥å,valueçš„å¼ºå¼•ç”¨é“¾æ¡æ‰ä¼šæ–­æ‰**ã€‚å‡å¦‚æˆ‘ä»¬ä¸åšä»»ä½•æªæ–½çš„è¯ï¼Œ**value** æ°¸è¿œæ— æ³•è¢« GC å›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯èƒ½ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²(ç›¸å½“äºç™½å äº†`jvm`å†…å­˜è€Œæ— æ³•è¢«é‡Šæ”¾)

`ThreadLocalMap` çš„å®ç°ä¸­å·²ç»è€ƒè™‘äº†è¿™ç§æƒ…å†µï¼Œ**åœ¨è°ƒç”¨ `set()`ã€`get()`ã€`remove()` æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ¸…ç†æ‰ key ä¸º null çš„è®°å½•**ã€‚ä½¿ç”¨å®Œ `ThreadLocal`æ–¹æ³•åæœ€å¥½æ‰‹åŠ¨è°ƒç”¨`remove()`æ–¹æ³•ï¼Œ`ThreadLocal`åœ¨`remove()`çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨å¼±å¼•ç”¨ä¸­çš„`clear()`æ–¹æ³•:

```java
//ThreaLocalä¸­çš„removeæ–¹æ³•
public void remove() {
         ThreadLocalMap m = getMap(Thread.currentThread());
         if (m != null) {
             m.remove(this);
         }
     }

//ThreaLocalMapä¸­å®šä¹‰çš„removeæ–¹æ³•
private void remove(ThreadLocal<?> key) {
            Entry[] tab = table;
            int len = tab.length;
            int i = key.threadLocalHashCode & (len-1);
            for (Entry e = tab[i];
                 e != null;  //è¿™ä¸ªforå¾ªç¯å…¶å®å°±æ˜¯ä¸ºäº†æ‰¾åˆ°keyä¸ºnullçš„entry
                 e = tab[i = nextIndex(i, len)]) {
                if (e.refersTo(key)) {
                    e.clear(); //å¦‚æœkeyä¸ºnull,è€Œå¯¹åº”çš„entryè¿˜æœªè¢«å›æ”¶ï¼Œè°ƒç”¨Referenceä¸­çš„clear()æ–¹æ³•
                    expungeStaleEntry(i)ï¼›
                    return;
                }
            }
        }

//Referenceä¸­çš„clearæ–¹æ³• 
public void clear() {
        clear0();
    }

private native void clear0();
```

**æ€»ç»“ï¼š**

ç”±äº`Thread`ç±»ä¸­åŒ…å«å˜é‡`ThreadLocalMap`ï¼Œå› æ­¤`ThreadLocalMap`ä¸`Thread`çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤`key`ä¸º`null`ï¼Œ`value`ä¸ä¸º`null`çš„`Entry`,éƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼

ä½¿ç”¨**å¼±å¼•ç”¨**å¯ä»¥å¤šä¸€å±‚ä¿éšœï¼šå¼±å¼•ç”¨`ThreadLocal`ä¸ä¼šå†…å­˜æ³„æ¼ï¼Œå¯¹åº”çš„`value`åœ¨ä¸‹ä¸€æ¬¡`ThreadLocalMap`è°ƒç”¨`set(),get(),remove()`çš„æ—¶å€™ä¼šè¢«æ¸…é™¤

å› æ­¤ï¼Œ`ThreadLocal`å†…å­˜æ³„æ¼çš„æ ¹æºæ˜¯ï¼šç”±äº`ThreadLocalMap`çš„ç”Ÿå‘½å‘¨æœŸè·ŸThreadä¸€æ ·é•¿ï¼Œåœ¨å½“å‰çº¿ç¨‹æœªæ¶ˆäº¡å‰å¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº”`key`ä¸º`null`çš„`Entry`å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè€Œä¸æ˜¯å› ä¸ºkeyä¸ºå¼±å¼•ç”¨ï¼





## ThreadPool



### ä¸ºä»€ä¹ˆå¼•å…¥çº¿ç¨‹æ± å‘¢ï¼Ÿ

å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨new Thread();è¿™ç§æ–¹å¼å»è¿›è¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹ä¼šå¸¦æ¥ä»€ä¹ˆåæœï¼Ÿ

- - **OOMï¼š** å¦‚æœå½“å‰æ–¹æ³•çªé‡é«˜å¹¶å‘æƒ…å†µï¼Œå‡è®¾æ­¤æ—¶æ¥äº†1000ä¸ªè¯·æ±‚ï¼Œè€ŒæŒ‰ä¼ ç»Ÿçš„ç½‘ç»œæ¨¡å‹æ˜¯BIOï¼Œæ­¤æ—¶æœåŠ¡å™¨ä¼šå¼€1000ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™1000ä¸ªè¯·æ±‚ï¼ˆä¸è€ƒè™‘WEBå®¹å™¨çš„æœ€å¤§çº¿ç¨‹æ•°é…ç½®ï¼‰ï¼Œå½“1000ä¸ªè¯·æ±‚æ‰§è¡Œæ—¶åˆä¼šå‘ç°æ­¤æ–¹æ³•ä¸­å­˜åœ¨`new Thread();`åˆ›å»ºçº¿ç¨‹ï¼Œæ­¤æ—¶æ¯ä¸ªæ‰§è¡Œè¯·æ±‚çš„çº¿ç¨‹åˆä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°1000*2=2000ä¸ªçº¿ç¨‹çš„æƒ…å†µå‡ºç°ï¼Œè€Œ**åœ¨ä¸€ä¸ªç¨‹åºä¸­åˆ›å»ºçº¿ç¨‹æ˜¯éœ€è¦å‘JVMç”³è¯·å†…å­˜åˆ†é…çš„ï¼Œä½†æ˜¯æ­¤æ—¶å¤§é‡çº¿ç¨‹åœ¨åŒä¸€ç¬é—´å‘JVMç”³è¯·åˆ†é…å†…å­˜ï¼Œæ­¤æ—¶ä¼šå¾ˆå®¹æ˜“é€ æˆå†…å­˜æº¢å‡ºï¼ˆOOMï¼‰çš„æƒ…å†µå‘ç”Ÿ**
  - **èµ„æºå¼€é”€ä¸è€—æ—¶ï¼š**Javaå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¤§è‡´åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼šå¯¹è±¡çš„åˆ›å»ºï¼Œå¯¹è±¡çš„ä½¿ç”¨ï¼Œå¯¹è±¡çš„æ¸…é™¤ã€‚å› æ­¤ï¼Œå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿åº¦å¯ç”¨å¦‚ä¸‹çš„è¡¨è¾¾å¼è¡¨ç¤ºï¼šObject = O1 + O2 +O3ã€‚å…¶ä¸­O1è¡¨ç¤ºå¯¹è±¡çš„åˆ›å»ºæ—¶é—´ï¼ŒO2è¡¨ç¤ºå¯¹è±¡çš„ä½¿ç”¨æ—¶é—´ï¼Œè€ŒO3åˆ™è¡¨ç¤ºå…¶æ¸…é™¤ï¼ˆåƒåœ¾å›æ”¶ï¼‰æ—¶é—´ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰O2æ˜¯çœŸæ­£æœ‰æ•ˆçš„æ—¶é—´ï¼Œè€ŒO1ã€O3åˆ™æ˜¯å¯¹è±¡æœ¬èº«çš„å¼€é”€ã€‚å½“æˆ‘ä»¬å»åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå› ä¸ºçº¿ç¨‹åœ¨Javaä¸­å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªThreadç±»çš„å®ä¾‹ï¼Œæ‰€ä»¥å¯¹äºçº¿ç¨‹è€Œè¨€ï¼Œå…¶å®å®ƒçš„åˆ›å»ºï¼ˆç”³è¯·å†…å­˜åˆ†é…ã€JVMå‘OSæäº¤çº¿ç¨‹æ˜ å°„è¿›ç¨‹ç”³è¯·ã€OSçœŸå®çº¿ç¨‹æ˜ å°„ï¼‰å’Œé”€æ¯å¯¹èµ„æºæ˜¯å¼€é”€éå¸¸å¤§çš„å¹¶ä¸”éå¸¸è€—æ—¶çš„ã€‚
  - **ä¸å¯ç®¡ç†æ€§ï¼š** å¯¹äº`new Thread();`çš„æ˜¾ç¤ºåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹æ˜¯æ— æ³•ç®¡ç†çš„ï¼Œä¸€æ—¦CPUè°ƒåº¦æˆåŠŸï¼Œæ­¤çº¿ç¨‹çš„å¯ç®¡ç†æ€§å‡ ä¹ä¸ºé›¶ã€‚





### åˆ›å»ºæ–¹å¼

1. å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ

   - **é€šè¿‡`ThreadPoolExecutor`æ„é€ å‡½æ•°æ¥åˆ›å»º**

   ```java
    public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                                 int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                                 long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                                 TimeUnit unit,//æ—¶é—´å•ä½
                                 BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                                 ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                                 RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                     )  
   ```

   

   - **é€šè¿‡`Executor` æ¡†æ¶çš„å·¥å…·ç±» `Executors` åˆ›å»º**

   `Executors` æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œæä¾›äº†ç”¨äºåˆ›å»ºå’Œç®¡ç†çº¿ç¨‹æ± çš„é™æ€æ–¹æ³•ï¼Œç”¨äºç®€åŒ–çº¿ç¨‹æ± çš„åˆ›å»ºå’Œé…ç½®ï¼Œ`Executors` è¿˜æä¾›äº†å…¶ä»–ä¸€äº›ç”¨äºåˆ›å»ºç‰¹å®šç±»å‹çº¿ç¨‹æ± çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•éƒ½è¿”å›å®ç°äº† `ExecutorService` æ¥å£çš„çº¿ç¨‹æ± å¯¹è±¡ï¼Œå¯ä»¥ç”¨äºæäº¤ä»»åŠ¡å’Œç®¡ç†çº¿ç¨‹æ± çš„æ‰§è¡Œ

   `ExecutorService` æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ‰©å±•äº† `Executor` æ¥å£ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½å’Œæ›´çµæ´»çš„ä»»åŠ¡ç®¡ç†ã€‚

   `ExecutorService` æ¥å£çš„ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š

   1. æä¾›çº¿ç¨‹æ± ï¼š`ExecutorService` å¯ä»¥é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± ï¼Œå¦‚ `newFixedThreadPool()`ã€`newCachedThreadPool()` ç­‰ã€‚çº¿ç¨‹æ± å¯ä»¥é‡ç”¨çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹çš„é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ï¼Œæé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡å’Œæ€§èƒ½ã€‚
   2. æäº¤ä»»åŠ¡ï¼š`ExecutorService` å¯ä»¥æ¥æ”¶ä»»åŠ¡ï¼ˆ`Runnable` æˆ– `Callable` å¯¹è±¡ï¼‰çš„æäº¤ï¼Œå¹¶å®‰æ’çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚ä»»åŠ¡çš„æäº¤å¯ä»¥é€šè¿‡ `submit()` æˆ– `execute()` æ–¹æ³•è¿›è¡Œã€‚
   3. å¼‚æ­¥æ‰§è¡Œï¼š`ExecutorService` æäº¤çš„ä»»åŠ¡å¯ä»¥åœ¨åå°çº¿ç¨‹ä¸­å¼‚æ­¥æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ‰§è¡Œã€‚è¿™ä½¿å¾—ä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œè€Œä¸å¿…ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚
   4. ä»»åŠ¡ç®¡ç†ï¼š`ExecutorService` æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥ç®¡ç†å’Œæ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¦‚ `shutdown()`ã€`shutdownNow()`ã€`isShutdown()`ã€`isTerminated()` ç­‰ã€‚å¯ä»¥æ§åˆ¶çº¿ç¨‹æ± çš„å¯åŠ¨ã€å…³é—­ã€ç›‘æ§ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ç­‰ã€‚
   5. è·å–ä»»åŠ¡ç»“æœï¼š`ExecutorService` æäº¤ä»»åŠ¡åï¼Œå¯ä»¥è¿”å›ä¸€ä¸ª `Future` å¯¹è±¡ï¼Œè¡¨ç¤ºä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚é€šè¿‡ `Future` å¯¹è±¡ï¼Œå¯ä»¥è·å–ä»»åŠ¡çš„è¿”å›å€¼ã€åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€å–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œç­‰ã€‚
   6. æ‰¹é‡æäº¤ä»»åŠ¡ï¼š`ExecutorService` æä¾›äº†æ‰¹é‡æäº¤ä»»åŠ¡çš„æ–¹æ³•ï¼Œå¦‚ `invokeAll()` å’Œ `invokeAny()`ã€‚`invokeAll()` æäº¤ä¸€æ‰¹ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼›`invokeAny()` æäº¤ä¸€æ‰¹ä»»åŠ¡ï¼Œå¹¶è¿”å›æœ€å…ˆå®Œæˆçš„ä»»åŠ¡çš„ç»“æœã€‚

   

2. `ThreadPoolExecutor`çš„ç±»å‹æœ‰å“ªäº›ï¼ˆ`Executors`ä¸­è‡ªå¸¦çš„çº¿ç¨‹æ± ï¼‰ï¼Ÿ

   - `FixThreadPool`:è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª**å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± **ã€‚è¯¥çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å§‹ç»ˆä¸å˜ã€‚å½“æœ‰ä¸€ä¸ªæ–°çš„ä»»åŠ¡æäº¤æ—¶ï¼Œçº¿ç¨‹æ± ä¸­è‹¥æœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ç«‹å³æ‰§è¡Œã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ–°çš„ä»»åŠ¡ä¼šè¢«æš‚å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…æœ‰çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¾¿å¤„ç†åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡  

   ```java
   public static ExecutorService newFixedThreadPool(int nThreads) {  //nThreadsè¡¨ç¤ºçº¿ç¨‹æ•°é‡
           return new ThreadPoolExecutor(nThreads, nThreads,
                                         0L, TimeUnit.MILLISECONDS,
                                         new LinkedBlockingQueue<Runnable>());
       }
   ```

   

   - `SingleThreadExecutor`:è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚è‹¥å¤šä½™ä¸€ä¸ªä»»åŠ¡è¢«æäº¤åˆ°è¯¥çº¿ç¨‹æ± ï¼Œä»»åŠ¡ä¼šè¢«ä¿å­˜åœ¨ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¾…çº¿ç¨‹ç©ºé—²ï¼ŒæŒ‰å…ˆå…¥å…ˆå‡ºçš„é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡

   ```java
    public static ExecutorService newSingleThreadExecutor() {
           return new FinalizableDelegatedExecutorService
     (new ThreadPoolExecutor(1, 1,0L, TimeUnit.MILLISECONDS,new LinkedBlockingQueue<Runnable>()));
      // corePoolSizeæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º1    maximumPoolSizeä¸º1  keepAliveTimeä¸ºOL   æ—¶é—´å•ä½   ä¼ å…¥é˜»å¡ä»»åŠ¡é˜Ÿåˆ—(æ— ç•Œ)
       }
   ```

   

   - `CachedThreadPool`:è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª**å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´çº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± **ã€‚çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡ä¸ç¡®å®šï¼Œä½†è‹¥æœ‰ç©ºé—²çº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œåˆ™ä¼šä¼˜å…ˆä½¿ç”¨çº¿ç¨‹æ± ä¸­å·²æœ‰çš„çº¿ç¨‹ï¼›è‹¥æ‰€æœ‰çº¿ç¨‹å‡åœ¨å·¥ä½œï¼Œè€Œåˆæœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹å¤„ç†ä»»åŠ¡ã€‚æ‰€æœ‰çº¿ç¨‹åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå°†è¿”å›çº¿ç¨‹æ± è¿›è¡Œå¤ç”¨

   ```JAVA
   public static ExecutorService newCachedThreadPool() {
       return new ThreadPoolExecutor(0, Integer.MAX_VALUE, //ä¸é™åˆ¶çº¿ç¨‹æ± ä¸­æœ€å¤§çº¿ç¨‹æ•°é‡ï¼ŒåŠ¨æ€è°ƒæ•´
                                     60L, TimeUnit.SECONDS,
                                     new SynchronousQueue<Runnable>());
   }
   ```

   

   - **`ScheduledThreadPool`** ï¼šè¯¥è¿”å›ä¸€ä¸ªç”¨æ¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œä»»åŠ¡æˆ–è€…å®šæœŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± 

   ```java
   public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) {
           return new ScheduledThreadPoolExecutor(corePoolSize);
       }
   
   // ScheduledThreadPoolExecutor()
   public ScheduledThreadPoolExecutor(int corePoolSize) {
           super(corePoolSize, Integer.MAX_VALUE,
                 DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,
                 new DelayedWorkQueue());//å¼•å…¥äº†å»¶è¿Ÿå·¥ä½œé˜Ÿåˆ—
       }
   ```



**æ³¨æ„äº‹é¡¹ï¼š**å»ºè®®é€šè¿‡ `ThreadPoolExecutor` æ„é€ å‡½æ•°çš„æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©

`Executors` è¿”å›çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š

- **`FixedThreadPool` å’Œ `SingleThreadExecutor`**ï¼šä½¿ç”¨çš„æ˜¯æ— ç•Œçš„ `LinkedBlockingQueue`ï¼Œä»»åŠ¡é˜Ÿåˆ—æœ€å¤§é•¿åº¦ä¸º `Integer.MAX_VALUE`ï¼ˆç”±äºé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ï¼Œå› æ­¤`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼‰ã€‚æ•…å¯èƒ½å †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ `OOM`
- **`CachedThreadPool`**ï¼šä½¿ç”¨çš„æ˜¯åŒæ­¥é˜Ÿåˆ— `SynchronousQueue`, å…è®¸åˆ›å»ºçš„çº¿ç¨‹æ•°é‡ä¸º `Integer.MAX_VALUE` ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ `OOM`
- **`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor`** : ä½¿ç”¨çš„æ— ç•Œçš„å»¶è¿Ÿé˜»å¡é˜Ÿåˆ—`DelayedWorkQueue`ï¼Œ`DelayedWorkQueue` æ·»åŠ å…ƒç´ æ»¡äº†ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹åŸæ¥å®¹é‡çš„ 1/2ï¼Œå³æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œæœ€å¤§æ‰©å®¹å¯è¾¾ `Integer.MAX_VALUE`ï¼Œæ‰€ä»¥æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹





> ä¸ºä»€ä¹ˆé˜¿é‡Œä¸å»ºè®®ä½¿ç”¨`Executors`å†…ç½®çš„çº¿ç¨‹æ± 

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%98%BF%E9%87%8C.png)





### çº¿ç¨‹æ± æºç åˆ†æ:expressionless:

ThreadPoolExecutorçº¿ç¨‹æ± æœ‰5ä¸ªçŠ¶æ€ï¼Œåˆ†åˆ«æ˜¯ï¼š

1. RUNNINGï¼šå¯ä»¥æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡
2. SHUTDOWNï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œ**ä½†æ˜¯å¯ä»¥å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡**
3. STOPï¼šä¸æ¥å—æ–°çš„ä»»åŠ¡ï¼Œä¸å¤„ç†é˜»å¡é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡
4. TIDYINGï¼š**è¿‡æ¸¡çŠ¶æ€**ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†ï¼Œå½“å‰çº¿ç¨‹æ± å·²ç»æ²¡æœ‰æœ‰æ•ˆçš„çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ± çš„çŠ¶æ€å°†ä¼šTIDYINGï¼Œ**å¹¶ä¸”å°†è¦è°ƒç”¨terminatedæ–¹æ³•**
5. TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ï¼Œterminatedæ–¹æ³•è°ƒç”¨å®Œæˆä»¥åçš„çŠ¶æ€



çŠ¶æ€ä¹‹é—´å¯ä»¥è¿›è¡Œè½¬æ¢ï¼š

RUNNING -> SHUTDOWNï¼šæ‰‹åŠ¨è°ƒç”¨shutdownæ–¹æ³•ï¼Œæˆ–è€…ThreadPoolExecutorè¦è¢«GCå›æ”¶çš„æ—¶å€™è°ƒç”¨finalizeæ–¹æ³•ï¼Œfinalizeæ–¹æ³•å†…éƒ¨ä¹Ÿä¼šè°ƒç”¨shutdownæ–¹æ³•

(RUNNING or SHUTDOWN) -> STOPï¼šè°ƒç”¨shutdownNowæ–¹æ³•

SHUTDOWN -> TIDYINGï¼šå½“é˜Ÿåˆ—å’Œçº¿ç¨‹æ± éƒ½ä¸ºç©ºçš„æ—¶å€™

STOP -> TIDYINGï¼šå½“çº¿ç¨‹æ± ä¸ºç©ºçš„æ—¶å€™

TIDYING -> TERMINATEDï¼šterminatedæ–¹æ³•è°ƒç”¨å®Œæˆä¹‹å

ThreadPoolExecutorå†…éƒ¨è¿˜ä¿å­˜ç€çº¿ç¨‹æ± çš„æœ‰æ•ˆçº¿ç¨‹ä¸ªæ•°ã€‚

çŠ¶æ€å’Œçº¿ç¨‹æ•°åœ¨`ThreadPoolExecutor`å†…éƒ¨ä½¿ç”¨ä¸€ä¸ª**æ•´å‹å˜é‡**ä¿å­˜ï¼Œæ²¡é”™ï¼Œä¸€ä¸ªå˜é‡è¡¨ç¤ºä¸¤ç§å«ä¹‰ã€‚



ä¸ºä»€ä¹ˆä¸€ä¸ªæ•´å‹å˜é‡æ—¢å¯ä»¥ä¿å­˜çŠ¶æ€ï¼Œåˆå¯ä»¥ä¿å­˜æ•°é‡ï¼Ÿ åˆ†æä¸€ä¸‹ï¼š

é¦–å…ˆï¼Œæˆ‘ä»¬çŸ¥é“javaä¸­1ä¸ªæ•´å‹å 4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯32ä½ï¼Œæ‰€ä»¥1ä¸ªæ•´å‹æœ‰32ä½ã€‚

æ‰€ä»¥æ•´å‹1ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯ï¼š00000000000000000000000000000001

æ•´å‹-1ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯ï¼š11111111111111111111111111111111(è¿™ä¸ªæ˜¯è¡¥ç ï¼Œä¸æ‡‚çš„åŒå­¦å¯ä»¥çœ‹ä¸‹åŸç ï¼Œåç ï¼Œè¡¥ç çš„çŸ¥è¯†)

åœ¨`ThreadPoolExecutor`ä¸­ï¼Œæ•´å‹ä¸­32ä½çš„å‰3ä½ç”¨æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œå3ä½è¡¨ç¤ºçº¿ç¨‹æ± ä¸­æœ‰æ•ˆçš„çº¿ç¨‹æ•°ã€‚

```
// å‰3ä½è¡¨ç¤ºçŠ¶æ€ï¼Œæ‰€æœ‰çº¿ç¨‹æ•°å 29ä½
private static final int COUNT_BITS = Integer.SIZE - 3;
```



çº¿ç¨‹æ± çš„**åˆå§‹å®¹é‡**å¤§å°ä¸º 1 << 29 - 1 = 00011111111111111111111111111111(äºŒè¿›åˆ¶)ï¼Œä»£ç å¦‚ä¸‹

```
private static final int CAPACITY   = (1 << COUNT_BITS) - 1;
```



`RUNNING`çŠ¶æ€ä¸ºï¼š -1 << 29 = 11111111111111111111111111111111 << 29 = 11100000000000000000000000000000(å‰3ä½ä¸º111)ï¼š

```
private static final int RUNNING    = -1 << COUNT_BITS;
```

`SHUTDOWN`çŠ¶æ€ä¸ºï¼š 0 << 29 = 00000000000000000000000000000000 << 29 = 00000000000000000000000000000000(å‰3ä½ä¸º000)

```
private static final int SHUTDOWN   =  0 << COUNT_BITS;
```

`STOP`çŠ¶æ€ä¸ºï¼š 1 << 29 = 00000000000000000000000000000001 << 29 = 00100000000000000000000000000000(å‰3ä½ä¸º001)ï¼š

```
private static final int STOP       =  1 << COUNT_BITS;
```

`TIDYING`çŠ¶æ€ä¸ºï¼š 2 << 29 = 00000000000000000000000000000010 << 29 = 01000000000000000000000000000000(å‰3ä½ä¸º010)ï¼š

```
private static final int TIDYING    =  2 << COUNT_BITS;
```

TERMINATEDçŠ¶æ€ä¸ºï¼š 3 << 29 = 00000000000000000000000000000011 << 29 = 01100000000000000000000000000000(å‰3ä½ä¸º011)ï¼š

```
private static final int TERMINATED =  3 << COUNT_BITS;    
```





æ¸…æ¥šçŠ¶æ€ä½ä¹‹åï¼Œä¸‹é¢æ˜¯è·å¾—çŠ¶æ€å’Œçº¿ç¨‹æ•°çš„å†…éƒ¨æ–¹æ³•ï¼š

```java
// å¾—åˆ°çº¿ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯å29ä½çš„æ•°å­—ã€‚ ç›´æ¥è·ŸCAPACITYåšä¸€ä¸ªä¸æ“ä½œå³å¯ï¼ŒCAPACITYå°±æ˜¯çš„å€¼å°± 1 << 29 - 1 = 00011111111111111111111111111111ã€‚ ä¸æ“ä½œçš„è¯å‰é¢3ä½è‚¯å®šä¸º0ï¼Œç›¸å½“äºç›´æ¥å–å29ä½çš„å€¼
private static int workerCountOf(int c)  { return c & CAPACITY; }

// å¾—åˆ°çŠ¶æ€ï¼ŒCAPACITYçš„éæ“ä½œå¾—åˆ°çš„äºŒè¿›åˆ¶ä½11100000000000000000000000000000ï¼Œç„¶ååšåœ¨ä¸€ä¸ªä¸æ“ä½œï¼Œç›¸å½“äºç›´æ¥å–å‰3ä½çš„çš„å€¼
private static int runStateOf(int c)     { return c & ~CAPACITY; }

// æˆ–æ“ä½œã€‚ç›¸å½“äºæ›´æ–°æ•°é‡å’ŒçŠ¶æ€ä¸¤ä¸ªæ“ä½œ
private static int ctlOf(int rs, int wc) { return rs | wc; }
```



çº¿ç¨‹æ± åˆå§‹åŒ–çŠ¶æ€çº¿ç¨‹æ•°å˜é‡ï¼š

```java
// åˆå§‹åŒ–çŠ¶æ€å’Œæ•°é‡ï¼ŒçŠ¶æ€ä¸ºRUNNINGï¼Œçº¿ç¨‹æ•°ä¸º0
private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
```





è‡³äºå¦‚ä½•ä¸ºçº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹ï¼Œéœ€è¦æ¥çœ‹çœ‹`addWorker()`æ–¹æ³•ï¼š

```java
// ä¸¤ä¸ªå‚æ•°ï¼ŒfirstTaskè¡¨ç¤ºéœ€è¦è·‘çš„ä»»åŠ¡ã€‚booleanç±»å‹çš„coreå‚æ•°ä¸ºtrueçš„è¯è¡¨ç¤ºä½¿ç”¨çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼Œä¸ºfalseä½¿ç”¨çº¿ç¨‹æ± æœ€å¤§å¤§å°
// è¿”å›å€¼æ˜¯booleanç±»å‹ï¼Œtrueè¡¨ç¤ºæ–°ä»»åŠ¡è¢«æ¥æ”¶äº†ï¼Œå¹¶ä¸”æ‰§è¡Œäº†ã€‚å¦åˆ™æ˜¯false
private boolean addWorker(Runnable firstTask, boolean core) {
    retry:
    for (;;) {
        int c = ctl.get();  // è·å–åŸå­å±æ€§ctlï¼ˆåŒ…å«çº¿ç¨‹æ•°é‡ä¸çº¿ç¨‹æ± çŠ¶æ€ï¼‰
        int rs = runStateOf(c); // çº¿ç¨‹æ± å½“å‰çŠ¶æ€

        // è¿™ä¸ªåˆ¤æ–­è½¬æ¢æˆ rs >= SHUTDOWN && (rs != SHUTDOWN || firstTask != null || workQueue.isEmpty)ã€‚ 
        // æ¦‚æ‹¬ä¸º3ä¸ªæ¡ä»¶ï¼š
        // 1. çº¿ç¨‹æ± ä¸åœ¨RUNNINGçŠ¶æ€å¹¶ä¸”çŠ¶æ€æ˜¯STOPã€TIDYINGæˆ–TERMINATEDä¸­çš„ä»»æ„ä¸€ç§çŠ¶æ€

        // 2. çº¿ç¨‹æ± ä¸åœ¨RUNNINGçŠ¶æ€ï¼Œçº¿ç¨‹æ± æ¥å—äº†æ–°çš„ä»»åŠ¡ 

        // 3. çº¿ç¨‹æ± ä¸åœ¨RUNNINGçŠ¶æ€ï¼Œé˜»å¡é˜Ÿåˆ—ä¸ºç©ºã€‚  æ»¡è¶³è¿™3ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªçš„è¯ï¼Œæ‹’ç»æ‰§è¡Œä»»åŠ¡

        if (rs >= SHUTDOWN &&
            ! (rs == SHUTDOWN &&
               firstTask == null &&
               ! workQueue.isEmpty()))
            return false;

        for (;;) {
            int wc = workerCountOf(c); // çº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°
            if (wc >= CAPACITY ||
                wc >= (core ? corePoolSize : maximumPoolSize)) // å¦‚æœçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡è¶…è¿‡çº¿ç¨‹æ± æœ€å¤§å®¹é‡æˆ–è€…çº¿ç¨‹æ•°é‡è¶…è¿‡äº†åŸºæœ¬å¤§å°(coreå‚æ•°ä¸ºtrueï¼Œcoreå‚æ•°ä¸ºfalseçš„è¯åˆ¤æ–­è¶…è¿‡æœ€å¤§å¤§å°)
                return false; // è¶…è¿‡ç›´æ¥è¿”å›false
            if (compareAndIncrementWorkerCount(c)) // æ²¡æœ‰è¶…è¿‡å„ç§å¤§å°çš„è¯ï¼Œcasæ“ä½œçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡+1ï¼ŒcasæˆåŠŸçš„è¯è·³å‡ºå¾ªç¯
                break retry;
            c = ctl.get();  // é‡æ–°æ£€æŸ¥çŠ¶æ€
            if (runStateOf(c) != rs) // å¦‚æœçŠ¶æ€æ”¹å˜äº†ï¼Œé‡æ–°å¾ªç¯æ“ä½œ
                continue retry;
            // else CAS failed due to workerCount change; retry inner loop
        }
    }
    // èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜casæ“ä½œæˆåŠŸäº†ï¼Œçº¿ç¨‹æ± çº¿ç¨‹æ•°é‡+1
    boolean workerStarted = false; // ä»»åŠ¡æ˜¯å¦æˆåŠŸå¯åŠ¨æ ‡è¯†
    boolean workerAdded = false; // ä»»åŠ¡æ˜¯å¦æ·»åŠ æˆåŠŸæ ‡è¯†
    Worker w = null;
    try {
        final ReentrantLock mainLock = this.mainLock; // å¾—åˆ°çº¿ç¨‹æ± çš„å¯é‡å…¥é”
        w = new Worker(firstTask); // åŸºäºä»»åŠ¡firstTaskæ„é€ worker
        final Thread t = w.thread; // ä½¿ç”¨Workerçš„å±æ€§threadï¼Œè¿™ä¸ªthreadæ˜¯ä½¿ç”¨ThreadFactoryæ„é€ å‡ºæ¥çš„
        if (t != null) { // ThreadFactoryæ„é€ å‡ºçš„Threadæœ‰å¯èƒ½æ˜¯nullï¼Œåšä¸ªåˆ¤æ–­
            mainLock.lock(); // é”ä½ï¼Œé˜²æ­¢å¹¶å‘
            try {
                // åœ¨é”ä½ä¹‹åå†é‡æ–°æ£€æµ‹ä¸€ä¸‹çŠ¶æ€
                int c = ctl.get();
                int rs = runStateOf(c);

                if (rs < SHUTDOWN ||
                    (rs == SHUTDOWN && firstTask == null)) { // å¦‚æœçº¿ç¨‹æ± åœ¨RUNNINGçŠ¶æ€æˆ–è€…çº¿ç¨‹æ± åœ¨SHUTDOWNçŠ¶æ€å¹¶ä¸”ä»»åŠ¡æ˜¯ä¸ªnull
                    if (t.isAlive()) // åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€ï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹å·²ç»å¯åŠ¨å¹¶ä¸”è¿˜æ²¡æ­»æ‰
                        throw new IllegalThreadStateException(); // å¦‚æœå­˜åœ¨å·²ç»å¯åŠ¨å¹¶ä¸”è¿˜æ²¡æ­»çš„çº¿ç¨‹ï¼ŒæŠ›å‡ºå¼‚å¸¸
                    workers.add(w); // workeræ·»åŠ åˆ°çº¿ç¨‹æ± çš„workerså±æ€§ä¸­ï¼Œæ˜¯ä¸ªHashSet
                    int s = workers.size(); // å¾—åˆ°ç›®å‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸ªæ•°
                    if (s > largestPoolSize) // å¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸ªæ•°è¶…è¿‡äº†çº¿ç¨‹æ± ä¸­çš„æœ€å¤§çº¿ç¨‹æ•°æ—¶ï¼Œæ›´æ–°ä¸€ä¸‹è¿™ä¸ªæœ€å¤§çº¿ç¨‹æ•°
                        largestPoolSize = s;
                    workerAdded = true; // æ ‡è¯†ä¸€ä¸‹ä»»åŠ¡å·²ç»æ·»åŠ æˆåŠŸ
                }
            } finally {
                mainLock.unlock(); // è§£é”
            }
            if (workerAdded) { // å¦‚æœä»»åŠ¡æ·»åŠ æˆåŠŸï¼Œè¿è¡Œä»»åŠ¡ï¼Œæ”¹å˜ä¸€ä¸‹ä»»åŠ¡æˆåŠŸå¯åŠ¨æ ‡è¯†
                t.start(); // å¯åŠ¨çº¿ç¨‹ï¼Œè¿™é‡Œçš„tæ˜¯Workerä¸­çš„threadå±æ€§ï¼Œæ‰€ä»¥ç›¸å½“äºå°±æ˜¯è°ƒç”¨äº†Workerçš„runæ–¹æ³•
                workerStarted = true;
            }
        }
    } finally {
        if (! workerStarted) // å¦‚æœä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼Œè°ƒç”¨addWorkerFailedæ–¹æ³•
            addWorkerFailed(w);
    }
    return workerStarted;
}
```

 

é€šè¿‡`addWorker()`æ–¹æ³•æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡ä¼ å…¥çš„`ThreadFactory`çº¿ç¨‹å·¥å‚æ¥åˆ›å»ºçš„ï¼š

```java
Worker(Runnable firstTask) {
            setState(-1); // inhibit interrupts until runWorker
            this.firstTask = firstTask;
            this.thread = getThreadFactory().newThread(this);
        }
```

**åˆ†æï¼š**

- `addWorker()`æ–¹æ³•ç”¨äºåˆ›å»ºæ–°çš„çº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡ï¼Œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†**æ›´æ–°çº¿ç¨‹æ•°é‡å’Œåˆ›å»ºå¯åŠ¨çº¿ç¨‹**ã€‚
- **ä½¿ç”¨CASæ›´æ–°çº¿ç¨‹æ•°é‡**ï¼Œä½¿ç”¨`compareAndIncrementWorkerCount()`å³**CASæ“ä½œå¢åŠ çº¿ç¨‹æ•°é‡**ï¼Œå¾ªç¯æ›´æ–°ç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚
- **åˆ›å»ºå¯åŠ¨çº¿ç¨‹éƒ¨åˆ†ä½¿ç”¨å…¨å±€é”ï¼ˆç‹¬å é”ï¼‰`mainLock`åˆ›å»ºå¹¶æ‰§è¡Œçº¿ç¨‹**ï¼Œå¹¶è®°å½•çŠ¶æ€ï¼Œå¦‚æœåˆ›å»ºå¤±è´¥åˆ™è°ƒç”¨`addWorkerFailed()`ç§»é™¤çº¿ç¨‹æ“ä½œã€‚











çº¿ç¨‹æ± æ„é€ å®Œæ¯•ä¹‹åï¼Œå¦‚æœç”¨æˆ·è°ƒç”¨äº†executeæˆ–è€…submitæ–¹æ³•çš„æ—¶å€™ï¼Œæœ€åéƒ½ä¼šä½¿ç”¨executeæ–¹æ³•æ‰§è¡Œã€‚

executeæ–¹æ³•å†…éƒ¨åˆ†3ç§æƒ…å†µå¤„ç†ä»»åŠ¡ï¼š

1. **å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„Workeræ•°é‡æ¯”corePoolSize(åŸºæœ¬å¤§å°)è¦å°ã€‚ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„Workeræ‰§è¡Œä»»åŠ¡ï¼Œä¼šè°ƒç”¨addWorkeræ–¹æ³•**
2. å¦‚æœå½“å‰æ­£åœ¨æ‰§è¡Œçš„Workeræ•°é‡å¤§äºç­‰äºcorePoolSize(åŸºæœ¬å¤§å°)ã€‚å°†ä»»åŠ¡æ”¾åˆ°é˜»å¡é˜Ÿåˆ—é‡Œï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—æ²¡æ»¡å¹¶ä¸”çŠ¶æ€æ˜¯RUNNINGçš„è¯ï¼Œç›´æ¥ä¸¢åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œå¦åˆ™æ‰§è¡Œç¬¬3æ­¥
3. ä¸¢åˆ°é˜»å¡å¤±è´¥çš„è¯ï¼Œä¼šè°ƒç”¨addWorkeræ–¹æ³•å°è¯•èµ·ä¸€ä¸ªæ–°çš„Workerå»é˜»å¡é˜Ÿåˆ—æ‹¿ä»»åŠ¡å¹¶æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœè¿™ä¸ªæ–°çš„Workeråˆ›å»ºå¤±è´¥ï¼Œè°ƒç”¨rejectæ–¹æ³•

çº¿ç¨‹æ± ä¸­çš„è¿™ä¸ªåŸºæœ¬å¤§å°æŒ‡çš„æ˜¯Workerçš„æ•°é‡ã€‚ä¸€ä¸ªWorkeræ˜¯ä¸€ä¸ªRunnableçš„å®ç°ç±»ï¼Œä¼šè¢«å½“åšä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¯åŠ¨ã€‚Workerå†…éƒ¨å¸¦æœ‰ä¸€ä¸ªRunnableå±æ€§firstTaskï¼Œè¿™ä¸ªfirstTaskå¯ä»¥ä¸ºnullï¼Œä¸ºnullçš„è¯Workerä¼šå»é˜»å¡é˜Ÿåˆ—æ‹¿ä»»åŠ¡æ‰§è¡Œï¼Œå¦åˆ™ä¼šå…ˆæ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åå†å»é˜»å¡é˜Ÿåˆ—ç»§ç»­æ‹¿ä»»åŠ¡æ‰§è¡Œã€‚

æ‰€ä»¥è¯´å¦‚æœWorkeræ•°é‡è¶…è¿‡äº†åŸºæœ¬å¤§å°ï¼Œé‚£ä¹ˆä»»åŠ¡éƒ½ä¼šåœ¨é˜»å¡é˜Ÿåˆ—é‡Œï¼Œå½“Workeræ‰§è¡Œå®Œäº†å®ƒçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ä¹‹åï¼Œå°±ä¼šå»é˜»å¡é˜Ÿåˆ—é‡Œæ‹¿å…¶ä»–ä»»åŠ¡ç»§ç»­æ‰§è¡Œã€‚

Workeråœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šæ ¹æ®ä¸€äº›å‚æ•°è¿›è¡Œè°ƒèŠ‚ï¼Œæ¯”å¦‚Workeræ•°é‡è¶…è¿‡äº†çº¿ç¨‹æ± åŸºæœ¬å¤§å°æˆ–è€…è¶…æ—¶æ—¶é—´åˆ°äº†ç­‰å› ç´ ï¼Œè¿™ä¸ªæ—¶å€™Workerä¼šè¢«çº¿ç¨‹æ± å›æ”¶ï¼Œçº¿ç¨‹æ± ä¼šå°½é‡ä¿æŒå†…éƒ¨çš„Workeræ•°é‡ä¸è¶…è¿‡åŸºæœ¬å¤§å°ã€‚

å¦å¤–Workeræ‰§è¡Œä»»åŠ¡çš„æ—¶å€™è°ƒç”¨çš„æ˜¯Runnableçš„runæ–¹æ³•ï¼Œè€Œä¸æ˜¯startæ–¹æ³•ï¼Œè°ƒç”¨äº†startæ–¹æ³•å°±ç›¸å½“äºå¦å¤–å†èµ·ä¸€ä¸ªçº¿ç¨‹äº†ã€‚

Workeråœ¨å›æ”¶çš„æ—¶å€™ä¼šå°è¯•ç»ˆæ­¢çº¿ç¨‹æ± ã€‚å°è¯•å…³é—­çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰Workeråœ¨å·¥ä½œï¼Œæ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œæ²¡é—®é¢˜çš„è¯ä¼šå°†çŠ¶æ€è¿‡åº¦åˆ°TIDYINGçŠ¶æ€ï¼Œä¹‹åè°ƒç”¨terminatedæ–¹æ³•ï¼Œterminatedæ–¹æ³•è°ƒç”¨å®Œæˆä¹‹åå°†çº¿ç¨‹æ± çŠ¶æ€æ›´æ–°åˆ°TERMINATEDã€‚



`execute`æ–¹æ³•æºç è§£æï¼š

```JAVA
public void execute(Runnable command) {
        // åˆ¤æ–­å…¥å‚æ˜¯å¦ä¸ºç©º
  if (command == null)
    throw new NullPointerException();
        // è·å–åŸå­å±æ€§ctlï¼ˆåŒ…å«çº¿ç¨‹æ•°é‡ä¸çº¿ç¨‹æ± çŠ¶æ€ï¼‰
  int c = ctl.get();
        // workerCountOf()ç”¨äºè·å–çº¿ç¨‹æ± çš„å½“å‰çº¿ç¨‹æ•°é‡
  if (workerCountOf(c) < corePoolSize) {
                // å°äºæ ¸å¿ƒçº¿ç¨‹æ•°åˆ™ç›´æ¥è°ƒç”¨addWorkeråˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡å¹¶è¿”å›
    if (addWorker(command, true))
      return;
                // é‡æ–°è·å–ctl
    c = ctl.get();
  }
        // èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜å½“å‰çº¿ç¨‹æ•°é‡å·²ç»è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œéœ€è¦åˆ¤æ–­èƒ½å¦åŠ å…¥é˜»å¡é˜Ÿåˆ—
        // åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦ä¸ºRUNNINGå¹¶å°†ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—
  if (isRunning(c) && workQueue.offer(command)) {
                // è·å–ctl
    int recheck = ctl.get();
                // å¦‚æœçº¿ç¨‹æ± æ²¡æœ‰RUNNINGï¼ŒæˆåŠŸä»é˜»å¡é˜Ÿåˆ—ä¸­åˆ é™¤ä»»åŠ¡ï¼Œæ‰§è¡Œrejectæ–¹æ³•å¤„ç†ä»»åŠ¡
    if (! isRunning(recheck) && remove(command))
      reject(command);
                // çº¿ç¨‹æ± å¤„äºRUNNINGçŠ¶æ€ï¼Œä½†æ˜¯æ²¡æœ‰çº¿ç¨‹ï¼Œåˆ™åˆ›å»ºçº¿ç¨‹
    else if (workerCountOf(recheck) == 0)
      addWorker(null, false);
  }
        // å¦‚æœåˆ›å»ºæ–°çº¿ç¨‹å¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥
  else if (!addWorker(command, false))
    reject(command);
}

```





### çº¿ç¨‹æ± å…³é—­



1. å…³é—­æ–¹å¼ä¸€ï¼š`shutdown()`

å°†çº¿ç¨‹æ± çŠ¶æ€è®¾ç½®ä¸ºSHUTDOWNçŠ¶æ€ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸ä¼šå†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œå†…éƒ¨ä¼šå°†é˜Ÿåˆ—ä¸­æäº¤çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå·¥ä½œçº¿ç¨‹è‡ªåŠ¨é€€å‡º



2. å…³é—­æ–¹å¼äºŒï¼š`shutdownNow()`

å°†çº¿ç¨‹æ± çŠ¶æ€è®¾ç½®ä¸ºSTOPçŠ¶æ€ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¼šå°†é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ä»»åŠ¡å…¨éƒ¨ç§»é™¤ï¼Œå°†æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå·¥ä½œçº¿ç¨‹è‡ªåŠ¨é€€å‡º

> å…³é—­çº¿ç¨‹æ± åº•å±‚æºç æ“ä½œä¸ºï¼šéå†çº¿ç¨‹æ± çš„æ‰€æœ‰çº¿ç¨‹ï¼Œç„¶åä¾æ¬¡è°ƒç”¨çº¿ç¨‹çš„`interrput()`æ–¹æ³•æ¥ç»ˆæ­¢çº¿ç¨‹

```java
 private void interruptIdleWorkers(boolean onlyOne) {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            for (Worker w : workers) {
                Thread t = w.thread;
                if (!t.isInterrupted() && w.tryLock()) {
                    try {
                        t.interrupt(); //ä¸­æ­¢çº¿ç¨‹
                    } catch (SecurityException ignore) {
                    } finally {
                        w.unlock();
                    }
                }
                if (onlyOne)
                    break;
            }
        } finally {
            mainLock.unlock();
        }
    }
```





### å¸¸ç”¨å‚æ•°

1. çº¿ç¨‹æ± å¸¸è§å‚æ•°æœ‰å“ªäº›ï¼Ÿ

   ```java
   /* ç”¨ç»™å®šçš„åˆå§‹å‚æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadPoolExecutor */
       public ThreadPoolExecutor(int corePoolSize,//çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°é‡
                                 int maximumPoolSize,//çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
                                 long keepAliveTime,//å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå¤šä½™çš„ç©ºé—²çº¿ç¨‹å­˜æ´»çš„æœ€é•¿æ—¶é—´
                                 TimeUnit unit,//æ—¶é—´å•ä½
                                 BlockingQueue<Runnable> workQueue,//ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨æ¥å‚¨å­˜ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—
                                 ThreadFactory threadFactory,//çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤å³å¯
                                 RejectedExecutionHandler handler//æ‹’ç»ç­–ç•¥ï¼Œå½“æäº¤çš„ä»»åŠ¡è¿‡å¤šè€Œä¸èƒ½åŠæ—¶å¤„ç†æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®šåˆ¶ç­–ç•¥æ¥å¤„ç†ä»»åŠ¡
                     )         
   ```

   - **`corePoolSize`: ** **ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æœªè¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œæœ€å¤§å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡**ï¼ˆæ ¸å¿ƒçº¿ç¨‹ä»»åŠ¡ç»“æŸåä¸ä¼šè¢«é”€æ¯ï¼Œéæ ¸å¿ƒçº¿ç¨‹åœ¨æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶ä¼šè¢«é”€æ¯ï¼‰

   - **`maximumPoolSize`: **çº¿ç¨‹æ± çš„æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°ï¼ˆä»£è¡¨å½“å‰çº¿ç¨‹æ± ä¸­ä¸€å…±å¯ä»¥æœ‰å¤šå°‘ä¸ªå·¥ä½œçº¿ç¨‹ï¼‰

   - **` BlockingQueue<Runnable> workQueue`:** æ–°ä»»åŠ¡æ¥çš„æ—¶å€™ä¼šå…ˆåˆ¤æ–­å½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå¦‚æœè¾¾åˆ°çš„è¯ï¼Œæ–°ä»»åŠ¡å°±ä¼šè¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼ˆ`BlockingDeque`ï¼‰

   - `ThreadFactory threadFactory`: çº¿ç¨‹å·¥å‚ç”¨æ¥åˆ›å»ºçº¿ç¨‹ã€è®¾ç½®çº¿ç¨‹ä¿¡æ¯

     

     `ThreadPoolExecutor`é»˜è®¤ä½¿ç”¨`DefaultThreadFactory`çº¿ç¨‹å·¥å‚æ¥åˆ›å»ºçº¿ç¨‹ï¼š

     ```java
      public interface ThreadFactory {
         Thread newThread(Runnable r);
     }
     
     
     
     
     private static class DefaultThreadFactory implements ThreadFactory {
             private static final AtomicInteger poolNumber = new AtomicInteger(1);
             private final ThreadGroup group;
             private final AtomicInteger threadNumber = new AtomicInteger(1);
             private final String namePrefix;
     
             DefaultThreadFactory() {
                 @SuppressWarnings("removal")
                 SecurityManager s = System.getSecurityManager();
                 group = (s != null) ? s.getThreadGroup() :
                                       Thread.currentThread().getThreadGroup();
                 namePrefix = "pool-" +
                               poolNumber.getAndIncrement() +
                              "-thread-";
             }
     
             //åˆ›å»ºçº¿ç¨‹çš„æ ¸å¿ƒ
             public Thread newThread(Runnable r) {
                 Thread t = new Thread(group, r,
                                       namePrefix + threadNumber.getAndIncrement(),
                                       0);
                 if (t.isDaemon())
                     t.setDaemon(false);
                 if (t.getPriority() != Thread.NORM_PRIORITY)
                     t.setPriority(Thread.NORM_PRIORITY);
                 return t;
             }
         }
     ```
   
     æ³¨æ„ï¼š
   
     è¯¥å·¥å‚ç±»ä½¿ç”¨äº† `AtomicInteger` æ¥ç»™æ–°å»ºçš„æ¯ä¸ªçº¿ç¨‹èµ‹äºˆä¸€ä¸ªå”¯ä¸€çš„ç¼–å·,åŒºåˆ†çº¿ç¨‹æ± ä¸­çš„æ¯ä¸ªçº¿ç¨‹ã€‚
   
     æ–°å»ºçš„çº¿ç¨‹éƒ½è¢«è®¾ç½®ä¸ºéå®ˆæŠ¤çº¿ç¨‹,ä¼˜å…ˆçº§ä¸ºé»˜è®¤çš„ `Thread.NORM_PRIORITY` çº§åˆ«ã€‚
   
   - **`keepAliveTime`**:ï¼ˆé’ˆå¯¹çš„éæ ¸å¿ƒçº¿ç¨‹ï¼‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº `corePoolSize` çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰å¾…ï¼Œç›´åˆ°ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† `keepAliveTime`æ‰ä¼šè¢«å›æ”¶é”€æ¯
   
   - `TimeUnit unit`: æ—¶é—´å•ä½
   
   - `handler`: é¥±å’Œ(æ‹’ç»)ç­–ç•¥â€”â€”å³å½“å‰çº¿ç¨‹æ± æ»¡äº†åï¼Œæ–°æ¥çš„ä»»åŠ¡æ€ä¹ˆå¤„ç†ï¼Ÿ
   
     
     
     



> æ¯”å¦‚ä¸€æ¬¡æ€§æäº¤äº†100ä¸ªä»»åŠ¡(**è°ƒç”¨çº¿ç¨‹æ± ä¸­çš„`execute() `æ–¹æ³•æ·»åŠ ä¸€ä¸ªä»»åŠ¡**)ï¼Œæ¯ä¸ªä»»åŠ¡æ‰§è¡Œ30ç§’,é‚£ä¹ˆæŒ‰ç…§ä¸‹é¢çš„è¿™ä¸ªçº¿ç¨‹æ± çš„å‚æ•°,100ä¸ªä»»åŠ¡éƒ½æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„å‘¢?
>
> corePoolSize=5                               maximumPoolSize=10 
>
> keepAliveTime=60                             TimeUnit=TimeUnit.seconds
>
> new LinkedBlockingQueue<>(capacity:50)       new ThreadPoolExecutor.AbortPolicy() 


   1.é¦–å…ˆçº¿ç¨‹æ± ä¼šåˆ›å»º5ä¸ªæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œå‰5ä¸ªä»»åŠ¡;

   2.ä»ç¬¬6ä¸ªä»»åŠ¡å¼€å§‹æ¥çš„éƒ½ä¼šæ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå³`LinkedBlockingDeque`ä¸­ï¼ˆé»˜è®¤å®¹é‡ä¸º50ï¼‰;

   3.å½“ä»»åŠ¡é˜Ÿåˆ—çš„50ä¸ªä»»åŠ¡æ”¾æ»¡ä»¥åï¼Œé‚£ä¹ˆå½“å‰è¿˜å‰©ä¸‹45ä¸ªä»»åŠ¡ï¼Œ å› ä¸ºæœ‰5ä¸ªåœ¨æ‰§è¡Œ + 50ä¸ªå·²åœ¨é˜»å¡é˜Ÿåˆ—ä¸­=55ä¸ª;

   4.**ç¬¬56-60ä¸ªä»»åŠ¡æ¥äº†ä»¥åæ‰ä¼šç»§ç»­åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œ,è¿™é‡Œåªèƒ½åœ¨åˆ›å»º5ä¸ªçº¿ç¨‹**ï¼Œå› ä¸ºæœ€å¤§çº¿ç¨‹æ•°æ˜¯10ï¼Œ5+5=10;

   5.ç¬¬70-100ä¸ªä»»åŠ¡æ¥äº†ä»¥åï¼Œåˆ™çº¿ç¨‹æ± å·²ç»å¤„äºæ»¡äº†çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæœ€å¤§çº¿ç¨‹æ•° = 10ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ­¤æ—¶ç¬¬70-ç¬¬100ä¸ªä»»åŠ¡ä¼šå»æ‰§è¡Œæ‹’ç»ç­–ç•¥

2. **handler**çš„æ‹’ç»ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

   **`AbortPolicy`**:æŠ›å‡º `RejectedExecutionException`æ¥æ‹’ç»æ–°ä»»åŠ¡çš„å¤„ç†

   **`CallerRunsPolicy`**::zzz:åœ¨çº¿ç¨‹æ± æ— æ³•å¤„ç†ä»»åŠ¡æ—¶å°†ä»»åŠ¡äº¤ç»™è°ƒç”¨è€…ï¼ˆä½¿ç”¨è°ƒç”¨è€…çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼‰å¤„ç†  

   **`DiscardPolicy`**:ä¸å¤„ç†æ–°ä»»åŠ¡ï¼Œç›´æ¥ä¸¢å¼ƒæ‰:heavy_multiplication_x:

   **`DiscardOldestPolicy`**:å°†`BlockingQueue`ä¸­æœ€æ—©çš„ä»»åŠ¡ä¸¢å¼ƒæ‰(`LRU`ç®—æ³•)ï¼Œç„¶åå°†å½“å‰ä»»åŠ¡å†æ¬¡å°è¯•äº¤ç»™çº¿ç¨‹æ± å¤„ç†

   

3. çº¿ç¨‹æ± ä¸­å¸¸ç”¨çš„**é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰**æœ‰å“ªäº›ï¼Ÿ

â€‹    é˜»å¡é˜Ÿåˆ—ï¼šå¦‚æœä¸€ä¸ªé˜Ÿåˆ—ä¸ºé˜»å¡é˜Ÿåˆ—ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾å¯¹ä¸€ä¸ªå·²ç»æ»¡äº†çš„é˜Ÿåˆ—è¿›è¡Œå…¥é˜Ÿåˆ—æ“ä½œæ—¶ï¼Œå®ƒå°†ä¼šè¢«é˜»å¡ï¼Œé™¤éæœ‰å¦ä¸€ä¸ªçº¿ç¨‹åšäº†å‡ºé˜Ÿåˆ—æ“ä½œï¼›åŒæ ·ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾å¯¹ä¸€ä¸ªç©ºé˜Ÿåˆ—è¿›è¡Œå‡ºé˜Ÿåˆ—æ“ä½œæ—¶åŒæ ·ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çš„çº¿ç¨‹å¾€ç©ºçš„é˜Ÿåˆ—æ’å…¥æ–°çš„å…ƒç´ ã€‚å¸¸è§é˜»å¡é˜Ÿåˆ—æœ‰ï¼ˆ`ArrayBlockingQueueã€PriorityBlockingQueue`ï¼‰

â€‹    éé˜»å¡é˜Ÿåˆ—ï¼šè‹¥é˜Ÿåˆ—ä¸ºç©ºä»ä¸­è·å–å…ƒç´ åˆ™ä¼šè¿”å›ç©ºï¼Œè‹¥é˜Ÿåˆ—æ»¡äº†æ’å…¥å…ƒç´ åˆ™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ç­‰å¾…ï¼›å¸¸è§çš„é˜»å¡é˜Ÿåˆ—æœ‰ï¼ˆ`PriorityQueueã€ConcurrentLinkedQueue`ï¼‰

â€‹    æœ‰ç•Œé˜Ÿåˆ—ï¼šå°±æ˜¯æœ‰å›ºå®šå¤§å°çš„é˜Ÿåˆ—ã€‚æ¯”å¦‚è®¾å®šäº†å›ºå®šå¤§å°çš„`ArrayBlockingQueue`

â€‹    æ— ç•Œé˜Ÿåˆ—ï¼šæŒ‡çš„æ˜¯æ²¡æœ‰è®¾ç½®å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼ˆå®é™…ä¸Šé»˜è®¤å€¼ä¸º`Integer.MAX_VALUE`ï¼‰,æ— ç•Œé˜Ÿåˆ—çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥ä¸€ç›´å…¥é˜Ÿï¼Œä¸å­˜åœ¨é˜Ÿåˆ—æ»¡è´Ÿè·çš„ç°è±¡,ä»ä½¿ç”¨è€…çš„ä½“éªŒä¸Šï¼Œå°±ç›¸å½“äº â€œæ— ç•Œâ€

æ³¨æ„äº‹é¡¹ï¼š

1. å®¹é‡ä¸º `Integer.MAX_VALUE` çš„ `LinkedBlockingQueue`ï¼ˆæ— ç•Œé˜Ÿåˆ—ï¼‰ï¼š`FixedThreadPool` å’Œ `SingleThreadExector` ã€‚ç”±äºé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ”¾æ»¡ï¼Œå› æ­¤`FixedThreadPool`æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼ˆ**æ°¸è¿œä¸ä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹**ï¼Œæ•…`corePoolSize ç­‰äºmaximumPoolSize`ï¼‰ã€‚
2. `SynchronousQueue`ï¼ˆåŒæ­¥é˜Ÿåˆ—ï¼‰ï¼š`CachedThreadPool` ã€‚`SynchronousQueue` æ²¡æœ‰å®¹é‡ï¼Œä¸å­˜å‚¨å…ƒç´ ï¼Œç›®çš„æ˜¯ä¿è¯å¯¹äºæäº¤çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ç©ºé—²çº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨ç©ºé—²çº¿ç¨‹æ¥å¤„ç†ï¼›å¦åˆ™æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`CachedThreadPool` çš„æœ€å¤§çº¿ç¨‹æ•°æ˜¯ `Integer.MAX_VALUE` ï¼Œå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹æ•°æ˜¯å¯ä»¥æ— é™æ‰©å±•çš„ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚
3. `DelayedWorkQueue`ï¼š`ScheduledThreadPool` å’Œ `SingleThreadScheduledExecutor`ä½¿ç”¨è¯¥é˜»å¡é˜Ÿåˆ—,`DelayedWorkQueue` çš„å†…éƒ¨å…ƒç´ å¹¶ä¸æ˜¯æŒ‰ç…§æ”¾å…¥çš„æ—¶é—´æ’åºï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§å»¶è¿Ÿçš„æ—¶é—´é•¿çŸ­å¯¹ä»»åŠ¡è¿›è¡Œæ’åºï¼Œå†…éƒ¨é‡‡ç”¨çš„æ˜¯â€œå †â€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ä¿è¯æ¯æ¬¡å‡ºé˜Ÿçš„ä»»åŠ¡éƒ½æ˜¯å½“å‰é˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´æœ€é å‰çš„ã€‚`DelayedWorkQueue` æ·»åŠ å…ƒç´ æ»¡äº†ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹åŸæ¥å®¹é‡çš„ 1/2ï¼Œå³æ°¸è¿œä¸ä¼šé˜»å¡ï¼Œæœ€å¤§æ‰©å®¹å¯è¾¾ `Integer.MAX_VALUE`ï¼Œæ‰€ä»¥æœ€å¤šåªèƒ½åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹



### å¦‚ä½•é…ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿ


æ ¹æ®ç³»ç»Ÿèµ„æºï¼š

- æŸ¥çœ‹ç³»ç»Ÿçš„CPUæ ¸å¿ƒæ•°å’Œå†…å­˜æƒ…å†µï¼Œä»¥åŠå…¶ä»–å…³é”®èµ„æºçš„ä½¿ç”¨æƒ…å†µã€‚é€šå¸¸ï¼Œ**çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ä¸åº”è¶…è¿‡CPUæ ¸å¿ƒæ•°ï¼Œè¿™å¯ä»¥é˜²æ­¢è¿‡å¤šçš„çº¿ç¨‹ç«äº‰CPUèµ„æºï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¢åŠ **ï¼Œåè€Œé™ä½æ€§èƒ½ã€‚
- ç¡®ä¿çº¿ç¨‹æ± å¤§å°ä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„å†…å­˜èµ„æºï¼Œè¿‡å¤šçš„çº¿ç¨‹å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºæˆ–ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ã€‚

è€ƒè™‘ä»»åŠ¡ç±»å‹ï¼š

- **å¦‚æœç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„CPUå¯†é›†å‹ä»»åŠ¡ï¼ˆè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼‰ï¼Œå¯ä»¥é…ç½®è¾ƒå°çš„çº¿ç¨‹æ± å¤§å°ï¼Œé¿å…è¿‡å¤šçš„çº¿ç¨‹ç«äº‰CPUèµ„æº**â€”â€”â€”â€”â€”â€”â€”â€”å¯ä»¥è¿™ä¹ˆç†è§£ï¼šCPUå·²ç»æ»¡è´Ÿè·å·¥ä½œäº†è¿˜å¼€å¤šçº¿ç¨‹é¢‘ç¹è¿›è¡Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™ä¸æ˜¯ç™½æµªè´¹èµ„æº
- **å¦‚æœç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„IOå¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œï¼‰ï¼Œå¯ä»¥é€‚å½“å¢å¤§çº¿ç¨‹æ± å¤§å°**ï¼Œä»¥ä¾¿çº¿ç¨‹åœ¨IOç­‰å¾…æ—¶å¯ä»¥è¢«æ›´å……åˆ†åœ°åˆ©ç”¨

è€ƒè™‘ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼š

- å¦‚æœä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´è¾ƒçŸ­ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šå¹¶å‘è¯·æ±‚ï¼Œå¯ä»¥é…ç½®è¾ƒå¤§çš„çº¿ç¨‹æ± å¤§å°ï¼Œä»¥ä¾¿æ›´å¿«åœ°å“åº”è¯·æ±‚
- å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œå¯ä»¥é€‚å½“å‡å°çº¿ç¨‹æ± å¤§å°ï¼Œé¿å…çº¿ç¨‹è¿‡å¤šï¼Œå¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½

ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼š

- åœ¨é…ç½®çº¿ç¨‹æ± æ—¶ï¼Œæœ€å¥½ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œé¿å…çº¿ç¨‹æ± ä¸­ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡è¿‡å¤šï¼Œå¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ã€‚æœ‰ç•Œé˜Ÿåˆ—å¯ä»¥é™åˆ¶ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ï¼Œä¸€æ—¦é˜Ÿåˆ—æ»¡äº†ï¼Œçº¿ç¨‹æ± ä¼šæ‹’ç»æ–°çš„ä»»åŠ¡ã€‚

ç›‘æ§å’Œè°ƒæ•´ï¼š

- åœ¨é…ç½®çº¿ç¨‹æ± åï¼Œè§‚å¯Ÿç³»ç»Ÿçš„æ€§èƒ½æŒ‡æ ‡ï¼Œå¦‚å“åº”æ—¶é—´ã€ååé‡å’Œç³»ç»Ÿè´Ÿè½½ç­‰ï¼Œæ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚ç›‘æ§ç³»ç»Ÿçš„çº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦å’Œä»»åŠ¡æ‰§è¡Œæ—¶é—´ç­‰æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜å¹¶åšå‡ºè°ƒæ•´ã€‚









## Future é‡è¦ :star2::star2:

åœ¨ Java ä¸­ï¼Œ`Future` æ˜¯è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœçš„æ¥å£ã€‚`Future` å¯¹è±¡æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå¯ä»¥**åœ¨ä»»åŠ¡æäº¤åç«‹å³è¿”å›**, å…è®¸ä¸»çº¿ç¨‹åœ¨åå°ä»»åŠ¡æ‰§è¡Œçš„åŒæ—¶æ‰§è¡Œå…¶ä»–æ“ä½œ,è¿™ä½¿å¾—ä»»åŠ¡çš„æ‰§è¡Œå’Œä¸»çº¿ç¨‹çš„æ“ä½œå¯ä»¥å¹¶è¡Œè¿›è¡Œã€‚`Future` å¯¹è±¡çš„å¼‚æ­¥æ€§ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. éé˜»å¡è¿”å›ï¼šå½“ä¸»çº¿ç¨‹é€šè¿‡ `submit()` æ–¹æ³•æäº¤ä»»åŠ¡ç»™ `ExecutorService` åï¼Œå®ƒä¼šç«‹å³è¿”å›ä¸€ä¸ª `Future` å¯¹è±¡ï¼Œè€Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚è¿™æ„å‘³ç€ä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œè€Œä¸å¿…é˜»å¡ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚
2. å¼‚æ­¥æ‰§è¡Œï¼šå¼‚æ­¥ä»»åŠ¡é€šå¸¸åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸»çº¿ç¨‹ã€‚è¿™æ ·å¯ä»¥å°†è€—æ—¶çš„æ“ä½œæˆ–éœ€è¦ç­‰å¾…çš„æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€IO æ“ä½œç­‰ï¼‰æ”¾åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨æˆ–é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚
3. è·å–ç»“æœçš„é˜»å¡ï¼šé€šè¿‡ `Future` å¯¹è±¡çš„ `get()` æ–¹æ³•å¯ä»¥è·å–ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚å¦‚æœä»»åŠ¡å°šæœªå®Œæˆï¼Œ`get()` æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶è¿”å›ç»“æœã€‚è¿™ç§é˜»å¡æ˜¯ç”±ä¸»çº¿ç¨‹ä¸»åŠ¨è§¦å‘çš„ï¼Œä»¥è·å–å¼‚æ­¥ä»»åŠ¡çš„æœ€ç»ˆç»“æœã€‚

é€šè¿‡å°†è€—æ—¶æ“ä½œæ”¾åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œå¹¶ä½¿ç”¨ `Future` å¯¹è±¡è·å–ç»“æœï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤šçº¿ç¨‹æˆ–å¹¶å‘å¤„ç†çš„ä¼˜åŠ¿ï¼Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ä¸»çº¿ç¨‹å¯ä»¥åœ¨åå°ä»»åŠ¡æ‰§è¡Œçš„åŒæ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œè€Œä¸å¿…ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚è¿™ç§å¼‚æ­¥æ‰§è¡Œçš„ç‰¹æ€§å¯ä»¥åœ¨å¤„ç†å¹¶å‘ä»»åŠ¡ã€æé«˜ç³»ç»Ÿååé‡å’Œå“åº”æ€§ç­‰æ–¹é¢å‘æŒ¥ä½œç”¨

### Futureç±»å¸¸ç”¨æ–¹æ³•

åœ¨ Java ä¸­ï¼Œ`Future` ç±»åªæ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œä½äº `java.util.concurrent` åŒ…ä¸‹ï¼Œå…¶ä¸­å®šä¹‰äº† 5 ä¸ªæ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢è¿™ 4 ä¸ªåŠŸèƒ½ï¼š

- å–æ¶ˆä»»åŠ¡ï¼›
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ;
- åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ;
- è·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚



```java
// V ä»£è¡¨äº†Futureæ‰§è¡Œçš„ä»»åŠ¡è¿”å›å€¼çš„ç±»å‹
public interface Future<V> {
    // å–æ¶ˆä»»åŠ¡æ‰§è¡Œ
    // æˆåŠŸå–æ¶ˆè¿”å› trueï¼Œå¦åˆ™è¿”å› false
    boolean cancel(boolean mayInterruptIfRunning);
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
    boolean isCancelled();
    // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»æ‰§è¡Œå®Œæˆ
    boolean isDone();
    // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ
    V get() throws InterruptedException, ExecutionException;
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¿”å›è®¡ç®—ç»“æœå°±æŠ›å‡º TimeOutException å¼‚å¸¸
    V get(long timeout, TimeUnit unit)

        throws InterruptedException, ExecutionException, TimeoutExceptio

}
```

ç®€å•ç†è§£å°±æ˜¯ï¼šæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œæäº¤ç»™äº† `Future` æ¥å¤„ç†ã€‚ä»»åŠ¡æ‰§è¡ŒæœŸé—´æˆ‘è‡ªå·±å¯ä»¥å»åšä»»ä½•æƒ³åšçš„äº‹æƒ…ã€‚å¹¶ä¸”ï¼Œåœ¨è¿™æœŸé—´æˆ‘è¿˜å¯ä»¥å–æ¶ˆä»»åŠ¡ä»¥åŠè·å–ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ã€‚ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå°±å¯ä»¥ `Future` é‚£é‡Œç›´æ¥å–å‡ºä»»åŠ¡æ‰§è¡Œç»“æœ



### FutureTask

`FutureTask` ç±»å®ç°äº† `RunnableFuture` æ¥å£ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ `RunnableFuture` æ¥å£çš„å®ç°ï¼š

```java
public interface RunnableFuture<V> extends Runnable, Future<V> {
    void run();
}

public class FutureTask<V> implements RunnableFuture<V>{
    
}
```

å¯ä»¥çœ‹å‡º `RunnableFuture` ç»§æ‰¿äº† `Runnable` æ¥å£å’Œ `Future` æ¥å£ï¼Œè€Œ `FutureTask` å®ç°äº† `RunnableFuture` æ¥å£ã€‚**æ‰€ä»¥å®ƒæ—¢å¯ä»¥ä½œä¸º `Runnable` è¢«çº¿ç¨‹æ‰§è¡Œï¼Œåˆå¯ä»¥ä½œä¸º `Future` å¾—åˆ° `Callable` çš„è¿”å›å€¼**ã€‚åæ˜ åœ¨ç¨‹åºä¸Šå°±æ˜¯æ—¢èƒ½ä¼ å…¥`Thread`æ‰§è¡Œï¼Œåˆèƒ½é€šè¿‡`futureTask.get()`è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ



- FutureTaskæœ‰ä»¥ä¸‹2ä¸ªç‰¹å¾ï¼š
  - èƒ½åŒ…è£…Runnableå’ŒCallableï¼ˆæ„é€ å™¨ä¼ å…¥ï¼‰ï¼Œä½†æœ¬èº«å´åˆå®ç°äº†Runnableæ¥å£ï¼Œå³æœ¬è´¨æ˜¯Runnable
  - æ—¢ç„¶æ˜¯Runnableï¼Œæ‰€ä»¥FutureTaskèƒ½ä½œä¸ºä»»åŠ¡è¢«Threadæ‰§è¡Œï¼Œä½†è¯¡å¼‚çš„æ˜¯ä¹Ÿå¯ä»¥é€šè¿‡FutureTask.get()è·å–ç»“æœ



> `ExecutorService` æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒç»§æ‰¿è‡ª `Executor` æ¥å£ï¼Œç”¨äºæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œ`ExecutorService` æ¥å£æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥ç®¡ç†å’Œæ§åˆ¶å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯ `submit()` æ–¹æ³•ï¼š**`submit()` æ–¹æ³•ç”¨äºæäº¤ä¸€ä¸ªå¯æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆ`Runnable` æˆ– `Callable` å¯¹è±¡ï¼‰ç»™ `ExecutorService` è¿›è¡Œæ‰§è¡Œï¼Œå¹¶è¿”å›ä¸€ä¸ªè¡¨ç¤ºè¯¥ä»»åŠ¡çš„ `Future` å¯¹è±¡**ã€‚`Future` å¯¹è±¡å¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œç»“æœæˆ–å–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œ

```java
import java.util.concurrent.*;

class MyTask implements Callable<Integer> {
    private int value;

    public MyTask(int value) {
        this.value = value;
    }

    @Override
    public Integer call() throws Exception {
        // æ‰§è¡Œä»»åŠ¡é€»è¾‘ï¼Œè¿™é‡Œç®€å•åœ°è¿”å› value çš„å¹³æ–¹
        return value * value;
    }
}

public class Main {
    public static void main(String[] args) throws InterruptedException, ExecutionException {
        // åˆ›å»ºçº¿ç¨‹æ± 
        ExecutorService executorService = Executors.newFixedThreadPool(5);

        // æäº¤ä»»åŠ¡ç»™çº¿ç¨‹æ± 
        Future<Integer> future = executorService.submit(new MyTask(5));

        // è·å–ä»»åŠ¡çš„ç»“æœ
        int result = future.get();
        System.out.println(result); // è¾“å‡º: 25

        // å…³é—­çº¿ç¨‹æ± 
        executorService.shutdown();
    }
}

```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `MyTask` ç±»å®ç°äº† `Callable` æ¥å£ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ•´æ•°å€¼å¹¶è¿”å›å…¶å¹³æ–¹ã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ `Executors.newFixedThreadPool(5)` åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°ä¸º 5 çš„çº¿ç¨‹æ± ï¼Œé€šè¿‡ `executorService.submit()` æ–¹æ³•å°† `MyTask` å¯¹è±¡æäº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œã€‚è¿”å›çš„ `Future` å¯¹è±¡å¯ä»¥ä½¿ç”¨ `get()` æ–¹æ³•è·å–ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œæœ€åå°†ç»“æœæ‰“å°å‡ºæ¥

ä½¿ç”¨ `submit()` æ–¹æ³•ï¼Œä½ å¯ä»¥å°†ä»»åŠ¡æäº¤ç»™ `ExecutorService` æ‰§è¡Œï¼Œå¹¶é€šè¿‡ `Future` å¯¹è±¡è·å–ä»»åŠ¡çš„ç»“æœæˆ–è¿›è¡Œå…¶ä»–æ“ä½œï¼Œå¦‚å–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œ







ä¾‹å­ï¼šä½¿ç”¨`Callable`+`FutureTask`è·å–æ‰§è¡Œç»“æœ

```java
public class Test {
    public static void main(String[] args) {
        //ç¬¬ä¸€ç§æ–¹å¼
        ExecutorService executor = Executors.newCachedThreadPool();
        Task task = new Task();
        FutureTask<Integer> futureTask = new FutureTask<Integer>(task);
        executor.submit(futureTask);
        executor.shutdown();
         
        //ç¬¬äºŒç§æ–¹å¼ï¼Œæ³¨æ„è¿™ç§æ–¹å¼å’Œç¬¬ä¸€ç§æ–¹å¼æ•ˆæœæ˜¯ç±»ä¼¼çš„ï¼Œ
        //åªä¸è¿‡ä¸€ä¸ªä½¿ç”¨çš„æ˜¯ExecutorServiceï¼Œä¸€ä¸ªä½¿ç”¨çš„æ˜¯Thread
        /*Task task = new Task();
        FutureTask<Integer> futureTask = new FutureTask<Integer>(task);
        Thread thread = new Thread(futureTask);
        thread.start();*/
         
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e1) {
            e1.printStackTrace();
        }
         
        System.out.println("ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡");
         
        try {
            System.out.println("taskè¿è¡Œç»“æœ"+futureTask.get()); //é€šè¿‡futuretaskæ¥è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }
        
        System.out.println("æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•");
    }
}
class Task implements Callable<Integer>{
    @Override
    public Integer call() throws Exception {
        System.out.println("å­çº¿ç¨‹åœ¨è¿›è¡Œè®¡ç®—");
        Thread.sleep(3000);
        int sum = 0;
        for(int i=0;i<100;i++)
            sum += i;
        return sum;
    }
}

```

è¾“å‡ºå¦‚ä¸‹ï¼š

```
å­çº¿ç¨‹åœ¨è¿›è¡Œè®¡ç®—
ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡
taskè¿è¡Œç»“æœ4950
æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
```



### CompletableFuture

`CompletableFuture`å’Œ`FutureTask`çš„å¼‚åŒç‚¹ï¼š

- ç›¸åŒï¼šéƒ½å®ç°äº†Futureæ¥å£ï¼Œæ‰€ä»¥éƒ½å¯ä»¥ä½¿ç”¨è¯¸å¦‚ Future.get()ã€Future.isDone()ã€Future.cancel() ç­‰æ–¹æ³•
- `CompletableFuture`æ²¡æœ‰å®ç°`Runnable`æ¥å£ï¼Œ**æ— æ³•ä½œä¸ºä»»åŠ¡è¢«æ‰§è¡Œï¼Œ**æ‰€ä»¥æ— æ³•æŠŠå®ƒç›´æ¥ä¸¢ç»™çº¿ç¨‹æ± æ‰§è¡Œ
- `FutureTask`å’Œ`CompletableFuture`æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œ`FutureTask`éœ€è¦è°ƒç”¨è€…çº¿ç¨‹ä¸»åŠ¨é˜»å¡å¼è·å–(å³è°ƒç”¨`get()`æ—¶ä¾æ—§æ˜¯é˜»å¡å¼çš„)ï¼Œè€Œ`CompletableFuture`æ”¯æŒå¼‚æ­¥å›è°ƒ



Futureä¾ç„¶æœ‰ä¸€äº›å±€é™æ€§ï¼š

1. æ— æ³•å°†ä¸¤ä¸ªå¼‚æ­¥è®¡ç®—çš„ç»“æœåˆå¹¶ä¸ºä¸€ä¸ªã€‚
2. ç­‰å¾…Futureé›†åˆä¸­æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚
3. ç­‰å¾…Futureé›†åˆä¸­æœ€å¿«ä»»åŠ¡å®Œæˆï¼ˆé€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œæ–¹æ¡ˆï¼‰ã€‚
4. é€šè¿‡ç¼–ç¨‹çš„æ–¹å¼å®Œæˆä¸€ä¸ªFutureä»»åŠ¡çš„æ‰§è¡Œï¼ˆæ‰‹å·¥è®¾å®šå¼‚æ­¥ç»“æœå¤„ç†ï¼‰ã€‚
5. åº”å¯¹Futureçš„å®Œæˆäº‹ä»¶ï¼Œå½“Futureçš„å®Œæˆäº‹ä»¶å‘ç”Ÿæ—¶ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶å¯ä»¥ä½¿ç”¨Futureçš„ç»“æœè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼Œä¸åªæ˜¯ç®€å•çš„é˜»å¡ç­‰å¾…ã€‚

è€ŒCompletableFutureç±»å®ç°äº†Futureæ¥å£ï¼Œå¯ä»¥å°†ä¸Šè¿°çš„é—®é¢˜å…¨éƒ¨è§£å†³ã€‚CompletableFutureä¸Streamçš„è®¾è®¡éƒ½éµå¾ªäº†ç±»ä¼¼çš„è®¾è®¡æ¨¡å¼ï¼šä½¿ç”¨Lambdaè¡¨è¾¾å¼ä»¥åŠæµæ°´çº¿çš„æ€æƒ³ï¼Œä»è¿™ä¸ªè§’åº¦å¯ä»¥è¯´CompletableFutureä¸Futureçš„å…³ç³»ç±»ä¼¼äºStreamä¸Collectionçš„å…³ç³»











### Fork/Join æ¡†æ¶

`Fork/Join` æ¡†æ¶çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¤§ä»»åŠ¡åˆ’åˆ†ä¸ºå°ä»»åŠ¡ï¼Œé€’å½’åœ°æ‹†åˆ†ä»»åŠ¡ç›´åˆ°ä»»åŠ¡è¶³å¤Ÿå°ä¸”å¯ä»¥è¢«ç›´æ¥æ‰§è¡Œã€‚ç„¶åï¼Œæ¡†æ¶åˆ©ç”¨å·¥ä½œçªƒå–ï¼ˆwork-stealingï¼‰ç®—æ³•ï¼Œåœ¨çº¿ç¨‹æ± å†…çš„çº¿ç¨‹ä¹‹é—´åŠ¨æ€åœ°åˆ†é…å’Œæ‰§è¡Œè¿™äº›å°ä»»åŠ¡ã€‚å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­å·å–ä»»åŠ¡æ‰§è¡Œï¼Œä»è€Œå®ç°è´Ÿè½½å‡è¡¡å’Œæé«˜å¹¶è¡Œæ€§ã€‚

ä¸ `Future` ç›¸å…³ï¼Œ`ForkJoinTask` æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº† `Future` æ¥å£ã€‚å› æ­¤ï¼Œ`ForkJoinTask` æ—¢èƒ½è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œåˆèƒ½è·å–ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚

`ForkJoinTask` æä¾›äº† `fork()` å’Œ `join()` æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œä»»åŠ¡çš„æ‹†åˆ†å’Œåˆå¹¶ï¼š

- `fork()` æ–¹æ³•å°†ä»»åŠ¡æ‹†åˆ†ä¸ºæ›´å°çš„å­ä»»åŠ¡ï¼Œå¹¶å°†å­ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚
- `join()` æ–¹æ³•ç”¨äºç­‰å¾…å­ä»»åŠ¡çš„æ‰§è¡Œç»“æœï¼Œå¹¶åˆå¹¶å­ä»»åŠ¡çš„ç»“æœã€‚å¦‚æœå­ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™ `join()` æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°å­ä»»åŠ¡æ‰§è¡Œå®Œæˆå¹¶è¿”å›ç»“æœã€‚

`ForkJoinPool` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œå®ƒé’ˆå¯¹ Fork/Join æ¡†æ¶è¿›è¡Œäº†ä¼˜åŒ–ã€‚å®ƒæä¾›äº†ç®¡ç†å’Œæ‰§è¡Œ `ForkJoinTask` å¯¹è±¡çš„åŠŸèƒ½ï¼Œä»¥å®ç°ä»»åŠ¡çš„å¹¶è¡Œæ‰§è¡Œã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œ`Fork/Join` æ¡†æ¶å’Œ `Future` æœ‰ä»¥ä¸‹å…³ç³»ï¼š

1. `ForkJoinTask` å®ç°äº† `Future` æ¥å£ï¼Œå› æ­¤å¯ä»¥è¡¨ç¤ºå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœã€‚
2. `ForkJoinTask` çš„ `fork()` å’Œ `join()` æ–¹æ³•æä¾›äº†ä»»åŠ¡çš„æ‹†åˆ†å’Œåˆå¹¶åŠŸèƒ½ï¼Œå¯ä»¥å®ç°ä»»åŠ¡çš„å¹¶è¡Œæ‰§è¡Œå’Œç»“æœçš„åˆå¹¶ã€‚
3. `ForkJoinPool` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œç”¨äºç®¡ç†å’Œæ‰§è¡Œ `ForkJoinTask` å¯¹è±¡ï¼Œå®ç°ä»»åŠ¡çš„å¹¶è¡Œå¤„ç†ã€‚
4. `ForkJoinTask` å’Œ `ForkJoinPool` å¯ä»¥ç»“åˆä½¿ç”¨ï¼Œé€šè¿‡æ‹†åˆ†å’Œåˆå¹¶ä»»åŠ¡ï¼Œå¹¶åˆ©ç”¨å·¥ä½œçªƒå–ç®—æ³•ï¼Œå®ç°ä»»åŠ¡çš„å¹¶è¡Œæ‰§è¡Œå’Œé«˜æ•ˆçš„è´Ÿè½½å‡è¡¡ã€‚

æ€»çš„æ¥è¯´ï¼Œ`Fork/Join` æ¡†æ¶æä¾›äº†ä¸€ç§é«˜æ•ˆçš„å¹¶è¡Œä»»åŠ¡å¤„ç†æ–¹å¼ï¼Œåˆ©ç”¨ `Future` æ¥å£è·å–ä»»åŠ¡ç»“æœï¼Œè€Œ `ForkJoinPool` åˆ™æ˜¯æ”¯æŒè¿™ç§æ¡†æ¶çš„ç‰¹å®šçº¿ç¨‹æ± å®ç°





## UnSafeç±» é‡è¦âœ¨âœ¨

`Unsafe` æ˜¯ä½äº `sun.misc` åŒ…ä¸‹çš„ä¸€ä¸ªç±»ï¼Œä¸»è¦æä¾›ä¸€äº›ç”¨äºæ‰§è¡Œä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚**ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºã€è‡ªä¸»ç®¡ç†å†…å­˜èµ„æº**ç­‰ï¼Œè¿™äº›æ–¹æ³•åœ¨**æå‡ Java è¿è¡Œæ•ˆç‡ã€å¢å¼º Java è¯­è¨€åº•å±‚èµ„æºæ“ä½œèƒ½åŠ›**æ–¹é¢èµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ã€‚ä½†ç”±äº `Unsafe` ç±»ä½¿ Java è¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼ C è¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©

åŒæ—¶`Unsafe` æä¾›çš„åŠŸèƒ½å®ç°éœ€è¦ä¾èµ–æœ¬åœ°æ–¹æ³•ï¼ˆ`Native Method`ï¼‰ã€‚å¯ä»¥å°†æœ¬åœ°æ–¹æ³•çœ‹ä½œæ˜¯ Java ä¸­ä½¿ç”¨å…¶ä»–ç¼–ç¨‹è¯­è¨€(C++ C)ç¼–å†™çš„æ–¹æ³•ã€‚æœ¬åœ°æ–¹æ³•ä½¿ç”¨ **`native`** å…³é”®å­—ä¿®é¥°ï¼ŒJava ä»£ç ä¸­åªæ˜¯å£°æ˜æ–¹æ³•å¤´ï¼Œå…·ä½“çš„å®ç°åˆ™äº¤ç»™ **æœ¬åœ°ä»£ç **ï¼Œä½¿ç”¨æœ¬åœ°æ–¹æ³•çš„åŸå› åœ¨äºï¼š

- ç¨‹åºéœ€è¦ç”¨åˆ°Javaä¸å…·å¤‡çš„ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ç‰¹æ€§ï¼ŒJavaåœ¨å®ç°è·¨å¹³å°çš„åŒæ—¶è¦å®ç°å¯¹åº•å±‚çš„æ§åˆ¶ï¼Œè¿™å°±éœ€è¦å€ŸåŠ©å…¶ä»–è¯­è¨€
- å¯¹äºå…¶ä»–è¯­è¨€å·²ç»å®Œæˆçš„ä¸€äº›ç°æˆåŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨Javaç›´æ¥è°ƒç”¨
- ç¨‹åºå¯¹æ—¶é—´æ•æ„Ÿæˆ–å¯¹æ€§èƒ½è¦æ±‚éå¸¸é«˜æ—¶ï¼Œæœ‰å¿…è¦ä½¿ç”¨æ›´åŠ åº•å±‚çš„è¯­è¨€ï¼Œä¾‹å¦‚C/C++ç”šè‡³æ˜¯æ±‡ç¼–





### æ“ä½œå†…å­˜

åœ¨ Java ä¸­ä¸å…è®¸ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¯¹è±¡å†…å­˜çš„åˆ†é…å’Œå›æ”¶éƒ½æ˜¯ç”± JVM è‡ªå·±å®ç°ï¼Œä½†æ˜¯åœ¨ `Unsafe` ä¸­ï¼Œæä¾›çš„ä¸‹åˆ—æ¥å£å¯ä»¥ç›´æ¥è¿›è¡Œå†…å­˜æ“ä½œï¼š

```java
//åˆ†é…æ–°çš„æœ¬åœ°ç©ºé—´
public native long allocateMemory(long bytes);
//é‡æ–°è°ƒæ•´å†…å­˜ç©ºé—´çš„å¤§å°
public native long reallocateMemory(long address, long bytes);
//å°†å†…å­˜è®¾ç½®ä¸ºæŒ‡å®šå€¼
public native void setMemory(Object o, long offset, long bytes, byte value);
//å†…å­˜æ‹·è´
public native void copyMemory(Object srcBase, long srcOffset,Object destBase, long destOffset,long bytes);
//æ¸…é™¤å†…å­˜
public native void freeMemory(long address);
```



éœ€è¦æ³¨æ„çš„æ˜¯ç»è¿™ç§æ–¹å¼åˆ†é…çš„å†…å­˜å±äº **å †å¤–å†…å­˜**ï¼Œæ— æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œè¦æŠŠè¿™äº›å†…å­˜å½“åšä¸€ç§èµ„æºå»æ‰‹åŠ¨è°ƒç”¨`freeMemory`æ–¹æ³•è¿›è¡Œé‡Šæ”¾ï¼Œå¦åˆ™ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼:-1: ï¼Œ**ä½¿ç”¨å †å¤–å†…å­˜**çš„å¥½å¤„åœ¨äºï¼š

- æ”¹å–„**åƒåœ¾å›æ”¶åœé¡¿**ï¼šç”±äºå †å¤–å†…å­˜ç›´æ¥å—æ“ä½œç³»ç»Ÿç®¡ç†è€Œä¸æ˜¯ JVMï¼Œæ‰€ä»¥ä½¿ç”¨å †å¤–å†…å­˜æ—¶ï¼Œå¯ä¿æŒè¾ƒå°çš„å †å†…å†…å­˜è§„æ¨¡ã€‚ä»è€Œåœ¨ GC æ—¶å‡å°‘å›æ”¶åœé¡¿å¯¹äºå…¶ä»–åº”ç”¨çš„å½±å“
- æå‡ç¨‹åº I/O æ“ä½œçš„æ€§èƒ½ï¼šé€šå¸¸åœ¨ I/O é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¼šå­˜åœ¨å †å†…å†…å­˜åˆ°å †å¤–å†…å­˜çš„æ•°æ®æ‹·è´æ“ä½œï¼Œå¯¹äºéœ€è¦é¢‘ç¹è¿›è¡Œå†…å­˜é—´æ•°æ®æ‹·è´ä¸”ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„æš‚å­˜æ•°æ®ï¼Œéƒ½å»ºè®®å­˜å‚¨åˆ°å †å¤–å†…å­˜



### å†…å­˜å±éšœ

ç¼–è¯‘å™¨å’Œ CPU ä¼šåœ¨ä¿è¯ç¨‹åºè¾“å‡ºç»“æœä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œä¼šå¯¹ä»£ç è¿›è¡Œ**é‡æ’åº**ï¼Œä»æŒ‡ä»¤ä¼˜åŒ–è§’åº¦æå‡æ€§èƒ½ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¸¦æ¥ä¸€ä¸ªä¸å¥½çš„ç»“æœï¼šå¯¼è‡´ CPU çš„é«˜é€Ÿç¼“å­˜å’Œå†…å­˜ä¸­æ•°æ®çš„ä¸ä¸€è‡´ã€‚è€Œå†…å­˜å±éšœï¼ˆ`Memory Barrier`ï¼‰å°±æ˜¯é€šè¿‡é˜»æ­¢å±éšœä¸¤è¾¹çš„æŒ‡ä»¤é‡æ’åºä»è€Œé¿å…ç¼–è¯‘å™¨å’Œç¡¬ä»¶çš„ä¸æ­£ç¡®ä¼˜åŒ–

åœ¨ Java8 ä¸­ï¼Œå¼•å…¥äº† 3 ä¸ªå†…å­˜å±éšœçš„å‡½æ•°ï¼Œæ¥å®ç°å†…å­˜å±éšœçš„åŠŸèƒ½ï¼š

```java
//å†…å­˜å±éšœï¼Œç¦æ­¢loadæ“ä½œé‡æ’åºã€‚å±éšœå‰çš„loadæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœåï¼Œå±éšœåçš„loadæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœå‰
public native void loadFence();
//å†…å­˜å±éšœï¼Œç¦æ­¢storeæ“ä½œé‡æ’åºã€‚å±éšœå‰çš„storeæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœåï¼Œå±éšœåçš„storeæ“ä½œä¸èƒ½è¢«é‡æ’åºåˆ°å±éšœå‰
public native void storeFence();
//å†…å­˜å±éšœï¼Œç¦æ­¢loadã€storeæ“ä½œé‡æ’åº
public native void fullFence();

//loadä¸ºè¯»æ“ä½œ storeä¸ºå†™æ“ä½œ
```

å†…å­˜å±éšœå¯ä»¥çœ‹åšå¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œä¸­çš„ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œä½¿å¾—æ­¤ç‚¹ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ‰§è¡Œåæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œæ­¤ç‚¹ä¹‹åçš„æ“ä½œã€‚ä»¥`loadFence`æ–¹æ³•ä¸ºä¾‹ï¼Œå®ƒä¼šç¦æ­¢è¯»æ“ä½œé‡æ’åºï¼Œä¿è¯åœ¨è¿™ä¸ªå±éšœä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œéƒ½å·²ç»å®Œæˆï¼Œå¹¶ä¸”**å°†çº¿ç¨‹å·¥ä½œå†…å­˜ä¸­çš„ç¼“å­˜æ•°æ®è®¾ä¸ºæ— æ•ˆï¼Œå¼ºåˆ¶é‡æ–°ä»ä¸»å†…å­˜ä¸­è¿›è¡ŒåŠ è½½**ï¼š

```java
@Getter
class ChangeThread implements Runnable{
    /**volatile**/ boolean flag=false;
    @Override
    public void run() {
        try {
            Thread.sleep(3000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("subThread change flag to:" + flag);
        flag = true;
    }
}



/*åœ¨ä¸»çº¿ç¨‹çš„whileå¾ªç¯ä¸­ï¼ŒåŠ å…¥å†…å­˜å±éšœï¼Œæµ‹è¯•æ˜¯å¦èƒ½å¤Ÿæ„ŸçŸ¥åˆ°flagçš„ä¿®æ”¹å˜åŒ–*/
public static void main(String[] args){
    ChangeThread changeThread = new ChangeThread();
    new Thread(changeThread).start();
    while (true) {
        boolean flag = changeThread.isFlag();
        unsafe.loadFence(); //åŠ å…¥è¯»å†…å­˜å±éšœ
        if (flag){
            System.out.println("detected flag changed");
            break;
        }
    }
    System.out.println("main thread end");
}


//è¿è¡Œç»“æœä¸ºï¼š
subThread change flag to:false
detected flag changed
main thread end

```

åˆ†æä»¥ä¸Šä»£ç ï¼šåœ¨ä¸»çº¿ç¨‹ä¸­å¼€å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹`changeThread`ï¼Œæ–°çº¿ç¨‹åœ¨æ‰§è¡Œ`run`()æ–¹æ³•æ—¶ç«‹åˆ»è¿›å…¥ä¼‘çœ æ€ï¼Œä¸»çº¿ç¨‹åœ¨`while`å¾ªç¯ä¸­é¦–å…ˆè¯»å–åˆ°`flag`å€¼ä¸º`false`ï¼Œè€Œç”±äºæ’å…¥äº†`loadfence`å±éšœçš„åŸå› ï¼Œå­çº¿ç¨‹åœ¨ä¿®æ”¹flagåä¼šå°†ç»“æœåŒæ­¥ç»™ä¸»çº¿ç¨‹ï¼Œå˜ç›¸ä¿®æ”¹äº†ä¸»çº¿ç¨‹å·¥ä½œç©ºé—´ä¸­flagçš„å€¼ï¼Œè¿›è€Œè·³å‡ºäº†å¾ªç¯



### çº¿ç¨‹è°ƒåº¦

`Unsafe` ç±»ä¸­æä¾›äº†`park`ã€`unpark`ã€`monitorEnter`ã€`monitorExit`ã€`tryMonitorEnter`æ–¹æ³•è¿›è¡Œçº¿ç¨‹è°ƒåº¦ã€‚



```java
//å–æ¶ˆé˜»å¡çº¿ç¨‹
public native void unpark(Object thread);
//é˜»å¡çº¿ç¨‹
public native void park(boolean isAbsolute, long time);
//è·å¾—å¯¹è±¡é”ï¼ˆå¯é‡å…¥é”ï¼‰
@Deprecated
public native void monitorEnter(Object o);
//é‡Šæ”¾å¯¹è±¡é”
@Deprecated
public native void monitorExit(Object o);
//å°è¯•è·å–å¯¹è±¡é”
@Deprecated
public native boolean tryMonitorEnter(Object o);


//è·å¾—å¯¹è±¡é”
@Deprecated
public native void monitorEnter(Object var1);
//é‡Šæ”¾å¯¹è±¡é”
@Deprecated
public native void monitorExit(Object var1);
//å°è¯•è·å¾—å¯¹è±¡é”
@Deprecated
public native boolean tryMonitorEnter(Object var1);

```

å…¶ä¸­æ–¹æ³•`park`ã€`unpark` å¯å®ç°çº¿ç¨‹çš„æŒ‚èµ·ä¸æ¢å¤ï¼Œå°†ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒæŒ‚èµ·æ˜¯é€šè¿‡ `park` æ–¹æ³•å®ç°çš„ï¼Œè°ƒç”¨ `park` æ–¹æ³•åï¼Œçº¿ç¨‹å°†ä¸€ç›´é˜»å¡ç›´åˆ°è¶…æ—¶æˆ–è€…ä¸­æ–­ç­‰æ¡ä»¶å‡ºç°ï¼›`unpark` å¯ä»¥ç»ˆæ­¢ä¸€ä¸ªæŒ‚èµ·çš„çº¿ç¨‹ï¼Œä½¿å…¶æ¢å¤æ­£å¸¸

Java é”å’ŒåŒæ­¥å™¨æ¡†æ¶çš„æ ¸å¿ƒç±» `AbstractQueuedSynchronizer` (AQS)ï¼Œå°±æ˜¯é€šè¿‡è°ƒç”¨`LockSupport.park()`å’Œ`LockSupport.unpark()`å®ç°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’çš„ï¼Œè€Œ `LockSupport` çš„ `park`ã€`unpark` æ–¹æ³•å®é™…æ˜¯è°ƒç”¨ `Unsafe` çš„ `park`ã€`unpark` æ–¹å¼å®ç°çš„ï¼š

```java
private static final Unsafe U = Unsafe.getUnsafe();

public static void park(Object blocker) {
        Thread t = Thread.currentThread();
        setBlocker(t, blocker);
        U.park(false, 0L);
        setBlocker(t, null);
    }

public static void unpark(Thread thread) {
        if (thread != null)
            U.unpark(thread);
    }
```

`LockSupport` çš„`park`æ–¹æ³•è°ƒç”¨äº† `Unsafe` çš„`park`æ–¹æ³•æ¥é˜»å¡å½“å‰è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹ï¼Œæ­¤æ–¹æ³•å°†çº¿ç¨‹é˜»å¡åå°±ä¸ä¼šç»§ç»­å¾€åæ‰§è¡Œï¼Œç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨`unpark`æ–¹æ³•å”¤é†’å½“å‰çº¿ç¨‹ï¼Œä¸‹é¢ä¾‹å­å¯¹ `Unsafe` çš„è¿™ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼š

```java
public static void main(String[] args) {
    Thread mainThread = Thread.currentThread();
    new Thread(()->{
        try {
            TimeUnit.SECONDS.sleep(5);//æ–°çº¿ç¨‹åˆ›å»ºåå…ˆè¿›å…¥ä¼‘çœ æ€ï¼Œä¿è¯ä¸»çº¿ç¨‹å…ˆé˜»å¡è‡ªå·±
            System.out.println("subThread try to unpark mainThread");
            unsafe.unpark(mainThread); //å­çº¿ç¨‹unpark()è§£å†»ä¸»çº¿ç¨‹
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }).start();

    System.out.println("park main mainThread");
    unsafe.park(false,0L);//ä¸»çº¿ç¨‹mainThreadè°ƒç”¨park()æ¥é˜»å¡è‡ªå·±
    System.out.println("unpark mainThread success");
}
```

ç¨‹åºè¾“å‡ºä¸ºï¼š

```text
park main mainThread
subThread try to unpark mainThread
unpark mainThread success
```





### CASâ—â—â—



CAS å³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼ˆ`Compare And Swap`)ï¼Œæ˜¯å®ç°å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨åˆ°çš„ä¸€ç§æŠ€æœ¯ã€‚

CASæ“ä½œåŒ…æ‹¬ä¸‰ä¸ªå€¼ï¼šé¢„ä¼°å€¼ï¼ˆExpected Valueï¼‰ã€å†…å­˜å€¼ï¼ˆMemory Valueï¼‰å’Œæ›´æ–°å€¼ï¼ˆUpdate Valueï¼‰ã€‚

é¢„ä¼°å€¼æ˜¯æŒ‡çº¿ç¨‹åœ¨è¿›è¡ŒCASæ“ä½œä¹‹å‰ï¼Œå¯¹å…±äº«æ•°æ®çš„ä¸€ä¸ªæœŸæœ›å€¼ï¼Œå³çº¿ç¨‹è®¤ä¸ºå…±äº«æ•°æ®çš„å½“å‰å€¼åº”è¯¥æ˜¯å¤šå°‘ã€‚åœ¨CASæ“ä½œä¸­ï¼Œ**çº¿ç¨‹ä¼šå…ˆè¯»å–å…±äº«æ•°æ®çš„å½“å‰å€¼ä½œä¸ºé¢„ä¼°å€¼**ï¼›

åœ¨è¿›è¡ŒCASæ“ä½œæ—¶ï¼Œç³»ç»Ÿä¼šæ¯”è¾ƒé¢„ä¼°å€¼ï¼ˆExpected Valueï¼‰å’Œå†…å­˜å€¼ï¼ˆMemory Valueï¼‰æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™è¯´æ˜å…±äº«æ•°æ®çš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œæ­¤æ—¶çº¿ç¨‹å¯ä»¥æ‰§è¡Œæ›´æ–°æ“ä½œï¼Œå°†é¢„ä¼°å€¼æ›´æ–°ä¸ºæ–°çš„å€¼ï¼ˆUpdate Valueï¼‰ï¼›

å¦‚æœé¢„ä¼°å€¼å’Œå†…å­˜å€¼ä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†å…±äº«æ•°æ®çš„å€¼ï¼ŒCASæ“ä½œå¤±è´¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹éœ€è¦é‡æ–°è·å–æœ€æ–°çš„å…±äº«æ•°æ®å€¼ï¼Œå¹¶é‡æ–°è¿›è¡ŒCASæ“ä½œï¼Œç›´åˆ°CASæ“ä½œæˆåŠŸï¼›





ç”±äºCAS æ˜¯ä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ï¼ˆ`cmpxchg` æŒ‡ä»¤ï¼‰ï¼Œä¾é ç¡¬ä»¶å®ç°ï¼ŒJVMåªæ˜¯å°è£…äº†æ±‡ç¼–è°ƒç”¨ï¼Œå› æ­¤ä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚`Unsafe` æä¾›çš„ CAS æ–¹æ³•ï¼ˆå¦‚ `compareAndSwapXXX`ï¼‰ç¤ºä¾‹ï¼š

```java
/**
	*  CAS
  * @param o         åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡
  * @param offset    å¯¹è±¡ä¸­æŸfieldçš„åç§»é‡
  * @param expected  æœŸæœ›å€¼
  * @param update    æ›´æ–°å€¼
  * @return          true | false
  */
public final native boolean compareAndSwapObject(Object o, long offset,  Object expected, Object update);

public final native boolean compareAndSwapInt(Object o, long offset, int expected,int update);

public final native boolean compareAndSwapLong(Object o, long offset, long expected, long update);


//æ–°ç‰ˆJDK
public final native int compareAndExchangeInt(Object o, long offset,
                                                  int expected,
                                                  int x);

```

åˆ†æä»¥ä¸Šä»£ç ï¼šé€šè¿‡`Object o`+åç§»é‡`offset`å¯ä»¥ç¡®å®šè¯¥å¯¹è±¡åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå†å°†è¯¥å†…å­˜ä½ç½®çš„å€¼ä¸é¢„æœŸå€¼`expected`åšæ¯”è¾ƒï¼Œç„¶åè¿›è¡Œåç»­æ“ä½œï¼Œ`compareAndSwapInt`æ˜¯ä¸€ä¸ª`native`æ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨hotspotæºä»£ç çš„/src/share/vm/prims/unsafe.cppæ–‡ä»¶ä¸­ï¼š

```c++
UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x))
  UnsafeWrapper("Unsafe_CompareAndSwapInt"); // 1è¡Œ
  oop p = JNIHandles::resolve(obj); // 2è¡Œ
  jint* addr = (jint *) index_oop_from_field_offset_long(p, offset); // 3è¡Œ
  return (jint)(Atomic::cmpxchg(x, addr, e)) == e; // 4è¡Œ  å…³é”®ï¼ï¼ï¼
UNSAFE_END
```

å®ç°é€»è¾‘åœ¨ç¬¬2è‡³4è¡Œï¼Œå…¶ä¸­ç¬¬2ã€3è¡Œä¸»è¦æ˜¯æ ¹æ®å­—æ®µçš„åç§»é‡è®¡ç®—å‡ºå­—æ®µçš„åœ°å€

å…³é”®æ˜¯ç¬¬4è¡Œä»£ç ï¼Œä¸»è¦æ˜¯è°ƒç”¨äº†`Atomic::cmpxchg`æ–¹æ³•ï¼Œå®ç°å­—æ®µå€¼çš„æ¯”è¾ƒäº¤æ¢æ“ä½œï¼ˆCASï¼‰





å¯¹äº`cmpxchg`æŒ‡ä»¤ `linux_x86`åº•å±‚å®ç°ä¸ºï¼š

```c++
inline jint     Atomic::cmpxchg    (jint     exchange_value, volatile jint*     dest, jint     compare_value) {
  int mp = os::is_MP();// ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰å¤šä¸ªå¤„ç†å™¨ï¼Œå¦‚æœæ˜¯åˆ™mpä¸º1ï¼Œå¦åˆ™mpä¸º0
  __asm__ volatile (LOCK_IF_MP(%4) "cmpxchgl %1,(%3)"
                    : "=a" (exchange_value)
                    : "r" (exchange_value), "a" (compare_value), "r" (dest), "r" (mp)
                    : "cc", "memory");
  return exchange_value;
}


"=a" (exchange_value) // ç¬¬1ä¸ªè¾“å‡ºå‚æ•°ã€‚cmpxchglæŒ‡ä»¤æ‰§è¡Œç»“æŸåï¼Œå°†å¯„å­˜å™¨eaxçš„å€¼ä¿å­˜åˆ°exchange_valueï¼Œåœ¨æ–¹æ³•æ‰§è¡Œç»“æŸåè¿”å›
"r" (exchange_value) //  ç¬¬1ä¸ªè¾“å…¥å‚æ•°ã€‚ç¼–è¯‘å™¨ä¼šé€‰æ‹©ä»»æ„ä¸€ä¸ªå¯ç”¨çš„å¯„å­˜å™¨æ¥å­˜å‚¨exchange_valueï¼Œä¾‹å¦‚ä½¿ç”¨å¯„å­˜å™¨ecxã€‚
"a" (compare_value) // ç¬¬2ä¸ªè¾“å…¥å‚æ•°ã€‚ä½¿ç”¨å¯„å­˜å™¨eaxæ¥å­˜å‚¨å¾…æ¯”è¾ƒçš„å€¼compare_valueï¼Œæ‰§è¡ŒcmpxchglæŒ‡ä»¤æ—¶ä¼šç”¨åˆ°å¯„å­˜å™¨eaxã€‚
"r" (dest) // ç¬¬3ä¸ªè¾“å…¥å‚æ•°ã€‚ç¼–è¯‘å™¨ä¼šé€‰æ‹©ä»»æ„ä¸€ä¸ªå¯ç”¨çš„å¯„å­˜å™¨æ¥å­˜å‚¨ç›®æ ‡åœ°å€destï¼Œä¾‹å¦‚ä½¿ç”¨å¯„å­˜å™¨edxã€‚
"r" (mp) //  ç¬¬4ä¸ªè¾“å…¥å‚æ•°ã€‚ç¼–è¯‘å™¨ä¼šé€‰æ‹©ä»»æ„ä¸€ä¸ªå¯ç”¨çš„å¯„å­˜å™¨æ¥å­˜å‚¨å¤šå¤„ç†å™¨æ ‡å¿—
```

åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æœ€å…³é”®çš„æ˜¯ä¸€è¡Œä»£ç æ˜¯ï¼šLOCK_IF_MP(%4) "cmpxchgl %1,(%3)ï¼Œcmpxchglå…³é”®å­—å°±æ˜¯æ±‡ç¼–æŒ‡ä»¤åŸè¯­ï¼Œè¿™ä¸ªåŸè¯­åœ¨ä¸åŒçš„è®¡ç®—æœºçš„å®ç°ä¸ä¸€æ ·ï¼Œåœ¨linux_x86å°±å«åšcmpxchglã€‚

è€Œcmpxchgæ–¹æ³•å¯ä»¥ç†è§£ä¸ºlinux_x86å¹³å°å¯¹å¤–æä¾›casæ”¯æŒçš„APIã€‚

è¿™æ®µä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°LOCK_IF_MPå…³é”®å­—ï¼Œçœ‹åˆ°lockä¸€èˆ¬æˆ‘ä»¬ä¼šæƒ³åˆ°åŠ é”ï¼Œè¿™é‡Œç¡®å®æ˜¯åŠ é”çš„æ„æ€ï¼Œæˆ–è®¸ä½ ä¼šè¯´casæ“ä½œä¸ºä»€ä¹ˆè¿˜è¦åŠ é”ï¼Œå¦‚æœè¿™æ ·ï¼Œé‚£ç›´æ¥ç”¨åŠ é”çš„æ–¹å¼å®ç°åŸå­æ€§ä¸å°±å¯ä»¥äº†ï¼Œè¿™æ®µä»£ç çš„é€»è¾‘å…¶å®æ˜¯å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ ¸å¤„ç†å™¨ï¼Œå¦‚æœæ˜¯å¤šæ ¸å°±ä¼šåŠ é”ï¼Œå¦‚æœå•æ ¸å°±ä¸åŠ é”ã€‚è€Œè¿™ä¸ªåŠ é”çš„å®ç°æ ¹æ®ç³»ç»Ÿå¹³å°çš„ä¸åŒä¼šæœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼Œå¤§è‡´åˆ†ä¸ºé”æ€»çº¿å’Œé”ç¼“å­˜ã€‚

æˆ‘ä»¬è¯´äº†ï¼Œä¸€æ¡æœºå™¨æŒ‡ä»¤ï¼ˆæˆ–è€…è¯´æ±‡ç¼–æŒ‡ä»¤ï¼‰ä¸€å®šèƒ½åœ¨ä¸€ä¸ªcpuæ—¶é—´ç‰‡æ®µå†…å®Œæˆï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹å æ®ä¸¤ä¸ªæ—¶é—´ç‰‡ï¼Œè¿™ä¸ªä¸¤ä¸ªæ—¶é—´ç‰‡æ®µéƒ½æ˜¯è¦æ‰§è¡ŒåŒä¸€ä¸ªæŒ‡ä»¤ï¼Œå½“ä¸€ä¸ªæ—¶é—´ç‰‡æ®µæ‰§è¡Œå®Œï¼Œæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡æ®µï¼Œè¿™æ ·çœ‹èµ·æ¥å•ä¸ªæŒ‡ä»¤çš„æ‰§è¡Œæ˜¯ä¸²è¡Œçš„ï¼Œä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯ç°åœ¨çš„å¤„ç†å™¨ä¸€èˆ¬éƒ½ä¼šå­˜åœ¨å¤šæ ¸ï¼Œç”šè‡³å¤šcpuï¼Œæ¯ä¸ªæ ¸éƒ½ä¼šæœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œæ‰€ä»¥ï¼Œå¤šæ ¸æƒ…å†µä¸‹ä»…ä»…é casæ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„ï¼Œæ“ä½œç³»ç»Ÿå†…éƒ¨é€šè¿‡é”æ¥è§„é¿ã€‚



å› æ­¤æ“ä½œç³»ç»Ÿåº•å±‚å®é™…ä¸Šè¿˜æ˜¯ä¼šé€šè¿‡lockåŠ é”çš„æ–¹å¼æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§(**å¤šæ ¸CPUä¸‹å­˜åœ¨cpu cacheç¼“å­˜ä¸€è‡´æ€§é—®é¢˜**)







#### AtomicåŸå­ç±»

J.U.C åŒ…é‡Œé¢çš„æ•´æ•°åŸå­ç±» `AtomicInteger`ï¼Œå…¶ä¸­çš„ `compareAndSet`() å’Œ `getAndIncrement`() ç­‰æ–¹æ³•éƒ½ä½¿ç”¨äº† Unsafe ç±»çš„ CAS æ“ä½œ,ä¾‹å¦‚**AtomicInteger ç±»å¸¸ç”¨æ–¹æ³•**å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public final int get() //è·å–å½“å‰çš„å€¼
public final int getAndSet(int newValue)//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼
public final int getAndIncrement()//è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢
public final int getAndDecrement() //è·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡
public final int getAndAdd(int delta) //è·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼
boolean compareAndSet(int expect, int update) //å¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰
public final void lazySet(int newValue)//æœ€ç»ˆè®¾ç½®ä¸ºnewValue,ä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚
```



ä»¥ä¸‹ä»£ç ä½¿ç”¨äº† `AtomicInteger` æ‰§è¡Œäº†è‡ªå¢çš„æ“ä½œï¼š

```java
private AtomicInteger cnt = new AtomicInteger();

public void add() {
    cnt.incrementAndGet();
}
```

ä»¥ä¸‹ä»£ç æ˜¯ `incrementAndGet`() çš„æºç ï¼Œå®ƒè°ƒç”¨äº† `unsafe` çš„ `getAndAddInt`() ã€‚

```java
public final int incrementAndGet() {
    return unsafe.getAndAddInt(this, valueOffset, 1) + 1;
}

//æ–°ç‰ˆæœ¬jdk
public final int getAndIncrement() {
        return U.getAndAddInt(this, VALUE, 1);
    }
```

ä»¥ä¸‹ä»£ç æ˜¯ `getAndAddInt`() æºç ,å¯¹äºè€ç‰ˆæœ¬çš„jdk:

var1 æŒ‡ç¤ºå¯¹è±¡å†…å­˜åœ°å€ï¼Œvar2 æŒ‡ç¤ºè¯¥å­—æ®µç›¸å¯¹å¯¹è±¡å†…å­˜åœ°å€çš„åç§»ï¼Œvar4 æŒ‡ç¤ºæ“ä½œéœ€è¦åŠ çš„æ•°å€¼ï¼Œè¿™é‡Œä¸º 1ã€‚é€šè¿‡ `getIntVolatile`(var1, var2) å¾—åˆ°æ—§çš„é¢„æœŸå€¼(å¯ä»¥ç†è§£ä¸ºvar1ä¸ºè¢«æ“ä½œ`object`åœ¨å†…å­˜ä¸­çš„é¦–åœ°å€ï¼Œvar2ä¸ºåç§»é‡`offset`)ï¼Œé€šè¿‡è°ƒç”¨ `compareAndSwapInt`() æ¥è¿›è¡Œ CAS æ¯”è¾ƒï¼Œå¦‚æœè¯¥å­—æ®µå†…å­˜åœ°å€ä¸­çš„å€¼ç­‰äº var5ï¼Œé‚£ä¹ˆå°±æ›´æ–°å†…å­˜åœ°å€ä¸º var1+var2 çš„å˜é‡ä¸º var5+var4ï¼Œå¯ä»¥çœ‹åˆ° `getAndAddInt`() åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼Œå‘ç”Ÿå†²çªçš„åšæ³•æ˜¯ä¸æ–­çš„è¿›è¡Œé‡è¯•ï¼š

```java
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));

    return var5;
}

//æ–°ç‰ˆæœ¬jdk  çœ‹è¿™ä¸ªå°±è¡Œ
public final int getAndAddInt(Object o, long offset, int delta) {
        int v;
        do {
            v = getIntVolatile(o, offset); 
        } while (!weakCompareAndSetInt(o, offset, v, v + delta));
        return v;
    }
```

è€Œå¯¹äºæ–°ç‰ˆæœ¬jdkæ¥è¯´ï¼Œ`getAndAddInt()`é¦–å…ˆé€šè¿‡ `getIntVolatile()`æ–¹æ³•è·å–å¯¹è±¡ä¸­offsetåç§»åœ°å€å¯¹åº”çš„æ•´å‹fieldçš„å€¼(*é™„åŠ äº†volatileåŠ è½½è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯å¼ºåˆ¶ä»ä¸»å­˜ä¸­è·å–å±æ€§å€¼*),ç„¶åé€šè¿‡`weakCompareAndSetInt()`æ¥æ¯”è¾ƒæ—§å€¼vå’Œå½“å‰å€¼`value=func(o,offset)` (**å› ä¸ºç¬¬ä¸€æ¬¡è¯»å–åˆ°çš„vååˆ°ä¿®æ”¹è¯¥å€¼å‰å­˜åœ¨æ—¶é—´å·®ï¼Œå¯èƒ½å…¶ä»–çº¿ç¨‹åœ¨è¿™ä¸ªæ—¶é—´é—´éš”å†…æäº¤äº†å¯¹è¯¥å€¼çš„æ›´æ–°ï¼Œæ­¤æ—¶å¦‚æœç›´æ¥ä¿®æ”¹å°†ä¼šäº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜**)ï¼Œå¦‚æœvalueå’Œvç›¸ç­‰ï¼Œåˆ™è¯´æ˜å¯ä»¥æ›´æ–°ï¼Œä¸ç›¸ç­‰åˆ™è‡ªæ—‹å†æ¬¡å°è¯•ä¿®æ”¹ã€‚

å†ä¸¾ä¸€ä¸ªä¾‹å­åŠ æ·±ç†è§£ï¼Œ**å‡è®¾ç°åœ¨çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶æ‰§è¡ŒgetAndAddæ“ä½œ(CPUé‡‡ç”¨æ—¶é—´ç‰‡è½®è½¬æ–¹å¼)ï¼š**

1. `AtomicInteger`é‡Œé¢çš„`value`åŸå§‹å€¼ä¸º3ï¼Œå³ä¸»å†…å­˜ä¸­`AtomicInteger`çš„`value`ä¸º3ï¼Œ**æ ¹æ®Javaå†…å­˜æ¨¡å‹ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bå„è‡ªæŒæœ‰ä¸€ä»½valueçš„å‰¯æœ¬ï¼Œå€¼ä¸º3**
2. çº¿ç¨‹Aé€šè¿‡`getIntVolatile(var1, var2)`æ–¹æ³•è·å–åˆ°valueå€¼3ï¼Œçº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹AæŒ‚èµ·
3. çº¿ç¨‹Bé€šè¿‡`getIntVolatile(var1, var2)`æ–¹æ³•è·å–åˆ°valueå€¼3ï¼Œå¹¶åˆ©ç”¨`compareAndSwapInt`æ–¹æ³•æ¯”è¾ƒå½“å‰ç›¸åº”å†…å­˜åœ°å€çš„å€¼ ä¹Ÿä¸º3ï¼Œæ¯”è¾ƒæˆåŠŸï¼Œæ•…ä¿®æ”¹å†…å­˜å€¼ä¸º2ï¼Œ**åŒæ—¶ç”±äºvalueè¢«volatileä¿®é¥°ï¼Œè¢«æŸä¸€çº¿ç¨‹ä¿®æ”¹åä¼šç«‹å³å°†æ–°å€¼åŒæ­¥åˆ°ä¸»å­˜**ï¼Œæ­¤æ—¶çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹BæŒ‚èµ·
4. **çº¿ç¨‹Aæ¢å¤ï¼Œåˆ©ç”¨`compareAndSwapInt`æ–¹æ³•æ¯”è¾ƒï¼Œå‘ç°æ‰‹é‡Œçš„å€¼3å’Œå½“å‰ä¸»å†…å­˜ä¸­çš„å€¼2ä¸ä¸€è‡´ï¼Œ**å› ä¸ºæ­¤æ—¶valueæ­£åœ¨è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ï¼Œçº¿ç¨‹Aä¸èƒ½ä¿®æ”¹valueå€¼
5. çº¿ç¨‹Açš„`compareAndSwapInt`æ— æ³•å®ç°ï¼Œå¾ªç¯åˆ¤æ–­ï¼Œ**é‡æ–°è·å–valueå€¼ï¼Œå› ä¸ºvalueæ˜¯volatileå˜é‡ï¼Œæ‰€ä»¥çº¿ç¨‹å¯¹å®ƒçš„ä¿®æ”¹ï¼Œçº¿ç¨‹Aæ€»æ˜¯èƒ½å¤Ÿçœ‹åˆ°ï¼Œçº¿ç¨‹Aç»§ç»­åˆ©ç”¨`compareAndSwapInt`è¿›è¡Œæ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œ**ç›´åˆ°`compareAndSwapInt`ä¿®æ”¹æˆåŠŸåè¿”å›`true`





åŒç† `compareAndSwapObject`ï¼Œ`compareAndSwapLong`ç­‰å…¶ä»–æ–¹æ³•ä¹Ÿéƒ½å¤§åŒå°å¼‚





#### AtomicStampedReference



åŠ å…¥ä¿®æ”¹æ—¶é—´æˆ³æ¥è§£å†³ABAé—®é¢˜  :astonished:



CAS åªå¯¹å•ä¸ªå…±äº«å˜é‡æœ‰æ•ˆï¼Œå½“æ“ä½œæ¶‰åŠè·¨å¤šä¸ªå…±äº«å˜é‡æ—¶ CAS æ— æ•ˆï¼Œä» JDK 1.5 å¼€å§‹ï¼Œæä¾›äº†`AtomicReference`ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œå¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ª`pair`å¯¹è±¡é‡Œæ¥è¿›è¡Œ CAS æ“ä½œ

CASå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼šå¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ï¼Œå³**`ABA`é—®é¢˜**ï¼ŒJUCæä¾›å¸¦æœ‰æ ‡è®°çš„åŸå­å¼•ç”¨ç±» `AtomicStampedReference` æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬ï¼ŒåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶å¯èƒ½å‡ºç°çš„ `ABA` é—®é¢˜:

`AtomicStampedReference`ä¸»è¦ç»´æŠ¤åŒ…å«ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ä»¥åŠä¸€ä¸ªå¯ä»¥è‡ªåŠ¨æ›´æ–°çš„æ•´æ•°"stamp"çš„pairå¯¹è±¡

```java
public class AtomicStampedReference<V> {
    private static class Pair<T> {
        final T reference;  //ç»´æŠ¤å¯¹è±¡å¼•ç”¨
        final int stamp;  //ç”¨äºæ ‡å¿—ç‰ˆæœ¬
        private Pair(T reference, int stamp) {
            this.reference = reference;
            this.stamp = stamp;
        }
        static <T> Pair<T> of(T reference, int stamp) {
            return new Pair<T>(reference, stamp);
        }
    }
    private volatile Pair<V> pair;
    ....
    
    /**
      * expectedReference ï¼šæ›´æ–°ä¹‹å‰çš„åŸå§‹å€¼
      * newReference : å°†è¦æ›´æ–°çš„æ–°å€¼
      * expectedStamp : æœŸå¾…æ›´æ–°çš„æ ‡å¿—ç‰ˆæœ¬
      * newStamp : å°†è¦æ›´æ–°çš„æ ‡å¿—ç‰ˆæœ¬
      */
    public boolean compareAndSet(V   expectedReference,
                             V   newReference,
                             int expectedStamp,
                             int newStamp) 
    {
        // è·å–å½“å‰çš„(å…ƒç´ å€¼ï¼Œç‰ˆæœ¬å·)å¯¹
        Pair<V> current = pair;
        return
            // å¼•ç”¨æ²¡å˜
            expectedReference == current.reference &&
            // ç‰ˆæœ¬å·æ²¡å˜
            expectedStamp == current.stamp &&
            // æ–°å¼•ç”¨ç­‰äºæ—§å¼•ç”¨
            ((newReference == current.reference &&
            // æ–°ç‰ˆæœ¬å·ç­‰äºæ—§ç‰ˆæœ¬å·
            newStamp == current.stamp) ||
            // æ„é€ æ–°çš„Pairå¯¹è±¡å¹¶CASæ›´æ–°
            casPair(current, Pair.of(newReference, newStamp)));
    }

    private boolean casPair(Pair<V> cmp, Pair<V> val) {
        // è°ƒç”¨Unsafeçš„compareAndSwapObject()æ–¹æ³•CASæ›´æ–°pairçš„å¼•ç”¨ä¸ºæ–°å¼•ç”¨
        return UNSAFE.compareAndSwapObject(this, pairOffset, cmp, val);
    }
```

 :100: åˆ†æä»¥ä¸Šä»£ç ï¼šå…ˆå°†æ‰€è¦ä¿®æ”¹çš„`object`å€¼ä¸ä¸€ä¸ª`pair`å¯¹è±¡ç›¸å…³è”èµ·æ¥ï¼Œè¿™ä¸ª`pair`åŒ…å«äº†ä¸€ä¸ªæˆå‘˜å±æ€§`stamp`æˆ³ç”¨æ¥æ ‡è®°ç‰ˆæœ¬å·ï¼Œç„¶ååœ¨ä¿®æ”¹æ­¤`object`æ—¶(å®é™…ä¸Šæ˜¯ä¿®æ”¹pairå¼•ç”¨)é€šè¿‡CASåŸç†åŒæ—¶æ¯”è¾ƒå¼•ç”¨ä¸`Stamp`æ—¶é—´æˆ³çš„å€¼ï¼Œå¦‚æœéƒ½æœªå‘ç”Ÿå˜åŒ–ï¼Œåˆ™æäº¤ä¿®æ”¹

å¯¹äºABAé—®é¢˜ï¼Œå‡è®¾çº¿ç¨‹Aã€Bã€Cæ“ä½œä¸€ä¸ª`Object`ï¼Œçº¿ç¨‹Aç‡å…ˆè¿›å…¥`compareAndSet()`æ–¹æ³•ï¼Œæ­¤æ—¶è®©å‡ºæ—¶é—´ç‰‡ï¼Œçº¿ç¨‹Bã€Cæ‰§è¡Œäº†ä¿®æ”¹objectæ“ä½œå¹¶æäº¤ï¼Œä¿è¯Objectåœ¨ç»ä¸¤æ¬¡ä¿®æ”¹åå€¼æœªå˜ ã€‚è¿™æ˜¯çº¿ç¨‹Aå†æ¬¡æ‹¿åˆ°CPUä½¿ç”¨æƒï¼Œåœ¨CASæ¯”è¾ƒ `pair.Reference`æ—¶æ²¡æœ‰é—®é¢˜ï¼Œè€ŒCASæ¯”è¾ƒç‰ˆæœ¬æˆ³`Stamp`æ—¶ï¼Œä¼šå‘ç°`expectedStamp != current.stamp`,å› ä¸ºçº¿ç¨‹Bã€Cæäº¤äº†å¯¹objectçš„ä¿®æ”¹åä¼šç«‹åˆ»åˆ·æ–°è‡³ä¸»å­˜ï¼Œæ­¤æ—¶çº¿ç¨‹Aå°±ä¼šè‡ªæ—‹å†æ¬¡å°è¯•æ›´æ–° 



åŒæ—¶ `AtomicReference`å¼•ç”¨ç±»å‹åŸå­ç±»ã€`AtomicMarkableReference`åŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°çš„å¼•ç”¨ç±»å‹ä¹Ÿæ˜¯ç±»ä¼¼çš„

>  **AtomicStampedReference å¦‚ä½•è§£å†³ABAé—®é¢˜** ? 

æ€è·¯å¾ˆç®€å•ï¼Œæ¯æ¬¡`compareAndSwap`åç»™æ•°æ®çš„ç‰ˆæœ¬å·åŠ 1ï¼Œä¸‹æ¬¡`compareAndSwap`çš„æ—¶å€™ä¸ä»…æ¯”è¾ƒæ•°æ®ï¼Œä¹Ÿæ¯”è¾ƒç‰ˆæœ¬å·ï¼Œå€¼ç›¸åŒï¼Œç‰ˆæœ¬å·ä¸åŒä¹Ÿä¸èƒ½æ‰§è¡ŒæˆåŠŸã€‚`Java`ä¸­æä¾›äº†`AtomicStampedReference`æ¥è§£å†³è¯¥é—®é¢˜ï¼š

```java
public static void main(String[] args) {
    final AtomicStampedReference<Integer> count = new AtomicStampedReference<>(5, 1);

    for (int i = 0; i < 2; i++) {
        Thread thread = new Thread(() -> {
            try {
                Thread.sleep(10);
            } catch (Exception ignore) {
            }

            boolean re = count.compareAndSet(5, 10, 1, 2);
            System.out.println(Thread.currentThread().getName() + "[recharge] compareAndSet " + re);
        });
        thread.start();
    }

    Thread thread = new Thread(() -> {
        try {
            Thread.sleep(10);
        } catch (Exception ignore) {
        }
        boolean re = count.compareAndSet(10, 5, count.getStamp(), count.getStamp() + 1);
        System.out.println(Thread.currentThread().getName() + "[consume] compareAndSet " + re);
    });
    thread.start();
}
```



è§£å†³ABAé—®é¢˜çš„æ ¸å¿ƒæ˜¯`AtomicStampedReference`çš„`compareAndSet`å‡½æ•°ï¼Œè¿™é‡Œé¢æœ‰å››ä¸ªå‚æ•°ï¼š

`compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)`ï¼š

ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå‚æ•°expectedReferenceï¼šè¡¨ç¤ºé¢„æœŸå€¼ã€‚

ï¼ˆ2ï¼‰ç¬¬äºŒä¸ªå‚æ•°newReferenceï¼šè¡¨ç¤ºè¦æ›´æ–°çš„å€¼ã€‚

ï¼ˆ3ï¼‰ç¬¬ä¸‰ä¸ªå‚æ•°expectedStampï¼šè¡¨ç¤ºé¢„æœŸçš„æ—¶é—´æˆ³ã€‚

ï¼ˆ4ï¼‰ç¬¬å››ä¸ªå‚æ•°newStampï¼šè¡¨ç¤ºè¦æ›´æ–°çš„æ—¶é—´æˆ³ã€‚

å…¶å®å°±æ˜¯åŠ äº†æ—¶é—´æˆ³ç‰ˆæœ¬å·æ¥åŒºåˆ†ä¸åŒæ—¶æœŸçš„ä¿®æ”¹æ“ä½œ









## AQS é‡è¦âœ¨âœ¨

AQSå…¶å®æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒå®ç°äº†çº¿ç¨‹æŒ‚èµ·çš„é€»è¾‘ï¼Œå®ç°äº†çº¿ç¨‹å­˜å‚¨æœºåˆ¶ï¼Œå®ç°äº†é”çš„çŠ¶æ€é€»è¾‘ï¼Œå®ç°äº†çº¿ç¨‹å”¤é†’çš„é€»è¾‘ï¼Œå´åªå®šä¹‰äº†çº¿ç¨‹æŠ¢é”å’Œé‡Šæ”¾é”çš„æŠ½è±¡ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯å°†æŠ¢é”å’Œé‡Šæ”¾é”çš„é€»è¾‘äº¤ç»™å­ç±»æ¥å®ç°ï¼Œè¿™æ ·æœ‰åŠ©äºå®ç°å„ç§ä¸åŒç‰¹æ€§çš„é”ï¼Œæ¯”å¦‚å…±äº«é”ï¼Œç‹¬å é”ï¼Œå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥ç­‰ã€‚å¹¶ä¸”ä»¥æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°†ä¸Šè¿°ä¸Šé”æµç¨‹å’Œé‡Šæ”¾é”æµç¨‹å°è£…ä¸ºå›ºå®šæ¨¡æ¿æ–¹æ³•ã€‚æ‰€ä»¥AQSå°±æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„**åŒæ­¥å™¨æ¡†æ¶**

AQSå®ç°åŒæ­¥æœºåˆ¶æœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯ç‹¬å æ¨¡å¼ï¼Œä¸€ç§æ˜¯å…±äº«æ¨¡å¼ã€‚ä¸¤ç§æ¨¡å¼åˆ†åˆ«æä¾›æä¾›ä¸¤ä¸ªæ¨¡æ¿æ–¹æ³•å®ç°ã€‚å››ä¸ªæ¨¡æ¿æ–¹æ³•ä¸º`acquire`ï¼Œ`release`ï¼Œ`acquireShared`ï¼Œ`releaseShared`

ç‹¬å æ¨¡å¼çš„é”æ˜¯åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”

å…±äº«æ¨¡å¼çš„é”æ˜¯å…è®¸å¤šä½™ä¸€ä¸ªçš„çº¿ç¨‹æŒæœ‰é”



AQSæ¡†æ¶å€ŸåŠ©äºä¸¤ä¸ªç±»ï¼š`Unsafe`(æä¾›`CAS`æ“ä½œ)å’Œ`LockSupport`(æä¾›`park`/`unpark`æ“ä½œ)

`AQS` æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶ä¸”å°†å…±äº«èµ„æºè®¾ç½®ä¸ºé”å®šçŠ¶æ€;å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¥—çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ `AQS` æ˜¯ç”¨`CLH`é˜Ÿåˆ—é”å®ç°çš„ï¼Œå³å°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­



### LockSupport

ç”±äºAQSä¸­é˜Ÿåˆ—å…ƒç´ æ“ä½œæ¶‰åŠåˆ°`park`()ã€`unpark`()æ–¹æ³•ï¼Œæ•…éœ€è¦å…ˆæ¥å­¦ä¹ ä¸‹`LockSupport`ç±»

`LockSupport`çš„æ ¸å¿ƒå‡½æ•°éƒ½æ˜¯åŸºäº`Unsafe`ç±»ä¸­å®šä¹‰çš„`park`å’Œ`unpark`å‡½æ•°ï¼Œä¸‹é¢ç»™å‡º`Unsafe`ç±»ä¸­ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰:

```java
public native void park(boolean isAbsolute, long time);
public native void unpark(Thread thread);
```



#### wait/notify

`wait`() ä¸ `notify/notifyAll()` æ˜¯`Object`ç±»çš„æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œä¸¤ä¸ªæ–¹æ³•æ—¶ï¼Œè¦å…ˆè·å¾—é”ï¼Œ ç»å¸¸ä¸`synchronized`æ­é…ä½¿ç”¨ï¼Œå³åœ¨`synchronized`ä¿®é¥°çš„åŒæ­¥ä»£ç å—æˆ–æ–¹æ³•é‡Œé¢è°ƒç”¨`wait()` ä¸ `notify/notifyAll()`æ–¹æ³•:

- å½“çº¿ç¨‹æ‰§è¡Œwait()æ—¶ï¼Œä¼šæŠŠå½“å‰çš„é”é‡Šæ”¾ï¼Œç„¶åè®©å‡ºCPUï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€
- å½“æ‰§è¡Œnotify/notifyAllæ–¹æ³•æ—¶ï¼Œä¼šå”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…è¯¥å¯¹è±¡é”çš„çº¿ç¨‹ï¼Œ**ç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œç›´åˆ°æ‰§è¡Œå®Œé€€å‡ºå¯¹è±¡é”é”ä½çš„åŒºåŸŸï¼ˆ`synchronized`ä¿®é¥°çš„ä»£ç å—ï¼‰åå†é‡Šæ”¾é”**
- æ— è®ºæ˜¯æ‰§è¡Œå¯¹è±¡çš„ waitã€notify è¿˜æ˜¯ notifyAll æ–¹æ³•ï¼Œ**å¿…é¡»ä¿è¯å½“å‰è¿è¡Œçš„çº¿ç¨‹å–å¾—äº†è¯¥å¯¹è±¡çš„ç›‘è§†å™¨æ§åˆ¶æƒï¼ˆmonitorï¼‰**,å³å‰ææ˜¯å½“å‰çº¿ç¨‹å·²ç»è·å–åˆ°å¯¹è±¡çš„é”ï¼Œ**ä¹Ÿå°±æ˜¯`wait/notify`æ–¹æ³•å¿…é¡»åœ¨`synchronized`ä¿®é¥°çš„ä»£ç å—æˆ–è€…æ–¹æ³•ä¸­ä½¿ç”¨**



**ä½¿ç”¨wait/notifyå®ç°çº¿ç¨‹åŒæ­¥:**

ä¾‹1ï¼š

```java
    public static void main(String[] args) throws InterruptedException {
        Object lock1 = new Object();
        Thread t1 = new Thread(new Test().new Tt1(lock1));
        Thread t2 = new Thread(new Test().new Tt2(lock1));
        t1.start();
        Thread.sleep(1000);
        t2.start();
    }
    class Tt1 implements Runnable{

        private Object lock1;
        public Tt1(Object lock1) {
            this.lock1 = lock1;
        }
        @Override
        public void run() {
            try {
                System.out.println(this.getClass()+"-------1");
                synchronized (lock1) {
                    Thread.sleep(2000);
                    System.out.println("waiting start");
                    lock1.wait();
                }
                System.out.println("waiting end");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
    
    class Tt2 implements Runnable{

        private Object lock1;
        public Tt2(Object lock1) {
            this.lock1 = lock1;
        }
        @Override
        public void run() {
            System.out.println(this.getClass()+"-------1");
            synchronized (lock1) {
                try {
                    System.out.println(this.getClass()+"-------2");
                    lock1.notify(); //å¯¹è±¡é”è°ƒç”¨notify()
                    Thread.sleep(1000);
                    System.out.println(this.getClass()+"-------3");
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
            
        }
    }
```

ç®€å•åˆ†æä¸€ä¸‹

(1) t1å’Œt2å…ˆåå¯åŠ¨(t1å¯åŠ¨åä¸»çº¿ç¨‹ç¡çœ )ï¼Œt1å…ˆè·å–åˆ°lock1é”,ç„¶åt1è°ƒç”¨`sleep`()æ–¹æ³•ï¼Œä½†æ˜¯sleepå¹¶ä¸ä¼šé‡Šæ”¾é”ï¼Œæ‰€ä»¥t2å¯åŠ¨åæš‚æ—¶æ— æ³•è·å–åˆ°lock1é”å¯¼è‡´ä¸€ç›´è¢«é˜»å¡ä½ï¼›
(2) t1ä¸­æ‰§è¡Œäº†`wait()`å¯¼è‡´é”lock1è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥t2è·å–åˆ°é”æ‰§è¡Œä¸‹å»ï¼›
(3) t2ä¸­è°ƒç”¨äº†`notify()`ä½†æ˜¯å¹¶ä¸ä¼šé©¬ä¸Šé‡Šæ”¾é”(å¾…åŒæ­¥ä»£ç æ‰§è¡Œå®Œåæ‰é‡Šæ”¾)ï¼Œt1æ²¡æœ‰é©¬ä¸Šæ‰§è¡Œç­‰t2æ‰§è¡Œå®Œæˆé‡Šæ”¾é”åï¼Œt1ç»§ç»­æ‰§è¡Œ `System.out.println("waiting end");`



ä¾‹2:

```java
class MyThread extends Thread {
    
    public void run() {
        synchronized (this) {
            System.out.println("before notify");   //sout2         
            notify();
            System.out.println("after notify");    //sout3
        }
    }
}

public class WaitAndNotifyDemo {
    public static void main(String[] args) throws InterruptedException {
        MyThread myThread = new MyThread();            
        synchronized (myThread) {
            try { //è¿›å…¥è¯¥åŒæ­¥ä»£ç å—æ—¶ä¸»çº¿ç¨‹æ‹¿åˆ°äº†myThreadå¯¹è±¡é”
                myThread.start();//	å¼€å¯å­çº¿ç¨‹
                Thread.sleep(3000);// ä¸»çº¿ç¨‹ç¡çœ 3s,å¹¶ä¸é‡Šæ”¾é”
                System.out.println("before wait"); //sout1
                myThread.wait();// é˜»å¡ä¸»çº¿ç¨‹
                System.out.println("after wait");  //sout4
            } catch (InterruptedException e) {
                e.printStackTrace();
            }            
        }        
    }
}
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```
before wait
before notify
after notify
after wait
```



#### park/unpark

parkæ–¹æ³•æ˜¯çº¿ç¨‹é˜»å¡çš„æ–¹æ³•ï¼Œå¯ä»¥ä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹å”¤é†’ã€‚parkæ–¹æ³•æœ‰å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯park()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨unparkæ–¹æ³•å”¤é†’ã€‚parkæ–¹æ³•è¿˜å¯ä»¥ä¼ å…¥ä¸€ä¸ªObjectç±»å‹çš„å‚æ•°ï¼Œç”¨äºæ ‡è¯†å½“å‰çº¿ç¨‹ç­‰å¾…çš„æ¡ä»¶ï¼Œå½“è¯¥æ¡ä»¶æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹ä¼šè¢«å”¤é†’ã€‚

unparkæ–¹æ³•æ˜¯çº¿ç¨‹å”¤é†’çš„æ–¹æ³•ï¼Œå¯ä»¥å”¤é†’æŒ‡å®šçš„çº¿ç¨‹ã€‚unparkæ–¹æ³•ä¹Ÿæœ‰å¤šä¸ªé‡è½½æ–¹æ³•ï¼Œå…¶ä¸­æœ€å¸¸ç”¨çš„æ˜¯unpark(Thread thread)æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å”¤é†’æŒ‡å®šçš„çº¿ç¨‹ã€‚**å¦‚æœè¯¥çº¿ç¨‹ä¹‹å‰è°ƒç”¨äº†parkæ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä¼šè¢«å”¤é†’ï¼›å¦‚æœè¯¥çº¿ç¨‹è¿˜æ²¡æœ‰è°ƒç”¨parkæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒåœ¨è°ƒç”¨parkæ–¹æ³•ä¹‹åä¼šç«‹å³è¿”å›**

unparkå‡½æ•°ä¸ºçº¿ç¨‹æä¾›â€œè®¸å¯(permit)â€ï¼Œçº¿ç¨‹è°ƒç”¨parkå‡½æ•°åˆ™ç­‰å¾…â€œè®¸å¯â€ã€‚è¿™ä¸ªæœ‰ç‚¹åƒä¿¡å·é‡ï¼Œä½†æ˜¯è¿™ä¸ªâ€œè®¸å¯â€æ˜¯ä¸èƒ½å åŠ çš„ï¼Œâ€œè®¸å¯â€æ˜¯ä¸€æ¬¡æ€§çš„,æ¯”å¦‚çº¿ç¨‹Bè¿ç»­è°ƒç”¨äº†ä¸‰æ¬¡unparkå‡½æ•°ï¼Œæ­¤æ—¶çº¿ç¨‹Aè°ƒç”¨parkå‡½æ•°å°±ä½¿ç”¨æ‰è¿™ä¸ªâ€œè®¸å¯â€ï¼Œå¦‚æœçº¿ç¨‹Aå†æ¬¡è°ƒç”¨parkï¼Œåˆ™è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè¿™æ˜¯`park/unpark`ä¸åŒäº`wait/notify`ä¹‹å¤„

**æ³¨æ„ï¼Œunparkå‡½æ•°å¯ä»¥å…ˆäºparkè°ƒç”¨ã€‚æ¯”å¦‚çº¿ç¨‹Bè°ƒç”¨unparkå‡½æ•°ï¼Œç»™çº¿ç¨‹Aå‘äº†ä¸€ä¸ªâ€œè®¸å¯â€ï¼Œé‚£ä¹ˆå½“çº¿ç¨‹Aè°ƒç”¨parkæ—¶ï¼Œå®ƒå‘ç°å·²ç»æœ‰â€œè®¸å¯â€äº†ï¼Œé‚£ä¹ˆå®ƒä¼šé©¬ä¸Šå†ç»§ç»­è¿è¡Œ**



**`park/unpark`å®ç°çº¿ç¨‹åŒæ­¥**



ä¾‹å­1ï¼š

```java
import java.util.concurrent.locks.LockSupport;

public class ParkDemo {

    public static void main(String[] args) {
        Thread thread1 = new Thread(() -> {
            System.out.println("Thread 1 is waiting...");
            LockSupport.park(); // çº¿ç¨‹1ç­‰å¾…
            System.out.println("Thread 1 is awakened.");
        });

        Thread thread2 = new Thread(() -> {
            System.out.println("Thread 2 is waiting...");
            LockSupport.park(); // çº¿ç¨‹2ç­‰å¾…
            System.out.println("Thread 2 is awakened.");
        });

        thread1.start();
        thread2.start();

        try {
            System.out.println("wait 2 s.");
            Thread.sleep(2000); // ç­‰å¾…2ç§’é’Ÿ
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

        LockSupport.unpark(thread1); // å”¤é†’çº¿ç¨‹1
        LockSupport.unpark(thread2); // å”¤é†’çº¿ç¨‹2
    }
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªçº¿ç¨‹thread1å’Œthread2ï¼Œå®ƒä»¬éƒ½è°ƒç”¨äº†LockSupport.park()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚ç„¶åæˆ‘ä»¬ç­‰å¾…äº†2ç§’é’Ÿï¼Œä¹‹ååœ¨ä¸»çº¿ç¨‹è°ƒç”¨`LockSupport.unpark()`æ–¹æ³•æ¥åˆ†åˆ«å”¤é†’çº¿ç¨‹1å’Œçº¿ç¨‹2,å½“çº¿ç¨‹è¢«å”¤é†’æ—¶ï¼Œå®ƒä»¬ä¼šç»§ç»­æ‰§è¡Œå„è‡ªåé¢çš„ä»£ç ï¼Œç»“æœå¦‚ä¸‹ï¼š

```
Thread 1 is waiting...
Thread 2 is waiting...
wait 2 s.
Thread 1 is awakened.
Thread 2 is awakened.
```



ä¾‹å­2ï¼š

```java
import java.util.concurrent.locks.LockSupport;

class MyThread extends Thread {
    private Object object;

    public MyThread(Object object) {
        this.object = object;
    }

    public void run() {
        System.out.println("before unpark");
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        // è·å–blocker
        System.out.println("Blocker info " + LockSupport.getBlocker((Thread) object));
        // é‡Šæ”¾è®¸å¯
        LockSupport.unpark((Thread) object);
        // ä¼‘çœ 500msï¼Œä¿è¯å…ˆæ‰§è¡Œparkä¸­çš„setBlocker(t, null);
        try {
            Thread.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        // å†æ¬¡è·å–blocker
        System.out.println("Blocker info " + LockSupport.getBlocker((Thread) object));

        System.out.println("after unpark");
    }
}

public class test {
    public static void main(String[] args) {
        MyThread myThread = new MyThread(Thread.currentThread());
        myThread.start();
        System.out.println("before park");
        // è·å–è®¸å¯
        LockSupport.park("ParkAndUnparkDemo");
        System.out.println("after park");
    }
}
```

ç»“æœå¦‚ä¸‹ï¼š

```
before park
before unpark
Blocker info ParkAndUnparkDemo
after park
Blocker info null
after unpark
```





###  èµ„æºå…±äº«æ–¹å¼ :1234:

AQSå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ª`volatile`çš„å˜é‡`state`æ¥ä½œä¸ºèµ„æºçš„æ ‡è¯†ã€‚åŒæ—¶å®šä¹‰äº†å‡ ä¸ªè·å–å’Œæ”¹å˜stateçš„protectedæ–¹æ³•ï¼Œå­ç±»å¯ä»¥è¦†ç›–è¿™äº›æ–¹æ³•æ¥å®ç°è‡ªå·±çš„é€»è¾‘ï¼š

```java
getState()
setState()
compareAndSetState()
```

è¿™ä¸‰ç§æ“ä½œå‡æ˜¯åŸå­æ“ä½œï¼Œå…¶ä¸­`compareAndSetState`çš„å®ç°ä¾èµ–äºUnsafeçš„`compareAndSwapInt`()æ–¹æ³•ã€‚

è€ŒAQSç±»æœ¬èº«å®ç°çš„æ˜¯ä¸€äº›æ’é˜Ÿå’Œé˜»å¡çš„æœºåˆ¶ï¼Œæ¯”å¦‚å…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ã€‚å®ƒå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŒç«¯é˜Ÿåˆ—ï¼Œå¹¶ä½¿ç”¨äº†ä¸¤ä¸ªæŒ‡é’ˆheadå’Œtailç”¨äºæ ‡è¯†é˜Ÿåˆ—çš„å¤´éƒ¨å’Œå°¾éƒ¨ã€‚å…¶æ•°æ®ç»“æ„å¦‚å›¾ï¼š

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/thread/aqs-c294b5e3-69ef-49bb-ac56-f825894746ab.png" alt="img" style="zoom:67%;" />



ä½†å®ƒå¹¶ä¸æ˜¯ç›´æ¥å‚¨å­˜çº¿ç¨‹ï¼Œè€Œæ˜¯å‚¨å­˜æ‹¥æœ‰çº¿ç¨‹çš„NodeèŠ‚ç‚¹





`AQS` å®šä¹‰äº†ä¸¤ç§èµ„æºå…±äº«æ–¹å¼ï¼š

`Exclusive`ï¼ˆç‹¬å ï¼Œä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œå¦‚`ReentrantLock`ï¼‰

`Share`ï¼ˆå…±äº«ï¼Œå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶æ‰§è¡Œï¼Œå¦‚`Semaphore`/`CountDownLatch`,å…·ä½“çš„èµ„æºä¸ªæ•°å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šï¼‰



ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå­ç±»åªéœ€è¦æ ¹æ®éœ€æ±‚å®ç°å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œå½“ç„¶ä¹Ÿæœ‰åŒæ—¶å®ç°ä¸¤ç§æ¨¡å¼çš„åŒæ­¥ç±»ï¼Œå¦‚`ReadWriteLock`



`AQS`ä¸­å…³äºè¿™ä¸¤ç§èµ„æºå…±äº«æ¨¡å¼çš„å®šä¹‰æºç ï¼ˆå‡åœ¨å†…éƒ¨ç±»Nodeä¸­ï¼‰ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹`Node`çš„ç»“æ„ï¼š

```java
static final class Node {
    // æ ‡è®°ä¸€ä¸ªç»“ç‚¹ï¼ˆå¯¹åº”çš„çº¿ç¨‹ï¼‰åœ¨å…±äº«æ¨¡å¼ä¸‹ç­‰å¾…
    static final Node SHARED = new Node();
    // æ ‡è®°ä¸€ä¸ªç»“ç‚¹ï¼ˆå¯¹åº”çš„çº¿ç¨‹ï¼‰åœ¨ç‹¬å æ¨¡å¼ä¸‹ç­‰å¾…
    static final Node EXCLUSIVE = null; 

    // waitStatusçš„å€¼ï¼Œè¡¨ç¤ºè¯¥ç»“ç‚¹ï¼ˆå¯¹åº”çš„çº¿ç¨‹ï¼‰å·²è¢«å–æ¶ˆ
    static final int CANCELLED = 1; 
    // waitStatusçš„å€¼ï¼Œè¡¨ç¤ºåç»§ç»“ç‚¹ï¼ˆå¯¹åº”çš„çº¿ç¨‹ï¼‰éœ€è¦è¢«å”¤é†’
    static final int SIGNAL = -1;
    // waitStatusçš„å€¼ï¼Œè¡¨ç¤ºè¯¥ç»“ç‚¹ï¼ˆå¯¹åº”çš„çº¿ç¨‹ï¼‰åœ¨ç­‰å¾…æŸä¸€æ¡ä»¶
    static final int CONDITION = -2;
    /*waitStatusçš„å€¼ï¼Œè¡¨ç¤ºæœ‰èµ„æºå¯ç”¨ï¼Œæ–°headç»“ç‚¹éœ€è¦ç»§ç»­å”¤é†’åç»§ç»“ç‚¹ï¼ˆå…±äº«æ¨¡å¼ä¸‹ï¼Œå¤šçº¿ç¨‹å¹¶å‘é‡Šæ”¾èµ„æºï¼Œè€Œheadå”¤é†’å…¶åç»§ç»“ç‚¹åï¼Œéœ€è¦æŠŠå¤šå‡ºæ¥çš„èµ„æºç•™ç»™åé¢çš„ç»“ç‚¹ï¼›è®¾ç½®æ–°çš„headç»“ç‚¹æ—¶ï¼Œä¼šç»§ç»­å”¤é†’å…¶åç»§ç»“ç‚¹ï¼‰*/
    static final int PROPAGATE = -3;

    // ç­‰å¾…çŠ¶æ€ï¼Œå–å€¼èŒƒå›´ï¼Œ-3ï¼Œ-2ï¼Œ-1ï¼Œ0ï¼Œ1
    volatile int waitStatus;
    volatile Node prev; // å‰é©±ç»“ç‚¹
    volatile Node next; // åç»§ç»“ç‚¹
    volatile Thread thread; // ç»“ç‚¹å¯¹åº”çš„çº¿ç¨‹
    Node nextWaiter; // ç­‰å¾…é˜Ÿåˆ—é‡Œä¸‹ä¸€ä¸ªç­‰å¾…æ¡ä»¶çš„ç»“ç‚¹

    
    // åˆ¤æ–­å…±äº«æ¨¡å¼çš„æ–¹æ³•
    final boolean isShared() {
        return nextWaiter == SHARED;
    }
    
    Node(Thread thread, Node mode) {     // Used by addWaiter
        this.nextWaiter = mode;
        this.thread = thread;
    }
    
    // å…¶å®ƒæ–¹æ³•å¿½ç•¥ï¼Œå¯ä»¥å‚è€ƒå…·ä½“çš„æºç 
}

// AQSé‡Œé¢çš„addWaiterç§æœ‰æ–¹æ³•
private Node addWaiter(Node mode) {
    // ä½¿ç”¨äº†Nodeçš„è¿™ä¸ªæ„é€ å‡½æ•°
    Node node = new Node(Thread.currentThread(), mode);
    // å…¶å®ƒä»£ç çœç•¥
}
```



> æ³¨æ„ï¼šé€šè¿‡Nodeæˆ‘ä»¬å¯ä»¥å®ç°ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€æ˜¯é€šè¿‡prevå’Œnextå®ç°CLHé˜Ÿåˆ—(çº¿ç¨‹åŒæ­¥é˜Ÿåˆ—,åŒå‘é˜Ÿåˆ—)ï¼Œ**äºŒæ˜¯nextWaiterå®ç°Conditionæ¡ä»¶ä¸Šçš„ç­‰å¾…çº¿ç¨‹é˜Ÿåˆ—(å•å‘é˜Ÿåˆ—)ï¼Œè¿™ä¸ªConditionä¸»è¦ç”¨åœ¨ReentrantLockç±»ä¸­(è¿™é‡Œæˆ‘ä»¬å…ˆä¸é‡ç‚¹å…³æ³¨å®ƒ)**





ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒï¼Œ**è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦å®ç°å…±äº«èµ„æºstateçš„è·å–ä¸é‡Šæ”¾æ–¹å¼å³å¯**ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQSçš„è®¾è®¡æ˜¯åŸºäº**æ¨¡æ¿æ–¹æ³•æ¨¡å¼**çš„ï¼Œå®ƒæœ‰ä¸€äº›æ–¹æ³•å¿…é¡»è¦å­ç±»å»å®ç°çš„ï¼Œä¸»è¦æœ‰ï¼š

- `isHeldExclusively()`ï¼šè¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æº ã€‚ç”¨åˆ°`condition`æ‰éœ€è¦å®ç°
- `tryAcquire(int)`ï¼šç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false
- `tryRelease(int)`ï¼šç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false
- `tryAcquireShared(int)`ï¼šå…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æº
- `tryReleaseShared(int)`ï¼šå…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼Œå¦‚æœé‡Šæ”¾åå…è®¸å”¤é†’åç»­ç­‰å¾…ç»“ç‚¹è¿”å›trueï¼Œå¦åˆ™è¿”å›false





`AQS` ä½¿ç”¨ **int æˆå‘˜å˜é‡ `state` è¡¨ç¤ºåŒæ­¥çŠ¶æ€**:(æœ‰äº›åœ°æ–¹æ˜¯`status`ï¼Œä¸€ä¸ªæ¦‚å¿µ)

```java
private volatile int state; //volatileä¿®é¥°ä¿è¯çº¿ç¨‹å¯è§æ€§
```





:exclamation: :grey_exclamation: :heavy_exclamation_mark:  **ä¸€å®šæ³¨æ„ï¼š Stateåœ¨ä¸åŒçš„åŒæ­¥å™¨å®ç°ä¸‹æ‰€ä»£è¡¨çš„å«ä¹‰æ˜¯ä¸åŒçš„**

> AQSä¸­çš„stateæ˜¯è¡¨ç¤ºåŒæ­¥çŠ¶æ€çš„ä¸€ä¸ªæ•´æ•°å€¼ï¼Œç”¨äºç®¡ç†å’Œæ§åˆ¶åŒæ­¥å™¨çš„çŠ¶æ€å’Œçº¿ç¨‹çš„è®¿é—®ã€‚
>
> åœ¨AQSä¸­ï¼Œstateçš„å«ä¹‰å’Œç”¨é€”å–å†³äºå…·ä½“çš„åŒæ­¥å™¨çš„å®ç°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œstateå¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§ç”¨é€”ï¼š
>
> 1. **ä»£è¡¨èµ„æºçš„å¯ç”¨æ•°é‡**ï¼šåœ¨ä¸€äº›åŒæ­¥å™¨ä¸­ï¼Œstateå¯ä»¥è¡¨ç¤ºæŸç§èµ„æºçš„å¯ç”¨æ•°é‡ï¼Œä¾‹å¦‚Semaphoreï¼ˆä¿¡å·é‡ï¼‰åŒæ­¥å™¨ä¸­çš„stateè¡¨ç¤ºå¯ç”¨çš„è®¸å¯æ•°ã€‚çº¿ç¨‹åœ¨è·å–èµ„æºæ—¶ï¼Œä¼šå°è¯•å°†stateå‡å°‘ï¼Œå½“stateä¸º0æ—¶ï¼Œè¡¨ç¤ºèµ„æºå·²ç»è€—å°½ã€‚
> 2. **ä»£è¡¨é”çš„çŠ¶æ€**ï¼š**åœ¨ç‹¬å é”ï¼ˆå¦‚ReentrantLockï¼‰çš„åŒæ­¥å™¨ä¸­ï¼Œstateé€šå¸¸è¡¨ç¤ºé”çš„çŠ¶æ€ï¼Œæ¯”å¦‚0è¡¨ç¤ºæœªé”å®šï¼Œ1è¡¨ç¤ºé”å®š**ã€‚çº¿ç¨‹åœ¨è·å–é”æ—¶ï¼Œä¼šå°è¯•å°†stateä»0ä¿®æ”¹ä¸º1ï¼Œè·å–é”æˆåŠŸåå†å°†stateè®¾ç½®å›0ä»¥é‡Šæ”¾é”ã€‚
> 3. è®°å½•çº¿ç¨‹æ•°é‡ï¼šåœ¨æŸäº›åŒæ­¥å™¨ä¸­ï¼Œstateå¯ä»¥ç”¨äºè®°å½•å½“å‰åœ¨åŒæ­¥å™¨ä¸Šç­‰å¾…çš„çº¿ç¨‹æ•°é‡ã€‚çº¿ç¨‹è¿›å…¥åŒæ­¥å™¨ç­‰å¾…æ—¶ï¼Œä¼šå°†stateå¢åŠ ï¼Œé€€å‡ºç­‰å¾…æ—¶ä¼šå°†stateå‡å°‘ã€‚







å¦å¤–ï¼ŒçŠ¶æ€ä¿¡æ¯ `state` å¯ä»¥é€šè¿‡ `protected` ç±»å‹çš„`getState()`ã€`setState()`å’Œ`compareAndSetState()` è¿›è¡Œæ“ä½œ,å¹¶ä¸”è¿™å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯ `final` ä¿®é¥°çš„ï¼Œåœ¨å­ç±»ä¸­æ— æ³•è¢«é‡å†™

```java
//è¿”å›åŒæ­¥çŠ¶æ€çš„å½“å‰å€¼
protected final int getState() {
     return state;
}
 // è®¾ç½®åŒæ­¥çŠ¶æ€çš„å€¼
protected final void setState(int newState) {
     state = newState;
}
//åŸå­åœ°ï¼ˆCASæ“ä½œï¼‰å°†åŒæ­¥çŠ¶æ€å€¼è®¾ç½®ä¸ºç»™å®šå€¼updateå¦‚æœå½“å‰åŒæ­¥çŠ¶æ€çš„å€¼ç­‰äºexpectï¼ˆæœŸæœ›å€¼ï¼‰
protected final boolean compareAndSetState(int expect, int update) {
      return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
}
```

ä»¥ `ReentrantLock` ä¸ºä¾‹ï¼Œ`state` åˆå§‹å€¼ä¸º 0ï¼Œè¡¨ç¤ºæœªé”å®šçŠ¶æ€ã€‚A çº¿ç¨‹ `lock()` æ—¶ï¼Œä¼šè°ƒç”¨ `tryAcquire()` ç‹¬å è¯¥é”å¹¶å°† `state+1` ã€‚æ­¤åï¼Œå…¶ä»–çº¿ç¨‹å† `tryAcquire()` æ—¶å°±ä¼šå¤±è´¥ï¼Œç›´åˆ° A çº¿ç¨‹ `unlock()` åˆ° `state=0`ï¼ˆå³é‡Šæ”¾é”ï¼‰ä¸ºæ­¢ï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè·å–è¯¥é”ã€‚å½“ç„¶ï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒA çº¿ç¨‹è‡ªå·±æ˜¯å¯ä»¥é‡å¤è·å–æ­¤é”çš„ï¼ˆ`state` ä¼šç´¯åŠ ï¼‰ï¼Œè¿™å°±æ˜¯å¯é‡å…¥çš„æ¦‚å¿µã€‚ä½†è¦æ³¨æ„ï¼Œè·å–å¤šå°‘æ¬¡å°±è¦é‡Šæ”¾å¤šå°‘æ¬¡ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ state æ˜¯èƒ½å›åˆ°é›¶æ€çš„

å†ä»¥ `CountDownLatch` ä»¥ä¾‹ï¼Œä»»åŠ¡åˆ†ä¸º N ä¸ªå­çº¿ç¨‹å»æ‰§è¡Œï¼Œ`state` ä¹Ÿåˆå§‹åŒ–ä¸º Nï¼ˆæ³¨æ„ N è¦ä¸çº¿ç¨‹ä¸ªæ•°ä¸€è‡´ï¼‰ä¸”è¿™ N ä¸ªå­çº¿ç¨‹æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¯ä¸ªå­çº¿ç¨‹æ‰§è¡Œå®Œå`countDown()` ä¸€æ¬¡ï¼Œstate ä¼šç»`CAS`æ“ä½œ å‡1 ï¼› ç­‰åˆ°æ‰€æœ‰å­çº¿ç¨‹éƒ½æ‰§è¡Œå®Œå(å³ `state=0` )ï¼Œä¼š `unpark()` è§£é”ä¸»è°ƒç”¨çº¿ç¨‹ï¼Œç„¶åä¸»è°ƒç”¨çº¿ç¨‹å°±ä¼šä» `await()` å‡½æ•°è¿”å›ï¼Œç»§ç»­åä½™åŠ¨ä½œ







#### Exclusive



`Exclusive`æ¨¡å¼ä¸‹è·å–å…±äº«èµ„æºçš„æµç¨‹å¦‚ä¸‹ï¼š



1ã€ `acquire(int)`æ–¹æ³•æ˜¯ç‹¬å æ¨¡å¼ä¸‹çº¿ç¨‹è·å–å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£(ç›¸å½“äºlock())ã€‚å¦‚æœè·å–åˆ°èµ„æºï¼Œçº¿ç¨‹ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–åˆ°èµ„æºä¸ºæ­¢:

```java
public final void acquire(int arg) {
2     if (!tryAcquire(arg) &&// tryAcuire()ä¸º1ï¼Œå³æ–°çº¿ç¨‹æŠ¢å åˆ°èµ„æºåå°±ç›´æ¥é€€å‡ºäº†
3         acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
4         selfInterrupt();
5 }

```

1. `tryAcquire()`å°è¯•**ç›´æ¥å»è·å–èµ„æºï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›(è¿™é‡Œä½“ç°äº†éå…¬å¹³é”ï¼Œæ¯ä¸ªçº¿ç¨‹è·å–é”æ—¶ä¼šå°è¯•ç›´æ¥æŠ¢å åŠ å¡ä¸€æ¬¡ï¼Œè€ŒCLHé˜Ÿåˆ—ä¸­å¯èƒ½è¿˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨ç­‰å¾…)**ï¼›
2. **`addWaiter`()å°†è¯¥è·å–èµ„æºå¤±è´¥çš„çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ ‡è®°ä¸ºç‹¬å æ¨¡å¼**ï¼›
3. `acquireQueued`()ä½¿çº¿ç¨‹é˜»å¡åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­è·å–èµ„æºï¼Œä¸€ç›´è·å–åˆ°èµ„æºåæ‰è¿”å›ã€‚å¦‚æœåœ¨æ•´ä¸ªç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™è¿”å›`true`ï¼Œå¦åˆ™è¿”å›`false`
4. å¦‚æœçº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œå®ƒæ˜¯ä¸å“åº”çš„ã€‚åªæ˜¯è·å–èµ„æºåæ‰å†è¿›è¡Œè‡ªæˆ‘ä¸­æ–­`selfInterrupt()`ï¼Œå°†ä¸­æ–­è¡¥ä¸Š

2ã€`tryAcquire(int)` æ­¤æ–¹æ³•å°è¯•å»è·å–ç‹¬å èµ„æºã€‚å¦‚æœè·å–æˆåŠŸï¼Œåˆ™ç›´æ¥è¿”å›`true`ï¼Œå¦åˆ™ç›´æ¥è¿”å›`false`

```java
protected boolean tryAcquire(int arg) {
2         throw new UnsupportedOperationException();
3     }
```

3ã€`addWaiter(Node)`

```JAVA
private Node addWaiter(Node mode) {
    // ç”Ÿæˆè¯¥çº¿ç¨‹å¯¹åº”çš„NodeèŠ‚ç‚¹
    Node node = new Node(Thread.currentThread(), mode);
    // å°†Nodeæ’å…¥é˜Ÿåˆ—ä¸­
    Node pred = tail;
    if (pred != null) {
        node.prev = pred;
        // ä½¿ç”¨CASå°è¯•ï¼Œå¦‚æœæˆåŠŸå°±è¿”å›
        if (compareAndSetTail(pred, node)) {
            pred.next = node;
            return node;
        }
    }
    // å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºæˆ–è€…ä¸Šè¿°CASå¤±è´¥ï¼Œå†è‡ªæ—‹CASæ’å…¥
    enq(node);
    return node;
}

// è‡ªæ—‹CASæ’å…¥ç­‰å¾…é˜Ÿåˆ—
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) { // Must initialize
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                t.next = node;
                return t;
            }
        }
    }
}

```

> ä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯åœ¨ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨æ’å…¥æ–°çš„NodeèŠ‚ç‚¹ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ç”±äºAQSä¸­ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶äº‰å¤ºèµ„æºçš„æƒ…å†µï¼Œå› æ­¤è‚¯å®šä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶æ’å…¥èŠ‚ç‚¹çš„æ“ä½œï¼Œåœ¨è¿™é‡Œæ˜¯é€šè¿‡CASè‡ªæ—‹çš„æ–¹å¼ä¿è¯äº†æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œä¸”ä¿è¯äº†è¯¥çº¿ç¨‹å¯¹åº”èŠ‚ç‚¹ä¸€å®šèƒ½å¤Ÿå…¥é˜ŸæˆåŠŸ





4ã€`acquireQueued(Node, int)`

é€šè¿‡`tryAcquire`()å’Œ`addWaiter`()ï¼Œè¯¥çº¿ç¨‹è·å–èµ„æºå¤±è´¥ï¼Œå·²ç»è¢«æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨äº†,**è¿›å…¥ç­‰å¾…çŠ¶æ€ä¼‘æ¯ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹å½»åº•é‡Šæ”¾èµ„æºåå”¤é†’è‡ªå·±**

```java
final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;//æ ‡è®°æ˜¯å¦æˆåŠŸæ‹¿åˆ°èµ„æº
    try {
        boolean interrupted = false;//æ ‡è®°ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­è¿‡

        //åˆæ˜¯ä¸€ä¸ªâ€œè‡ªæ—‹â€ï¼
        for (;;) {
            final Node p = node.predecessor();//æ‹¿åˆ°å‰é©±
            //å¦‚æœå‰é©±æ˜¯headï¼Œå³è¯¥ç»“ç‚¹å·²æˆè€äºŒï¼Œé‚£ä¹ˆä¾¿æœ‰èµ„æ ¼å»å°è¯•è·å–èµ„æºï¼ˆå¯èƒ½æ˜¯è€å¤§é‡Šæ”¾å®Œèµ„æºå”¤é†’è‡ªå·±çš„ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½è¢«interruptäº†ï¼‰ã€‚
            if (p == head && tryAcquire(arg)) {
                setHead(node);//æ‹¿åˆ°èµ„æºåï¼Œå°†headæŒ‡å‘è¯¥ç»“ç‚¹ã€‚æ‰€ä»¥headæ‰€æŒ‡çš„æ ‡æ†ç»“ç‚¹ï¼Œå°±æ˜¯å½“å‰è·å–åˆ°èµ„æºçš„é‚£ä¸ªç»“ç‚¹æˆ–nullã€‚
                p.next = null; // setHeadä¸­node.prevå·²ç½®ä¸ºnullï¼Œæ­¤å¤„å†å°†head.nextç½®ä¸ºnullï¼Œå°±æ˜¯ä¸ºäº†æ–¹ä¾¿GCå›æ”¶ä»¥å‰çš„headç»“ç‚¹ã€‚ä¹Ÿå°±æ„å‘³ç€ä¹‹å‰æ‹¿å®Œèµ„æºçš„ç»“ç‚¹å‡ºé˜Ÿäº†ï¼
                failed = false; // æˆåŠŸè·å–èµ„æº
                return interrupted;//è¿”å›ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­è¿‡
            }

            //å¦‚æœè‡ªå·±å¯ä»¥ä¼‘æ¯äº†ï¼Œå°±é€šè¿‡park()è¿›å…¥waitingçŠ¶æ€ï¼Œç›´åˆ°è¢«unpark()ã€‚å¦‚æœä¸å¯ä¸­æ–­çš„æƒ…å†µä¸‹è¢«ä¸­æ–­äº†ï¼Œé‚£ä¹ˆä¼šä»park()ä¸­é†’è¿‡æ¥ï¼Œå‘ç°æ‹¿ä¸åˆ°èµ„æºï¼Œä»è€Œç»§ç»­è¿›å…¥park()ç­‰å¾…ã€‚
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                interrupted = true;//å¦‚æœç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œå“ªæ€•åªæœ‰é‚£ä¹ˆä¸€æ¬¡ï¼Œå°±å°†interruptedæ ‡è®°ä¸ºtrue
        }
    } finally {
        if (failed) // å¦‚æœç­‰å¾…è¿‡ç¨‹ä¸­æ²¡æœ‰æˆåŠŸè·å–èµ„æºï¼ˆå¦‚timeoutï¼Œæˆ–è€…å¯ä¸­æ–­çš„æƒ…å†µä¸‹è¢«ä¸­æ–­äº†ï¼‰ï¼Œé‚£ä¹ˆå–æ¶ˆç»“ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„ç­‰å¾…ã€‚
            cancelAcquire(node);
    }
}
```

æ‰€ä»¥**ç»“ç‚¹è¿›å…¥ç­‰å¾…é˜Ÿåˆ—åï¼Œæ˜¯è°ƒç”¨parkä½¿å®ƒè¿›å…¥é˜»å¡çŠ¶æ€çš„ã€‚åªæœ‰å¤´ç»“ç‚¹çš„çº¿ç¨‹æ˜¯å¤„äºæ´»è·ƒçŠ¶æ€çš„**ã€‚



æ€»ç»“ä¸‹æµç¨‹ï¼š

1. è°ƒç”¨è‡ªå®šä¹‰åŒæ­¥å™¨çš„`tryAcquire()`å°è¯•ç›´æ¥å»è·å–èµ„æºï¼Œå¦‚æœæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼›
2. æ²¡æˆåŠŸï¼Œåˆ™`addWaiter()`å°†è¯¥çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶æ ‡è®°ä¸ºç‹¬å æ¨¡å¼ï¼›
3. `acquireQueued()`ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ä¼‘æ¯ï¼Œæœ‰**æœºä¼šæ—¶ï¼ˆè½®åˆ°è‡ªå·±ï¼Œä¼šè¢«unpark()ï¼‰ä¼šå»å°è¯•è·å–èµ„æº**,è·å–åˆ°èµ„æºåæ‰è¿”å›ã€‚å¦‚æœåœ¨æ•´ä¸ªç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false
4. å¦‚æœçº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œå®ƒæ˜¯ä¸å“åº”çš„,åªæ˜¯è·å–èµ„æºåæ‰å†è¿›è¡Œè‡ªæˆ‘ä¸­æ–­`selfInterrupt()`ï¼Œå°†ä¸­æ–­è¡¥ä¸Š

`acquire()`çš„æµç¨‹ä¹Ÿæ˜¯`ReentrantLock.lock()`çš„æµç¨‹ï¼Œæ•´ä¸ªå‡½æ•°å°±æ˜¯``acquire(1)`!!!

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/thread/aqs-a0689bb2-9b18-419d-9617-6d292fbd439d.jpg" alt="acquireæµç¨‹" style="zoom: 67%;" />













**`Exclusive`æ¨¡å¼ä¸‹é‡Šæ”¾å…±äº«èµ„æºçš„æµç¨‹å¦‚ä¸‹ï¼š**

1ã€`release(int)`ï¼š æ­¤æ–¹æ³•æ˜¯ç‹¬å æ¨¡å¼ä¸‹çº¿ç¨‹é‡Šæ”¾å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å®ƒä¼šé‡Šæ”¾æŒ‡å®šé‡çš„èµ„æºï¼Œå¦‚æœå½»åº•é‡Šæ”¾äº†ï¼ˆå³state=0ï¼‰,å®ƒä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„å…¶ä»–çº¿ç¨‹æ¥è·å–èµ„æºã€‚è¿™ä¹Ÿæ­£æ˜¯`unlock()`çš„è¯­ä¹‰

```java
public final boolean release(int arg) {
    if (tryRelease(arg)) {//è°ƒç”¨tryRelease()æ¥é‡Šæ”¾èµ„æº
        Node h = head;//æ‰¾åˆ°å¤´ç»“ç‚¹
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h);//å”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„ä¸‹ä¸€ä¸ªçº¿ç¨‹!
        return true;
    }
    return false;
}
```



2ã€ `tryRelease(int)`:

è·Ÿ`tryAcquire()`ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯**éœ€è¦ç‹¬å æ¨¡å¼çš„è‡ªå®šä¹‰åŒæ­¥å™¨**å»å®ç°çš„ã€‚æ­£å¸¸æ¥è¯´ï¼ŒtryRelease()éƒ½ä¼šæˆåŠŸçš„ï¼Œå› ä¸ºè¿™æ˜¯ç‹¬å æ¨¡å¼ï¼Œè¯¥çº¿ç¨‹æ¥é‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå®ƒè‚¯å®šå·²ç»æ‹¿åˆ°ç‹¬å èµ„æºäº†ï¼Œç›´æ¥å‡æ‰ç›¸åº”é‡çš„èµ„æºå³å¯(state-=arg)ï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚ä½†è¦æ³¨æ„å®ƒçš„è¿”å›å€¼ï¼Œä¸Šé¢å·²ç»æåˆ°äº†ï¼Œ**release()æ˜¯æ ¹æ®tryRelease()çš„è¿”å›å€¼æ¥åˆ¤æ–­è¯¥çº¿ç¨‹æ˜¯å¦å·²ç»å®Œæˆé‡Šæ”¾æ‰èµ„æºäº†ï¼**æ‰€ä»¥è‡ªä¹‰å®šåŒæ­¥å™¨åœ¨å®ç°æ—¶ï¼Œå¦‚æœå·²ç»å½»åº•é‡Šæ”¾èµ„æº(state=0)ï¼Œè¦è¿”å›trueï¼Œå¦åˆ™è¿”å›false

```java
1 protected boolean tryRelease(int arg) {
2     throw new UnsupportedOperationException();
3 }
```

3ã€`unparkSuccessor(Node node)`:æ­¤æ–¹æ³•ç”¨äºå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªçº¿ç¨‹

```java
private void unparkSuccessor(Node node) {
    //è¿™é‡Œï¼Œnodeä¸€èˆ¬ä¸ºå½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹ã€‚
    int ws = node.waitStatus;
    if (ws < 0)//ç½®é›¶å½“å‰çº¿ç¨‹æ‰€åœ¨çš„ç»“ç‚¹çŠ¶æ€ï¼Œå…è®¸å¤±è´¥ã€‚
        compareAndSetWaitStatus(node, ws, 0);

    Node s = node.next;//æ‰¾åˆ°ä¸‹ä¸€ä¸ªéœ€è¦å”¤é†’çš„ç»“ç‚¹s
    if (s == null || s.waitStatus > 0) {//å¦‚æœä¸ºç©ºæˆ–å·²å–æ¶ˆ
        s = null;
        for (Node t = tail; t != null && t != node; t = t.prev) // ä»åå‘å‰æ‰¾ã€‚
            if (t.waitStatus <= 0)//ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œ<=0çš„ç»“ç‚¹ï¼Œéƒ½æ˜¯è¿˜æœ‰æ•ˆçš„ç»“ç‚¹ã€‚
                s = t;
    }
    if (s != null)
        LockSupport.unpark(s.thread);//// å¦‚æœåç»§ç»“ç‚¹ä¸ä¸ºç©ºï¼Œå”¤é†’çº¿ç¨‹
}
```

`release()`æ˜¯**ç‹¬å æ¨¡å¼**ä¸‹çº¿ç¨‹é‡Šæ”¾å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£,å®ƒä¼šé‡Šæ”¾æŒ‡å®šé‡çš„èµ„æºï¼Œå¦‚æœå½»åº•é‡Šæ”¾äº†ï¼ˆå³state=0ï¼‰,å®ƒä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„å…¶ä»–çº¿ç¨‹æ¥è·å–èµ„æº







#### Share

è·å–å…±äº«èµ„æºï¼š

1ã€ `acquireShared()`:æ­¤æ–¹æ³•æ˜¯å…±äº«æ¨¡å¼ä¸‹çº¿ç¨‹è·å–å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å®ƒä¼šè·å–æŒ‡å®šé‡çš„èµ„æºï¼Œè·å–æˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œè·å–å¤±è´¥åˆ™è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–åˆ°èµ„æºä¸ºæ­¢ï¼Œæ•´ä¸ªè¿‡ç¨‹å¿½ç•¥ä¸­æ–­ã€‚ä¸‹é¢æ˜¯`acquireShared()`çš„æºç ï¼š

```java
 public final void acquireShared(int arg) {
     if (tryAcquireShared(arg) < 0)
         doAcquireShared(arg);
 }

//è¿™é‡ŒacquireShared()çš„æµç¨‹å°±æ˜¯ï¼š
//tryAcquireShared()å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼›
//å¤±è´¥åˆ™é€šè¿‡doAcquireShared()è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–åˆ°èµ„æºä¸ºæ­¢æ‰è¿”å›
    
    
 public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout)
            throws InterruptedException {
        if (!Thread.interrupted()) {
            if (tryAcquireShared(arg) >= 0)
                return true;
            if (nanosTimeout <= 0L)
                return false;
            int stat = acquire(null, arg, true, true, true,
                               System.nanoTime() + nanosTimeout);
            if (stat > 0)
                return true;
            if (stat == 0)
                return false;
        }
        throw new InterruptedException();
    }
```



2ã€`doAcquireShared()`:æ­¤æ–¹æ³•ç”¨äºå°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ä¼‘æ¯ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é‡Šæ”¾èµ„æºå”¤é†’è‡ªå·±ï¼Œè‡ªå·±æˆåŠŸæ‹¿åˆ°ç›¸åº”é‡çš„èµ„æºåæ‰è¿”å›ã€‚ä¸‹é¢æ˜¯`doAcquireShared()`çš„æºç ï¼š

```java
private void doAcquireShared(int arg) {
    final Node node = addWaiter(Node.SHARED);//åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨
    boolean failed = true;//æ˜¯å¦æˆåŠŸæ ‡å¿—
    try {
        boolean interrupted = false;//ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­è¿‡çš„æ ‡å¿—
        for (;;) {
            final Node p = node.predecessor();//å‰é©±
            if (p == head) {//å¦‚æœåˆ°headçš„ä¸‹ä¸€ä¸ªï¼Œå› ä¸ºheadæ˜¯æ‹¿åˆ°èµ„æºçš„çº¿ç¨‹ï¼Œæ­¤æ—¶nodeè¢«å”¤é†’ï¼Œå¾ˆå¯èƒ½æ˜¯headç”¨å®Œèµ„æºæ¥å”¤é†’è‡ªå·±çš„
                int r = tryAcquireShared(arg);//å°è¯•è·å–èµ„æº
                if (r >= 0) {//æˆåŠŸ
                    setHeadAndPropagate(node, r);//å°†headæŒ‡å‘è‡ªå·±ï¼Œè¿˜æœ‰å‰©ä½™èµ„æºå¯ä»¥å†å”¤é†’ä¹‹åçš„çº¿ç¨‹
                    p.next = null; // help GC
                    if (interrupted)//å¦‚æœç­‰å¾…è¿‡ç¨‹ä¸­è¢«æ‰“æ–­è¿‡ï¼Œæ­¤æ—¶å°†ä¸­æ–­è¡¥ä¸Šã€‚
                        selfInterrupt();
                    failed = false;
                    return;
                }
            }

            //åˆ¤æ–­çŠ¶æ€ï¼Œå¯»æ‰¾å®‰å…¨ç‚¹ï¼Œè¿›å…¥waitingçŠ¶æ€ï¼Œç­‰ç€è¢«unpark()æˆ–interrupt()
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())
                interrupted = true;
        }
    } finally {
        if (failed)
            cancelAcquire(node);
    }
}
```

å†æ¢³ç†ä¸€ä¸‹`acquireShared`çš„æµç¨‹ï¼š

`tryAcquireShared`()å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼›

å¤±è´¥åˆ™é€šè¿‡`doAcquireShared`()è¿›å…¥ç­‰å¾…é˜Ÿåˆ—`park`()ï¼Œç›´åˆ°è¢«`unpark`()/`interrupt`()å¹¶æˆåŠŸè·å–åˆ°èµ„æºæ‰è¿”å›,æ•´ä¸ªç­‰å¾…è¿‡ç¨‹ä¹Ÿå¿½ç•¥ä¸­æ–­





é‡Šæ”¾å…±äº«èµ„æºï¼š

`releaseShared`()ï¼šæ–¹æ³•æ˜¯å…±äº«æ¨¡å¼ä¸‹çº¿ç¨‹é‡Šæ”¾å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å®ƒä¼šé‡Šæ”¾æŒ‡å®šé‡çš„èµ„æºï¼Œå¦‚æœæˆåŠŸé‡Šæ”¾ä¸”å…è®¸å”¤é†’ç­‰å¾…çº¿ç¨‹ï¼Œå®ƒä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„å…¶ä»–çº¿ç¨‹æ¥è·å–èµ„æºã€‚ä¸‹é¢æ˜¯`releaseShared`()çš„æºç ï¼š

```java
public final boolean releaseShared(int arg) {
    if (tryReleaseShared(arg)) {//å°è¯•é‡Šæ”¾èµ„æº
        doReleaseShared();//å”¤é†’åç»§ç»“ç‚¹
        return true;
    }
    return false;
}
```







### CLHé˜Ÿåˆ—

`AQS`é€šè¿‡å†…ç½®çš„ **FIFOçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—** æ¥å®Œæˆè·å–èµ„æºçº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œ

CLH é”æ˜¯å¯¹è‡ªæ—‹é”çš„ä¸€ç§æ”¹è¿›ï¼Œæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—ï¼ˆè™šæ‹Ÿçš„åŒå‘é˜Ÿåˆ—å³ä¸å­˜åœ¨é˜Ÿåˆ—å®ä¾‹ï¼Œä»…å­˜åœ¨ç»“ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼‰ï¼Œæš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹å°†è¢«åŠ å…¥åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚AQS å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é˜Ÿåˆ—é”çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…ï¼š

- å†…éƒ¨é€šè¿‡èŠ‚ç‚¹`head`(å®é™…ä¸Šæ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œ**çœŸæ­£çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨head.nextçš„ä½ç½®**)å’Œ`tail`è®°å½•é˜Ÿé¦–å’Œé˜Ÿå°¾å…ƒç´ ï¼Œé˜Ÿåˆ—å…ƒç´ ç±»å‹ä¸º`Node`;

- åœ¨ CLH é˜Ÿåˆ—é”ä¸­ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆ`thread`ï¼‰ã€ å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€ï¼ˆ`waitStatus`ï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆ`prev`ï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆ`next`ï¼‰;

- å¦‚æœå½“å‰çº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€å¤±è´¥ï¼ˆé”ï¼‰æ—¶ï¼Œ`AQS` åˆ™ä¼šå°†å½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆ`Node`ï¼‰å¹¶å°†å…¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹



```java
static final class Node {
/** ç­‰å¾…çº¿ç¨‹è¶…æ—¶æˆ–è€…è¢«ä¸­æ–­ã€éœ€è¦ä»åŒæ­¥é˜Ÿåˆ—ä¸­å–æ¶ˆç­‰å¾…ï¼ˆä¹Ÿå°±æ˜¯æ”¾å¼ƒèµ„æºçš„ç«äº‰ï¼‰ï¼Œæ­¤çŠ¶æ€ä¸ä¼šåœ¨æ”¹å˜ */
        static final int CANCELLED =  1;
        /** åç»§èŠ‚ç‚¹ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼Œå½“å‰èŠ‚ç‚¹çº¿ç¨‹å¦‚æœé‡Šæ”¾åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆåˆ™ä¼šé€šçŸ¥åç»§èŠ‚ç‚¹çº¿ç¨‹ï¼Œä½¿åç»§èŠ‚ç‚¹çº¿ç¨‹çš„å¾—ä»¥è¿è¡Œ */
        static final int SIGNAL    = -1;
        /** èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œçº¿ç¨‹åœ¨ç­‰å¾…åœ¨Condition ä¸Šï¼Œå…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨singnal()æ–¹æ³•åï¼Œè¯¥èŠ‚ç‚¹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚ */
        static final int CONDITION = -2;
        /**
         * è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼è·å–åŒæ­¥çŠ¶æ€çš„æ—¶ä¼šè¢«æ— æ¡ä»¶çš„ä¼ æ’­ä¸‹å»ã€‚
         */
        static final int PROPAGATE = -3;

        /**ç­‰å¾…çŠ¶æ€*/
        volatile int waitStatus;

        /**å‰é©±èŠ‚ç‚¹ */
        volatile Node prev;

        /**åç»§èŠ‚ç‚¹*/
        volatile Node next;

        /**è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ */
        volatile Thread thread;

        /**é“¾æ¥ä¸‹ä¸€ä¸ªç­‰å¾…çŠ¶æ€ */
        Node nextWaiter
}
```



#### å…¥é˜Ÿ/å‡ºé˜Ÿ

å…¥é˜Ÿæ“ä½œå¯åˆ†è§£æˆä¸‰æ­¥ï¼š

1. å°†tailï¼ˆä½¿ç”¨CASä¿è¯åŸå­æ“ä½œï¼‰æŒ‡å‘æ–°èŠ‚ç‚¹

2. æ–°èŠ‚ç‚¹çš„`prev`æŒ‡å‘é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆ**æ—§çš„å°¾èŠ‚ç‚¹étailèŠ‚ç‚¹**)
3. åŸé˜Ÿåˆ—ä¸­æœ€åä¸€èŠ‚ç‚¹çš„`next`æŒ‡é’ˆæŒ‡å‘æ–°èŠ‚ç‚¹ä»¥æ­¤æ¥å»ºç«‹è”ç³»

å…ˆé€šè¿‡`addWaiter(Node mode)`æ–¹æ³•å°è¯•å¿«é€Ÿå°†è¯¥èŠ‚ç‚¹è®¾ç½®å°¾æˆå°¾èŠ‚ç‚¹ï¼Œè®¾ç½®å¤±è´¥èµ°`enq(final Node node)`æ–¹æ³•

```JAVA
private Node addWaiter(Node mode) {
// ä»¥ç»™å®šçš„æ¨¡å¼æ¥æ„å»ºèŠ‚ç‚¹ï¼Œ modeæœ‰ä¸¤ç§æ¨¡å¼ 
//  å…±äº«å¼SHAREDï¼Œ ç‹¬å å¼EXCLUSIVE;
  Node node = new Node(Thread.currentThread(), mode);
    // å°è¯•å¿«é€Ÿå°†è¯¥èŠ‚ç‚¹åŠ å…¥åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨
    Node pred = tail;
     if (pred != null) {
        node.prev = pred;
            if (compareAndSetTail(pred, node)) {
                pred.next = node;
                return node;
            }
        }
        // å¦‚æœå¿«é€ŸåŠ å…¥å¤±è´¥ï¼Œåˆ™é€šè¿‡ enqæ–¹å¼å…¥åˆ—
        enq(node);
        return node;
    }

private Node enq(final Node node) {
// CASè‡ªæ—‹ï¼Œç›´åˆ°åŠ å…¥é˜Ÿå°¾æˆåŠŸ        
for (;;) {
    Node t = tail;
        if (t == null) { // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å¿…é¡»å…ˆåˆå§‹åŒ–CLHé˜Ÿåˆ—ï¼Œæ–°å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹æ ‡è¯†ä½œä¸ºHaderèŠ‚ç‚¹,å¹¶å°†tail æŒ‡å‘å®ƒ
            if (compareAndSetHead(new Node()))
                tail = head;
            } else {// æ­£å¸¸æµç¨‹ï¼ŒåŠ å…¥é˜Ÿåˆ—å°¾éƒ¨
                node.prev = t;
                    if (compareAndSetTail(t, node)) {
                        t.next = node;
                        return t;
                }
            }
        }
    }

```

é€šè¿‡â€œè‡ªæ—‹â€ä¹Ÿå°±æ˜¯æ­»å¾ªç¯çš„æ–¹å¼æ¥ä¿è¯è¯¥èŠ‚ç‚¹èƒ½é¡ºåˆ©çš„åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œåªæœ‰åŠ å…¥æˆåŠŸæ‰ä¼šé€€å‡ºå¾ªç¯ï¼Œå¦åˆ™ä¼šä¸€ç›´å¾ªåºç›´åˆ°æˆåŠŸ

ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯é€šè¿‡`compareAndSetHead(new Node())`æ–¹æ³•æ¥è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œä»¥ä¿è¯èŠ‚ç‚¹æ·»åŠ çš„çº¿ç¨‹å®‰å…¨



å‡ºé˜Ÿæ“ä½œï¼šåŒæ­¥é˜Ÿåˆ—ï¼ˆCLHï¼‰éµå¾ªFIFOï¼Œé¦–èŠ‚ç‚¹æ˜¯è·å–åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå› æ­¤é¦–èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†ä¼šå”¤é†’å®ƒçš„åç»§èŠ‚ç‚¹`next`ï¼Œè€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶å°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹ï¼Œåœ¨å®ç°ä¸Šç›´æ¥å°†headæŒ‡å‘æ–°é¦–èŠ‚ç‚¹(é€šè¿‡åŸé¦–èŠ‚ç‚¹çš„`next`æŒ‡é’ˆ)å¹¶æ–­å¼€æ—§é¦–èŠ‚ç‚¹ä¸æ–°é¦–èŠ‚ç‚¹ä¹‹å‰çš„è¿æ¥å°±å¯ä»¥äº†







## åŸºäºAQSå®ç°çš„å·¥å…·ç±» :computer:



AQSä½œä¸ºå¹¶å‘ç¼–ç¨‹çš„æ¡†æ¶ï¼Œä¸ºå¾ˆå¤šå…¶ä»–åŒæ­¥å·¥å…·æä¾›äº†è‰¯å¥½çš„è§£å†³æ–¹æ¡ˆã€‚ä¸‹é¢åˆ—å‡ºäº†JUCä¸­çš„å‡ ç§åŒæ­¥å·¥å…·ï¼Œå¤§ä½“ä»‹ç»ä¸€ä¸‹AQSçš„åº”ç”¨åœºæ™¯ï¼š

| åŒæ­¥å·¥å…·               | åŒæ­¥å·¥å…·ä¸AQSçš„å…³è”                                          |
| :--------------------- | :----------------------------------------------------------- |
| ReentrantLock          | ä½¿ç”¨AQSä¿å­˜é”é‡å¤æŒæœ‰çš„æ¬¡æ•°ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼ŒReentrantLockè®°å½•å½“å‰è·å¾—é”çš„çº¿ç¨‹æ ‡è¯†ï¼Œç”¨äºæ£€æµ‹æ˜¯å¦é‡å¤è·å–ï¼Œä»¥åŠé”™è¯¯çº¿ç¨‹è¯•å›¾è§£é”æ“ä½œæ—¶å¼‚å¸¸æƒ…å†µçš„å¤„ç†ã€‚ |
| Semaphore              | ä½¿ç”¨AQSåŒæ­¥çŠ¶æ€æ¥ä¿å­˜ä¿¡å·é‡çš„å½“å‰è®¡æ•°ã€‚tryReleaseä¼šå¢åŠ è®¡æ•°ï¼ŒacquireSharedä¼šå‡å°‘è®¡æ•°ã€‚ |
| CountDownLatch         | ä½¿ç”¨AQSåŒæ­¥çŠ¶æ€æ¥è¡¨ç¤ºè®¡æ•°ã€‚è®¡æ•°ä¸º0æ—¶ï¼Œæ‰€æœ‰çš„Acquireæ“ä½œï¼ˆCountDownLatchçš„awaitæ–¹æ³•ï¼‰æ‰å¯ä»¥é€šè¿‡ã€‚ |
| ReentrantReadWriteLock | ä½¿ç”¨AQSåŒæ­¥çŠ¶æ€ä¸­çš„16ä½ä¿å­˜å†™é”æŒæœ‰çš„æ¬¡æ•°ï¼Œå‰©ä¸‹çš„16ä½ç”¨äºä¿å­˜è¯»é”çš„æŒæœ‰æ¬¡æ•°ã€‚ |
| ThreadPoolExecutor     | Workeråˆ©ç”¨AQSåŒæ­¥çŠ¶æ€å®ç°å¯¹ç‹¬å çº¿ç¨‹å˜é‡çš„è®¾ç½®ï¼ˆtryAcquireå’ŒtryReleaseï¼‰ã€‚ |





### ReentrantLock  (ç»“åˆAQSçœ‹)



#### å¯é‡å…¥ç‰¹æ€§



> å¦‚ä½•å®ç°çš„å¯é‡å…¥æ€§ï¼Ÿ

`ReentrantLock`é‡å…¥é”ï¼Œæ˜¯å®ç°Lockæ¥å£çš„ä¸€ä¸ªç±»ï¼Œ**æ”¯æŒé‡å…¥æ€§ï¼Œè¡¨ç¤ºèƒ½å¤Ÿå¯¹å…±äº«èµ„æºèƒ½å¤Ÿé‡å¤åŠ é”ï¼Œå³å½“å‰çº¿ç¨‹è·å–è¯¥é”å†æ¬¡è·å–ä¸ä¼šè¢«é˜»å¡**ã€‚è¦æƒ³æ”¯æŒé‡å…¥æ€§ï¼Œå°±è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

1. åœ¨çº¿ç¨‹è·å–é”çš„æ—¶å€™ï¼Œå¦‚æœå·²ç»è·å–é”çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹çš„è¯åˆ™ç›´æ¥å†æ¬¡è·å–æˆåŠŸï¼›
2. ç”±äºé”ä¼šè¢«è·å–næ¬¡ï¼Œé‚£ä¹ˆåªæœ‰é”åœ¨è¢«é‡Šæ”¾åŒæ ·çš„næ¬¡ä¹‹åï¼Œè¯¥é”æ‰ç®—æ˜¯å®Œå…¨é‡Šæ”¾æˆåŠŸã€‚



æˆ‘ä»¬çŸ¥é“ï¼ŒåŒæ­¥ç»„ä»¶ä¸»è¦æ˜¯é€šè¿‡é‡å†™AQSçš„å‡ ä¸ªprotectedæ–¹æ³•æ¥è¡¨è¾¾è‡ªå·±çš„åŒæ­¥è¯­ä¹‰ã€‚é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹`ReentrantLock`æ˜¯æ€æ ·å®ç°çš„ï¼Œ**ä»¥éå…¬å¹³é”ä¸ºä¾‹(è¿™é‡Œåªæ˜¯ä¸ºäº†åˆ†æå¦‚ä½•å®ç°é”çš„å¯é‡å…¥ï¼Œè‡³äºå…¬å¹³/éå…¬å¹³å¦‚ä½•å®ç°ä¸‹é¢å†æåŠ)**ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹èƒ½å¦è·å¾—é”ä¸ºä¾‹ï¼Œæ ¸å¿ƒæ–¹æ³•ä¸º`nonfairTryAcquire`ï¼š

```java
final boolean nonfairTryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();  //è¿™é‡Œçš„stateä¸º0æ—¶ï¼Œè¡¨ç¤ºé”æœªè¢«å ç”¨
    //1. å¦‚æœè¯¥é”æœªè¢«ä»»ä½•çº¿ç¨‹å æœ‰ï¼Œè¯¥é”èƒ½è¢«å½“å‰çº¿ç¨‹è·å–
	if (c == 0) {
        if (compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
	//2.è‹¥è¢«å æœ‰ï¼Œæ£€æŸ¥å æœ‰çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹
    else if (current == getExclusiveOwnerThread()) {
		// 3. å†æ¬¡è·å–ï¼Œè®¡æ•°åŠ ä¸€
        int nextc = c + acquires;
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

> å¯¹äº `c == 0` çš„åˆ¤æ–­ï¼Œå®ƒè¡¨ç¤ºå½“å‰åŒæ­¥å™¨çš„çŠ¶æ€ä¸º0ï¼Œå³å½“å‰é”æœªè¢«ä»»ä½•çº¿ç¨‹å æœ‰(**ç›¸å½“äºé”çš„è®¡æ•°å™¨**)ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°è¯•è·å–é”ï¼Œå³å°†é”çŠ¶æ€ä»0ä¿®æ”¹ä¸ºacquiresï¼ˆè¡¨ç¤ºè·å¾—é”çš„è®¡æ•°ï¼‰ã€‚å¦‚æœ `compareAndSetState(0, acquires)` æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹æˆåŠŸè·å–äº†é”ï¼Œç„¶åä¼šå°†é”çš„æ‹¥æœ‰è€…è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼ˆ`setExclusiveOwnerThread(current)`ï¼‰ï¼Œæœ€åè¿”å› true è¡¨ç¤ºè·å–æˆåŠŸã€‚

ä¸ºäº†æ”¯æŒé‡å…¥æ€§ï¼Œåœ¨ç¬¬äºŒæ­¥å¢åŠ äº†å¤„ç†é€»è¾‘ï¼Œå¦‚æœè¯¥é”å·²ç»è¢«çº¿ç¨‹æ‰€å æœ‰äº†ï¼Œä¼šç»§ç»­æ£€æŸ¥å æœ‰çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒåŒæ­¥çŠ¶æ€åŠ 1è¿”å›trueï¼Œè¡¨ç¤ºå¯ä»¥å†æ¬¡è·å–æˆåŠŸã€‚æ¯æ¬¡é‡æ–°è·å–éƒ½ä¼šå¯¹åŒæ­¥çŠ¶æ€è¿›è¡ŒåŠ ä¸€çš„æ“ä½œï¼Œé‚£ä¹ˆé‡Šæ”¾çš„æ—¶å€™å¤„ç†æ€è·¯æ˜¯æ€æ ·çš„äº†ï¼Ÿï¼ˆä¾ç„¶è¿˜æ˜¯ä»¥éå…¬å¹³é”ä¸ºä¾‹ï¼‰æ ¸å¿ƒæ–¹æ³•ä¸º`tryRelease`ï¼š

```java
protected final boolean tryRelease(int releases) {
	//1. åŒæ­¥çŠ¶æ€å‡1
    int c = getState() - releases;
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    if (c == 0) {
		//2. åªæœ‰å½“åŒæ­¥çŠ¶æ€ä¸º0æ—¶ï¼Œé”æˆåŠŸè¢«é‡Šæ”¾ï¼Œè¿”å›true
        free = true;
        setExclusiveOwnerThread(null);
    }
	// 3. é”æœªè¢«å®Œå…¨é‡Šæ”¾ï¼Œè¿”å›false
    setState(c);
    return free;
}

```

ä»£ç çš„é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡å…¥é”çš„é‡Šæ”¾å¿…é¡»å¾—ç­‰åˆ°åŒæ­¥çŠ¶æ€ä¸º0æ—¶é”æ‰ç®—æˆåŠŸé‡Šæ”¾ï¼Œå¦åˆ™é”ä»æœªé‡Šæ”¾ã€‚å¦‚æœé”è¢«è·å–næ¬¡ï¼Œé‡Šæ”¾äº†n-1æ¬¡ï¼Œè¯¥é”æœªå®Œå…¨é‡Šæ”¾è¿”å›falseï¼Œåªæœ‰è¢«é‡Šæ”¾næ¬¡æ‰ç®—æˆåŠŸé‡Šæ”¾ï¼Œè¿”å›trueã€‚åˆ°ç°åœ¨æˆ‘ä»¬å¯ä»¥ç†æ¸…`ReentrantLock`é‡å…¥æ€§çš„å®ç°äº†ï¼Œä¹Ÿå°±æ˜¯ç†è§£äº†åŒæ­¥è¯­ä¹‰çš„ç¬¬ä¸€æ¡ã€‚





####  Fair/NonFair



> å¦‚ä½•å®ç°çš„å…¬å¹³/éå…¬å¹³ï¼Ÿ

`ReentrantLock`æ”¯æŒä¸¤ç§é”ï¼š**å…¬å¹³é”**å’Œ**éå…¬å¹³é”**ã€‚**ä½•è°“å…¬å¹³æ€§ï¼Œæ˜¯é’ˆå¯¹è·å–é”è€Œè¨€çš„ï¼Œå¦‚æœä¸€ä¸ªé”æ˜¯å…¬å¹³çš„ï¼Œé‚£ä¹ˆé”çš„è·å–é¡ºåºå°±åº”è¯¥ç¬¦åˆè¯·æ±‚ä¸Šçš„ç»å¯¹æ—¶é—´é¡ºåºï¼Œæ»¡è¶³FIFO**ã€‚`ReentrantLock`çš„æ„é€ æ–¹æ³•æ— å‚æ—¶æ˜¯æ„é€ éå…¬å¹³é”ï¼Œæºç ä¸ºï¼š

```java
public ReentrantLock() {
    sync = new NonfairSync();
}
```

å¦å¤–è¿˜æä¾›äº†å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå¯ä¼ å…¥ä¸€ä¸ªbooleanå€¼ï¼Œtrueæ—¶ä¸ºå…¬å¹³é”ï¼Œfalseæ—¶ä¸ºéå…¬å¹³é”ï¼Œæºç ä¸ºï¼š

```java
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

å¯ä»¥çœ‹å‡ºæ¥å®ç°éå…¬å¹³/å…¬å¹³éœ€è¦å€ŸåŠ©`FairSync`ç±»å’Œ`NonfairSync`ç±»æ¥å®ç°ï¼š



(1)æˆ‘ä»¬æ¥çœ‹çœ‹å…¬å¹³é”`FairSync`ç±»ä¸­çš„å¤„ç†é€»è¾‘æ˜¯æ€æ ·çš„ï¼Œæ ¸å¿ƒæ–¹æ³•ä¸ºï¼š

```java
protected final boolean tryAcquire(int acquires) {
    final Thread current = Thread.currentThread();
    int c = getState();
    if (c == 0) {
        if (!hasQueuedPredecessors() &&
            compareAndSetState(0, acquires)) {
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires;
        if (nextc < 0)
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
}
```

è¿™æ®µä»£ç çš„é€»è¾‘ä¸`nonfairTryAcquire`åŸºæœ¬ä¸Šä¸€ç›´ï¼Œå”¯ä¸€çš„ä¸åŒåœ¨äºå¢åŠ äº†`hasQueuedPredecessors`çš„é€»è¾‘åˆ¤æ–­ï¼Œæ–¹æ³•åå°±å¯çŸ¥é“è¯¥æ–¹æ³•ç”¨æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå¦‚æœæœ‰å‰é©±èŠ‚ç‚¹è¯´æ˜æœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ›´æ—©çš„è¯·æ±‚èµ„æºï¼Œæ ¹æ®å…¬å¹³æ€§ï¼Œå½“å‰çº¿ç¨‹è¯·æ±‚èµ„æºå¤±è´¥ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹æ²¡æœ‰å‰é©±èŠ‚ç‚¹çš„è¯ï¼Œå†æ‰æœ‰åšåé¢çš„é€»è¾‘åˆ¤æ–­çš„å¿…è¦æ€§ã€‚

å³**å…¬å¹³é”æ¯æ¬¡éƒ½æ˜¯ä»åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è·å–åˆ°é”ï¼Œè€Œéå…¬å¹³æ€§é”åˆ™ä¸ä¸€å®šï¼Œæœ‰å¯èƒ½åˆšé‡Šæ”¾é”çš„çº¿ç¨‹èƒ½å†æ¬¡è·å–åˆ°é”**ã€‚



å†æ¥çœ‹çœ‹æ–°ç‰ˆæœ¬jdkä¸­å¦‚ä½•å®ç°é”è·å–çš„å…¬å¹³/éå…¬å¹³

1. `FairSync`

```java
protected final boolean tryAcquire(int acquires) {
            if (getState() == 0 && !hasQueuedPredecessors() &&
                compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }
```



2. `NonfairSync`

```java
 protected final boolean tryAcquire(int acquires) {
            if (getState() == 0 && compareAndSetState(0, acquires)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }
```

  





#### åŠ é”/è§£é”

å…ˆæ¥çœ‹çœ‹`NonFair`ç±»ä¸­å¦‚ä½•å®ç°åŠ é”çš„ï¼š

```java
// java.util.concurrent.locks.ReentrantLock#NonfairSync

// éå…¬å¹³é”
static final class NonfairSync extends Sync {
	...
	final void lock() {
		if (compareAndSetState(0, 1))
			setExclusiveOwnerThread(Thread.currentThread());
		else
			acquire(1);
		}
  ...
}
```

è¿™å—ä»£ç çš„å«ä¹‰ä¸ºï¼š

- è‹¥é€šè¿‡CASè®¾ç½®å˜é‡Stateï¼ˆåŒæ­¥çŠ¶æ€ï¼‰æˆåŠŸï¼Œä¹Ÿå°±æ˜¯è·å–é”æˆåŠŸï¼Œåˆ™å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºç‹¬å çº¿ç¨‹ã€‚
- è‹¥é€šè¿‡CASè®¾ç½®å˜é‡Stateï¼ˆåŒæ­¥çŠ¶æ€ï¼‰å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è·å–é”å¤±è´¥ï¼Œåˆ™è¿›å…¥Acquireæ–¹æ³•è¿›è¡Œåç»­å¤„ç†ã€‚

ç¬¬ä¸€æ­¥å¾ˆå¥½ç†è§£ï¼Œä½†ç¬¬äºŒæ­¥è·å–é”å¤±è´¥åï¼Œåç»­çš„å¤„ç†ç­–ç•¥æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™å—å¯èƒ½ä¼šæœ‰ä»¥ä¸‹æ€è€ƒï¼š

- æŸä¸ªçº¿ç¨‹è·å–é”å¤±è´¥çš„åç»­æµç¨‹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæœ‰ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š

(1) å°†å½“å‰çº¿ç¨‹è·é”ç»“æœè®¾ç½®ä¸ºå¤±è´¥ï¼Œè·å–é”æµç¨‹ç»“æŸã€‚è¿™ç§è®¾è®¡ä¼šæå¤§é™ä½ç³»ç»Ÿçš„å¹¶å‘åº¦ï¼Œå¹¶ä¸æ»¡è¶³æˆ‘ä»¬å®é™…çš„éœ€æ±‚ã€‚æ‰€ä»¥å°±éœ€è¦ä¸‹é¢è¿™ç§æµç¨‹ï¼Œä¹Ÿå°±æ˜¯AQSæ¡†æ¶çš„å¤„ç†æµç¨‹ã€‚

(2) å­˜åœ¨æŸç§æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œçº¿ç¨‹ç»§ç»­ç­‰å¾…ï¼Œä»ç„¶ä¿ç•™è·å–é”çš„å¯èƒ½ï¼Œè·å–é”æµç¨‹ä»åœ¨ç»§ç»­ã€‚

- å¯¹äºé—®é¢˜1çš„ç¬¬äºŒç§æƒ…å†µï¼Œæ—¢ç„¶è¯´åˆ°äº†æ’é˜Ÿç­‰å€™æœºåˆ¶ï¼Œé‚£ä¹ˆå°±ä¸€å®šä¼šæœ‰æŸç§é˜Ÿåˆ—å½¢æˆï¼Œè¿™æ ·çš„é˜Ÿåˆ—æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„å‘¢ï¼Ÿ
- å¤„äºæ’é˜Ÿç­‰å€™æœºåˆ¶ä¸­çš„çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥æœ‰æœºä¼šè·å–é”å‘¢ï¼Ÿ
- å¦‚æœå¤„äºæ’é˜Ÿç­‰å€™æœºåˆ¶ä¸­çš„çº¿ç¨‹ä¸€ç›´æ— æ³•è·å–é”ï¼Œè¿˜æ˜¯éœ€è¦ä¸€ç›´ç­‰å¾…å—ï¼Œè¿˜æ˜¯æœ‰åˆ«çš„ç­–ç•¥æ¥è§£å†³è¿™ä¸€é—®é¢˜?

ç€éå…¬å¹³é”çš„è¿™äº›é—®é¢˜ï¼Œå†çœ‹ä¸‹å…¬å¹³é”æºç ä¸­è·é”çš„æ–¹å¼ï¼š

```java
// java.util.concurrent.locks.ReentrantLock#FairSync

static final class FairSync extends Sync {
  ...  
	final void lock() {
		acquire(1);
	}
  ...
}
```

çœ‹åˆ°è¿™å—ä»£ç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå­˜åœ¨è¿™ç§ç–‘é—®ï¼šLockå‡½æ•°é€šè¿‡Acquireæ–¹æ³•è¿›è¡ŒåŠ é”ï¼Œä½†æ˜¯å…·ä½“æ˜¯å¦‚ä½•åŠ é”çš„å‘¢ï¼Ÿ

ç»“åˆå…¬å¹³é”å’Œéå…¬å¹³é”çš„åŠ é”æµç¨‹ï¼Œè™½ç„¶æµç¨‹ä¸Šæœ‰ä¸€å®šçš„ä¸åŒï¼Œä½†æ˜¯éƒ½è°ƒç”¨äº†Acquireæ–¹æ³•ï¼Œè€ŒAcquireæ–¹æ³•æ˜¯FairSyncå’ŒUnfairSyncçš„çˆ¶ç±»AQSä¸­çš„æ ¸å¿ƒæ–¹æ³•ã€‚

å¯¹äºä¸Šè¾¹æåˆ°çš„é—®é¢˜ï¼Œå…¶å®åœ¨`ReentrantLock`ç±»æºç ä¸­éƒ½æ— æ³•è§£ç­”ï¼Œè€Œè¿™äº›é—®é¢˜çš„ç­”æ¡ˆï¼Œéƒ½æ˜¯ä½äºAcquireæ–¹æ³•æ‰€åœ¨çš„ç±»`AbstractQueuedSynchronizer`ä¸­



ä¸ºäº†å¸®åŠ©å¤§å®¶ç†è§£ReentrantLockå’ŒAQSä¹‹é—´æ–¹æ³•çš„äº¤äº’è¿‡ç¨‹ï¼Œä»¥éå…¬å¹³é”ä¸ºä¾‹ï¼Œæˆ‘ä»¬å°†åŠ é”å’Œè§£é”çš„äº¤äº’æµç¨‹å•ç‹¬æ‹å‡ºæ¥å¼ºè°ƒä¸€ä¸‹ï¼Œä»¥ä¾¿äºå¯¹åç»­å†…å®¹çš„ç†è§£ï¼š

åŠ é”ï¼š

- é€šè¿‡ReentrantLockçš„åŠ é”æ–¹æ³•Lockè¿›è¡ŒåŠ é”æ“ä½œã€‚
- ä¼šè°ƒç”¨åˆ°å†…éƒ¨ç±»Syncçš„Lockæ–¹æ³•ï¼Œç”±äºSync#lockæ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ ¹æ®ReentrantLockåˆå§‹åŒ–é€‰æ‹©çš„å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œæ‰§è¡Œç›¸å…³å†…éƒ¨ç±»çš„Lockæ–¹æ³•ï¼Œæœ¬è´¨ä¸Šéƒ½ä¼šæ‰§è¡ŒAQSçš„Acquireæ–¹æ³•ã€‚
- AQSçš„Acquireæ–¹æ³•ä¼šæ‰§è¡ŒtryAcquireæ–¹æ³•ï¼Œä½†æ˜¯ç”±äºtryAcquireéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°ï¼Œå› æ­¤æ‰§è¡Œäº†ReentrantLockä¸­çš„tryAcquireæ–¹æ³•ï¼Œç”±äºReentrantLockæ˜¯é€šè¿‡å…¬å¹³é”å’Œéå…¬å¹³é”å†…éƒ¨ç±»å®ç°çš„tryAcquireæ–¹æ³•ï¼Œå› æ­¤ä¼šæ ¹æ®é”ç±»å‹ä¸åŒï¼Œæ‰§è¡Œä¸åŒçš„tryAcquireã€‚
- tryAcquireæ˜¯è·å–é”é€»è¾‘ï¼Œè·å–å¤±è´¥åï¼Œä¼šæ‰§è¡Œæ¡†æ¶AQSçš„åç»­é€»è¾‘ï¼Œè·ŸReentrantLockè‡ªå®šä¹‰åŒæ­¥å™¨æ— å…³ã€‚

è§£é”ï¼š

- é€šè¿‡ReentrantLockçš„è§£é”æ–¹æ³•Unlockè¿›è¡Œè§£é”ã€‚
- Unlockä¼šè°ƒç”¨å†…éƒ¨ç±»Syncçš„Releaseæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç»§æ‰¿äºAQSã€‚
- Releaseä¸­ä¼šè°ƒç”¨tryReleaseæ–¹æ³•ï¼ŒtryReleaseéœ€è¦è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°ï¼ŒtryReleaseåªåœ¨ReentrantLockä¸­çš„Syncå®ç°ï¼Œå› æ­¤å¯ä»¥çœ‹å‡ºï¼Œé‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œå¹¶ä¸åŒºåˆ†æ˜¯å¦ä¸ºå…¬å¹³é”ã€‚
- é‡Šæ”¾æˆåŠŸåï¼Œæ‰€æœ‰å¤„ç†ç”±AQSæ¡†æ¶å®Œæˆï¼Œä¸è‡ªå®šä¹‰åŒæ­¥å™¨æ— å…³ã€‚







**æ€»ç»“ï¼š**

æ— è®ºæ˜¯å…¬å¹³oréå…¬å¹³é”ï¼Œå‡è¦å…ˆåˆ¤æ–­stateçš„çŠ¶æ€æ˜¯å¦ä¸º0(ä¸º0è¯´æ˜é”å¯ä»¥è·å–)ï¼Œä¸åŒçš„æ˜¯å…¬å¹³é”éœ€è¦åˆ¤æ–­**è¯¥çº¿ç¨‹åœ¨CLHç­‰å¾…é˜Ÿåˆ—ä¸­å¯¹åº”çš„NodeèŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹**ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å‰é©±èŠ‚ç‚¹è¯´æ˜ä¸ºç¬¬ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹ï¼Œæ­¤æ—¶å¯ä»¥CASå°è¯•è·å–é”ï¼Œè€Œéå…¬å¹³å°±æ²¡æœ‰è¿™ä¸ªé™åˆ¶äº†ï¼Œè¿›å…¥CLHé˜Ÿåˆ—çš„çº¿ç¨‹æ— éœ€æ’é˜Ÿç›´æ¥é€šè¿‡CASè‡ªæ—‹ä¸æ–­å°è¯•è·å–é”







#### ä¸Synchronizedå¼‚åŒ

`ReentrantLock` å®ç°äº† `Lock` æ¥å£ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥ä¸”ç‹¬å å¼çš„é”ï¼Œ`ReentrantLock` é‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±» `Sync`ï¼Œ`Sync` ç»§æ‰¿ **AQS**ï¼ˆ`AbstractQueuedSynchronizer`ï¼‰ï¼Œæ·»åŠ é”å’Œé‡Šæ”¾é”çš„å¤§éƒ¨åˆ†æ“ä½œå®é™…ä¸Šéƒ½æ˜¯åœ¨ `Sync` ä¸­å®ç°çš„ã€‚`Sync` æœ‰å…¬å¹³é” `FairSync` å’Œéå…¬å¹³é” `NonfairSync` ä¸¤ä¸ªå­ç±»ï¼Œå®ƒä¸`synchronized`çš„åŒºåˆ«ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1. `synchronized` æ˜¯ä¾èµ–äº JVM å®ç°çš„ï¼ŒJDK1.6ä¸º `synchronized` å…³é”®å­—è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–(åå‘é”ã€è½»é‡çº§é”ã€é€‚åº”æ€§è‡ªæ—‹é” é”æ¶ˆé™¤ã€é”ç²—åŒ–)ï¼Œä½†æ˜¯è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åœ¨è™šæ‹Ÿæœºå±‚é¢å®ç°çš„ï¼Œå¹¶æ²¡æœ‰ç›´æ¥æš´éœ²ç»™ç”¨æˆ·

   `ReentrantLock` æ˜¯ JDK å±‚é¢å®ç°çš„ï¼ˆä¹Ÿå°±æ˜¯ API å±‚é¢ï¼Œéœ€è¦ lock() å’Œ unlock() æ–¹æ³•é…åˆ try/finally è¯­å¥å—æ¥å®Œæˆï¼‰

2. åŠ é”é¡ºåºä¸åŒ:å¯¹äº Lock è€Œè¨€å¦‚æœæœ‰å¤šæŠŠ Lock é”ï¼ŒLock å¯ä»¥ä¸å®Œå…¨æŒ‰ç…§åŠ é”çš„ååºè§£é”ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥å…ˆè·å– Lock1 é”ï¼Œå†è·å– Lock2 é”ï¼Œè§£é”æ—¶åˆ™å…ˆè§£é” Lock1ï¼Œå†è§£é” Lock2ï¼ŒåŠ è§£é”æœ‰ä¸€å®šçš„çµæ´»åº¦

   ```java
   lock1.lock();
   
   lock2.lock();
   
   ...
   
   lock1.unlock();
   
   lock2.unlock();
   ```

   è€Œ`synchronized` è§£é”çš„é¡ºåºå’ŒåŠ é”çš„é¡ºåºå¿…é¡»å®Œå…¨ç›¸åï¼Œä¾‹å¦‚ï¼š

   ```java
   synchronized(obj1){
   
       synchronized(obj2){
   
           ...
   
       }
   
   }
   ```

   é¡ºåºå°±æ˜¯å…ˆå¯¹ obj1 åŠ é”ï¼Œç„¶åå¯¹ obj2 åŠ é”ï¼Œç„¶åå¯¹ obj2 è§£é”ï¼Œæœ€åè§£é” obj1ã€‚è¿™æ˜¯å› ä¸º synchronized åŠ è§£é”æ˜¯ç”± JVM å®ç°çš„ï¼Œåœ¨æ‰§è¡Œå®Œ synchronized å—åä¼šè‡ªåŠ¨è§£é”ï¼Œæ‰€ä»¥ä¼šæŒ‰ç…§ synchronized çš„åµŒå¥—é¡ºåºåŠ è§£é”ï¼Œä¸èƒ½è‡ªè¡Œæ§åˆ¶

3. **æ˜¯å¦å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯é€šè¿‡`ReentrantLock`ç±»çš„`ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥å†³å®šæ˜¯å¦æ˜¯å…¬å¹³çš„

   ```java
     public ReentrantLock(boolean fair) {
           sync = fair ? new FairSync() : new NonfairSync();
       }  
   //ä¼ å…¥trueåˆ™è°ƒç”¨å…¬å¹³é”æ–¹æ³•ã€falseåˆ™è°ƒç”¨éå…¬å¹³é”æ–¹æ³•
   ```

4. ç­‰å¾…å¯ä¸­æ–­ï¼š`ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ï¼Œæ”¹ä¸ºå¤„ç†å…¶ä»–äº‹æƒ…ï¼Œå³`ReentrantLock`æ˜¯å¯ä¸­æ–­çš„ï¼Œè€Œ`synchronized` é”è¢«æŸä¸ªçº¿ç¨‹è·å¾—åï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹å¦‚æœè¿˜æƒ³è·å¾—ï¼Œé‚£å®ƒåªèƒ½è¢«**é˜»å¡**ï¼Œç›´åˆ°æŒæœ‰é”çš„çº¿ç¨‹è¿è¡Œå®Œæ¯•æˆ–è€…å‘ç”Ÿå¼‚å¸¸ä»è€Œé‡Šæ”¾è¿™ä¸ªé”















### ReentrantReadWriteLock



ä½¿ç”¨`ReentrantReadWriteLock`è¯»å†™é”çš„æ–¹å¼ï¼Œä¼šè°ƒç”¨`readLock()`å’Œ`writeLock()`ä¸¤ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸‹ä»–ä»¬çš„æºç ï¼š



ReadLock:

```java
public static class ReadLock implements Lock, java.io.Serializable {
    private static final long serialVersionUID = -5992448646407690164L;
    private final Sync sync; //ç»§æ‰¿äº†AQSç±»


    public void lock() {
        sync.acquireShared(1);  //AQSä¸­çš„å…±äº«æ¨¡å¼
    }
    
        public void unlock() {
        sync.releaseShared(1); //å…±äº«
    }
}       
```













WriteLock:

```java
public static class WriteLock implements Lock, java.io.Serializable {
    private static final long serialVersionUID = -4992448646407690164L;
    private final Sync sync;

    public void lock() {
        sync.acquire(1);  //AQSä¸­çš„äº’æ–¥æ¨¡å¼
    }
    
     public void unlock() {
        sync.release(1); //ç‹¬å 
    }
    
}
```

å®ç°å†™é”çš„åŒæ­¥è¯­ä¹‰æ˜¯é€šè¿‡é‡å†™AQSä¸­çš„tryAcquireæ–¹æ³•å®ç°çš„ã€‚æºç ä¸º:

```java
protected final boolean tryAcquire(int acquires) {
    Thread current = Thread.currentThread();
	// 1. è·å–å†™é”å½“å‰çš„åŒæ­¥çŠ¶æ€
    int c = getState();
	// 2. è·å–å†™é”è·å–çš„æ¬¡æ•°
    int w = exclusiveCount(c);
    if (c != 0) {
        // (Note: if c != 0 and w == 0 then shared count != 0)
		// 3.1 å½“è¯»é”å·²è¢«è¯»çº¿ç¨‹è·å–æˆ–è€…å½“å‰çº¿ç¨‹ä¸æ˜¯å·²ç»è·å–å†™é”çš„çº¿ç¨‹çš„è¯
		// å½“å‰çº¿ç¨‹è·å–å†™é”å¤±è´¥
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        if (w + exclusiveCount(acquires) > MAX_COUNT)
            throw new Error("Maximum lock count exceeded");
        // Reentrant acquire
		// 3.2 å½“å‰çº¿ç¨‹è·å–å†™é”ï¼Œæ”¯æŒå¯é‡å¤åŠ é”
        setState(c + acquires);
        return true;
    }
	// 3.3 å†™é”æœªè¢«ä»»ä½•çº¿ç¨‹è·å–ï¼Œå½“å‰çº¿ç¨‹å¯è·å–å†™é”
    if (writerShouldBlock() ||
        !compareAndSetState(c, c + acquires))
        return false;
    setExclusiveOwnerThread(current);
    return true;
}

```

å†™é”é‡Šæ”¾é€šè¿‡é‡å†™AQSçš„tryReleaseæ–¹æ³•ï¼Œæºç ä¸ºï¼š

```java
protected final boolean tryRelease(int releases) {
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
	//1. åŒæ­¥çŠ¶æ€å‡å»å†™çŠ¶æ€
    int nextc = getState() - releases;
	//2. å½“å‰å†™çŠ¶æ€æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™é‡Šæ”¾å†™é”
    boolean free = exclusiveCount(nextc) == 0;
    if (free)
        setExclusiveOwnerThread(null);
	//3. ä¸ä¸º0åˆ™æ›´æ–°åŒæ­¥çŠ¶æ€
    setState(nextc);
    return free;
}
```

æºç çš„å®ç°é€»è¾‘è¯·çœ‹æ³¨é‡Šï¼Œä¸éš¾ç†è§£ä¸ReentrantLockåŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡å°‘å†™çŠ¶æ€` int nextc = getState() - releases;`åªéœ€è¦ç”¨**å½“å‰åŒæ­¥çŠ¶æ€ç›´æ¥å‡å»å†™çŠ¶æ€çš„åŸå› æ­£æ˜¯æˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„å†™çŠ¶æ€æ˜¯ç”±åŒæ­¥çŠ¶æ€çš„ä½16ä½è¡¨ç¤ºçš„**ã€‚







çœ‹åˆ°è¿™é‡Œå‘ç°äº†ReentrantReadWriteLockå’ŒReentrantLockçš„ä¸€ä¸ªç›¸åŒç‚¹å’Œä¸åŒç‚¹ï¼Œ**ç›¸åŒçš„æ˜¯ä½¿ç”¨äº†åŒä¸€ä¸ªå…³é”®å®ç°AbstractQueuedSynchronizerï¼Œä¸åŒçš„æ˜¯ReentrantReadWriteLockä½¿ç”¨äº†ä¸¤ä¸ªé”åˆ†åˆ«å®ç°äº†AQSï¼Œè€Œä¸”WriteLockå’ŒReentrantLockä¸€æ ·ï¼Œä½¿ç”¨äº†ç‹¬å é”ã€‚è€ŒReadLockå’ŒSemaphoreä¸€æ ·ï¼Œä½¿ç”¨äº†å…±äº«é”**ã€‚å†å¾€ä¸‹çš„å†…å®¹ä¼°è®¡çœ‹è¿‡å‰é¢å‡ ç¯‡æ–‡ç« çš„éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œç‹¬å é”é€šè¿‡stateå˜é‡çš„0å’Œ1ä¸¤ä¸ªçŠ¶æ€æ¥æ§åˆ¶æ˜¯å¦æœ‰çº¿ç¨‹å æœ‰é”ï¼Œå…±äº«é”é€šè¿‡stateå˜é‡0æˆ–è€…é0æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹è®¿é—®ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒReadLockå’ŒWriteLockä½¿ç”¨äº†åŒä¸€ä¸ªAQSï¼Œé‚£ä¹ˆåœ¨ReentrantReadWriteLockä¸­åˆæ˜¯æ€ä¹ˆæ§åˆ¶è¯»é”å’Œå†™é”å…³ç³»çš„å‘¢ï¼Ÿ





#### è®¾è®¡StateçŠ¶æ€å˜é‡

è¯»å†™é”åŒæ ·ä¾èµ–è‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°åŒæ­¥åŠŸèƒ½ï¼Œè€Œè¯»å†™çŠ¶æ€å°±æ˜¯å…¶åŒæ­¥å™¨çš„åŒæ­¥çŠ¶æ€ã€‚å›æƒ³ReentrantLockä¸­è‡ªå®šä¹‰åŒæ­¥å™¨çš„å®ç°ï¼ŒåŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œè¯»å†™é”çš„è‡ªå®šä¹‰åŒæ­¥å™¨éœ€è¦åœ¨åŒæ­¥çŠ¶æ€ï¼ˆä¸€ä¸ªæ•´å‹å˜é‡ï¼‰ä¸Šç»´æŠ¤å¤šä¸ªè¯»çº¿ç¨‹å’Œä¸€ä¸ªå†™çº¿ç¨‹çš„çŠ¶æ€ï¼Œä½¿å¾—è¯¥çŠ¶æ€çš„è®¾è®¡æˆä¸ºè¯»å†™é”å®ç°çš„å…³é”®ã€‚å¦‚æœåœ¨ä¸€ä¸ª**æ•´å‹å˜é‡**ä¸Šç»´æŠ¤å¤šç§çŠ¶æ€ï¼Œå°±ä¸€å®šéœ€è¦â€œæŒ‰ä½åˆ‡å‰²ä½¿ç”¨â€è¿™ä¸ªå˜é‡ï¼Œè¯»å†™é”å°†å˜é‡åˆ‡åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œé«˜16ä½è¡¨ç¤ºè¯»ï¼Œä½16ä½è¡¨ç¤ºå†™ï¼Œåˆ’åˆ†æ–¹å¼å¦‚ä¸‹å›¾æ‰€ç¤º:

<img src="https://img-blog.csdn.net/20170521115701777?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZnV5dXdlaTIwMTU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="è¯»å†™é”çŠ¶æ€" style="zoom:67%;" />

å½“å‰åŒæ­¥çŠ¶æ€è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹å·²ç»è·å–äº†å†™é”ï¼Œä¸”é‡è¿›å…¥äº†ä¸¤æ¬¡ï¼ŒåŒæ—¶ä¹Ÿè¿ç»­è·å–äº†ä¸¤æ¬¡è¯»é”ã€‚è¯»å†™é”æ˜¯å¦‚ä½•è¿…é€Ÿç¡®å®šè¯»å’Œå†™å„è‡ªçš„çŠ¶æ€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡ä½è¿ç®—ã€‚å‡è®¾å½“å‰åŒæ­¥çŠ¶æ€å€¼ä¸ºSï¼Œå†™çŠ¶æ€ç­‰äºS&0x0000FFFFï¼ˆå°†é«˜16ä½å…¨éƒ¨æŠ¹å»ï¼‰ï¼Œè¯»çŠ¶æ€ç­‰äºS>>>16ï¼ˆæ— ç¬¦å·è¡¥0å³ç§»16ä½ï¼‰ã€‚å½“å†™çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+1ï¼Œå½“è¯»çŠ¶æ€å¢åŠ 1æ—¶ï¼Œç­‰äºS+(1<<16)ï¼Œä¹Ÿå°±æ˜¯S+0x00010000ã€‚

æ ¹æ®çŠ¶æ€çš„åˆ’åˆ†èƒ½å¾—å‡ºä¸€ä¸ªæ¨è®ºï¼š**Sä¸ç­‰äº0æ—¶ï¼Œå½“å†™çŠ¶æ€ï¼ˆS&0x0000FFFFï¼‰ç­‰äº0æ—¶ï¼Œåˆ™è¯»çŠ¶æ€ï¼ˆS>>>16ï¼‰å¤§äº0ï¼Œå³è¯»é”å·²è¢«è·å–**







#### é”å‡çº§/é™çº§

1ã€é”é™çº§

é”é™çº§æŒ‡çš„æ˜¯å†™é”é™çº§æˆä¸ºè¯»é”ã€‚å¦‚æœå½“å‰çº¿ç¨‹æ‹¥æœ‰å†™é”ï¼Œç„¶åå°†å…¶é‡Šæ”¾ï¼Œæœ€åå†è·å–è¯»é”ï¼Œè¿™ç§åˆ†æ®µå®Œæˆçš„è¿‡ç¨‹ä¸èƒ½ç§°ä¹‹ä¸ºé”é™çº§ã€‚**é”é™çº§æ˜¯æŒ‡æŠŠæŒä½ï¼ˆå½“å‰æ‹¥æœ‰çš„ï¼‰å†™é”ï¼Œå†è·å–åˆ°è¯»é”ï¼Œéšåé‡Šæ”¾ï¼ˆå…ˆå‰æ‹¥æœ‰çš„ï¼‰å†™é”çš„è¿‡ç¨‹ã€‚**

> è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œå¦‚æœå½“å‰çº¿ç¨‹åœ¨æŒæœ‰å†™é”çš„å‰æä¸‹ï¼šä¸å…ˆè·å–è¯»é”è€Œç›´æ¥é‡Šæ”¾å†™é”ï¼Œå‡è®¾æ­¤åˆ»å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆTï¼‰è·å–äº†å†™é”å¹¶ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æ˜¯æ— æ³•æ„ŸçŸ¥çº¿ç¨‹Tçš„æ•°æ®æ›´æ–°ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–è¯»é”ï¼Œå³éµå¾ªé”é™çº§çš„æ­¥éª¤ï¼Œåˆ™çº¿ç¨‹Tå°†ä¼šè¢«é˜»å¡ï¼ŒçŸ¥é“å½“å‰çº¿ç¨‹ä½¿ç”¨æ•°æ®å¹¶é‡Šæ”¾è¯»é”ä¹‹åï¼Œçº¿ç¨‹Tæ‰èƒ½è·å–å†™é”è¿›è¡Œæ•°æ®æ›´æ–°ã€‚

è¯»å†™é”æ”¯æŒé”é™çº§ï¼Œ**éµå¾ªæŒ‰ç…§è·å–å†™é”ï¼Œè·å–è¯»é”å†é‡Šæ”¾å†™é”çš„æ¬¡åºï¼Œå†™é”èƒ½å¤Ÿé™çº§æˆä¸ºè¯»é”**ï¼Œä¸æ”¯æŒé”å‡çº§ï¼Œå…³äºé”é™çº§ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ‘˜è‡ªReentrantWriteReadLockæºç ä¸­ï¼š

```java
void processCachedData() {
    rwl.readLock().lock();
    if (!cacheValid) {
        // Must release read lock before acquiring write lock
        rwl.readLock().unlock();
        rwl.writeLock().lock();
        try {
            // Recheck state because another thread might have
            // acquired write lock and changed state before we did.
            if (!cacheValid) {
                data = ...
        cacheValid = true;
      }
      // Downgrade by acquiring read lock before releasing write lock
      rwl.readLock().lock();
    } finally {
      rwl.writeLock().unlock(); // Unlock write, still hold read
    }
  }

  try {
    use(data);
  } finally {
    rwl.readLock().unlock();
  }
}
```





2ã€é”å‡çº§

åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œåœ¨æ²¡æœ‰é‡Šæ”¾è¯»é”çš„æƒ…å†µä¸‹ï¼Œå°±å»ç”³è¯·å†™é”ï¼Œè¿™å±äºé”å‡çº§ï¼Œ`ReentrantReadWriteLock`æ˜¯ä¸æ”¯æŒçš„ã€‚ä¾‹å¦‚ä¸‹è¿°ä»£ç ä¼šäº§ç”Ÿæ­»é”:

```java
 ReadWriteLock rtLock = new ReentrantReadWriteLock();
 rtLock.readLock().lock(); //è·å–è¯»é”
 System.out.println("get readLock.");
 rtLock.writeLock().lock();//æœªé‡Šæ”¾è¯»é”çš„å‰æä¸‹å°±å»è·å–å†™é”
 System.out.println("blocking");
```



### StampedLock

https://segmentfault.com/a/1190000024540229



### Semaphore

`Synchronized` å’Œ `ReentrantLock(ç‹¬å æ¨¡å¼)` éƒ½æ˜¯ä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªèµ„æºï¼Œè€Œ`Semaphore`(ä¿¡å·é‡)å¯ä»¥ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡(å¤šä¸ªçº¿ç¨‹)ï¼Œå› æ­¤`Semaphore`æ˜¯`AQS`åœ¨`Share`å…±äº«æ¨¡å¼ä¸‹çš„å®ç°ï¼š

ä¸‹é¢ä»£ç è¡¨ç¤ºåŒä¸€æ—¶åˆ» N ä¸ªçº¿ç¨‹ä¸­åªæœ‰ 5 ä¸ªçº¿ç¨‹èƒ½è·å–åˆ°å…±äº«èµ„æºï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼Œåªæœ‰è·å–åˆ°å…±äº«èµ„æºçš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œï¼Œç­‰åˆ°æœ‰å…¶ä»–çº¿ç¨‹é‡Šæ”¾åï¼Œé˜»å¡çº¿ç¨‹æ‰èƒ½è·å–åˆ°å…±äº«èµ„æºï¼š

```java
// åˆå§‹è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹æ•°é‡
final Semaphore semaphore = new Semaphore(5);
// çº¿ç¨‹è·å–1ä¸ªè®¸å¯
semaphore.acquire();

//çº¿ç¨‹è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯
semaphore.acquire(int permits);


// çº¿ç¨‹é‡Šæ”¾1ä¸ªè®¸å¯
semaphore.release();
```

å½“åˆå§‹çš„èµ„æºä¸ªæ•°ä¸º 1 çš„æ—¶å€™ï¼Œ`Semaphore` é€€åŒ–ä¸ºæ’ä»–é”`Synchronized`



`Semaphore` æœ‰ä¸¤ç§æ¨¡å¼ï¼š

- **å…¬å¹³æ¨¡å¼ï¼š** è°ƒç”¨ `acquire()` æ–¹æ³•çš„é¡ºåºå°±æ˜¯è·å–è®¸å¯çš„é¡ºåºï¼Œéµå¾ª FIFOï¼›
- **éå…¬å¹³æ¨¡å¼ï¼š** æŠ¢å å¼è°ƒåº¦

`Semaphore` å…¶å¯¹åº”çš„ä¸¤ä¸ªæ„é€ æ–¹æ³•(**è¿™ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œéƒ½å¿…é¡»æä¾›è®¸å¯çš„æ•°é‡**)å¦‚ä¸‹ï¼š

```java
public Semaphore(int permits) {
  	sync = new NonfairSync(permits);
}

public Semaphore(int permits, boolean fair) {
  	sync = fair ? new FairSync(permits) : new NonfairSync(permits);
}
```



`Semaphore` æ˜¯å…±äº«é”çš„ä¸€ç§å®ç°ï¼Œå®ƒé»˜è®¤æ„é€  `AQS` çš„ `state` å€¼ä¸º `permits`ï¼Œå¯ä»¥å°† `permits` çš„å€¼ç†è§£ä¸ºè®¸å¯è¯çš„æ•°é‡ï¼Œåªæœ‰æ‹¿åˆ°è®¸å¯è¯çš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œæ“ä½œï¼Œæ¯”å¦‚ä¸‹åˆ—ä»£ç æ˜¯å®ç°`Fair`å…¬å¹³æ¨¡å¼(é»˜è®¤éå…¬å¹³)ä¸‹çš„`Semaphore`ï¼š

```java
//é»˜è®¤æ„é€ 
 public Semaphore(int permits) {
        sync = new NonfairSync(permits);
    }
//å…¬å¹³æ¨¡å¼
public Semaphore(int permits, boolean fair) {
        sync = fair ? new FairSync(permits) : new NonfairSync(permits);
    }

FairSync(int permits) {
            super(permits);
        }
Sync(int permits) {
            setState(permits);//è°ƒç”¨AQSä¸­çš„setState()
        }
protected final void setState(int newState) {
        state = newState;
    }
```



**è·å–è®¸å¯ï¼š**

è°ƒç”¨`semaphore.acquire()` ï¼Œçº¿ç¨‹å°è¯•è·å–è®¸å¯è¯ï¼Œå¦‚æœ `state >= 0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥è·å–æˆåŠŸã€‚å¦‚æœè·å–æˆåŠŸçš„è¯ï¼Œä½¿ç”¨ CAS æ“ä½œå»ä¿®æ”¹ `state` çš„å€¼ `state=state-1`ã€‚å¦‚æœ `state<0` çš„è¯ï¼Œåˆ™è¡¨ç¤ºè®¸å¯è¯æ•°é‡ä¸è¶³ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ª Node èŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹

```java
/**
 *  è·å–1ä¸ªè®¸å¯è¯
 */
public void acquire() throws InterruptedException {
 	 sync.acquireSharedInterruptibly(1);
}
/**
 * å…±äº«æ¨¡å¼ä¸‹è·å–è®¸å¯è¯ï¼Œè·å–æˆåŠŸåˆ™è¿”å›ï¼Œå¤±è´¥åˆ™åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹
 */
public final void acquireSharedInterruptibly(int arg)
    throws InterruptedException {
    if (Thread.interrupted())
      throw new InterruptedException();
        // å°è¯•è·å–è®¸å¯è¯ï¼Œargä¸ºè·å–è®¸å¯è¯ä¸ªæ•°ï¼Œå½“å¯ç”¨è®¸å¯è¯æ•°å‡å½“å‰è·å–çš„è®¸å¯è¯æ•°(æ­¤å¤„ä¸º1,å› ä¸ºåªæœ‰1ä¸ªçº¿ç¨‹)ç»“æœå°äº0æ—¶,åˆ™åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·å½“å‰çº¿ç¨‹ã€‚
    if (tryAcquireShared(arg) < 0)
      doAcquireSharedInterruptibly(arg);
}

```



**é‡Šæ”¾è®¸å¯ï¼š**

é€šè¿‡è°ƒç”¨`semaphore.release();` æ¥ä½¿çº¿ç¨‹å°è¯•é‡Šæ”¾è®¸å¯è¯ï¼Œå¹¶ä½¿ç”¨ CAS å»ä¿®æ”¹ `state` çš„å€¼ `state=state+1`ã€‚é‡Šæ”¾è®¸å¯è¯æˆåŠŸä¹‹åï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šé‡æ–°å°è¯•å»CASä¿®æ”¹ `state` çš„å€¼ `state=state-1` ï¼Œå¦‚æœ `state>=0` åˆ™è·å–ä»¤ç‰ŒæˆåŠŸï¼Œå¦åˆ™é‡æ–°è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‚èµ·çº¿ç¨‹ï¼š

```java
// é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯
public void release() {
  	sync.releaseShared(1);
}

// é‡Šæ”¾å…±äº«é”ï¼ŒåŒæ—¶ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹  
public final boolean releaseShared(int arg) {
    //é‡Šæ”¾å…±äº«é”
    if (tryReleaseShared(arg)) {
      //å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹
      doReleaseShared();
      return true;
    }
    return false;
}
//æ–°ç‰ˆæœ¬çš„releaseShared()
public final boolean releaseShared(int arg) {
        if (tryReleaseShared(arg)) {
            signalNext(head);
            return true;
        }
        return false;
    }

//ä»é˜»å¡é˜Ÿåˆ—ä¸­å”¤é†’headèŠ‚ç‚¹
private static void signalNext(Node h) {
        Node s;
        if (h != null && (s = h.next) != null && s.status != 0) {
            s.getAndUnsetStatus(WAITING);
            LockSupport.unpark(s.waiter);
        }
    }
```



ä¸‹é¢æ˜¯ä¸€ä¸ª`Semaphore`ä½¿ç”¨çš„ä¾‹å­:

é¦–å…ˆç”Ÿæˆä¸€ä¸ªä¿¡å·é‡ï¼Œè¯¥ä¿¡å·é‡æœ‰10ä¸ªè®¸å¯ï¼Œç„¶åï¼Œmainï¼Œt1ï¼Œt2ä¸‰ä¸ªçº¿ç¨‹è·å–è®¸å¯è¿è¡Œ

```java
import java.util.concurrent.Semaphore;

class MyThread extends Thread {
    private Semaphore semaphore;
    
    public MyThread(String name, Semaphore semaphore) {
        super(name);
        this.semaphore = semaphore;
    }
    
    public void run() {        
        int count = 3;
        System.out.println(Thread.currentThread().getName() + " trying to acquire");
        try {
            semaphore.acquire(count);
            System.out.println(Thread.currentThread().getName() + " acquire successfully");
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            semaphore.release(count);
            System.out.println(Thread.currentThread().getName() + " release successfully");
        }
    }
}

public class SemaphoreDemo {
    public final static int SEM_SIZE = 10;
    
    public static void main(String[] args) {
        Semaphore semaphore = new Semaphore(SEM_SIZE);
        MyThread t1 = new MyThread("t1", semaphore);
        MyThread t2 = new MyThread("t2", semaphore);
        t1.start();
        t2.start();
        int permits = 5;
        System.out.println(Thread.currentThread().getName() + " trying to acquire");
        try {
            semaphore.acquire(permits);
            System.out.println(Thread.currentThread().getName() + " acquire successfully");
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            semaphore.release();
            System.out.println(Thread.currentThread().getName() + " release successfully");
        }      
    }
}
```

è¾“å‡ºç»“æœä¸ºï¼š

```
main trying to acquire
main acquire successfully
t1 trying to acquire
t1 acquire successfully
t2 trying to acquire   //t2åœ¨ç”³è¯·è®¸å¯æ—¶æ•°é‡ä¸å¤Ÿç”¨äº†
t1 release successfully
main release successfully
t2 acquire successfully
t2 release successfully
```



é¦–å…ˆï¼Œ`main`çº¿ç¨‹æ‰§è¡Œ`acquire`æ“ä½œï¼Œå¹¶ä¸”æˆåŠŸè·å¾—è®¸å¯ï¼Œä¹‹åt1çº¿ç¨‹æ‰§è¡Œ`acquire`æ“ä½œï¼ŒæˆåŠŸè·å¾—è®¸å¯ï¼Œä¹‹åt2æ‰§è¡Œ`acquire`æ“ä½œï¼Œç”±äºæ­¤æ—¶è®¸å¯æ•°é‡ä¸å¤Ÿ(2<3)ï¼Œt2çº¿ç¨‹å°†ä¼šé˜»å¡ï¼Œç›´åˆ°è®¸å¯å¯ç”¨ã€‚ä¹‹åt1çº¿ç¨‹é‡Šæ”¾è®¸å¯ï¼Œmainçº¿ç¨‹é‡Šæ”¾è®¸å¯ï¼Œæ­¤æ—¶çš„è®¸å¯æ•°é‡å¯ä»¥æ»¡è¶³t2çº¿ç¨‹çš„è¦æ±‚ï¼Œæ‰€ä»¥ï¼Œæ­¤æ—¶t2çº¿ç¨‹ä¼šæˆåŠŸè·å¾—è®¸å¯è¿è¡Œï¼Œt2è¿è¡Œå®Œæˆåé‡Šæ”¾è®¸å¯:

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-thread-x-semaphore-5.png)







ä½¿ç”¨Semaphoreå®ç°ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°Aã€Bã€Cå­—ç¬¦ï¼š

```java
//ä½¿ç”¨Semaphoreä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°Aã€Bã€C

class  SemaphoreTest2{

 private static  final  Semaphore semaphoreA =new Semaphore(1);
 private static  final  Semaphore semaphoreB=new Semaphore(0);
 private static  final  Semaphore semaphoreC=new Semaphore(0);

    public static void main(String[] args) {

        new Thread(
                ()->{
                    print("A",semaphoreA,semaphoreB);
                }
        ,"ThreadA").start();

        new Thread(
                ()->{
                    print("B",semaphoreB,semaphoreC);
                }
                ,"ThreadB").start();

        new Thread(
                ()->{
                    print("C",semaphoreC,semaphoreA);
                }
                ,"ThreadC").start();
    }

   public static  void print(String message,Semaphore cur,Semaphore next)
   {

       for (int i = 0; i < 100; i++) {
           try {
               cur.acquire(1); //
           } catch (InterruptedException e) {
               throw new RuntimeException(e);
           }
           System.out.println(Thread.currentThread().getName()+"æ‰“å°"+message+"ç¬¬"+i+"æ¬¡");
           next.release(); //ä¸ºä¸‹ä¸€ä¸ªç­‰å¾…è¯¥ä¿¡å·é‡çš„çº¿ç¨‹å¼€ç»¿ç¯
       }
   }
}
```









### CountDownLatch

`CountDownLatch` ä¹Ÿæ˜¯å…±äº«é”çš„ä¸€ç§å®ç°,å®ƒé»˜è®¤æ„é€  `AQS` çš„ `state` å€¼ä¸º `count`

å½“çº¿ç¨‹ä½¿ç”¨ `countDown()` æ–¹æ³•æ—¶,å…¶å®ä½¿ç”¨äº†`tryReleaseShared`æ–¹æ³•ä»¥ `CAS` çš„æ“ä½œæ¥å‡å°‘ `state`,ç›´è‡³ `state` ä¸º 0ï¼›

å½“è°ƒç”¨ `await()` æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœ `state` ä¸ä¸º 0ï¼Œé‚£å°±è¯æ˜ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œ`await()` æ–¹æ³•å°±ä¼šä¸€ç›´é˜»å¡ï¼Œä¹Ÿå°±æ˜¯è¯´ `await()` æ–¹æ³•ä¹‹åçš„è¯­å¥ä¸ä¼šè¢«æ‰§è¡Œã€‚ç„¶åï¼Œ`CountDownLatch` ä¼šè‡ªæ—‹ CAS åˆ¤æ–­ `state == 0`ï¼Œå¦‚æœ `state == 0` çš„è¯ï¼Œå°±ä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œ`await()` æ–¹æ³•ä¹‹åçš„è¯­å¥å¾—åˆ°æ‰§è¡Œ





æºç åˆ†æï¼š

ç°åœ¨æˆ‘ä»¬ä»æºç åˆ†æä¸€ä¸‹`CountDownLatch`çš„å·¥ä½œåŸç†ï¼Œå…ˆæ¥çœ‹çœ‹å®ƒçš„å†…éƒ¨ç±»**Sync**,åœ¨ `CountDownLatch` ç±»å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ª Sync å†…éƒ¨ç±»ï¼Œè¿™ä¸ªå†…éƒ¨ç±»å°±æ˜¯ç»§æ‰¿è‡ª `AbstractQueuedSynchronizer` çš„ã€‚å¹¶ä¸”é‡å†™äº†æ–¹æ³• `tryAcquireShared`å’Œ`tryReleaseShared`ï¼š

```java
private static final class Sync extends AbstractQueuedSynchronizer {
    private static final long serialVersionUID = 4982264981922014374L;
    
    // ä¼ å…¥åˆå§‹æ¬¡æ•°
    Sync(int count) {
        setState(count);
    }
    // è·å–è¿˜å‰©çš„æ¬¡æ•°
    int getCount() {
        return getState();
    }
    // å°è¯•è·å–å…±äº«é”
    protected int tryAcquireShared(int acquires) {
        // æ³¨æ„ï¼Œè¿™é‡Œstateç­‰äº0çš„æ—¶å€™è¿”å›çš„æ˜¯1ï¼Œä¹Ÿå°±æ˜¯è¯´countå‡ä¸º0çš„æ—¶å€™è·å–æ€»æ˜¯æˆåŠŸ
        // stateä¸ç­‰äº0çš„æ—¶å€™è¿”å›çš„æ˜¯-1ï¼Œä¹Ÿå°±æ˜¯countä¸ä¸º0çš„æ—¶å€™æ€»æ˜¯è¦æ’é˜Ÿ
        return (getState() == 0) ? 1 : -1;
    }
    // å°è¯•é‡Šæ”¾é”
    protected boolean tryReleaseShared(int releases) {
        for (;;) {
            // stateçš„å€¼
            int c = getState();
            // ç­‰äº0äº†ï¼Œåˆ™æ— æ³•å†é‡Šæ”¾äº†
            if (c == 0)
                return false;
            // å°†countçš„å€¼å‡1
            int nextc = c-1;
            // åŸå­æ›´æ–°stateçš„å€¼
            if (compareAndSetState(c, nextc))
                // å‡ä¸º0çš„æ—¶å€™è¿”å›trueï¼Œè¿™æ—¶ä¼šå”¤é†’åé¢æ’é˜Ÿçš„çº¿ç¨‹
                return nextc == 0;
        }
    }
}
```



å£°æ˜ä¸€ä¸ª`CountDownLatch`å¯¹è±¡éœ€è¦ä¼ å…¥**ä¸€ä¸ªcountï¼Œç›¸å½“äºAQSä¸­çš„state**

```java
public CountDownLatch(int count) {
    this.sync = new Sync(count);
}

Sync(int count) {
    setState(count);
}

//æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨AQSä¸­çš„setState()
protected final void setState(int newState) {
    state = newState;
}
```





è€Œå½“è°ƒç”¨ `await()`æ–¹æ³•æ—¶ï¼Œ`CountDownLatch` ä¼šè°ƒç”¨å†…éƒ¨ç±» Sync çš„ `acquireSharedInterruptibly() ` æ–¹æ³•ï¼Œç„¶ååœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè°ƒç”¨ `tryAcquireShared` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ `CountDownLatch` çš„å†…éƒ¨ç±» `Sync` é‡Œé‡å†™çš„ `AbstractQueuedSynchronizer` çš„æ–¹æ³•ã€‚

è°ƒç”¨ `countDown()` æ–¹æ³•åŒç†ä¼šè°ƒç”¨Syncç±»ä¸­çš„`tryReleaseShared`æ–¹æ³•



await()æ–¹æ³•

```java
// java.util.concurrent.CountDownLatch.await()
public void await() throws InterruptedException {
    // è°ƒç”¨AQSçš„acquireSharedInterruptibly()æ–¹æ³•
    sync.acquireSharedInterruptibly(1);
}
// java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly()
public final void acquireSharedInterruptibly(int arg)
        throws InterruptedException {
    if (Thread.interrupted())
        throw new InterruptedException();
    // å°è¯•è·å–é”ï¼Œå¦‚æœå¤±è´¥åˆ™æ’é˜Ÿ
    if (tryAcquireShared(arg) < 0)
        doAcquireSharedInterruptibly(arg);
}
```

await()æ–¹æ³•æ˜¯ç­‰å¾…å…¶å®ƒçº¿ç¨‹å®Œæˆçš„æ–¹æ³•ï¼Œå®ƒä¼šå…ˆå°è¯•è·å–ä¸€ä¸‹å…±äº«é”ï¼Œå¦‚æœå¤±è´¥åˆ™è¿›å…¥AQSçš„é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…è¢«å”¤é†’ã€‚

æ ¹æ®ä¸Šé¢Syncçš„æºç ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œstateä¸ç­‰äº0çš„æ—¶å€™tryAcquireShared()è¿”å›çš„æ˜¯-1ï¼Œä¹Ÿå°±æ˜¯è¯´countæœªå‡åˆ°0çš„æ—¶å€™æ‰€æœ‰è°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹éƒ½è¦æ’é˜Ÿã€‚

 



countDown()æ–¹æ³•

```java
// java.util.concurrent.CountDownLatch.countDown()
public void countDown() {
    // è°ƒç”¨AQSçš„é‡Šæ”¾å…±äº«é”æ–¹æ³•
    sync.releaseShared(1);
}
// java.util.concurrent.locks.AbstractQueuedSynchronizer.releaseShared()
public final boolean releaseShared(int arg) {
    // å°è¯•é‡Šæ”¾å…±äº«é”ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œå°±å”¤é†’æ’é˜Ÿçš„çº¿ç¨‹
    if (tryReleaseShared(arg)) {
        doReleaseShared();
        return true;
    }
    return false;
}
```

countDown()æ–¹æ³•ï¼Œä¼šé‡Šæ”¾ä¸€ä¸ªå…±äº«é”ï¼Œä¹Ÿå°±æ˜¯countçš„æ¬¡æ•°ä¼šå‡1ã€‚

æ ¹æ®ä¸Šé¢Syncçš„æºç ï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒtryReleaseShared()æ¯æ¬¡ä¼šæŠŠcountçš„æ¬¡æ•°å‡1ï¼Œå½“å…¶å‡ä¸º0çš„æ—¶å€™è¿”å›trueï¼Œè¿™æ—¶å€™æ‰ä¼šå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚











æ¥çœ‹ä¸€ä¸‹`CountDownLatch`çš„ç”¨æ³•ï¼š

å‡å¦‚ç°åœ¨è¦è¯»å–å¤„ç† 6 ä¸ªæ–‡ä»¶ï¼Œè¿™ 6 ä¸ªä»»åŠ¡éƒ½æ˜¯æ²¡æœ‰æ‰§è¡Œé¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è¿”å›ç»™ç”¨æˆ·çš„æ—¶å€™å°†è¿™å‡ ä¸ªæ–‡ä»¶çš„å¤„ç†çš„ç»“æœè¿›è¡Œç»Ÿè®¡æ•´ç† ã€‚æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªçº¿ç¨‹æ± å’Œ `count` ä¸º 6 çš„`CountDownLatch`å¯¹è±¡ ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è¯»å–ä»»åŠ¡ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹å¤„ç†å®Œä¹‹åå°±å°† `count-1`ï¼Œè°ƒç”¨`CountDownLatch`å¯¹è±¡çš„ `await()`æ–¹æ³•ï¼Œç›´åˆ°æ‰€æœ‰æ–‡ä»¶è¯»å–å®Œä¹‹åï¼Œæ‰ä¼šæ¥ç€æ‰§è¡Œåé¢çš„é€»è¾‘ï¼š

```java
public class CountDownLatchExample1 {
    // å¤„ç†æ–‡ä»¶çš„æ•°é‡
    private static final int threadCount = 6;

    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»ºä¸€ä¸ªå…·æœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± å¯¹è±¡ï¼ˆæ¨èä½¿ç”¨æ„é€ æ–¹æ³•åˆ›å»ºï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(10);
        final CountDownLatch countDownLatch = new CountDownLatch(threadCount);
        for (int i = 0; i < threadCount; i++) {
            final int threadnum = i;
            threadPool.execute(() -> {
                try {
                    //å¤„ç†æ–‡ä»¶çš„ä¸šåŠ¡æ“ä½œ
                    //......
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    //è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶å·²ç»è¢«å®Œæˆ
                    countDownLatch.countDown();
                }

            });
        }
        countDownLatch.await(); //
        threadPool.shutdown();
        System.out.println("finish");
    }
}

```





ä¾‹å­2  åœ¨3ä¸ªå‰ç½®èµ„æºåŠ è½½å®Œæˆåï¼ŒMainçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼š

```java

public class CountDownLatchTest {
    
    private  static  final CountDownLatch count=new CountDownLatch(3);
    public static void main(String[] args) throws InterruptedException {

        System.out.println("ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ");
        new Thread(
                ()->{
                    count.countDown(); //å…±äº«æ¨¡å¼ä¸‹çš„é‡Šæ”¾
                    System.out.println(Thread.currentThread().getName()+"åŠ è½½èµ„æº1");
                    System.out.println("è¿˜æœ‰"+count.getCount()+"ä¸ªèµ„æºæœªåŠ è½½å®Œæˆ");
                }
                ,"Thread1").start();

        new Thread(
                ()->{
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    count.countDown(); //å…±äº«æ¨¡å¼ä¸‹çš„é‡Šæ”¾
                    System.out.println(Thread.currentThread().getName()+"åŠ è½½èµ„æº2");
                    System.out.println("è¿˜æœ‰"+count.getCount()+"ä¸ªèµ„æºæœªåŠ è½½å®Œæˆ");
                }
                ,"Thread2").start();
        new Thread(
                ()->{
                    try {
                        Thread.sleep(2000);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    count.countDown(); //å…±äº«æ¨¡å¼ä¸‹çš„é‡Šæ”¾
                    System.out.println(Thread.currentThread().getName()+"åŠ è½½èµ„æº3");
                    System.out.println("è¿˜æœ‰"+count.getCount()+"ä¸ªèµ„æºæœªåŠ è½½å®Œæˆ");
                }
                ,"Thread3").start();

        count.await();
        System.out.println("å‰ç½®èµ„æºåŠ è½½å®Œæ¯•,ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ");
    }
}
```

æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

```
ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
Thread1åŠ è½½èµ„æº1
è¿˜æœ‰2ä¸ªèµ„æºæœªåŠ è½½å®Œæˆ
Thread2åŠ è½½èµ„æº2
è¿˜æœ‰1ä¸ªèµ„æºæœªåŠ è½½å®Œæˆ
å‰ç½®èµ„æºåŠ è½½å®Œæ¯•,ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
Thread3åŠ è½½èµ„æº3
è¿˜æœ‰0ä¸ªèµ„æºæœªåŠ è½½å®Œæˆ
```



ç–‘æƒ‘ :question: 

ä¸ºä»€ä¹ˆ`Thread3`è¿˜æ²¡æœ‰`countDown()`å®Œæˆï¼Œä¸»çº¿ç¨‹å°±å·²ç»å¼€å§‹ç»§ç»­æ‰§è¡Œäº†ï¼Ÿ

åŸå› æ˜¯CPUåŸºäºæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ï¼Œ





### CyclicBarrier









## Conditionç±»

ä»»ä½•ä¸€ä¸ªjavaå¯¹è±¡éƒ½å¤©ç„¶ç»§æ‰¿äºObjectç±»ï¼Œåœ¨çº¿ç¨‹é—´å®ç°é€šä¿¡çš„å¾€å¾€ä¼šåº”ç”¨åˆ°Objectçš„å‡ ä¸ªæ–¹æ³•ï¼š

- wait()
- wait(long timeout)
- wait(long timeout, int nanos)
- notify()
- notifyAll()

åœ¨java Lockä½“ç³»ä¸‹ä¾ç„¶ä¼šæœ‰åŒæ ·çš„æ–¹æ³•å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œæ•´ä½“ä¸Šæ¥çœ‹**Objectçš„waitå’Œnotify/notifyæ˜¯ä¸å¯¹è±¡ç›‘è§†å™¨é…åˆå®Œæˆçº¿ç¨‹é—´çš„ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼Œè€ŒConditionä¸Locké…åˆå®Œæˆç­‰å¾…é€šçŸ¥æœºåˆ¶ï¼Œå‰è€…æ˜¯javaåº•å±‚çº§åˆ«çš„ï¼Œåè€…æ˜¯è¯­è¨€çº§åˆ«çš„ï¼Œå…·æœ‰æ›´é«˜çš„å¯æ§åˆ¶æ€§å’Œæ‰©å±•æ€§**



`Condition`æ˜¯åœ¨java 1.5ä¸­æ‰å‡ºç°çš„ï¼Œå®ƒç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„Objectçš„`wait()`ã€`notify()`å®ç°çº¿ç¨‹é—´çš„åä½œï¼Œç›¸æ¯”ä½¿ç”¨`Object`çš„`wait()`ã€`notify()`ï¼Œä½¿ç”¨`Condition`çš„`await()`ã€`signal()`è¿™ç§æ–¹å¼å®ç°çº¿ç¨‹é—´åä½œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆï¼š

- Conditionæ˜¯ä¸ªæ¥å£ï¼ŒåŸºæœ¬çš„æ–¹æ³•å°±æ˜¯await()å’Œsignal()æ–¹æ³•ï¼›
- Conditionä¾èµ–äºLockæ¥å£ï¼Œç”Ÿæˆä¸€ä¸ªConditionçš„åŸºæœ¬ä»£ç æ˜¯**lock.newCondition()**
- **è°ƒç”¨Conditionçš„await()å’Œsignal()æ–¹æ³•ï¼Œéƒ½å¿…é¡»åœ¨lockä¿æŠ¤ä¹‹å†…ï¼Œå°±æ˜¯è¯´å¿…é¡»åœ¨lock.lock()å’Œlock.unlockä¹‹é—´æ‰å¯ä»¥ä½¿ç”¨ï¼Œå› ä¸ºå†…éƒ¨ä¼šåšé‡Šæ”¾é”çš„æ“ä½œï¼Œå¦‚æœä¸æ˜¯åœ¨lockå’Œunlockä¹‹é—´ä½¿ç”¨ï¼Œä¼šæŠ¥é”™`java.lang.IllegalMonitorStateException`**
- Conditonä¸­çš„`await()`å¯¹åº”Objectçš„`wait()`ï¼›signal()å¯¹åº”Objectçš„`notify()`ï¼›Conditionä¸­çš„`signalAll()`å¯¹åº”Objectçš„`notifyAll()`





### æ¡ä»¶é˜Ÿåˆ—



`AQS`å†…éƒ¨æœ‰ä¸€ä¸ªå†…éƒ¨ç±»`ConditionObject`ï¼Œå…¶å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå•å‘é“¾è¡¨ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ï¼Œè¿™ä¸ªå†…éƒ¨ç±»å†…æœ‰ä¸¤ä¸ªå±æ€§ï¼š`firstWaiter`å’Œ`lastWaiter`åˆ†åˆ«æŒ‡å‘å•å‘é“¾è¡¨çš„å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œè¿™ä¸ªå•å‘é“¾è¡¨å°±æ˜¯æ¡ä»¶é˜Ÿåˆ—ï¼Œå’Œç­‰å¾…é˜Ÿåˆ—çš„ä¸åŒå¤„æ˜¯å®ƒçš„å¤´èŠ‚ç‚¹æ˜¯ç»‘å®šçº¿ç¨‹çš„,æ¡ä»¶é˜Ÿåˆ—çš„ç»“æ„å¦‚ä¸‹

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/XpRTa39LHCWzhDXpHDJZ8MTjyzw8VsVTgVCLRmlq73GqwGzydF9CXpqoDFYicCJpOrvmZRPlZokIYhicibDvHJNpw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œ`condition`æ˜¯è¦å’Œlocké…åˆä½¿ç”¨çš„ä¹Ÿå°±æ˜¯conditionå’ŒLockæ˜¯ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œè€Œlockçš„å®ç°åŸç†åˆä¾èµ–äºAQSï¼Œè‡ªç„¶è€Œç„¶`ConditionObject`å°±æˆä¸ºäº†AQSçš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚

åˆ›å»ºä¸€ä¸ª`condition`å¯¹è±¡æ˜¯é€šè¿‡`lock.newCondition()`,è€Œè¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ä¼šnewå‡ºä¸€ä¸ª**`ConditionObject`**å¯¹è±¡ï¼Œè¯¥ç±»æ˜¯AQSçš„ä¸€ä¸ªå†…éƒ¨ç±»ã€‚







åœ¨é”æœºåˆ¶çš„å®ç°ä¸Šï¼Œ**AQSå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯ç‹¬å å¼é”çš„è¯ï¼Œæ‰€æœ‰è·å–é”å¤±è´¥çš„çº¿ç¨‹çš„å°¾æ’å…¥åˆ°åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŒæ ·çš„ï¼ŒConditionå†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨åŒæ ·çš„æ–¹å¼ï¼Œæ¯ä¸ª`Condition`å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—**ï¼Œæ‰€æœ‰è°ƒç”¨`condition.await`æ–¹æ³•çš„çº¿ç¨‹ä¼šåŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”çº¿ç¨‹çŠ¶æ€è½¬æ¢ä¸ºç­‰å¾…çŠ¶æ€ã€‚å¦å¤–æ³¨æ„åˆ°`ConditionObject`ä¸­æœ‰ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼š

```java
/** First node of condition queue. */
private transient Node firstWaiter;
/** Last node of condition queue. */
private transient Node lastWaiter;

```

å¯ä»¥çœ‹å‡ºæ¥`ConditionObject`é€šè¿‡æŒæœ‰ç­‰å¾…é˜Ÿåˆ—çš„`å¤´å°¾æŒ‡é’ˆ`æ¥ç®¡ç†æ¡ä»¶é˜Ÿåˆ—ï¼ŒNodeç±»æœ‰è¿™æ ·ä¸€ä¸ªå±æ€§ï¼š

```JAVA
static final class ConditionNode extends Node{
ConditionNode nextWaiter;   
}
```

è¿›ä¸€æ­¥è¯´æ˜ï¼Œ**æ¡ä»¶é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é˜Ÿåˆ—**ï¼Œè€Œåœ¨ä¹‹å‰è¯´AQSæ—¶çŸ¥é“åŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ä¸€ä¸ªdemoï¼Œé€šè¿‡debugè¿›å»çœ‹æ˜¯ä¸æ˜¯ç¬¦åˆæˆ‘ä»¬çš„çŒœæƒ³ï¼š

```java
public static void main(String[] args) {
    for (int i = 0; i < 10; i++) {
        Thread thread = new Thread(() -> {
            lock.lock();
            try {
                condition.await();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }finally {
                lock.unlock();
            }
        });
        thread.start();
    }
}
```

æ–°å»ºäº†10ä¸ªçº¿ç¨‹ï¼Œæ²¡æœ‰çº¿ç¨‹å…ˆè·å–é”ï¼Œç„¶åè°ƒç”¨`condition.await`æ–¹æ³•é‡Šæ”¾é”å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œé€šè¿‡debugæ§åˆ¶å½“èµ°åˆ°ç¬¬10ä¸ªçº¿ç¨‹çš„æ—¶å€™æŸ¥çœ‹`firstWaiter`å³ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´ç»“ç‚¹ï¼Œdebugæ¨¡å¼ä¸‹æƒ…æ™¯å›¾å¦‚ä¸‹:

![debugæ¨¡å¼ä¸‹æƒ…æ™¯å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/thread/condition-01.png)



ä»è¿™ä¸ªå›¾æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°è¿™æ ·å‡ ç‚¹ï¼š

1. è°ƒç”¨`condition.await`æ–¹æ³•åçº¿ç¨‹ä¾æ¬¡å°¾æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¦‚å›¾é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹å¼•ç”¨ä¾æ¬¡ä¸ºThread-0,Thread-1,Thread-2....Thread-8ï¼›
2. ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘é˜Ÿåˆ—ã€‚é€šè¿‡æˆ‘ä»¬çš„çŒœæƒ³ç„¶åè¿›è¡Œå®éªŒéªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç­‰å¾…é˜Ÿåˆ—çš„ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç­‰å¾…é˜Ÿåˆ—çš„ç¤ºæ„å›¾](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/thread/condition-02.png)







åŒæ—¶è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæˆ‘ä»¬å¯ä»¥å¤šæ¬¡è°ƒç”¨`lock.newCondition()`æ–¹æ³•åˆ›å»ºå¤šä¸ª`condition`å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªlockå¯ä»¥æŒæœ‰å¤šä¸ªç­‰å¾…é˜Ÿåˆ—ã€‚ä¸åŒäºåœ¨`Objectçš„ç›‘è§†å™¨æ¨¡å‹ä¸Š`çš„ä¸€ä¸ªå¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ï¼Œ**å¹¶å‘åŒ…ä¸­çš„Lockå®ç°ç±»æ‹¥æœ‰ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—å’Œå¤šä¸ªç­‰å¾…é˜Ÿåˆ—**ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/1352849-20201223220123984-923368951.png" style="zoom: 80%;" />

- **æ¡ä»¶é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå•å‘FIFOé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«äº†ä¸€ä¸ªçº¿ç¨‹å¼•ç”¨ï¼Œè¯¥çº¿ç¨‹æ˜¯åœ¨Conditionå¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼›**
- **å®é™…ä¸Šè¿™é‡Œçš„æ¡ä»¶é˜Ÿåˆ—å’ŒAQSä¸­çš„åŒæ­¥é˜Ÿåˆ—ï¼Œéƒ½æ˜¯é‡‡ç”¨AQS.Nodeé™æ€å†…éƒ¨ç±»ï¼›**
- **ä¸€ä¸ªConditionObjectæ‹¥æœ‰é¦–èŠ‚ç‚¹(fisrtWaiter)å’Œå°¾èŠ‚ç‚¹(lastWaiter)ï¼›**
- **å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Condition.await()æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ä¼šé‡Šæ”¾é”ï¼ˆä»åŒæ­¥é˜Ÿåˆ—ä¸­ç§»é™¤ï¼‰ï¼Œæ„é€ æˆèŠ‚ç‚¹åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ï¼Œç­‰å¾…è¢«å”¤é†’ï¼›**
- **å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Condition.signal()æ–¹æ³•ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†ä¼šè¢«å”¤é†’ï¼ˆä»æ¡ä»¶é˜Ÿåˆ—ä¸­ç§»é™¤ï¼‰ï¼Œæ„é€ æˆèŠ‚ç‚¹åŠ å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå°è¯•é‡æ–°è·å–åŒæ­¥çŠ¶æ€ï¼›**



(æœ€åä¸¤æ¡åé¢ä¼šå•ç‹¬è¿›è¡Œåˆ†æ)







### å…¥é˜Ÿ/å‡ºé˜Ÿ



#### await()

å½“è°ƒç”¨`await()`æ–¹æ³•æ—¶ï¼Œç›¸å½“äºåŒæ­¥é˜Ÿåˆ—çš„é¦–èŠ‚ç‚¹ï¼ˆè·å–äº†é”çš„èŠ‚ç‚¹ï¼‰ç§»åŠ¨åˆ°äº†`Condition`çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ 

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/condition-await.png" style="zoom:67%;" />	

æ›´å…·ä½“æ¥è¯´æ˜¯**é¦–å…ˆè°ƒç”¨await()æ–¹æ³•ä¹‹å‰è‚¯å®šæ˜¯èƒ½è·å–åˆ°åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŒæ­¥é˜Ÿåˆ—ä¸­é¦–èŠ‚ç‚¹ï¼Œä¹‹åè°ƒç”¨await()æ–¹æ³•ç”±å°†é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—**



å†æ¥çœ‹æºç ï¼š

**1ï¼‰è°ƒç”¨`await`()æ–¹æ³•ï¼Œé€šè¿‡`addConditionWaiter`()æ–¹æ³•åŠ å…¥ç­‰å¾…çº¿ç¨‹ï¼Œç„¶åé‡Šæ”¾å…¨éƒ¨åŒæ­¥çŠ¶æ€**

**2ï¼‰è¿›å…¥whileå¾ªç¯ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœå·²ç»è¢«ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­åˆ™è¯´æ˜çº¿ç¨‹å·²ç»è¢«å”¤é†’ï¼ˆsignalï¼‰ï¼›**

**3ï¼‰æ¥ä¸‹æ¥å°è¯•è·å–ç«äº‰åŒæ­¥çŠ¶æ€ï¼Œå³è°ƒç”¨`acquireQueue`æ–¹æ³•**

```java
   ã€€ã€€public final void await() throws InterruptedException {
            if (Thread.interrupted())
                throw new InterruptedException();
            // addConditionWaiter()æ–¹æ³•å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
            Node node = addConditionWaiter();
            // è°ƒç”¨await()æ–¹æ³•åé‡Šæ”¾å½“å‰çº¿ç¨‹æ‰€å ç”¨çš„lockï¼Œåœ¨é‡Šæ”¾çš„è¿‡ç¨‹ä¸­ä¼šå”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
            int savedState = fullyRelease(node);
            int interruptMode = 0;
            // æ£€æŸ¥nodeæ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œä¸æ˜¯çš„è¯è¯´æ˜å·²ç»è·å–åˆ°é”
            //  LockSupport.unparkå”¤é†’çº¿ç¨‹åï¼Œä»è¿™é‡Œè¿”å›ï¼Œæ­¤æ—¶å·²ç»åœ¨SyncQueueåŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œé€€å‡ºå¾ªç¯
            // ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œä¹Ÿæ˜¯ç»å…¸çš„ç­‰å¾…/é€šçŸ¥æ¨¡å¼
            while (!isOnSyncQueue(node)) {
                // é˜»å¡å½“å‰çº¿ç¨‹ ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€
                LockSupport.park(this);
                // åœ¨è°ƒç”¨signalå‰æŠ›å‡ºä¸­æ–­å¼‚å¸¸ï¼Œæˆ–è€…è°ƒç”¨ä¹‹åä¸­æ–­ï¼Œéƒ½é€€å‡ºå¾ªç¯
                // THROW_IE if interrupted  before signalled, REINTERRUPT if after signalled
                if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
                    break;
            }
            // è¢«å”¤é†’åçš„çº¿ç¨‹é‡æ–°å°è¯•ç«äº‰è·å–åŒæ­¥çŠ¶æ€
            if (acquireQueued(node, savedState) && interruptMode != THROW_IE)
                interruptMode = REINTERRUPT;
            if (node.nextWaiter != null) // clean up if cancelled
                unlinkCancelledWaiters();
            if (interruptMode != 0)
                reportInterruptAfterWait(interruptMode);
        }
```

**å½“å‰çº¿ç¨‹è°ƒç”¨`condition.await()`æ–¹æ³•åï¼Œä¼šä½¿å¾—å½“å‰çº¿ç¨‹é‡Šæ”¾lockç„¶ååŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç›´è‡³è¢«`signal/signalAll`åä¼šä½¿å¾—å½“å‰çº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»è‡³åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»ï¼Œç›´åˆ°è·å¾—äº†lockåæ‰ä¼šä»awaitæ–¹æ³•è¿”å›ï¼Œæˆ–è€…åœ¨ç­‰å¾…æ—¶è¢«ä¸­æ–­ä¼šåšä¸­æ–­å¤„ç†**

é‚£ä¹ˆå…³äºè¿™ä¸ªå®ç°è¿‡ç¨‹æˆ‘ä»¬ä¼šæœ‰è¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š

1. æ˜¯æ€æ ·å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»çš„ï¼Ÿ
2. é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Ÿ
3. æ€æ ·æ‰èƒ½ä»awaitæ–¹æ³•é€€å‡ºï¼Ÿ

è€Œè¿™æ®µä»£ç çš„é€»è¾‘å°±æ˜¯å‘Šè¯‰æˆ‘ä»¬è¿™ä¸‰ä¸ªé—®é¢˜çš„ç­”æ¡ˆã€‚å…·ä½“**è¯·çœ‹æ³¨é‡Š**ï¼Œåœ¨ç¬¬1æ­¥ä¸­è°ƒç”¨`addConditionWaiter`å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè¯¥æ–¹æ³•æºç ä¸ºï¼š

```
private Node addConditionWaiter() {
    Node t = lastWaiter;
    // If lastWaiter is cancelled, clean out.
    if (t != null && t.waitStatus != Node.CONDITION) {
        unlinkCancelledWaiters();
        t = lastWaiter;
    }
	//å°†å½“å‰çº¿ç¨‹åŒ…è£…æˆNode
    Node node = new Node(Thread.currentThread(), Node.CONDITION);
    if (t == null)
        firstWaiter = node;
    else
		//å°¾æ’å…¥
        t.nextWaiter = node;
	//æ›´æ–°lastWaiter
    lastWaiter = node;
    return node;
}
```

è¿™æ®µä»£ç å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œå°†å½“å‰èŠ‚ç‚¹åŒ…è£…æˆNodeï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—çš„`firstWaiter`ä¸ºnullçš„è¯ï¼ˆç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºé˜Ÿåˆ—ï¼‰ï¼Œåˆ™å°†`firstWaiter`æŒ‡å‘å½“å‰çš„Node,å¦åˆ™ï¼Œæ›´æ–°`lastWaiter`(å°¾èŠ‚ç‚¹)å³å¯ã€‚å°±æ˜¯**é€šè¿‡å°¾æ’å…¥çš„æ–¹å¼å°†å½“å‰çº¿ç¨‹å°è£…çš„Nodeæ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å³å¯**ï¼ŒåŒæ—¶å¯ä»¥çœ‹å‡ºç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ª**ä¸å¸¦å¤´ç»“ç‚¹çš„é“¾å¼é˜Ÿåˆ—**ï¼Œä¹‹å‰æˆ‘ä»¬å­¦ä¹ AQSæ—¶çŸ¥é“åŒæ­¥é˜Ÿåˆ—**æ˜¯ä¸€ä¸ªå¸¦å¤´ç»“ç‚¹çš„é“¾å¼é˜Ÿåˆ—**ï¼Œè¿™æ˜¯ä¸¤è€…çš„ä¸€ä¸ªåŒºåˆ«

å°†å½“å‰èŠ‚ç‚¹æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¹‹åï¼Œä¼šä½¿å½“å‰çº¿ç¨‹é‡Šæ”¾lockï¼Œç”±fullyReleaseæ–¹æ³•å®ç°ï¼ŒfullyReleaseæºç ä¸ºï¼š

```java
final int fullyRelease(Node node) {
    boolean failed = true;
    try {
        int savedState = getState();
        if (release(savedState)) {
			//æˆåŠŸé‡Šæ”¾åŒæ­¥çŠ¶æ€
            failed = false;
            return savedState;
        } else {
			//ä¸æˆåŠŸé‡Šæ”¾åŒæ­¥çŠ¶æ€æŠ›å‡ºå¼‚å¸¸
            throw new IllegalMonitorStateException();
        }
    } finally {
        if (failed)
            node.waitStatus = Node.CANCELLED;
    }
}
```

è¿™æ®µä»£ç å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œ**è°ƒç”¨AQSçš„æ¨¡æ¿æ–¹æ³•releaseæ–¹æ³•é‡Šæ”¾AQSçš„åŒæ­¥çŠ¶æ€å¹¶ä¸”å”¤é†’åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­å¤´ç»“ç‚¹çš„åç»§èŠ‚ç‚¹å¼•ç”¨çš„çº¿ç¨‹**



é‚£ä¹ˆçº¿ç¨‹å¦‚ä½•é€€å‡º`await`æ–¹æ³•å‘¢ï¼Ÿ

**å½“å‰çº¿ç¨‹è¢«ä¸­æ–­æˆ–è€…è°ƒç”¨`condition.signal/condition.signalAll`æ–¹æ³•å½“å‰èŠ‚ç‚¹ç§»åŠ¨åˆ°äº†åŒæ­¥é˜Ÿåˆ—å** ï¼Œè¿™æ˜¯å½“å‰çº¿ç¨‹é€€å‡ºawaitæ–¹æ³•çš„å‰ææ¡ä»¶

å½“é€€å‡ºwhileå¾ªç¯åå°±ä¼šè°ƒç”¨`acquireQueued(node, savedState)`ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯åœ¨**è‡ªæ—‹è¿‡ç¨‹ä¸­çº¿ç¨‹ä¸æ–­å°è¯•è·å–åŒæ­¥çŠ¶æ€ï¼Œç›´è‡³æˆåŠŸï¼ˆçº¿ç¨‹è·å–åˆ°lockï¼‰**ã€‚è¿™æ ·ä¹Ÿè¯´æ˜äº†**é€€å‡ºawaitæ–¹æ³•å¿…é¡»æ˜¯å·²ç»è·å¾—äº†conditionå¼•ç”¨ï¼ˆå…³è”ï¼‰çš„lock**ã€‚









#### signal()

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/condition-signal.png)

è°ƒç”¨`signal`æ–¹æ³•å°†ä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„èŠ‚ç‚¹ï¼ˆé¦–èŠ‚ç‚¹ï¼‰ï¼Œåœ¨å”¤é†’èŠ‚ç‚¹ä¹‹å‰ï¼Œä¼šå°†èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­:

```java
ã€€ã€€public final void signal() {
            // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰è·å¾—é”
            if (!isHeldExclusively())
                throw new IllegalMonitorStateException();
            Node first = firstWaiter;
            if (first != null)
                // ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹
                doSignal(first);
        }
ã€€ã€€private void doSignal(Node first) {
            do {
                // å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå³é¦–èŠ‚ç‚¹ï¼‰ï¼Œåˆ™å”¤é†’é¦–èŠ‚ç‚¹ålastWaiterç½®ç©º
                if ( (firstWaiter = first.nextWaiter) == null)
                    lastWaiter = null;
                // å¦åˆ™è·å–ç­‰å¾…é˜Ÿåˆ—ä¸­çš„é¦–èŠ‚ç‚¹ï¼Œå³nextåŸŸæ–­å¼€ç½®ç©º
                first.nextWaiter = null;
            } while (!transferForSignal(first) &&
                     (first = firstWaiter) != null);
        }
```

**`doSignal(Node node)`æ–¹æ³•ä¸­è°ƒç”¨`transferForSignal(Node node)`ï¼Œé€šè¿‡è°ƒç”¨`enq(Node node)`æ–¹æ³•(è¿™é‡Œå…¶å®å°±æ˜¯åŒæ­¥é˜Ÿåˆ—çš„å…¥é˜Ÿ`enq(Node node)`æ–¹æ³•)ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´ç»“ç‚¹çº¿ç¨‹å®‰å…¨åœ°ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œå½“èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—åï¼Œå½“å‰çº¿ç¨‹å°†ä¼šè¢«å”¤é†’`ï¼ˆLockSupport.unpark(node.thread)`**

```java
    final boolean transferForSignal(Node node) {
        /*
         * If cannot change waitStatus, the node has been cancelled.
         */
        // å¦‚æœæ²¡æœ‰æ­£ç¡®è®¾ç½®ç­‰å¾…çŠ¶æ€ä¸ºåˆå§‹çŠ¶æ€å‡†å¤‡åŠ å…¥åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œåˆ™è¿”å›ï¼Œå½“å‰èŠ‚ç‚¹çŠ¶æ€ä¸ºNode.CONDITION
        if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))
            return false;
        // å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´ç»“ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­, è¿”å›å·²ç»åŠ å…¥çš„å½“å‰nodeåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­å‰èŠ‚ç‚¹
        Node p = enq(node);
        int ws = p.waitStatus;
        if (ws > 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))
            // å”¤é†’å½“å‰nodeçº¿ç¨‹ï¼Œè¿”å›while(isOnSynQueue(Node node))å¤„ï¼Œé€€å‡ºå¾ªç¯
            LockSupport.unpark(node.thread);
        return true;
    }
```



æµç¨‹ç»“æ„å¦‚ä¸‹å›¾ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/conditiom-signal2.png" style="zoom:80%;" />

æ€»ç»“ï¼š

(1) é€šè¿‡è°ƒç”¨åŒæ­¥å™¨çš„`enq(Node node)`æ–¹æ³•ï¼Œè®©ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹çº¿ç¨‹å®‰å…¨åœ°ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ã€‚å½“èŠ‚ç‚¹ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—åï¼Œå½“å‰çº¿ç¨‹å†ä½¿ç”¨`LockSupport`å”¤é†’è¯¥èŠ‚ç‚¹çš„çº¿ç¨‹ã€‚è¢«å”¤é†’åçš„çº¿ç¨‹ï¼Œå°†ä»`await()`æ–¹æ³•ä¸­çš„`while`å¾ªç¯ä¸­é€€å‡º(`isOnSyncQueue(Node node)`æ–¹æ³•è¿”å›`true`ï¼ŒèŠ‚ç‚¹å·²ç»åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­)ï¼Œ**è¿›è€Œè°ƒç”¨åŒæ­¥å™¨çš„`acquireQueued()`æ–¹æ³•åŠ å…¥åˆ°è·å–åŒæ­¥çŠ¶æ€çš„ç«äº‰ä¸­**ã€‚æˆåŠŸè·å–åŒæ­¥çŠ¶æ€ï¼ˆæˆ–è€…è¯´é”ï¼‰ä¹‹åï¼Œè¢«å”¤é†’çš„çº¿ç¨‹å°†ä»å…ˆå‰è°ƒç”¨çš„`await()`æ–¹æ³•è¿”å›ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å·²ç»æˆåŠŸåœ°è·å–äº†é”

(2) `Condition`çš„`signalAll()`æ–¹æ³•ï¼Œç›¸å½“äºå¯¹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å‡æ‰§è¡Œä¸€æ¬¡`signal()`æ–¹æ³•ï¼ˆ**æ³¨æ„æ˜¯è¿™ä¸ª`Condition`å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—**ï¼‰ï¼Œæ•ˆæœå°±æ˜¯å°†ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰€æœ‰èŠ‚ç‚¹å…¨éƒ¨ç§»åŠ¨åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶å”¤é†’æ¯ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹











### ä¸€äº›é—®é¢˜:currency_exchange:



> `question1`:å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ await()æ–¹æ³•åè¿›å…¥æ¡ä»¶é˜Ÿåˆ—ï¼Œå…¶ä»–çº¿ç¨‹åç»­è°ƒç”¨signal()æ–¹æ³•å”¤é†’è¯¥çº¿ç¨‹ï¼Œè¯·é—®è¿™é‡Œçš„å”¤é†’æ˜¯è¿›å…¥äº†AQSä¸­çš„CLHåŒæ­¥é˜Ÿåˆ—å—ï¼Ÿ

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•åè¿›å…¥æ¡ä»¶é˜Ÿåˆ—ï¼Œå…¶ä»–çº¿ç¨‹åç»­è°ƒç”¨ `signal()` æˆ– `signalAll()` æ–¹æ³•æ¥å”¤é†’ç­‰å¾…çº¿ç¨‹æ—¶ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹ä¼šä»æ¡ä»¶é˜Ÿåˆ—ç§»åŠ¨åˆ° AQSï¼ˆAbstractQueuedSynchronizerï¼‰çš„ CLHï¼ˆCraig, Landin, and Hagerstenï¼‰åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚

è¿™æ˜¯å› ä¸º `Condition` æ¥å£çš„å®ç°é€šå¸¸æ˜¯åŸºäº `ReentrantLock` æˆ–å…¶ä»– `AQS` å­ç±»çš„ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾å½“å‰æŒæœ‰çš„é”ï¼ˆå³ `ReentrantLock` é”ï¼‰ï¼Œç„¶åè¿›å…¥æ¡ä»¶é˜Ÿåˆ—ç­‰å¾…ã€‚å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨ `signal()` æˆ– `signalAll()` æ–¹æ³•æ¥å”¤é†’ç­‰å¾…çº¿ç¨‹æ—¶ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹ä¼šä»æ¡ä»¶é˜Ÿåˆ—ä¸­ç§»åŠ¨åˆ° AQS çš„ CLH åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œå¼€å§‹å‚ä¸é”çš„ç«äº‰ã€‚

åœ¨ AQS çš„ CLH é˜Ÿåˆ—ä¸­ï¼Œçº¿ç¨‹ä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ’é˜Ÿç­‰å¾…è·å–é”(**é”çš„ç«äº‰ï¼šå…¬å¹³/éå…¬å¹³**)ï¼Œé€šè¿‡è‡ªæ—‹ç­‰å¾…æ¥å‡å°‘çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ã€‚ä¸€æ—¦çº¿ç¨‹æˆåŠŸè·å–é”ï¼Œå®ƒä¼šä» CLH é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ  





> `question2`: æ—¢ç„¶await/signalæ–¹æ³•éœ€è¦å€ŸåŠ©äºlock (å¿…é¡»å£°æ˜åœ¨`lock.lock()+lock.unlock()`æ–¹æ³•å—ä¸­)ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸€ä¸ªçº¿ç¨‹åœ¨æ–¹æ³•å—å†…éƒ¨è°ƒç”¨`condition.await()`æ–¹æ³•æ—¶ä¼šé‡Šæ”¾é”ï¼Œæ˜æ˜è¯¥çº¿ç¨‹è¿˜æ²¡æœ‰è°ƒç”¨`lock.unlock()`æ–¹æ³•å‘€

åœ¨ `ReentrantLock` å’Œ `Condition` çš„è®¾è®¡ä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨æ–¹æ³•å—å†…éƒ¨è°ƒç”¨ `condition.await()` æ–¹æ³•æ—¶ï¼Œç¡®å®ä¼šé‡Šæ”¾é”ï¼Œå°½ç®¡æ­¤æ—¶è¿˜æ²¡æœ‰æ˜¾å¼åœ°è°ƒç”¨ `lock.unlock()` æ–¹æ³•ã€‚è¿™å¯èƒ½ä¼šå¼•èµ·ä¸€äº›å›°æƒ‘ï¼Œä½†å®é™…ä¸Šè¿™ç§è®¾è®¡æ˜¯ä¸ºäº†æä¾›æ›´çµæ´»çš„çº¿ç¨‹åè°ƒå’Œç­‰å¾…æœºåˆ¶ã€‚

è¿™é‡Œçš„å…³é”®åœ¨äº `condition.await()` æ–¹æ³•å†…éƒ¨ä¼šè‡ªåŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹æŒæœ‰çš„é”ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹æ”¾å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ç„¶åï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ä¼šç­‰å¾…åœ¨ç‰¹å®šçš„æ¡ä»¶ä¸Šï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹é€šè¿‡ `condition.signal()` æˆ– `condition.signalAll()` æ–¹æ³•**å”¤é†’ï¼Œ** è¿™é‡Œçš„å”¤é†’æŒ‡çš„æ˜¯è¢«å”¤é†’çš„çº¿ç¨‹ä¼šåœ¨ CLH é˜Ÿåˆ—ä¸­æŒ‰ç…§ä¸€å®šçš„é¡ºåºç­‰å¾…ï¼Œç„¶åå°è¯•ä½¿ç”¨ **CAS**ï¼ˆCompare and Swapï¼‰æ“ä½œè·å–é”

- å½“ä¸€ä¸ªçº¿ç¨‹è¢«å”¤é†’å¹¶è¿›å…¥ AQS çš„ CLH åŒæ­¥é˜Ÿåˆ—ï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥é€šè¿‡ CAS æ“ä½œè·å–é”çš„ï¼Œè€Œæ˜¯ä¼šæŒ‰ç…§é˜Ÿåˆ—ä¸­çš„é¡ºåºé€ä¸ªå°è¯•è·å–é”ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰å…³

- å¯¹äºå…¬å¹³é”ï¼ˆ`Fair` ä¸º `true`ï¼‰çš„æƒ…å†µï¼š

  1. å½“è¢«å”¤é†’çš„çº¿ç¨‹è¿›å…¥ CLH é˜Ÿåˆ—åï¼Œå®ƒä¼šæŒ‰ç…§é˜Ÿåˆ—çš„é¡ºåºç­‰å¾…ï¼Œä¸ä¼šç›´æ¥é€šè¿‡ CAS æ“ä½œè·å–é”ã€‚

  2. çº¿ç¨‹åªæœ‰åœ¨è½®åˆ°å®ƒæˆä¸ºé˜Ÿåˆ—çš„å¤´ç»“ç‚¹æ—¶ï¼Œæ‰ä¼šå°è¯•ä½¿ç”¨ CAS æ“ä½œè·å–é”ã€‚æ­¤æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦å·²ç»é‡Šæ”¾é”ï¼Ÿ

     å¦‚æœæ˜¯ï¼Œåˆ™è¯¥çº¿ç¨‹å¯ä»¥é€šè¿‡ CAS æ“ä½œè·å–é”

- å¯¹äºéå…¬å¹³é”ï¼ˆ`Fair` ä¸º `false`ï¼‰çš„æƒ…å†µï¼š

  1. å½“è¢«å”¤é†’çš„çº¿ç¨‹è¿›å…¥ CLH é˜Ÿåˆ—åï¼Œå®ƒä¼šç›´æ¥å°è¯•ä½¿ç”¨ CAS æ“ä½œè·å–é”ï¼Œä¸ä¼šç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”ã€‚
  2. å¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œçº¿ç¨‹ä¼šæˆåŠŸè·å–é”ã€‚å¦‚æœ CAS æ“ä½œå¤±è´¥ï¼Œåˆ™çº¿ç¨‹å¯èƒ½ä¼šè¿›è¡Œè‡ªæ—‹ç­‰å¾…ï¼Œæˆ–è€…è¢«é˜»å¡ï¼Œç›´åˆ°å®ƒæˆåŠŸè·å–é”æˆ–è€…æ”¾å¼ƒç«äº‰ã€‚



è¿™ç§è®¾è®¡çš„ç›®çš„æ˜¯å…è®¸å…¶ä»–çº¿ç¨‹æœ‰æœºä¼šè·å¾—é”å¹¶æ‰§è¡Œä¸€äº›æ“ä½œï¼Œè€Œä¸ä¼šè¢«å½“å‰çº¿ç¨‹æŒæœ‰é”çš„ä»£ç å—æ‰€é˜»å¡ã€‚å¦‚æœ `condition.await()` ä¸é‡Šæ”¾é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹å°†æ— æ³•è¿›å…¥åˆ°è¯¥ä»£ç å—ï¼Œå¯¼è‡´æ•ˆç‡ä¸‹é™æˆ–æ­»é”ã€‚å½“è¢«å”¤é†’çš„çº¿ç¨‹é‡æ–°è·å–é”æ—¶ï¼Œå®ƒä¼šç»§ç»­æ‰§è¡Œæ¡ä»¶ç­‰å¾…ä¹‹åçš„ä»£ç ï¼Œæ­¤æ—¶å†æ¬¡æŒæœ‰é”ã€‚æ‰€ä»¥ï¼Œè™½ç„¶åœ¨ `condition.await()` æ–¹æ³•å†…éƒ¨é‡Šæ”¾äº†é”ï¼Œä½†åœ¨çº¿ç¨‹è¢«å”¤é†’åï¼Œå®ƒä¼šç»§ç»­æ‰§è¡Œé”ä¿æŠ¤ä¸‹çš„ä»£ç ã€‚





> question3:å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ signalAll()æ–¹æ³•æ—¶ï¼Œä¼šå”¤é†’æ‰€æœ‰åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸Šçš„çº¿ç¨‹å—ï¼Ÿ

é¦–å…ˆè¦æ¸…æ¥šï¼š

- å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨`signalAll`()æ–¹æ³•æ—¶ï¼Œè¯¥çº¿ç¨‹æ­¤æ—¶æ˜¯å¤„äºæŒæœ‰é”å‡†å¤‡é‡Šæ”¾çš„çŠ¶æ€
- å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ `await()` æ–¹æ³•ï¼ŒåŒæ ·æ˜¯åœ¨æŒæœ‰é”çš„çŠ¶æ€ä¸‹è°ƒç”¨çš„ï¼Œå°½ç®¡è°ƒç”¨ `await()` æ–¹æ³•æ—¶ä¼šé‡Šæ”¾é”ï¼Œä½†çº¿ç¨‹åœ¨è¢«å”¤é†’åä¼šé‡æ–°è·å–é”ï¼Œæ‰€ä»¥åœ¨ `await()` ä¹‹åçš„ä»£ç å—ä¸­ï¼Œçº¿ç¨‹ä»ç„¶æ˜¯åœ¨æŒæœ‰é”çš„çŠ¶æ€ä¸‹æ‰§è¡Œçš„(å³è¯¥çº¿ç¨‹å…ˆè¿›å…¥äº†`Condition`æ¡ä»¶é˜Ÿåˆ—ç­‰å¾…ï¼Œç„¶åè¢«å”¤é†’åé‡æ–°è¿›å…¥CLHåŒæ­¥é˜Ÿåˆ—æ¥ç«äº‰é”)



å½“ä¸€ä¸ªçº¿ç¨‹åœ¨`lock`ä»£ç å—å†…éƒ¨è°ƒç”¨ `signalAll()` æ–¹æ³•æ—¶ï¼Œå®ƒä¼šé€šçŸ¥æ‰€æœ‰åœ¨è¯¥ç‰¹å®šæ¡ä»¶ä¸Šç­‰å¾…çš„çº¿ç¨‹(æ¯ä¸ª`Condition`éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„æ¡ä»¶é˜Ÿåˆ—)ï¼Œä½¿å®ƒä»¬æœ‰æœºä¼šé‡æ–°å‚ä¸ç«äº‰é”ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šä»æ¡ä»¶é˜Ÿåˆ—ç§»åŠ¨åˆ° `AQSï¼ˆAbstractQueuedSynchronizerï¼‰`çš„**CLHåŒæ­¥é˜Ÿåˆ—**ä¸­ï¼Œç„¶åå¼€å§‹ç«äº‰é”ã€‚



éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡ `signalAll()` ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰è¢«å”¤é†’çš„çº¿ç¨‹éƒ½ä¼šæˆåŠŸè·å–é”ã€‚çº¿ç¨‹è¿˜éœ€è¦å‚ä¸é”çš„ç«äº‰ï¼Œé€šè¿‡ CAS æ“ä½œç­‰å¾…å…¶æœºä¼šï¼Œæœ€ç»ˆè·å–é”å¹¶ç»§ç»­æ‰§è¡Œã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸè·å–é”å¹¶æ»¡è¶³æ¡ä»¶ã€‚



### ç¤ºä¾‹

1ã€ä½¿ç”¨Conditionæ¥å®ç°ä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°Aã€Bã€Cå­—ç¬¦ï¼š

```java
public class ConditionTest {
    //Conditionä¾èµ–å¤–éƒ¨Lockå¯¹è±¡
    private  static  final ReentrantLock lock=new ReentrantLock();
    private  static  final Condition A=lock.newCondition();
    private  static  final Condition B=lock.newCondition();
    private  static  final Condition C=lock.newCondition();
    private  static AtomicInteger state=new AtomicInteger(0);

    public static void main(String[] args) {
        new Thread(
            ()->{
                print("A",0,A,B);
            }
            ,"Thread A").start();

        new Thread(
            ()->{
                print("B",1,B,C);
            }
            ,"Thread B").start();

        new Thread(
            ()->{
                print("C",2,C,A);
            }
            ,"Thread C").start();
    }

    static  void print(String msg,int  target,Condition cur,Condition next)
    {
        for (int i = 0; i < 100; i++) {
            try {
                lock.lock();
                while (state.get() % 3 != target) {
                    cur.await();
                }
                next.signalAll(); //å”¤é†’åœ¨ä¸‹ä¸€ä¸ªconditioné˜Ÿåˆ—ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè®©è¯¥çº¿ç¨‹åŠ å…¥ç«äº‰é”çš„åŒæ­¥é˜Ÿåˆ—
                System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹æ‰“å°" + msg + "ç¬¬" + i + "æ¬¡");
                state.incrementAndGet();
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }
    }
}
```









2ã€ä½¿ç”¨Conditionå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹:

```java

//ä½¿ç”¨Conditionå®ç°ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å‹
//å®ç°ä¸€ä¸ªç®€æ˜“çš„BlockingQueue
class  MyBlockingQueueTest{

    private  volatile  int maxSize;
    private   final Queue<Object> queue;
    private  static  final  ReentrantLock lock=new ReentrantLock();

    private  Condition notEmpty=lock.newCondition();
    private  Condition notFull=lock.newCondition();
   public MyBlockingQueueTest(int size)
    {
        this.maxSize=size;
        queue=new LinkedList();
    }

    public  void  put(Object obj) throws InterruptedException {
       lock.lock();
       try {
           if(queue.size()==maxSize) //é˜Ÿåˆ—åˆ°è¾¾æœ€å¤§å®¹é‡â€”â€” Full
           {
               notFull.await(); //ç”Ÿäº§è€…ä¸èƒ½æ¥ç€putå…ƒç´ äº†
           }
           queue.add(obj);
           notEmpty.signalAll(); //å”¤é†’ç­‰å¾…çš„æ¶ˆè´¹è€…
       }
       finally {
           lock.unlock();
       }
    }

    public  Object  get() throws  InterruptedException
    {
        lock.lock();
        try {
            if(queue.size()==0)  //é˜Ÿåˆ—ä¸­æ²¡æœ‰å…ƒç´ 
            {
                notEmpty.await();// æ¶ˆè´¹è€…æ— æ³•å–äº†,é˜»å¡å¼ç­‰å¾…
            }
            Object item=queue.remove();
            notFull.signalAll() ;//å”¤é†’ç”Ÿäº§è€…ï¼Œå¯ä»¥ç»§ç»­å¾€é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ 
            return  item;
        }finally {
            lock.unlock();
        }
    }


    public static void main(String[] args) throws InterruptedException {
        MyBlockingQueueTest myBlockingQueueTest = new MyBlockingQueueTest(20);
        ExecutorService producerPool = Executors.newFixedThreadPool(5);
        ExecutorService consumerPool = Executors.newFixedThreadPool(5);
        producerPool.execute(
                // è¿™éƒ¨åˆ†ä»£ç å°†ç”±çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å¼‚æ­¥æ‰§è¡Œ
                ()->{
                    for (int i = 0; i < 20; i++) {
                        try {
                            myBlockingQueueTest.put(i);
                            System.out.println("Producer :"+i);
                        } catch (InterruptedException e) {
                            throw new RuntimeException(e);
                        }
                    }
                }
        );
        consumerPool.execute(
                ()->{
                    try {
                        Thread.sleep(2000);
                    } catch (InterruptedException e) {
                        throw new RuntimeException(e);
                    }
                    for (int i = 0; i < 20; i++) {
                        try {
                            Object result = myBlockingQueueTest.get();
                            System.out.println("Consumer"+result);
                        }catch (Exception e)
                        {
                            throw  new RuntimeException(e);
                        }
                    }
                }
        );

        producerPool.shutdown();
        consumerPool.shutdown();
    }
}
```







# JVM





## ä¸€æ®µJAVAä»£ç çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ

Javaä»£ç çš„æ‰§è¡Œåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

1. **ç¼–å†™ä»£ç ï¼š** é¦–å…ˆï¼Œå¼€å‘äººå‘˜æ ¹æ®éœ€æ±‚ç¼–å†™Javaæºä»£ç ã€‚æºä»£ç æ˜¯ä»¥æ–‡æœ¬å½¢å¼ç¼–å†™çš„ï¼ŒåŒ…å«Javaçš„è¯­æ³•è§„åˆ™å’Œé€»è¾‘ã€‚

2. **ç¼–è¯‘é˜¶æ®µï¼š** ç¼–è¯‘é˜¶æ®µæ˜¯å°†Javaæºä»£ç ç¼–è¯‘æˆå­—èŠ‚ç çš„è¿‡ç¨‹ã€‚Javaæºä»£ç ç»è¿‡Javaç¼–è¯‘å™¨ï¼ˆjavacï¼‰çš„å¤„ç†ï¼Œç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼ˆ.classæ–‡ä»¶ï¼‰ã€‚å­—èŠ‚ç æ˜¯ä¸€ç§ä¸­é—´ä»£ç ï¼Œå®ƒåŒ…å«äº†ä¸ç‰¹å®šç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ— å…³çš„æŒ‡ä»¤ã€‚

3. **ç±»åŠ è½½é˜¶æ®µï¼š** ç±»åŠ è½½é˜¶æ®µæ˜¯å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°Javaè™šæ‹Ÿæœºçš„è¿‡ç¨‹ã€‚Javaè™šæ‹Ÿæœºå°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å¯¹ç±»è¿›è¡ŒéªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–ã€‚ç±»åŠ è½½é˜¶æ®µæ˜¯Javaè™šæ‹Ÿæœºçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£åŠ è½½ç±»å’Œæ¥å£ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨æ–¹æ³•åŒºã€‚

4. **è¿è¡Œé˜¶æ®µï¼š** è¿è¡Œé˜¶æ®µæ˜¯Javaä»£ç å®é™…æ‰§è¡Œçš„é˜¶æ®µã€‚åœ¨è¿è¡Œé˜¶æ®µï¼ŒJavaè™šæ‹Ÿæœºä¼šæ ¹æ®ç¨‹åºçš„æ§åˆ¶æµå’Œé€»è¾‘æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤ï¼Œä»è€Œå®ç°Javaç¨‹åºçš„åŠŸèƒ½

   > è¿è¡Œé˜¶æ®µæ˜¯Javaç¨‹åºå®é™…æ‰§è¡Œçš„é˜¶æ®µï¼Œä¹Ÿæ˜¯Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰æœ€æ ¸å¿ƒçš„éƒ¨åˆ†,è¯¥é˜¶æ®µJVMå®Œæˆäº†ï¼š
   >
   > 1. **è§£é‡Šæ‰§è¡Œï¼š** JVMä½¿ç”¨è§£é‡Šå™¨å¯¹å­—èŠ‚ç æŒ‡ä»¤è¿›è¡Œé€æ¡è§£é‡Šæ‰§è¡Œã€‚è§£é‡Šå™¨å°†å­—èŠ‚ç æŒ‡ä»¤ç¿»è¯‘æˆç‰¹å®šå¹³å°çš„æœºå™¨ç ï¼Œç„¶åæ‰§è¡Œè¿™äº›æœºå™¨ç æŒ‡ä»¤ã€‚è¿™ç§æ–¹å¼ä½¿å¾—Javaç¨‹åºå¯ä»¥åœ¨ä¸åŒçš„ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œï¼Œå®ç°äº†Javaçš„è·¨å¹³å°ç‰¹æ€§ã€‚ç„¶è€Œï¼Œè§£é‡Šæ‰§è¡Œæ•ˆç‡ç›¸å¯¹è¾ƒä½ï¼Œæ‰€ä»¥JVMä¼šé‡‡ç”¨ä¸€äº›ä¼˜åŒ–æ‰‹æ®µæ¥æé«˜æ€§èƒ½ã€‚
   > 2. **å³æ—¶ç¼–è¯‘ï¼ˆJITç¼–è¯‘ï¼‰ï¼š** ä¸ºäº†æé«˜Javaç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼ŒJVMä¼šä½¿ç”¨å³æ—¶ç¼–è¯‘å™¨ï¼ˆJust-In-Time Compilerï¼ŒJITï¼‰å¯¹**çƒ­ç‚¹ä»£ç **è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ã€‚**JITç¼–è¯‘å™¨å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœ¬åœ°æœºå™¨ç ï¼Œå¹¶ç”Ÿæˆä¼˜åŒ–çš„æœ¬åœ°ä»£ç **ã€‚**è¿™æ ·åœ¨åç»­æ‰§è¡Œæ—¶ï¼Œçƒ­ç‚¹ä»£ç å°±ä¸å†é€šè¿‡è§£é‡Šå™¨æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨æœ¬åœ°ä»£ç ï¼Œä»è€Œå¤§å¹…æé«˜æ‰§è¡Œé€Ÿåº¦**ã€‚
   > 3. **å†…å­˜ç®¡ç†ï¼š** åœ¨è¿è¡Œé˜¶æ®µï¼ŒJVMè´Ÿè´£ç®¡ç†Javaç¨‹åºçš„å†…å­˜ã€‚å®ƒå°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œç”¨äºå­˜å‚¨ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚JVMä½¿ç”¨åƒåœ¾å›æ”¶å™¨è¿›è¡Œè‡ªåŠ¨çš„å†…å­˜å›æ”¶ï¼Œå›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œæº¢å‡ºã€‚
   > 4. **æ‰§è¡Œå¼‚å¸¸å¤„ç†ï¼š** åœ¨è¿è¡Œé˜¶æ®µï¼ŒJVMä¼šæ•è·å’Œå¤„ç†Javaç¨‹åºä¸­çš„å¼‚å¸¸ã€‚å½“ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸æƒ…å†µæ—¶ï¼ŒJVMä¼šæ ¹æ®å¼‚å¸¸å¤„ç†æœºåˆ¶æ‰§è¡Œç›¸åº”çš„å¼‚å¸¸å¤„ç†ä»£ç ï¼Œä¿è¯ç¨‹åºçš„æ­£å¸¸è¿è¡Œã€‚





Java è™šæ‹Ÿæœºè™½ç„¶æ˜¯è™šæ‹Ÿçš„ï¼Œä½†å®ƒçš„å†…éƒ¨æ˜¯å¯ä»¥åˆ’åˆ†ä¸ºï¼š

- ç±»åŠ è½½å™¨ï¼ˆClass Loaderï¼‰
- è¿è¡Œæ—¶æ•°æ®åŒºï¼ˆRuntime Data Areasï¼‰
- æ‰§è¡Œå¼•æ“ï¼ˆExcution Engineï¼‰

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/seven-06.png" style="zoom: 50%;" />





**1ï¼‰ç±»åŠ è½½å™¨**

ç±»åŠ è½½å™¨æ˜¯ Java è™šæ‹Ÿæœºçš„ä¸€ä¸ªå­ç³»ç»Ÿï¼Œç”¨äºåŠ è½½ç±»æ–‡ä»¶ã€‚æ¯å½“æˆ‘ä»¬è¿è¡Œä¸€ä¸ª Java ç¨‹åºï¼Œå®ƒéƒ½ä¼šç”±ç±»åŠ è½½å™¨é¦–å…ˆåŠ è½½ã€‚

ä¸€èˆ¬æ¥è¯´ï¼ŒJava ç¨‹åºå‘˜å¹¶ä¸éœ€è¦ç›´æ¥åŒç±»åŠ è½½å™¨è¿›è¡Œäº¤äº’ã€‚JVM é»˜è®¤çš„è¡Œä¸ºå°±å·²ç»è¶³å¤Ÿæ»¡è¶³å¤§å¤šæ•°æƒ…å†µçš„éœ€æ±‚äº†ã€‚ä¸è¿‡ï¼Œå¦‚æœé‡åˆ°äº†éœ€è¦å’Œç±»åŠ è½½å™¨è¿›è¡Œäº¤äº’çš„æƒ…å†µï¼Œè€Œå¯¹ç±»åŠ è½½å™¨çš„æœºåˆ¶åˆä¸æ˜¯å¾ˆäº†è§£çš„è¯ï¼Œå°±ä¸å¾—ä¸èŠ±å¤§é‡çš„æ—¶é—´å»è°ƒè¯• `ClassNotFoundException` å’Œ `NoClassDefFoundError` ç­‰å¼‚å¸¸ã€‚

å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®å®šå…¶åœ¨ JVM ä¸­çš„å”¯ä¸€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸¤ä¸ªç±»çš„åŠ è½½å™¨ä¸åŒï¼Œå³ä½¿ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰ï¼ˆæ¯”å¦‚ä¸¤ä¸ªç±»çš„ Class å¯¹è±¡ä¸ `equals`ï¼‰



æ¥é€šè¿‡ä¸€æ®µç®€å•çš„ä»£ç äº†è§£ä¸‹ã€‚

```java
public class Test {
    public static void main(String[] args) {
        ClassLoader loader = Test.class.getClassLoader();
        while (loader != null) {
            System.out.println(loader);
            loader = loader.getParent();
        }
    }
}
```

æ¯ä¸ª Java ç±»éƒ½ç»´æŠ¤ç€ä¸€ä¸ªæŒ‡å‘å®šä¹‰å®ƒçš„ç±»åŠ è½½å™¨çš„å¼•ç”¨ï¼Œé€šè¿‡ `ç±»å.class.getClassLoader()` å¯ä»¥è·å–åˆ°æ­¤å¼•ç”¨ï¼›ç„¶åé€šè¿‡ `loader.getParent()` å¯ä»¥è·å–ç±»åŠ è½½å™¨çš„ä¸Šå±‚ç±»åŠ è½½å™¨ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```shell
jdk.internal.loader.ClassLoaders$AppClassLoader@512ddf17
jdk.internal.loader.ClassLoaders$PlatformClassLoader@2d209079
```

ç¬¬ä¸€è¡Œè¾“å‡ºä¸º Test çš„ç±»åŠ è½½å™¨ï¼Œå³åº”ç”¨ç±»åŠ è½½å™¨ï¼Œå®ƒæ˜¯ `jdk.internal.loader.ClassLoaders$AppClassLoader` ç±»çš„å®ä¾‹ï¼›ç¬¬äºŒè¡Œè¾“å‡ºä¸ºå¹³å°ç±»åŠ è½½å™¨ï¼Œæ˜¯ `jdk.internal.loader.ClassLoaders$PlatformClassLoader` ç±»çš„å®ä¾‹ã€‚é‚£å¯åŠ¨ç±»åŠ è½½å™¨å‘¢ï¼ŸæŒ‰ç†è¯´ï¼Œæ‰©å±•ç±»åŠ è½½å™¨çš„ä¸Šå±‚ç±»åŠ è½½å™¨æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œä½†å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯è™šæ‹Ÿæœºçš„å†…ç½®ç±»åŠ è½½å™¨ï¼Œé€šå¸¸è¡¨ç¤ºä¸º `null`





**2ï¼‰è¿è¡Œæ—¶æ•°æ®åŒº**  

jdk1.7å’Œjdk1.8æƒ…å†µä¸åŒï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†







**3ï¼‰æ‰§è¡Œå¼•æ“**ï¼šæ‰§è¡Œå¼•æ“æ˜¯JVMçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£è§£é‡Šå’Œæ‰§è¡ŒJavaå­—èŠ‚ç æŒ‡ä»¤ã€‚æ‰§è¡Œå¼•æ“å¯ä»¥ä½¿ç”¨ä¸åŒçš„å®ç°æ–¹å¼ï¼ŒåŒ…æ‹¬è§£é‡Šæ‰§è¡Œå’Œå³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰æ‰§è¡Œ

- è§£é‡Šå™¨æ‰§è¡Œï¼šè¯»å–å­—èŠ‚ç æµï¼Œç„¶åç¿»è¯‘æˆæŒ‡ä»¤å¹¶æ‰§è¡Œã€‚å› ä¸ºå®ƒæ˜¯ä¸€è¡Œä¸€è¡Œåœ°è§£é‡Šå’Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å¾ˆå¿«åœ°è§£é‡Šå­—èŠ‚ç ï¼Œä½†æ˜¯æ‰§è¡Œèµ·æ¥ä¼šæ¯”è¾ƒæ…¢ï¼ˆæ¯•ç«Ÿè¦ä¸€è¡Œæ‰§è¡Œå®Œå†æ‰§è¡Œä¸‹ä¸€è¡Œï¼‰
- å³æ—¶ï¼ˆ`Just-In-Timeï¼ŒJIT`ï¼‰ç¼–è¯‘å™¨æ‰§è¡Œï¼šå³æ—¶ç¼–è¯‘å™¨ç”¨æ¥å¼¥è¡¥è§£é‡Šå™¨çš„ç¼ºç‚¹ï¼Œæé«˜æ€§èƒ½ã€‚æ‰§è¡Œå¼•æ“é¦–å…ˆæŒ‰ç…§è§£é‡Šæ‰§è¡Œçš„æ–¹å¼æ¥æ‰§è¡Œï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶å€™ï¼Œå³æ—¶ç¼–è¯‘å™¨æŠŠæ•´æ®µå­—èŠ‚ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚ç„¶åï¼Œæ‰§è¡Œå¼•æ“å°±æ²¡æœ‰å¿…è¦å†å»è§£é‡Šæ‰§è¡Œæ–¹æ³•äº†ï¼Œå®ƒå¯ä»¥ç›´æ¥é€šè¿‡æœ¬åœ°ä»£ç å»æ‰§è¡Œã€‚æ‰§è¡Œæœ¬åœ°ä»£ç æ¯”ä¸€æ¡ä¸€æ¡è¿›è¡Œè§£é‡Šæ‰§è¡Œçš„é€Ÿåº¦å¿«å¾ˆå¤šã€‚ç¼–è¯‘åçš„ä»£ç å¯ä»¥æ‰§è¡Œçš„å¾ˆå¿«ï¼Œå› ä¸ºæœ¬åœ°ä»£ç æ˜¯ä¿å­˜åœ¨ç¼“å­˜é‡Œçš„





**4) æœ¬åœ°æ–¹æ³•æ¥å£ Native Interfaceï¼š**æ˜¯JVMä¸åº•å±‚æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶çš„æ¥å£ï¼Œå…è®¸Javaä»£ç è°ƒç”¨æœ¬åœ°ä»£ç ï¼ˆå¦‚Cæˆ–C++ç¼–å†™çš„ä»£ç ï¼‰

**5) æœ¬åœ°æ–¹æ³•åº“ Native Method Libraries**ï¼šåŒ…å«äº†ä¸å¹³å°ç›¸å…³çš„æœ¬åœ°æ–¹æ³•çš„å®ç°ï¼Œç”¨äºæ”¯æŒJavaçš„æœ¬åœ°æ–¹æ³•è°ƒç”¨









## è™šæ‹Ÿæœºæ˜¯å¦‚ä½•ç®¡ç†å¯¹è±¡çš„ï¼Ÿ :star2:



Step1:ç±»åŠ è½½æ£€æŸ¥

è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡ new æŒ‡ä»¤æ—¶ï¼Œ**é¦–å…ˆå°†å»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°æ˜¯å¦èƒ½åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å®šä½åˆ°è¿™ä¸ªç±»çš„ç¬¦å·å¼•ç”¨**ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²è¢«åŠ è½½è¿‡ã€è§£æå’Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£å¿…é¡»å…ˆæ‰§è¡Œç›¸åº”çš„ç±»åŠ è½½è¿‡ç¨‹

> æ¯ä¸ªclassæ–‡ä»¶å‡åŒ…å«ä¸€ä¸ªå¸¸é‡æ± ,å­˜å‚¨ç€è¯¥ç±»ä½¿ç”¨çš„Various constants,åŒ…æ‹¬ç±»åã€å­—æ®µåã€æ–¹æ³•åã€å­—ç¬¦ä¸²å­—é¢é‡ç­‰ã€‚
>
> 
>
> åœ¨Javaç¨‹åºæ‰§è¡Œæ—¶JVMä¼šå°†æ‰€æœ‰æ¶‰åŠåˆ°çš„ç±»å¯¹åº”çš„ç¬¦å·å¼•ç”¨(å®šä¹‰åœ¨æ¯ä¸ªClassæ–‡ä»¶ä¸­)åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­
>
> 
>
> è¿™é‡Œçš„â€œç¬¦å·å¼•ç”¨â€æŒ‡çš„æ˜¯ç±»ååœ¨å¸¸é‡æ± ä¸­çš„å¼•ç”¨ entryã€‚JVMé€šè¿‡**è¿™ä¸ªç¬¦å·å¼•ç”¨æ¥å®šä½ç±»,é€šè¿‡æ£€æŸ¥è¯¥ç¬¦å·å¼•ç”¨å¯ä»¥åˆ¤æ–­å‡ºæ˜¯å¦ä»£è¡¨ä¸€ä¸ªå·²è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–è¿‡çš„ç±»ã€‚**



Step2:åˆ†é…å†…å­˜(å®é™…ä¼šå…ˆåˆ†é…åœ¨æ¯ä¸ªçº¿ç¨‹çš„æœ¬åœ°åˆ†é…ç¼“å†²åŒº(ä½äºedenåŒº)å†…ï¼Œä¸å¤Ÿäº†æ‰åˆ†é…åˆ°å…¨å±€å †ä¸­ :exclamation: )

åœ¨**ç±»åŠ è½½æ£€æŸ¥**é€šè¿‡åï¼Œæ¥ä¸‹æ¥è™šæ‹Ÿæœºå°†ä¸ºæ–°ç”Ÿå¯¹è±¡**åˆ†é…å†…å­˜**ã€‚å¯¹è±¡æ‰€éœ€çš„å†…å­˜å¤§å°åœ¨ç±»åŠ è½½å®Œæˆåä¾¿å¯ç¡®å®šï¼Œä¸ºå¯¹è±¡åˆ†é…ç©ºé—´çš„ä»»åŠ¡ç­‰åŒäºæŠŠä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä» Java å †ä¸­åˆ’åˆ†å‡ºæ¥ã€‚**åˆ†é…æ–¹å¼**æœ‰ **â€œæŒ‡é’ˆç¢°æ’â€** å’Œ **â€œç©ºé—²åˆ—è¡¨â€** ä¸¤ç§ï¼Œ**é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”± Java å †æ˜¯å¦è§„æ•´å†³å®šï¼Œè€Œ Java å †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®š**

**å†…å­˜åˆ†é…çš„ä¸¤ç§æ–¹å¼** ï¼ˆè¡¥å……å†…å®¹ï¼Œéœ€è¦æŒæ¡ï¼‰ï¼š

- æŒ‡é’ˆç¢°æ’ï¼š 
  - é€‚ç”¨åœºåˆï¼š**å †å†…å­˜è§„æ•´**ï¼ˆå³æ²¡æœ‰å†…å­˜ç¢ç‰‡ï¼‰çš„æƒ…å†µä¸‹
  - åŸç†ï¼š**ç”¨è¿‡çš„å†…å­˜å…¨éƒ¨æ•´åˆåˆ°ä¸€è¾¹ï¼Œæ²¡æœ‰ç”¨è¿‡çš„å†…å­˜æ”¾åœ¨å¦ä¸€è¾¹ï¼Œä¸­é—´æœ‰ä¸€ä¸ªåˆ†ç•ŒæŒ‡é’ˆï¼Œåªéœ€è¦å‘ç€æ²¡ç”¨è¿‡çš„å†…å­˜æ–¹å‘å°†è¯¥æŒ‡é’ˆç§»åŠ¨å¯¹è±¡å†…å­˜å¤§å°ä½ç½®å³å¯**
  - ä½¿ç”¨è¯¥åˆ†é…æ–¹å¼çš„ GC æ”¶é›†å™¨ï¼šSerial, ParNew
- ç©ºé—²åˆ—è¡¨ï¼š 
  - é€‚ç”¨åœºåˆï¼šå †å†…å­˜ä¸è§„æ•´çš„æƒ…å†µä¸‹
  - åŸç†ï¼š**è™šæ‹Ÿæœºä¼šç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨ä¸­ä¼šè®°å½•å“ªäº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œåœ¨åˆ†é…çš„æ—¶å€™ï¼Œæ‰¾ä¸€å—å„¿è¶³å¤Ÿå¤§çš„å†…å­˜å—å„¿æ¥åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œæœ€åæ›´æ–°åˆ—è¡¨è®°å½•**
  - ä½¿ç”¨è¯¥åˆ†é…æ–¹å¼çš„ GC æ”¶é›†å™¨ï¼šCMS

**é€‰æ‹©ä»¥ä¸Šä¸¤ç§æ–¹å¼ä¸­çš„å“ªä¸€ç§ï¼Œå–å†³äº Java å †å†…å­˜æ˜¯å¦è§„æ•´ã€‚è€Œ Java å †å†…å­˜æ˜¯å¦è§„æ•´ï¼Œå–å†³äº GC æ”¶é›†å™¨çš„ç®—æ³•æ˜¯"æ ‡è®°-æ¸…é™¤"ï¼Œè¿˜æ˜¯"æ ‡è®°-æ•´ç†"ï¼ˆä¹Ÿç§°ä½œ"æ ‡è®°-å‹ç¼©"ï¼‰**ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¤åˆ¶ç®—æ³•å†…å­˜æ˜¯è§„æ•´çš„



**å†…å­˜åˆ†é…å¹¶å‘é—®é¢˜ï¼ˆè¡¥å……å†…å®¹ï¼Œéœ€è¦æŒæ¡ï¼‰**

åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œå› ä¸ºåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºå¯¹è±¡æ˜¯å¾ˆé¢‘ç¹çš„äº‹æƒ…ï¼Œä½œä¸ºè™šæ‹Ÿæœºæ¥è¯´ï¼Œå¿…é¡»è¦ä¿è¯çº¿ç¨‹æ˜¯å®‰å…¨çš„ï¼Œé€šå¸¸æ¥è®²ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨ä¸¤ç§æ–¹å¼æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š

- **CAS+å¤±è´¥é‡è¯•(è‡ªæ—‹)ï¼š** CAS æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ã€‚æ‰€è°“ä¹è§‚é”å°±æ˜¯ï¼Œæ¯æ¬¡ä¸åŠ é”è€Œæ˜¯å‡è®¾æ²¡æœ‰å†²çªè€Œå»å®ŒæˆæŸé¡¹æ“ä½œï¼Œå¦‚æœå› ä¸ºå†²çªå¤±è´¥å°±é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚**è™šæ‹Ÿæœºé‡‡ç”¨ CAS é…ä¸Šå¤±è´¥é‡è¯•çš„æ–¹å¼ä¿è¯æ›´æ–°æ“ä½œçš„åŸå­æ€§ã€‚**
- **TLAB(å †å†…å­˜å¤„è®²è¿‡)ï¼š** ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹é¢„å…ˆåœ¨ Eden åŒºåˆ†é…ä¸€å—å„¿å†…å­˜ï¼ŒJVM åœ¨ç»™çº¿ç¨‹ä¸­çš„å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œé¦–å…ˆåœ¨ TLAB åˆ†é…ï¼Œ**å½“å¯¹è±¡å¤§äº TLAB ä¸­çš„å‰©ä½™å†…å­˜æˆ– TLAB çš„å†…å­˜å·²ç”¨å°½æ—¶ï¼Œå†é‡‡ç”¨ä¸Šè¿°çš„ CAS è¿›è¡Œå†…å­˜åˆ†é…**

> TLABå…¨ç§°Thread Local Allocation Buffer,å³çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒºã€‚
>
> å®ƒæ˜¯JVMä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›çš„å†…å­˜ç©ºé—´,ç”¨äºç”³è¯·å’Œå›æ”¶çº¿ç¨‹ç§æœ‰çš„çŸ­æœŸå¯¹è±¡ã€‚
>
> å…·ä½“æ¥è¯´:
>
> - æ¯ä¸ªçº¿ç¨‹åœ¨å¯åŠ¨æ—¶,JVMä¼šç»™äºˆå®ƒä¸€ä¸ªTLABç©ºé—´ã€‚
> - å½“çº¿ç¨‹ç”³è¯·æ–°å¯¹è±¡æ—¶(æ¯”å¦‚ä½¿ç”¨new Operator),JVMé¦–å…ˆä¼šä»è¯¥çº¿ç¨‹çš„TLABä¸­åˆ†é…å†…å­˜ã€‚
> - å¯¹è±¡åœ¨TLABä¸­åˆ†é…çš„å†…å­˜ç©ºé—´,è¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸå,å¯¹åº”çš„å†…å­˜ä¹Ÿä¼šç«‹å³é‡Šæ”¾å›TLABã€‚
> - å¦‚æœTLABå‰©ä½™ç©ºé—´ä¸è¶³,ç”³è¯·å¤§å¯¹è±¡,æˆ–è€…TLABå·²ç©º,åˆ™JVMæ‰ä¼šçœŸæ­£çš„å‘å †ç”³è¯·å†…å­˜ã€‚
>
> TLABçš„è®¾è®¡ä¸»è¦æ˜¯ä¸ºäº†æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡çŸ­æœŸå°å¯¹è±¡çš„é«˜æ•ˆåˆ†é…ã€‚å®ƒæœ‰ä»¥ä¸‹ä¼˜ç‚¹:
>
> - å‡å°‘å…¨å±€é”çš„ç«äº‰:æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„TLAB,**æ— éœ€ç«äº‰å…¨å±€é”**ã€‚
> - å‡å°‘å†…å­˜åˆ†é…å¼€é”€:TLABå†…éƒ¨åˆ†é…æ¯”å‘å †ç”³è¯·æ›´å¿«ã€‚
> - æé«˜å±€éƒ¨æ€§:TLABå†…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­,è‡ªç„¶èšé›†åœ¨ä¸€èµ·ã€‚



Step3:åˆå§‹åŒ–é›¶å€¼

å†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦**å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼**ï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œè¿™ä¸€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨ Java ä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±ç›´æ¥ä½¿ç”¨ï¼Œ**ç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼**



Step4:è®¾ç½®å¯¹è±¡å¤´

åˆå§‹åŒ–é›¶å€¼å®Œæˆä¹‹åï¼Œ**è™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›è¡Œå¿…è¦çš„è®¾ç½®**ï¼Œä¾‹å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹(`Klass Pointer`)å³å¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ã€å¯¹è±¡çš„å“ˆå¸Œç ã€**å¯¹è±¡çš„ GC åˆ†ä»£å¹´é¾„**ï¼Œä»¥åŠé”æ ‡å¿—ä½(`Synchronized`é‚£é‡Œè®²è¿‡)ç­‰ä¿¡æ¯ï¼Œ **è¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ä¸­ã€‚**



Step5:æ‰§è¡Œ init æ–¹æ³•

åœ¨ä¸Šé¢å·¥ä½œéƒ½å®Œæˆä¹‹åï¼Œä»è™šæ‹Ÿæœºçš„è§†è§’æ¥çœ‹ï¼Œä¸€ä¸ªæ–°çš„å¯¹è±¡å·²ç»äº§ç”Ÿäº†ï¼Œä½†ä» Java ç¨‹åºçš„è§†è§’æ¥çœ‹ï¼Œå¯¹è±¡åˆ›å»ºæ‰åˆšå¼€å§‹ï¼Œ`<init>` æ–¹æ³•è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½è¿˜ä¸ºé›¶ã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œæ‰§è¡Œ new æŒ‡ä»¤ä¹‹åä¼šæ¥ç€æ‰§è¡Œ `<init>` æ–¹æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œå…¨äº§ç”Ÿå‡ºæ¥



åœ¨å­—èŠ‚ç ä¸­ï¼Œæ„é€ å‡½æ•°è¢«è¡¨ç¤ºä¸º`<init>`æ–¹æ³•ï¼Œå…¶ä¸­`<init>`æ˜¯æ„é€ å‡½æ•°çš„æ ‡è¯†ç¬¦ã€‚æ¯ä¸ªæ„é€ å‡½æ•°éƒ½å¯¹åº”ä¸€ä¸ª`<init>`æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œå¯¹è±¡çš„åˆå§‹åŒ–å·¥ä½œï¼Œä¾‹å¦‚ä¸ºå¯¹è±¡çš„æˆå‘˜å˜é‡åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–å®ƒä»¬çš„åˆå§‹å€¼ã€‚



æ„é€ å‡½æ•°ï¼ˆ`<init>`æ–¹æ³•ï¼‰çš„ç‰¹ç‚¹ï¼š

1. æ–¹æ³•åç§°ä¸º`<init>`ï¼Œæ²¡æœ‰è¿”å›ç±»å‹ï¼ˆåŒ…æ‹¬voidï¼‰ï¼Œä¹Ÿä¸éœ€è¦æ˜¾å¼å£°æ˜è¿”å›å€¼ã€‚
2. æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨ç”±å¯¹è±¡åˆå§‹åŒ–æ—¶æ‰€éœ€çš„å‚æ•°å†³å®šã€‚
3. æ„é€ å‡½æ•°åœ¨å¯¹è±¡è¢«åˆ›å»ºæ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œä¸èƒ½æ‰‹åŠ¨è°ƒç”¨ï¼Œå› ä¸ºå®ƒä¸æ˜¯æ™®é€šçš„æ–¹æ³•ã€‚

```java
 Student student = new Student("Alice", 20);
```



> è¡¥å……1ï¼šå¯¹è±¡çš„å†…å­˜å¸ƒå±€

åœ¨ Hotspot è™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å¯ä»¥åˆ†ä¸º 3 å—åŒºåŸŸï¼š**å¯¹è±¡å¤´**ã€**å®ä¾‹æ•°æ®**å’Œ**å¯¹é½å¡«å……**ã€‚

**Hotspot è™šæ‹Ÿæœºçš„å¯¹è±¡å¤´åŒ…æ‹¬ä¸¤éƒ¨åˆ†ä¿¡æ¯**ï¼Œ**ç¬¬ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®**ï¼ˆå“ˆå¸Œç ã€GC åˆ†ä»£å¹´é¾„ã€`é”çŠ¶æ€æ ‡å¿—`ç­‰ç­‰ï¼‰ï¼Œ**å¦ä¸€éƒ¨åˆ†æ˜¯ç±»å‹æŒ‡é’ˆ**ï¼Œå³å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œ**è™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹**ã€‚

**å®ä¾‹æ•°æ®éƒ¨åˆ†æ˜¯å¯¹è±¡çœŸæ­£å­˜å‚¨çš„æœ‰æ•ˆä¿¡æ¯**ï¼Œä¹Ÿæ˜¯åœ¨ç¨‹åºä¸­æ‰€å®šä¹‰çš„å„ç§ç±»å‹çš„å­—æ®µå†…å®¹ã€‚

**å¯¹é½å¡«å……éƒ¨åˆ†ä¸æ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰ï¼Œä»…ä»…èµ·å ä½ä½œç”¨ã€‚** å› ä¸º Hotspot è™šæ‹Ÿæœºçš„è‡ªåŠ¨å†…å­˜ç®¡ç†ç³»ç»Ÿè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€ï¼Œæ¢å¥è¯è¯´å°±æ˜¯**å¯¹è±¡çš„å¤§å°å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„æ•´æ•°å€**ã€‚è€Œå¯¹è±¡å¤´éƒ¨åˆ†æ­£å¥½æ˜¯ 8 å­—èŠ‚çš„å€æ•°ï¼ˆ1 å€æˆ– 2 å€ï¼‰ï¼Œå› æ­¤ï¼Œå½“å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†æ²¡æœ‰å¯¹é½æ—¶ï¼Œå°±éœ€è¦é€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨





> è¡¥å……2ï¼šå¯¹è±¡çš„è®¿é—®

å»ºç«‹å¯¹è±¡å°±æ˜¯ä¸ºäº†ä½¿ç”¨å¯¹è±¡ï¼Œæˆ‘ä»¬çš„ Java ç¨‹åºé€šè¿‡æ ˆä¸Šçš„ `reference` æ•°æ®æ¥æ“ä½œå †ä¸Šçš„å…·ä½“å¯¹è±¡ã€‚å¯¹è±¡çš„è®¿é—®æ–¹å¼ç”±è™šæ‹Ÿæœºå®ç°è€Œå®šï¼Œç›®å‰ä¸»æµçš„è®¿é—®æ–¹å¼æœ‰ï¼š**ä½¿ç”¨å¥æŸ„**ã€**ç›´æ¥æŒ‡é’ˆ**

1ã€å¥æŸ„

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/access-location-of-object-handle.png" style="zoom: 80%;" />



2ã€ç›´æ¥æŒ‡é’ˆ



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/access-location-of-object-handle-direct-pointer.png" style="zoom:80%;" />



è¿™ä¸¤ç§å¯¹è±¡è®¿é—®æ–¹å¼å„æœ‰ä¼˜åŠ¿ã€‚ä½¿ç”¨å¥æŸ„æ¥è®¿é—®çš„æœ€å¤§å¥½å¤„æ˜¯ reference ä¸­å­˜å‚¨çš„æ˜¯ç¨³å®šçš„å¥æŸ„åœ°å€ï¼Œåœ¨å¯¹è±¡è¢«ç§»åŠ¨æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­çš„å®ä¾‹æ•°æ®æŒ‡é’ˆï¼Œè€Œ reference æœ¬èº«ä¸éœ€è¦ä¿®æ”¹ã€‚ä½¿ç”¨ç›´æ¥æŒ‡é’ˆè®¿é—®æ–¹å¼æœ€å¤§çš„å¥½å¤„å°±æ˜¯é€Ÿåº¦å¿«ï¼Œå®ƒèŠ‚çœäº†ä¸€æ¬¡æŒ‡é’ˆå®šä½çš„æ—¶é—´å¼€é”€









## å­—èŠ‚ç 

JVM å¯ä»¥ç†è§£çš„ä»£ç å°±å«åš`å­—èŠ‚ç `ï¼ˆå³æ‰©å±•åä¸º `.class` çš„æ–‡ä»¶ï¼‰ï¼ŒJava è¯­è¨€é€šè¿‡å­—èŠ‚ç çš„æ–¹å¼ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†ä¼ ç»Ÿè§£é‡Šå‹è¯­è¨€æ‰§è¡Œæ•ˆç‡ä½çš„é—®é¢˜ï¼ŒåŒæ—¶åˆä¿ç•™äº†è§£é‡Šå‹è¯­è¨€å¯ç§»æ¤çš„ç‰¹ç‚¹ã€‚æ‰€ä»¥ Java ç¨‹åºè¿è¡Œæ—¶æ¯”è¾ƒé«˜æ•ˆï¼Œè€Œä¸”ï¼Œ**ç”±äºå­—èŠ‚ç å¹¶ä¸é’ˆå¯¹ä¸€ç§ç‰¹å®šçš„æœºå™¨ï¼Œå› æ­¤ï¼ŒJava ç¨‹åºæ— é¡»é‡æ–°ç¼–è¯‘ä¾¿å¯åœ¨å¤šç§ä¸åŒæ“ä½œç³»ç»Ÿçš„è®¡ç®—æœºä¸Šè¿è¡Œ**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-virtual-machine-program-language-os.png" style="zoom: 67%;" />

å¯ä»¥è¯´`.class`æ–‡ä»¶æ˜¯ä¸åŒçš„è¯­è¨€åœ¨ Java è™šæ‹Ÿæœºä¹‹é—´çš„é‡è¦æ¡¥æ¢ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ”¯æŒ Java è·¨å¹³å°å¾ˆé‡è¦çš„ä¸€ä¸ªåŸå› 

æ ¹æ® Java è™šæ‹Ÿæœºè§„èŒƒï¼ŒClass æ–‡ä»¶é€šè¿‡ `ClassFile` å®šä¹‰ï¼Œæœ‰ç‚¹ç±»ä¼¼ C è¯­è¨€çš„ç»“æ„ä½“ã€‚



å¯ä»¥ä»åå…­è¿›åˆ¶çš„å­—èŠ‚ç è§’åº¦ã€ `jclasslib` å›¾å½¢åŒ–æŸ¥çœ‹åç¼–è¯‘åçš„å­—èŠ‚ç çš„è§’åº¦ã€ä¹Ÿæˆ–è€…æ˜¯åé¢ä» `javap` åç¼–è¯‘åçš„è§’åº¦éƒ½å¯ä»¥åˆ†æå­—èŠ‚ç æ–‡ä»¶ï¼š

`ClassFile` çš„ç»“æ„å¦‚ä¸‹ï¼š

```java
ClassFile {
    u4             magic; //Class æ–‡ä»¶çš„æ ‡å¿—      0xcafebabe
    u2             minor_version;//Class çš„å°ç‰ˆæœ¬å·  æ¬¡ç‰ˆæœ¬å·
    
    u2             major_version;//Class çš„å¤§ç‰ˆæœ¬å·  ä¸»ç‰ˆæœ¬å·â€”â€”â€”â€”æ¯å½“ Java å‘å¸ƒå¤§ç‰ˆæœ¬æ—¶ï¼ˆJava 8ï¼ŒJava9ï¼‰ä¸»ç‰ˆæœ¬å·éƒ½ä¼šåŠ  1
    
    u2             constant_pool_count;//å¸¸é‡æ± çš„æ•°é‡
    cp_info        constant_pool[constant_pool_count-1];//å¸¸é‡æ± 
    u2             access_flags;//Class çš„è®¿é—®æ ‡è®°
    u2             this_class;//å½“å‰ç±»
    u2             super_class;//çˆ¶ç±»
    u2             interfaces_count;//æ¥å£æ•°é‡
    u2             interfaces[interfaces_count];//ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£
    u2             fields_count;//Class æ–‡ä»¶çš„å­—æ®µå±æ€§æ•°é‡
    field_info     fields[fields_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªå­—æ®µ
    u2             methods_count;//Class æ–‡ä»¶çš„æ–¹æ³•æ•°é‡
    method_info    methods[methods_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰ä¸ªå¤šä¸ªæ–¹æ³•
    u2             attributes_count;//æ­¤ç±»çš„å±æ€§è¡¨ä¸­çš„å±æ€§æ•°
    attribute_info attributes[attributes_count];//å±æ€§è¡¨é›†åˆ
}

```

é€šè¿‡åˆ†æ `ClassFile` çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥çŸ¥é“ `class` æ–‡ä»¶çš„ç»„æˆ:

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/classfile.jpeg" style="zoom: 25%;" />



**Magic-Number é­”æ•°:**

```java
    u4             magic; //Class æ–‡ä»¶çš„æ ‡å¿—
```

æ¯ä¸ª Class æ–‡ä»¶çš„å¤´ 4 ä¸ªå­—èŠ‚ç§°ä¸ºé­”æ•°ï¼ˆ`Magic Number`ï¼‰,å®ƒçš„å”¯ä¸€ä½œç”¨æ˜¯**ç¡®å®šè¿™ä¸ªæ–‡ä»¶æ˜¯å¦ä¸ºä¸€ä¸ªèƒ½è¢«è™šæ‹Ÿæœºæ¥æ”¶çš„ Class æ–‡ä»¶**(åœ¨è‡ªå®šä¹‰RPCä¼ è¾“åè®®æ—¶ä¹ŸåŠ å…¥äº†æ ‡è®°å¤´ `Magic`)





**Constant Pool å¸¸é‡æ± (æœ€é‡è¦ï¼ï¼):**

Java è™šæ‹Ÿæœºæ˜¯åœ¨åŠ è½½å­—èŠ‚ç æ–‡ä»¶çš„æ—¶å€™æ‰è¿›è¡Œçš„åŠ¨æ€é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå­—æ®µå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨åªæœ‰ç»è¿‡è¿è¡ŒæœŸè½¬æ¢åæ‰èƒ½è·å¾—çœŸæ­£çš„å†…å­˜åœ°å€ã€‚**å½“ Java è™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œéœ€è¦ä»å¸¸é‡æ± è·å–å¯¹åº”çš„ç¬¦å·å¼•ç”¨ï¼Œç„¶ååœ¨ç±»åˆ›å»ºæˆ–è€…è¿è¡Œæ—¶è§£æå¹¶ç¿»è¯‘åˆ°å…·ä½“çš„å†…å­˜åœ°å€ä¸Š**

```java
    u2             constant_pool_count;//å¸¸é‡æ± çš„æ•°é‡
    cp_info        constant_pool[constant_pool_count-1];//å¸¸é‡æ± 
```

å¸¸é‡æ± ä¸»è¦å­˜æ”¾ä¸¤å¤§å¸¸é‡ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘äº Java è¯­è¨€å±‚é¢çš„çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚**æ–‡æœ¬å­—ç¬¦ä¸²ã€å£°æ˜ä¸º final çš„å¸¸é‡å€¼**ç­‰ã€‚è€Œç¬¦å·å¼•ç”¨(ç´¢å¼•)åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µã€‚åŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š

- ç±»å’Œæ¥å£çš„å…¨é™å®šå
- å­—æ®µçš„åç§°å’Œæè¿°ç¬¦
- æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦

Java å®šä¹‰äº† booleanã€byteã€shortã€char å’Œ int ç­‰åŸºæœ¬æ•°æ®ç±»å‹ï¼Œ**å®ƒä»¬åœ¨å¸¸é‡æ± ä¸­éƒ½ä¼šè¢«å½“åš int æ¥å¤„ç†(0x03)**ï¼Œæˆ‘ä»¬æ¥é€šè¿‡ä¸€æ®µç®€å•çš„ Java ä»£ç äº†è§£ä¸‹ï¼š

```java
public class ConstantTest {
    public final boolean bool = true;
    public final char aChar = 'a';
    public final byte b = 66;
    public final short s = 67;
    public final int i = 68;
}
```

å¸ƒå°”å€¼ true çš„åå…­è¿›åˆ¶æ˜¯ 0x01ã€å­—ç¬¦ a çš„åå…­è¿›åˆ¶æ˜¯ 0x61ï¼Œå­—èŠ‚ 66 çš„åå…­è¿›åˆ¶æ˜¯ 0x42ï¼ŒçŸ­æ•´å‹ 67 çš„åå…­è¿›åˆ¶æ˜¯ 0x43ï¼Œæ•´å‹ 68 çš„åå…­è¿›åˆ¶æ˜¯ 0x44ã€‚æ‰€ä»¥ç¼–è¯‘ç”Ÿæˆçš„æ•´å‹å¸¸é‡åœ¨ class æ–‡ä»¶ä¸­çš„ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-file-jiegou-bbe4c673-c3a.png" style="zoom:50%;" />

ç¬¬ä¸€ä¸ªå­—èŠ‚ 0x03 è¡¨ç¤ºå¸¸é‡çš„ç±»å‹ä¸º *CONSTANT_Integer_info*ï¼Œæ˜¯ JVM ä¸­å®šä¹‰çš„ 14 ç§å¸¸é‡ç±»å‹ä¹‹ä¸€ï¼Œå¯¹åº”çš„è¿˜æœ‰ *CONSTANT_Float_info*ã€*CONSTANT_Long_info*ã€*CONSTANT_Double_info*ï¼Œå¯¹åº”çš„æ ‡è¯†åˆ†åˆ«æ˜¯ 0x04ã€0x05ã€0x06



æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€æ®µä»£ç :

```java
class Hello {
    public final String s = "hello";
}
```

â€œhelloâ€æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒçš„åå…­è¿›åˆ¶ä¸º `68 65 6c 6c 6f`ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒåœ¨ class æ–‡ä»¶ä¸­çš„ä½ç½®ã€‚

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-file-jiegou-801ed589-658c-407e-ac64-81fd525d7324.png" style="zoom:50%;" />

å‰é¢è¿˜æœ‰ 3 ä¸ªå­—èŠ‚ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ 0x01 æ˜¯æ ‡è¯†ï¼Œæ ‡è¯†ç±»å‹ä¸º *CONSTANT_Uft8_info*(UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²)ï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªè‡ªå·± 0x00 0x05 ç”¨æ¥è¡¨ç¤ºç¬¬ä¸‰éƒ¨åˆ†å­—èŠ‚æ•°ç»„çš„é•¿åº¦

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-file-jiegou-string.png" style="zoom:50%;" />

ä¸ *`CONSTANT_Uft8_info`* ç±»å‹å¯¹åº”çš„ï¼Œè¿˜æœ‰ä¸€ä¸ª *`CONSTANT_String_info`*ï¼Œç”¨æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å¯¹è±¡ï¼ˆä¹‹å‰ä»£ç ä¸­çš„ sï¼‰ï¼Œæ ‡è¯†æ˜¯ 0x08ã€‚å‰è€…å­˜å‚¨äº†å­—ç¬¦ä¸²çœŸæ­£çš„å€¼ï¼Œåè€…å¹¶ä¸åŒ…å«å­—ç¬¦ä¸²çš„å†…å®¹ï¼Œä»…ä»…åŒ…å«äº†ä¸€ä¸ªæŒ‡å‘å¸¸é‡æ± ä¸­ *`CONSTANT_Uft8_info`* çš„ç´¢å¼•ã€‚

*CONSTANT_String_info* é€šè¿‡ç´¢å¼• 19 æ¥æ‰¾åˆ° *CONSTANT_Uft8_info*:

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/1.png)





**è®¿é—®æ ‡å¿— `Access Flags`:**

ç´§è·Ÿç€å¸¸é‡æ± ä¹‹åçš„åŒºåŸŸå°±æ˜¯è®¿é—®æ ‡è®°ï¼ˆ`Access flags`ï¼‰ï¼Œè¿™ä¸ªæ ‡è®°ç”¨äºè¯†åˆ«ç±»æˆ–æ¥å£çš„è®¿é—®ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´åˆ°åº•æ˜¯ `class` è¿˜æ˜¯ `interface`ï¼Ÿæ˜¯ `public` å—ï¼Ÿæ˜¯ `abstract` æŠ½è±¡ç±»å—ï¼Ÿæ˜¯ `final` ç±»å—ï¼Ÿç­‰ç­‰ã€‚æ€»å…±æœ‰ 16 ä¸ªæ ‡è®°ä½å¯ä¾›ä½¿ç”¨ï¼Œä½†å¸¸ç”¨çš„åªæœ‰å…¶ä¸­ 7 ä¸ª

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-file-jiegou.png" style="zoom:67%;" />

æ¥çœ‹ä¸€ä¸ªç®€å•çš„æšä¸¾ä»£ç 

```java
public enum Color {
    RED,GREEN,BLUE;
}
```

é€šè¿‡ `jclasslib` å¯ä»¥çœ‹åˆ°è®¿é—®æ ‡è®°çš„ä¿¡æ¯æœ‰ `0x4031 [public final enum]`:

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-file-jiegou-dddd.png" style="zoom: 40%;" />





`this_classã€super_classã€interfaces:`

Java ç±»çš„ç»§æ‰¿å…³ç³»ç”±ç±»ç´¢å¼•ã€çˆ¶ç±»ç´¢å¼•å’Œæ¥å£ç´¢å¼•é›†åˆä¸‰é¡¹ç¡®å®šã€‚

**ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„å…¨é™å®šå**ï¼Œ**çˆ¶ç±»ç´¢å¼•ç”¨äºç¡®å®šè¿™ä¸ªç±»çš„çˆ¶ç±»çš„å…¨é™å®šå**ï¼Œç”±äº Java è¯­è¨€çš„å•ç»§æ‰¿ï¼Œæ‰€ä»¥çˆ¶ç±»ç´¢å¼•åªæœ‰ä¸€ä¸ªï¼Œé™¤äº† `java.lang.Object` ä¹‹å¤–ï¼Œæ‰€æœ‰çš„ Java ç±»éƒ½æœ‰çˆ¶ç±»ï¼Œ**å› æ­¤é™¤äº† `java.lang.Object` å¤–ï¼Œæ‰€æœ‰ Java ç±»çš„çˆ¶ç±»ç´¢å¼•éƒ½ä¸ä¸º 0**

**æ¥å£ç´¢å¼•é›†åˆç”¨æ¥æè¿°è¿™ä¸ªç±»å®ç°äº†é‚£äº›æ¥å£**ï¼Œè¿™äº›è¢«å®ç°çš„æ¥å£å°†æŒ‰ `implements` (å¦‚æœè¿™ä¸ªç±»æœ¬èº«æ˜¯æ¥å£çš„è¯åˆ™æ˜¯`extends`) åçš„æ¥å£é¡ºåºä»å·¦åˆ°å³æ’åˆ—åœ¨æ¥å£ç´¢å¼•é›†åˆä¸­

é€šè¿‡ `jclasslib` æ’ä»¶å¯ä»¥çœ‹åˆ°`TeachplanServiceImpl`ç±»çš„ç»§æ‰¿å…³ç³»:

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/jclasslib.png)





**å­—æ®µè¡¨ã€æ–¹æ³•è¡¨ã€å±æ€§è¡¨ï¼š**

```java
u2             fields_count;//Class æ–‡ä»¶çš„å­—æ®µå±æ€§æ•°é‡
field_info     fields[fields_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªå­—æ®µ
u2             methods_count;//Class æ–‡ä»¶çš„æ–¹æ³•æ•°é‡
method_info    methods[methods_count];//ä¸€ä¸ªç±»å¯ä»¥æœ‰ä¸ªå¤šä¸ªæ–¹æ³•
u2             attributes_count;//æ­¤ç±»çš„å±æ€§è¡¨ä¸­çš„å±æ€§æ•°
attribute_info attributes[attributes_count];//å±æ€§è¡¨é›†åˆ
```

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/jclass2.png" style="zoom: 67%;" />





## å¸¸é‡æ± åˆ†æ :grey_question:

è§‚å¯Ÿä»¥ä¸‹å­—èŠ‚ç æ–‡ä»¶ï¼š

```java
Classfile /Users/maweiqing/Documents/GitHub/TechSisterLearnJava/codes/TechSister/target/classes/com/itwanger/jvm/Main.class
  Last modified 2021å¹´4æœˆ15æ—¥; size 385 bytes
  SHA-256 checksum 6688843e4f70ae8d83040dc7c8e2dd3694bf10ba7c518a6ea9b88b318a8967c6
  Compiled from "Main.java"
public class com.itwanger.jvm.Main
  minor version: 0
  major version: 55
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER
  this_class: #3                          // com/itwanger/jvm/Main
  super_class: #4                         // java/lang/Object
  interfaces: 0, fields: 1, methods: 2, attributes: 1
Constant pool:
   #1 = Methodref          #4.#18         // java/lang/Object."<init>":()V
   #2 = Fieldref           #3.#19         // com/itwanger/jvm/Main.age:I
   #3 = Class              #20            // com/itwanger/jvm/Main
   #4 = Class              #21            // java/lang/Object
   #5 = Utf8               age
   #6 = Utf8               I
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               LocalVariableTable
  #12 = Utf8               this
  #13 = Utf8               Lcom/itwanger/jvm/Main;
  #14 = Utf8               getAge
  #15 = Utf8               ()I
  #16 = Utf8               SourceFile
  #17 = Utf8               Main.java
  #18 = NameAndType        #7:#8          // "<init>":()V
  #19 = NameAndType        #5:#6          // age:I
  #20 = Utf8               com/itwanger/jvm/Main
  #21 = Utf8               java/lang/Object
{
      
   //å­—æ®µè¡¨é›†åˆ æ­¤ä¾‹ä¸­åªæœ‰ä¸€ä¸ªintç±»å‹çš„ageå­—æ®µ
  private int age;
    descriptor: I
    flags: (0x0002) ACC_PRIVATE  
   
   //æ–¹æ³•è¡¨é›†åˆ  
        //mainæ–¹æ³•
  public com.itwanger.jvm.Main();
    descriptor: ()V
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=2, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: aload_0
         5: bipush        18
         7: putfield      #2                  // Field age:I
        10: return
      LineNumberTable:
        line 6: 0
        line 7: 4
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      11     0  this   Lcom/itwanger/jvm/Main;

      //getAgeæ–¹æ³•
  public int getAge();
    descriptor: ()I
    flags: (0x0001) ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: getfield      #2                  // Field age:I
         4: ireturn
      LineNumberTable:
        line 9: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Lcom/itwanger/jvm/Main;
}
SourceFile: "Main.java"

```

**Java è™šæ‹Ÿæœºæ˜¯åœ¨åŠ è½½å­—èŠ‚ç æ–‡ä»¶çš„æ—¶å€™æ‰è¿›è¡Œçš„åŠ¨æ€é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå­—æ®µå’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨åªæœ‰ç»è¿‡è¿è¡ŒæœŸè½¬æ¢åæ‰èƒ½è·å¾—çœŸæ­£çš„å†…å­˜åœ°å€ã€‚å½“ Java è™šæ‹Ÿæœºè¿è¡Œæ—¶ï¼Œéœ€è¦ä»å¸¸é‡æ± è·å–å¯¹åº”çš„ç¬¦å·å¼•ç”¨ï¼Œç„¶ååœ¨ç±»åˆ›å»ºæˆ–è€…è¿è¡Œæ—¶è§£æå¹¶ç¿»è¯‘åˆ°å…·ä½“çš„å†…å­˜åœ°å€ä¸Š**

å½“å‰å­—èŠ‚ç æ–‡ä»¶ä¸­ä¸€å…±æœ‰ 21 ä¸ªå¸¸é‡ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯æœ‰é“¾æ¥çš„ï¼Œé€ä¸ªåˆ†æä¼šæ¯”è¾ƒä¹±ï¼Œæˆ‘ä»¬é‡‡ç”¨é¡ºè—¤æ‘¸ç“œçš„æ–¹å¼ï¼Œä»ä¸Šä¾æ¬¡å¾€ä¸‹çœ‹ï¼Œé‚£äº›è¢«é“¾æ¥çš„å¸¸é‡æˆ‘ä»¬å°±ç‚¹åˆ°ä¸ºæ­¢

*æ³¨*ï¼š

- `#` å·åé¢è·Ÿçš„æ˜¯ç´¢å¼•ï¼Œç´¢å¼•æ²¡æœ‰ä» 0 å¼€å§‹è€Œæ˜¯ä» 1 å¼€å§‹ï¼Œæ˜¯å› ä¸ºè®¾è®¡è€…è€ƒè™‘åˆ°ï¼Œâ€œå¦‚æœè¦è¡¨è¾¾ä¸å¼•ç”¨ä»»ä½•ä¸€ä¸ªå¸¸é‡çš„å«ä¹‰æ—¶ï¼Œå¯ä»¥å°†ç´¢å¼•å€¼è®¾ä¸º 0 æ¥è¡¨ç¤ºâ€ï¼ˆã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹æè¿°çš„ï¼‰
- `=` å·åé¢è·Ÿçš„æ˜¯å¸¸é‡çš„ç±»å‹ï¼Œæ²¡æœ‰åŒ…å«å‰ç¼€ `CONSTANT_` å’Œåç¼€ `_info`



ç¬¬ 1 ä¸ªå¸¸é‡ï¼š

```text
#1 = Methodref          #4.#18         // java/lang/Object."<init>":()V
```

ç±»å‹ä¸º Methodrefï¼Œè¡¨æ˜æ˜¯ç”¨æ¥å®šä¹‰æ–¹æ³•çš„ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­ä¸‹æ ‡ä¸º 4 å’Œ 18 çš„å¸¸é‡ã€‚

ç¬¬ 4 ä¸ªå¸¸é‡ï¼š

```text
#4 = Class              #21            // java/lang/Object
```

ç±»å‹ä¸º Classï¼Œè¡¨æ˜æ˜¯ç”¨æ¥å®šä¹‰ç±»ï¼ˆæˆ–è€…æ¥å£ï¼‰çš„ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­ä¸‹æ ‡ä¸º 21 çš„å¸¸é‡ã€‚

ç¬¬ 21 ä¸ªå¸¸é‡ï¼š

```text
#21 = Utf8               java/lang/Object
```

ç±»å‹ä¸º Utf8ï¼ŒUTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå€¼ä¸º `java/lang/Object`ã€‚

ç¬¬ 18 ä¸ªå¸¸é‡ï¼š

```text
#18 = NameAndType        #7:#8          // "<init>":()V
```

ç±»å‹ä¸º NameAndTypeï¼Œè¡¨æ˜æ˜¯å­—æ®µæˆ–è€…æ–¹æ³•çš„éƒ¨åˆ†ç¬¦å·å¼•ç”¨ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­ä¸‹æ ‡ä¸º 7 å’Œ 8 çš„å¸¸é‡ã€‚

ç¬¬ 7 ä¸ªå¸¸é‡ï¼š

```text
#7 = Utf8               <init>
```

ç±»å‹ä¸º Utf8ï¼ŒUTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå€¼ä¸º `<init>`ï¼Œè¡¨æ˜ä¸ºæ„é€ æ–¹æ³•ã€‚

ç¬¬ 8 ä¸ªå¸¸é‡ï¼š

```text
#8 = Utf8               ()V
```

ç±»å‹ä¸º Utf8ï¼ŒUTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå€¼ä¸º `()V`ï¼Œè¡¨æ˜æ–¹æ³•çš„è¿”å›å€¼ä¸º voidã€‚

åˆ°æ­¤ä¸ºæ­¢ï¼Œç¬¬ 1 ä¸ªå¸¸é‡ç®—æ˜¯æ‘¸å®Œäº†ã€‚ç»„åˆèµ·æ¥çš„æ„æ€å°±æ˜¯ï¼ŒMain ç±»ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œæ¥æºäº Object ç±»ã€‚





ç¬¬ 2 ä¸ªå¸¸é‡ï¼š

```text
#2 = Fieldref           #3.#19         // com/itwanger/jvm/Main.age:I
```

ç±»å‹ä¸º Fieldrefï¼Œè¡¨æ˜æ˜¯ç”¨æ¥å®šä¹‰å­—æ®µçš„ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­ä¸‹æ ‡ä¸º 3 å’Œ 19 çš„å¸¸é‡ã€‚

ç¬¬ 3 ä¸ªå¸¸é‡ï¼š

```text
#3 = Class              #20            // com/itwanger/jvm/Main
```

ç±»å‹ä¸º Classï¼Œè¡¨æ˜æ˜¯ç”¨æ¥å®šä¹‰ç±»ï¼ˆæˆ–è€…æ¥å£ï¼‰çš„ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­ä¸‹æ ‡ä¸º 20 çš„å¸¸é‡ã€‚

ç¬¬ 19 ä¸ªå¸¸é‡ï¼š

```text
#19 = NameAndType        #5:#6          // age:I
```

ç±»å‹ä¸º NameAndTypeï¼Œè¡¨æ˜æ˜¯å­—æ®µæˆ–è€…æ–¹æ³•çš„éƒ¨åˆ†ç¬¦å·å¼•ç”¨ï¼ŒæŒ‡å‘å¸¸é‡æ± ä¸­ä¸‹æ ‡ä¸º 5 å’Œ 6 çš„å¸¸é‡ã€‚

ç¬¬ 5 ä¸ªå¸¸é‡ï¼š

```text
#5 = Utf8               age
```

ç±»å‹ä¸º Utf8ï¼ŒUTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå€¼ä¸º `age`ï¼Œè¡¨æ˜å­—æ®µåä¸º ageã€‚

ç¬¬ 6 ä¸ªå¸¸é‡ï¼š

```text
#6 = Utf8               I
```

ç±»å‹ä¸º Utf8ï¼ŒUTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå€¼ä¸º `I`ï¼Œè¡¨æ˜å­—æ®µçš„ç±»å‹ä¸º int













## JVMå†…å­˜ç»“æ„



Java æºä»£ç æ–‡ä»¶ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘åç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶åäº¤ç»™ JVM çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½å®Œæ¯•åï¼Œäº¤ç»™æ‰§è¡Œå¼•æ“æ‰§è¡Œã€‚åœ¨æ•´ä¸ªæ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒJVM ä¼šç”¨ä¸€å—ç©ºé—´æ¥å­˜å‚¨ç¨‹åºæ‰§è¡ŒæœŸé—´éœ€è¦ç”¨åˆ°çš„æ•°æ®ï¼Œè¿™å—ç©ºé—´ä¸€èˆ¬è¢«ç§°ä¸ºè¿è¡Œæ—¶æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„ JVM å†…å­˜åŒºåŸŸ



jdk1.7ä¹‹å‰ï¼š







jdk1.7:

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-runtime-data-areas-jdk1.7.png" style="zoom: 67%;" />





jdk1.8:

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/java-runtime-data-areas-jdk1.8.png" style="zoom:67%;" />

**çº¿ç¨‹ç§æœ‰çš„ï¼š**

- ç¨‹åºè®¡æ•°å™¨
- è™šæ‹Ÿæœºæ ˆ
- æœ¬åœ°æ–¹æ³•æ ˆ

**çº¿ç¨‹å…±äº«çš„ï¼š**

- å †
- æ–¹æ³•åŒº
- ç›´æ¥å†…å­˜ (éè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†)

> ä»€ä¹ˆæ˜¯**ç›´æ¥å†…å­˜**ï¼Ÿ
>
> 
>
> åœ¨Javaä¸­ï¼Œé€šå¸¸ä½¿ç”¨`java.nio`åŒ…ä¸­çš„`ByteBuffer`ç±»æ¥ä½¿ç”¨ç›´æ¥å†…å­˜ã€‚`ByteBuffer`ç±»æä¾›äº†ä¸€ç§åœ¨JVMä¸­åˆ†é…ç›´æ¥å†…å­˜çš„æ–¹æ³•ï¼Œé€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥è·å¾—æ›´é«˜æ•ˆçš„I/Oæ“ä½œå’Œå‡å°‘å†…å­˜æ‹·è´çš„å¼€é”€
>
> ç›´æ¥å†…å­˜çš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š
>
> 1. **éå †å†…å­˜ï¼š** **ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯Javaè™šæ‹Ÿæœºçš„å †å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯åœ¨æœ¬åœ°å†…å­˜ä¸­åˆ†é…çš„**ï¼Œè¿™ä½¿å¾—ç›´æ¥å†…å­˜åœ¨åˆ†é…å’Œå›æ”¶æ—¶ä¸å—Javaå †çš„é™åˆ¶
> 2. **é›¶æ‹·è´ï¼š** ç›´æ¥å†…å­˜ä¸Javaå †å†…å­˜ä¹‹é—´çš„æ•°æ®äº¤æ¢å¯ä»¥é€šè¿‡`java.nio`åŒ…ä¸­çš„é€šé“ï¼ˆChannelï¼‰å’Œç¼“å†²åŒºï¼ˆBufferï¼‰è¿›è¡Œã€‚ä½¿ç”¨ç›´æ¥å†…å­˜å¯ä»¥å®ç°**é›¶æ‹·è´**ï¼Œå‡å°‘äº†æ•°æ®åœ¨Javaå †å’Œæœ¬åœ°å†…å­˜ä¹‹é—´çš„æ‹·è´æ¬¡æ•°ï¼Œæé«˜äº†I/Oæ“ä½œçš„æ•ˆç‡
> 3. **é‡Šæ”¾æ–¹å¼ï¼š** **ç›´æ¥å†…å­˜çš„é‡Šæ”¾é€šå¸¸ç”±Javaè™šæ‹Ÿæœºå¤–çš„æ“ä½œç³»ç»Ÿè´Ÿè´£ï¼Œè€Œä¸æ˜¯ç”±Javaè™šæ‹Ÿæœºçš„åƒåœ¾å›æ”¶å™¨æ¥å¤„ç†**ã€‚è¿™æ„å‘³ç€ç›´æ¥å†…å­˜çš„é‡Šæ”¾å¯èƒ½ä¸ä¼šåƒJavaå †å†…å­˜ä¸€æ ·åŠæ—¶è¿›è¡Œï¼Œéœ€è¦æ³¨æ„é˜²æ­¢è¿‡åº¦ä½¿ç”¨ç›´æ¥å†…å­˜
> 4. ç›´æ¥å†…å­˜æ˜¯ä¸€ç§ç‰¹æ®Šçš„å†…å­˜ç¼“å†²åŒºï¼Œæ˜¯é€šè¿‡ JNI çš„æ–¹å¼åœ¨æœ¬åœ°å†…å­˜ä¸Šåˆ†é…çš„ï¼Œä¾‹å¦‚`UnSafe`ç±»ä¸­åˆ†é…å†…å­˜çš„å‡½æ•°



å…ˆä»çº¿ç¨‹ç§æœ‰çš„éƒ¨åˆ†è®¨è®º:



### **ç¨‹åºè®¡æ•°å™¨**

ç¨‹åºè®¡æ•°å™¨æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥**é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤**ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆ

å¦å¤–ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œ**æ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„çº¿ç¨‹ä¹‹é—´è®¡æ•°å™¨äº’ä¸å½±å“**ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸ºâ€œçº¿ç¨‹ç§æœ‰â€çš„å†…å­˜

å½“çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ä¼šè®°å½•å½“å‰æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€æˆ–ç´¢å¼•ã€‚å½“çº¿ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ä¼šè¢«æ›´æ–°ä¸ºæ–°æ–¹æ³•çš„å¼€å§‹åœ°å€æˆ–ç´¢å¼•ã€‚å› æ­¤ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨ä¸åŒæ–¹æ³•ä¹‹é—´è¿›è¡Œåˆ‡æ¢æ—¶èµ·åˆ°äº†å¯¼èˆªçš„ä½œç”¨

ç¨‹åºè®¡æ•°å™¨çš„å€¼æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œé€šå¸¸ä»¥å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€æˆ–ç´¢å¼•è¡¨ç¤ºã€‚å­—èŠ‚ç æŒ‡ä»¤æ˜¯ä¸€ç³»åˆ—ç”¨äºæ‰§è¡ŒJavaç¨‹åºçš„åŸºæœ¬æŒ‡ä»¤ï¼ŒJVMæ ¹æ®ç¨‹åºè®¡æ•°å™¨ä¸­çš„åœ°å€æˆ–ç´¢å¼•æ¥è·å–å½“å‰è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œç„¶åè¿›è¡Œè§£é‡Šå’Œæ‰§è¡Œ



ä»ä¸Šé¢çš„ä»‹ç»ä¸­æˆ‘ä»¬çŸ¥é“äº†ç¨‹åºè®¡æ•°å™¨ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š

- å­—èŠ‚ç è§£é‡Šå™¨é€šè¿‡æ”¹å˜ç¨‹åºè®¡æ•°å™¨æ¥ä¾æ¬¡è¯»å–æŒ‡ä»¤ï¼Œä»è€Œå®ç°ä»£ç çš„æµç¨‹æ§åˆ¶ï¼Œå¦‚ï¼šé¡ºåºæ‰§è¡Œã€é€‰æ‹©ã€å¾ªç¯ã€å¼‚å¸¸å¤„ç†
- **åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œç¨‹åºè®¡æ•°å™¨ç”¨äºè®°å½•å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œä»è€Œå½“çº¿ç¨‹è¢«åˆ‡æ¢å›æ¥çš„æ—¶å€™èƒ½å¤ŸçŸ¥é“è¯¥çº¿ç¨‹ä¸Šæ¬¡è¿è¡Œåˆ°å“ªå„¿äº†**

**æ³¨æ„ï¼š**ç¨‹åºè®¡æ•°å™¨æ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‡ºç° `OutOfMemoryError` çš„å†…å­˜åŒºåŸŸï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„ç»“æŸè€Œæ­»äº¡

å¦‚æœçº¿ç¨‹æ‰§è¡Œçš„æ˜¯éæœ¬åœ°ï¼ˆ`native`ï¼‰æ–¹æ³•ï¼Œåˆ™ç¨‹åºè®¡æ•°å™¨ä¸­ä¿å­˜çš„æ˜¯å½“å‰éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼›å¦‚æœçº¿ç¨‹æ‰§è¡Œçš„æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œåˆ™ç¨‹åºè®¡æ•°å™¨ä¸­çš„å€¼æ˜¯ `undefined`

ä¸ºä»€ä¹ˆæœ¬åœ°æ–¹æ³•åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„å€¼æ˜¯ `undefined` çš„ï¼Ÿå› ä¸ºæœ¬åœ°æ–¹æ³•å¤§å¤šæ˜¯é€šè¿‡ C/C++ å®ç°çš„ï¼Œå¹¶æœªç¼–è¯‘æˆéœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚

ç”±äºç¨‹åºè®¡æ•°å™¨ä¸­å­˜å‚¨çš„æ•°æ®æ‰€å çš„ç©ºé—´ä¸ä¼šéšç¨‹åºçš„æ‰§è¡Œè€Œå‘ç”Ÿå¤§å°ä¸Šçš„æ”¹å˜ï¼Œå› æ­¤ï¼Œç¨‹åºè®¡æ•°å™¨æ˜¯ä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºç°è±¡(`OutOfMemory`)





### **Javaè™šæ‹Ÿæœºæ ˆ**

ä¸ç¨‹åºè®¡æ•°å™¨ä¸€æ ·ï¼ŒJava è™šæ‹Ÿæœºæ ˆï¼ˆåæ–‡ç®€ç§°æ ˆï¼‰ä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç›¸åŒï¼Œéšç€çº¿ç¨‹çš„åˆ›å»ºè€Œåˆ›å»ºï¼Œéšç€çº¿ç¨‹çš„æ­»äº¡è€Œæ­»äº¡ï¼›

æ ˆç»å¯¹ç®—çš„ä¸Šæ˜¯ JVM è¿è¡Œæ—¶æ•°æ®åŒºåŸŸçš„ä¸€ä¸ªæ ¸å¿ƒï¼Œé™¤äº†ä¸€äº› `Native` æ–¹æ³•è°ƒç”¨æ˜¯é€šè¿‡æœ¬åœ°æ–¹æ³•æ ˆå®ç°çš„(åé¢ä¼šæåˆ°)ï¼Œå…¶ä»–æ‰€æœ‰çš„ Java æ–¹æ³•è°ƒç”¨éƒ½æ˜¯é€šè¿‡æ ˆæ¥å®ç°çš„ï¼ˆä¹Ÿéœ€è¦å’Œå…¶ä»–è¿è¡Œæ—¶æ•°æ®åŒºåŸŸæ¯”å¦‚ç¨‹åºè®¡æ•°å™¨é…åˆï¼‰ï¼›

Java è™šæ‹Ÿæœºæ ˆä¸­æ˜¯ä¸€ä¸ªä¸ªæ ˆå¸§ï¼Œ**æ¯ä¸ªæ ˆå¸§å¯¹åº”ä¸€ä¸ªè¢«è°ƒç”¨çš„æ–¹æ³•**ã€‚å½“çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ ˆå¸§ï¼Œå¹¶å°†æ ˆå¸§å‹å…¥æ ˆä¸­ã€‚å½“æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œå°†æ ˆå¸§ä»æ ˆä¸­ç§»é™¤ã€‚æ ˆéµå¾ªçš„æ˜¯**åè¿›å…ˆå‡º**çš„åŸåˆ™ï¼Œæ‰€ä»¥**çº¿ç¨‹å½“å‰æ‰§è¡Œçš„æ–¹æ³•å¯¹åº”çš„æ ˆå¸§å¿…å®šåœ¨ Java è™šæ‹Ÿæœºæ ˆçš„é¡¶éƒ¨**(æ¯ä¸ªæ ˆå¸§ä¸­éƒ½æ‹¥æœ‰ï¼š**å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•è¿”å›åœ°å€**)ï¼›

- JVM ç›´æ¥å¯¹ Java æ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå¯¹æ ˆå¸§çš„**å‹æ ˆ**å’Œ**å‡ºæ ˆ**ï¼Œéµå¾ªâ€œå…ˆè¿›åå‡º/åè¿›å…ˆå‡ºâ€åŸåˆ™

- åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆ**æ ˆé¡¶æ ˆå¸§**ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸º**å½“å‰æ ˆå¸§**ï¼ˆCurrent Frameï¼‰ï¼Œä¸å½“å‰æ ˆå¸§å¯¹åº”çš„æ–¹æ³•å°±æ˜¯**å½“å‰æ–¹æ³•**ï¼ˆCurrent Methodï¼‰ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯**å½“å‰ç±»**ï¼ˆCurrent Classï¼‰
- æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œ
- å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œç§°ä¸ºæ–°çš„å½“å‰æ ˆå¸§
- ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªæ ˆå¸§ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§
- å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§
- Java æ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼Œ**ä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨ return æŒ‡ä»¤ï¼Œå¦ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ç®¡ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡º**

> æ ˆç©ºé—´è™½ç„¶ä¸æ˜¯æ— é™çš„ï¼Œä½†ä¸€èˆ¬æ­£å¸¸è°ƒç”¨çš„æƒ…å†µä¸‹æ˜¯ä¸ä¼šå‡ºç°é—®é¢˜çš„ã€‚ä¸è¿‡ï¼Œå¦‚æœå‡½æ•°è°ƒç”¨é™·å…¥æ— é™å¾ªç¯çš„è¯ï¼Œå°±ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹çš„JVMæ ˆä¸­è¢«å‹å…¥å¤ªå¤šæ ˆå¸§è€Œå ç”¨å¤ªå¤šç©ºé—´ï¼Œå¯¼è‡´æ ˆç©ºé—´è¿‡æ·±ã€‚é‚£ä¹ˆå½“çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦çš„æ—¶å€™ï¼Œå°±æŠ›å‡º `StackOverFlowError`é”™è¯¯
>
> 
>
> åœ¨ä½¿ç”¨Javaå‘½ä»¤å¯åŠ¨Javaç¨‹åºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨`-Xss`å‚æ•°æ¥è®¾ç½®æ ˆçš„å¤§å° (stack-size)
>
> ```java
> java -Xss1m MyClass
> ```
>
> é™¤äº† `StackOverFlowError` é”™è¯¯ä¹‹å¤–ï¼Œæ ˆè¿˜å¯èƒ½ä¼šå‡ºç°`OutOfMemoryError`é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœæ ˆçš„å†…å­˜å¤§å°å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œ å¦‚æœè™šæ‹Ÿæœºåœ¨åŠ¨æ€æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡º`OutOfMemoryError`å¼‚å¸¸
>
>  
>
>
>
> ç®€å•æ€»ç»“ä¸€ä¸‹ç¨‹åºè¿è¡Œä¸­æ ˆå¯èƒ½ä¼šå‡ºç°ä¸¤ç§é”™è¯¯ï¼š
>
> - **`StackOverFlowError`ï¼š** è‹¥æ ˆçš„å†…å­˜å¤§å°ä¸å…è®¸åŠ¨æ€æ‰©å±•ï¼Œé‚£ä¹ˆå½“**çº¿ç¨‹è¯·æ±‚æ ˆçš„æ·±åº¦è¶…è¿‡å½“å‰ Java è™šæ‹Ÿæœºæ ˆçš„æœ€å¤§æ·±åº¦**çš„æ—¶å€™ï¼Œå°±æŠ›å‡º `StackOverFlowError` é”™è¯¯ã€‚
> - **`OutOfMemoryError`ï¼š** å¦‚æœæ ˆçš„å†…å­˜å¤§å°å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œ å¦‚æœè™šæ‹Ÿæœºåœ¨åŠ¨æ€æ‰©å±•æ ˆæ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™æŠ›å‡º`OutOfMemoryError`å¼‚å¸¸
>
> 



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/neicun-jiegou-1.png" style="zoom:67%;" />





(1) **å±€éƒ¨å˜é‡è¡¨ï¼š**

- å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–è€…æœ¬åœ°å˜é‡è¡¨
- æ˜¯ä¸€ç»„å˜é‡å€¼å­˜å‚¨ç©ºé—´ï¼Œ**ä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°(åŒ…å«äº†æ–¹æ³•çš„è¾“å…¥å‚æ•°å’Œå¯¹äºéé™æ€æ–¹æ³•çš„éšå«thisæŒ‡é’ˆ)å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡**ï¼ŒåŒ…æ‹¬ç¼–è¯‘å™¨å¯çŸ¥çš„å„ç§ `Java` è™šæ‹Ÿæœº**åŸºæœ¬æ•°æ®ç±»å‹**ï¼ˆ`booleanã€byteã€charã€shortã€intã€floatã€longã€double`ï¼‰ã€**å¯¹è±¡å¼•ç”¨**(æœ€å¸¸è§çš„)
- ä¸åŒæ•°æ®ç±»å‹çš„å±€éƒ¨å˜é‡å æ®ä¸åŒçš„**æ§½ä½**ï¼ˆ`Slot`ï¼‰ï¼Œä¾‹å¦‚`int`ç±»å‹å ç”¨ä¸€ä¸ªæ§½ä½ï¼Œ`long`å’Œ`double`ç±»å‹å ç”¨ä¸¤ä¸ªæ§½ä½
- JVM ä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ª `Slot` éƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ï¼Œç´¢å¼•å€¼çš„èŒƒå›´ä» 0 å¼€å§‹åˆ°å±€éƒ¨å˜é‡è¡¨æœ€å¤§çš„ `Slot` æ•°é‡
- å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨ this å°†ä¼šå­˜æ”¾åœ¨ index ä¸º 0 çš„ Slot å¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åˆ—ï¼ˆè¿™é‡Œå°±å¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼š**é™æ€æ–¹æ³•ä¸­ä¸ºä»€ä¹ˆä¸å¯ä»¥å¼•ç”¨ thisï¼Œå°±æ˜¯å› ä¸ºthis å˜é‡ä¸å­˜åœ¨äºå½“å‰æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ä¸­**ï¼‰
- ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤**ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜**
- **å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆ**ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯
- **å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–é—´æ¥å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶**

å½“ä¸€ä¸ªæ–¹æ³•å®šä¹‰å¦‚ä¸‹æ—¶ï¼š

```java
public int addNumbers(int a, int b) {
    int sum = a + b;
    int product = a * b;
    return sum + product;
}
```

åœ¨JVMçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œè¯¥æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å°†åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```shell
Slot 0: this (for non-static method, a reference to the current object)  #thisæŒ‡é’ˆ
Slot 1: a (method parameter)                   #aæ˜¯intç±»å‹ å ä¸€ä¸ªæ§½ä½
Slot 2: b (method parameter)
Slot 3: sum (local variable)
Slot 4: product (local variable)
```





(2) **æ“ä½œæ•°æ ˆï¼š**

æ¯ä¸ªç‹¬ç«‹çš„æ ˆå¸§ä¸­é™¤äº†åŒ…å«å±€éƒ¨å˜é‡è¡¨ä¹‹å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ª**åè¿›å…ˆå‡º**çš„æ“ä½œæ•°æ ˆï¼Œä¹Ÿå¯ä»¥ç§°ä¸º**è¡¨è¾¾å¼æ ˆ**ï¼ˆ`Expression Stack`ï¼‰

**æ“ä½œæ•°æ ˆåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ“ä½œæ•°æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆï¼ˆpushï¼‰ã€å‡ºæ ˆï¼ˆpopï¼‰**

æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆã€‚æ¯”å¦‚ï¼Œæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œ

å…¶ä½œç”¨å¦‚ä¸‹ï¼š

- æ“ä½œæ•°æ ˆï¼Œ**ä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´**

- æ“ä½œæ•°æ ˆå°±æ˜¯ JVM æ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œ**æ­¤æ—¶è¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„**
- æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ï¼Œè€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®
- **å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­**ï¼Œå¹¶æ›´æ–° PC å¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤
- å¦å¤–ï¼Œæˆ‘ä»¬è¯´**Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“æ˜¯åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“**ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆ

æ¥ç€çœ‹ä¸Šè¿°é‚£ä¸ªä¾‹å­ï¼š

```java
public int addNumbers(int a, int b) {
    int sum = a + b;
    int product = a * b;
    return sum + product;
}
```

1. **æ–¹æ³•å…¥æ ˆï¼š** æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå‚æ•°ä¼šè¢«å‹å…¥æ“ä½œæ•°æ ˆã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`addNumbers(2, 3)`æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå‚æ•°2å’Œ3ä¼šè¢«ä¾æ¬¡å‹å…¥æ“ä½œæ•°æ ˆï¼Œæ“ä½œæ•°æ ˆå˜ä¸ºï¼š`[2, 3]`ã€‚
2. **å±€éƒ¨å˜é‡å…¥æ ˆï¼š** æ–¹æ³•å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå±€éƒ¨å˜é‡è¡¨ä¸­çš„`a`å’Œ`b`ä¼šè¢«åŠ è½½åˆ°æ“ä½œæ•°æ ˆã€‚è¿™é‡Œ`a`å’Œ`b`çš„å€¼åˆ†åˆ«æ˜¯2å’Œ3ï¼Œæ‰€ä»¥æ“ä½œæ•°æ ˆå˜ä¸ºï¼š`[2, 3, 2, 3]`ã€‚
3. **æ‰§è¡Œ`a + b`ï¼š** æ‰§è¡Œ`int sum = a + b;`æ—¶ï¼Œä»æ“ä½œæ•°æ ˆä¸­ä¾æ¬¡å¼¹å‡ºä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ‰§è¡ŒåŠ æ³•æ“ä½œï¼Œç„¶åå°†ç»“æœ5å…¥æ ˆã€‚æ­¤æ—¶æ“ä½œæ•°æ ˆå˜ä¸ºï¼š`[5, 2, 3]`ã€‚
4. **æ‰§è¡Œ`a \* b`ï¼š** æ‰§è¡Œ`int product = a * b;`æ—¶ï¼Œä»æ“ä½œæ•°æ ˆä¸­ä¾æ¬¡å¼¹å‡ºä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ‰§è¡Œä¹˜æ³•æ“ä½œï¼Œç„¶åå°†ç»“æœ6å…¥æ ˆã€‚æ­¤æ—¶æ“ä½œæ•°æ ˆå˜ä¸ºï¼š`[6, 5]`ã€‚
5. **æ‰§è¡Œ`sum + product`ï¼š** æ‰§è¡Œ`return sum + product;`æ—¶ï¼Œä»æ“ä½œæ•°æ ˆä¸­ä¾æ¬¡å¼¹å‡ºä¸¤ä¸ªæ“ä½œæ•°ï¼ˆåˆ†åˆ«æ˜¯6å’Œ5ï¼‰ï¼Œæ‰§è¡ŒåŠ æ³•æ“ä½œï¼Œç„¶åå°†ç»“æœ11å…¥æ ˆã€‚æ­¤æ—¶æ“ä½œæ•°æ ˆå˜ä¸ºï¼š`[11]`ã€‚
6. **æ–¹æ³•è¿”å›ï¼š** æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œå°†æœ€ç»ˆçš„ç»“æœ11ä»æ“ä½œæ•°æ ˆä¸­å¼¹å‡ºï¼Œç„¶åè¿”å›ç»™æ–¹æ³•è°ƒç”¨è€…





å¯ä»¥è¿™ä¹ˆç†è§£ï¼š**å±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆçš„å…³ç³»å°±ç›¸å½“äºå½¢å‚å’Œå®å‚çš„å…³ç³»ä¸€æ ·**ã€‚ã€‚ã€‚ã€‚



(3) **åŠ¨æ€é“¾æ¥ï¼š** é’ˆå¯¹çš„æ˜¯æ–¹æ³•è°ƒç”¨â€”â€”â€”â€”**å¤šæ€**å°±æ˜¯è¿™æ ·å®ç°çš„

åŠ¨æ€é“¾æ¥å³è™šæ‹Ÿæ–¹æ³•è°ƒç”¨ï¼Œç”¨åˆ°äº†**æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± çš„æ–¹æ³•å¼•ç”¨**

ä¸»è¦æœåŠ¡ä¸€ä¸ªæ–¹æ³•éœ€è¦è°ƒç”¨å…¶ä»–æ–¹æ³•çš„åœºæ™¯ã€‚Class æ–‡ä»¶çš„å¸¸é‡æ± é‡Œä¿å­˜æœ‰å¤§é‡çš„ç¬¦å·å¼•ç”¨æ¯”å¦‚æ–¹æ³•å¼•ç”¨çš„ç¬¦å·å¼•ç”¨ã€‚å½“ä¸€ä¸ªæ–¹æ³•è¦è°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œéœ€è¦å°†å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºå…¶åœ¨å†…å­˜åœ°å€ä¸­çš„ç›´æ¥å¼•ç”¨ã€‚åŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿè¢«ç§°ä¸º **åŠ¨æ€é“¾æ¥**

**æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨**ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥(`Dynamic Linking`)ã€‚

**åœ¨ Java æºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ï¼ˆ`Symbolic Reference`ï¼‰ä¿å­˜åœ¨ Class æ–‡ä»¶çš„å¸¸é‡æ± ä¸­**ã€‚æ¯”å¦‚ï¼šæè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆ**åŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨(å†…å­˜åœ°å€)**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5.jpg" style="zoom:67%;" />



> question1:JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„?
>

æ–¹æ³•è°ƒç”¨ä¸åŒäºæ–¹æ³•æ‰§è¡Œï¼Œæ–¹æ³•è°ƒç”¨é˜¶æ®µçš„å”¯ä¸€ä»»åŠ¡å°±æ˜¯ç¡®å®šè¢«è°ƒç”¨æ–¹æ³•çš„ç‰ˆæœ¬ï¼ˆå³è°ƒç”¨å“ªä¸€ä¸ªæ–¹æ³•ï¼‰ï¼Œæš‚æ—¶è¿˜ä¸æ¶‰åŠæ–¹æ³•å†…éƒ¨çš„å…·ä½“è¿è¡Œè¿‡ç¨‹ã€‚Class æ–‡ä»¶çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ä¸åŒ…æ‹¬ä¼ ç»Ÿç¼–è¯‘å™¨ä¸­çš„è¿æ¥æ­¥éª¤ï¼Œ**ä¸€åˆ‡æ–¹æ³•è°ƒç”¨åœ¨ Classæ–‡ä»¶é‡Œé¢å­˜å‚¨çš„éƒ½æ˜¯ç¬¦å·å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ–¹æ³•åœ¨å®é™…è¿è¡Œæ—¶å†…å­˜å¸ƒå±€ä¸­çš„å…¥å£åœ°å€ï¼ˆç›´æ¥å¼•ç”¨ï¼‰**ã€‚ä¹Ÿå°±æ˜¯éœ€è¦åœ¨ç±»åŠ è½½é˜¶æ®µï¼Œç”šè‡³åˆ°è¿è¡ŒæœŸæ‰èƒ½ç¡®å®šç›®æ ‡æ–¹æ³•çš„ç›´æ¥å¼•ç”¨

>  question2:åœ¨ JVM ä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

- **é™æ€é“¾æ¥**ï¼šå½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿› JVM å†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„**ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥**ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ã€‚è¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥
- **åŠ¨æ€é“¾æ¥**ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**åªèƒ½åœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥**

å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼šæ—©æœŸç»‘å®šï¼ˆEarly Bindingï¼‰å’Œæ™šæœŸç»‘å®šï¼ˆLate Bindingï¼‰ã€‚**ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡**

- æ—©æœŸç»‘å®šï¼š**æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶**ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚
- æ™šæœŸç»‘å®šï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘å™¨æ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼å°±è¢«ç§°ä¸ºæ™šæœŸç»‘å®š







**(4) æ–¹æ³•è¿”å›åœ°å€:**

ç”¨äºè®°å½•æ–¹æ³•è°ƒç”¨ç»“æŸåçš„è¿”å›åœ°å€ï¼Œä»¥ä¾¿åœ¨æ–¹æ³•è¿”å›æ—¶è¿”å›åˆ°æ­£ç¡®çš„è°ƒç”¨ç‚¹,å³å­˜æ”¾äº†**è°ƒç”¨è¯¥æ–¹æ³•çš„ PC å¯„å­˜å™¨çš„å€¼**

ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼

- æ­£å¸¸æ‰§è¡Œå®Œæˆ
- å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º

æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›åˆ°è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„ PC è®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œ**ä¹‹åè°ƒç”¨è¯¥æ–¹æ³•å¯¹åº”å­—èŠ‚ç æŒ‡ä»¤åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€**ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šçš„ï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚





### æœ¬åœ°æ–¹æ³•æ ˆ

å’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š**è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³• ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ `Native` æ–¹æ³•æœåŠ¡( `Unsafe` ç±»å°±æœ‰å¾ˆå¤šæœ¬åœ°æ–¹æ³•),** åœ¨ `HotSpot` è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€

æœ¬åœ°æ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºå­˜æ”¾è¯¥æœ¬åœ°æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€å‡ºå£ä¿¡æ¯(è°ƒç”¨è€…çš„PCå¯„å­˜å™¨å€¼)

æ–¹æ³•æ‰§è¡Œå®Œæ¯•åç›¸åº”çš„æ ˆå¸§ä¹Ÿä¼šå‡ºæ ˆå¹¶é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œä¹Ÿä¼šå‡ºç° `StackOverFlowError` å’Œ `OutOfMemoryError` ä¸¤ç§é”™è¯¯

> ä¸ºä»€ä¹ˆéœ€è¦`native method`?
>
> - ä¸ Java ç¯å¢ƒå¤–äº¤äº’ï¼šæœ‰æ—¶ Java åº”ç”¨éœ€è¦ä¸ Java å¤–é¢çš„ç¯å¢ƒäº¤äº’ï¼Œè¿™å°±æ˜¯æœ¬åœ°æ–¹æ³•å­˜åœ¨çš„åŸå› 
> - ä¸æ“ä½œç³»ç»Ÿäº¤äº’ï¼šJVM æ”¯æŒ Java è¯­è¨€æœ¬èº«å’Œè¿è¡Œæ—¶åº“ï¼Œä½†æ˜¯æœ‰æ—¶ä»éœ€è¦ä¾èµ–ä¸€äº›åº•å±‚ç³»ç»Ÿçš„æ”¯æŒã€‚é€šè¿‡æœ¬åœ°æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç”¨ Java ä¸å®ç°äº† jre çš„åº•å±‚ç³»ç»Ÿäº¤äº’ï¼Œ JVM çš„ä¸€äº›éƒ¨åˆ†å°±æ˜¯ C è¯­è¨€å†™çš„
> - ç¨‹åºéœ€è¦ç”¨åˆ°Javaä¸å…·å¤‡çš„ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ç‰¹æ€§ï¼ŒJavaåœ¨å®ç°è·¨å¹³å°çš„åŒæ—¶è¦å®ç°å¯¹åº•å±‚çš„æ§åˆ¶ï¼Œè¿™å°±éœ€è¦å€ŸåŠ©å…¶ä»–è¯­è¨€
> - å¯¹äºå…¶ä»–è¯­è¨€å·²ç»å®Œæˆçš„ä¸€äº›ç°æˆåŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨Javaç›´æ¥è°ƒç”¨
> - ç¨‹åºå¯¹æ—¶é—´æ•æ„Ÿæˆ–å¯¹æ€§èƒ½è¦æ±‚éå¸¸é«˜æ—¶ï¼Œæœ‰å¿…è¦ä½¿ç”¨æ›´åŠ åº•å±‚çš„è¯­è¨€ï¼Œä¾‹å¦‚C/C++ç”šè‡³æ˜¯æ±‡ç¼–







### å †å†…å­˜  :astonished:

> **æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œè€Œå †æ˜¯å­˜å‚¨çš„å•ä½**
>
> æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚å †è§£å†³çš„æ˜¯æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªã€‚
>
> 

Java å †æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºï¼Œæ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œå‡ ä¹æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜

éšç€ JIT ç¼–è¯‘å™¨çš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆâ€œç»å¯¹â€äº†ã€‚ä» JDK 1.7 å¼€å§‹å·²ç»é»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œ**å¦‚æœæŸäº›æ–¹æ³•ä¸­çš„å¯¹è±¡å¼•ç”¨æ²¡æœ‰è¢«è¿”å›æˆ–è€…æœªè¢«å¤–é¢ä½¿ç”¨ï¼ˆä¹Ÿå°±æ˜¯æœªé€ƒé€¸å‡ºå»ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡å¯ä»¥ç›´æ¥åœ¨æ ˆä¸Šåˆ†é…å†…å­˜**

Java å †æ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä½œ **GC å †ï¼ˆGarbage Collected Heapï¼‰**ã€‚ä»åƒåœ¾å›æ”¶çš„è§’åº¦ï¼Œç”±äºç°åœ¨æ”¶é›†å™¨åŸºæœ¬éƒ½é‡‡ç”¨åˆ†ä»£åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œæ‰€ä»¥ Java å †è¿˜å¯ä»¥ç»†åˆ†ä¸ºï¼šæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼›å†ç»†è‡´ä¸€ç‚¹æœ‰ï¼šEdenã€Survivorã€Old ç­‰ç©ºé—´ã€‚è¿›ä¸€æ­¥åˆ’åˆ†çš„ç›®çš„æ˜¯æ›´å¥½åœ°å›æ”¶å†…å­˜ï¼Œæˆ–è€…æ›´å¿«åœ°åˆ†é…å†…å­˜





**æ¥çœ‹ä¸€çœ‹é˜¿é‡Œå¤§ç¥æ€»ç»“çš„ç‰ˆæœ¬ï¼š**

Java å †ï¼ˆJava Heapï¼‰æ˜¯ JVM æ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ï¼Œå †åˆæ˜¯åƒåœ¾æ”¶é›†å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦åˆ†æä¸€ä¸‹ Java å †çš„ç»“æ„

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/jvm/tujie-gc-294701a5-1c50-4112-94a1-96a8bab80e34.png" alt="img" style="zoom:67%;" />

Java å †ä¸»è¦åˆ†ä¸º 2 ä¸ªåŒºåŸŸ-å¹´è½»ä»£ä¸è€å¹´ä»£ï¼Œå…¶ä¸­å¹´è½»ä»£åˆåˆ† Eden åŒºå’Œ Survivor åŒºï¼Œå…¶ä¸­ Survivor åŒºåˆåˆ† From å’Œ To 2 ä¸ªåŒºã€‚å¯èƒ½è¿™æ—¶å€™å¤§å®¶ä¼šæœ‰ç–‘é—®ï¼Œ

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä¼šåœ¨æ–°ç”Ÿä»£ Eden åŒºä¸­è¿›è¡Œåˆ†é…ã€‚å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºä¼šå‘èµ·ä¸€æ¬¡ Minor GCï¼ŒMinor GC ç›¸æ¯” Major GC æ›´é¢‘ç¹ï¼Œå›æ”¶é€Ÿåº¦ä¹Ÿæ›´å¿«

**é€šè¿‡ Minor GC ä¹‹åï¼ŒEden ä¼šè¢«æ¸…ç©ºï¼ŒEden åŒºä¸­ç»å¤§éƒ¨åˆ†å¯¹è±¡ä¼šè¢«å›æ”¶ï¼Œè€Œé‚£äº›æ— éœ€å›æ”¶çš„å­˜æ´»å¯¹è±¡ï¼Œå°†ä¼šè¿›åˆ° Survivor çš„ From åŒºï¼ˆè‹¥ From åŒºä¸å¤Ÿï¼Œåˆ™ç›´æ¥è¿›å…¥ Old åŒºâ€”â€”åˆ†é…æ‹…ä¿æœºåˆ¶ï¼‰**



> ä¸ºä»€ä¹ˆéœ€è¦ `Survivor` åŒº?

Survivor åŒºç›¸å½“äºæ˜¯ Eden åŒºå’Œ Old åŒºçš„ä¸€ä¸ªç¼“å†²ï¼Œç±»ä¼¼äºæˆ‘ä»¬äº¤é€šç¯ä¸­çš„é»„ç¯ã€‚Survivor åˆåˆ†ä¸º 2 ä¸ªåŒºï¼Œä¸€ä¸ªæ˜¯ From åŒºï¼Œä¸€ä¸ªæ˜¯ To åŒºã€‚æ¯æ¬¡æ‰§è¡Œ Minor GCï¼Œä¼šå°† Eden åŒºå’Œ From å­˜æ´»çš„å¯¹è±¡æ”¾åˆ° Survivor çš„ To åŒºï¼ˆå¦‚æœ To åŒºä¸å¤Ÿï¼Œåˆ™ç›´æ¥è¿›å…¥ Old åŒºï¼‰

ä¹‹æ‰€ä»¥æœ‰ Survivor åŒºæ˜¯å› ä¸ºå¦‚æœæ²¡æœ‰ Survivor åŒºï¼ŒEden åŒºæ¯è¿›è¡Œä¸€æ¬¡ Minor GCï¼Œå­˜æ´»çš„å¯¹è±¡å°±ä¼šè¢«é€åˆ°è€å¹´ä»£ï¼Œè€å¹´ä»£å¾ˆå¿«å°±ä¼šè¢«å¡«æ»¡ã€‚è€Œæœ‰å¾ˆå¤šå¯¹è±¡è™½ç„¶ä¸€æ¬¡ Minor GC æ²¡æœ‰æ¶ˆç­ï¼Œä½†å…¶å®ä¹Ÿå¹¶ä¸ä¼šè¹¦è·¶å¤šä¹…ï¼Œæˆ–è®¸ç¬¬äºŒæ¬¡ï¼Œç¬¬ä¸‰æ¬¡å°±éœ€è¦è¢«æ¸…é™¤ã€‚è¿™æ—¶å€™ç§»å…¥è€å¹´åŒºï¼Œå¾ˆæ˜æ˜¾ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„å†³å®š

æ‰€ä»¥ï¼ŒSurvivor çš„å­˜åœ¨æ„ä¹‰å°±æ˜¯å‡å°‘è¢«é€åˆ°è€å¹´ä»£çš„å¯¹è±¡ï¼Œè¿›è€Œå‡å°‘ `Major GC`(é’ˆå¯¹è€å¹´ä»£) çš„å‘ç”Ÿã€‚Survivor çš„é¢„ç­›é€‰ä¿è¯ï¼Œåªæœ‰ç»å† 16 æ¬¡ Minor GC è¿˜èƒ½åœ¨æ–°ç”Ÿä»£ä¸­å­˜æ´»çš„å¯¹è±¡ï¼Œæ‰ä¼šè¢«é€åˆ°è€å¹´ä»£





> ä¸ºä»€ä¹ˆ `Survivor` è¿˜è¦åˆ† 2 ä¸ªåŒº?

è®¾ç½®ä¸¤ä¸ª `Survivor` åŒºæœ€å¤§çš„å¥½å¤„å°±æ˜¯è§£å†³å†…å­˜ç¢ç‰‡åŒ–ã€‚

æˆ‘ä»¬å…ˆå‡è®¾ä¸€ä¸‹ï¼ŒSurvivor å¦‚æœåªæœ‰ä¸€ä¸ªåŒºåŸŸä¼šæ€æ ·ã€‚Minor GC æ‰§è¡Œåï¼ŒEden åŒºè¢«æ¸…ç©ºäº†ï¼Œå­˜æ´»çš„å¯¹è±¡æ”¾åˆ°äº† Survivor åŒºï¼Œè€Œä¹‹å‰ Survivor åŒºä¸­çš„å¯¹è±¡ï¼Œå¯èƒ½ä¹Ÿæœ‰ä¸€äº›æ˜¯éœ€è¦è¢«æ¸…é™¤çš„ã€‚é—®é¢˜æ¥äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ€ä¹ˆæ¸…é™¤å®ƒä»¬ï¼Ÿåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åªèƒ½æ ‡è®°æ¸…é™¤ï¼Œè€Œæˆ‘ä»¬çŸ¥é“æ ‡è®°æ¸…é™¤æœ€å¤§çš„é—®é¢˜å°±æ˜¯å†…å­˜ç¢ç‰‡ï¼Œåœ¨æ–°ç”Ÿä»£è¿™ç§ç»å¸¸ä¼šæ¶ˆäº¡çš„åŒºåŸŸï¼Œé‡‡ç”¨æ ‡è®°æ¸…é™¤å¿…ç„¶ä¼šè®©å†…å­˜äº§ç”Ÿä¸¥é‡çš„ç¢ç‰‡åŒ–ã€‚**å› ä¸º Survivor æœ‰ 2 ä¸ªåŒºåŸŸï¼Œæ‰€ä»¥æ¯æ¬¡ Minor GCï¼Œä¼šå°†ä¹‹å‰ Eden åŒºå’Œ From åŒºä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° To åŒºåŸŸã€‚ç¬¬äºŒæ¬¡ Minor GC æ—¶ï¼ŒFrom ä¸ To èŒè´£äº’æ¢ï¼Œè¿™æ—¶å€™ä¼šå°† Eden åŒºå’Œ To åŒºä¸­çš„å­˜æ´»å¯¹è±¡å†å¤åˆ¶åˆ° From åŒºåŸŸ**ï¼Œä»¥æ­¤åå¤ã€‚

è¿™ç§æœºåˆ¶æœ€å¤§çš„å¥½å¤„å°±æ˜¯ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œ**æ°¸è¿œæœ‰ä¸€ä¸ª Survivor space æ˜¯ç©ºçš„ï¼Œå¦ä¸€ä¸ªéç©ºçš„ Survivor space æ˜¯æ— ç¢ç‰‡çš„**ã€‚é‚£ä¹ˆï¼ŒSurvivor ä¸ºä»€ä¹ˆä¸åˆ†æ›´å¤šå—å‘¢ï¼Ÿæ¯”æ–¹è¯´åˆ†æˆä¸‰ä¸ªã€å››ä¸ªã€äº”ä¸ª?æ˜¾ç„¶ï¼Œå¦‚æœ Survivor åŒºå†ç»†åˆ†ä¸‹å»ï¼Œæ¯ä¸€å—çš„ç©ºé—´å°±ä¼šæ¯”è¾ƒå°ï¼Œå®¹æ˜“å¯¼è‡´ Survivor åŒºæ»¡ï¼Œä¸¤å— Survivor åŒºå¯èƒ½æ˜¯ç»è¿‡æƒè¡¡ä¹‹åçš„æœ€ä½³æ–¹æ¡ˆã€‚



> å…³äºè€å¹´ä»£

è€å¹´ä»£å æ®ç€ 2/3 çš„å †å†…å­˜ç©ºé—´ï¼Œåªæœ‰åœ¨ Major GC çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ¸…ç†ï¼Œæ¯æ¬¡ GC éƒ½ä¼šè§¦å‘é•¿æœŸçš„â€œStop-The-Worldâ€

(Minor GCï¼ˆå¹´è½»ä»£åƒåœ¾å›æ”¶ï¼‰é€šå¸¸ä¹Ÿä¼šè§¦å‘**çŸ­æš‚**çš„"Stop-the-World"ï¼ˆåœé¡¿ï¼‰äº‹ä»¶)

å†…å­˜è¶Šå¤§ï¼ŒSTW çš„æ—¶é—´ä¹Ÿè¶Šé•¿ï¼Œæ‰€ä»¥å†…å­˜ä¹Ÿä¸ä»…ä»…æ˜¯è¶Šå¤§å°±è¶Šå¥½ã€‚åœ¨å†…å­˜æ‹…ä¿æœºåˆ¶ä¸‹ï¼Œæ— æ³•å®‰ç½®çš„å¯¹è±¡ä¼šç›´æ¥è¿›åˆ°è€å¹´ä»£ï¼Œä»¥ä¸‹å‡ ç§æƒ…å†µä¹Ÿä¼šè¿›å…¥è€å¹´ä»£ã€‚

1ï¼‰**å¤§å¯¹è±¡**ï¼ŒæŒ‡éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼Œè¿™éƒ¨åˆ†å¯¹è±¡ä¸ç®¡æ˜¯ä¸æ˜¯â€œæœç”Ÿå¤•æ­»â€ï¼Œéƒ½ä¼šç›´æ¥è¿›åˆ°è€å¹´ä»£ã€‚è¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†é¿å…åœ¨ Eden åŒºåŠ 2 ä¸ª Survivor åŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜å¤åˆ¶ã€‚

2ï¼‰**é•¿æœŸå­˜æ´»å¯¹è±¡**ï¼Œè™šæ‹Ÿæœºç»™æ¯ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ä¸ªå¯¹è±¡å¹´é¾„ï¼ˆAgeï¼‰è®¡æ•°å™¨ã€‚æ­£å¸¸æƒ…å†µä¸‹å¯¹è±¡ä¼šä¸æ–­çš„åœ¨ Survivor çš„ From åŒºä¸ To åŒºä¹‹é—´ç§»åŠ¨ï¼Œå¯¹è±¡åœ¨ Survivor åŒºä¸­æ¯ç»å†ä¸€æ¬¡ Minor GCï¼Œå¹´é¾„å°±å¢åŠ  1 å²ã€‚å½“å¹´é¾„å¢åŠ åˆ° 15 å²æ—¶ï¼Œè¿™æ—¶å€™å°±ä¼šè¢«è½¬ç§»åˆ°è€å¹´ä»£ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„ 15ï¼ŒJVM ä¹Ÿæ”¯æŒè¿›è¡Œç‰¹æ®Šè®¾ç½®ã€‚

3ï¼‰**åŠ¨æ€å¯¹è±¡å¹´é¾„**ï¼Œè™šæ‹Ÿæœºå¹¶ä¸é‡è§†è¦æ±‚å¯¹è±¡å¹´é¾„å¿…é¡»åˆ° 15 å²ï¼Œæ‰ä¼šæ”¾å…¥è€å¹´åŒºï¼Œå¦‚æœ Survivor ç©ºé—´ä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»åˆå¤§äº Survivor ç©ºé—´çš„ä¸€åŠï¼Œå¹´é¾„å¤§äºç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å°±å¯ä»¥ç›´æ¥è¿›å»è€å¹´åŒºï¼Œæ— éœ€ç­‰ä½ â€œæˆå¹´â€ã€‚



>  ä»€ä¹ˆæ˜¯åˆ†é…æ‹…ä¿æœºåˆ¶ï¼Ÿ
>
> 
>
> åˆ†é…æ‹…ä¿æœºåˆ¶çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œåœ¨è¿›è¡Œä¸€æ¬¡ Minor GC å‰ï¼Œé¦–å…ˆä¼°è®¡æœ¬æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡å¤§å°ï¼ˆé€šå¸¸ä½¿ç”¨ä¸Šä¸€æ¬¡ GC åå­˜æ´»çš„å¯¹è±¡å¤§å°ä½œä¸ºä¼°è®¡ï¼‰ï¼Œç„¶åæ£€æŸ¥è€å¹´ä»£çš„å‰©ä½™ç©ºé—´æ˜¯å¦è¶³å¤Ÿå®¹çº³è¿™äº›å­˜æ´»å¯¹è±¡ã€‚å¦‚æœè¶³å¤Ÿï¼Œå°±å¯ä»¥æ”¾å¿ƒè¿›è¡Œ Minor GCï¼›å¦‚æœä¸å¤Ÿï¼ŒJVM ä¼šå°è¯•å…ˆæ‰§è¡Œä¸€æ¬¡ Full GCï¼Œå°½é‡å›æ”¶è€å¹´ä»£çš„ç©ºé—´ï¼Œä»¥ä¿è¯ Minor GC çš„å®‰å…¨æ€§ã€‚
>
> è¿™ä¸ªæœºåˆ¶ç¡®ä¿äº†åœ¨è¿›è¡Œ Minor GC æ—¶ï¼Œè€å¹´ä»£ä¸ä¼šå› ä¸ºç©ºé—´ä¸è¶³è€Œè§¦å‘ Full GCï¼Œä»è€Œé™ä½äº†åº”ç”¨ç¨‹åºçš„åœé¡¿æ—¶é—´ã€‚





#### å†…å­˜åˆ’åˆ†

åœ¨ JDK 7 ç‰ˆæœ¬åŠ JDK 7 ç‰ˆæœ¬ä¹‹å‰ï¼Œå †å†…å­˜è¢«é€šå¸¸åˆ†ä¸ºä¸‹é¢ä¸‰éƒ¨åˆ†ï¼š

1. æ–°ç”Ÿä»£å†…å­˜(Young Generation)
2. è€ç”Ÿä»£(Old Generation)
3. æ°¸ä¹…ä»£(Permanent Generation)

**JDK 8 ç‰ˆæœ¬ä¹‹å PermGen(æ°¸ä¹…ä»£) å·²è¢« Metaspace(å…ƒç©ºé—´) å–ä»£ï¼Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯æœ¬åœ°å†…å­˜**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/hotspot-heap-structure.png" style="zoom: 67%;" />



**æ–°ç”Ÿä»£ï¼š**

å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ Eden åŒºåŸŸåˆ†é…ï¼Œåœ¨ä¸€æ¬¡æ–°ç”Ÿä»£åƒåœ¾å›æ”¶åï¼Œå¦‚æœå¯¹è±¡è¿˜å­˜æ´»ï¼Œåˆ™ä¼šè¿›å…¥ S0 æˆ–è€… S1(å®ƒä»¬ä¹Ÿè¢«ç§°ä¸º"`from survivor`"å’Œ"`to survivor`")ï¼Œå¹¶ä¸”å¯¹è±¡çš„å¹´é¾„è¿˜ä¼šåŠ  1(Eden åŒº->Survivor åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º 15 å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®

æ–°ç”Ÿä»£è¢«åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†â€”â€”ä¼Šç”¸å›­ï¼ˆ**Eden Memory**ï¼‰å’Œä¸¤ä¸ªå¹¸å­˜åŒºï¼ˆ**Survivor Memory**ï¼Œè¢«ç§°ä¸ºfrom/toæˆ–s0/s1ï¼‰ï¼Œé»˜è®¤æ¯”ä¾‹æ˜¯`8:1:1`

- å¤§å¤šæ•°æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä½äº Eden å†…å­˜ç©ºé—´ä¸­
- å½“ Eden ç©ºé—´è¢«å¯¹è±¡å¡«å……æ»¡æ—¶ï¼Œæ‰§è¡Œ**Minor GC**ï¼Œå¹¶å°†æ‰€æœ‰å¹¸å­˜è€…å¯¹è±¡ç§»åŠ¨åˆ°ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ä¸­
- Minor GC æ£€æŸ¥å¹¸å­˜è€…å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬ç§»åŠ¨åˆ°å¦ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ã€‚**æ‰€ä»¥æ¯æ¬¡GCåï¼Œæ€»æœ‰ä¸€ä¸ªå¹¸å­˜è€…ç©ºé—´ä¸ºç©º**
- ç»è¿‡å¤šæ¬¡ GC å¾ªç¯åå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡è¢«ç§»åŠ¨åˆ°è€å¹´ä»£ã€‚é€šå¸¸ï¼Œè¿™æ˜¯é€šè¿‡è®¾ç½®å¹´è½»ä¸€ä»£å¯¹è±¡çš„å¹´é¾„é˜ˆå€¼æ¥å®ç°çš„ï¼Œç„¶åä»–ä»¬æ‰æœ‰èµ„æ ¼æå‡åˆ°è€ä¸€ä»£

> Minor GC:
>
> æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰ä¸»è¦ç”¨äºå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ã€‚å½“å¯¹è±¡ç»è¿‡åƒåœ¾å›æ”¶åï¼Œå¦‚æœä»ç„¶å­˜æ´»ï¼Œå®ƒä»¬ä¼šè¢«ç§»åŠ¨åˆ°SurvivoråŒºä¸­ã€‚æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶é€šå¸¸é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼ˆCopying Algorithmï¼‰ï¼Œå…¶ä¸­çš„"S0"å’Œ"S1"æ˜¯ä¸¤ä¸ªç”¨äºå¤åˆ¶å­˜æ´»å¯¹è±¡çš„SurvivoråŒºã€‚
>
> æ–°åˆ›å»ºçš„å¯¹è±¡é¦–å…ˆè¢«åˆ†é…åœ¨EdenåŒºï¼Œå½“EdenåŒºæ»¡äº†ä¹‹åï¼Œè§¦å‘Minor GCï¼ˆæ–°ç”Ÿä»£åƒåœ¾å›æ”¶ï¼‰ã€‚åœ¨Minor GCä¸­ï¼Œå­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°"S0"æˆ–"S1"ä¸­çš„ä¸€ä¸ªï¼ŒåŒæ—¶æ¸…ç†EdenåŒºå’Œå¦ä¸€ä¸ªSurvivoråŒºã€‚ç»è¿‡å¤šæ¬¡Minor GCåï¼Œä¾ç„¶å­˜æ´»çš„å¯¹è±¡ä¼šè¢«ç§»åˆ°è€å¹´ä»£ä¸­ã€‚
>
> "S0"å’Œ"S1"çš„ä½œç”¨æ˜¯ç”¨äºä¸¤æ¬¡Minor GCä¹‹é—´çš„å­˜æ´»å¯¹è±¡å¤åˆ¶å’Œè°ƒæ•´ã€‚åœ¨ç¬¬ä¸€æ¬¡Minor GCåï¼Œå­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°å¦ä¸€ä¸ªSurvivoråŒºï¼ˆé€šå¸¸æ˜¯"S0"åˆ°"S1"æˆ–è€…"S1"åˆ°"S0"ï¼‰ã€‚åœ¨ç¬¬äºŒæ¬¡Minor GCæ—¶ï¼Œå†å°†å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°æœªä½¿ç”¨çš„SurvivoråŒºã€‚
>
> è¿™ç§è½®æ¢æ–¹å¼å¯ä»¥ä¿è¯åœ¨ä¸€æ¬¡Minor GCè¿‡ç¨‹ä¸­ï¼ŒSurvivoråŒºä¸­çš„ä¸€ä¸ªæ˜¯ç©ºçš„ï¼Œä»¥å¤‡ä¸‹æ¬¡Minor GCä½¿ç”¨ã€‚åŒæ—¶ï¼Œç»è¿‡å¤šæ¬¡Minor GCåï¼Œä¾ç„¶å­˜æ´»çš„å¯¹è±¡ä¼šè¢«ç§»åˆ°è€å¹´ä»£ï¼Œä»è€Œå®ç°äº†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¹‹é—´å¯¹è±¡çš„åˆ†ä»£ç®¡ç†





**è€å¹´ä»£ï¼š**

è€å¹´ä»£å†…å­˜åŒ…å«é‚£äº›ç»è¿‡è®¸å¤šè½®å°å‹`GC`åä»ç„¶å­˜æ´»çš„å¯¹è±¡ï¼Œè€å¹´ä»£åƒåœ¾æ”¶é›†ç§°ä¸º ä¸»GCï¼ˆ`Major GC`ï¼‰ï¼Œé€šå¸¸éœ€è¦æ›´é•¿çš„æ—¶é—´

å¤§å¯¹è±¡ä¹Ÿä¼šç›´æ¥è¿›å…¥è€å¹´ä»£ï¼ˆå¤§å¯¹è±¡æ˜¯æŒ‡éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼‰ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é¿å…åœ¨ Eden åŒºå’Œä¸¤ä¸ª `Survivor` åŒºä¹‹é—´å‘ç”Ÿå¤§é‡çš„å†…å­˜æ‹·è´



**æ°¸ä¹…ä»£(å…ƒç©ºé—´)ï¼š**

**ä¸ç®¡æ˜¯ JDK8 ä¹‹å‰çš„æ°¸ä¹…ä»£ï¼Œè¿˜æ˜¯ JDK8 åŠä»¥åçš„å…ƒç©ºé—´ï¼Œéƒ½å¯ä»¥çœ‹ä½œæ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°**

åœ¨ Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œæ°¸ä¹…ä»£ï¼ˆPermanent Generationï¼‰æ˜¯ä¸€éƒ¨åˆ†å †å†…å­˜çš„åŒºåŸŸï¼Œå®ƒä¸»è¦ç”¨äºå­˜æ”¾ç±»çš„å…ƒæ•°æ®ã€å¸¸é‡æ± ã€é™æ€å˜é‡å’Œä¸€äº›ç¼–è¯‘å™¨ä¼˜åŒ–åçš„ä»£ç ç­‰ã€‚æ°¸ä¹…ä»£åœ¨ JVM ä¸­çš„ä½œç”¨å¦‚ä¸‹ï¼š

1. **å­˜æ”¾ç±»çš„å…ƒæ•°æ®ï¼š** ç±»çš„å…ƒæ•°æ®æ˜¯æŒ‡ç±»çš„ç»“æ„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„å­—æ®µã€æ–¹æ³•ã€çˆ¶ç±»ã€æ¥å£ç­‰ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒJVMéœ€è¦å¿«é€Ÿè®¿é—®ç±»çš„å…ƒæ•°æ®ï¼Œå› æ­¤å°†å®ƒä»¬å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸­ã€‚
2. **å­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± (å¯¹åº”`Class`æ–‡ä»¶ä¸­çš„`Constant Pool`)ï¼š** å¸¸é‡æ± ç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€åŸºæœ¬æ•°æ®ç±»å‹çš„å€¼ã€ç±»å’Œæ–¹æ³•çš„ç¬¦å·å¼•ç”¨ç­‰ã€‚è¿™äº›å¸¸é‡åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šï¼Œå› æ­¤å°†å®ƒä»¬å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸­ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ—¶å¯ä»¥å¿«é€Ÿè®¿é—®ã€‚
3. **å­˜æ”¾é™æ€å˜é‡ï¼š** é™æ€å˜é‡æ˜¯ç±»çº§åˆ«çš„å˜é‡ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œç±»çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼Œå­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸­å¯ä»¥ä¿è¯å®ƒä»¬åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…å­˜åœ¨ã€‚
4. **å­˜æ”¾ç¼–è¯‘å™¨ä¼˜åŒ–åçš„ä»£ç ï¼š** ä¸€äº›ç»è¿‡ JIT ç¼–è¯‘å™¨ä¼˜åŒ–åçš„ä»£ç ï¼ˆä¾‹å¦‚å³æ—¶ç¼–è¯‘ç”Ÿæˆçš„æœ¬åœ°æœºå™¨ç ï¼‰ä¹Ÿå¯èƒ½å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸­ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Java 8 åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œæ°¸ä¹…ä»£è¢«å…ƒæ•°æ®åŒºï¼ˆMetaspaceï¼‰æ‰€å–ä»£ã€‚Metaspace ä¸å†æ˜¯å †å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯åœ¨æœ¬åœ°å†…å­˜ä¸­åˆ†é…çš„ã€‚Metaspace çš„å¤§å°ä¸å†å—å›ºå®šçš„é™åˆ¶ï¼Œè€Œæ˜¯å¯ä»¥æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦åŠ¨æ€è°ƒæ•´ã€‚

æ°¸ä¹…ä»£åœ¨ Java 8 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­å­˜åœ¨ï¼Œä½†åœ¨ Java 8 åŠä¹‹åçš„ç‰ˆæœ¬ä¸­è¢«ç§»é™¤ã€‚**åœ¨ Java 8 ä¹‹åï¼Œç±»çš„å…ƒæ•°æ®ç­‰ä¿¡æ¯ä¾ç„¶è¢«å­˜æ”¾åœ¨ Metaspace ä¸­ï¼Œè€Œé™æ€å˜é‡å’Œå­—ç¬¦ä¸²å¸¸é‡æ± ç­‰ä¿¡æ¯åˆ™è¢«å­˜æ”¾åœ¨å †ä¸­çš„å…¶ä»–åŒºåŸŸ**ã€‚







####   å †å†…å­˜åˆ†é…åŸåˆ™



1ã€å¯¹è±¡ä¼˜å…ˆåœ¨ Eden åŒºåˆ†é…

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯¹è±¡åœ¨æ–°ç”Ÿä»£ä¸­ Eden åŒºåˆ†é…ã€‚å½“ Eden åŒºæ²¡æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œåˆ†é…æ—¶ï¼Œè™šæ‹Ÿæœºå°†å‘èµ·ä¸€æ¬¡ `Minor GC`

æ‰§è¡Œ `Minor GC` åï¼Œåé¢åˆ†é…çš„å¯¹è±¡å¦‚æœèƒ½å¤Ÿå­˜åœ¨ Eden åŒºçš„è¯ï¼Œè¿˜æ˜¯ä¼šåœ¨ Eden åŒºåˆ†é…å†…å­˜



2ã€å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£

å¤§å¯¹è±¡å°±æ˜¯éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ã€‚

å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ä¸»è¦æ˜¯ä¸ºäº†é¿å…ä¸ºå¤§å¯¹è±¡åˆ†é…å†…å­˜æ—¶ç”±äº**åˆ†é…æ‹…ä¿æœºåˆ¶**å¸¦æ¥çš„å¤åˆ¶è€Œé™ä½æ•ˆç‡ã€‚



3ã€é•¿æœŸå­˜æ´»çš„å¯¹è±¡å°†è¿›å…¥è€å¹´ä»£(å¦‚ä½•åˆ¤æ–­ï¼Ÿ)

å¤§éƒ¨åˆ†æƒ…å†µï¼Œå¯¹è±¡éƒ½ä¼šé¦–å…ˆåœ¨ Eden åŒºåŸŸåˆ†é…ã€‚å¦‚æœå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡ `Minor` `GC` åä»ç„¶èƒ½å¤Ÿå­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢« `Survivor` å®¹çº³çš„è¯(**æ— æ³•è¢«å®¹çº³åˆ™ç»è¿‡åˆ†é…æ‹…ä¿æœºåˆ¶ç›´æ¥è¿›å…¥è€å¹´ä»£**)ï¼Œå°†è¢«ç§»åŠ¨åˆ° `Survivor` ç©ºé—´ï¼ˆs0 æˆ–è€… s1ï¼‰ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º 1(Eden åŒº->`Survivor` åŒºåå¯¹è±¡çš„åˆå§‹å¹´é¾„å˜ä¸º 1)

> 1. åœ¨è¿›è¡ŒMinor GCä¹‹å‰ï¼ŒJVMä¼šæ£€æŸ¥è€å¹´ä»£çš„å‰©ä½™ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£ä¸­æ‰€æœ‰å­˜æ´»å¯¹è±¡çš„å¤§å°ä¹‹å’Œï¼ˆå³æ‰€æœ‰å­˜æ´»å¯¹è±¡çš„å¤§å°ä¹‹å’Œè¦å°äºè€å¹´ä»£çš„å‰©ä½™ç©ºé—´ï¼‰
> 2. å¦‚æœè€å¹´ä»£çš„å‰©ä½™ç©ºé—´è¶³å¤Ÿï¼ŒJVMä¼šç»§ç»­æ‰§è¡ŒMinor GCï¼Œå¹¶å°†å­˜æ´»å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ä¸­(ç¬¦åˆæ™‹å‡æ¡ä»¶çš„å‰æä¸‹)
> 3. å¦‚æœè€å¹´ä»£çš„å‰©ä½™ç©ºé—´ä¸è¶³ä»¥å­˜æ”¾æ‰€æœ‰å­˜æ´»å¯¹è±¡ï¼Œé‚£ä¹ˆJVMå°†è§¦å‘ä¸€æ¬¡Full GCï¼ˆå…¨å±€åƒåœ¾æ”¶é›†ï¼‰ï¼Œè¿™æ ·å°±ä¼šåœ¨è€å¹´ä»£è…¾å‡ºè¶³å¤Ÿçš„ç©ºé—´æ¥å®¹çº³ä»æ–°ç”Ÿä»£æ™‹å‡è€Œæ¥çš„å¯¹è±¡

å¯¹è±¡åœ¨ `Survivor` ä¸­æ¯ç†¬è¿‡ä¸€æ¬¡ `MinorGC`,å¹´é¾„å°±å¢åŠ  1 å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤ä¸º 15 å²ï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° `-XX:MaxTenuringThreshold` æ¥è®¾ç½®

> è¿™é‡Œè¯´æ³•æœ‰è¯¯è§£ï¼Œæ˜¯å¦æ™‹å‡è€å¹´ä»£é‡‡ç”¨çš„æ˜¯åŠ¨æ€å¹´é¾„è®¡ç®—ç­–ç•¥ï¼š
>
> â€œHotspot éå†æ‰€æœ‰å¯¹è±¡æ—¶ï¼ŒæŒ‰ç…§å¹´é¾„ä»å°åˆ°å¤§å¯¹å…¶æ‰€å ç”¨çš„å¤§å°è¿›è¡Œç´¯ç§¯ï¼Œå½“ç´¯ç§¯çš„æŸä¸ªå¹´é¾„å¤§å°è¶…è¿‡äº† survivor åŒºçš„ 50% æ—¶ï¼ˆé»˜è®¤å€¼æ˜¯ 50%ï¼Œå¯ä»¥é€šè¿‡ `-XX:TargetSurvivorRatio=percent` æ¥è®¾ç½®ï¼Œ**å–è¿™ä¸ªå¹´é¾„å’Œ `MaxTenuringThreshold` ä¸­æ›´å°çš„ä¸€ä¸ªå€¼ï¼Œä½œä¸ºæ–°çš„æ™‹å‡å¹´é¾„é˜ˆå€¼**â€

```
// å®šä¹‰å¹´é¾„è¡¨è®¡ç®—å‡½æ•°ï¼Œç”¨äºè®¡ç®—å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼
uint ageTable::compute_tenuring_threshold(size_t survivor_capacity) {
    // survivor_capacity æ˜¯survivorç©ºé—´çš„å¤§å°

    // è®¡ç®—ç›®æ ‡ Survivor å¤§å°ï¼Œæ ¹æ®ç›®æ ‡æ¯”ä¾‹ TargetSurvivorRatio æ¥ç¡®å®š
    size_t desired_survivor_size = (size_t)((((double)survivor_capacity) * TargetSurvivorRatio) / 100);

    // åˆå§‹åŒ– total å˜é‡ï¼Œç”¨äºç´¯ç§¯å„ä¸ªå¹´é¾„æ®µå¯¹è±¡çš„å¤§å°ä¹‹å’Œ
    size_t total = 0;

    // åˆå§‹åŒ– age å˜é‡ï¼Œè¡¨ç¤ºå½“å‰å¯¹è±¡çš„å¹´é¾„ï¼Œé»˜è®¤ä¸º 1
    uint age = 1;

    // å¼€å§‹å¾ªç¯ï¼Œéå†å„ä¸ªå¹´é¾„æ®µ
    while (age < table_size) {
        // sizes æ•°ç»„å­˜å‚¨äº†æ¯ä¸ªå¹´é¾„æ®µå¯¹è±¡çš„å¤§å°ï¼Œå°†å½“å‰å¹´é¾„æ®µå¯¹è±¡å¤§å°ç´¯åŠ åˆ° total ä¸­
        total += sizes[age];

        // å¦‚æœ total è¶…è¿‡äº†ç›®æ ‡ Survivor å¤§å°(SurvioråŒºçš„ä¸€åŠ)ï¼Œå°±è·³å‡ºå¾ªç¯
        if (total > desired_survivor_size) {
            break;
        }

        // å¦‚æœ total è¿˜æœªè¾¾åˆ°ç›®æ ‡ Survivor å¤§å°ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå¹´é¾„æ®µ
        age++;
    }

    // æ ¹æ®è®¡ç®—å¾—åˆ°çš„å¹´é¾„ï¼Œå†³å®šæœ€ç»ˆçš„å¹´é¾„é˜ˆå€¼ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ result ä¸­
    // å¦‚æœè®¡ç®—å¾—åˆ°çš„å¹´é¾„è¶…è¿‡äº†æœ€å¤§é˜ˆå€¼ MaxTenuringThresholdï¼Œåˆ™å–æœ€å¤§é˜ˆå€¼
    uint result = age < MaxTenuringThreshold ? age : MaxTenuringThreshold;
    
    // è¿”å›æœ€ç»ˆè®¡ç®—å¾—åˆ°çš„å¹´é¾„é˜ˆå€¼
    return result;
}

```

















#### è®¾ç½®å †å†…å­˜å¤§å°

å †çš„å¤§å°åœ¨ JVM å¯åŠ¨çš„æ—¶å€™å°±ç¡®å®šäº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `-Xmx` å’Œ `-Xms` æ¥è®¾å®š

- `-Xms` ç”¨æ¥è¡¨ç¤ºå †çš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº `-XX:InitialHeapSize`
- `-Xmx` ç”¨æ¥è¡¨ç¤ºå †çš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº `-XX:MaxHeapSize`

å¦‚æœå †çš„å†…å­˜å¤§å°è¶…è¿‡ `-Xmx` è®¾å®šçš„æœ€å¤§å†…å­˜ï¼Œ å°±ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸ã€‚

æˆ‘ä»¬é€šå¸¸ä¼šå°† `-Xmx` å’Œ `-Xms` ä¸¤ä¸ªå‚æ•°é…ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨åƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåä¸å†éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †çš„å¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½

- é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆå§‹å †å†…å­˜å¤§å°ä¸ºï¼šç”µè„‘å†…å­˜å¤§å°/64
- é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ€å¤§å †å†…å­˜å¤§å°ä¸ºï¼šç”µè„‘å†…å­˜å¤§å°/4

å¯ä»¥é€šè¿‡ä»£ç è·å–åˆ°æˆ‘ä»¬çš„è®¾ç½®å€¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ¨¡æ‹Ÿ OOMï¼š

```java
public static void main(String[] args) {

  //è¿”å› JVM å †å¤§å°
  long initalMemory = Runtime.getRuntime().totalMemory() / 1024 /1024;
  //è¿”å› JVM å †çš„æœ€å¤§å†…å­˜
  long maxMemory = Runtime.getRuntime().maxMemory() / 1024 /1024;

  System.out.println("-Xms : "+initalMemory + "M");
  System.out.println("-Xmx : "+maxMemory + "M");

  System.out.println("ç³»ç»Ÿå†…å­˜å¤§å°ï¼š" + initalMemory * 64 / 1024 + "G");
  System.out.println("ç³»ç»Ÿå†…å­˜å¤§å°ï¼š" + maxMemory * 4 / 1024 + "G");
}
```

è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
-Xms : 489M
-Xmx : 7241M
ç³»ç»Ÿå†…å­˜å¤§å°ï¼š30G
ç³»ç»Ÿå†…å­˜å¤§å°ï¼š28G
```





#### å¯¹è±¡åœ¨å †ä¸­çš„ç”Ÿå‘½å‘¨æœŸ

åœ¨ JVM å†…å­˜æ¨¡å‹çš„å †ä¸­ï¼Œå †è¢«åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ 

- æ–°ç”Ÿä»£åˆè¢«è¿›ä¸€æ­¥åˆ’åˆ†ä¸º **EdenåŒº** å’Œ **SurvivoråŒº**ï¼Œ`Survivor` åŒºç”± `From Survivor` å’Œ `To Survivor` ç»„æˆ

å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯¹è±¡ä¼šè¢«ä¼˜å…ˆåˆ†é…åˆ°æ–°ç”Ÿä»£çš„ Eden åŒº 

- æ­¤æ—¶ JVM ä¼šç»™å¯¹è±¡å®šä¹‰ä¸€ä¸ª**å¯¹è±¡å¹´è½»è®¡æ•°å™¨**ï¼ˆ`-XX:MaxTenuringThreshold`ï¼‰

> `-XX:MaxTenuringThreshold`ç”¨äºæŒ‡å®šå¯¹è±¡åœ¨æ–°ç”Ÿä»£ï¼ˆ`Young Generation`ï¼‰ä¸­ç»è¿‡å¤šå°‘æ¬¡åƒåœ¾å›æ”¶åæ‰ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ï¼ˆOld Generationï¼‰:
>
> 
>
> åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œé€šå¸¸æœ‰ä¸¤ä¸ª `Survivor` åŒºï¼Œç§°ä¸º "S0" å’Œ "S1"ã€‚å½“ä¸€ä¸ªå¯¹è±¡åœ¨ Eden åŒºè¢«åˆ†é…åï¼Œå¦‚æœç»è¿‡ä¸€æ¬¡ Minor GC åä»ç„¶å­˜æ´»ï¼Œå®ƒä¼šè¢«ç§»åˆ°å…¶ä¸­ä¸€ä¸ª Survivor åŒºã€‚å¦‚æœåœ¨ Survivor åŒºä¸­ç»è¿‡ä¸€å®šæ¬¡æ•°çš„åƒåœ¾å›æ”¶ï¼ˆå–å†³äº `-XX:MaxTenuringThreshold` çš„è®¾ç½®ï¼‰ï¼Œåˆ™ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£
>
> 
>
> é»˜è®¤æƒ…å†µä¸‹ï¼Œ`-XX:MaxTenuringThreshold` çš„å€¼é€šå¸¸ä¸º 15ï¼Œè¡¨ç¤ºä¸€ä¸ªå¯¹è±¡åœ¨ Survivor åŒºä¸­ç»è¿‡ 15 æ¬¡åƒåœ¾å›æ”¶åï¼Œå¦‚æœä»ç„¶å­˜æ´»ï¼Œåˆ™ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£(è¿™ä¸ªè¯´æ³•ä¹Ÿä¸å®Œå…¨å‡†ç¡®ï¼)ã€‚

å½“ Eden ç©ºé—´ä¸è¶³æ—¶ï¼ŒJVM å°†æ‰§è¡Œæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰ 

- JVM ä¼šæŠŠå­˜æ´»çš„å¯¹è±¡è½¬ç§»åˆ° Survivor ä¸­ï¼Œå¹¶ä¸”å¯¹è±¡å¹´é¾„ +1
- å¯¹è±¡åœ¨ Survivor ä¸­åŒæ ·ä¹Ÿä¼šç»å† Minor GCï¼Œæ¯ç»å†ä¸€æ¬¡ Minor GCï¼Œå¯¹è±¡å¹´é¾„éƒ½ä¼š+1

:exclamation: å¦‚æœåˆ†é…çš„å¯¹è±¡è¶…è¿‡äº†`-XX:PretenureSizeThreshold`çš„å¤§å°ï¼Œå¯¹è±¡ä¼š**ç›´æ¥è¢«åˆ†é…åˆ°è€å¹´ä»£**





#### TLAB

`Thread Local Allocation Buffer`ï¼ˆTLABï¼‰æ˜¯Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸­ä¸€ç§ç”¨äºä¼˜åŒ–å¯¹è±¡åˆ†é…çš„æŠ€æœ¯ã€‚**TLABæ˜¯ä¸€ç§çº¿ç¨‹æœ¬åœ°ç¼“å†²åŒºï¼Œç”¨äºåœ¨çº¿ç¨‹çš„æ ˆä¸Šåˆ†é…å¯¹è±¡**ï¼Œä»¥æé«˜å¯¹è±¡åˆ†é…çš„æ•ˆç‡

åœ¨Javaä¸­ï¼Œ**å¯¹è±¡çš„åˆ†é…é€šå¸¸æ˜¯åœ¨å †å†…å­˜ä¸Šè¿›è¡Œçš„ï¼Œè€Œä¸”é€šå¸¸æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œå¯¹è±¡åˆ†é…æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç«äº‰å’Œé”å†²çªï¼Œä»è€Œé™ä½åˆ†é…æ•ˆç‡**ã€‚ä¸ºäº†é¿å…è¿™ç§ç«äº‰ï¼ŒJVMå¼•å…¥äº†`Thread Local Allocation Buffer`ï¼ˆTLABï¼‰æŠ€æœ¯

**TLABçš„åŸºæœ¬æ€æƒ³æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹é¢„å…ˆåœ¨å †ä¸Šåˆ†é…ä¸€å—å°çš„ç¼“å†²åŒºï¼Œç”¨äºè¯¥çº¿ç¨‹çš„å¯¹è±¡åˆ†é…(å¯¹ `Eden` åŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼Œ`JVM` ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨ `Eden` ç©ºé—´å†…)ã€‚å½“çº¿ç¨‹éœ€è¦åˆ†é…å¯¹è±¡æ—¶ï¼Œå®ƒå¯ä»¥åœ¨è‡ªå·±çš„TLABä¸Šè¿›è¡Œåˆ†é…ï¼Œè€Œä¸éœ€è¦åœ¨å…¨å±€å †ä¸Šç«äº‰ã€‚è¿™æ ·ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ç¼“å†²åŒºï¼Œé¿å…äº†çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œæé«˜äº†å¯¹è±¡åˆ†é…çš„æ•ˆç‡ã€‚**

TLABçš„ä½¿ç”¨å¯ä»¥å‡å°‘å¯¹å…¨å±€é”çš„ç«äº‰ï¼Œä»è€Œæé«˜å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½ã€‚ä¸è¿‡ï¼Œ**TLABçš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹çš„TLABç”¨å°½æ—¶ï¼Œå®ƒè¿˜æ˜¯éœ€è¦åœ¨å…¨å±€å †ä¸Šåˆ†é…å¯¹è±¡**ã€‚JVMä¼šåŠ¨æ€è°ƒæ•´TLABçš„å¤§å°ï¼Œä»¥é€‚åº”ä¸åŒçº¿ç¨‹çš„å¯¹è±¡åˆ†é…éœ€æ±‚ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTLABæ˜¯JVMçš„ä¸€ç§å®ç°ç»†èŠ‚ï¼Œå¯èƒ½åœ¨ä¸åŒçš„JVMç‰ˆæœ¬å’Œåƒåœ¾å›æ”¶å™¨ä¸­æœ‰æ‰€ä¸åŒã€‚ä¸åŒçš„JVMå®ç°å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç­–ç•¥æ¥ä¼˜åŒ–å¯¹è±¡åˆ†é…å’ŒTLABçš„ä½¿ç”¨







### æ–¹æ³•åŒº

æ–¹æ³•åŒºç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€**å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜**ç­‰

æ–¹æ³•åŒºå’Œå †ä¸€æ ·ï¼Œæ˜¯çº¿ç¨‹å…±äº«çš„åŒºåŸŸï¼Œå®ƒç”¨æ¥å­˜å‚¨å·²ç»è¢« Java è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ï¼Œä»¥åŠä¾¿å™¨ç¼–è¯‘åçš„ä»£ç ç­‰ï¼Œè™½ç„¶ Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå« `Non-Heap`ï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€



JVMçš„æ–¹æ³•åŒºä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹æ•°æ®:

- å·²ç»åŠ è½½çš„ç±»ä¿¡æ¯:åŒ…æ‹¬ç±»åã€çˆ¶ç±»åã€æ¥å£ä¿¡æ¯ã€æˆå‘˜å˜é‡å’Œæ–¹æ³•ç­‰ã€‚è¿™äº›æ•°æ®ä¼šåœ¨ç±»åŠ è½½æ—¶è¢«åŠ è½½åˆ°æ–¹æ³•åŒºã€‚
- è¿è¡Œæ—¶å¸¸é‡æ± :æ–¹æ³•åŒºä¸­åŒ…å«ç±»çš„è¿è¡Œæ—¶å¸¸é‡æ± ,å­˜å‚¨å­—ç¬¦ä¸²å­—é¢é‡ã€æ•°å­—å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚
- é™æ€å˜é‡:æ‰€æœ‰ç±»çš„é™æ€å˜é‡æ•°æ®éƒ½è¢«å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ã€‚
- ç±»å…ƒæ•°æ®:åŒ…æ‹¬æœ‰å…³ç±»çš„ä¿¡æ¯,å¦‚annotationsã€æ³›å‹ä¿¡æ¯ç­‰ã€‚
- æ–¹æ³•å­—èŠ‚ç :æ‰€æœ‰çš„ç±»ä¸­çš„æ–¹æ³•å¯¹åº”å­—èŠ‚ç éƒ½å­˜å‚¨åœ¨æ–¹æ³•åŒºä¸­ã€‚
- **JITä»£ç ç¼“å­˜ï¼šçƒ­ç‚¹ä»£ç **
- æŒ‡å‘æ–¹æ³•åŒºçš„å…¨å±€å˜é‡:è™šæ‹Ÿæœºè§„èŒƒä¿ç•™äº†ä¸€äº›æŒ‡å‘æ–¹æ³•åŒºæ•°æ®çš„å…¨å±€å˜é‡,ç±»ä¼¼äºæ–¹æ³•åŒºçš„å¼•ç”¨ã€‚



> ã€ŠJava è™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­åªè§„å®šäº†æœ‰æ–¹æ³•åŒºè¿™ä¹ˆä¸€ä¸ªæ¦‚å¿µå’Œå®ƒçš„ä½œç”¨ï¼Œå¹¶æ²¡æœ‰è§„å®šå¦‚ä½•å»å®ç°å®ƒã€‚é‚£ä¹ˆä¸åŒçš„ Java è™šæ‹Ÿæœºå¯èƒ½å°±ä¼šæœ‰ä¸åŒçš„å®ç°ã€‚æ°¸ä¹…ä»£æ˜¯ HotSpot å¯¹æ–¹æ³•åŒºçš„ä¸€ç§å®ç°å½¢å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ°¸ä¹…ä»£åªæ˜¯ HotSpot ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè€Œæ–¹æ³•åŒºåˆ™æ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­çš„ä¸€ä¸ªå®šä¹‰ï¼Œä¸€ç§è§„èŒƒ
>
> æ¢å¥è¯è¯´ï¼Œæ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£çš„å…³ç³»å°±åƒæ˜¯ Java ä¸­æ¥å£å’Œç±»çš„å…³ç³»ï¼Œç±»å®ç°äº†æ¥å£

åœ¨æ–¹æ³•åŒºä¸­ï¼Œæœ‰ä¸€å—éå¸¸é‡è¦çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯**è¿è¡Œæ—¶å¸¸é‡æ± **ã€‚åœ¨è®² `class` æ–‡ä»¶çš„æ—¶å€™ï¼Œæåˆ°äº†æ¯ä¸ª `class` æ–‡ä»¶éƒ½ä¼šæœ‰ä¸ªå¸¸é‡æ± ï¼Œç”¨æ¥å­˜æ”¾å­—ç¬¦ä¸²å¸¸é‡ã€ç±»å’Œæ¥å£çš„åå­—ã€å­—æ®µåã€å¸¸é‡ç­‰ç­‰ã€‚è¿è¡Œæ—¶å¸¸é‡æ± å’Œ `class` æ–‡ä»¶çš„å¸¸é‡æ± æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå®ƒå°±æ˜¯é€šè¿‡ `class` æ–‡ä»¶ä¸­çš„å¸¸é‡æ± æ¥æ„å»ºçš„

**JDK 7 ä¹‹å‰ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ä¸­åŒ…å«ç€å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œéƒ½åœ¨æ–¹æ³•åŒº**ï¼Œæ­¤æ—¶çš„æ–¹æ³•åŒºå®ç°æ˜¯**æ°¸ä¹…ä»£**

**JDK 7 çš„æ—¶å€™ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä»æ–¹æ³•åŒºä¸­æ‹¿å‡ºæ¥æ”¾åˆ°äº†å †ä¸­ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ä¸­çš„å…¶ä»–ä¸œè¥¿è¿˜åœ¨æ–¹æ³•åŒºä¸­**ï¼Œæ­¤æ—¶çš„æ–¹æ³•åŒºå®ç°ä»ç„¶æ˜¯**æ°¸ä¹…ä»£**

**JDK 8 çš„æ—¶å€™ï¼ŒHotSpot ç§»é™¤äº†æ°¸ä¹…ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´æ–¹æ³•åŒºä¸å­˜åœ¨äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å…ƒç©ºé—´ã€‚ä¹Ÿå°±æ„å‘³ç€å­—ç¬¦ä¸²å¸¸é‡æ± åœ¨å †ä¸­(ç±»çš„é™æ€å˜é‡åŒæ ·è½¬ç§»åˆ°äº†å †ä¸­)ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± è·‘åˆ°äº†å…ƒç©ºé—´(æ°¸ä¹…ä»£ä¸­çš„ `class metadata` è½¬ç§»åˆ°äº† `native memory`)**



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/method-area-implementation.png)





- æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰ä¸ Java å †ä¸€æ ·ï¼Œæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸ
- è™½ç„¶ Java è™šæ‹Ÿæœºè§„èŒƒæŠŠæ–¹æ³•åŒºæè¿°ä¸ºå †çš„ä¸€ä¸ªé€»è¾‘éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒå´æœ‰ä¸€ä¸ªåˆ«åå« Non-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„åº”è¯¥æ˜¯ä¸ Java å †åŒºåˆ†å¼€
- è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆ`Runtime Constant Pool`ï¼‰æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚Class æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬/å­—æ®µ/æ–¹æ³•/æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œ**è¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯å¸¸é‡æ± ï¼ˆConstant Pool Tableï¼‰ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åè¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å­˜æ”¾**ã€‚è¿è¡ŒæœŸé—´ä¹Ÿå¯èƒ½å°†æ–°çš„å¸¸é‡æ”¾å…¥æ± ä¸­ï¼Œè¿™ç§ç‰¹æ€§è¢«å¼€å‘äººå‘˜åˆ©ç”¨å¾—æ¯”è¾ƒå¤šçš„æ˜¯ `String.intern()`æ–¹æ³•ã€‚å—æ–¹æ³•åŒºå†…å­˜çš„é™åˆ¶ï¼Œå½“å¸¸é‡æ± æ— æ³•å†ç”³è¯·åˆ°å†…å­˜æ—¶ä¼šæŠ›å‡º `OutOfMemoryError` å¼‚å¸¸
- æ–¹æ³•åŒºçš„å¤§å°å’Œå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°ä¹Ÿå¯é€‰æ‹©å¯æ‰©å±•ï¼Œæ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥æ”¾å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿç±»å¤ªå¤šï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯
- JVM å…³é—­åæ–¹æ³•åŒºå³è¢«é‡Šæ”¾





> å†æ¥è¯´è¯´ä¸ºä»€ä¹ˆè¦å°†æ°¸ä¹…ä»£ (PermGen) æˆ–è€…è¯´æ–¹æ³•åŒºæ›¿æ¢ä¸ºå…ƒç©ºé—´ (MetaSpace) 

ç¬¬ä¸€ï¼Œæ°¸ä¹…ä»£æ”¾åœ¨ Java è™šæ‹Ÿæœºä¸­ï¼Œå°±ä¼šå—åˆ° Java è™šæ‹Ÿæœºå†…å­˜å¤§å°çš„é™åˆ¶ï¼Œè€Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯æœ¬åœ°å†…å­˜ï¼Œä¹Ÿå°±è„±ç¦»äº† Java è™šæ‹Ÿæœºå†…å­˜çš„é™åˆ¶

ç¬¬äºŒï¼Œå…ƒç©ºé—´é‡Œé¢å­˜æ”¾çš„æ˜¯ç±»çš„å…ƒæ•°æ®ï¼Œè¿™æ ·åŠ è½½å¤šå°‘ç±»çš„å…ƒæ•°æ®å°±ä¸ç”± `MaxPermSize` æ§åˆ¶äº†, è€Œç”±ç³»ç»Ÿçš„å®é™…å¯ç”¨ç©ºé—´æ¥æ§åˆ¶ï¼Œè¿™æ ·èƒ½åŠ è½½çš„ç±»å°±æ›´å¤šäº†ã€‚

ç¬¬ä¸‰ï¼ŒJDK 8 çš„æ—¶å€™ï¼Œåœ¨ HotSpot ä¸­èåˆäº† JRockit è™šæ‹Ÿæœºï¼Œè€Œ JRockit ä¸­å¹¶æ²¡æœ‰æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼Œå› æ­¤æ–°çš„ HotSpot å°±æ²¡æœ‰å¿…è¦å†å¼€è¾Ÿä¸€å—ç©ºé—´æ¥ä½œä¸ºæ°¸ä¹…ä»£äº†





>  æ€»ç»“ä¸€ä¸‹ï¼šæ–¹æ³•åŒºåœ¨ JDK6ã€7ã€8ä¸­çš„æ¼”è¿›ç»†èŠ‚.....

é¦–å…ˆè¦æ¸…æ¥šåªæœ‰ HotSpot æ‰æœ‰æ°¸ä¹…ä»£çš„æ¦‚å¿µ

| JDKç‰ˆæœ¬      | æ˜¯å¦æœ‰æ°¸ä¹…ä»£ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± æ”¾åœ¨å“ªé‡Œï¼Ÿ                         | æ–¹æ³•åŒºé€»è¾‘ä¸Šè§„èŒƒï¼Œç”±å“ªäº›å®é™…çš„éƒ¨åˆ†å®ç°çš„ï¼Ÿ                   |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| jdk1.6åŠä¹‹å‰ | æœ‰æ°¸ä¹…ä»£ï¼Œè¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰ï¼Œ**é™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸Š** | è¿™ä¸ªæ—¶æœŸæ–¹æ³•åŒºåœ¨HotSpotä¸­æ˜¯ç”±æ°¸ä¹…ä»£æ¥å®ç°çš„ï¼Œä»¥è‡³äº**è¿™ä¸ªæ—¶æœŸè¯´æ–¹æ³•åŒºå°±æ˜¯æŒ‡æ°¸ä¹…ä»£** |
| jdk1.7       | æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œ**å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­ï¼›** | è¿™ä¸ªæ—¶æœŸæ–¹æ³•åŒºåœ¨HotSpotä¸­ç”±**æ°¸ä¹…ä»£**ï¼ˆç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ï¼‰å’Œ**å †**ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ï¼‰å…±åŒå®ç° |
| jdk1.8åŠä¹‹å | å–æ¶ˆæ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»åœ¨å †ä¸­ | è¿™ä¸ªæ—¶æœŸ**æ–¹æ³•åŒº**åœ¨HotSpotä¸­ç”±æœ¬åœ°å†…å­˜çš„**å…ƒç©ºé—´**ï¼ˆç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ï¼‰å’Œ**å †**ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ï¼‰**å…±åŒå®ç°** |









### å¸¸é‡æ± 

**è¿è¡Œæ—¶å¸¸é‡æ± ï¼š**

å…ˆæ¥çœ‹çœ‹å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± å’Œè¿è¡Œæ—¶å¸¸é‡æ± çš„åŒºåˆ«åœ¨å“ªé‡Œï¼š

è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰å’Œå­—èŠ‚ç ä¸­çš„å¸¸é‡æ± ï¼ˆConstant Poolï¼‰æ˜¯Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸­ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œä½†å®ƒä»¬ä¹‹é—´å­˜åœ¨ç€å¯†åˆ‡çš„å…³ç³»ã€‚

1. **å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± ï¼ˆConstant Poolï¼‰ï¼š** åœ¨Javaæºä»£ç ç¼–è¯‘æˆå­—èŠ‚ç æ–‡ä»¶ï¼ˆ`.class`æ–‡ä»¶ï¼‰æ—¶ï¼Œç¼–è¯‘å™¨å°†æ‰€æœ‰çš„å­—é¢é‡å¸¸é‡ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ç­‰ï¼‰å’Œç¬¦å·å¼•ç”¨ï¼ˆå¦‚ç±»ã€æ–¹æ³•ã€å­—æ®µçš„å¼•ç”¨ï¼‰éƒ½å­˜å‚¨åœ¨å­—èŠ‚ç çš„å¸¸é‡æ± ä¸­ã€‚å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± æ˜¯ä¸€ç§è¡¨æ ¼æ•°æ®ç»“æ„ï¼Œå®ƒåŒ…å«äº†å¤šä¸ªå¸¸é‡é¡¹ï¼ˆConstant Pool Entryï¼‰ã€‚å­—èŠ‚ç æ–‡ä»¶ä¸­çš„æŒ‡ä»¤ä½¿ç”¨è¿™äº›å¸¸é‡é¡¹æ¥è¡¨ç¤ºæ‰€éœ€çš„å¸¸é‡å€¼æˆ–ç¬¦å·å¼•ç”¨ã€‚è¿™ä¸ªå¸¸é‡æ± åœ¨ç±»åŠ è½½æ—¶ä¼šè¢«åŠ è½½åˆ°JVMçš„æ–¹æ³•åŒºä¸­ï¼Œå¹¶ä¾›è¿è¡Œæ—¶ä½¿ç”¨ã€‚
2. **è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰ï¼š** è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯Javaè™šæ‹Ÿæœºåœ¨å†…å­˜ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯å­—èŠ‚ç ä¸­å¸¸é‡æ± çš„è¿è¡Œæ—¶è¡¨ç°å½¢å¼ã€‚åœ¨ç±»åŠ è½½åï¼ŒJVMä¼šå°†å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± å†…å®¹è½¬ç§»åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œä¾›ç¨‹åºåœ¨è¿è¡Œæ—¶ä½¿ç”¨ã€‚è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾**è¿è¡Œæ—¶å¸¸é‡å’Œç¬¦å·å¼•ç”¨**ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒJavaç¨‹åºå¯ä»¥åŠ¨æ€ç”Ÿæˆä¸€äº›å¸¸é‡ï¼Œå¹¶ä¸”è¿è¡Œæ—¶å¸¸é‡æ± ä¼šåŠ¨æ€æ‰©å±•ä»¥é€‚åº”æ–°çš„å¸¸é‡æ·»åŠ ã€‚

å¯ä»¥çœ‹å‡ºï¼Œå­—èŠ‚ç ä¸­çš„å¸¸é‡æ± æ˜¯åœ¨ç¼–è¯‘é˜¶æ®µç”Ÿæˆçš„ï¼Œå®ƒæ˜¯`.class`æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚è€Œè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œå°†å­—èŠ‚ç ä¸­çš„å¸¸é‡æ± å†…å®¹åŠ è½½åˆ°JVMçš„æ–¹æ³•åŒºä¸­å½¢æˆçš„ï¼Œä¾›ç¨‹åºåœ¨è¿è¡Œæ—¶ä½¿ç”¨ã€‚

æ€»ç»“æ¥è¯´ï¼Œå­—èŠ‚ç ä¸­çš„å¸¸é‡æ± æ˜¯ç¼–è¯‘æ—¶çš„é™æ€å¸¸é‡è¡¨ï¼Œè€Œè¿è¡Œæ—¶å¸¸é‡æ± æ˜¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„å¸¸é‡è¡¨ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ä¸€ç§é™æ€å’ŒåŠ¨æ€çš„å¯¹åº”å…³ç³»





**å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š**

**å­—ç¬¦ä¸²å¸¸é‡æ± ** æ˜¯ JVM ä¸ºäº†æå‡æ€§èƒ½å’Œå‡å°‘å†…å­˜æ¶ˆè€—é’ˆå¯¹å­—ç¬¦ä¸²ï¼ˆ`String` ç±»ï¼‰ä¸“é—¨å¼€è¾Ÿçš„ä¸€å—åŒºåŸŸï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é¿å…å­—ç¬¦ä¸²çš„é‡å¤åˆ›å»º

```java
// åœ¨å †ä¸­åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡â€abâ€œ,å› ä¸ºJDK7ä¹‹åå­—ç¬¦ä¸²å¸¸é‡æ± å·²ç»åœ¨å †ä¸­äº†
// å°†å­—ç¬¦ä¸²å¯¹è±¡â€abâ€œçš„å¼•ç”¨ä¿å­˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­
String aa = "ab";
// ç›´æ¥è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­—ç¬¦ä¸²å¯¹è±¡â€abâ€œçš„å¼•ç”¨
String bb = "ab";
System.out.println(aa==bb);// true
```

HotSpot è™šæ‹Ÿæœºä¸­å­—ç¬¦ä¸²å¸¸é‡æ± çš„å®ç°æ˜¯ `src/hotspot/share/classfile/stringTable.cpp` ,`StringTable` å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªå›ºå®šå¤§å°çš„`HashTable` ï¼Œå®¹é‡ä¸º `StringTableSize`ï¼ˆå¯ä»¥é€šè¿‡ `-XX:StringTableSize` å‚æ•°æ¥è®¾ç½®ï¼‰ï¼Œä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²ï¼ˆkeyï¼‰å’Œ å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨ï¼ˆvalueï¼‰çš„æ˜ å°„å…³ç³»ï¼Œå­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨(**å‡†ç¡®è¯´ä½äºæ–¹æ³•åŒºä¸­**)æŒ‡å‘å †ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡

JDK1.7 ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± (åŒ…æ‹¬é™æ€å˜é‡)å­˜æ”¾åœ¨æ°¸ä¹…ä»£ï¼Œ**JDK1.7 æ—¶å­—ç¬¦ä¸²å¸¸é‡æ± å’Œé™æ€å˜é‡ä»æ°¸ä¹…ä»£ç§»åŠ¨äº† Java å †ä¸­**(**æ­¤æ—¶å…ƒç©ºé—´è¿˜ä¸æ˜¯æ–¹æ³•åŒºçš„å®ç°ï¼Œæ­¤æ—¶è¿˜è¢«ç§°åšæ˜¯æ°¸ä¹…ä»£**)

è§‚å¯Ÿä»¥ä¸‹å›¾å³å¯å¾—å‡ºç»“è®ºï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/method-area-jdk1.6.png" style="zoom: 67%;" />



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/method-area-jdk1.7.png" style="zoom: 67%;" />



**JDK 1.7 ä¸ºä»€ä¹ˆè¦å°†å­—ç¬¦ä¸²å¸¸é‡æ± ç§»åŠ¨åˆ°å †ä¸­ï¼Ÿ**

ä¸»è¦æ˜¯å› ä¸ºæ°¸ä¹…ä»£ï¼ˆæ–¹æ³•åŒºå®ç°ï¼‰çš„ GC å›æ”¶æ•ˆç‡å¤ªä½ï¼Œåªæœ‰åœ¨æ•´å †æ”¶é›†`Full GC`çš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ `GC`(ä¸€èˆ¬éƒ½æ˜¯é’ˆå¯¹æ–°ç”Ÿä»£çš„GCâ€”â€”`Minor GC`)ã€‚**Java ç¨‹åºä¸­é€šå¸¸ä¼šæœ‰å¤§é‡çš„è¢«åˆ›å»ºçš„å­—ç¬¦ä¸²ç­‰å¾…å›æ”¶ï¼Œå°†å­—ç¬¦ä¸²å¸¸é‡æ± æ”¾åˆ°å †ä¸­ï¼Œèƒ½å¤Ÿæ›´é«˜æ•ˆåŠæ—¶åœ°å›æ”¶å­—ç¬¦ä¸²å†…å­˜ã€‚**













## ç±»åŠ è½½ :cactus:



### åŠ è½½æµç¨‹

Java çš„ç±»åŠ è½½è¿‡ç¨‹å¯ä»¥åˆ†ä¸º 5 ä¸ªé˜¶æ®µï¼šè½½å…¥ã€éªŒè¯ã€å‡†å¤‡ã€è§£æå’Œåˆå§‹åŒ–(**ä¸­é—´ä¸‰ä¸ªé˜¶æ®µå¯åˆå¹¶ä¸ºè¿æ¥**)ã€‚è¿™ 5 ä¸ªé˜¶æ®µä¸€èˆ¬æ˜¯é¡ºåºå‘ç”Ÿçš„ï¼Œä½†åœ¨åŠ¨æ€ç»‘å®šçš„æƒ…å†µä¸‹ï¼Œè§£æé˜¶æ®µå‘ç”Ÿåœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹å

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-loading-procedure.png" style="zoom: 67%;" />



1ã€è½½å…¥

ç±»åŠ è½½è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œä¸»è¦å®Œæˆä¸‹é¢ 3 ä»¶äº‹æƒ…ï¼š

1. é€šè¿‡å…¨ç±»å**è·å–**å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ

   > è™šæ‹Ÿæœºè§„èŒƒä¸Šé¢è¿™ 3 ç‚¹å¹¶ä¸å…·ä½“ï¼Œå› æ­¤æ˜¯éå¸¸çµæ´»çš„ã€‚æ¯”å¦‚ï¼š"é€šè¿‡å…¨ç±»åè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ" å¹¶æ²¡æœ‰æŒ‡æ˜å…·ä½“ä»å“ªé‡Œè·å–ï¼ˆ `ZIP`ã€ `JAR`ã€`EAR`ã€`WAR`ã€ç½‘ç»œã€åŠ¨æ€ä»£ç†æŠ€æœ¯è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆã€å…¶ä»–æ–‡ä»¶ç”Ÿæˆæ¯”å¦‚ `JSP`...ï¼‰ã€æ€æ ·è·å–

2. **å°†å­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„**ã€‚

3. **åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ `Class` å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™äº›æ•°æ®çš„è®¿é—®å…¥å£**



åŠ è½½è¿™ä¸€æ­¥ä¸»è¦æ˜¯é€šè¿‡æˆ‘ä»¬åé¢è¦è®²åˆ°çš„ **ç±»åŠ è½½å™¨** å®Œæˆçš„ã€‚ç±»åŠ è½½å™¨æœ‰å¾ˆå¤šç§ï¼Œå½“æˆ‘ä»¬æƒ³è¦åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå…·ä½“æ˜¯å“ªä¸ªç±»åŠ è½½å™¨åŠ è½½ç”± **åŒäº²å§”æ´¾æ¨¡å‹** å†³å®šï¼ˆä¸è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ‰“ç ´ç”±åŒäº²å§”æ´¾æ¨¡å‹ï¼‰

æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ `ClassLoader`ã€‚ä¸è¿‡ï¼Œæ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ `ClassLoader` åˆ›å»ºçš„ï¼Œè€Œæ˜¯ JVM åœ¨éœ€è¦çš„æ—¶å€™è‡ªåŠ¨åˆ›å»ºçš„ï¼Œæ•°ç»„ç±»é€šè¿‡`getClassLoader()`æ–¹æ³•è·å– `ClassLoader` çš„æ—¶å€™å’Œè¯¥æ•°ç»„çš„å…ƒç´ ç±»å‹çš„ `ClassLoader` æ˜¯ä¸€è‡´çš„ã€‚

ä¸€ä¸ªéæ•°ç»„ç±»çš„åŠ è½½é˜¶æ®µï¼ˆåŠ è½½é˜¶æ®µè·å–ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµçš„åŠ¨ä½œï¼‰æ˜¯å¯æ§æ€§æœ€å¼ºçš„é˜¶æ®µï¼Œè¿™ä¸€æ­¥æˆ‘ä»¬å¯ä»¥å»å®Œæˆè¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»æ§åˆ¶å­—èŠ‚æµçš„è·å–æ–¹å¼ï¼ˆé‡å†™ä¸€ä¸ªç±»åŠ è½½å™¨çš„ `loadClass()` æ–¹æ³•ï¼‰

> æ•°ç»„ç±»æ˜¯æŒ‡ç”¨äºè¡¨ç¤ºæ•°ç»„å¯¹è±¡çš„ç±»,Javaä¸­æ•°ç»„ç±»çš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š
>
> 1. æ•°ç»„ç±»æ˜¯Javaçš„å†…ç½®ç±»ï¼Œä¸éœ€è¦é¢å¤–å¯¼å…¥
> 2. æ•°ç»„ç±»æ˜¯Javaè¯­è¨€æä¾›çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨å¤šä¸ªç›¸åŒæ•°æ®ç±»å‹çš„å…ƒç´ 
> 3. æ•°ç»„ç±»æ˜¯å¯¹è±¡ï¼Œç»§æ‰¿è‡ª`java.lang.Object`ç±»ï¼Œå› æ­¤å®ƒå¯ä»¥ä½¿ç”¨`Object`ç±»çš„æ–¹æ³•ï¼Œæ¯”å¦‚`toString()`å’Œ`hashCode()`ç­‰

JVM åœ¨è¯¥é˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯**å°†å­—èŠ‚ç ä»ä¸åŒçš„æ•°æ®æº**ï¼ˆå¯èƒ½æ˜¯ class æ–‡ä»¶ã€ä¹Ÿå¯èƒ½æ˜¯ jar åŒ…ï¼Œç”šè‡³ç½‘ç»œï¼‰**è½¬åŒ–ä¸ºäºŒè¿›åˆ¶å­—èŠ‚æµåŠ è½½åˆ°å†…å­˜ä¸­**ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„ `java.lang.Class` å¯¹è±¡







2ã€éªŒè¯

JVM ä¼šåœ¨è¯¥é˜¶æ®µå¯¹äºŒè¿›åˆ¶å­—èŠ‚æµè¿›è¡Œæ ¡éªŒï¼Œåªæœ‰ç¬¦åˆ JVM å­—èŠ‚ç è§„èŒƒçš„æ‰èƒ½è¢« JVM æ­£ç¡®æ‰§è¡Œã€‚**è¯¥é˜¶æ®µæ˜¯ä¿è¯ JVM å®‰å…¨çš„é‡è¦å±éšœï¼Œé˜²æ­¢æ¶æ„ä»£ç çš„æ‰§è¡Œ**ï¼ŒéªŒè¯é˜¶æ®µä¸»è¦ç”±å››ä¸ªæ£€éªŒé˜¶æ®µç»„æˆï¼š

1. æ–‡ä»¶æ ¼å¼éªŒè¯ï¼ˆClass æ–‡ä»¶æ ¼å¼æ£€æŸ¥ï¼‰
2. å…ƒæ•°æ®éªŒè¯ï¼ˆå­—èŠ‚ç è¯­ä¹‰æ£€æŸ¥ï¼‰
3. å­—èŠ‚ç éªŒè¯ï¼ˆç¨‹åºè¯­ä¹‰æ£€æŸ¥ï¼‰
4. ç¬¦å·å¼•ç”¨éªŒè¯ï¼ˆç±»çš„æ­£ç¡®æ€§æ£€æŸ¥ï¼‰

ä¸‹é¢æ˜¯ä¸€äº›ä¸»è¦çš„æ£€æŸ¥ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-loading-process-verification.png" style="zoom: 80%;" />

æ–‡ä»¶æ ¼å¼éªŒè¯è¿™ä¸€é˜¶æ®µæ˜¯åŸºäºè¯¥ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµè¿›è¡Œçš„ï¼Œä¸»è¦ç›®çš„æ˜¯ä¿è¯è¾“å…¥çš„å­—èŠ‚æµèƒ½æ­£ç¡®åœ°è§£æå¹¶å­˜å‚¨äºæ–¹æ³•åŒºä¹‹å†…ï¼Œæ ¼å¼ä¸Šç¬¦åˆæè¿°ä¸€ä¸ª Java ç±»å‹ä¿¡æ¯çš„è¦æ±‚ã€‚é™¤äº†è¿™ä¸€é˜¶æ®µä¹‹å¤–ï¼Œ**å…¶ä½™ä¸‰ä¸ªéªŒè¯é˜¶æ®µéƒ½æ˜¯åŸºäºæ–¹æ³•åŒºçš„å­˜å‚¨ç»“æ„ä¸Šè¿›è¡Œçš„ï¼Œä¸ä¼šå†ç›´æ¥è¯»å–ã€æ“ä½œå­—èŠ‚æµäº†**

**ç¬¦å·å¼•ç”¨éªŒè¯å‘ç”Ÿåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„è§£æé˜¶æ®µï¼Œå…·ä½“ç‚¹è¯´æ˜¯ JVM å°†ç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨**çš„æ—¶å€™





3ã€å‡†å¤‡

**å‡†å¤‡é˜¶æ®µæ˜¯æ­£å¼ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡é»˜è®¤å€¼çš„é˜¶æ®µ**ï¼Œè¿™äº›å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­åˆ†é…(ä¸åŒç‰ˆæœ¬jdkæ–¹æ³•åŒºå®ç°ä¸åŒï¼Œå¯¼è‡´ç±»å˜é‡å­˜æ”¾çš„ä½ç½®ä¹Ÿä¸åŒ)

> å¯¹äºè¯¥é˜¶æ®µæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š
>
> 1. è¿™æ—¶å€™è¿›è¡Œå†…å­˜åˆ†é…çš„ä»…åŒ…æ‹¬ç±»å˜é‡ï¼ˆ Class Variables ï¼Œå³**é™æ€å˜é‡**ï¼Œè¢« `static` å…³é”®å­—ä¿®é¥°çš„å˜é‡ï¼Œåªä¸ç±»ç›¸å…³ï¼Œå› æ­¤è¢«ç§°ä¸ºç±»å˜é‡ï¼‰ï¼Œè€Œ**ä¸åŒ…æ‹¬å®ä¾‹å˜é‡**ã€‚å®ä¾‹å˜é‡ä¼šåœ¨å¯¹è±¡å®ä¾‹åŒ–æ—¶éšç€å¯¹è±¡ä¸€å—åˆ†é…åœ¨ Java å †ä¸­ã€‚
> 2. ä»æ¦‚å¿µä¸Šè®²ï¼Œç±»å˜é‡æ‰€ä½¿ç”¨çš„å†…å­˜éƒ½åº”å½“åœ¨ **æ–¹æ³•åŒº** ä¸­è¿›è¡Œåˆ†é…ã€‚ä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šJDK 7 ä¹‹å‰ï¼ŒHotSpot ä½¿ç”¨æ°¸ä¹…ä»£æ¥å®ç°æ–¹æ³•åŒºçš„æ—¶å€™ï¼Œå®ç°æ˜¯å®Œå…¨ç¬¦åˆè¿™ç§é€»è¾‘æ¦‚å¿µçš„ã€‚ è€Œ**åœ¨ JDK 7 åŠä¹‹åï¼ŒHotSpot å·²ç»æŠŠåŸæœ¬æ”¾åœ¨æ°¸ä¹…ä»£çš„å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç­‰ç§»åŠ¨åˆ°å †ä¸­ï¼Œè¿™ä¸ªæ—¶å€™ç±»å˜é‡åˆ™ä¼šéšç€ Class å¯¹è±¡ä¸€èµ·å­˜æ”¾åœ¨ Java å †ä¸­(è¿™å—å¾ˆé‡è¦ï¼ï¼ï¼)**
> 3. è¿™é‡Œæ‰€è®¾ç½®çš„åˆå§‹å€¼"é€šå¸¸æƒ…å†µ"ä¸‹æ˜¯æ•°æ®ç±»å‹é»˜è®¤çš„é›¶å€¼ï¼ˆå¦‚ 0ã€0Lã€nullã€false ç­‰ï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬å®šä¹‰äº†`public static int value=111` ï¼Œé‚£ä¹ˆ value å˜é‡åœ¨å‡†å¤‡é˜¶æ®µçš„åˆå§‹å€¼å°±æ˜¯ 0 è€Œä¸æ˜¯ 111ï¼ˆåˆå§‹åŒ–é˜¶æ®µæ‰ä¼šèµ‹å€¼ï¼‰ã€‚ç‰¹æ®Šæƒ…å†µï¼šæ¯”å¦‚ç»™ value å˜é‡åŠ ä¸Šäº† final å…³é”®å­—`public static final int value=111` ï¼Œé‚£ä¹ˆå‡†å¤‡é˜¶æ®µ value çš„å€¼å°±è¢«èµ‹å€¼ä¸º 111

JVM ä¼šåœ¨è¯¥é˜¶æ®µå¯¹ç±»å˜é‡ï¼ˆä¹Ÿç§°ä¸ºé™æ€å˜é‡ï¼Œ`static` å…³é”®å­—ä¿®é¥°çš„ï¼‰åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ï¼ˆå¯¹åº”æ•°æ®ç±»å‹çš„é»˜è®¤åˆå§‹å€¼ï¼Œå¦‚ 0ã€0Lã€nullã€false ç­‰ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´å‡å¦‚æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š

```java
public String chenmo = "æ²‰é»˜";
public static String wanger = "ç‹äºŒ";
public static final String cmower = "æ²‰é»˜ç‹äºŒ";
```

- `chenmo` ä¸ä¼šè¢«åˆ†é…å†…å­˜ï¼Œè€Œ `wanger` ä¼šï¼›ä½† `wanger` çš„åˆå§‹å€¼ä¸æ˜¯â€œç‹äºŒâ€è€Œæ˜¯ `null`ã€‚

- éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`static final` ä¿®é¥°çš„å˜é‡è¢«ç§°ä½œä¸ºå¸¸é‡ï¼Œå’Œç±»å˜é‡ä¸åŒã€‚å¸¸é‡ä¸€æ—¦èµ‹å€¼å°±ä¸ä¼šæ”¹å˜äº†ï¼Œæ‰€ä»¥ `cmower` åœ¨å‡†å¤‡é˜¶æ®µçš„å€¼ä¸ºâ€œ`æ²‰é»˜ç‹äºŒ`â€è€Œä¸æ˜¯ `null`
- å­—ç¬¦ä¸²å¸¸é‡`"æ²‰é»˜ç‹äºŒ"`è¢«å­˜æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œåœ¨JAVA7ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨æ–¹æ³•åŒºä¸­ï¼ŒJAVA7(åŒ…æ‹¬)ä¹‹åå­—ç¬¦ä¸²å¸¸é‡æ± åŠé™æ€å˜é‡éƒ½è¢«è½¬ç§»åˆ°äº†å †ä¸­ï¼ï¼







4ã€è§£æ

**è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹**

> 1. **ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referenceï¼‰ï¼š** åœ¨Javaä»£ç çš„ç¼–è¯‘é˜¶æ®µï¼Œæ‰€æœ‰çš„ç±»åã€æ–¹æ³•åã€å­—æ®µåç­‰éƒ½ä»¥ç¬¦å·å¼•ç”¨çš„å½¢å¼å­˜åœ¨ã€‚ç¬¦å·å¼•ç”¨æ˜¯ä¸€ç§ç¬¦å·åŒ–çš„å¼•ç”¨ï¼Œå®ƒ**å¹¶ä¸å…·ä½“æŒ‡å‘å†…å­˜ä¸­çš„å®é™…æ•°æ®**ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯¹å…¶æ‰€å¼•ç”¨ç›®æ ‡çš„ç¬¦å·åŒ–æè¿°ã€‚ä¾‹å¦‚ï¼Œåœ¨Javaä»£ç ä¸­ä½¿ç”¨ç±»åè°ƒç”¨æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„å¼•ç”¨åœ¨ç¼–è¯‘é˜¶æ®µæ˜¯ä»¥ç¬¦å·å¼•ç”¨çš„æ–¹å¼å­˜åœ¨
> 2. **ç›´æ¥å¼•ç”¨ï¼ˆDirect Referenceï¼‰ï¼š** åœ¨Javaä»£ç çš„è¿è¡Œæ—¶é˜¶æ®µï¼Œè™šæ‹Ÿæœºéœ€è¦**é€šè¿‡ç¬¦å·å¼•ç”¨æ¥å®šä½å…·ä½“çš„å†…å­˜åœ°å€**ã€‚åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œè™šæ‹Ÿæœºä¼šå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œå³å°†ç±»ã€æ–¹æ³•ã€å­—æ®µç­‰ç¬¦å·å¼•ç”¨è§£æä¸ºå®é™…çš„å†…å­˜åœ°å€ã€‚**ç›´æ¥å¼•ç”¨å¯ä»¥æ˜¯æŒ‡å‘æ–¹æ³•åŒºä¸­çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€å †ä¸­çš„å¯¹è±¡å®ä¾‹ã€æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„æœ¬åœ°æ–¹æ³•ç­‰**

ä¾‹å¦‚ï¼Œè€ƒè™‘ä»¥ä¸‹ä¸¤ä¸ªJavaç±»ï¼š

```java
// MyClass.java
public class MyClass {
    public static void main(String[] args) {
        int result = MyUtils.add(3, 5);
        System.out.println("Result: " + result);
    }
}
```

```java
// MyUtils.java
public class MyUtils {
    public static int add(int a, int b) {
        return a + b;
    }
}
```

åœ¨`MyClass`ç±»çš„`main`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†`MyUtils`ç±»çš„`add`æ–¹æ³•ã€‚åœ¨ç¼–è¯‘é˜¶æ®µï¼ŒJavaç¼–è¯‘å™¨ä¼šç”Ÿæˆç¬¦å·å¼•ç”¨ï¼Œè¡¨ç¤º`MyUtils.add`æ–¹æ³•çš„è°ƒç”¨

åœ¨è¿è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä¼šå°†è¿™ä¸ªç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚å‡è®¾**`MyUtils`ç±»å·²ç»è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œ`add`æ–¹æ³•ä¹Ÿå·²ç»è¢«è§£æåˆ°æ–¹æ³•åŒºä¸­çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚è™šæ‹Ÿæœºé€šè¿‡è§£æç¬¦å·å¼•ç”¨ï¼Œå¾—åˆ°å…·ä½“çš„å†…å­˜åœ°å€ï¼Œä½¿å¾—ä»£ç èƒ½å¤Ÿæ­£ç¡®åœ°è°ƒç”¨`MyUtils.add`æ–¹æ³•ï¼Œè®¡ç®—å‡ºç»“æœå¹¶è¾“å‡º**ã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼Œ**ç¬¦å·å¼•ç”¨æ˜¯åœ¨ä»£ç ç¼–è¯‘é˜¶æ®µç”Ÿæˆçš„ï¼Œè€Œç›´æ¥å¼•ç”¨æ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡è§£æç¬¦å·å¼•ç”¨å¾—åˆ°çš„**ï¼Œä½¿å¾—Javaç¨‹åºèƒ½å¤Ÿæ­£ç¡®åœ°è®¿é—®å’Œè°ƒç”¨å…¶ä»–ç±»ä¸­çš„æ–¹æ³•



**ç»¼ä¸Šæ‰€è¿°ï¼š**è§£æé˜¶æ®µæ˜¯è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯å¾—åˆ°ç±»æˆ–è€…å­—æ®µã€æ–¹æ³•åœ¨å†…å­˜ä¸­çš„æŒ‡é’ˆæˆ–è€…åç§»é‡ã€‚	

> åœ¨Javaå­—èŠ‚ç ä¸­ï¼Œç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referenceï¼‰æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç¤ºç¬¦å·åç§°ï¼ˆå¦‚ç±»åã€å­—æ®µåã€æ–¹æ³•åï¼‰çš„å¼•ç”¨ï¼Œè€Œä¸æ˜¯ç›´æ¥æŒ‡å‘å¯¹åº”çš„å†…å­˜åœ°å€æˆ–å…·ä½“å®ç°ã€‚ç¬¦å·å¼•ç”¨æ˜¯ä¸€ç§æŠ½è±¡çš„å¼•ç”¨ï¼Œå®ƒåœ¨ç¼–è¯‘æœŸé—´ç”¨äºè¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼Œæœ€ç»ˆåœ¨**è¿è¡Œ**æ—¶é€šè¿‡è§£æè½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚
>
> ç¬¦å·å¼•ç”¨åœ¨Javaå­—èŠ‚ç ä¸­é€šå¸¸ç”¨å¸¸é‡æ± ï¼ˆ`Constant Pool`ï¼‰æ¥è¡¨ç¤ºã€‚å¸¸é‡æ± æ˜¯å­—èŠ‚ç æ–‡ä»¶ä¸­çš„ä¸€ä¸ªè¡¨ï¼Œç”¨äºå­˜å‚¨ç±»ã€å­—æ®µã€æ–¹æ³•ç­‰çš„ç¬¦å·å¼•ç”¨ä¿¡æ¯ã€‚å®ƒåŒ…å«äº†å¤šç§å¸¸é‡ç±»å‹ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ç¬¦å·å¼•ç”¨ã€‚
>
> åœ¨å¸¸é‡æ± ä¸­ï¼Œ**ç¬¦å·å¼•ç”¨ä¼šè¢«ç¼–ç æˆä¸€ä¸ªç´¢å¼•å€¼ï¼Œè¯¥ç´¢å¼•å€¼æŒ‡å‘å¸¸é‡æ± ä¸­å¦ä¸€ä¸ªå¸¸é‡é¡¹ã€‚è¿™ä¸ªè¢«ç´¢å¼•çš„å¸¸é‡é¡¹å…·ä½“è¡¨ç¤ºäº†ç¬¦å·å¼•ç”¨çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€å±çš„ç±»åã€å­—æ®µæˆ–æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ç­‰**ã€‚
>
> é€šè¿‡ç¬¦å·å¼•ç”¨çš„ä½¿ç”¨ï¼Œ**Javaå­—èŠ‚ç å®ç°äº†ä¸€ç§é—´æ¥å¼•ç”¨çš„æ–¹å¼ï¼Œä½¿å¾—ç±»ã€å­—æ®µå’Œæ–¹æ³•çš„å¼•ç”¨åœ¨ç¼–è¯‘æœŸé—´å¯ä»¥è§£æå’Œç¡®è®¤**ï¼Œ**è€Œå…·ä½“çš„å†…å­˜åœ°å€æˆ–å®ç°åˆ™åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æå’Œè¿æ¥(è¿è¡Œæ—¶æ‰æ‰§è¡Œå­—èŠ‚ç æ–‡ä»¶)**ã€‚



5ã€åˆå§‹åŒ–

**åˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• `<classinit> ()`æ–¹æ³•çš„è¿‡ç¨‹ï¼Œæ˜¯ç±»åŠ è½½çš„æœ€åä¸€æ­¥ï¼Œè¿™ä¸€æ­¥ JVM æ‰å¼€å§‹çœŸæ­£æ‰§è¡Œç±»ä¸­å®šä¹‰çš„ Java ç¨‹åºä»£ç (å­—èŠ‚ç )**

è¯¥é˜¶æ®µæ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„æœ€åä¸€æ­¥ã€‚**åœ¨å‡†å¤‡é˜¶æ®µï¼Œç±»å˜é‡å·²ç»è¢«èµ‹è¿‡é»˜è®¤åˆå§‹å€¼ï¼Œè€Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œç±»å˜é‡å°†è¢«èµ‹å€¼ä¸ºä»£ç æœŸæœ›èµ‹çš„å€¼**ï¼Œåœ¨Javaä¸­å¯¹ç±»å˜é‡(é™æ€å˜é‡)è¿›è¡Œåˆå§‹å€¼è®¾å®šæœ‰ä¸¤ç§æ–¹å¼:

- å£°æ˜ç±»å˜é‡æ˜¯æŒ‡å®šåˆå§‹å€¼
- ä½¿ç”¨é™æ€ä»£ç å—ä¸ºç±»å˜é‡æŒ‡å®šåˆå§‹å€¼



> **ç±»åˆå§‹åŒ–æ—¶æœº**: åªæœ‰å½“å¯¹ç±»çš„ä¸»åŠ¨ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼Œç±»çš„ä¸»åŠ¨ä½¿ç”¨åŒ…æ‹¬ä»¥ä¸‹å…­ç§:
>
> - åˆ›å»ºç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯newçš„æ–¹å¼
> - è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼
> - è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•
> - åå°„(å¦‚Class.forName("com.pdai.jvm.Test"))
> - åˆå§‹åŒ–æŸä¸ªç±»çš„å­ç±»ï¼Œåˆ™å…¶çˆ¶ç±»ä¹Ÿä¼šè¢«åˆå§‹åŒ–
> - Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»(Java Test)ï¼Œç›´æ¥ä½¿ç”¨java.exeå‘½ä»¤æ¥è¿è¡ŒæŸä¸ªä¸»ç±»



6ã€ä½¿ç”¨ä¸å¸è½½

**å¸è½½ç±»å³è¯¥ç±»çš„ Class å¯¹è±¡è¢« GC**ï¼Œå¸è½½ç±»éœ€è¦æ»¡è¶³ 3 ä¸ªè¦æ±‚:

1. è¯¥ç±»çš„æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡éƒ½å·²è¢« GCï¼Œä¹Ÿå°±æ˜¯è¯´å †ä¸å­˜åœ¨è¯¥ç±»çš„å®ä¾‹å¯¹è±¡ã€‚
2. è¯¥ç±»æ²¡æœ‰åœ¨å…¶ä»–ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨
3. è¯¥ç±»çš„ç±»åŠ è½½å™¨çš„å®ä¾‹å·²è¢« GC

æ‰€ä»¥ï¼Œåœ¨ `JVM` ç”Ÿå‘½å‘¨æœŸå†…ï¼Œç”± `jvm` è‡ªå¸¦çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯ä¸ä¼šè¢«å¸è½½çš„ã€‚ä½†æ˜¯ç”±æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯å¯èƒ½è¢«å¸è½½çš„ã€‚

åªè¦æƒ³é€šä¸€ç‚¹å°±å¥½äº†ï¼Œ**JDK è‡ªå¸¦çš„ `BootstrapClassLoader`, `ExtClassLoader`, `AppClassLoader` è´Ÿè´£åŠ è½½ JDK æä¾›çš„ç±»ï¼Œæ‰€ä»¥å®ƒä»¬(ç±»åŠ è½½å™¨çš„å®ä¾‹)è‚¯å®šä¸ä¼šè¢«å›æ”¶**ã€‚è€Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨çš„å®ä¾‹æ˜¯å¯ä»¥è¢«å›æ”¶çš„ï¼Œæ‰€ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯å¯ä»¥è¢«å¸è½½æ‰çš„





### ç±»åŠ è½½å™¨

> **JVM åˆ¤å®šä¸¤ä¸ª Java ç±»æ˜¯å¦ç›¸åŒçš„å…·ä½“è§„åˆ™**ï¼šJVM ä¸ä»…è¦çœ‹ç±»çš„å…¨åæ˜¯å¦ç›¸åŒï¼Œè¿˜è¦çœ‹åŠ è½½æ­¤ç±»çš„ç±»åŠ è½½å™¨æ˜¯å¦ä¸€æ ·ã€‚åªæœ‰ä¸¤è€…éƒ½ç›¸åŒçš„æƒ…å†µï¼Œæ‰è®¤ä¸ºä¸¤ä¸ªç±»æ˜¯ç›¸åŒçš„ã€‚å³ä½¿ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ª `Class` æ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸åŒ

å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»(`.class`)æœ¬èº«ä¸€åŒç¡®å®šå…¶åœ¨ JVM ä¸­çš„å”¯ä¸€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸¤ä¸ªç±»çš„åŠ è½½å™¨ä¸åŒï¼Œå³ä½¿ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ª`class`å­—èŠ‚ç æ–‡ä»¶ï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰ï¼ˆæ¯”å¦‚ä¸¤ä¸ªç±»çš„ Class å¯¹è±¡ä¸ `equals`ï¼‰

- ç±»åŠ è½½å™¨æ˜¯ä¸€ä¸ªè´Ÿè´£åŠ è½½ç±»çš„å¯¹è±¡ï¼Œç”¨äºå®ç°ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åŠ è½½è¿™ä¸€æ­¥
- æ¯ä¸ª Java ç±»éƒ½æœ‰ä¸€ä¸ªå¼•ç”¨æŒ‡å‘åŠ è½½å®ƒçš„ `ClassLoader`
- æ•°ç»„ç±»ä¸æ˜¯é€šè¿‡ `ClassLoader` åˆ›å»ºçš„ï¼ˆæ•°ç»„ç±»æ²¡æœ‰å¯¹åº”çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼‰ï¼Œæ˜¯ç”± JVM ç›´æ¥ç”Ÿæˆçš„

ç«™åœ¨ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹ï¼ŒJava ç±»åŠ è½½å™¨å¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼š

1ï¼‰å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆ`Bootstrap Class-Loader`ï¼‰ï¼ŒåŠ è½½ `jre/lib` åŒ…ä¸‹é¢çš„ jar æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´å¸¸è§çš„ rt.jarã€‚

2ï¼‰æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆ`Extension or Ext Class-Loader`ï¼‰ï¼ŒåŠ è½½ `jre/lib/ext` åŒ…ä¸‹é¢çš„ jar æ–‡ä»¶ã€‚

3ï¼‰åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆ`Application or AppClass-Loader`ï¼‰ï¼Œæ ¹æ®ç¨‹åºçš„ç±»è·¯å¾„ï¼ˆ`classpath`ï¼‰æ¥åŠ è½½ Java ç±»ã€‚

> JVM ä¸­å†…ç½®äº†ä¸‰ä¸ªé‡è¦çš„ `ClassLoader`ï¼š
>
> 1. **`BootstrapClassLoader`(å¯åŠ¨ç±»åŠ è½½å™¨)**ï¼šæœ€é¡¶å±‚çš„åŠ è½½ç±»ï¼Œç”± C++å®ç°ï¼Œé€šå¸¸è¡¨ç¤ºä¸º nullï¼Œå¹¶ä¸”æ²¡æœ‰çˆ¶çº§ï¼Œä¸»è¦ç”¨æ¥åŠ è½½ JDK å†…éƒ¨çš„æ ¸å¿ƒç±»åº“ï¼ˆ `%JAVA_HOME%/lib`ç›®å½•ä¸‹çš„ `rt.jar`ã€`resources.jar`ã€`charsets.jar`ç­‰ jar åŒ…å’Œç±»ï¼‰ä»¥åŠè¢« `-Xbootclasspath`å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»
> 2. **`ExtensionClassLoader`(æ‰©å±•ç±»åŠ è½½å™¨)**ï¼šä¸»è¦è´Ÿè´£åŠ è½½ `%JRE_HOME%/lib/ext` ç›®å½•ä¸‹çš„ jar åŒ…å’Œç±»ä»¥åŠè¢« `java.ext.dirs` ç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»
> 3. **`AppClassLoader`(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)**ï¼šé¢å‘æˆ‘ä»¬ç”¨æˆ·çš„åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½å½“å‰åº”ç”¨ classpath ä¸‹çš„æ‰€æœ‰ jar åŒ…å’Œç±»

æ¥ä¸€æ®µä»£ç åˆ†æä¸€ä¸‹ï¼š

```java
public class Test {
	public static void main(String[] args) {
		ClassLoader loader = Test.class.getClassLoader();
		while (loader != null) {
			System.out.println(loader.toString());
			loader = loader.getParent();
		}
	}
}
```

æ¯ä¸ª Java ç±»éƒ½ç»´æŠ¤ç€ä¸€ä¸ªæŒ‡å‘å®šä¹‰å®ƒçš„ç±»åŠ è½½å™¨çš„å¼•ç”¨ï¼Œé€šè¿‡ `ç±»å.class.getClassLoader()` å¯ä»¥è·å–åˆ°æ­¤å¼•ç”¨ï¼›ç„¶åé€šè¿‡ `loader.getParent()` å¯ä»¥è·å–ç±»åŠ è½½å™¨çš„ä¸Šå±‚ç±»åŠ è½½å™¨ã€‚

è¿™æ®µä»£ç çš„è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```text
sun.misc.Launcher$AppClassLoader@73d16e93
sun.misc.Launcher$ExtClassLoader@15db9742
```

ç¬¬ä¸€è¡Œè¾“å‡ºä¸º `Test` çš„ç±»åŠ è½½å™¨ï¼Œå³åº”ç”¨ç±»åŠ è½½å™¨`AppClassLoader`ï¼Œå®ƒæ˜¯ `sun.misc.Launcher$AppClassLoader` ç±»çš„å®ä¾‹ï¼›ç¬¬äºŒè¡Œè¾“å‡ºä¸ºæ‰©å±•ç±»åŠ è½½å™¨`ExtensionClassLoader`ï¼Œæ˜¯ `sun.misc.Launcher$ExtClassLoader` ç±»çš„å®ä¾‹ã€‚é‚£å¯åŠ¨ç±»åŠ è½½å™¨å‘¢ï¼Ÿ

æŒ‰ç†è¯´ï¼Œæ‰©å±•ç±»åŠ è½½å™¨çš„ä¸Šå±‚ç±»åŠ è½½å™¨æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨`BootStrapLoader`ï¼Œä½†åœ¨è¿™ä¸ªç‰ˆæœ¬çš„ JDK ä¸­ï¼Œ æ‰©å±•ç±»åŠ è½½å™¨çš„ `getParent()` è¿”å› `null`ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å‡ºã€‚

> **ä¸ºä»€ä¹ˆ è·å–åˆ° `ClassLoader` ä¸º`null`å°±æ˜¯ `BootstrapClassLoader` åŠ è½½çš„å‘¢ï¼Ÿ** è¿™æ˜¯å› ä¸º`BootstrapClassLoader` ç”± C++ å®ç°ï¼Œç”±äºè¿™ä¸ª C++ å®ç°çš„ç±»åŠ è½½å™¨åœ¨ Java ä¸­æ˜¯æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„ç±»çš„ï¼Œæ‰€ä»¥æ‹¿åˆ°çš„ç»“æœæ˜¯ null

é™¤äº†è¿™ä¸‰ç§ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥åŠ å…¥è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥è¿›è¡Œæ‹“å±•ï¼Œä»¥æ»¡è¶³è‡ªå·±çš„ç‰¹æ®Šéœ€æ±‚ã€‚å°±æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ Java ç±»çš„å­—èŠ‚ç ï¼ˆ `.class` æ–‡ä»¶ï¼‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ è½½æ—¶å†åˆ©ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¯¹å…¶è§£å¯†

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-loader-parents-delegation-model.png" style="zoom:67%;" />



> å¦‚ä½•è‡ªå®šä¹‰`ClassLoader`ç±»åŠ è½½å™¨ï¼Ÿ

é™¤äº† `BootstrapClassLoader` å…¶ä»–ç±»åŠ è½½å™¨å‡ç”± `Java` å®ç°ä¸”å…¨éƒ¨ç»§æ‰¿è‡ª`java.lang.ClassLoader`ã€‚å¦‚æœæˆ‘ä»¬è¦è‡ªå®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå¾ˆæ˜æ˜¾éœ€è¦ç»§æ‰¿ `ClassLoader`æŠ½è±¡ç±»

`ClassLoader` ç±»æœ‰ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼š

- `protected Class loadClass(String name, boolean resolve)`ï¼šåŠ è½½æŒ‡å®šäºŒè¿›åˆ¶åç§°çš„ç±»ï¼Œ**å®ç°äº†åŒäº²å§”æ´¾æœºåˆ¶**ã€‚`name` ä¸ºç±»çš„äºŒè¿›åˆ¶åç§°ï¼Œ`resove` å¦‚æœä¸º trueï¼Œåœ¨åŠ è½½æ—¶è°ƒç”¨ `resolveClass(Class<?> c)` æ–¹æ³•è§£æè¯¥ç±»

  `loadClass(String name, boolean resolve)` æ–¹æ³•ï¼šè¯¥æ–¹æ³•æ˜¯ `ClassLoader` ç±»ä¸­çš„ä¸»è¦æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ ¹æ®ç»™å®šçš„ç±»ååŠ è½½ç›¸åº”çš„ç±»ã€‚è¿™ä¸ªæ–¹æ³•é¦–å…ˆä¼šæ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²ç»åŠ è½½äº†è¯¥ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½äº†ï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç±»ï¼›å¦‚æœæ²¡æœ‰åŠ è½½ï¼Œåˆ™ä¼šè°ƒç”¨çˆ¶ç±»åŠ è½½å™¨æ¥å°è¯•åŠ è½½ç±»ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨ä¹Ÿæ²¡æœ‰åŠ è½½è¯¥ç±»ï¼Œåˆ™ä¼šè°ƒç”¨ `findClass()` æ–¹æ³•æ¥åŠ è½½ç±»ã€‚

- `protected Class findClass(String name)`ï¼šæ ¹æ®ç±»çš„äºŒè¿›åˆ¶åç§°æ¥æŸ¥æ‰¾ç±»ï¼Œé»˜è®¤å®ç°æ˜¯ç©ºæ–¹æ³•ã€‚

  è¯¥æ–¹æ³•æ˜¯ `ClassLoader` ä¸­çš„ä¿æŠ¤æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯æŸ¥æ‰¾å¹¶åŠ è½½æŒ‡å®šåç§°çš„ç±»ã€‚å¦‚æœå­ç±»éœ€è¦åŠ è½½ä¸€ä¸ªæ–°çš„ç±»ï¼Œå¯ä»¥é‡å†™è¯¥æ–¹æ³•ã€‚åœ¨å®ç°è¯¥æ–¹æ³•æ—¶ï¼Œé€šå¸¸æ˜¯é€šè¿‡è¯»å–å­—èŠ‚ç æ–‡ä»¶ï¼Œå¹¶è°ƒç”¨ `defineClass()` æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªç±»çš„ `Class` å¯¹è±¡ã€‚

æ€»çš„æ¥è¯´ï¼Œ`loadClass()` æ–¹æ³•ä¸»è¦è´Ÿè´£å§”æ´¾çˆ¶ç±»åŠ è½½å™¨æ¥åŠ è½½ç±»ï¼Œè€Œ `findClass()` æ–¹æ³•åˆ™æ˜¯å­ç±»åŠ è½½å™¨ç”¨æ¥è‡ªå®šä¹‰åŠ è½½ç±»çš„å®ç°æ–¹æ³•









### åŒäº²å§”æ´¾æ¨¡å‹ :astonished:



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/class-loader-parents-delegation-model.png" style="zoom:75%;" />

- `ClassLoader` ç±»ä½¿ç”¨å§”æ‰˜æ¨¡å‹æ¥æœç´¢ç±»å’Œèµ„æºã€‚

- åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚

- **æ¯ä¸ª`ClassLoader` å®ä¾‹ä¼šåœ¨è¯•å›¾äº²è‡ªæŸ¥æ‰¾ç±»æˆ–èµ„æºä¹‹å‰ï¼Œå°†æœç´¢ç±»æˆ–èµ„æºçš„ä»»åŠ¡å§”æ‰˜ç»™å…¶çˆ¶ç±»åŠ è½½å™¨**



æ‰§è¡Œæµç¨‹æŒ‰ç…§å›¾ä¸­çš„ç†è§£åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

1. å½“`AppClassLoader`åŠ è½½ä¸€ä¸ª`class`æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨`ExtClassLoader`å»å®Œæˆ(é€šè¿‡`loadClass()`æ–¹æ³•æ¥å§”æ´¾ä¸Šå±‚)
2. å½“`ExtClassLoader`åŠ è½½ä¸€ä¸ª`class`æ—¶ï¼Œå®ƒé¦–å…ˆä¹Ÿä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠç±»åŠ è½½è¯·æ±‚å§”æ´¾ç»™`BootStrapClassLoader`å»å®Œæˆ
3. å¦‚æœ`BootStrapClassLoader`åŠ è½½å¤±è´¥(ä¾‹å¦‚åœ¨$JAVA_HOME/jre/libé‡ŒæœªæŸ¥æ‰¾åˆ°è¯¥class)ï¼Œä¼šä½¿ç”¨`ExtClassLoader`æ¥å°è¯•åŠ è½½ï¼›
4. è‹¥`ExtClassLoader`ä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šä½¿ç”¨`AppClassLoader`æ¥åŠ è½½ï¼Œå¦‚æœ`AppClassLoader`ä¹ŸåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šæŠ¥å‡ºå¼‚å¸¸`ClassNotFoundException`(æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰`classloader`æ‰å¤„ç†è¿™ç§æƒ…å†µ)





æ³¨æ„:question: : åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸æ˜¯ä¸€ç§å¼ºåˆ¶æ€§çš„çº¦æŸï¼Œåªæ˜¯ JDK å®˜æ–¹æ¨èçš„ä¸€ç§æ–¹å¼ã€‚å¦‚æœæˆ‘ä»¬å› ä¸ºæŸäº›ç‰¹æ®Šéœ€æ±‚æƒ³è¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåæ–‡ä¼šä»‹ç»å…·ä½“çš„æ–¹æ³•ã€‚

åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°ä»£ç éå¸¸ç®€å•:

```java
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        //é¦–å…ˆï¼Œæ£€æŸ¥è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡
        Class c = findLoadedClass(name);
        if (c == null) {
            //å¦‚æœ c ä¸º nullï¼Œåˆ™è¯´æ˜è¯¥ç±»æ²¡æœ‰è¢«åŠ è½½è¿‡
            long t0 = System.nanoTime();
            try {
                if (parent != null) {
                    //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡çˆ¶ç±»çš„loadClassæ¥åŠ è½½è¯¥ç±»
                    c = parent.loadClass(name, false);
                } else {
                    //å½“çˆ¶ç±»çš„åŠ è½½å™¨ä¸ºç©ºï¼Œåˆ™è°ƒç”¨å¯åŠ¨ç±»åŠ è½½å™¨æ¥åŠ è½½è¯¥ç±»
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                //éç©ºçˆ¶ç±»çš„ç±»åŠ è½½å™¨æ— æ³•æ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
            }

            if (c == null) {
                //å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½æ—¶ï¼Œåˆ™è°ƒç”¨findClassæ–¹æ³•æ¥åŠ è½½è¯¥ç±»
                //ç”¨æˆ·å¯é€šè¿‡è¦†å†™è¯¥æ–¹æ³•ï¼Œæ¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨
                long t1 = System.nanoTime();
                c = findClass(name);

                //ç”¨äºç»Ÿè®¡ç±»åŠ è½½å™¨ç›¸å…³çš„ä¿¡æ¯
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            //å¯¹ç±»è¿›è¡Œlinkæ“ä½œ
            resolveClass(c);
        }
        return c;
    }
}

```

ç»“åˆä¸Šé¢çš„æºç ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹åŒäº²å§”æ´¾æ¨¡å‹çš„æ‰§è¡Œæµç¨‹ï¼š

- åœ¨ç±»åŠ è½½çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šé¦–å…ˆåˆ¤æ–­å½“å‰ç±»æ˜¯å¦è¢«åŠ è½½è¿‡ã€‚å·²ç»è¢«åŠ è½½çš„ç±»ä¼šç›´æ¥è¿”å›ï¼Œå¦åˆ™æ‰ä¼šå°è¯•åŠ è½½ï¼ˆæ¯ä¸ªçˆ¶ç±»åŠ è½½å™¨éƒ½ä¼šèµ°ä¸€éè¿™ä¸ªæµç¨‹ï¼‰
- ç±»åŠ è½½å™¨åœ¨è¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼ˆè°ƒç”¨çˆ¶åŠ è½½å™¨ `loadClass()`æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰ï¼Œè¿™æ ·æ‰€æœ‰çš„è¯·æ±‚æœ€ç»ˆéƒ½ä¼šä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ `BootstrapClassLoader` ä¸­
- åªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼ˆè°ƒç”¨è‡ªå·±çš„ `findClass()` æ–¹æ³•æ¥åŠ è½½ç±»ï¼‰





> é‚£ä¹ˆä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹çš„å¥½å¤„åœ¨å“ªé‡Œï¼Ÿ

åŒäº²å§”æ´¾æ¨¡å‹ä¿è¯äº† Java ç¨‹åºçš„ç¨³å®šè¿è¡Œï¼Œå¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼ˆJVM åŒºåˆ†ä¸åŒç±»çš„æ–¹å¼ä¸ä»…ä»…æ ¹æ®ç±»åï¼Œç›¸åŒçš„ç±»æ–‡ä»¶è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½äº§ç”Ÿçš„æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»ï¼‰ï¼Œä¹Ÿä¿è¯äº† Java çš„æ ¸å¿ƒ API ä¸è¢«ç¯¡æ”¹ã€‚

å¦‚æœæ²¡æœ‰ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Œè€Œæ˜¯æ¯ä¸ªç±»åŠ è½½å™¨åŠ è½½è‡ªå·±çš„è¯å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç§°ä¸º `java.lang.Object` ç±»çš„è¯ï¼Œé‚£ä¹ˆç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šå‡ºç°ä¸¤ä¸ªä¸åŒçš„ `Object` ç±»ã€‚åŒäº²å§”æ´¾æ¨¡å‹å¯ä»¥ä¿è¯åŠ è½½çš„æ˜¯ JRE é‡Œçš„é‚£ä¸ª `Object` ç±»ï¼Œè€Œä¸æ˜¯ä½ å†™çš„ `Object` ç±»ã€‚è¿™æ˜¯å› ä¸º `AppClassLoader` åœ¨åŠ è½½ä½ çš„ `Object` ç±»æ—¶ï¼Œä¼šå§”æ‰˜ç»™ `ExtClassLoader` å»åŠ è½½ï¼Œè€Œ `ExtClassLoader` åˆä¼šå§”æ‰˜ç»™ `BootstrapClassLoader`ï¼Œ`BootstrapClassLoader` å‘ç°è‡ªå·±å·²ç»åŠ è½½è¿‡äº† `Object` ç±»ï¼Œä¼šç›´æ¥è¿”å›ï¼Œä¸ä¼šå»åŠ è½½ä½ å†™çš„ `Object` ç±»





> å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹å‘¢ï¼Ÿ

è‡ªå®šä¹‰åŠ è½½å™¨çš„è¯ï¼Œéœ€è¦ç»§æ‰¿ `ClassLoader` ã€‚å¦‚æœæˆ‘ä»¬è¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå°±éœ€è¦é‡å†™ `ClassLoader` ç±»ä¸­çš„ `findClass()` æ–¹æ³•å³å¯ï¼Œè¯¥æ–¹æ³•ä¼šåœ¨çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»æ—¶è¢«è°ƒç”¨ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ç±»çš„åŠ è½½è¿‡ç¨‹ï¼Œä»è€Œæ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ã€‚









> **`Tomcat`å¦‚ä½•å®ç°åº”ç”¨éš”ç¦»çš„ï¼Ÿ  **ä¸ºæ¯ä¸ªwebåº”ç”¨åˆ†é…ä¸€ä¸ªWebAppClassLoaderåŠ è½½å™¨å®ä¾‹



æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„ Tomcat æœåŠ¡å™¨ä¸ºäº†èƒ½å¤Ÿä¼˜å…ˆåŠ è½½ Web åº”ç”¨ç›®å½•ä¸‹çš„ç±»ï¼Œç„¶åå†åŠ è½½å…¶ä»–ç›®å½•ä¸‹çš„ç±»ï¼Œå°±è‡ªå®šä¹‰äº†ç±»åŠ è½½å™¨ `WebAppClassLoader` æ¥æ‰“ç ´åŒäº²å§”æ‰˜æœºåˆ¶ã€‚è¿™ä¹Ÿæ˜¯ Tomcat ä¸‹ Web åº”ç”¨ä¹‹é—´çš„ç±»å®ç°éš”ç¦»çš„å…·ä½“åŸç†

1ã€**WebAppClassLoader**

è‹¥ä½¿ç”¨JVMé»˜è®¤çš„`AppClassLoader`åŠ è½½Webåº”ç”¨ï¼Œ`AppClassLoader`åªèƒ½åŠ è½½ä¸€ä¸ª`Servlet`ç±»ï¼Œåœ¨åŠ è½½ç¬¬äºŒä¸ªåŒå`Servlet`ç±»æ—¶ï¼Œ`AppClassLoader`ä¼šè¿”å›ç¬¬ä¸€ä¸ª`Servlet`ç±»çš„`Class`å®ä¾‹ã€‚å› ä¸ºåœ¨`AppClassLoader`çœ¼é‡Œï¼ŒåŒå`Servlet`ç±»åªèƒ½è¢«åŠ è½½ä¸€æ¬¡,äºæ˜¯ï¼ŒTomcatè‡ªå®šä¹‰äº†ä¸€ä¸ªç±»åŠ è½½å™¨`WebAppClassLoader`ï¼Œ å¹¶ä¸ºæ¯ä¸ªWebåº”ç”¨åˆ›å»ºä¸€ä¸ª`WebAppClassLoader`å®ä¾‹

æ¯ä¸ªWebåº”ç”¨è‡ªå·±çš„Javaç±»å’Œä¾èµ–çš„JARåŒ…ï¼Œåˆ†åˆ«æ”¾åœ¨WEB-INF/classeså’ŒWEB-INF/libç›®å½•ä¸‹ï¼Œéƒ½æ˜¯WebAppClassLoaderåŠ è½½çš„

**Contextå®¹å™¨ç»„ä»¶å¯¹åº”ä¸€ä¸ªWebåº”ç”¨ï¼Œå› æ­¤ï¼Œæ¯ä¸ªContextå®¹å™¨åˆ›å»ºå’Œç»´æŠ¤ä¸€ä¸ªWebAppClassLoaderåŠ è½½å™¨å®ä¾‹**ã€‚ä¸åŒåŠ è½½å™¨å®ä¾‹åŠ è½½çš„ç±»è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ç±»ï¼Œå³ä½¿ç±»åç›¸åŒã€‚è¿™å°±ç›¸å½“äºåœ¨JVMå†…éƒ¨åˆ›å»ºç›¸äº’éš”ç¦»çš„Javaç±»ç©ºé—´ï¼Œæ¯ä¸ªWebåº”ç”¨éƒ½æœ‰è‡ªå·±çš„ç±»ç©ºé—´ï¼ŒWebåº”ç”¨ä¹‹é—´é€šè¿‡å„è‡ªçš„ç±»åŠ è½½å™¨äº’ç›¸éš”



2ã€**SharedClassLoader:**

ä¸¤ä¸ªWebåº”ç”¨ä¹‹é—´æ€ä¹ˆå…±äº«**åº“ç±»**ï¼Œå¹¶ä¸”ä¸èƒ½é‡å¤åŠ è½½ç›¸åŒçš„ç±»ï¼Ÿ

**åŒäº²å§”æ´¾æœºåˆ¶çš„å„å­åŠ è½½å™¨éƒ½èƒ½é€šè¿‡çˆ¶åŠ è½½å™¨å»åŠ è½½ç±»ï¼Œäºæ˜¯è€ƒè™‘æŠŠéœ€å…±äº«çš„ç±»æ”¾åˆ°çˆ¶åŠ è½½å™¨çš„åŠ è½½è·¯å¾„**

ä¸åŒçš„WEBåº”ç”¨ç¨‹åºå³æ˜¯é€šè¿‡è¯¥æ–¹å¼**å…±äº«JREæ ¸å¿ƒç±»**:

(1) Tomcatæäº†ä¸ªç±»åŠ è½½å™¨`SharedClassLoader`ï¼Œä½œä¸º`WebAppClassLoader`çš„çˆ¶åŠ è½½å™¨ï¼Œä»¥åŠ è½½Webåº”ç”¨ä¹‹é—´å…±äº«çš„ç±»

(2) è‹¥`WebAppClassLoader`æœªåŠ è½½åˆ°æŸç±»ï¼Œå°±å§”æ‰˜çˆ¶åŠ è½½å™¨`SharedClassLoader`å»åŠ è½½è¯¥ç±»ï¼Œ`SharedClassLoader`ä¼šåœ¨æŒ‡å®šç›®å½•ä¸‹åŠ è½½å…±äº«ç±»ï¼Œä¹‹åè¿”å›ç»™`WebAppClassLoader`ï¼Œå³å¯è§£å†³å…±äº«é—®é¢˜



3ã€**CatalinaClassLoader:**

å¦‚ä½•éš”ç¦»Tomcatæœ¬èº«çš„ç±»å’ŒWebåº”ç”¨çš„ç±»ï¼Ÿ

å…„å¼Ÿå…³ç³»ï¼šä¸¤ä¸ªç±»åŠ è½½å™¨æ˜¯å¹³è¡Œçš„ï¼Œå®ƒä»¬å¯èƒ½**æ‹¥æœ‰åŒä¸€çˆ¶åŠ è½½å™¨**ï¼Œ**ä½†ä¸¤ä¸ªå…„å¼Ÿç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯éš”ç¦»çš„**ã€‚äºæ˜¯ï¼ŒTomcatæäº†`CatalinaClassLoader`ï¼Œ**ä¸“é—¨åŠ è½½Tomcatè‡ªèº«çš„ç±»**

é—®é¢˜æ˜¯ï¼Œå½“Tomcatå’Œå„Webåº”ç”¨ä¹‹é—´éœ€è¦å…±äº«ä¸€äº›ç±»æ—¶è¯¥æ€ä¹ˆåŠï¼Ÿ(ä¾èµ–`CommonClassLoader`)



4ã€**CommonClassLoader:**

å…±äº«ä¾æ—§é çˆ¶å­å…³ç³»ã€‚

æ•…å†å¢åŠ ä¸ª`CommonClassLoader`ï¼Œä½œä¸º`CatalinaClassLoader`å’Œ`SharedClassLoader`çš„çˆ¶åŠ è½½å™¨ã€‚



`CommonClassLoader`èƒ½åŠ è½½çš„ç±»éƒ½å¯è¢«`CatalinaClassLoader`ã€`SharedClassLoader` ä½¿ç”¨ï¼Œè€Œ`CatalinaClassLoader`å’Œ`SharedClassLoader`èƒ½åŠ è½½çš„ç±»åˆ™ä¸å¯¹æ–¹ç›¸äº’éš”ç¦»ã€‚`WebAppClassLoader`å¯ä»¥ä½¿ç”¨`SharedClassLoader`åŠ è½½åˆ°çš„ç±»ï¼Œä½†å„ä¸ª`WebAppClassLoader`å®ä¾‹ä¹‹é—´ç›¸äº’éš”ç¦»



`Tomcat` çš„ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„å¦‚ä¸‹ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/tomcat.png" style="zoom:50%;" />

> **åœºæ™¯ï¼š**
>
> 1ã€å¦‚æœTomcaté‡Œé¢è¿è¡Œäº†ä¸¤ä¸ªWebåº”ç”¨ç¨‹åºï¼Œä¸¤ä¸ªWebåº”ç”¨ç¨‹åºä¸­æœ‰åŒåçš„[Servlet](https://so.csdn.net/so/search?q=Servlet&spm=1001.2101.3001.7020)ï¼Œä½†åŠŸèƒ½ä¸åŒï¼ŒTomcatéœ€è¦åŒæ—¶åŠ è½½å’Œç®¡ç†è¿™ä¸¤ä¸ªåŒåçš„ Servlet ç±»ï¼Œä¿è¯å®ƒä»¬ä¸ä¼šå†²çªï¼Œå› æ­¤ Web åº”ç”¨ä¹‹é—´çš„ç±»éœ€è¦éš”ç¦»
>
> 2ã€å¦‚æœä¸¤ä¸ª Web åº”ç”¨éƒ½ä¾èµ–åŒä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ JAR åŒ…ï¼Œæ¯”å¦‚ Springï¼Œé‚£ Spring çš„ JAR åŒ…è¢«åŠ è½½åˆ°å†…å­˜åï¼ŒTomcat è¦ä¿è¯è¿™ä¸¤ä¸ª Web åº”ç”¨èƒ½å¤Ÿå…±äº«ï¼Œä¹Ÿå°±æ˜¯è¯´Spring çš„ JAR åŒ…åªè¢«åŠ è½½ä¸€æ¬¡ï¼Œå¦åˆ™éšç€ä¾èµ–çš„ç¬¬ä¸‰æ–¹JAR åŒ…å¢å¤šï¼ŒJVM çš„å†…å­˜ä¼šè†¨èƒ€

è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š

(1)ä¸ºäº†è§£å†³`AppClassLoader`åŒç±»åçš„`Servlet`ç±»åªèƒ½è¢«åŠ è½½ä¸€æ¬¡çš„é—®é¢˜ï¼ŒTomcat è‡ªå®šä¹‰ä¸€ä¸ªç±»åŠ è½½å™¨`WebAppClassLoader`ï¼Œ å¹¶ä¸”ç»™æ¯ä¸ª Web åº”ç”¨åˆ›å»ºä¸€ä¸ªç±»åŠ è½½å™¨å®ä¾‹ã€‚Context å®¹å™¨ç»„ä»¶å¯¹åº”ä¸€ä¸ª Web åº”ç”¨ï¼Œå› æ­¤ï¼Œæ¯ä¸ª Context å®¹å™¨è´Ÿè´£åˆ›å»ºå’Œç»´æŠ¤ä¸€ä¸ª`WebAppClassLoader` åŠ è½½å™¨å®ä¾‹ã€‚**åŸç†æ˜¯ï¼Œä¸åŒçš„åŠ è½½å™¨å®ä¾‹åŠ è½½çš„ç±»è¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ç±»ï¼Œå³ä½¿å®ƒä»¬çš„ç±»åç›¸åŒã€‚è¿™å°±ç›¸å½“äºåœ¨ Java è™šæ‹Ÿæœºå†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªä¸ªç›¸äº’éš”ç¦»çš„ Java ç±»ç©ºé—´ï¼Œæ¯ä¸€ä¸ª Web åº”ç”¨éƒ½æœ‰è‡ªå·±çš„ç±»ç©ºé—´ï¼ŒWeb åº”ç”¨ä¹‹é—´é€šè¿‡å„è‡ªçš„ç±»åŠ è½½å™¨äº’ç›¸éš”ç¦»**

(2)**ä¸ºäº†Tomcatå¯ä»¥å­˜æ”¾å¤šä¸ªWebåº”ç”¨ï¼ŒTomcatå®ç°äº†Webåº”ç”¨çš„éš”ç¦»ï¼Œä»è€Œè¾¾åˆ°å¯ä»¥åŠ è½½ä¸åŒWebåº”ç”¨ä¸‹ç›¸åŒåçš„Servletç±»ï¼Œä»è€Œç¼–å†™äº†è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå…¶å†…éƒ¨ç±»åŠ è½½å™¨æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/tomcat.png" style="zoom:50%;" />

ï¼ˆ1ï¼‰`SharedClassLoader`ï¼šè¯¥ç±»åŠ è½½å™¨å­˜åœ¨æ˜¯ä¸ºäº†è§£å†³ä¸åŒWebåº”ç”¨ä¹‹é—´å…±äº«ç±»åº“ï¼Œå¹¶ä¸”ä¸ä¼šé‡å¤åŠ è½½ç›¸åŒçš„ç±»ã€‚å®ƒä½œä¸º`WebAppClassLoader`çš„çˆ¶åŠ è½½å™¨ï¼Œä¸“é—¨åŠ è½½Webåº”ç”¨ä¹‹é—´çš„å…±äº«ç±»ã€‚
ï¼ˆ2ï¼‰`CatalinaClassloader`ï¼šè¯¥ç±»åŠ è½½å™¨ä¸“é—¨åŠ è½½Tomcatè‡ªèº«çš„ç±»ï¼Œä»è€Œå’Œwebåº”ç”¨çš„ç±»åšä¸€ä¸ªéš”ç¦»ã€‚
ï¼ˆ3ï¼‰`CommonClassLoader`ï¼š`CatalinaClassLader`å®ç°äº†Tomcatç±»å’Œwebåº”ç”¨ç±»çš„éš”ç¦»ï¼Œå¦‚æœäºŒè€…ä¹‹é—´éœ€è¦å…±äº«ä¸€äº›ç±»æ€ä¹ˆåŠï¼Ÿè¿™é‡Œå°±éœ€è¦`CommonClassLoader`ï¼Œå®ƒæ‰€åŠ è½½çš„æ‰€æœ‰ç±»éƒ½å¯ä»¥è¢«`SharedClassLoader`å’Œ`CatalinaClassLoader`ä½¿ç”¨ï¼Œä»è€Œå®ç°webåº”ç”¨å’Œtomcatå¯¹ä¸€äº›ç±»çš„å…±äº«







## JIT & é€ƒé€¸åˆ†æ

é¦–å…ˆè¦çŸ¥é“`HotSpot` VMï¼š`OracleJDK`ï¼ˆå•†ç”¨ï¼‰å’Œ `OpenJDK`ï¼ˆå¼€æºï¼‰çš„é»˜è®¤è™šæ‹Ÿæœºï¼Œä¹Ÿæ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„ Java è™šæ‹Ÿæœºã€‚`HotSpot` çš„æŠ€æœ¯ä¼˜åŠ¿å°±åœ¨äºçƒ­ç‚¹ä»£ç æ¢æµ‹æŠ€æœ¯ï¼ˆåå­—å°±ä»è¿™æ¥ï¼‰å’Œå‡†ç¡®å¼å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œ**çƒ­ç‚¹ä»£ç æ¢æµ‹**æŒ‡çš„æ˜¯ï¼Œé€šè¿‡æ‰§è¡Œè®¡æ•°å™¨æ‰¾å‡ºæœ€å…·æœ‰ç¼–è¯‘ä»·å€¼çš„ä»£ç ï¼Œç„¶åé€šçŸ¥å³æ—¶ç¼–è¯‘å™¨ä»¥æ–¹æ³•ä¸ºå•ä½è¿›è¡Œç¼–è¯‘ï¼Œè§£é‡Šå™¨å°±å¯ä»¥ä¸å†é€è¡Œçš„å°†å­—èŠ‚ç ç¿»è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯å°†ä¸€æ•´ä¸ªæ–¹æ³•çš„æ‰€æœ‰å­—èŠ‚ç ç¿»è¯‘æˆæœºå™¨ç å†æ‰§è¡Œ

å¸¸è§çš„ç¼–è¯‘å‹è¯­è¨€å¦‚ C++ï¼Œé€šå¸¸ä¼šæŠŠä»£ç ç›´æ¥ç¼–è¯‘æˆ CPU æ‰€èƒ½ç†è§£çš„æœºå™¨ç æ¥è¿è¡Œã€‚è€Œ Java ä¸ºäº†å®ç°â€œä¸€æ¬¡ç¼–è¯‘ï¼Œå¤„å¤„è¿è¡Œâ€çš„ç‰¹æ€§ï¼ŒæŠŠç¼–è¯‘çš„è¿‡ç¨‹åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œé¦–å…ˆå®ƒä¼šå…ˆç”± javac ç¼–è¯‘æˆé€šç”¨çš„ä¸­é—´å½¢å¼â€”â€”å­—èŠ‚ç ï¼Œç„¶åå†ç”±è§£é‡Šå™¨é€æ¡å°†å­—èŠ‚ç è§£é‡Šä¸ºæœºå™¨ç æ¥æ‰§è¡Œã€‚æ‰€ä»¥åœ¨æ€§èƒ½ä¸Šï¼ŒJava å¯èƒ½ä¼šå¹²ä¸è¿‡ C++ è¿™ç±»ç¼–è¯‘å‹è¯­è¨€

ä¸ºäº†ä¼˜åŒ– Java çš„æ€§èƒ½ ï¼ŒJVM åœ¨è§£é‡Šå™¨ä¹‹å¤–å¼•å…¥äº† JIT ç¼–è¯‘å™¨ï¼šå½“ç¨‹åºè¿è¡Œæ—¶ï¼Œè§£é‡Šå™¨é¦–å…ˆå‘æŒ¥ä½œç”¨ï¼Œä»£ç å¯ä»¥ç›´æ¥æ‰§è¡Œã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œå³æ—¶ç¼–è¯‘å™¨é€æ¸å‘æŒ¥ä½œç”¨ï¼ŒæŠŠè¶Šæ¥è¶Šå¤šçš„ä»£ç ç¼–è¯‘ä¼˜åŒ–æˆæœ¬åœ°ä»£ç ï¼Œæ¥è·å–æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚è§£é‡Šå™¨è¿™æ—¶å¯ä»¥ä½œä¸ºç¼–è¯‘è¿è¡Œçš„é™çº§æ‰‹æ®µï¼Œåœ¨ä¸€äº›ä¸å¯é çš„ç¼–è¯‘ä¼˜åŒ–å‡ºç°é—®é¢˜æ—¶ï¼Œå†åˆ‡æ¢å›è§£é‡Šæ‰§è¡Œï¼Œä¿è¯ç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œ



> æ€ä¹ˆæ ·æ‰ä¼šè¢«è®¤ä¸ºæ˜¯çƒ­ç‚¹ä»£ç å‘¢ï¼Ÿ

JVMä¸­ä¼šè®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œ**å½“æ–¹æ³•æˆ–è€…ä»£ç å—çš„åœ¨ä¸€å®šæ—¶é—´å†…çš„è°ƒç”¨æ¬¡æ•°è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶å°±ä¼šè¢«ç¼–è¯‘ï¼Œå­˜å…¥`codeCache`ä¸­**ï¼Œå½“ä¸‹æ¬¡æ‰§è¡Œæ—¶ï¼Œå†é‡åˆ°è¿™æ®µä»£ç ï¼Œå°±ä¼šä»`CodeCache`ä¸­è¯»å–æœºå™¨ç ç›´æ¥æ‰§è¡Œï¼Œä»¥æ­¤æ¥æå‡ç¨‹åºè¿è¡Œçš„æ€§èƒ½ã€‚æ•´ä½“çš„æ‰§è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%83%AD%E7%82%B9%E4%BB%A3%E7%A0%81.png)



`CodeCache` ä¸­å­˜æ”¾çš„æ˜¯ `JIT` ç¼–è¯‘å™¨ç”Ÿæˆçš„**æœ¬åœ°ä»£ç **ï¼Œè€Œä¸æ˜¯å­—èŠ‚ç  `class` æ–‡ä»¶ï¼ï¼





é€ƒé€¸åˆ†æï¼š

è€Œé€ƒé€¸åˆ†ææ˜¯ä¸€ç§åœ¨ç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶ä¼˜åŒ–ä¸­ä½¿ç”¨çš„æŠ€æœ¯ï¼Œç”¨äºåˆ†æå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦åœ¨æ–¹æ³•ä¹‹å¤–è¢«å¼•ç”¨ï¼ˆå³é€ƒé€¸å‡ºæ–¹æ³•çš„ä½œç”¨åŸŸï¼‰ï¼Œä»¥ä¾¿è¿›è¡Œç›¸åº”çš„ä¼˜åŒ–ã€‚

åœ¨Javaä¸­ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•å†…éƒ¨è¢«åˆ›å»ºåï¼Œå®ƒå¯èƒ½è¢«åˆ†é…åˆ°æ ˆä¸Šæˆ–å †ä¸Šã€‚å¦‚æœåœ¨æ–¹æ³•å†…éƒ¨åˆ›å»ºçš„å¯¹è±¡æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„ä½œç”¨åŸŸï¼Œå³åœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨å¹¶ä¸ä¼šåœ¨æ–¹æ³•å¤–éƒ¨è¢«å¼•ç”¨ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶ç³»ç»Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œå°†å¯¹è±¡åˆ†é…åˆ°æ ˆä¸Šè€Œä¸æ˜¯å †ä¸Šã€‚

**é€ƒé€¸åˆ†æçš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡å‡å°‘å¯¹è±¡çš„å †åˆ†é…ï¼Œä»è€Œå‡å°‘åƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œæé«˜ç¨‹åºçš„æ€§èƒ½ã€‚åœ¨æ ˆä¸Šåˆ†é…å¯¹è±¡å¯ä»¥ä½¿å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ›´çŸ­ï¼Œå½“æ–¹æ³•è°ƒç”¨ç»“æŸæ—¶ï¼Œæ ˆä¸Šçš„å¯¹è±¡ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä¸éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œä»è€Œå‡å°‘äº†å†…å­˜çš„å¼€é”€å’Œåƒåœ¾å›æ”¶çš„æ—¶é—´**ï¼ŒåŒæ—¶é€ƒé€¸åˆ†æä¹Ÿåœ¨é”æ¶ˆé™¤ä¸­å‘æŒ¥äº†ä½œç”¨ï¼Œå¦‚æœä¸€ä¸ªå˜é‡å£°æ˜ä¸ºå±€éƒ¨å˜é‡ä¸”ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰€è®¿é—®(åªåœ¨è‡ªå·±æ ˆä¸­)ï¼Œé‚£ä¹ˆä¼šå°†ä¸€äº›ä¸å¿…è¦çš„é”ç»™æ¶ˆé™¤æ‰











## åƒåœ¾å›æ”¶

é’ˆå¯¹ HotSpot VM çš„å®ç°ï¼Œå®ƒé‡Œé¢çš„ GC å…¶å®å‡†ç¡®åˆ†ç±»åªæœ‰ä¸¤å¤§ç§ï¼š

éƒ¨åˆ†æ”¶é›† (Partial GC)ï¼š

- æ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC / Young GCï¼‰ï¼šåªå¯¹æ–°ç”Ÿä»£è¿›è¡Œåƒåœ¾æ”¶é›†ï¼›
- è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC / Old GCï¼‰ï¼šåªå¯¹è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ Major GC åœ¨æœ‰çš„è¯­å¢ƒä¸­ä¹Ÿç”¨äºæŒ‡ä»£æ•´å †æ”¶é›†ï¼›
- æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼šå¯¹æ•´ä¸ªæ–°ç”Ÿä»£å’Œéƒ¨åˆ†è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚

æ•´å †æ”¶é›† (Full GC)ï¼šæ”¶é›†æ•´ä¸ª Java å †å’Œæ–¹æ³•åŒº









### å¦‚ä½•åˆ¤æ–­æ­»äº¡å¯¹è±¡ï¼Ÿ





1ã€**å¼•ç”¨è®¡æ•°å™¨ï¼š**

å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReachability Countingï¼‰æ˜¯é€šè¿‡åœ¨å¯¹è±¡å¤´ä¸­åˆ†é…ä¸€ä¸ªç©ºé—´æ¥ä¿å­˜è¯¥å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼ˆReference Countï¼‰ã€‚å¦‚æœè¯¥å¯¹è±¡è¢«å…¶å®ƒå¯¹è±¡å¼•ç”¨ï¼Œåˆ™å®ƒçš„å¼•ç”¨è®¡æ•°åŠ 1ï¼Œå¦‚æœåˆ é™¤å¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒçš„å¼•ç”¨è®¡æ•°å°±å‡1ï¼Œå½“è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±ä¼šè¢«å›æ”¶ã€‚

```java
String m = new String("jack");
```

å…ˆåˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™æ—¶å€™"jack"æœ‰ä¸€ä¸ªå¼•ç”¨ mï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%BC%95%E7%94%A81.jpg" style="zoom: 67%;" />

ç„¶åå°† m è®¾ç½®ä¸º nullï¼Œè¿™æ—¶å€™"jack"çš„å¼•ç”¨æ¬¡æ•°å°±ç­‰äº0äº†ï¼Œåœ¨å¼•ç”¨è®¡æ•°ç®—æ³•ä¸­ï¼Œæ„å‘³ç€è¿™å—å†…å®¹å°±éœ€è¦è¢«å›æ”¶äº†

å¼•ç”¨è®¡æ•°ç®—æ³•æ˜¯**å°†åƒåœ¾å›æ”¶åˆ†æ‘Šåˆ°æ•´ä¸ªåº”ç”¨ç¨‹åºçš„è¿è¡Œå½“ä¸­äº†**ï¼Œè€Œä¸æ˜¯åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼šæŒ‚èµ·æ•´ä¸ªåº”ç”¨çš„è¿è¡Œï¼Œç›´åˆ°å¯¹å †ä¸­æ‰€æœ‰å¯¹è±¡çš„å¤„ç†éƒ½ç»“æŸã€‚å› æ­¤ï¼Œé‡‡ç”¨å¼•ç”¨è®¡æ•°çš„åƒåœ¾æ”¶é›†ä¸å±äºä¸¥æ ¼æ„ä¹‰ä¸Šçš„"`Stop-The-World`"çš„åƒåœ¾æ”¶é›†æœºåˆ¶

è€Œä¸”è¿™ç§ç®—æ³•å­˜åœ¨**å¾ªç¯å¼•ç”¨é—®é¢˜**ï¼š

```java
public class ReferenceCountingGC {
    public Object instance;
    public ReferenceCountingGC(String name)
    {

    }

}
public static void testGC(){
    ReferenceCountingGC a = new ReferenceCountingGC("objA");
    ReferenceCountingGC b = new ReferenceCountingGC("objB");
    a.instance = b;  //aå¼•ç”¨äº†b
    b.instance = a;  //bå¼•ç”¨äº†a
    
    //ç½®ç©ºå„è‡ªçš„å£°æ˜å¼•ç”¨
    a = null; 
    b = null;
}

```

å¯ä»¥çœ‹åˆ°ï¼Œæœ€åè¿™2ä¸ªå¯¹è±¡å·²ç»ä¸å¯èƒ½å†è¢«è®¿é—®äº†ï¼Œä½†ç”±äºä»–ä»¬ç›¸äº’å¼•ç”¨ç€å¯¹æ–¹ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°æ°¸è¿œéƒ½ä¸ä¼šä¸º0ï¼Œé€šè¿‡å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œä¹Ÿå°±æ°¸è¿œæ— æ³•é€šçŸ¥GCæ”¶é›†å™¨å›æ”¶å®ƒä»¬







2ã€**å¯è¾¾æ€§åˆ†æç®—æ³•ï¼š**

ç®—æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º **â€œ`GC Roots`â€** çš„å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼ŒèŠ‚ç‚¹æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ° `GC Roots` æ²¡æœ‰**ä»»ä½•å¼•ç”¨é“¾**ç›¸è¿çš„è¯ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ï¼Œéœ€è¦è¢«å›æ”¶(**å³ä¸€ä¸ªå¯¹è±¡æ²¡æœ‰è¢«ä»»ä½•å¼•ç”¨é“¾æ‰€ç›¸è¿**)

ä¸‹å›¾ä¸­çš„ `Object 6 ~ Object 10` ä¹‹é—´è™½æœ‰å¼•ç”¨å…³ç³»ï¼Œä½†å®ƒä»¬åˆ° `GC Roots` ä¸å¯è¾¾ï¼Œå› æ­¤ä¸ºéœ€è¦è¢«å›æ”¶çš„å¯¹è±¡ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/jvm-gc-roots.png" style="zoom: 67%;" />



ä»¥ä¸‹æ˜¯ä¸€äº›å¯ä»¥ä½œä¸º`GC Roots`çš„å¯¹è±¡ç±»å‹ï¼š

1. è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡ï¼šå³å½“å‰çº¿ç¨‹æ­£åœ¨ä½¿ç”¨çš„æ ˆå¸§ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚

2. æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ï¼šå³ç±»çš„é™æ€å˜é‡å¼•ç”¨çš„å¯¹è±¡ã€‚

3. æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼šå³åŒ…æ‹¬å­—ç¬¦ä¸²å¸¸é‡åœ¨å†…çš„å¸¸é‡æ± ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚

4. æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆJava Native Interfaceï¼‰å¼•ç”¨çš„å¯¹è±¡ï¼šå³ç”±æœ¬åœ°æ–¹æ³•ä»£ç åˆ›å»ºçš„å¯¹è±¡å¼•ç”¨ã€‚

5. **æ´»åŠ¨çº¿ç¨‹ï¼ˆActive Threadsï¼‰**ï¼š**æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ˜¯`GC Roots`ï¼Œè¿™äº›çº¿ç¨‹çš„è°ƒç”¨æ ˆä¸­çš„å¯¹è±¡éƒ½æ˜¯å¯è¾¾çš„**

6. **é™æ€å˜é‡ï¼ˆStatic Variablesï¼‰**ï¼šç±»çš„é™æ€æˆå‘˜å˜é‡å±äºç±»æœ¬èº«ï¼Œå› æ­¤å®ƒä»¬åœ¨ç±»åŠ è½½æ—¶è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­ã€‚æ•…æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ä¹Ÿå¯ä½œä¸º`GC Roots`

   

ä¾‹å­ï¼š

è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ ï¼Œæ­¤æ—¶çš„ s å³ä¸º GC Rootï¼Œå½“sç½®ç©ºæ—¶ï¼Œ`localParameter` å¯¹è±¡ä¹Ÿæ–­æ‰äº†ä¸ GC Root çš„å¼•ç”¨é“¾ï¼Œå°†è¢«å›æ”¶

```java
public class StackLocalParameter {
public StackLocalParameter(String name){}
}

public static void testGC(){
StackLocalParameter s = new StackLocalParameter("localParameter");
s = null;
}
```





> å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå¸¸é‡æ˜¯åºŸå¼ƒå¸¸é‡ï¼Ÿ

å‡å¦‚åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å­˜åœ¨å­—ç¬¦ä¸² "abc"ï¼Œå¦‚æœå½“å‰æ²¡æœ‰ä»»ä½• String å¯¹è±¡å¼•ç”¨è¯¥å­—ç¬¦ä¸²å¸¸é‡çš„è¯ï¼Œå°±è¯´æ˜å¸¸é‡ "abc" å°±æ˜¯åºŸå¼ƒå¸¸é‡ï¼Œå¦‚æœè¿™æ—¶å‘ç”Ÿå†…å­˜å›æ”¶çš„è¯è€Œä¸”æœ‰å¿…è¦çš„è¯ï¼Œ"abc" å°±ä¼šè¢«ç³»ç»Ÿæ¸…ç†å‡ºå¸¸é‡æ± äº†



> å¦‚ä½•åˆ¤æ–­ç±»æ˜¯å¦æ˜¯ä¸€ä¸ªæ— ç”¨çš„ç±»ï¼Ÿ

æ–¹æ³•åŒºä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»çš„å‘¢ï¼Ÿ

åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦æ˜¯â€œåºŸå¼ƒå¸¸é‡â€æ¯”è¾ƒç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»æ˜¯å¦æ˜¯â€œæ— ç”¨çš„ç±»â€çš„æ¡ä»¶åˆ™ç›¸å¯¹è‹›åˆ»è®¸å¤šã€‚ç±»éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ 3 ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ **â€œæ— ç”¨çš„ç±»â€**ï¼š

- è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹
- åŠ è½½è¯¥ç±»çš„ `ClassLoader` å·²ç»è¢«å›æ”¶
- è¯¥ç±»å¯¹åº”çš„ `java.lang.Class` å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•

è™šæ‹Ÿæœºå¯ä»¥å¯¹æ»¡è¶³ä¸Šè¿° 3 ä¸ªæ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œå¯ä»¥â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ä¸ä½¿ç”¨äº†å°±ä¼šå¿…ç„¶è¢«å›æ”¶









### å¼•ç”¨ç±»å‹æ€»ç»“

JDK1.2 ä¹‹å‰ï¼ŒJava ä¸­å¼•ç”¨çš„å®šä¹‰å¾ˆä¼ ç»Ÿï¼šå¦‚æœ reference ç±»å‹çš„æ•°æ®å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¿™å—å†…å­˜ä»£è¡¨ä¸€ä¸ªå¼•ç”¨

JDK1.2 ä»¥åï¼ŒJava å¯¹å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸ºå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨å››ç§ï¼ˆå¼•ç”¨å¼ºåº¦é€æ¸å‡å¼±ï¼‰



1. å¼ºå¼•ç”¨

è¢«å¼ºå¼•ç”¨å…³è”çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ã€‚ä½¿ç”¨ new ä¸€ä¸ªæ–°å¯¹è±¡çš„æ–¹å¼æ¥åˆ›å»ºå¼ºå¼•ç”¨

```java
Object obj = new Object();
```



2. è½¯å¼•ç”¨

**è¢«è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡åªæœ‰åœ¨å†…å­˜ä¸å¤Ÿçš„æƒ…å†µä¸‹æ‰ä¼šè¢«å›æ”¶**ã€‚ä½¿ç”¨ `SoftReference` ç±»æ¥åˆ›å»ºè½¯å¼•ç”¨

```java
Object obj = new Object();
SoftReference<Object> sf = new SoftReference<Object>(obj);  //sfè½¯å¼•ç”¨å…³è”äº†ç¬¬ä¸€è¡Œåˆ›å»ºçš„å¯¹è±¡
obj = null;  // ä½¿å¯¹è±¡åªè¢«è½¯å¼•ç”¨å…³è”
```

è½¯å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœè½¯å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJAVA è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªè½¯å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­



3. å¼±å¼•ç”¨

è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ä¸€å®šä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªèƒ½å­˜æ´»åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶å‘ç”Ÿä¹‹å‰(**åªè¦è¿›è¡ŒGCå°±ä¼šå›æ”¶å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡**)ï¼Œä½¿ç”¨ `WeakReference` ç±»æ¥å®ç°å¼±å¼•ç”¨

```java
Object obj = new Object();
WeakReference<Object> wf = new WeakReference<Object>(obj);  //wfå¼±å¼•ç”¨å…³è”äº†ç¬¬ä¸€è¡Œåˆ›å»ºçš„å¯¹è±¡
obj = null;
```

å¼±å¼•ç”¨å¯ä»¥å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰è”åˆä½¿ç”¨ï¼Œå¦‚æœå¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ŒJava è™šæ‹Ÿæœºå°±ä¼šæŠŠè¿™ä¸ªå¼±å¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­



4. è™šå¼•ç”¨

åˆç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨å–å¾—ä¸€ä¸ªå¯¹è±¡ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚ä½¿ç”¨ PhantomReference æ¥å®ç°è™šå¼•ç”¨

```java
Object obj = new Object();
PhantomReference<Object> pf = new PhantomReference<Object>(obj);
obj = null;
```

è™šå¼•ç”¨æ˜¯æœ€å¼±çš„å¼•ç”¨ç±»å‹ï¼Œæ— æ³•é€šè¿‡è™šå¼•ç”¨è·å–å¯¹è±¡ï¼Œä¸»è¦ç”¨äºå¯¹è±¡è¢«å›æ”¶æ—¶çš„é€šçŸ¥å’Œåç»­å¤„ç†







### åƒåœ¾æ”¶é›†ç®—æ³•



1ã€**æ ‡è®°æ¸…é™¤ç®—æ³•**(è€å¹´ä»£ç”¨)

åˆ†ä¸ºâ€œæ ‡è®°ï¼ˆMarkï¼‰â€å’Œâ€œæ¸…é™¤ï¼ˆSweepï¼‰â€é˜¶æ®µï¼šé¦–å…ˆæ ‡è®°å‡ºæ‰€æœ‰ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°å®Œæˆåç»Ÿä¸€å›æ”¶æ‰æ‰€æœ‰æ²¡æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ã€‚å®ƒæ˜¯æœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œåç»­çš„ç®—æ³•éƒ½æ˜¯å¯¹å…¶ä¸è¶³è¿›è¡Œæ”¹è¿›å¾—åˆ°ã€‚è¿™ç§åƒåœ¾æ”¶é›†ç®—æ³•ä¼šå¸¦æ¥ä¸¤ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š

1. **æ•ˆç‡é—®é¢˜**ï¼šæ ‡è®°å’Œæ¸…é™¤ä¸¤ä¸ªè¿‡ç¨‹æ•ˆç‡éƒ½ä¸é«˜ã€‚
2. **ç©ºé—´é—®é¢˜**ï¼šæ ‡è®°æ¸…é™¤åä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ã€‚

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mark-and-sweep-garbage-collection-algorithm.png" style="zoom: 67%;" />

æ•´ä¸ªæ ‡è®°-æ¸…é™¤è¿‡ç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š

1. å½“ä¸€ä¸ªå¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œç»™ä¸€ä¸ªæ ‡è®°ä½ï¼Œå‡è®¾ä¸º 0 (**falseâ€”è¡¨ç¤ºè¿˜æœªè¢«å¼•ç”¨**)ï¼›
2. åœ¨æ ‡è®°é˜¶æ®µï¼Œæˆ‘ä»¬å°†æ‰€æœ‰**å¯è¾¾å¯¹è±¡**ï¼ˆæˆ–ç”¨æˆ·å¯ä»¥å¼•ç”¨çš„å¯¹è±¡ï¼‰çš„æ ‡è®°ä½è®¾ç½®ä¸º 1 (true)ï¼›
3. **æ‰«æé˜¶æ®µæ¸…é™¤çš„å°±æ˜¯æ ‡è®°ä½ä¸º 0 (false)çš„å¯¹è±¡**





2ã€æ ‡è®°**å¤åˆ¶ç®—æ³•**(æ–°ç”Ÿä»£çš„ä¸¤ä¸ª`Survivor`åŒºå°±æ˜¯é‡‡å–è¿™ç§æ–¹æ³•æ¥å‡å°‘å†…å­˜ç¢ç‰‡ï¼ï¼ï¼)

ä¸ºäº†è§£å†³æ ‡è®°-æ¸…é™¤ç®—æ³•çš„æ•ˆç‡å’Œå†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œå¤åˆ¶ï¼ˆ`Copying`ï¼‰æ”¶é›†ç®—æ³•å‡ºç°äº†ã€‚å®ƒå¯ä»¥å°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤å—ï¼Œæ¯æ¬¡ä½¿ç”¨å…¶ä¸­çš„ä¸€å—ã€‚å½“è¿™ä¸€å—çš„å†…å­˜ä½¿ç”¨å®Œåï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å»ï¼Œç„¶åå†æŠŠä½¿ç”¨çš„ç©ºé—´ä¸€æ¬¡æ¸…ç†æ‰ã€‚è¿™æ ·å°±ä½¿æ¯æ¬¡çš„å†…å­˜å›æ”¶éƒ½æ˜¯å¯¹å†…å­˜åŒºé—´çš„ä¸€åŠè¿›è¡Œå›æ”¶

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/copying-garbage-collection-algorithm.png" style="zoom:67%;" />

  

è™½ç„¶æ”¹è¿›äº†æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œä½†ä¾ç„¶å­˜åœ¨ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

- **å¯ç”¨å†…å­˜å˜å°**ï¼šå¯ç”¨å†…å­˜ç¼©å°ä¸ºåŸæ¥çš„ä¸€åŠ
- **ä¸é€‚åˆè€å¹´ä»£**ï¼šå¦‚æœå­˜æ´»å¯¹è±¡æ•°é‡æ¯”è¾ƒå¤§ï¼Œ**å¤åˆ¶æ€§èƒ½**ä¼šå˜å¾—å¾ˆå·®





æ ‡è®°-å¤åˆ¶ç®—æ³•æ˜¯ä¸€ç§å¸¸è§çš„åƒåœ¾æ”¶é›†ç®—æ³•ï¼Œç”¨äºå›æ”¶æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰ä¸­çš„å†…å­˜ã€‚å®ƒä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š

1. **æ ‡è®°é˜¶æ®µï¼ˆMarkingï¼‰**ï¼š
   - åœ¨æ ‡è®°é˜¶æ®µï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œéå†æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬æ ‡è®°ä¸º"å­˜æ´»"ã€‚æ ¹å¯¹è±¡é€šå¸¸æ˜¯æŒ‡åº”ç”¨ç¨‹åºçš„æ ˆå¸§ä¸­çš„å¼•ç”¨å¯¹è±¡ã€é™æ€å¯¹è±¡ä»¥åŠJNIï¼ˆJava Native Interfaceï¼‰å¼•ç”¨ç­‰ã€‚
   - åœ¨è¿™ä¸ªé˜¶æ®µï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šåœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œè¿›è¡Œæ ‡è®°æ“ä½œ(`Stop the world`)ã€‚æ ‡è®°å®Œæˆåï¼Œæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½ä¼šè¢«æ ‡è®°ä¸º"å­˜æ´»"çŠ¶æ€ã€‚
2. **å¤åˆ¶é˜¶æ®µï¼ˆCopyingï¼‰**ï¼š
   - åœ¨å¤åˆ¶é˜¶æ®µï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šå°†æ‰€æœ‰æ ‡è®°ä¸º"å­˜æ´»"çš„å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªæ–°çš„SurvivoråŒºåŸŸï¼‰ä¸­ã€‚è¿™ä¸ªæ–°çš„å†…å­˜åŒºåŸŸè¢«ç§°ä¸º"To"ç©ºé—´æˆ–"to"åŒºåŸŸã€‚
   - å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œå­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°æ–°çš„å†…å­˜åŒºåŸŸï¼Œå¹¶æŒ‰ç…§å®ƒä»¬çš„ç›¸å¯¹ä½ç½®é¡ºåºæ’åˆ—(å‡å°‘äº†å†…å­˜ç¢ç‰‡)ï¼Œä¿æŒäº†å¯¹è±¡ä¹‹é—´çš„ç›¸å¯¹ä½ç½®å…³ç³»
3. **æ¸…ç†é˜¶æ®µï¼ˆCleaningï¼‰**ï¼š
   - åœ¨æ¸…ç†é˜¶æ®µï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šå°†æ‰€æœ‰çš„å¯¹è±¡ä»åŸæ¥çš„å†…å­˜åŒºåŸŸï¼ˆé€šå¸¸æ˜¯EdenåŒºåŸŸå’ŒSurvivoråŒºåŸŸï¼‰ä¸­æ¸…é™¤ã€‚è¿™ä¸ªåŸæ¥çš„å†…å­˜åŒºåŸŸè¢«ç§°ä¸º"From"ç©ºé—´æˆ–"from"åŒºåŸŸã€‚
   - åœ¨æ¸…ç†é˜¶æ®µï¼Œæ‰€æœ‰å·²ç»å¤åˆ¶åˆ°æ–°å†…å­˜åŒºåŸŸä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ¸…é™¤ï¼Œå¹¶ä¸”åŸæ¥çš„å†…å­˜åŒºåŸŸå°†å˜ä¸ºç©ºé—²çŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­ç”¨æ¥åˆ†é…æ–°çš„å¯¹è±¡ã€‚



å³å…ˆå°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ç©ºç™½å†…å­˜åŒºåŸŸï¼Œç„¶åå†æ¸…é™¤ä¹‹å‰çš„å†…å­˜åŒºåŸŸ



3ã€**æ ‡è®°æ•´ç†ç®—æ³•**(è€å¹´ä»£æ‰€é‡‡ç”¨çš„æ–¹å¼)

æ ‡è®°-æ•´ç†ï¼ˆMark-and-Compactï¼‰ç®—æ³•æ˜¯æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹æå‡ºçš„ä¸€ç§æ ‡è®°ç®—æ³•ï¼Œæ ‡è®°è¿‡ç¨‹ä»ç„¶ä¸â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸€æ ·ï¼Œä½†**åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡å›æ”¶ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰ç«¯è¾¹ç•Œä»¥å¤–çš„å†…å­˜**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/aaam.png" style="zoom:67%;" />

ç”±äºå¤šäº†æ•´ç†è¿™ä¸€æ­¥ï¼Œå› æ­¤æ•ˆç‡ä¹Ÿä¸é«˜ï¼Œé€‚åˆè€å¹´ä»£è¿™ç§åƒåœ¾å›æ”¶é¢‘ç‡ä¸æ˜¯å¾ˆé«˜çš„åœºæ™¯

> è€å¹´ä»£å æ®ç€2/3çš„å †å†…å­˜ç©ºé—´ï¼Œåªæœ‰åœ¨ Major GC çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ¸…ç†ï¼Œæ¯æ¬¡ GC éƒ½ä¼šè§¦å‘â€œStop-The-Worldâ€ã€‚å†…å­˜è¶Šå¤§ï¼ŒSTW çš„æ—¶é—´ä¹Ÿè¶Šé•¿ï¼Œæ‰€ä»¥å†…å­˜ä¹Ÿä¸ä»…ä»…æ˜¯è¶Šå¤§å°±è¶Šå¥½ã€‚**ç”±äºå¤åˆ¶ç®—æ³•åœ¨å¯¹è±¡å­˜æ´»ç‡è¾ƒé«˜çš„è€å¹´ä»£ä¼šè¿›è¡Œå¾ˆå¤šæ¬¡çš„å¤åˆ¶æ“ä½œï¼Œæ•ˆç‡å¾ˆä½ï¼Œæ‰€ä»¥è€å¹´ä»£è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ ‡è®° --- æ•´ç†ç®—æ³•**







4ã€**åˆ†ä»£æ”¶é›†ç®—æ³•**

å½“å‰è™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†éƒ½é‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œæ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒå°†å†…å­˜åˆ†ä¸ºå‡ å—ã€‚ä¸€èˆ¬å°† Java å †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å„ä¸ªå¹´ä»£çš„ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†ç®—æ³•ã€‚

æ¯”å¦‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œæ¯æ¬¡æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡å¯¹è±¡æ­»å»ï¼Œæ‰€ä»¥å¯ä»¥é€‰æ‹©â€å¤åˆ¶â€œç®—æ³•ï¼Œ**åªéœ€è¦ä»˜å‡ºå°‘é‡å¯¹è±¡çš„å¤åˆ¶æˆæœ¬å°±å¯ä»¥å®Œæˆæ¯æ¬¡åƒåœ¾æ”¶é›†(S0<â€”â€”>S1)**ã€‚è€Œè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»å‡ ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–çš„ç©ºé—´å¯¹å®ƒè¿›è¡Œåˆ†é…æ‹…ä¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é€‰æ‹©â€œæ ‡è®°-æ¸…é™¤â€æˆ–â€œæ ‡è®°-æ•´ç†â€ç®—æ³•è¿›è¡Œåƒåœ¾æ”¶é›†

> ä¸ºä»€ä¹ˆHotSpotè™šæ‹Ÿæœºè¦åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Ÿ
>
> 
>
> HotSpot JVMï¼ˆJavaè™šæ‹Ÿæœºï¼‰å°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰å’Œè€å¹´ä»£ï¼ˆOld Generationï¼‰æ˜¯ä¸ºäº†å®ç°æ›´é«˜æ•ˆçš„åƒåœ¾æ”¶é›†ç­–ç•¥å’Œå†…å­˜ç®¡ç†
>
> 1. **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå‡è®¾ï¼š** å¤§å¤šæ•°Javaåº”ç”¨ç¨‹åºä¸­çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­æš‚ï¼Œå³å®ƒä»¬åœ¨åˆ›å»ºåä¸ä¹…å°±å˜å¾—ä¸å¯è¾¾å¹¶ä¸”éœ€è¦è¢«å›æ”¶ã€‚ä½†ä¹Ÿæœ‰ä¸€äº›å¯¹è±¡å…·æœ‰è¾ƒé•¿çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦‚å…¨å±€å•ä¾‹å¯¹è±¡æˆ–ç¼“å­˜å¯¹è±¡ã€‚å°†å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæ˜¯åŸºäºè¿™ç§å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå‡è®¾ã€‚é€šè¿‡å°†æ–°åˆ›å»ºçš„å¯¹è±¡æ”¾åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œå¯ä»¥æ›´å¿«åœ°å›æ”¶è¿™äº›å¯¹è±¡ï¼Œè€Œè¾ƒé•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡åˆ™æ”¾åœ¨è€å¹´ä»£ï¼Œå‡å°‘é¢‘ç¹å›æ”¶è€å¹´ä»£çš„å¼€é”€ã€‚
> 2. **ä¸åŒåƒåœ¾å›æ”¶ç­–ç•¥ï¼š** æ–°ç”Ÿä»£å’Œè€å¹´ä»£é€šå¸¸ä½¿ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†ç­–ç•¥ã€‚åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œå› ä¸ºå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸçŸ­æš‚ï¼Œé€šå¸¸ä½¿ç”¨æ•ˆç‡è¾ƒé«˜çš„Minor GCï¼ˆMinor Garbage Collectionï¼‰ï¼Œå®ƒä¸»è¦å…³æ³¨æ–°ç”Ÿä»£ä¸­çš„åƒåœ¾å›æ”¶ã€‚è€Œè€å¹´ä»£ä¸­çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿ï¼Œä¼šé‡‡ç”¨æ›´è€—æ—¶ä½†å…¨é¢çš„Major GCï¼ˆMajor Garbage Collectionï¼‰æ¥è¿›è¡Œåƒåœ¾å›æ”¶ã€‚
> 3. **é¿å…å…¨å±€åƒåœ¾æ”¶é›†åœé¡¿ï¼š** å°†å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£å¯ä»¥å‡å°‘å…¨å±€åƒåœ¾æ”¶é›†å¸¦æ¥çš„åœé¡¿æ—¶é—´ã€‚åœ¨æ–°ç”Ÿä»£ä¸­æ‰§è¡Œé¢‘ç¹ä½†è¾ƒçŸ­æš‚çš„Minor GCï¼Œè€Œè€å¹´ä»£çš„Major GCè¾ƒå°‘ä¸”è€—æ—¶è¾ƒé•¿ã€‚è¿™æ ·å¯ä»¥åœ¨è¾ƒå°çš„å†…å­˜åŒºåŸŸå†…è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå‡å°‘å…¨å±€åƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„å“åº”æ€§ã€‚
> 4. **ç©ºé—´æ•ˆç‡ï¼š** å°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œæœ‰åŠ©äºæ›´å¥½åœ°åˆ©ç”¨å†…å­˜ç©ºé—´ã€‚æ–°ç”Ÿä»£é‡‡ç”¨è¾ƒå¤§çš„EdenåŒºå’Œä¸¤ä¸ªå°çš„SurvivoråŒºï¼ˆFromå’ŒToï¼‰ï¼Œå› ä¸ºæ–°å¯¹è±¡é€šå¸¸åœ¨EdenåŒºåˆ†é…ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šå¯¹è±¡æ˜¯çŸ­æš‚çš„ï¼Œæ‰€ä»¥è¾ƒå¤§çš„EdenåŒºæä¾›äº†æ›´é«˜çš„ç©ºé—´æ•ˆç‡ã€‚è€å¹´ä»£ç›¸å¯¹è¾ƒå¤§ï¼Œç”¨äºå­˜æ”¾ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡ã€‚









**5ã€ä¸‰è‰²æ ‡è®°æ³•**

ä¸‰è‰²æ ‡è®°æ³•å°†å¯¹è±¡çš„é¢œè‰²åˆ†ä¸ºäº†é»‘ã€ç°ã€ç™½ï¼Œä¸‰ç§é¢œè‰²ã€‚

- é»‘è‰²ï¼šè¯¥å¯¹è±¡å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œä¸”è¯¥å¯¹è±¡ä¸‹çš„å­å¯¹è±¡ä¹Ÿå…¨éƒ¨éƒ½è¢«æ ‡è®°è¿‡äº†ã€‚ï¼ˆç¨‹åºæ‰€éœ€è¦çš„å¯¹è±¡ï¼‰
- ç°è‰²ï¼šè¯¥å¯¹è±¡è‡ªèº«å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œä½†è¯¥å¯¹è±¡ä¸‹çš„å­å¯¹è±¡æ²¡æœ‰å…¨è¢«æ ‡è®°å®Œã€‚ï¼ˆGCéœ€è¦ä»æ­¤å¯¹è±¡ä¸­å»å¯»æ‰¾åƒåœ¾ï¼‰
- ç™½è‰²ï¼šæœªè¢«æ‰«æå¯¹è±¡ï¼Œå¦‚æœæ‰«æå®Œæ‰€æœ‰å¯¹è±¡ä¹‹åï¼Œæœ€ç»ˆä¸ºç™½è‰²çš„ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³åƒåœ¾å¯¹è±¡

![img](https://upload-images.jianshu.io/upload_images/25881088-0180395691fdfbef.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)



 æ ¹æ®å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œä» GC Roots å¼€å§‹è¿›è¡Œéå†è®¿é—®ã€‚

- åˆå§‹çŠ¶æ€ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç™½è‰²çš„ï¼Œåªæœ‰ GC Roots æ˜¯é»‘è‰²çš„ã€‚

<img src="https://upload-images.jianshu.io/upload_images/25881088-1fbbbb3fbc892506.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom: 50%;" />

â€‹	



- åˆå§‹æ ‡è®°é˜¶æ®µï¼ŒGC Roots æ ‡è®°ç›´æ¥å…³è”å¯¹è±¡ç½®ä¸ºç°è‰²ã€‚

<img src="https://upload-images.jianshu.io/upload_images/25881088-0c81810021f46288.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />



- å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œæ‰«ææ•´ä¸ªå¼•ç”¨é“¾ã€‚
  - æ²¡æœ‰å­èŠ‚ç‚¹çš„è¯ï¼Œå°†æœ¬èŠ‚ç‚¹å˜ä¸ºé»‘è‰²ã€‚
  - æœ‰å­èŠ‚ç‚¹çš„è¯ï¼Œåˆ™å½“å‰èŠ‚ç‚¹å˜ä¸ºé»‘è‰²ï¼Œå­èŠ‚ç‚¹å˜ä¸ºç°è‰²ã€‚

<img src="https://upload-images.jianshu.io/upload_images/25881088-4e7d981058966ae1.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />

- é‡å¤å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œç›´è‡³ç°è‰²å¯¹è±¡æ²¡æœ‰å…¶å®ƒå­èŠ‚ç‚¹å¼•ç”¨æ—¶ç»“æŸã€‚

<img src="https://upload-images.jianshu.io/upload_images/25881088-194e16e47ef16cfc.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />

<img src="https://upload-images.jianshu.io/upload_images/25881088-4884e20ee151399b.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom: 50%;" />

- æ‰«æå®Œæˆ

  æ­¤æ—¶é»‘è‰²å¯¹è±¡å°±æ˜¯å­˜æ´»çš„å¯¹è±¡ï¼Œç™½è‰²å¯¹è±¡å°±æ˜¯å·²æ¶ˆäº¡å¯å›æ”¶çš„å¯¹è±¡ã€‚

  å³ï¼ˆAã€Dã€Eã€Fã€Gï¼‰å¯è¾¾ä¹Ÿå°±æ˜¯å­˜æ´»å¯¹è±¡ï¼Œï¼ˆBã€Cã€Hï¼‰ä¸å¯è¾¾å¯å›æ”¶çš„å¯¹è±¡ã€‚





å­˜åœ¨é—®é¢˜ï¼š

1. æµ®åŠ¨åƒåœ¾ï¼šå¹¶å‘æ ‡è®°çš„è¿‡ç¨‹ä¸­ï¼Œ**è‹¥ä¸€ä¸ªå·²ç»è¢«æ ‡è®°æˆé»‘è‰²æˆ–è€…ç°è‰²çš„å¯¹è±¡ï¼Œçªç„¶å˜æˆäº†åƒåœ¾(ä¸Šå›¾ä¸­Dâ€”>Eä¹‹é—´çš„å¼•ç”¨é“¾çªç„¶æ–­å¼€)ï¼Œæ­¤æ—¶ï¼Œæ­¤å¯¹è±¡ä¸æ˜¯ç™½è‰²çš„ä¸ä¼šè¢«æ¸…é™¤ï¼Œé‡æ–°æ ‡è®°ä¹Ÿä¸èƒ½ä»`GC Root`ä¸­å»æ‰¾åˆ°ï¼Œæ‰€ä»¥æˆä¸ºäº†æµ®åŠ¨åƒåœ¾**ï¼Œè¿™ç§æƒ…å†µå¯¹ç³»ç»Ÿçš„å½±å“ä¸å¤§ï¼Œç•™ç»™ä¸‹ä¸€æ¬¡GCè¿›è¡Œå¤„ç†å³å¯ã€‚

<img src="https://upload-images.jianshu.io/upload_images/25881088-d1f746e05b64dc4e.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />

å‡è®¾å·²ç»éå†åˆ° Eï¼ˆå˜ä¸ºç°è‰²äº†ï¼‰ï¼Œæ­¤æ—¶åº”ç”¨æ‰§è¡Œäº† objD.fieldE = null (D > E çš„å¼•ç”¨æ–­å¼€)

D > E çš„å¼•ç”¨æ–­å¼€ä¹‹åï¼ŒEã€Fã€G ä¸‰ä¸ªå¯¹è±¡ä¸å¯è¾¾ï¼Œåº”è¯¥è¦è¢«å›æ”¶çš„ã€‚ç„¶è€Œå› ä¸º E å·²ç»å˜ä¸ºç°è‰²äº†ï¼Œå…¶ä»ä¼šè¢«å½“ä½œå­˜æ´»å¯¹è±¡ç»§ç»­éå†ä¸‹å»ã€‚æœ€ç»ˆçš„ç»“æœæ˜¯ï¼šè¿™éƒ¨åˆ†å¯¹è±¡ä»ä¼šè¢«æ ‡è®°ä¸ºå­˜æ´»ï¼Œå³æœ¬è½® GC ä¸ä¼šå›æ”¶è¿™éƒ¨åˆ†å†…å­˜ã€‚







2. å¯¹è±¡æ¼æ ‡é—®é¢˜ï¼ˆéœ€è¦çš„å¯¹è±¡è¢«å›æ”¶ï¼‰ï¼šå¹¶å‘æ ‡è®°çš„è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªä¸šåŠ¡çº¿ç¨‹å°†ä¸€ä¸ªæœªè¢«æ‰«æè¿‡çš„ç™½è‰²å¯¹è±¡æ–­å¼€å¼•ç”¨æˆä¸ºåƒåœ¾ï¼ˆåˆ é™¤å¼•ç”¨ï¼‰ï¼ŒåŒæ—¶é»‘è‰²å¯¹è±¡å¼•ç”¨äº†è¯¥å¯¹è±¡ï¼ˆå¢åŠ å¼•ç”¨ï¼‰ï¼ˆè¿™ä¸¤éƒ¨å¯ä»¥ä¸åˆ†å…ˆåé¡ºåºï¼‰ï¼›å› ä¸ºé»‘è‰²å¯¹è±¡çš„å«ä¹‰ä¸ºå…¶å±æ€§éƒ½å·²ç»è¢«æ ‡è®°è¿‡äº†ï¼Œé‡æ–°æ ‡è®°ä¹Ÿä¸ä¼šä»é»‘è‰²å¯¹è±¡ä¸­å»æ‰¾ï¼Œå¯¼è‡´è¯¥å¯¹è±¡è¢«ç¨‹åºæ‰€éœ€è¦ï¼Œå´åˆè¦è¢«GCå›æ”¶ï¼Œæ­¤é—®é¢˜ä¼šå¯¼è‡´ç³»ç»Ÿå‡ºç°é—®é¢˜ï¼Œè€Œ`CMS`ä¸`G1`ï¼Œä¸¤ç§å›æ”¶å™¨åœ¨ä½¿ç”¨ä¸‰è‰²æ ‡è®°æ³•æ—¶ï¼Œéƒ½é‡‡å–äº†ä¸€äº›æªæ–½æ¥åº”å¯¹è¿™äº›é—®é¢˜ï¼Œ==CMSå¯¹å¢åŠ å¼•ç”¨ç¯èŠ‚è¿›è¡Œå¤„ç†ï¼ˆIncrement Updateï¼‰ï¼ŒG1åˆ™å¯¹åˆ é™¤å¼•ç”¨ç¯èŠ‚è¿›è¡Œå¤„ç†(SATB)ã€‚==

å‡è®¾ GC çº¿ç¨‹å·²ç»éå†åˆ° Eï¼ˆå˜ä¸ºç°è‰²äº†ï¼‰ï¼Œæ­¤æ—¶åº”ç”¨çº¿ç¨‹å…ˆæ‰§è¡Œäº†ï¼š

```
var G = objE.fieldG; objE.fieldG = null;  // ç°è‰²E æ–­å¼€å¼•ç”¨ ç™½è‰²G 
objD.fieldG = G;  // é»‘è‰²D å¼•ç”¨ ç™½è‰²G
```

<img src="https://upload-images.jianshu.io/upload_images/25881088-27fdde960bb1b29a.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />

æ­¤æ—¶åˆ‡å›åˆ° GC çº¿ç¨‹ï¼Œå› ä¸º E å·²ç»æ²¡æœ‰å¯¹ G çš„å¼•ç”¨äº†ï¼Œæ‰€ä»¥ä¸ä¼šå°† G ç½®ä¸ºç°è‰²ï¼›å°½ç®¡å› ä¸º D é‡æ–°å¼•ç”¨äº† Gï¼Œä½†å› ä¸º D å·²ç»æ˜¯é»‘è‰²äº†ï¼Œä¸ä¼šå†é‡æ–°åšéå†å¤„ç†ã€‚

æœ€ç»ˆå¯¼è‡´çš„ç»“æœæ˜¯ï¼šG ä¼šä¸€ç›´æ˜¯ç™½è‰²ï¼Œæœ€åè¢«å½“ä½œåƒåœ¾è¿›è¡Œæ¸…é™¤ã€‚è¿™ç›´æ¥å½±å“åˆ°äº†åº”ç”¨ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œæ˜¯ä¸å¯æ¥å—çš„ã€‚

æ€»ç»“å°±æ˜¯ï¼šå·²ç»è¢«æ ‡è®°ä¸ºé»‘è‰²çš„å¯¹è±¡ï¼Œåœ¨æ ‡è®°è¿‡ç¨‹ä¸­é‡æ–°å¼•ç”¨äº†ä¸€ä¸ªè¿˜æœªæ¥å¾—åŠè¢«ç›¸è¿çš„ç°è‰²å¯¹è±¡æ ‡è®°æ—¶ï¼Œç™½è‰²å¯¹è±¡å°±å·²ç»è¢«æ–­å¼€äº†ï¼Œè€Œç™½è‰²å¯¹è±¡ä¼šè¢«GCå›æ”¶ï¼Œå¯¼è‡´ç¨‹åºé”™è¯¯





**CMSè§£å†³åŠæ³•:å¢é‡æ›´æ–°**

åœ¨åº”å¯¹æ¼æ ‡é—®é¢˜æ—¶ï¼ŒCMSä½¿ç”¨äº†å¢é‡æ›´æ–°(Increment Update)æ–¹æ³•æ¥åšï¼š

åœ¨ä¸€ä¸ªæœªè¢«æ ‡è®°çš„å¯¹è±¡ï¼ˆç™½è‰²å¯¹è±¡ï¼‰è¢«é‡æ–°å¼•ç”¨åï¼Œ**ã€Œå¼•ç”¨å®ƒçš„å¯¹è±¡è‹¥ä¸ºé»‘è‰²åˆ™è¦å˜æˆç°è‰²ï¼Œåœ¨ä¸‹æ¬¡äºŒæ¬¡æ ‡è®°æ—¶è®©GCçº¿ç¨‹ç»§ç»­æ ‡è®°å®ƒçš„å±æ€§å¯¹è±¡ã€**ã€‚

ä½†æ˜¯å°±ç®—æ˜¯è¿™æ ·ï¼Œå…¶ä»ç„¶æ˜¯å­˜åœ¨æ¼æ ‡çš„é—®é¢˜ï¼š

- åœ¨ä¸€ä¸ªç°è‰²å¯¹è±¡æ­£åœ¨è¢«ä¸€ä¸ªGCçº¿ç¨‹å›æ”¶æ—¶ï¼Œå½“å®ƒå·²ç»è¢«æ ‡è®°è¿‡çš„å±æ€§æŒ‡å‘äº†ä¸€ä¸ªç™½è‰²å¯¹è±¡ï¼ˆåƒåœ¾ï¼‰
- è€Œè¿™ä¸ªå¯¹è±¡çš„å±æ€§å¯¹è±¡æœ¬èº«è¿˜æœªå…¨éƒ¨æ ‡è®°ç»“æŸï¼Œåˆ™ä¸ºç°è‰²ä¸å˜
- **ã€Œè€Œè¿™ä¸ªGCçº¿ç¨‹åœ¨æ ‡è®°å®Œæœ€åä¸€ä¸ªå±æ€§åï¼Œè®¤ä¸ºå·²ç»å°†æ‰€æœ‰çš„å±æ€§æ ‡è®°ç»“æŸäº†ï¼Œå°†è¿™ä¸ªç°è‰²å¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²ï¼Œè¢«é‡æ–°å¼•ç”¨çš„ç™½è‰²å¯¹è±¡ï¼Œæ— æ³•è¢«æ ‡è®°ã€**













### åƒåœ¾æ”¶é›†å™¨



åœ¨åƒåœ¾å›æ”¶ï¼ˆGCï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œååé‡å’Œåœé¡¿æ—¶é—´ä¹‹é—´é€šå¸¸å­˜åœ¨ä¸€ç§æƒè¡¡å…³ç³»ã€‚

**ååé‡æ˜¯æŒ‡å•ä½æ—¶é—´å†…cpuå®Œæˆçš„æœ‰æ•ˆå·¥ä½œé‡**ï¼Œä¾‹å¦‚ç¨‹åºæ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘æ‰€å ç”¨çš„æ—¶é—´æ¯”ä¾‹ã€‚

**åœé¡¿æ—¶é—´**æ˜¯æŒ‡GCè¿‡ç¨‹ä¸­**åº”ç”¨ç¨‹åºæš‚åœæ‰§è¡Œ**çš„æ—¶é—´ï¼Œä¹Ÿç§°ä¸ºåœé¡¿æˆ–æš‚åœæ—¶é—´





1ã€**`Serial`æ”¶é›†å™¨ï¼š**

è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚å®ƒçš„ **â€œå•çº¿ç¨‹â€** çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆ **"Stop The World"** ï¼‰ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸ

ä½†æ˜¯ Serial æ”¶é›†å™¨æœ‰æ²¡æœ‰ä¼˜äºå…¶ä»–åƒåœ¾æ”¶é›†å™¨çš„åœ°æ–¹å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œå®ƒ**ç®€å•è€Œé«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰**ã€‚Serial æ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œè‡ªç„¶å¯ä»¥è·å¾—å¾ˆé«˜çš„å•çº¿ç¨‹æ”¶é›†æ•ˆç‡ã€‚Serial æ”¶é›†å™¨å¯¹äºè¿è¡Œåœ¨ Client æ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ¥è¯´æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©







2ã€**`ParNew`æ”¶é›†å™¨ï¼š**

ParNew æ”¶é›†å™¨å…¶å®å°±æ˜¯ Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé™¤äº†**ä½¿ç”¨å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†å¤–**ï¼Œå…¶ä½™è¡Œä¸ºï¼ˆæ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€å›æ”¶ç­–ç•¥ç­‰ç­‰ï¼‰å’Œ Serial æ”¶é›†å™¨å®Œå…¨ä¸€æ ·

**æ–°ç”Ÿä»£é‡‡ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/parnew-garbage-collector.png" style="zoom: 80%;" />







3ã€**`Parallel Scavenge` æ”¶é›†å™¨:**

ä¸ `ParNew` ä¸€æ ·æ˜¯å¤šçº¿ç¨‹æ”¶é›†å™¨

**å…¶å®ƒæ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´**ï¼Œè€Œå®ƒçš„ç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼Œå®ƒè¢«ç§°ä¸ºâ€œååé‡ä¼˜å…ˆâ€æ”¶é›†å™¨ã€‚è¿™é‡Œçš„ååé‡æŒ‡ CPU ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´å æ€»æ—¶é—´çš„æ¯”å€¼

Parallel Scavenge æ”¶é›†å™¨å…³æ³¨ç‚¹æ˜¯ååé‡ï¼ˆé«˜æ•ˆç‡çš„åˆ©ç”¨ CPUï¼‰ã€‚CMS ç­‰åƒåœ¾æ”¶é›†å™¨çš„å…³æ³¨ç‚¹æ›´å¤šçš„æ˜¯ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ï¼ˆæé«˜ç”¨æˆ·ä½“éªŒï¼‰ã€‚





4ã€**CMSæ”¶é›†å™¨(é‡è¦:exclamation:**   é’ˆå¯¹çš„æ˜¯è€å¹´ä»£)

**CMSï¼ˆ`Concurrent` Mark Sweepï¼‰æ”¶é›†å™¨æ˜¯ä¸€ç§ä»¥è·å–æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ã€‚å®ƒéå¸¸ç¬¦åˆåœ¨æ³¨é‡ç”¨æˆ·ä½“éªŒçš„åº”ç”¨ä¸Šä½¿ç”¨ **

> CMSå›æ”¶å™¨ä¸»è¦**å…³æ³¨è€å¹´ä»£çš„å†…å­˜å›æ”¶**ï¼Œå®ƒé‡‡ç”¨äº†**å¹¶å‘æ ‡è®°-æ¸…é™¤**ï¼ˆMark-Sweepï¼‰ç®—æ³•ï¼Œä»¥æœ€å¤§ç¨‹åº¦åœ°å‡å°‘åƒåœ¾å›æ”¶æ—¶çš„åœé¡¿æ—¶é—´ã€‚åœ¨CMSå›æ”¶è¿‡ç¨‹ä¸­ï¼Œä¼š**å°½é‡é¿å…å…¨å±€çš„å†…å­˜æ•´ç†å’Œç§»åŠ¨å¯¹è±¡(G1åˆ™æ³¨é‡äº†å†…å­˜æ•´ç†ï¼Œå› ä¸ºG1åœ¨ä¸åŒºåˆ†ä»£çš„å‰æä¸‹å°†å†…å­˜åŒºåŸŸåˆ’åˆ†æˆäº†ä¸€ä¸ªä¸ª`Region`)**ï¼Œå› æ­¤å®ƒåœ¨è€å¹´ä»£çš„å›æ”¶å·¥ä½œæ˜¯ä»¥æ›´ç»†ç²’åº¦çš„åŒºåŸŸä¸ºå•ä½è¿›è¡Œçš„ã€‚
>
> å…·ä½“æ¥è¯´ï¼ŒCMSå›æ”¶å™¨å°†è€å¹´ä»£åˆ’åˆ†ä¸ºå¤šä¸ªè¾ƒå°çš„åŒºåŸŸï¼ˆä¹Ÿç§°ä¸ºCMSæ ‡è®°æ®µæˆ–CMSå—ï¼‰ï¼Œæ¯ä¸ªåŒºåŸŸå¯ä»¥ç‹¬ç«‹åœ°è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚CMSå›æ”¶å™¨é‡‡ç”¨å¹¶å‘æ ‡è®°çš„æ–¹å¼æ¥æ ‡è®°å­˜æ´»å¯¹è±¡ï¼Œç„¶åä½¿ç”¨æ¸…é™¤ï¼ˆSweepï¼‰é˜¶æ®µæ¥å›æ”¶æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ï¼Œå¹¶åœ¨æ¸…é™¤é˜¶æ®µå¯¹æ¯ä¸ªCMSæ ‡è®°æ®µè¿›è¡Œå¤„ç†ï¼Œå°†æœªè¢«æ ‡è®°çš„å¯¹è±¡å›æ”¶ã€‚

ä»åå­—ä¸­çš„**Mark Sweep**è¿™ä¸¤ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼ŒCMS æ”¶é›†å™¨æ˜¯ä¸€ç§ **â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•**å®ç°çš„ï¼Œå®ƒçš„è¿ä½œè¿‡ç¨‹ç›¸æ¯”äºå‰é¢å‡ ç§åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ›´åŠ å¤æ‚ä¸€äº›ã€‚æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š

- **åˆå§‹æ ‡è®°é˜¶æ®µï¼ˆInitial Markï¼‰**ï¼š

  - åˆå§‹æ ‡è®°é˜¶æ®µæ˜¯ä¸€æ¬¡çŸ­æš‚çš„æš‚åœï¼Œå®ƒæ ‡è®°å‡ºæ‰€æœ‰ç›´æ¥ä¸æ ¹å¯¹è±¡æœ‰å…³çš„å¯¹è±¡(**ä»€ä¹ˆæ ·çš„å¯¹è±¡å¯ä»¥è¢«è§†ä¸º`GC Roots`?**)ï¼ŒåŒ…æ‹¬ä»æ ¹å¯¹è±¡ç›´æ¥å¯è¾¾çš„å¯¹è±¡
  - **åœ¨è¿™ä¸ªé˜¶æ®µï¼Œåº”ç”¨ç¨‹åºçš„æ‰§è¡Œä¼šè¢«æš‚åœ**ï¼Œä»¥ç¡®ä¿ä»æ ¹å¯¹è±¡å‡ºå‘çš„å¼•ç”¨é“¾èƒ½å¤Ÿè¢«æ ‡è®°ä¸º"å¯è¾¾"ã€‚

  **å¹¶å‘æ ‡è®°é˜¶æ®µï¼ˆConcurrent Markï¼‰**ï¼š**å¼€å§‹éå†å¼•ç”¨é“¾ åŒæ—¶ç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œå¯¼è‡´å¼•ç”¨é“¾å†æ¬¡å‘ç”Ÿå°èŒƒå›´æ›´æ–°**

  - å¹¶å‘æ ‡è®°é˜¶æ®µæ˜¯CMSçš„ä¸»è¦ç‰¹ç‚¹ï¼Œå®ƒä¸åº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¹¶å‘è¿›è¡Œï¼Œä¸éœ€è¦æš‚åœåº”ç”¨ç¨‹åºã€‚
  - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒCMSæ”¶é›†å™¨ä¼šéå†å †ä¸­çš„å¯¹è±¡å›¾ï¼Œå¹¶æ ‡è®°æ‰€æœ‰ä¸æ ¹å¯¹è±¡å¯è¾¾çš„å¯¹è±¡ã€‚ç”±äºåº”ç”¨ç¨‹åºä»åœ¨æ‰§è¡Œï¼Œå †ä¸­çš„å¯¹è±¡å¯èƒ½åœ¨æ­¤æœŸé—´å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤CMSä½¿ç”¨ä¸€äº›ç‰¹æ®Šçš„æ‰‹æ®µæ¥è®°å½•è¿™äº›å˜åŒ–ï¼Œå¹¶åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ä¿æŒä¸€è‡´æ€§ã€‚

  **é‡æ–°æ ‡è®°é˜¶æ®µï¼ˆRemarkï¼‰**ï¼š

  - é‡æ–°æ ‡è®°é˜¶æ®µæ˜¯ä¸€æ¬¡çŸ­æš‚çš„æš‚åœï¼Œå®ƒçš„ç›®çš„æ˜¯**å¤„ç†åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­æœ‰å¯èƒ½å‘ç”Ÿçš„å˜åŒ–**
  - åœ¨å¹¶å‘æ ‡è®°æœŸé—´ï¼Œç”±äºåº”ç”¨ç¨‹åºçš„å¹¶å‘æ‰§è¡Œï¼Œæœ‰äº›å¯¹è±¡çš„å¼•ç”¨å…³ç³»å¯èƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œè¿™äº›å˜åŒ–å¯èƒ½å¯¼è‡´ä¸€äº›å¯¹è±¡åœ¨æ ‡è®°é˜¶æ®µè¢«é”™è¯¯åœ°æ ‡è®°ä¸ºåƒåœ¾(å…¶å®è¿™äº›å¯¹è±¡å·²ç»è¢«åŠ å…¥åˆ°å¼•ç”¨é“¾ä¸­äº†)ã€‚**é‡æ–°æ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†å¤„ç†è¿™äº›å˜åŒ–ï¼Œç¡®ä¿æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½èƒ½è¢«æ­£ç¡®æ ‡è®°ã€‚**

  **å¹¶å‘æ¸…é™¤é˜¶æ®µï¼ˆConcurrent Sweepï¼‰**ï¼š

  - å¹¶å‘æ¸…é™¤é˜¶æ®µä¸åº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¹¶å‘è¿›è¡Œï¼Œå®ƒè´Ÿè´£æ¸…é™¤æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ï¼Œå¹¶å›æ”¶å†…å­˜ç©ºé—´
  - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒCMSæ”¶é›†å™¨ä¼šå›æ”¶åƒåœ¾å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ï¼Œå¹¶å°†å†…å­˜ç©ºé—´é‡æ–°åˆ’åˆ†ä¸ºå¯ç”¨ç©ºé—´ï¼Œä»¥ä¾¿ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜

- åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­è€—æ—¶æœ€é•¿çš„å¹¶å‘æ ‡è®°å’Œå¹¶å‘æ¸…é™¤è¿‡ç¨‹ä¸­ï¼Œæ”¶é›†å™¨çº¿ç¨‹éƒ½å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œä¸éœ€è¦è¿›è¡Œåœé¡¿
- åœ¨CMSï¼ˆConcurrent Mark-Sweepï¼‰æ”¶é›†å™¨çš„å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œ**ä¸ä¼šè¿›è¡Œå…¨é¢çš„GCï¼ˆåƒåœ¾å›æ”¶ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šæ¸…é™¤æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ã€‚å¹¶å‘æ ‡è®°é˜¶æ®µçš„ç›®çš„æ˜¯æ ‡è®°æ‰€æœ‰ä¸æ ¹å¯¹è±¡å¯è¾¾çš„å­˜æ´»å¯¹è±¡(åœ¨ä¸åœæ­¢ç”¨æˆ·ç¨‹åºæ‰§è¡Œçš„å‰æä¸‹)ï¼Œè€Œä¸å¯¹åƒåœ¾å¯¹è±¡è¿›è¡Œæ¸…ç†**
- `Remark`é˜¶æ®µä¼šå¯¹å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†è¿›è¡Œé‡æ–°æ ‡è®°ï¼Œå¹¶å¤„ç†ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚é‡æ–°æ ‡è®°é˜¶æ®µæ˜¯ä¸€ä¸ªçŸ­æš‚çš„æš‚åœé˜¶æ®µ(`Stop The World`)ï¼Œå®ƒä¸åº”ç”¨ç¨‹åºçš„æ‰§è¡Œä¸æ˜¯å¹¶å‘è¿›è¡Œçš„
- åœ¨å¹¶å‘æ ‡è®°å’Œé‡æ–°æ ‡è®°é˜¶æ®µç»“æŸåï¼Œæœ€ç»ˆçš„åƒåœ¾å›æ”¶å·¥ä½œæ˜¯åœ¨å¹¶å‘æ¸…é™¤é˜¶æ®µï¼ˆConcurrent Sweepï¼‰è¿›è¡Œçš„ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒCMSæ”¶é›†å™¨ä¼šæ¸…é™¤æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ï¼Œå¹¶å›æ”¶å†…å­˜ç©ºé—´ï¼Œä»¥ä¾¿ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚å¹¶å‘æ¸…é™¤é˜¶æ®µæ˜¯ä¸åº”ç”¨ç¨‹åºå¹¶å‘è¿›è¡Œçš„ï¼Œå› æ­¤æ•´ä¸ªCMSçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œå¤§éƒ¨åˆ†æ—¶é—´åº”ç”¨ç¨‹åºéƒ½èƒ½ä¿æŒæ‰§è¡ŒçŠ¶æ€ï¼Œä»è€Œé™ä½äº†åœé¡¿æ—¶é—´







5ã€G1æ”¶é›†å™¨(é‡è¦ :grey_exclamation: )

https://pdai.tech/md/java/jvm/java-jvm-gc-g1.html

G1å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- G1åƒåœ¾å›æ”¶å™¨æ˜¯åŸºäº**`compacting`**æ ‡è®°æ•´ç†ç®—æ³•çš„ï¼Œå› æ­¤å…¶å›æ”¶å¾—åˆ°çš„ç©ºé—´æ˜¯è¿ç»­çš„ã€‚è¿™é¿å…äº†CMSå›æ”¶å™¨å› ä¸ºä¸è¿ç»­ç©ºé—´æ‰€é€ æˆçš„é—®é¢˜
- G1å›æ”¶å™¨çš„å†…å­˜ä¸CMSå›æ”¶å™¨è¦æ±‚çš„å†…å­˜æ¨¡å‹æœ‰æå¤§çš„ä¸åŒã€‚G1å°†å†…å­˜åˆ’åˆ†ä¸€ä¸ªä¸ªå›ºå®šå¤§å°çš„`region`ï¼Œæ¯ä¸ª`region`å¯ä»¥æ˜¯å¹´è½»ä»£ã€è€å¹´ä»£çš„ä¸€ä¸ªã€‚**å†…å­˜çš„å›æ”¶æ˜¯ä»¥`region`ä½œä¸ºåŸºæœ¬å•ä½çš„**ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œ**CMSå›æ”¶å™¨æ˜¯ä»¥å †ç©ºé—´ä¸­çš„ä¸åŒä»£ï¼ˆGenerationï¼‰ä¸ºå•ä½è¿›è¡Œå†…å­˜å›æ”¶**
- G1çš„è®¾è®¡åŸåˆ™æ˜¯"**é¦–å…ˆæ”¶é›†å°½å¯èƒ½å¤šçš„åƒåœ¾**(Garbage First)"ã€‚å› æ­¤ï¼ŒG1å¹¶ä¸ä¼šç­‰å†…å­˜è€—å°½(ä¸²è¡Œã€å¹¶è¡Œ)æˆ–è€…å¿«è€—å°½(CMS)çš„æ—¶å€™å¼€å§‹åƒåœ¾æ”¶é›†ï¼Œè€Œæ˜¯åœ¨å†…éƒ¨é‡‡ç”¨äº†å¯å‘å¼ç®—æ³•ï¼Œåœ¨è€å¹´ä»£æ‰¾å‡ºå…·æœ‰é«˜æ”¶é›†æ”¶ç›Šçš„åˆ†åŒºè¿›è¡Œæ”¶é›†

- **å¹¶è¡Œä¸å¹¶å‘**ï¼šG1 èƒ½å……åˆ†åˆ©ç”¨ CPUã€å¤šæ ¸ç¯å¢ƒä¸‹çš„ç¡¬ä»¶ä¼˜åŠ¿ï¼Œä½¿ç”¨å¤šä¸ª CPUï¼ˆCPU æˆ–è€… CPU æ ¸å¿ƒï¼‰æ¥ç¼©çŸ­ Stop-The-World åœé¡¿æ—¶é—´ã€‚éƒ¨åˆ†å…¶ä»–æ”¶é›†å™¨åŸæœ¬éœ€è¦åœé¡¿ Java çº¿ç¨‹æ‰§è¡Œçš„ GC åŠ¨ä½œï¼ŒG1 æ”¶é›†å™¨ä»ç„¶å¯ä»¥é€šè¿‡å¹¶å‘çš„æ–¹å¼è®© java ç¨‹åºç»§ç»­æ‰§è¡Œ
- **ç©ºé—´æ•´åˆ**ï¼š**ä¸ CMS çš„â€œæ ‡è®°-æ¸…é™¤â€ç®—æ³•ä¸åŒï¼ŒG1 ä»æ•´ä½“æ¥çœ‹æ˜¯åŸºäºâ€œæ ‡è®°-æ•´ç†â€ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼›ä»å±€éƒ¨ä¸Šæ¥çœ‹æ˜¯åŸºäºâ€œæ ‡è®°-å¤åˆ¶â€ç®—æ³•å®ç°çš„ã€‚**
- **å¯é¢„æµ‹çš„åœé¡¿**ï¼šè¿™æ˜¯ G1 ç›¸å¯¹äº CMS çš„å¦ä¸€ä¸ªå¤§ä¼˜åŠ¿ï¼Œé™ä½åœé¡¿æ—¶é—´æ˜¯ G1 å’Œ CMS å…±åŒçš„å…³æ³¨ç‚¹ï¼Œä½† G1 é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸º M æ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡ N æ¯«ç§’ã€‚



G1ï¼ˆGarbage-Firstï¼‰æ”¶é›†å™¨æ˜¯Javaè™šæ‹Ÿæœºä¸­ä¸€ç§é¢å‘æœåŠ¡å™¨ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œå®ƒçš„æ‰§è¡Œæµç¨‹ç›¸å¯¹äºä¼ ç»Ÿçš„åƒåœ¾æ”¶é›†å™¨æœ‰æ‰€ä¸åŒ( **ä»¥æé«˜æ¦‚ç‡æ»¡è¶³ GC åœé¡¿æ—¶é—´è¦æ±‚çš„åŒæ—¶,è¿˜å…·å¤‡é«˜ååé‡æ€§èƒ½ç‰¹å¾**)ï¼ŒG1æ”¶é›†å™¨çš„æ‰§è¡Œæµç¨‹å¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š

1. **åˆå§‹æ ‡è®°é˜¶æ®µï¼ˆInitial Markï¼‰**ï¼š
   - åˆå§‹æ ‡è®°é˜¶æ®µä¸CMSæ”¶é›†å™¨çš„åˆå§‹æ ‡è®°é˜¶æ®µç±»ä¼¼ï¼Œæ˜¯ä¸€æ¬¡çŸ­æš‚çš„æš‚åœã€‚**å®ƒæ ‡è®°å‡ºæ‰€æœ‰å¼•ç”¨é“¾ç›´æ¥ä¸æ ¹å¯¹è±¡`GC Root`æœ‰å…³çš„å¯¹è±¡**ã€‚
   - **åœ¨è¿™ä¸ªé˜¶æ®µï¼Œåº”ç”¨ç¨‹åºçš„æ‰§è¡Œä¼šè¢«æš‚åœ**ï¼Œä»¥ç¡®ä¿ä»æ ¹å¯¹è±¡å‡ºå‘çš„å¼•ç”¨é“¾èƒ½å¤Ÿè¢«æ ‡è®°ä¸º"å¯è¾¾"ã€‚
2. **å¹¶å‘æ ‡è®°é˜¶æ®µï¼ˆConcurrent Markï¼‰**ï¼š
   - å¹¶å‘æ ‡è®°é˜¶æ®µæ˜¯G1çš„ä¸»è¦ç‰¹ç‚¹ï¼Œå®ƒä¸åº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¹¶å‘è¿›è¡Œï¼Œä¸éœ€è¦æš‚åœåº”ç”¨ç¨‹åºã€‚
   - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒG1æ”¶é›†å™¨ä¼šéå†å †ä¸­çš„å¯¹è±¡å›¾ï¼Œå¹¶æ ‡è®°æ‰€æœ‰ä¸æ ¹å¯¹è±¡å¯è¾¾çš„å¯¹è±¡ã€‚ç”±äºåº”ç”¨ç¨‹åºä»åœ¨æ‰§è¡Œï¼Œå †ä¸­çš„å¯¹è±¡å¯èƒ½åœ¨æ­¤æœŸé—´å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤G1ä½¿ç”¨ä¸€äº›ç‰¹æ®Šçš„æ‰‹æ®µæ¥è®°å½•è¿™äº›å˜åŒ–ï¼Œå¹¶åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ä¿æŒä¸€è‡´æ€§ã€‚
3. **æœ€ç»ˆæ ‡è®°é˜¶æ®µï¼ˆFinal Remarkï¼‰**ï¼š
   - æœ€ç»ˆæ ‡è®°é˜¶æ®µæ˜¯ä¸€æ¬¡çŸ­æš‚çš„æš‚åœï¼Œå®ƒçš„ç›®çš„æ˜¯å¤„ç†åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­æœ‰å¯èƒ½å‘ç”Ÿçš„å˜åŒ–ã€‚
   - åœ¨å¹¶å‘æ ‡è®°æœŸé—´ï¼Œç”±äºåº”ç”¨ç¨‹åºçš„å¹¶å‘æ‰§è¡Œï¼Œæœ‰äº›å¯¹è±¡çš„å¼•ç”¨å…³ç³»å¯èƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œè¿™äº›å˜åŒ–å¯èƒ½å¯¼è‡´ä¸€äº›å¯¹è±¡åœ¨æ ‡è®°é˜¶æ®µè¢«é”™è¯¯åœ°æ ‡è®°ä¸ºåƒåœ¾ã€‚æœ€ç»ˆæ ‡è®°é˜¶æ®µå°±æ˜¯ä¸ºäº†å¤„ç†è¿™äº›å˜åŒ–ï¼Œç¡®ä¿æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½èƒ½è¢«æ­£ç¡®æ ‡è®°ã€‚
4. **ç­›é€‰å›æ”¶é˜¶æ®µï¼ˆLive Data Counting and Evacuationï¼‰**ï¼š
   - åœ¨æœ€ç»ˆæ ‡è®°é˜¶æ®µå®Œæˆåï¼ŒG1æ”¶é›†å™¨ä¼šå¯¹å †ä¸­çš„å­˜æ´»å¯¹è±¡è¿›è¡Œç»Ÿè®¡ï¼Œä»¥ç¡®å®šéœ€è¦å›æ”¶çš„åƒåœ¾å¯¹è±¡çš„æ•°é‡ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šç¡®å®šå“ªäº›å­˜æ´»å¯¹è±¡å°†è¢«è½¬ç§»åˆ°å…¶ä»–åœ°æ–¹ï¼ˆä¾‹å¦‚SurvivoråŒºæˆ–è€…Old Generationï¼‰ã€‚
   - è¿™ä¸ªé˜¶æ®µçš„ç›®æ ‡æ˜¯æ‰¾åˆ°å­˜æ´»å¯¹è±¡çš„æ•°é‡å’Œä½ç½®ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ­¥è¿›è¡Œåƒåœ¾å›æ”¶ã€‚
5. **å¹¶å‘å›æ”¶é˜¶æ®µï¼ˆConcurrent Cleanupï¼‰**ï¼š æ­¤é˜¶æ®µç”¨äº†æ ‡è®°å¤åˆ¶ç®—æ³•
   - å¹¶å‘å›æ”¶é˜¶æ®µä¸åº”ç”¨ç¨‹åºçš„æ‰§è¡Œå¹¶å‘è¿›è¡Œï¼Œå®ƒè´Ÿè´£æ¸…é™¤æ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ï¼Œå¹¶å›æ”¶å†…å­˜ç©ºé—´ã€‚
   - åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒG1æ”¶é›†å™¨ä¼šå›æ”¶åƒåœ¾å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ï¼Œå¹¶å°†å†…å­˜ç©ºé—´é‡æ–°åˆ’åˆ†ä¸ºå¯ç”¨ç©ºé—´ï¼Œä»¥ä¾¿ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜ã€‚

G1æ”¶é›†å™¨é€šè¿‡å°†å †å†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„åŒºåŸŸï¼ˆ`Region`ï¼‰ï¼Œå¹¶é‡‡ç”¨å¹¶å‘æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰çš„æ–¹å¼æ¥è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œä»è€Œæœ‰æ•ˆåœ°æ§åˆ¶åœé¡¿æ—¶é—´å’Œæé«˜ååé‡ã€‚ç›¸æ¯”ä¼ ç»Ÿçš„åƒåœ¾æ”¶é›†å™¨ï¼ŒG1æ”¶é›†å™¨æ›´åŠ é€‚ç”¨äºå¤§å†…å­˜çš„å¤šæ ¸æœåŠ¡å™¨ç¯å¢ƒï¼Œèƒ½å¤Ÿåœ¨å‡å°‘åœé¡¿æ—¶é—´çš„åŒæ—¶ä¿æŒé«˜çš„ååé‡ã€‚



**G1 æ”¶é›†å™¨åœ¨åå°ç»´æŠ¤äº†ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å›æ”¶ä»·å€¼æœ€å¤§çš„ Region(è¿™ä¹Ÿå°±æ˜¯å®ƒçš„åå­— Garbage-First çš„ç”±æ¥)** ã€‚è¿™ç§ä½¿ç”¨ Region åˆ’åˆ†å†…å­˜ç©ºé—´ä»¥åŠæœ‰ä¼˜å…ˆçº§çš„åŒºåŸŸå›æ”¶æ–¹å¼ï¼Œä¿è¯äº† G1 æ”¶é›†å™¨åœ¨æœ‰é™æ—¶é—´å†…å¯ä»¥å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ï¼ˆæŠŠå†…å­˜åŒ–æ•´ä¸ºé›¶ï¼‰







**G1ä¸­å‡ ä¸ªé‡è¦æ¦‚å¿µ:**



åœ¨ G1çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œå¼•å…¥äº†ä¸€äº›æ–°çš„æ¦‚å¿µï¼Œå¯¹äºå®ç°**é«˜ååã€æ²¡æœ‰å†…å­˜ç¢ç‰‡ã€æ”¶é›†æ—¶é—´å¯æ§**ç­‰åŠŸèƒ½èµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚ä¸‹é¢æˆ‘ä»¬å°±ä¸€èµ·çœ‹ä¸€ä¸‹ G1ä¸­çš„è¿™å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š



1ã€Region

ä¼ ç»Ÿçš„GCæ”¶é›†å™¨å°†è¿ç»­çš„å†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£ã€è€å¹´ä»£å’Œæ°¸ä¹…ä»£ï¼ˆJDK 8å»é™¤äº†æ°¸ä¹…ä»£ï¼Œå¼•å…¥äº†å…ƒç©ºé—´Metaspaceï¼‰ï¼Œè¿™ç§åˆ’åˆ†çš„ç‰¹ç‚¹æ˜¯å„ä»£çš„å­˜å‚¨åœ°å€ï¼ˆé€»è¾‘åœ°å€ï¼Œä¸‹åŒï¼‰æ˜¯è¿ç»­çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![ä¼ ç»ŸGCå†…å­˜å¸ƒå±€](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2016/8a9db36e.png)



è€ŒG1çš„å„ä»£å­˜å‚¨åœ°å€æ˜¯ä¸è¿ç»­çš„ï¼Œ**æ¯ä¸€ä»£éƒ½ä½¿ç”¨äº†nä¸ªä¸è¿ç»­çš„å¤§å°ç›¸åŒçš„Region**ï¼Œæ¯ä¸ªRegionå æœ‰ä¸€å—è¿ç»­çš„è™šæ‹Ÿå†…å­˜åœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2016/8ca16868.png" alt="g1 GCå†…å­˜å¸ƒå±€" style="zoom: 80%;" />

åœ¨ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°**è¿˜æœ‰ä¸€äº›Regionæ ‡æ˜äº†H**ï¼Œå®ƒä»£è¡¨Humongousï¼Œè¿™è¡¨ç¤ºè¿™äº›Regionå­˜å‚¨çš„æ˜¯å·¨å¤§å¯¹è±¡ï¼ˆhumongous objectï¼ŒH-objï¼‰ï¼Œå³å¤§å°å¤§äºç­‰äºregionä¸€åŠçš„å¯¹è±¡

**G1å’Œå…¶ä»–GCç®—æ³•æœ€å¤§çš„åŒºåˆ«æ˜¯å¼±åŒ–åˆ†ä»£æ¦‚å¿µï¼Œå¼•å…¥åˆ†åŒºæ€æƒ³ï¼ï¼ï¼**



2ã€Rset

**G1åƒåœ¾æ”¶é›†å™¨é‡Œæ¯ä¸€ä¸ª`RSet`å¯¹åº”çš„æ˜¯ä¸€ä¸ª`Region`å†…éƒ¨å¯¹è±¡å¼•ç”¨æƒ…å†µ**ï¼Œè¯´ç™½äº†å°±æ˜¯å­˜åœ¨Regionä¸­å­˜æ´»å¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨æ ‡è®°å­˜æ´»å¯¹è±¡çš„æ—¶å€™ï¼ŒG1ä½¿ç”¨RSetæ¦‚å¿µï¼Œå°†æ¯ä¸ªåˆ†åŒºæŒ‡å‘åˆ†åŒºå†…çš„å¼•ç”¨è®°å½•åœ¨è¯¥åˆ†åŒºï¼Œ**é¿å…å¯¹æ•´ä¸ªå †æ‰«æ**ï¼Œå¹¶è¡Œç‹¬ç«‹å¤„ç†åƒåœ¾é›†åˆï¼›

å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°3ä¸ªåˆ†åŒºï¼Œxï¼ˆå¹´è½»ä»£åˆ†åŒºï¼‰ã€y å’Œ zï¼ˆè€å¹´ä»£åˆ†åŒºï¼‰ã€‚xæœ‰ä¸€ä¸ªæ¥è‡ªzçš„å¯¹å†…å¼•ç”¨ã€‚è¿™ä¸ªå¼•ç”¨è®°å½•åœ¨xçš„RSetä¸­ï¼Œåˆ†åŒºzæœ‰2ä¸ªå¯¹å†…å¼•ç”¨ï¼Œä¸€ä¸ªæ¥è‡ªxä¸€ä¸ªæ¥è‡ªyï¼Œ**å› ä¸ºå¹´è½»ä»£åˆ†åŒºä½œä¸ºä¸€ä¸ªæ•´ä½“å›æ”¶çš„ï¼Œæ‰€ä»¥åªéœ€è®°å½•æ¥è‡ªyçš„å¯¹å†…å¼•ç”¨**ï¼Œä¸ç”¨è®°å½•xçš„å¯¹å†…å¼•ç”¨ï¼š

<img src="https://img2018.cnblogs.com/i-beta/1465200/202001/1465200-20200126211309597-1194163731.png" alt="img" style="zoom: 80%;" />

RSet åœ¨ G1 åƒåœ¾å›æ”¶å™¨ä¸­ç”¨äºä»¥ä¸‹ç›®çš„ï¼š

1. **å‡å°‘æ‰«æèŒƒå›´ï¼š** åœ¨æ‰§è¡Œåƒåœ¾å›æ”¶æ—¶ï¼ŒG1 åƒåœ¾å›æ”¶å™¨é¦–å…ˆä¼šé€‰æ‹©ä¸€ç»„åŒ…å«åƒåœ¾å¯¹è±¡çš„åŒºåŸŸè¿›è¡Œå›æ”¶ã€‚è€Œ **RSet çš„ä½œç”¨ä¹‹ä¸€å°±æ˜¯è®°å½•äº†å“ªäº›åŒºåŸŸå†…çš„å¯¹è±¡å¼•ç”¨äº†å½“å‰åŒºåŸŸå†…çš„å¯¹è±¡ã€‚è¿™æ ·ï¼Œåœ¨è¿›è¡Œå›æ”¶æ—¶ï¼Œåªéœ€è¦æ‰«æ RSet ä¸­æ ‡è®°çš„åŒºåŸŸï¼Œè€Œä¸éœ€è¦éå†æ•´ä¸ªå †ï¼Œ**ä»è€Œå¤§å¤§å‡å°‘äº†æ‰«æèŒƒå›´ï¼Œæé«˜äº†å›æ”¶æ•ˆç‡ã€‚
2. **æ ‡è®°é˜¶æ®µè¾…åŠ©ï¼š** åœ¨ G1 çš„å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œåƒåœ¾å›æ”¶å™¨éœ€è¦çŸ¥é“å“ªäº›å¯¹è±¡ä»ç„¶æ˜¯è¢«å¼•ç”¨çš„ã€‚RSet ç”¨äºè®°å½•ä»å…¶ä»–åŒºåŸŸåˆ°å½“å‰åŒºåŸŸçš„å¼•ç”¨å…³ç³»ï¼Œä»¥å¸®åŠ©æ ‡è®°å“ªäº›å¯¹è±¡ä»ç„¶å¯è¾¾ã€‚
3. **å¹¶å‘æ¸…ç†ï¼š** **åœ¨ G1 çš„å¹¶å‘æ¸…ç†é˜¶æ®µï¼ŒRSet ä¹Ÿèµ·åˆ°äº†é‡è¦ä½œç”¨ã€‚G1 åƒåœ¾å›æ”¶å™¨ä¼šé€šè¿‡ RSet ç¡®å®šå“ªäº›å¼•ç”¨å…³ç³»ä»ç„¶æœ‰æ•ˆï¼Œ**ä»è€Œç¡®ä¿åœ¨æ¸…ç†é˜¶æ®µä¸ä¼šé”™è¯¯åœ°æ¸…ç†æ‰ä»ç„¶å¯è¾¾çš„å¯¹è±¡ã€‚









### åƒåœ¾å›æ”¶åœé¡¿

> å¾ˆå¤šä½å»¶è¿Ÿé«˜å¯ç”¨JavaæœåŠ¡çš„ç³»ç»Ÿå¯ç”¨æ€§ç»å¸¸å—GCåœé¡¿çš„å›°æ‰°ã€‚GCåœé¡¿æŒ‡åƒåœ¾å›æ”¶æœŸé—´STWï¼ˆStop The Worldï¼‰ï¼Œå½“STWæ—¶ï¼Œæ‰€æœ‰åº”ç”¨çº¿ç¨‹åœæ­¢æ´»åŠ¨ï¼Œç­‰å¾…GCåœé¡¿ç»“æŸæ‰å¯ç»§ç»­æ‰§è¡Œï¼Œå¯¹äºç”¨æˆ·çš„æ„ŸçŸ¥ååˆ†æ˜æ˜¾

ä¸‹é¢ä»¥G1ä¸ºä¾‹ï¼Œé€šè¿‡G1ä¸­æ ‡è®°-å¤åˆ¶ç®—æ³•è¿‡ç¨‹ï¼ˆG1çš„Young GCå’ŒMixed GCå‡é‡‡ç”¨è¯¥ç®—æ³•ï¼‰ï¼Œåˆ†æG1åœé¡¿è€—æ—¶çš„ä¸»è¦ç“¶é¢ˆã€‚

æ ‡è®°é˜¶æ®µåœé¡¿åˆ†æ

- **åˆå§‹æ ‡è®°é˜¶æ®µ**ï¼šåˆå§‹æ ‡è®°é˜¶æ®µæ˜¯æŒ‡ä»GC Rootså‡ºå‘æ ‡è®°å…¨éƒ¨ç›´æ¥å­èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œè¯¥é˜¶æ®µæ˜¯STWçš„ã€‚ç”±äºGC Rootsæ•°é‡ä¸å¤šï¼Œé€šå¸¸è¯¥é˜¶æ®µè€—æ—¶éå¸¸çŸ­ã€‚
- **å¹¶å‘æ ‡è®°é˜¶æ®µ**ï¼šå¹¶å‘æ ‡è®°é˜¶æ®µæ˜¯æŒ‡ä»GC Rootså¼€å§‹å¯¹å †ä¸­å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œæ‰¾å‡ºå­˜æ´»å¯¹è±¡ã€‚è¯¥é˜¶æ®µæ˜¯å¹¶å‘çš„ï¼Œå³åº”ç”¨çº¿ç¨‹å’ŒGCçº¿ç¨‹å¯ä»¥åŒæ—¶æ´»åŠ¨ã€‚å¹¶å‘æ ‡è®°è€—æ—¶ç›¸å¯¹é•¿å¾ˆå¤šï¼Œä½†å› ä¸ºä¸æ˜¯STWï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¤ªå…³å¿ƒè¯¥é˜¶æ®µè€—æ—¶çš„é•¿çŸ­ã€‚
- **å†æ ‡è®°é˜¶æ®µ**ï¼šé‡æ–°æ ‡è®°é‚£äº›åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µå‘ç”Ÿå˜åŒ–çš„å¯¹è±¡ã€‚è¯¥é˜¶æ®µæ˜¯STWçš„ã€‚

æ¸…ç†é˜¶æ®µåœé¡¿åˆ†æ

- **æ¸…ç†é˜¶æ®µ**æ¸…ç‚¹å‡ºæœ‰å­˜æ´»å¯¹è±¡çš„åˆ†åŒºå’Œæ²¡æœ‰å­˜æ´»å¯¹è±¡çš„åˆ†åŒºï¼Œè¯¥é˜¶æ®µä¸ä¼šæ¸…ç†åƒåœ¾å¯¹è±¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œå­˜æ´»å¯¹è±¡çš„å¤åˆ¶ã€‚è¯¥é˜¶æ®µæ˜¯STWçš„ã€‚

å¤åˆ¶é˜¶æ®µåœé¡¿åˆ†æ

- **å¤åˆ¶ç®—æ³•**ä¸­çš„è½¬ç§»é˜¶æ®µéœ€è¦åˆ†é…æ–°å†…å­˜å’Œå¤åˆ¶å¯¹è±¡çš„æˆå‘˜å˜é‡ã€‚è½¬ç§»é˜¶æ®µæ˜¯STWçš„ï¼Œå…¶ä¸­å†…å­˜åˆ†é…é€šå¸¸è€—æ—¶éå¸¸çŸ­ï¼Œä½†å¯¹è±¡æˆå‘˜å˜é‡çš„å¤åˆ¶è€—æ—¶æœ‰å¯èƒ½è¾ƒé•¿ï¼Œè¿™æ˜¯å› ä¸ºå¤åˆ¶è€—æ—¶ä¸å­˜æ´»å¯¹è±¡æ•°é‡ä¸å¯¹è±¡å¤æ‚åº¦æˆæ­£æ¯”ã€‚å¯¹è±¡è¶Šå¤æ‚ï¼Œå¤åˆ¶è€—æ—¶è¶Šé•¿ã€‚

å››ä¸ªSTWè¿‡ç¨‹ä¸­ï¼Œåˆå§‹æ ‡è®°å› ä¸ºåªæ ‡è®°`GC Roots`ï¼Œè€—æ—¶è¾ƒçŸ­ã€‚å†æ ‡è®°å› ä¸ºå¯¹è±¡æ•°å°‘ï¼Œè€—æ—¶ä¹Ÿè¾ƒçŸ­ã€‚æ¸…ç†é˜¶æ®µå› ä¸ºå†…å­˜åˆ†åŒºæ•°é‡å°‘ï¼Œè€—æ—¶ä¹Ÿè¾ƒçŸ­ã€‚è½¬ç§»é˜¶æ®µè¦å¤„ç†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼Œè€—æ—¶ä¼šè¾ƒé•¿ã€‚å› æ­¤ï¼Œ**G1åœé¡¿æ—¶é—´çš„ç“¶é¢ˆä¸»è¦æ˜¯æ ‡è®°-å¤åˆ¶ä¸­çš„è½¬ç§»é˜¶æ®µSTW**ã€‚ä¸ºä»€ä¹ˆè½¬ç§»é˜¶æ®µä¸èƒ½å’Œæ ‡è®°é˜¶æ®µä¸€æ ·å¹¶å‘æ‰§è¡Œå‘¢ï¼Ÿä¸»è¦æ˜¯G1æœªèƒ½è§£å†³è½¬ç§»è¿‡ç¨‹ä¸­å‡†ç¡®å®šä½å¯¹è±¡åœ°å€çš„é—®é¢˜ã€‚

G1çš„Young GCå’ŒCMSçš„Young GCï¼Œå…¶æ ‡è®°-å¤åˆ¶å…¨è¿‡ç¨‹STWï¼Œè¿™é‡Œä¸å†è¯¦ç»†é˜è¿°

æ€»ç»“å°±æ˜¯ï¼šåƒåœ¾å›æ”¶åœé¡¿ç°è±¡ä¸»è¦å‘ç”Ÿåœ¨æ ‡è®°å¤åˆ¶ç®—æ³•ä¸­çš„å¯¹è±¡è½¬ç§»é˜¶æ®µï¼ï¼

https://pdai.tech/md/java/jvm/java-jvm-gc-zgc.html#zgc%E5%8E%9F%E7%90%86





### ä»€ä¹ˆæ—¶å€™è§¦å‘GC?



1. **Minor GCï¼ˆæ–°ç”Ÿä»£åƒåœ¾å›æ”¶ï¼‰ï¼š**
   - Minor GC ä¸»è¦å‘ç”Ÿåœ¨æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰ä¸­ã€‚
   - å½“æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡æ•°é‡è¾¾åˆ°ä¸€å®šé˜ˆå€¼æ—¶ï¼Œä¼šè§¦å‘ Minor GCã€‚
   - Minor GC çš„ç›®æ ‡æ˜¯å›æ”¶æ–°ç”Ÿä»£ä¸­çš„åƒåœ¾å¯¹è±¡ï¼Œå¹¶å°†å­˜æ´»çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ã€‚
2. **Major GCï¼ˆè€å¹´ä»£åƒåœ¾å›æ”¶ï¼‰ï¼š**
   - Major GC é€šå¸¸æŒ‡çš„æ˜¯å¯¹è€å¹´ä»£ï¼ˆOld Generationï¼‰çš„åƒåœ¾å›æ”¶ï¼Œä½†ä¸ä¸€å®šä¼šæ¸…ç†æ•´ä¸ªè€å¹´ä»£ï¼Œå¯èƒ½åªæ˜¯å¯¹éƒ¨åˆ†è€å¹´ä»£è¿›è¡Œå›æ”¶ã€‚
   - Major GC å¯èƒ½åœ¨ä»¥ä¸‹æƒ…å†µä¸‹è§¦å‘ï¼š
     - è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œæ— æ³•åˆ†é…å¤§å¯¹è±¡æˆ–æ™‹å‡å¯¹è±¡æ—¶ã€‚
     - æ™‹å‡å¤±è´¥ï¼ˆä¾‹å¦‚è€å¹´ä»£æ— æ³•å®¹çº³æ™‹å‡çš„å¯¹è±¡ï¼‰ã€‚
     - æ˜¾å¼è°ƒç”¨ `System.gc()` æ–¹æ³•æ—¶ã€‚
3. **Full GCï¼ˆå…¨å±€åƒåœ¾å›æ”¶ï¼‰ï¼š**
   - Full GC ä¼šå¯¹æ•´ä¸ªå †å†…å­˜è¿›è¡Œåƒåœ¾å›æ”¶ï¼ŒåŒ…æ‹¬æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚
   - Full GC å¯èƒ½åœ¨ä»¥ä¸‹æƒ…å†µä¸‹è§¦å‘ï¼š
     - è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œä¸”æ— æ³•è¿›è¡Œ Major GC ä»¥æ»¡è¶³ç©ºé—´éœ€æ±‚ã€‚
     - æ˜¾å¼è°ƒç”¨ `System.gc()` æ–¹æ³•ã€‚
     - ç”±åƒåœ¾æ”¶é›†å™¨è‡ªè¡Œå†³å®šçš„å…¶ä»–æƒ…å†µã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸åŒçš„åƒåœ¾æ”¶é›†å™¨å’Œä¸åŒçš„è™šæ‹Ÿæœºå®ç°å¯èƒ½ä¼šæœ‰ä¸åŒçš„è§¦å‘æ¡ä»¶å’Œè¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨å¯èƒ½ä¼šå¯¼è‡´ä¸åŒç±»å‹çš„åƒåœ¾å›æ”¶åœ¨ä¸åŒçš„æ—¶æœºè§¦å‘ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šæ ¹æ®å †å†…å­˜çš„çŠ¶æ€å’Œå„ä¸ªåŒºåŸŸçš„ä½¿ç”¨æƒ…å†µæ¥è‡ªåŠ¨è§¦å‘ä¸åŒç±»å‹çš„åƒåœ¾å›æ”¶ï¼Œä»¥ä¿è¯å†…å­˜çš„æœ‰æ•ˆåˆ©ç”¨å’Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚





## JVMå®æˆ˜





###  JVMå‚æ•°



> å †å†…å­˜/æ ˆç©ºé—´ç›¸å…³å‚æ•°ï¼š

1ã€æ˜¾å¼æŒ‡å®šå †å†…å­˜`â€“Xms`å’Œ`-Xmx`:

æ ¹æ®åº”ç”¨ç¨‹åºè¦æ±‚åˆå§‹åŒ–å †å†…å­˜ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æŒ‡å®šæœ€å°å’Œæœ€å¤§å †å¤§å°ï¼ˆæ¨èæ˜¾ç¤ºæŒ‡å®šå¤§å°ï¼‰ï¼Œä»¥ä¸‹å‚æ•°å¯ä»¥å¸®åŠ©ä½ å®ç°ï¼š

```shell
-Xms<heap size>[unit]
-Xmx<heap size>[unit]
```

- **heap size** è¡¨ç¤ºè¦åˆå§‹åŒ–å†…å­˜çš„å…·ä½“å¤§å°
- **unit** è¡¨ç¤ºè¦åˆå§‹åŒ–å†…å­˜çš„å•ä½

ä¸¾ä¸ªæ —å­ ğŸŒ°ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸º JVM åˆ†é…æœ€å° 2 GB å’Œæœ€å¤§ 5 GB çš„å †å†…å­˜å¤§å°ï¼Œæˆ‘ä»¬çš„å‚æ•°åº”è¯¥è¿™æ ·æ¥å†™ï¼š

```shell
-Xms2G -Xmx5G
```



2ã€è®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„Javaè™šæ‹Ÿæœºæ ˆï¼ˆJVM Stackï¼‰çš„å¤§å°ï¼š

```shell
-Xss 256k  #è¡¨ç¤ºå°†æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¤§å°è®¾ç½®ä¸º256Kå­—èŠ‚ 
```

å¢åŠ çº¿ç¨‹æ ˆçš„å¤§å°å¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¤„ç†æ›´æ·±çš„æ–¹æ³•è°ƒç”¨å±‚çº§å’Œæ›´å¤§çš„å±€éƒ¨å˜é‡ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå ç”¨æ›´å¤šçš„å†…å­˜ã€‚





3ã€æ˜¾å¼æŒ‡å®šæ–°ç”Ÿä»£/è€å¹´ä»£å†…å­˜å¤§å°ï¼š

(1) ä¸¾ä¸ªæ —å­ ğŸŒ°ï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸º **æ–°ç”Ÿä»£åˆ†é…** æœ€å° 256m çš„å†…å­˜ï¼Œæœ€å¤§ 1024m çš„å†…å­˜æˆ‘ä»¬çš„å‚æ•°åº”è¯¥è¿™æ ·æ¥å†™ï¼š

```shell
-XX:NewSize=256m
-XX:MaxNewSize=1024m
```

(2)ä½†æ˜¯å¦‚æœæˆ‘ä»¬è¦ä¸º æ–°ç”Ÿä»£åˆ†é… 256m çš„å†…å­˜ï¼ˆNewSize ä¸ MaxNewSize è®¾ä¸ºä¸€è‡´ï¼‰ï¼Œæˆ‘ä»¬çš„å‚æ•°åº”è¯¥è¿™æ ·æ¥å†™ï¼š

```shell
-Xmn256m
```



è®¾ç½®è€å¹´ä»£(å…ƒç©ºé—´)ï¼š

```shell
#è®¾ç½® Metaspace çš„åˆå§‹å¤§å°ï¼ˆæ˜¯ä¸€ä¸ªå¸¸è§çš„è¯¯åŒºï¼Œåé¢ä¼šè§£é‡Šï¼‰ å®é™… è¡¨ç¤º Metaspace ä½¿ç”¨è¿‡ç¨‹ä¸­è§¦å‘ Full GC çš„é˜ˆå€¼
-XX:MetaspaceSize=N 

-XX:MaxMetaspaceSize=N #è®¾ç½® Metaspace çš„æœ€å¤§å¤§å°
```





4ã€é€šè¿‡ **`-XX:NewRatio=<int>`** æ¥è®¾ç½®è€å¹´ä»£ä¸æ–°ç”Ÿä»£å†…å­˜çš„æ¯”å€¼ï¼š

```shell
-XX:NewRatio=1
```

ä¸Šè¿°å‚æ•°å°±æ˜¯è®¾ç½®è€å¹´ä»£ä¸æ–°ç”Ÿä»£å†…å­˜çš„æ¯”å€¼ä¸º 1ã€‚ä¹Ÿå°±æ˜¯è¯´è€å¹´ä»£å’Œæ–°ç”Ÿä»£æ‰€å æ¯”å€¼ä¸º 1ï¼š1ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †æ ˆçš„ 1/2







> GCç›¸å…³å‚æ•°ï¼š

1ã€JVM å…·æœ‰å››ç§ç±»å‹çš„ GC å®ç°ï¼š

- ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨
- å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨
- CMS åƒåœ¾æ”¶é›†å™¨
- G1 åƒåœ¾æ”¶é›†å™¨

```shell
-XX:+UseSerialGC
-XX:+UseParallelGC
-XX:+UseParNewGC
-XX:+UseG1GC
```



2ã€æ˜¾å¼çš„ç¦ç”¨System.gc()ï¼šè°ƒç”¨è¯¥å‡½æ•°æ˜¯å¾ˆæµªè´¹æ€§èƒ½çš„ï¼ŒJVMä¼šåœ¨éœ€è¦GCçš„æ—¶å€™è‡ªå·±è§¦å‘GC

```shell
-XX:+DisableExplicitGC
```



3ã€æŒ‡å®šå¹¶è¡Œåƒåœ¾æ”¶é›†å™¨çš„çº¿ç¨‹æ•°é‡ï¼š

```shell
-XX:ParallelGCThreads=4
```



4ã€æ‰“å°å¿…è¦çš„GCæ—¥å¿—è®°å½•ï¼š

```shell
-XX:+PrintGCDetails# å¿…é€‰ ï¼Œæ‰“å°åŸºæœ¬ GC ä¿¡æ¯
-XX:+PrintGCDateStamps
-XX:+PrintReferenceGC    # æ‰“å°Referenceå¤„ç†ä¿¡æ¯
-XX:+PrintGCApplicationStoppedTime # æ‰“å°STWæ—¶é—´
```

















### ç›‘æ§å·¥å…·

1ã€jps(JVM Process Status)  ç±»ä¼¼ UNIX çš„ `ps` å‘½ä»¤:

ä¾‹å¦‚å¯åŠ¨å¾®æœåŠ¡é¡¹ç›®åï¼Œjpsæ˜¾ç¤ºå¦‚ä¸‹ï¼š

```shell
C:\Users\aa>jps -l
23152 org.jetbrains.idea.maven.server.RemoteMavenServer36
18004 com.xuecheng.system.SystemApplication
20548 com.xuecheng.OrdersApiApplication
28708 com.xuecheng.GatewayApplication
28788
12952 org.jetbrains.jps.cmdline.Launcher
29368 com.xuecheng.LearningApiApplication
6568 sun.tools.jps.Jps
26204 com.xuecheng.ContentApiApplication
```

jpså‚æ•°

```bash
-qï¼šä»…è¾“å‡ºVMæ ‡è¯†ç¬¦ï¼Œä¸åŒ…æ‹¬classname,jar name,arguments in main method 
-mï¼šè¾“å‡ºmain methodçš„å‚æ•° 
-lï¼šè¾“å‡ºå®Œå…¨çš„åŒ…åï¼Œåº”ç”¨ä¸»ç±»åï¼Œjarçš„å®Œå…¨è·¯å¾„å 
-vï¼šè¾“å‡ºjvmå‚æ•° 
-Vï¼šè¾“å‡ºé€šè¿‡flagæ–‡ä»¶ä¼ é€’åˆ°JVMä¸­çš„å‚æ•°(.hotspotrcæ–‡ä»¶æˆ–-XX:Flags=æ‰€æŒ‡å®šçš„æ–‡ä»¶ 
-Joptionï¼šä¼ é€’å‚æ•°åˆ°vm,ä¾‹å¦‚:-J-Xms512m
```







2ã€`jstat`ï¼šç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯

```shell
jstat [option] vmid [interval[s|ms] [count]]
```

- option:æŒ‡å®šéœ€è¦ç»Ÿè®¡çš„ä¿¡æ¯,å¸¸ç”¨çš„æœ‰ -classã€-gcutilã€-gccause ç­‰
- vmid:éœ€è¦ç›‘æ§çš„ JVM è¿›ç¨‹ ID,å¯ä»¥é€šè¿‡ jps å‘½ä»¤æŸ¥çœ‹
- interval:æŸ¥çœ‹çŠ¶æ€ä¿¡æ¯çš„æ—¶é—´é—´éš”,å•ä½å¯ä»¥æ˜¯ s(ç§’) æˆ–è€… ms(æ¯«ç§’)
- count:ç»Ÿè®¡æ¬¡æ•°,é»˜è®¤ beloved

å®ƒå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è€…è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»ä¿¡æ¯ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JIT ç¼–è¯‘ç­‰è¿è¡Œæ•°æ®

æ¯”å¦‚ `jstat -gc -h3 20548 1000 10`è¡¨ç¤ºåˆ†æè¿›ç¨‹ id ä¸º 20548 çš„ gc æƒ…å†µï¼Œæ¯éš” 1000ms æ‰“å°ä¸€æ¬¡è®°å½•ï¼Œæ‰“å° 10 æ¬¡åœæ­¢ï¼Œæ¯ 3 è¡Œåæ‰“å°æŒ‡æ ‡å¤´éƒ¨

```java
C:\Users\aa>jstat -gc -h3 20548 1000 10
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
20480.0 24064.0  0.0    0.0   678912.0 323175.9  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
20480.0 24064.0  0.0    0.0   678912.0 326193.3  317440.0   36543.7   60080.0 56551.0 8320.0 7698.7      8    0.043   3      0.219    0.262
```





3ã€jstackï¼šçº¿ç¨‹æ ˆä¿¡æ¯æŸ¥çœ‹

`jstack`ï¼ˆStack Trace for Javaï¼‰å‘½ä»¤ç”¨äºç”Ÿæˆå½“å‰è™šæ‹Ÿæœºè¿›ç¨‹åœ¨å½“å‰æ—¶åˆ»çš„**çº¿ç¨‹å¿«ç…§**ã€‚çº¿ç¨‹å¿«ç…§å°±æ˜¯**å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆ**

ä½¿ç”¨jstackæ¥åˆ†ææ­»é”ï¼š

```java
public class DeadLockDemo {
    private static Object resource1 = new Object();//èµ„æº 1
    private static Object resource2 = new Object();//èµ„æº 2

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread() + "get resource2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource1");
                synchronized (resource1) {
                    System.out.println(Thread.currentThread() + "get resource1");
                }
            }
        }, "çº¿ç¨‹ 2").start();
    }
}

```

Output:

```text
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]get resource2
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]waiting get resource1
```

çº¿ç¨‹ A é€šè¿‡ `synchronized (resource1)` è·å¾— resource1 çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡` Thread.sleep(1000);`è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°æ‰§è¡Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”



é€šè¿‡`Jstack`å‘½ä»¤æ¥æ’æŸ¥é—®é¢˜ï¼š

```
C:\Users\aa>jps
23152 RemoteMavenServer36
18004 SystemApplication
18612 DeadLockDemo            #æ­»é”å‘ç”Ÿçš„JVMè¿›ç¨‹
20548 OrdersApiApplication
28708 GatewayApplication
28788
14920 Jps
29368 LearningApiApplication
10204 Launcher
26204 ContentApiApplication

C:\Users\aa>jstack DeadLockDemo
Found one Java-level deadlock:
=============================
"çº¿ç¨‹ 2":
  waiting to lock monitor 0x000000000333e668 (object 0x00000000d5efe1c0, a java.lang.Object),
  which is held by "çº¿ç¨‹ 1"
"çº¿ç¨‹ 1":
  waiting to lock monitor 0x000000000333be88 (object 0x00000000d5efe1d0, a java.lang.Object),
  which is held by "çº¿ç¨‹ 2"

Java stack information for the threads listed above:
===================================================
"çº¿ç¨‹ 2":
        at DeadLockDemo.lambda$main$1(DeadLockDemo.java:31)
        - waiting to lock <0x00000000d5efe1c0> (a java.lang.Object)
        - locked <0x00000000d5efe1d0> (a java.lang.Object)
        at DeadLockDemo$$Lambda$2/1078694789.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
"çº¿ç¨‹ 1":
        at DeadLockDemo.lambda$main$0(DeadLockDemo.java:16)
        - waiting to lock <0x00000000d5efe1d0> (a java.lang.Object)
        - locked <0x00000000d5efe1c0> (a java.lang.Object)
        at DeadLockDemo$$Lambda$1/1324119927.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.

```

å¯ä»¥çœ‹åˆ° `jstack` å‘½ä»¤å·²ç»å¸®æˆ‘ä»¬æ‰¾åˆ°å‘ç”Ÿæ­»é”çš„çº¿ç¨‹çš„å…·ä½“ä¿¡æ¯







4ã€**`jmap`**:ç”¨äºç”ŸæˆJavaè¿›ç¨‹çš„å†…å­˜å¿«ç…§ï¼Œå¹¶æŸ¥çœ‹Javaå †å†…å­˜ä¸­çš„å¯¹è±¡ä¿¡æ¯

å‡è®¾ä½ æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„Javaåº”ç”¨ç¨‹åºï¼Œå®ƒçš„è¿›ç¨‹IDæ˜¯`12345`ï¼Œä½ æƒ³è¦ç”Ÿæˆè¯¥Javaè¿›ç¨‹çš„å †å†…å­˜å¿«ç…§å¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åç»­åˆ†æå†…å­˜ä½¿ç”¨æƒ…å†µã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œ:

```shell
jmap -dump:format=b,file=heapdump.bin 12345
```

æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œ`jmap`ä¼šç”Ÿæˆä¸€ä¸ªåä¸º`heapdump.bin`çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†Javaè¿›ç¨‹çš„å †å†…å­˜å¿«ç…§ã€‚

æ¥ä¸‹æ¥ï¼Œä½ å¯èƒ½å¸Œæœ›æŸ¥çœ‹è¯¥Javaè¿›ç¨‹çš„å †å†…å­˜ä¿¡æ¯ï¼Œäº†è§£å †å¤§å°ã€ä½¿ç”¨æƒ…å†µã€GCæƒ…å†µç­‰ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œï¼š

```java
jmap -heap 12345
```



ä¾‹å¦‚é€šè¿‡`jmap`å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹`SystemApplication`çš„å †å†…å­˜ä¿¡æ¯ï¼š

```shell
C:\Users\aa>jps
23152 RemoteMavenServer36
24864 Jps
18004 SystemApplication   #è¢«æŸ¥çœ‹çš„è¿›ç¨‹
18612 DeadLockDemo
20548 OrdersApiApplication
28708 GatewayApplication
28788
19800 Launcher
29368 LearningApiApplication
26204 ContentApiApplication


C:\Users\aa>jmap  -heap 18004
Attaching to process ID 18004, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.192-b12

using thread-local object allocation.
Parallel GC with 10 thread(s)

Heap Configuration:
   MinHeapFreeRatio         = 0
   MaxHeapFreeRatio         = 100
   MaxHeapSize              = 8541700096 (8146.0MB)
   NewSize                  = 178257920 (170.0MB)
   MaxNewSize               = 2846883840 (2715.0MB)
   OldSize                  = 356515840 (340.0MB)
   NewRatio                 = 2
   SurvivorRatio            = 8
   MetaspaceSize            = 21807104 (20.796875MB)
   CompressedClassSpaceSize = 1073741824 (1024.0MB)
   MaxMetaspaceSize         = 17592186044415 MB
   G1HeapRegionSize         = 0 (0.0MB)

Heap Usage:
PS Young Generation
Eden Space:
   capacity = 261095424 (249.0MB)
   used     = 124858824 (119.07465362548828MB)
   free     = 136236600 (129.92534637451172MB)
   47.82114603433264% used
From Space:
   capacity = 14155776 (13.5MB)
   used     = 14135376 (13.480545043945312MB)
   free     = 20400 (0.0194549560546875MB)
   99.85588921440973% used
To Space:
   capacity = 15728640 (15.0MB)
   used     = 0 (0.0MB)
   free     = 15728640 (15.0MB)
   0.0% used
PS Old Generation
   capacity = 351797248 (335.5MB)
   used     = 18767584 (17.898162841796875MB)
   free     = 333029664 (317.6018371582031MB)
   5.33477282914959% used

19969 interned Strings occupying 1829848 bytes.
```













### è°ƒä¼˜æ¡ˆä¾‹



1ã€**ä¸Šè¿°æåˆ°çš„ä½¿ç”¨`jstack`å‘½ä»¤æ¥åˆ†ææ­»é”(é’ˆå¯¹å †å¤–å†…å­˜)ï¼š** 

```java
public class DeadLockDemo {
    private static Object resource1 = new Object();//èµ„æº 1
    private static Object resource2 = new Object();//èµ„æº 2

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread() + "get resource2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource1");
                synchronized (resource1) {
                    System.out.println(Thread.currentThread() + "get resource1");
                }
            }
        }, "çº¿ç¨‹ 2").start();
    }
}

```

Output:

```text
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]get resource2
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]waiting get resource1
```

çº¿ç¨‹ A é€šè¿‡ `synchronized (resource1)` è·å¾— resource1 çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡` Thread.sleep(1000);`è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°æ‰§è¡Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”



é€šè¿‡`Jstack`å‘½ä»¤æ¥æ’æŸ¥é—®é¢˜ï¼š

```
C:\Users\aa>jps
23152 RemoteMavenServer36
18004 SystemApplication
18612 DeadLockDemo            #æ­»é”å‘ç”Ÿçš„JVMè¿›ç¨‹
20548 OrdersApiApplication
28708 GatewayApplication
28788
14920 Jps
29368 LearningApiApplication
10204 Launcher
26204 ContentApiApplication

C:\Users\aa>jstack DeadLockDemo
Found one Java-level deadlock:
=============================
"çº¿ç¨‹ 2":
  waiting to lock monitor 0x000000000333e668 (object 0x00000000d5efe1c0, a java.lang.Object),
  which is held by "çº¿ç¨‹ 1"
"çº¿ç¨‹ 1":
  waiting to lock monitor 0x000000000333be88 (object 0x00000000d5efe1d0, a java.lang.Object),
  which is held by "çº¿ç¨‹ 2"

Java stack information for the threads listed above:
===================================================
"çº¿ç¨‹ 2":
        at DeadLockDemo.lambda$main$1(DeadLockDemo.java:31)
        - waiting to lock <0x00000000d5efe1c0> (a java.lang.Object)
        - locked <0x00000000d5efe1d0> (a java.lang.Object)
        at DeadLockDemo$$Lambda$2/1078694789.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
"çº¿ç¨‹ 1":
        at DeadLockDemo.lambda$main$0(DeadLockDemo.java:16)
        - waiting to lock <0x00000000d5efe1d0> (a java.lang.Object)
        - locked <0x00000000d5efe1c0> (a java.lang.Object)
        at DeadLockDemo$$Lambda$1/1324119927.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.

```

å¯ä»¥çœ‹åˆ° `jstack` å‘½ä»¤å·²ç»å¸®æˆ‘ä»¬æ‰¾åˆ°å‘ç”Ÿæ­»é”çš„çº¿ç¨‹çš„å…·ä½“ä¿¡æ¯







2ã€æ’æŸ¥`OutOfMemoryError`(**é’ˆå¯¹å †å†…å†…å­˜**):

å‡è®¾-Xmxæœ€å¤§å†…å­˜é…ç½®ä¸º2GB

```java
public void testOom1() {
	List<Map<String, Object>> mapList = new ArrayList<>();
	for (int i = 0; i < 1000000; i++) {
		Map<String, Object> map = new HashMap<>();
		for (int j = 0; j < i; j++) {
				map.put(String.valueOf(j), j);
		}
		mapList.add(map);
	}
}
```

ä¸Šè¿°çš„ä»£ç æ‰§è¡Œä¼šå¯¼è‡´ï¼šoldåŒº(**å­—ç¬¦ä¸²å¤§å¯¹è±¡åˆ›å»ºåç›´æ¥è¿›å…¥è€å¹´ä»£**)å ç”¨è¿‡å¤šå¯¼è‡´é¢‘ç¹`Full GC`ï¼Œæœ€ç»ˆå¯¼è‡´GC overhead limit exceedï¼š

```shell
java.lang.OutOfMemoryError: GC overhead limit exceeded
at java.util.HashMap.newNode(HashMap.java:1747) ~[na:1.8.0_181]
at java.util.HashMap.putVal(HashMap.java:642) ~[na:1.8.0_181]
at java.util.HashMap.put(HashMap.java:612) ~[na:1.8.0_181]
at tech.pdai.test.oom.controller.TestOomController.testOom1(TestOomController.java:33) ~[classes/:na]
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_181]
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_181]
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_181]
at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_181]
at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:197) ~[spring-web-5.3.9.jar:5.3.9]
at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:141) ~[spring-web-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:106) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:895) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:808) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1064) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:963) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006) ~[spring-webmvc-5.3.9.jar:5.3.9]
at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:898) ~[spring-webmvc-5.3.9.jar:5.3.9]
at javax.servlet.http.HttpServlet.service(HttpServlet.java:655) ~[tomcat-embed-core-9.0.50.jar:4.0.FR]
at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883) ~[spring-webmvc-5.3.9.jar:5.3.9]
at javax.servlet.http.HttpServlet.service(HttpServlet.java:764) ~[tomcat-embed-core-9.0.50.jar:4.0.FR]
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:228) ~[tomcat-embed-core-9.0.50.jar:9.0.50]
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:163) ~[tomcat-embed-core-9.0.50.jar:9.0.50]
at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53) ~[tomcat-embed-websocket-9.0.50.jar:9.0.50]
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:190) ~[tomcat-embed-core-9.0.50.jar:9.0.50]
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:163) ~[tomcat-embed-core-9.0.50.jar:9.0.50]
at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100) ~[spring-web-5.3.9.jar:5.3.9]
at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119) ~[spring-web-5.3.9.jar:5.3.9]
at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:190) ~[tomcat-embed-core-9.0.50.jar:9.0.50]
at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:163) ~[tomcat-embed-core-9.0.50.jar:9.0.50]
at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93) ~[spring-web-5.3.9.jar:5.3.9]
at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119) ~[spring-web-5.3.9.jar:5.3.9]
```

â€‹	





### çº¿ä¸Šæ•…éšœæ’æŸ¥

















# Spring



## åŸºæœ¬ç»„ä»¶

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/spring-framework-introduce-8.png" style="zoom:67%;" />





1ã€Core Containerï¼š

Spring æ¡†æ¶çš„æ ¸å¿ƒï¼Œä¸»è¦æä¾›æ§åˆ¶åè½¬ã€ä¾èµ–æ³¨å…¥åŠŸèƒ½ã€‚Spring å…¶ä»–æ‰€æœ‰åŠŸèƒ½åŸºæœ¬éƒ½éœ€è¦ä¾èµ–äºè¯¥æ¨¡å—

- **spring-core**ï¼šSpring æ¡†æ¶åŸºæœ¬çš„æ ¸å¿ƒå·¥å…·ç±»
- **spring-beans**ï¼šæä¾›å¯¹ bean çš„åˆ›å»ºã€é…ç½®å’Œç®¡ç†ç­‰æ”¯æŒï¼Œä¾‹å¦‚ç®¡ç†Beançš„ä½œç”¨åŸŸã€Beançš„ç”Ÿå‘½å‘¨æœŸ
- **Context ä¸Šä¸‹æ–‡æ¨¡å—**ï¼šå»ºç«‹åœ¨ Core å’Œ Beans æ¨¡å—çš„åŸºç¡€ä¹‹ä¸Šï¼Œé›†æˆ Beans æ¨¡å—åŠŸèƒ½å¹¶æ·»åŠ èµ„æºç»‘å®šã€æ•°æ®éªŒè¯ã€å›½é™…åŒ–ã€Java EE æ”¯æŒã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€äº‹ä»¶ä¼ æ’­ç­‰ã€‚`Context`æ¨¡å—ç»™`Spring`æä¾›ä¸€ä¸ªè¿è¡Œæ—¶çš„ç¯å¢ƒï¼Œç”¨äºä¿å­˜å„ä¸ªå¯¹è±¡çš„çŠ¶æ€ã€‚å¦‚`ApplicationContext`ï¼Œå®ƒæ˜¯`BeanFactory`çš„æ‰©å±•ï¼Œæä¾›äº†æ›´å¤šç‰¹æ€§ï¼Œ`Context`å°±æ˜¯`IOC`å®¹å™¨ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆå¦‚XMLé…ç½®æ–‡ä»¶ï¼‰æˆ–æ³¨è§£ï¼Œå¼€å‘è€…å¯ä»¥å‘Šè¯‰Springæ¡†æ¶éœ€è¦å“ªäº›Beanä»¥åŠå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ç„¶åï¼ŒSpringå®¹å™¨è´Ÿè´£æ ¹æ®é…ç½®æ¥å®ä¾‹åŒ–ã€åˆå§‹åŒ–å’Œæ³¨å…¥è¿™äº›Beanã€‚åŒæ—¶ `ApplicationContext` æ”¯æŒäº‹ä»¶çš„å‘å¸ƒå’Œç›‘å¬æœºåˆ¶ï¼Œå…è®¸Beanåœ¨æŸäº›äº‹ä»¶å‘ç”Ÿæ—¶äº§ç”Ÿé€šçŸ¥ï¼Œå¹¶è®©å…¶ä»–Beanç›‘å¬è¿™äº›äº‹ä»¶

> `IOC`å®¹å™¨çš„æ‰©å±•ç‚¹:
>
>  
>
>  å¯¹Springçš„IOCå®¹å™¨æ¥è¯´ï¼Œä¸»è¦æœ‰`BeanFactoryPostProcessor`å’Œ`BeanPostProcessor`ï¼Œä»–ä»¬åˆ†åˆ«åœ¨æ„å»º`BeanFactory`å’Œæ„å»º`Bean`å¯¹è±¡æ—¶è°ƒç”¨ï¼Œè¿˜æœ‰å°±æ˜¯`InItializingBean`å’Œ`DisposableBean`ï¼Œä»–ä»¬åˆ†åˆ«åœ¨`Bean`åˆ›å»ºå’Œé”€æ¯æ—¶è°ƒç”¨ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å®ç°è¿™äº›æ¥å£ä¸­çš„æ–¹æ³•ï¼ŒSpringä¼šåœ¨é€‚å½“çš„æ—¶å€™è°ƒç”¨ä»–ä»¬





2ã€Data Access/Integrationï¼š

- **spring-jdbc**ï¼šæä¾›äº†å¯¹æ•°æ®åº“è®¿é—®çš„æŠ½è±¡ JDBCã€‚ä¸åŒçš„æ•°æ®åº“éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ API ç”¨äºæ“ä½œæ•°æ®åº“ï¼Œè€Œ Java ç¨‹åºåªéœ€è¦å’Œ JDBC API äº¤äº’ï¼Œè¿™æ ·å°±å±è”½äº†æ•°æ®åº“çš„å½±å“(SPIæœºåˆ¶)

  1. **æä¾›äº†å¯¹æ•°æ®åº“è®¿é—®çš„æŠ½è±¡ JDBCï¼š** JDBCï¼ˆJava Database Connectivityï¼‰æ˜¯Javaæä¾›çš„æ ‡å‡†APIï¼Œç”¨äºä¸å…³ç³»å‹æ•°æ®åº“è¿›è¡Œé€šä¿¡ã€‚ä¸åŒç±»å‹çš„æ•°æ®åº“ï¼ˆå¦‚MySQLã€Oracleã€SQL Serverç­‰ï¼‰æœ‰ä¸åŒçš„æ•°æ®åº“é©±åŠ¨ç¨‹åºå’ŒAPIï¼Œå¼€å‘è€…éœ€è¦äº†è§£å¹¶ä½¿ç”¨ç‰¹å®šæ•°æ®åº“çš„APIæ‰èƒ½æ“ä½œæ•°æ®åº“ã€‚è€Œ`spring-jdbc`æ¨¡å—æä¾›äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå…è®¸å¼€å‘è€…ä½¿ç”¨ç»Ÿä¸€çš„APIæ¥æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œè€Œä¸éœ€è¦å…³å¿ƒåº•å±‚ä¸åŒæ•°æ®åº“çš„å·®å¼‚ã€‚
  2. **å±è”½äº†æ•°æ®åº“çš„å½±å“ï¼š** ä½¿ç”¨`spring-jdbc`æ¨¡å—ï¼ŒJavaç¨‹åºåªéœ€è¦ä¸JDBC API è¿›è¡Œäº¤äº’ï¼Œè€Œä¸éœ€è¦ç›´æ¥ä¸ç‰¹å®šæ•°æ®åº“çš„APIäº¤äº’ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ç¼–å†™ä¸€å¥—æ•°æ®åº“è®¿é—®ä»£ç ï¼Œç„¶ååœ¨ä¸åŒçš„æ•°æ®åº“ç³»ç»Ÿä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè€Œä¸å¿…æ”¹å˜ä»£ç ã€‚`spring-jdbc`æ¨¡å—ä¼šåœ¨åº•å±‚å¤„ç†ä¸åŒæ•°æ®åº“çš„ç»†èŠ‚ï¼Œä»è€Œå±è”½äº†è¿™äº›å·®å¼‚ï¼Œä½¿å¼€å‘è€…å¯ä»¥æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚

  æ€»ä¹‹ï¼Œ`spring-jdbc`æ¨¡å—é€šè¿‡æä¾›æŠ½è±¡çš„JDBCè®¿é—®å±‚ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿä»¥ä¸€ç§é€šç”¨çš„æ–¹å¼è®¿é—®å’Œæ“ä½œæ•°æ®åº“ï¼Œè€Œä¸å—ç‰¹å®šæ•°æ®åº“çš„é™åˆ¶ã€‚è¿™æé«˜äº†ä»£ç çš„å¯ç§»æ¤æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ›´çµæ´»åœ°é€‚åº”ä¸åŒç±»å‹çš„æ•°æ®åº“



- **Transactions äº‹åŠ¡æ¨¡å—**ï¼šæä¾›äº‹åŠ¡æ”¯æŒä¸ç®¡ç†

- **ORM æ¨¡å—**ï¼šæä¾›å¯¹ Hibernateã€JPAã€iBatis ç­‰ ORM æ¡†æ¶çš„æ”¯æŒ(æ— ç¼é›†æˆçš„API)

  ( ORM æ¨¡å—çš„ä¸»è¦ç›®æ ‡æ˜¯å°†æ•°æ®åº“ä¸­çš„æ•°æ®ä¸Javaå¯¹è±¡ä¹‹é—´å»ºç«‹æ˜ å°„ï¼Œä»è€Œä½¿å¼€å‘è€…å¯ä»¥ä½¿ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ¥æ“ä½œæ•°æ®åº“ï¼Œè€Œæ— éœ€å¤„ç† SQL è¯­å¥å’Œæ•°æ®åº“è¿æ¥ç»†èŠ‚)







3ã€Webæ¨¡å—ï¼š

- **spring-websocket**ï¼šæä¾›äº†å¯¹ WebSocket çš„æ”¯æŒï¼ŒWebSocket å¯ä»¥è®©å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›è¡ŒåŒå‘é€šä¿¡

- spring-web:`Servlet`åœ¨Springæ¡†æ¶ä¸­çš„ä½¿ç”¨æ˜¯é€šè¿‡`spring-web`æ¨¡å—æ¥å®ç°çš„

  ä¸‹æ˜¯`spring-web`æ¨¡å—ä¸­ä¸»è¦åŒ…å«çš„å†…å®¹ï¼š

  1. **Web MVC Frameworkï¼š**
     - æä¾›äº†ç”¨äºæ„å»ºåŸºäºæ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨ï¼ˆMVCï¼‰æ¶æ„çš„Webåº”ç”¨ç¨‹åºçš„æ”¯æŒã€‚
     - åŒ…æ‹¬`DispatcherServlet`ï¼Œè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™é€‚å½“çš„æ§åˆ¶å™¨ï¼Œä»¥åŠå°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
     - æä¾›äº†æ§åˆ¶å™¨ã€è§†å›¾è§£æã€æ•°æ®ç»‘å®šã€è¡¨å•å¤„ç†ã€æ•°æ®éªŒè¯ç­‰åŠŸèƒ½ã€‚
  2. **å¼‚å¸¸å¤„ç†å’Œè§†å›¾è§£æï¼š**
     - æä¾›äº†å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå¯ä»¥å°†å¼‚å¸¸æ˜ å°„åˆ°é€‚å½“çš„é”™è¯¯é¡µé¢æˆ–å¤„ç†ç¨‹åºã€‚
     - æä¾›äº†è§†å›¾è§£ææœºåˆ¶ï¼Œç”¨äºè§£æå¹¶æ¸²æŸ“è§†å›¾ï¼Œå¦‚JSPã€Thymeleafç­‰ã€‚





4ã€AOPï¼š

**AOP æ¨¡å—**ï¼šæä¾›äº†é¢å‘åˆ‡é¢ç¼–ç¨‹å®ç°ï¼Œæä¾›æ¯”å¦‚æ—¥å¿—è®°å½•ã€æƒé™æ§åˆ¶ã€äº‹åŠ¡ç®¡ç†ã€æ€§èƒ½ç»Ÿè®¡ç­‰é€šç”¨åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„æŠ€æœ¯ï¼Œå¹¶ä¸”èƒ½åŠ¨æ€çš„æŠŠè¿™äº›åŠŸèƒ½æ·»åŠ åˆ°éœ€è¦çš„ä»£ç ä¸­ï¼Œè¿™æ ·å„å¸å…¶èŒï¼Œé™ä½ä¸šåŠ¡é€»è¾‘å’Œé€šç”¨åŠŸèƒ½çš„è€¦åˆ

**Aspects æ¨¡å—**ï¼šæä¾›ä¸ AspectJ çš„é›†æˆï¼Œæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”æˆç†Ÿçš„é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æ¡†æ¶









## IOC



> **ä¸ºä»€ä¹ˆå«æ§åˆ¶åè½¬ï¼Ÿ**

- **æ§åˆ¶**ï¼šæŒ‡çš„æ˜¯å¯¹è±¡åˆ›å»ºï¼ˆå®ä¾‹åŒ–ã€ç®¡ç†ï¼‰çš„æƒåŠ›
- **åè½¬**ï¼šæ§åˆ¶æƒäº¤ç»™å¤–éƒ¨ç¯å¢ƒï¼ˆSpring æ¡†æ¶ã€IoC å®¹å™¨ï¼‰

1ã€IoC å®¹å™¨å°±åƒæ˜¯ä¸€ä¸ªå·¥å‚ä¸€æ ·ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œåªéœ€è¦é…ç½®å¥½é…ç½®æ–‡ä»¶/æ³¨è§£å³å¯ï¼Œå®Œå…¨ä¸ç”¨è€ƒè™‘å¯¹è±¡æ˜¯å¦‚ä½•è¢«åˆ›å»ºå‡ºæ¥çš„ï¼Œ IoC å®¹å™¨å®é™…ä¸Šå°±æ˜¯ä¸ª Mapï¼ˆkeyï¼Œvalueï¼‰ï¼ŒMap ä¸­å­˜æ”¾çš„æ˜¯å„ç§å¯¹è±¡

2ã€åœ¨IOCå®¹å™¨ä¸­ï¼Œé€šå¸¸ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªä»¥Beanåç§°ä¸ºKeyï¼Œä»¥å¯¹åº”çš„Beanå®ä¾‹å¯¹è±¡ä¸ºValueçš„æ˜ å°„å…³ç³»ã€‚å¯ä»¥å°†Keyçœ‹ä½œæ˜¯Beançš„æ ‡è¯†ç¬¦ï¼Œç”¨äºåœ¨å®¹å™¨ä¸­å”¯ä¸€æ ‡è¯†å’Œå®šä½ä¸€ä¸ªç‰¹å®šçš„Beanã€‚è€ŒValueåˆ™æ˜¯å¯¹åº”çš„Beanå®ä¾‹å¯¹è±¡ï¼Œå³å…·ä½“çš„åº”ç”¨ç¨‹åºç»„ä»¶ã€‚

ä¸”åœ¨Springæ¡†æ¶ä¸­ï¼Œå¸¸ç”¨çš„IOCå®¹å™¨æ˜¯`ApplicationContext`ã€‚å®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª`BeanFactory`(`ApplicationContext`æ¥å£æœ¬èº«å°±æ˜¯`BeanFactory`çš„ä¸€ä¸ªå­æ¥å£ï¼Œå®ƒç»§æ‰¿äº†`BeanFactory`æ¥å£)ï¼Œ**`BeanFactory`ä½¿ç”¨äº†ç±»ä¼¼Mapçš„æ•°æ®ç»“æ„ï¼Œå…¶ä¸­Keyæ˜¯Beançš„åç§°ï¼ˆå¯ä»¥æ˜¯IDæˆ–è€…åˆ«åï¼‰ï¼ŒValueæ˜¯å¯¹åº”çš„Beanå®ä¾‹å¯¹è±¡**

`BeanFactory`ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š

```java
public interface BeanFactory {

    Object getBean(String var1) throws BeansException;

    boolean isSingleton(String var1) throws NoSuchBeanDefinitionException;
}
```



3ã€åœ¨å®é™…é¡¹ç›®ä¸­ä¸€ä¸ª Service ç±»å¯èƒ½ä¾èµ–äº†å¾ˆå¤šå…¶ä»–çš„ç±»ï¼Œå‡å¦‚æˆ‘ä»¬éœ€è¦å®ä¾‹åŒ–è¿™ä¸ª Serviceï¼Œæ¯æ¬¡éƒ½è¦ææ¸…è¿™ä¸ª Service æ‰€æœ‰åº•å±‚ç±»çš„æ„é€ å‡½æ•°ã€‚å¦‚æœåˆ©ç”¨ IOC çš„è¯ï¼Œåªéœ€è¦é…ç½®å¥½ï¼Œç„¶ååœ¨éœ€è¦çš„åœ°æ–¹å¼•ç”¨å°±è¡Œäº†ï¼Œè¿™å¤§å¤§å¢åŠ äº†é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ä¸”é™ä½äº†å¼€å‘éš¾åº¦â€”â€”â€”â€”**åé¢æåˆ°äº†Springå¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜**

ä¼ ç»Ÿåº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±æˆ‘ä»¬åœ¨ç±»å†…éƒ¨ä¸»åŠ¨åˆ›å»ºä¾èµ–å¯¹è±¡,æœ‰äº†IOCå®¹å™¨åï¼Œ**æŠŠåˆ›å»ºå’ŒæŸ¥æ‰¾ä¾èµ–å¯¹è±¡çš„æ§åˆ¶æƒäº¤ç»™äº†å®¹å™¨ï¼Œç”±å®¹å™¨è¿›è¡Œæ³¨å…¥ç»„åˆå¯¹è±¡ï¼Œæ‰€ä»¥å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´æ˜¯ æ¾æ•£è€¦åˆ** (åº”ç”¨ç¨‹åºåŸæœ¬æ˜¯è€å¤§ï¼Œè¦è·å–ä»€ä¹ˆèµ„æºéƒ½æ˜¯ä¸»åŠ¨å‡ºå‡»ï¼Œä½†æ˜¯åœ¨IOC/DIæ€æƒ³ä¸­ï¼Œåº”ç”¨ç¨‹åºå°±å˜æˆè¢«åŠ¨çš„äº†ï¼Œè¢«åŠ¨çš„ç­‰å¾…IOCå®¹å™¨æ¥åˆ›å»ºå¹¶æ³¨å…¥å®ƒæ‰€éœ€è¦çš„èµ„æºäº†)











### Beançš„é…ç½®æ–¹å¼



#### XML

```java
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- å®šä¹‰ä¸€ä¸ªBean -->
    <bean id="myBean" class="com.example.MyBean">
        <property name="message" value="Hello, Spring!" />
    </bean>

</beans>
    
        
 <!--
ä½¿ç”¨<bean>æ ‡ç­¾å®šä¹‰äº†ä¸€ä¸ªidåä¸ºmyBeançš„Beanã€‚classå±æ€§æŒ‡å®šäº†Beançš„Javaç±»è·¯å¾„ã€‚<property>æ ‡ç­¾ç”¨äºè®¾ç½®Beançš„å±æ€§å€¼ï¼Œ
nameå±æ€§æŒ‡å®šäº†è¦è®¾ç½®çš„å±æ€§åï¼Œvalueå±æ€§æŒ‡å®šäº†å±æ€§çš„å€¼ -- >       
```





ç„¶ååœ¨åº”ç”¨ç¨‹åºä¸­åŠ è½½å¹¶ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š

``` java
javaCopy codeimport org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

public class MainApp {
    public static void main(String[] args) {
        // åŠ è½½é…ç½®æ–‡ä»¶
        ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");

        // è·å–Beanå®ä¾‹  é€šè¿‡beanNameâ€”â€”â€”â€”å”¯ä¸€id æ¥è·å–beanå®ä¾‹
        MyBean myBean = (MyBean) context.getBean("myBean");

        // ä½¿ç”¨Bean
        myBean.printMessage();
    }
}


//BeanFactoyä¸­getBeanæ–¹æ³•å¦‚ä¸‹ï¼š
Object getBean(String name) throws BeansException;
```







> é—®é¢˜æ¥äº†ï¼ŒSpringå¦‚ä½•åˆ›å»ºå’Œè·å–Beançš„å®ä¾‹å‘¢ï¼Ÿ

åœ¨Springä¸­ï¼Œå½“ä½¿ç”¨XMLé…ç½®Beanæ—¶ï¼ŒSpringæ¡†æ¶ä¼š**é€šè¿‡åå°„æœºåˆ¶æ¥åˆ›å»ºå’Œè·å–Beançš„å®ä¾‹**

å…·ä½“æ¥è¯´ï¼Œå½“Springå®¹å™¨å¯åŠ¨æ—¶ï¼Œä¼šè§£æXMLé…ç½®æ–‡ä»¶ï¼Œå¹¶æ ¹æ®é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„Beanä¿¡æ¯åˆ›å»ºç›¸åº”çš„Beanå®ä¾‹ã€‚å¯¹äºæ¯ä¸ªBeanå®šä¹‰ï¼Œ**Springä¼šé€šè¿‡Javaåå°„æœºåˆ¶åŠ¨æ€åŠ è½½ç›¸åº”çš„ç±»ï¼Œå¹¶ä½¿ç”¨åå°„æ¥å®ä¾‹åŒ–Beanå¯¹è±¡**

Springé€šè¿‡ä½¿ç”¨åå°„æœºåˆ¶å¯ä»¥åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š

1. å®ä¾‹åŒ–Beanå¯¹è±¡ï¼šSpringæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„Beanå®šä¹‰ï¼Œä½¿ç”¨åå°„æ¥åˆ›å»ºBeançš„å®ä¾‹ã€‚å®ƒä¼šé€šè¿‡ç±»çš„å…¨é™å®šåä½¿ç”¨`Class.forName()`æ–¹æ³•åŠ è½½ç±»ï¼Œå¹¶è°ƒç”¨æ„é€ å‡½æ•°(ä¸€èˆ¬ä¸º`public`)æ¥åˆ›å»ºå¯¹è±¡å®ä¾‹

2. è°ƒç”¨æ„é€ å‡½æ•°å’Œè®¾ç½®å±æ€§(åˆå§‹åŒ–)ï¼šä¸€æ—¦Beanå®ä¾‹åŒ–ï¼ŒSpringä¼šä½¿ç”¨åå°„è°ƒç”¨**é€‚å½“çš„æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–Bean**ï¼Œå¹¶é€šè¿‡åå°„è®¾ç½®Beançš„å±æ€§å€¼(**åªæ˜¯è®¾ç½®å¯¹è±¡å±æ€§ï¼Œå¹¶æ²¡æœ‰çœŸæ­£èµ‹å€¼**)â€”â€”â€”â€”é€šè¿‡`Class`å¯¹è±¡çš„`.getConstructors()`æ–¹æ³•å¯ä»¥è·å–ç±»çš„æ‰€æœ‰å…¬å…±æ„é€ æ–¹æ³•ï¼Œè€Œ`.getDeclaredConstructors()`æ–¹æ³•å¯ä»¥è·å–ç±»çš„æ‰€æœ‰æ„é€ æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼‰ã€‚ç„¶åå¯ä»¥éå†è¿™äº›æ„é€ æ–¹æ³•ï¼Œæ‰¾åˆ°éœ€è¦çš„æ„é€ æ–¹æ³•ã€‚

3. è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•<init>ï¼šå¦‚æœBeanå®šä¹‰ä¸­æŒ‡å®šäº†åˆå§‹åŒ–æ–¹æ³•ï¼ŒSpringä¼šé€šè¿‡åå°„è°ƒç”¨è¯¥æ–¹æ³•æ¥å®ŒæˆBeançš„åˆå§‹åŒ–æ“ä½œ

   åˆå§‹åŒ–æ–¹æ³•çš„å®šä¹‰å¯ä»¥åœ¨XMLé…ç½®ã€Javaæ³¨è§£æˆ–Javaä»£ç ä¸­å®Œæˆï¼š

   (1)**XMLé…ç½®ï¼š** åœ¨XMLé…ç½®æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨`<bean>`å…ƒç´ çš„`init-method`å±æ€§æ¥æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

   ```XML
   <bean id="myBean" class="com.example.MyBean" init-method="initMethod">
       <!-- å…¶ä»–é…ç½® -->
   </bean>
   
   init-methodå±æ€§å°†initMethodä½œä¸ºåˆå§‹åŒ–æ–¹æ³•ï¼ŒSpringä¼šåœ¨åˆ›å»ºmyBeanå®ä¾‹æ—¶è‡ªåŠ¨è°ƒç”¨initMethodæ–¹æ³•ã€‚
   ```

   (2)**Javaæ³¨è§£ï¼š** å¦‚æœä½ ä½¿ç”¨æ³¨è§£é…ç½®Spring Beanï¼Œä½ å¯ä»¥åœ¨Beanç±»çš„æ–¹æ³•ä¸Šä½¿ç”¨`@PostConstruct`æ³¨è§£æ¥æ ‡è®°åˆå§‹åŒ–æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

   ```JAVA
   @Component
   public class MyBean {
       // æ„é€ å‡½æ•°å’Œå…¶ä»–å±æ€§å’Œæ–¹æ³•
       
       @PostConstruct
       public void initMethod() {
           // åˆå§‹åŒ–é€»è¾‘
       }
   }
   ```

   

4. è·å–Beanå®ä¾‹ï¼šä¸€æ—¦Beanå®ä¾‹åŒ–å’Œåˆå§‹åŒ–å®Œæˆï¼ŒSpringä¼šå°†å…¶å­˜å‚¨åœ¨å®¹å™¨ä¸­ï¼Œå¹¶é€šè¿‡Beançš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆé€šå¸¸æ˜¯Beanåç§°ï¼‰æ¥ç´¢å¼•å’Œè·å–ç›¸åº”çš„Beanå®ä¾‹

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSpringä¸ä»…ä»…ä½¿ç”¨åå°„æœºåˆ¶æ¥è·å–å’Œåˆ›å»ºBeanå®ä¾‹ï¼Œå®ƒè¿˜æä¾›äº†å…¶ä»–æœºåˆ¶ï¼Œå¦‚**å·¥å‚æ–¹æ³•ã€å®ä¾‹å·¥å‚**ç­‰ï¼Œæ¥åˆ›å»ºå’Œè·å–Beanï¼Œä½†æ˜¯åœ¨XMLé…ç½®æ–¹å¼ä¸‹ï¼Œåå°„æœºåˆ¶æ˜¯æœ€å¸¸ç”¨å’Œé»˜è®¤çš„æ–¹å¼æ¥å®ç°Beançš„åˆ›å»ºå’Œè·å–





#### çº¯javaé…ç½®

é€šè¿‡ç¼–å†™Javaç±»ï¼Œä½¿ç”¨Springæä¾›çš„é…ç½®ç±»ï¼ˆå¦‚`@Configuration`ï¼‰å’Œç›¸åº”çš„æ³¨è§£ï¼ˆå¦‚`@Bean`ï¼‰æ¥å®šä¹‰Beançš„åˆ›å»ºå’Œä¾èµ–å…³ç³»ã€‚å¯ä»¥åœ¨é…ç½®ç±»ä¸­é€šè¿‡æ–¹æ³•è¿”å›Beanå®ä¾‹ï¼Œå¹¶ä½¿ç”¨æ³¨è§£è¿›è¡Œä¾èµ–æ³¨å…¥ï¼š

1ã€é¦–å…ˆåˆ›å»ºä¸€ä¸ªjavaç±»ä½œä¸ºé…ç½®ç±»ï¼š

```java
@Configuration
public class AppConfig {
    @Bean
    public MyBean myBean() {
        MyBean myBean = new MyBean();
        myBean.setMessage("Hello, Spring!");
        return myBean;
    }
}

```

ä¸Šè¿°ä»£ç ä½¿ç”¨äº†`@Configuration`æ³¨è§£å°†è¯¥ç±»æ ‡è®°ä¸ºé…ç½®ç±»ï¼Œå¹¶é€šè¿‡åœ¨æ–¹æ³•ä¸Šä½¿ç”¨`@Bean`æ³¨è§£ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º`myBean`çš„Bean(**å¦‚æœé€šè¿‡è¿™ç§æ–¹å¼é…ç½®Beanï¼ŒBeanè¢«æ³¨å…¥IOCå®¹å™¨åçš„é»˜è®¤nameä¸ºæ–¹æ³•åï¼Œå‰ææ˜¯å¦‚æœä¸æŒ‡å®š@Bean(name="customBeanName")çš„è¯**)ï¼Œå¹¶åœ¨æ–¹æ³•ä½“ä¸­è¿›è¡Œå®ä¾‹åŒ–å’Œè®¾ç½®å±æ€§

2ã€ç„¶ååœ¨åº”ç”¨ç¨‹åºä¸­åŠ è½½é…ç½®ç±»å¹¶è·å–Beanå®ä¾‹ï¼š

```java
import org.springframework.context.ApplicationContext;
import  org.springframework.context.annotation.AnnotationConfigApplicationContext;

public class MainApp {
    public static void main(String[] args) {
        // åŠ è½½é…ç½®ç±»
        ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);

        // è·å–Beanå®ä¾‹
        MyBean myBean = context.getBean(MyBean.class);

        // ä½¿ç”¨Bean
        myBean.printMessage();
    }
}

```

ä½¿ç”¨`AnnotationConfigApplicationContext`ç±»åŠ è½½é…ç½®ç±»`AppConfig`ï¼Œç„¶åä½¿ç”¨`getBean()`æ–¹æ³•æ ¹æ®Beançš„ç±»å‹è·å–å®ä¾‹ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ä¾‹è°ƒç”¨Beançš„æ–¹æ³•

é€šè¿‡Javaé…ç½®æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–å†™Javaç±»æ¥å®šä¹‰å’Œé…ç½®Beanï¼Œé¿å…äº†ä½¿ç”¨XMLçš„ç¹çå’Œå†—ä½™ã€‚é…ç½®ç±»ä¸­çš„æ–¹æ³•ä½¿ç”¨`@Bean`æ³¨è§£è¿”å›Beanå®ä¾‹ï¼Œå¹¶åœ¨æ–¹æ³•ä½“ä¸­è¿›è¡Œå®ä¾‹åŒ–å’Œè®¾ç½®å±æ€§ã€‚é€šè¿‡åŠ è½½é…ç½®ç±»ï¼ŒSpringä¼šè‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†ç›¸åº”çš„Beanï¼Œå¹¶æä¾›ä¾èµ–æ³¨å…¥å’Œå…¶ä»–ç‰¹æ€§

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJavaé…ç½®æ–¹å¼ä¹Ÿå¯ä»¥ä¸æ³¨è§£é…ç½®æ–¹å¼ç›¸ç»“åˆä½¿ç”¨ï¼Œä½¿ç”¨`@ComponentScan`æ³¨è§£è¿›è¡Œè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œå…¶ä»–ä½¿ç”¨æ³¨è§£é…ç½®çš„Bean**









#### æ³¨è§£



é€šè¿‡åœ¨ç±»ä¸ŠåŠ æ³¨è§£çš„æ–¹å¼ï¼Œæ¥å£°æ˜ä¸€ä¸ªç±»äº¤ç»™Springç®¡ç†ï¼ŒSpringä¼šè‡ªåŠ¨æ‰«æå¸¦æœ‰`@Componentï¼Œ@Controllerï¼Œ@Serviceï¼Œ@Repository`è¿™å››ä¸ªæ³¨è§£çš„ç±»ï¼Œç„¶åå¸®æˆ‘ä»¬åˆ›å»ºå¹¶ç®¡ç†ï¼Œå‰ææ˜¯éœ€è¦å…ˆé…ç½®Springçš„æ³¨è§£æ‰«æå™¨

`@Component`ï¼šé€šç”¨çš„æ³¨è§£ï¼Œå¯æ ‡æ³¨ä»»æ„ç±»ä¸º `Spring` ç»„ä»¶ã€‚å¦‚æœä¸€ä¸ª Bean ä¸çŸ¥é“å±äºå“ªä¸ªå±‚ï¼Œå¯ä»¥ä½¿ç”¨`@Component` æ³¨è§£æ ‡æ³¨

`@Repository` : å¯¹åº”æŒä¹…å±‚å³ `Dao` å±‚ï¼Œä¸»è¦ç”¨äºæ•°æ®åº“ç›¸å…³æ“ä½œ

`@Service` : å¯¹åº”æœåŠ¡å±‚ï¼Œä¸»è¦æ¶‰åŠä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œéœ€è¦ç”¨åˆ° `Dao` å±‚

`@Controller` : å¯¹åº” `Spring MVC` æ§åˆ¶å±‚ï¼Œä¸»è¦ç”¨äºæ¥å—ç”¨æˆ·è¯·æ±‚å¹¶è°ƒç”¨ `Service` å±‚è¿”å›æ•°æ®ç»™å‰ç«¯é¡µé¢ã€‚

ä»¥ä¸‹æ˜¯ä½¿ç”¨æ³¨è§£æ–¹å¼åœ¨Springä¸­å®šä¹‰å’Œé…ç½®ä¸€ä¸ªç®€å•çš„Beançš„ä¾‹å­ï¼š

```java
@Component
public class MyBean {
    private String message;

    public void setMessage(String message) {
        this.message = message;
    }

    public void printMessage() {
        System.out.println("Message: " + message);
    }
}
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`@Component`æ³¨è§£å°†`MyBean`ç±»æ ‡è®°ä¸ºä¸€ä¸ª`Spring Bean`ã€‚é€šè¿‡è¯¥æ³¨è§£ï¼Œ`Spring`ä¼šè‡ªåŠ¨å°†è¯¥ç±»å®ä¾‹åŒ–ä¸ºä¸€ä¸ªå¯ç”¨çš„Beanï¼Œå¹¶è¿›è¡Œç›¸åº”çš„ç®¡ç†å’Œä¾èµ–æ³¨å…¥





ç„¶ååœ¨åº”ç”¨ç¨‹åºä¸­å¯ç”¨æ³¨è§£æ‰«æå¹¶è·å–Beanå®ä¾‹ï¼š

```java
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;

public class MainApp {
    public static void main(String[] args) {
        // å¯ç”¨æ³¨è§£æ‰«æ
        ApplicationContext context = new AnnotationConfigApplicationContext("com.example");
        
      

        // è·å–Beanå®ä¾‹
        MyBean myBean = context.getBean(MyBean.class);

        // ä½¿ç”¨Bean
        myBean.printMessage();
    }
}





//
  public AnnotationConfigApplicationContext(String... basePackages) {
		this();
		scan(basePackages);
		refresh();
	}
```

ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`AnnotationConfigApplicationContext`ç±»å¹¶ä¼ å…¥è¦æ‰«æçš„åŸºç¡€åŒ…è·¯å¾„ï¼ˆä¾‹å¦‚`com.example`ï¼‰ï¼Œä»¥å¯ç”¨æ³¨è§£æ‰«æå’Œæ³¨å†Œã€‚Springä¼šè‡ªåŠ¨æ‰«æå¹¶è¯†åˆ«ä½¿ç”¨æ³¨è§£é…ç½®çš„Bean







### DI



**IOCå’ŒDIæ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ**

IoCæ˜¯è®¾è®¡æ€æƒ³ï¼ŒDIæ˜¯å®ç°æ–¹å¼ã€‚ç»„ä»¶ä¹‹é—´ä¾èµ–å…³ç³»ç”±å®¹å™¨åœ¨è¿è¡ŒæœŸå†³å®šï¼Œå½¢è±¡çš„è¯´ï¼Œå³**ç”±å®¹å™¨åŠ¨æ€çš„å°†æŸä¸ªä¾èµ–å…³ç³»æ³¨å…¥åˆ°ç»„ä»¶ä¹‹ä¸­**



åœ¨Springæ¡†æ¶ä¸­ï¼Œå®ç°ä¾èµ–æ³¨å…¥ï¼ˆ`Dependency Injection`ï¼‰çš„æ–¹å¼æœ‰å¤šç§ï¼ŒåŒ…æ‹¬ï¼š

1. æ„é€ å‡½æ•°æ³¨å…¥ï¼ˆ`Constructor Injection`ï¼‰ï¼šé€šè¿‡æ„é€ å‡½æ•°æ¥æ³¨å…¥ä¾èµ–é¡¹ã€‚å¯ä»¥åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­å£°æ˜ä¾èµ–é¡¹çš„å‚æ•°ï¼Œå¹¶ç”±Springå®¹å™¨è´Ÿè´£è§£æå’Œæ³¨å…¥ä¾èµ–é¡¹ã€‚
2. Setteræ–¹æ³•æ³¨å…¥ï¼ˆ`Setter Injection`ï¼‰ï¼šé€šè¿‡`Setter`æ–¹æ³•æ¥æ³¨å…¥ä¾èµ–é¡¹ã€‚å¯ä»¥åœ¨ç±»ä¸­å®šä¹‰ç›¸åº”çš„`Setter`æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨`@Autowired`æ³¨è§£æˆ–XMLé…ç½®æ¥æŒ‡å®šè¦æ³¨å…¥çš„ä¾èµ–é¡¹ã€‚
3. å­—æ®µæ³¨å…¥ï¼ˆ`Field Injection`ï¼‰ï¼šé€šè¿‡ç›´æ¥æ³¨å…¥å­—æ®µæ¥å®ç°ä¾èµ–æ³¨å…¥ã€‚å¯ä»¥åœ¨ç±»çš„å­—æ®µä¸Šä½¿ç”¨`@Autowired`æ³¨è§£æ¥æŒ‡å®šè¦æ³¨å…¥çš„ä¾èµ–é¡¹ã€‚è¿™ç§æ–¹å¼ä¸€èˆ¬ä¸è¢«æ¨èï¼Œå› ä¸ºç›´æ¥æ³¨å…¥å­—æ®µä¼šç ´åå°è£…æ€§ã€‚
4. æ¥å£æ³¨å…¥ï¼ˆ`Interface Injection`ï¼‰ï¼šé€šè¿‡å®ç°ç‰¹å®šçš„æ¥å£æ¥æ³¨å…¥ä¾èµ–é¡¹ã€‚å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œå…¶ä¸­åŒ…å«ç”¨äºè®¾ç½®ä¾èµ–é¡¹çš„æ–¹æ³•ï¼Œç„¶ååœ¨ç±»ä¸­å®ç°è¯¥æ¥å£å¹¶ä½¿ç”¨`@Autowired`æ³¨è§£æ¥æ³¨å…¥ä¾èµ–é¡¹ã€‚
5. æ³¨è§£æ³¨å…¥ï¼ˆ`Annotation-based Injection`ï¼‰ï¼šä½¿ç”¨æ³¨è§£æ¥å®ç°ä¾èµ–æ³¨å…¥ã€‚å¯ä»¥åœ¨ç±»çš„æ„é€ å‡½æ•°ã€Setteræ–¹æ³•ã€å­—æ®µç­‰ä½ç½®ä½¿ç”¨`@Autowired`æ³¨è§£æ¥æŒ‡å®šè¦æ³¨å…¥çš„ä¾èµ–é¡¹ã€‚åŒæ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æ³¨è§£å¦‚`@Resource`ã€`@Inject`ç­‰æ¥å®ç°ä¾èµ–æ³¨å…¥ã€‚



#### å­—æ®µæ³¨å…¥ :sun_with_face:



> é¦–å…ˆéœ€è¦åŒºåˆ†ä¸€ä¸‹å­—æ®µæ³¨å…¥å’Œæ³¨è§£æ³¨å…¥ï¼š
>
> åœ¨Springä¾èµ–æ³¨å…¥ä¸­ï¼Œæ³¨è§£æ³¨å…¥å’Œå­—æ®µæ³¨å…¥å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„æ¦‚å¿µï¼Œå°½ç®¡å®ƒä»¬ç»å¸¸åŒæ—¶ä½¿ç”¨
>
> 1. æ³¨è§£æ³¨å…¥ï¼ˆAnnotation-based Injectionï¼‰ï¼šæ³¨è§£æ³¨å…¥æ˜¯ä¸€ç§ä½¿ç”¨æ³¨è§£æ¥å®ç°ä¾èµ–æ³¨å…¥çš„æ–¹å¼ã€‚é€šè¿‡åœ¨ç±»çš„æ„é€ å‡½æ•°ã€Setteræ–¹æ³•ã€å­—æ®µç­‰ä½ç½®ä½¿ç”¨æ³¨è§£ï¼ˆå¦‚`@Autowired`ã€`@Resource`ã€`@Inject`ç­‰ï¼‰æ¥æ ‡è¯†è¦æ³¨å…¥çš„ä¾èµ–é¡¹ã€‚æ³¨è§£å‘Šè¯‰Springå®¹å™¨è¦è‡ªåŠ¨æ³¨å…¥ç›¸å…³çš„ä¾èµ–é¡¹
> 2. å­—æ®µæ³¨å…¥ï¼ˆField Injectionï¼‰ï¼šå­—æ®µæ³¨å…¥æ˜¯ä¸€ç§ç‰¹å®šçš„ä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œå®ƒå°†ä¾èµ–é¡¹ç›´æ¥æ³¨å…¥åˆ°ç±»çš„å­—æ®µä¸­ã€‚ä½¿ç”¨`@Autowired`æ³¨è§£æˆ–å…¶ä»–ç›¸å…³çš„æ³¨è§£æ¥æ ‡è®°å­—æ®µï¼Œå‘Šè¯‰Springå®¹å™¨è¦å°†ç›¸å…³çš„ä¾èµ–é¡¹æ³¨å…¥åˆ°è¿™äº›å­—æ®µä¸­
>
> å°½ç®¡åœ¨å®è·µä¸­ï¼Œä½¿ç”¨æ³¨è§£æ³¨å…¥æ—¶é€šå¸¸ä¼šå°†æ³¨è§£æ”¾åœ¨å­—æ®µä¸Šï¼Œä»¥å®ç°å­—æ®µæ³¨å…¥ã€‚ä½†æ³¨è§£æ³¨å…¥å¹¶ä¸é™äºå­—æ®µæ³¨å…¥ï¼Œè¿˜å¯ä»¥ç”¨äºæ„é€ å‡½æ•°æ³¨å…¥å’ŒSetteræ–¹æ³•æ³¨å…¥ã€‚æ³¨è§£æ³¨å…¥æä¾›äº†ä¸€ç§æ›´çµæ´»çš„æ–¹å¼æ¥å®šä¹‰å’Œé…ç½®ä¾èµ–é¡¹çš„æ³¨å…¥æ–¹å¼ï¼Œå¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åœ¨ä¸åŒä½ç½®ä½¿ç”¨æ³¨è§£æ¥å®ç°ä¾èµ–æ³¨å…¥



ä½¿ç”¨æœ€ç®€å•çš„**å­—æ®µæ³¨å…¥**æ–¹å¼æ¥æ³¨å…¥Beanï¼š

```java
@Service
public class UserServiceImpl {

    @Autowired
    private UserDaoImpl userDao;

    public List<User> findUserList() {
        return userDao.findUserList();
    }

}
```

è§‚å¯Ÿä»¥ä¸Šä»£ç ï¼š`@Service`æ³¨è§£è¡¨ç¤º`UserServiceImpl`ç±»æ˜¯ä¸€ä¸ªæœåŠ¡ç±»å‹çš„`bean`ï¼Œé€šè¿‡`@Autowired`æ³¨è§£ï¼Œå°†`UserDaoImpl`ç±»çš„å®ä¾‹è‡ªåŠ¨æ³¨å…¥åˆ°`userDao`å±æ€§ä¸­ï¼Œè€Œ`findUserList()`æ–¹æ³•ç”¨äºè°ƒç”¨`userDao`çš„`findUserList()`æ–¹æ³•æ¥è·å–ç”¨æˆ·åˆ—è¡¨





æ³¨æ„ï¼š:exclamation: :exclamation:  å¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–ï¼ˆA Beanä¾èµ–äºB Beanï¼ŒB BeanåŒæ—¶ä¹Ÿä¾èµ–äºA Beanï¼‰ï¼Œæ­¤æ—¶å­—æ®µæ³¨å…¥å¯èƒ½ä¼šå¼•å‘é—®é¢˜ã€‚æ„é€ å‡½æ•°æ³¨å…¥å¯ä»¥æ›´å¥½åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚



#### Setteræ³¨å…¥

éœ€è¦æ³¨æ„çš„æ˜¯ `Setter`æ–¹å¼å®ç°æ³¨å…¥éœ€è¦é…åˆXMLæˆ–è€…æ³¨è§£æ¥å®ç°

æ¥çœ‹çœ‹ä½¿ç”¨`Setter()`+`XML` å®ç°beançš„æ³¨å…¥ï¼š

1ã€åˆ›å»ºä¸€ä¸ªJavaç±»ä½œä¸º`UserServiceImpl`ï¼š

```java
public class UserServiceImpl {
    private UserDao userDao;

    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }

    public List<User> findUserList() {
        return userDao.findUserList();
    }
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`UserServiceImpl`ç±»æ˜¯ä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼Œæ²¡æœ‰ä½¿ç”¨ä»»ä½•æ³¨è§£ã€‚å®ƒä¾èµ–äº`UserDao`æ¥å£ï¼Œé€šè¿‡`Setter`æ–¹æ³•`setUserDao()`æ¥è®¾ç½®`userDao`å±æ€§



2ã€åˆ›å»ºSpringçš„é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚`applicationContext.xml`ï¼‰ï¼Œå®šä¹‰å’Œé…ç½®Beanï¼š

```java
xmlCopy code<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <!-- å®šä¹‰ UserDaoImpl Bean -->
        <bean id="userDao" class="com.example.UserDaoImpl" />

    <!-- å®šä¹‰ UserServiceImpl Bean -->
    <bean id="userService" class="com.example.UserServiceImpl">
        <property name="userDao" ref="userDao" />
    </bean>

</beans>
```

åœ¨ä¸Šè¿°XMLé…ç½®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`<bean>`æ ‡ç­¾åˆ†åˆ«å®šä¹‰äº†`UserDao`å’Œ`UserServiceImpl`çš„Beanã€‚é€šè¿‡`class`å±æ€§æŒ‡å®šç±»çš„è·¯å¾„ã€‚åœ¨`UserServiceImpl`çš„é…ç½®ä¸­ï¼Œä½¿ç”¨`<property>`æ ‡ç­¾å°†`userDao`å±æ€§æ³¨å…¥åˆ°idä¸º`userDao` çš„Beanä¸­å»



3ã€æœ€ååœ¨åº”ç”¨ç¨‹åºä¸­åŠ è½½å¹¶ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š

```java
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;

public class MainApp {
    public static void main(String[] args) {
        // åŠ è½½é…ç½®æ–‡ä»¶
            ApplicationContext context = new ClassPathXmlApplicationContext("applicationContext.xml");

        // è·å– Bean å®ä¾‹
        UserServiceImpl userService = (UserServiceImpl) context.getBean("userService");

        // ä½¿ç”¨ Bean
        userService.findUserList();
    }
}

```

é¦–å…ˆä½¿ç”¨`ApplicationContext`æ¥å£æ¥åŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨`getBean()`æ–¹æ³•æ ¹æ®Beançš„IDè·å–`UserServiceImpl`å®ä¾‹ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ä¾‹è°ƒç”¨æœåŠ¡æ–¹æ³•

å¯ä»¥çœ‹å‡ºæ¥`XML`+`Setter`çš„å®ç°æ–¹å¼éº»çƒ¦äº†è®¸å¤šğŸ˜…ğŸ˜…ğŸ˜…



ç„¶åæˆ‘ä»¬å†æ¥çœ‹çœ‹æ³¨è§£+`Setter`æ˜¯å¦‚ä½•å®ç°Beançš„æ³¨å…¥çš„ï¼š

å‡è®¾æœ‰ä¸€ä¸ª `UserDao` æ¥å£å’Œå®ƒçš„å®ç°ç±» `UserDaoImpl`ï¼š

```java
public interface UserDao {
    // ...
}

@Repository
public class UserDaoImpl implements UserDao {
    // ...
}

```

ç„¶åæœ‰ä¸€ä¸ªServiceç±»ï¼Œé€šè¿‡setteræ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥ï¼š

```java
@Service
public class UserService {

    private UserDao userDao;

    @Autowired
    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }
    
    // ...
}

```

è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œé€šè¿‡ä½¿ç”¨ `@Autowired` æ³¨è§£åœ¨ `setUserDao()` æ–¹æ³•ä¸Šï¼Œå‘Šè¯‰Springåœ¨å®¹å™¨ä¸­æ‰¾åˆ°å®ç°äº† `UserDao` æ¥å£çš„Beanï¼Œå¹¶å°†å®ƒæ³¨å…¥åˆ° `userDao` å­—æ®µä¸­ï¼Œå½“ç„¶è¿˜å¯ä»¥ä½¿ç”¨æ›´ç®€åŒ–çš„æ–¹å¼ï¼Œå°† `@Autowired` æ³¨è§£ç›´æ¥æ”¾åœ¨å­—æ®µä¸Šï¼Œè€Œä¸æ˜¯æ”¾åœ¨setteræ–¹æ³•ä¸Šï¼š

```java
@Service
public class UserService {

    @Autowired
    private UserDao userDao;
    
    // ...
}
```



> è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæ³¨å…¥çš„æ˜¯`UserDao`è€Œä¸æ˜¯å£°æ˜äº†`@Repository`æ³¨è§£çš„`UserDaoImpl`?



å½“ä½¿ç”¨`Spring`çš„ä¾èµ–æ³¨å…¥æ—¶ï¼Œæ‚¨æ³¨å…¥çš„æ˜¯æ¥å£ï¼ˆæˆ–æŠ½è±¡ç±»ï¼‰çš„ç±»å‹ï¼Œè€Œä¸æ˜¯å…·ä½“çš„å®ç°ç±»ã€‚è¿™æ˜¯å› ä¸ºSpringçš„ä¾èµ–æ³¨å…¥æ˜¯åŸºäºæŠ½è±¡çš„ç¼–ç¨‹åŸåˆ™ï¼Œå³â€œé¢å‘æ¥å£ç¼–ç¨‹â€ï¼Œä»¥å®ç°æ¾è€¦åˆå’Œå¯æ›¿æ¢çš„è®¾è®¡

åŒæ—¶ä½¿ç”¨`@AutoWired`æ—¶ï¼Œï¼Œç¨‹åºåœ¨springçš„å®¹å™¨ä¸­æŸ¥æ‰¾ç±»å‹æ—¶`UserDao`çš„`bean`ï¼Œåˆšå¥½æ‰¾åˆ°æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ­¤ç±»å‹çš„beanï¼Œå³`UserDaoImpl`ï¼Œæ‰€ä»¥å°±æŠŠ`UserDaoImpl`æ³¨å…¥åˆ°äº†`UserService`çš„å±æ€§`UserDao`ä¸­





#### æ„é€ å‡½æ•°æ³¨å…¥

æ„é€ å‡½æ•°æ³¨å…¥beanä¹Ÿéœ€è¦**é…åˆXMLæˆ–æ³¨è§£**æ¥å®ç°ï¼Œè¿™é‡Œæ¥çœ‹çœ‹ç»“åˆæ³¨è§£æ˜¯æ€ä¹ˆåšçš„ï¼š

```java
@Service
public class UserServiceImpl {

    private final UserDaoImpl userDao;  //å¯¹è±¡å±æ€§
    
    //å°†userDaoä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ï¼Œå¹¶ç”±Springæ¡†æ¶è´Ÿè´£è§£æå’Œæ³¨å…¥ä¾èµ–é¡¹
    @Autowired 
    public UserServiceImpl(UserDaoImpl userDaoImp) {
        this.userDao = userDaoImp;
    }

    public List<User> findUserList() {
        return userDao.findUserList();
    }
}
```

é€šè¿‡åœ¨è¯¥ç±»çš„æ„é€ æ–¹æ³•ä¸Šæ·»åŠ `@AutoWired`æ³¨è§£æ¥æ³¨å…¥å¯¹è±¡çš„Beanå±æ€§ï¼Œæ­¤æ—¶å°±æ— éœ€åœ¨`applicationContext.xml`é‡Œè¿›è¡Œé¢å¤–çš„é…ç½®å’Œå£°æ˜äº†







#### æ¥å£æ³¨å…¥







#### å®ç°Beanæ³¨å…¥çš„ç›¸å…³æ³¨è§£  :angel:



`@Autowired`:

å½“ä½¿ç”¨@`Autowired`æ³¨è§£æ—¶ï¼Œ`Spring`å®¹å™¨ä¼šè‡ªåŠ¨æŸ¥æ‰¾å’Œæ³¨å…¥ä¸è¢«æ³¨å…¥å­—æ®µã€æ–¹æ³•å‚æ•°æˆ–æ„é€ æ–¹æ³•å‚æ•°å…·æœ‰ç›¸åŒç±»å‹çš„Beanï¼Œé»˜è®¤æ˜¯æ ¹æ®typeç±»å‹è¿›è¡ŒåŒ¹é…ï¼š

- å¦‚æœè¢«æ³¨å…¥çš„å­—æ®µæˆ–æ–¹æ³•å‚æ•°çš„ç±»å‹ä¸ä¸€ä¸ªå”¯ä¸€çš„`Bean`ç±»å‹åŒ¹é…ï¼Œ`Spring`å®¹å™¨å°†è‡ªåŠ¨æ³¨å…¥è¯¥`Bean`
- å¦‚æœå­˜åœ¨å¤šä¸ªä¸ç±»å‹åŒ¹é…çš„`Bean`æ—¶ï¼Œä¼šå‘ç”Ÿè£…é…å¼‚å¸¸ã€‚æ­¤æ—¶å¯ä»¥ç»“åˆä½¿ç”¨`@Qualifier`æ³¨è§£ï¼Œé€šè¿‡æŒ‡å®šå…·ä½“çš„`Bean`åç§°æ¥è§£å†³æ­§ä¹‰(ä¸‹é¢æœ‰è®²)







éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**`@Autowired`æ³¨è§£é»˜è®¤æ˜¯`required=true`**ï¼Œ**å³è¦æ±‚å¿…é¡»å­˜åœ¨ä¸ç±»å‹åŒ¹é…çš„ Bean** ï¼Œ**å¦‚æœè®¾ç½®required=falseï¼Œåˆ™è¡¨ç¤ºå…è®¸ä¾èµ–çš„Beanä¸å­˜åœ¨ï¼Œæ³¨å…¥ä¸ºnullå€¼**



> `@Autowired` å±äº Spring å†…ç½®çš„æ³¨è§£ï¼Œé»˜è®¤çš„æ³¨å…¥æ–¹å¼ä¸º`byType`ï¼ˆæ ¹æ®ç±»å‹è¿›è¡ŒåŒ¹é…ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šä¼˜å…ˆæ ¹æ®æ¥å£ç±»å‹å»åŒ¹é…å¹¶æ³¨å…¥ Bean ï¼ˆæ¥å£çš„å®ç°ç±»ï¼‰
>
> 
>
> **è¿™ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ** å½“ä¸€ä¸ªæ¥å£å­˜åœ¨å¤šä¸ªå®ç°ç±»(ä¸”éƒ½è¢«IOCå®¹å™¨ç®¡ç†)ï¼Œ`byType`è¿™ç§æ–¹å¼å°±æ— æ³•æ­£ç¡®æ³¨å…¥å¯¹è±¡äº†ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ Spring ä¼šåŒæ—¶æ‰¾åˆ°å¤šä¸ªæ»¡è¶³æ¡ä»¶çš„é€‰æ‹©ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒè‡ªå·±ä¸çŸ¥é“é€‰æ‹©å“ªä¸€ä¸ª
>
> 
>
> è¿™ç§æƒ…å†µä¸‹ï¼Œæ³¨å…¥æ–¹å¼ä¼šå˜ä¸º `byName`ï¼ˆæ ¹æ®åç§°è¿›è¡ŒåŒ¹é…ï¼‰ï¼Œè¿™ä¸ªåç§°é€šå¸¸å°±æ˜¯ç±»åï¼ˆé¦–å­—æ¯å°å†™ï¼‰ï¼Œæ¯”å¦‚è¯´ä¸‹é¢ä»£ç ä¸­çš„ `smsService` å°±æ˜¯è¿™é‡Œæ‰€è¯´çš„åç§°ï¼š
>
> 

```java
// smsService å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„åç§°
@Autowired
private SmsService smsService;
```

ä¸¾ä¸ªä¾‹å­ï¼Œ`SmsService` æ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»: `SmsServiceImpl1`å’Œ `SmsServiceImpl2`ï¼Œä¸”å®ƒä»¬éƒ½å·²ç»è¢« Spring å®¹å™¨æ‰€ç®¡ç†

```java
// æŠ¥é”™ï¼ŒbyName å’Œ byType éƒ½æ— æ³•åŒ¹é…åˆ° bean
@Autowired
private SmsService smsService;




// æ­£ç¡®æ³¨å…¥  SmsServiceImpl1 å¯¹è±¡å¯¹åº”çš„ bean
// smsServiceImpl1 å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„åç§°
@Autowired
@Qualifier(value = "smsServiceImpl1")
private SmsService smsService;
```





`@Resource`ï¼š

- @Resourceæ˜¯JavaEEæä¾›çš„æ³¨è§£ï¼Œä¹Ÿå¯ä»¥ç”¨äºSpringä¸­ï¼Œç”¨äºè‡ªåŠ¨è£…é…Beançš„ä¾èµ–å…³ç³»

- @Resourceå¯ä»¥ç”¨äºå­—æ®µã€Setteræ–¹æ³•ä»¥åŠæ™®é€šæ–¹æ³•ä¸Š(**ä¸èƒ½ç”¨åœ¨æ„é€ æ–¹æ³•ä¸Šï¼ï¼Œå³ä¸æ”¯æŒæ„é€ æ–¹æ³•æ³¨å…¥** )

- å®ƒå¯ä»¥æ ¹æ®åç§°è¿›è¡Œè‡ªåŠ¨è£…é…ï¼Œ**ä¸”é»˜è®¤æŒ‰ç…§Beanåç§°è¿›è¡ŒåŒ¹é…(ä¸åŒäº`@Autowired`å’Œ`@Inject`çš„æœ€å¤§ä¹‹å¤„ï¼ï¼)**  ï¼Œå¦‚æœæ‰¾ä¸åˆ°ä¸åç§°åŒ¹é…çš„Beanï¼Œå¯ä»¥ç»“åˆ`@Qualifier`æ³¨è§£æŒ‡å®šå…·ä½“çš„Beanåç§°ï¼›å¦‚æœæ— æ³•é€šè¿‡åç§°åŒ¹é…åˆ°å¯¹åº”çš„ Bean çš„è¯ï¼Œæ³¨å…¥æ–¹å¼ä¼šå˜ä¸º`byType`

- @Autowiredå’Œ@Injectå¯ä»¥ç»“åˆ@Qualifieræ³¨è§£æ¥æŒ‡å®šå…·ä½“çš„Beanåç§°ï¼Œè€Œ@Resourceç›´æ¥é€šè¿‡`name`å±æ€§æŒ‡å®šBeanåç§°:

  ```java
  public @interface Resource {
      String name() default "";
      Class<?> type() default Object.class;
  }
  ```

  `@Resource`é»˜è®¤æ˜¯æŒ‰ç…§Beançš„åç§°è¿›è¡ŒåŒ¹é…ï¼›å¦‚æœä»…æŒ‡å®š `name` å±æ€§åˆ™æ³¨å…¥æ–¹å¼ä¸º`byName`ï¼Œå¦‚æœæŒ‡å®š`type`å±æ€§åˆ™æ³¨å…¥æ–¹å¼ä¸º`byType`ï¼›å¦‚æœåŒæ—¶æŒ‡å®š`name` å’Œ`type`å±æ€§ï¼ˆä¸å»ºè®®è¿™ä¹ˆåšï¼‰åˆ™æ³¨å…¥æ–¹å¼ä¸º`byType`+`byName`

  ```java
  // æŠ¥é”™ï¼ŒbyName å’Œ byType éƒ½æ— æ³•åŒ¹é…åˆ° bean
  @Resource
  private SmsService smsService;
  
  
  
  
  
  // æ­£ç¡®æ³¨å…¥ SmsServiceImpl1 å¯¹è±¡å¯¹åº”çš„ beanï¼ˆæ¯”è¾ƒæ¨èè¿™ç§æ–¹å¼ï¼‰
  @Resource(name = "smsServiceImpl1")
  private SmsService smsService;
  ```

  ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š
  
  - `@Autowired` æ˜¯ Spring æä¾›çš„æ³¨è§£ï¼Œ`@Resource` æ˜¯ JDK æä¾›çš„æ³¨è§£
  - `@Autowired` é»˜è®¤çš„æ³¨å…¥æ–¹å¼ä¸º`byType`ï¼ˆæ ¹æ®ç±»å‹è¿›è¡ŒåŒ¹é…ï¼‰ï¼Œ`@Resource`é»˜è®¤æ³¨å…¥æ–¹å¼ä¸º `byName`ï¼ˆæ ¹æ®åç§°è¿›è¡ŒåŒ¹é…ï¼‰
  - å½“ä¸€ä¸ªæ¥å£å­˜åœ¨å¤šä¸ªå®ç°ç±»çš„æƒ…å†µä¸‹ï¼Œ`@Autowired` å’Œ`@Resource`éƒ½éœ€è¦é€šè¿‡åç§°æ‰èƒ½æ­£ç¡®åŒ¹é…åˆ°å¯¹åº”çš„ Beanã€‚`Autowired` å¯ä»¥é€šè¿‡ `@Qualifier` æ³¨è§£æ¥æ˜¾å¼æŒ‡å®šåç§°ï¼Œ`@Resource`å¯ä»¥é€šè¿‡ `name` å±æ€§æ¥æ˜¾å¼æŒ‡å®šåç§°
  
  



`@Inject`ï¼š

- @Injectæ˜¯Javaè§„èŒƒ(javaxæ‰©å±•åŒ…)ä¸­å®šä¹‰çš„æ³¨è§£ï¼Œå¯ä»¥ç”¨äºSpringä¸­ï¼Œä¹Ÿå¯ä»¥ä¸JavaEEå®¹å™¨ä¸€èµ·ä½¿ç”¨

- @Injectå¯ä»¥ç”¨äºå­—æ®µã€æ„é€ æ–¹æ³•ã€Setteræ–¹æ³•ä»¥åŠæ™®é€šæ–¹æ³•ä¸Š
- å®ƒå’Œ`@Autowired`æ³¨è§£çš„ä½œç”¨ç±»ä¼¼ï¼Œç”¨äºè‡ªåŠ¨è£…é…Beançš„ä¾èµ–å…³ç³»
- @Injectæ³¨è§£å¯ä»¥ä½¿ç”¨`@Named`(ä½œç”¨ç±»ä¼¼äº`@Qualified`)æ³¨è§£æ¥æŒ‡å®šå…·ä½“çš„Beanåç§°





### @Component å’Œ @Bean çš„åŒºåˆ«ï¼Ÿ

- @Componentæ³¨è§£ï¼š

  - @Componentæ˜¯é€šç”¨çš„æ³¨è§£ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªç±»ä½œä¸ºç»„ä»¶(é€šç”¨ç»„ä»¶)è¢«Springç®¡ç†ã€‚
  - @Componentæ³¨è§£å¯ä»¥ç”¨åœ¨ä»»ä½•ç±»ä¸Šï¼Œè¡¨ç¤ºå°†è¯¥ç±»å®ä¾‹åŒ–ä¸ºä¸€ä¸ªBeanå¯¹è±¡ï¼Œå¹¶ç”±Springå®¹å™¨è¿›è¡Œç®¡ç†ã€‚
  - @Controllerã€@Serviceã€@Repositoryæ³¨è§£æ˜¯@Componentæ³¨è§£çš„æ´¾ç”Ÿæ³¨è§£ï¼Œç”¨äºè¡¨ç¤ºä¸åŒç±»å‹çš„ç»„ä»¶
- @Beanæ³¨è§£ï¼š

  - @Beanæ³¨è§£ç”¨äºåœ¨é…ç½®ç±»ï¼ˆé€šå¸¸æ˜¯å¸¦æœ‰@Configurationæ³¨è§£çš„ç±»ï¼‰ä¸­å£°æ˜æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªBeanå¯¹è±¡
  - @Beanæ³¨è§£å¯ä»¥æ”¾åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºå°†æ–¹æ³•çš„è¿”å›å€¼å®ä¾‹åŒ–ä¸ºä¸€ä¸ªBeanå¯¹è±¡ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°Springå®¹å™¨ä¸­
  - @Beanæ³¨è§£å…è®¸å¼€å‘äººå‘˜å®Œå…¨æ§åˆ¶Beançš„åˆ›å»ºè¿‡ç¨‹ï¼Œå¯ä»¥åœ¨æ–¹æ³•ä¸­è¿›è¡Œè‡ªå®šä¹‰çš„å®ä¾‹åŒ–ã€å±æ€§è®¾ç½®ç­‰æ“ä½œ

  





### Beançš„ä½œç”¨åŸŸ



Beançš„ä½œç”¨åŸŸå®šä¹‰äº†Beanå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä»¥åŠåœ¨å®¹å™¨ä¸­çš„å¯è§èŒƒå›´ã€‚Springæ¡†æ¶æä¾›äº†ä»¥ä¸‹å‡ ç§å¸¸ç”¨çš„Beanä½œç”¨åŸŸï¼š

1. `Singleton`ï¼ˆé»˜è®¤ï¼‰ï¼šåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­ï¼Œæ¯ä¸ªBeanå®šä¹‰å¯¹åº”ä¸€ä¸ªå®ä¾‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringå®¹å™¨ä¸­çš„Beanéƒ½æ˜¯Singletonä½œç”¨åŸŸã€‚åœ¨Singletonä½œç”¨åŸŸä¸‹ï¼ŒSpringå®¹å™¨åªä¼šåˆ›å»ºä¸€ä¸ªBeanå®ä¾‹(**Springä¼šé€šè¿‡åå°„æˆ–è€…cglibæ¥ç”Ÿæˆbeanå®ä¾‹**)ï¼Œå¹¶åœ¨éœ€è¦æ—¶é‡å¤ä½¿ç”¨è¯¥å®ä¾‹(å¤„ç†å¤šæ¬¡è¯·æ±‚æ—¶åœ¨**Spring**å®¹å™¨é‡Œåªå®ä¾‹åŒ–å‡ºä¸€ä¸ªbeanï¼Œåç»­çš„è¯·æ±‚éƒ½å…¬ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œå½“æœ‰è¯·æ±‚æ¥çš„æ—¶å€™ä¼šå…ˆä»ç¼“å­˜**map**é‡ŒæŸ¥çœ‹æœ‰æ²¡æœ‰ï¼Œæœ‰çš„è¯ç›´æ¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œæ²¡æœ‰çš„è¯æ‰å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„å¯¹è±¡)
2. Prototypeï¼šæ¯æ¬¡é€šè¿‡å®¹å™¨è·å–Beanæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Beanå®ä¾‹ã€‚æ¯ä¸ªBeanå®šä¹‰å¯¹åº”å¤šä¸ªå®ä¾‹ï¼Œæ¯æ¬¡è·å–Beanæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚Prototypeä½œç”¨åŸŸé€‚ç”¨äºéœ€è¦æ¯æ¬¡è·å–éƒ½æ˜¯å…¨æ–°å®ä¾‹çš„æƒ…å†µ
3. Requestï¼šæ¯ä¸ªHTTPè¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Beanå®ä¾‹ã€‚é€‚ç”¨äºWebåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ç‹¬ç«‹çš„Beanå®ä¾‹
4. Sessionï¼šæ¯ä¸ªç”¨æˆ·ä¼šè¯ï¼ˆSessionï¼‰éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Beanå®ä¾‹ã€‚é€‚ç”¨äºWebåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªç”¨æˆ·ä¼šè¯éƒ½éœ€è¦ç‹¬ç«‹çš„Beanå®ä¾‹

> ä¸ºä»€ä¹ˆé»˜è®¤æ˜¯å•ä¾‹ï¼Ÿ
>
> (1)å½“Beanè¢«å£°æ˜ä¸ºSingletonä½œç”¨åŸŸæ—¶ï¼ŒSpringå®¹å™¨åªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹å¹¶å°†å…¶ç¼“å­˜èµ·æ¥ã€‚åœ¨åç»­çš„è¯·æ±‚ä¸­ï¼Œå¦‚æœéœ€è¦è¯¥Beanï¼Œå®¹å™¨å°†ç›´æ¥è¿”å›ç¼“å­˜çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„å®ä¾‹ã€‚è¿™æ ·å¯ä»¥**å‡å°‘å¯¹è±¡åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€**ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚
>
> 
>
> (2)æ­¤å¤–ï¼ŒSingletonä½œç”¨åŸŸè¿˜å¯ä»¥**ç¡®ä¿Beanä¹‹é—´çš„çŠ¶æ€å…±äº«**ã€‚åœ¨Singletonä½œç”¨åŸŸä¸‹ï¼Œ**å¤šä¸ªBeanå¯ä»¥å¼•ç”¨åŒä¸€ä¸ªå®ä¾‹**ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åœ°å…±äº«æ•°æ®å’ŒçŠ¶æ€ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§
>
> 
>
> (3)åŒæ—¶ç”±äºå¤šæ¬¡è¯·æ±‚beanåªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œ**å‡å°‘jvmåƒåœ¾å›æ”¶çš„å¯¹è±¡**ï¼Œå¹¶ä¸”**ç”±äºåç»­è¯·æ±‚beanéƒ½æ˜¯ç›´æ¥ä»Mapç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæ‰€ä»¥å¯ä»¥å¿«é€Ÿè·å–ä¸€ä¸ªBean**
>
> 
>
> 
>
> ç„¶è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSingletonä½œç”¨åŸŸå¹¶ä¸é€‚ç”¨äºæ‰€æœ‰çš„æƒ…å†µã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œéœ€è¦æ¯æ¬¡è·å–Beanéƒ½æ˜¯å…¨æ–°å®ä¾‹ï¼Œæˆ–è€…éœ€è¦æ¯ä¸ªè¯·æ±‚/ä¼šè¯éƒ½æœ‰ç‹¬ç«‹çš„Beanå®ä¾‹ã€‚è¿™æ—¶å¯ä»¥ä½¿ç”¨Prototypeã€Requestã€Sessionæˆ–Global Sessionç­‰å…¶ä»–ä½œç”¨åŸŸ





### Beançš„çº¿ç¨‹å®‰å…¨é—®é¢˜

https://blog.csdn.net/xylitolz/article/details/123225348



åˆ†æè¿™ä¸ªé—®é¢˜è¦å…ˆçŸ¥é“ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€/æ— çŠ¶æ€çš„Beanï¼Ÿ

> JavaGuideä¸Šæ€»ç»“ï¼šæœ‰çŠ¶æ€ Bean æ˜¯æŒ‡åŒ…å«å¯å˜çš„æˆå‘˜å˜é‡çš„å¯¹è±¡ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹ç«äº‰è¯¥Beanæ—¶å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜

**"æœ‰çŠ¶æ€çš„Bean"ï¼š**æŒ‡çš„æ˜¯å…·æœ‰çŠ¶æ€æˆ–æ•°æ®çš„Beanï¼Œå®ƒä»¬åœ¨å¤šæ¬¡æ–¹æ³•è°ƒç”¨ä¹‹é—´ä¿æŒçŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„æ–¹æ³•è°ƒç”¨ä¹‹é—´å…±äº«æ•°æ®ã€‚æœ‰çŠ¶æ€çš„Beançš„çŠ¶æ€å¯ä»¥åœ¨å¤šä¸ªè¯·æ±‚æˆ–ä¼šè¯ä¹‹é—´ä¿æŒï¼Œå¯¹äºæ¯ä¸ªå®¢æˆ·ç«¯æˆ–ç”¨æˆ·æ¥è¯´ï¼Œå®ƒä»¬æ˜¯å”¯ä¸€çš„ï¼Œä¸¾ä¸€ä¸ªæœ‰çŠ¶æ€Beançš„ä¾‹å­ï¼š

```java
@Component
@Scope("prototype")
public class ShoppingCart {
    private List<Item> items = new ArrayList<>();

    public void addItem(Item item) {
        items.add(item);
    }

    public void removeItem(Item item) {
        items.remove(item);
    }

    public List<Item> getItems() {
        return items;
    }
}

```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`ShoppingCart`ç±»è¢«æ ‡è®°ä¸º`@Component`ä»¥ä½¿å…¶æˆä¸ºä¸€ä¸ªSpringç®¡ç†çš„Beanï¼Œå¹¶ä¸”`@Scope("prototype")`æŒ‡å®šäº†å…¶ä½œç”¨åŸŸä¸ºPrototypeï¼Œå³æ¯æ¬¡è·å–è¯¥Beanæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹

`ShoppingCart`ç±»ä»£è¡¨ä¸€ä¸ªè´­ç‰©è½¦ï¼Œå®ƒå…·æœ‰çŠ¶æ€ã€‚å®ƒåŒ…å«ä¸€ä¸ª`items`åˆ—è¡¨ç”¨äºå­˜å‚¨æ·»åŠ åˆ°è´­ç‰©è½¦ä¸­çš„å•†å“é¡¹

**ç”±äº`ShoppingCart`æ˜¯æœ‰çŠ¶æ€çš„Beanï¼Œæ¯ä¸ªç”¨æˆ·æˆ–å®¢æˆ·ç«¯åœ¨è·å–`ShoppingCart`å®ä¾‹æ—¶ï¼Œéƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„ã€ç‹¬ç«‹çš„è´­ç‰©è½¦å¯¹è±¡ï¼Œæ¯ä¸ªè´­ç‰©è½¦å¯¹è±¡ç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ã€‚è¿™æ ·ï¼Œæ¯ä¸ªç”¨æˆ·çš„è´­ç‰©è½¦æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬å¯ä»¥ç‹¬ç«‹åœ°æ“ä½œå’Œç®¡ç†è‡ªå·±çš„å•†å“é¡¹**



**"æ— çŠ¶æ€çš„Bean"**ï¼šåœ¨Springä¸­ï¼Œ"æ— çŠ¶æ€çš„Bean"æŒ‡çš„æ˜¯ä¸å…·æœ‰çŠ¶æ€æˆ–æ•°æ®çš„Beanï¼Œå®ƒä»¬åœ¨æ¯æ¬¡æ–¹æ³•è°ƒç”¨ä¹‹é—´ä¸ä¿æŒçŠ¶æ€ï¼Œä¸å…±äº«æ•°æ®ã€‚æ— çŠ¶æ€çš„Beançš„æ–¹æ³•è°ƒç”¨æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–äºä¹‹å‰çš„æ–¹æ³•è°ƒç”¨æˆ–å…¶ä»–è¯·æ±‚çš„çŠ¶æ€

æ— çŠ¶æ€çš„Beané€šå¸¸**ç”¨äºè¡¨ç¤ºçº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘ã€æœåŠ¡ç±»æˆ–å·¥å…·ç±»ï¼Œå®ƒä»¬ä¸éœ€è¦ç»´æŠ¤ç‰¹å®šçš„çŠ¶æ€ä¿¡æ¯**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```java
@Service
public class CalculatorService {
    public int add(int a, int b) {
        return a + b;
    }

    public int multiply(int a, int b) {
        return a * b;
    }
}
```



åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`CalculatorService`ç±»è¢«æ ‡è®°ä¸º`@Service`ä»¥ä½¿å…¶æˆä¸ºä¸€ä¸ªSpringç®¡ç†çš„Beanã€‚å®ƒæ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„Beanï¼Œç”¨äºæä¾›åŸºæœ¬çš„è®¡ç®—åŠŸèƒ½ã€‚å®ƒåŒ…å«äº†`add()`å’Œ`multiply()`æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šå—åˆ°ä¹‹å‰è°ƒç”¨çš„å½±å“ã€‚æ¯æ¬¡è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œå®ƒä»¬ä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°è¿›è¡Œè®¡ç®—ï¼Œå¹¶è¿”å›ç»“æœ

ç”±äº`CalculatorService`æ˜¯æ— çŠ¶æ€çš„Beanï¼Œæ¯ä¸ªç”¨æˆ·æˆ–å®¢æˆ·ç«¯åœ¨è·å–`CalculatorService`å®ä¾‹æ—¶ï¼Œéƒ½ä¼šå¾—åˆ°åŒä¸€ä¸ªå®ä¾‹ï¼Œå®ƒä¸ä¼šç»´æŠ¤ç‰¹å®šçš„çŠ¶æ€ä¿¡æ¯ã€‚è¿™æ ·ï¼Œ**ä¸åŒç”¨æˆ·æˆ–è¯·æ±‚ä¹‹é—´çš„`CalculatorService`å®ä¾‹æ˜¯ç‹¬ç«‹çš„ï¼Œå®ƒä»¬å¯ä»¥å¹¶å‘åœ°æ‰§è¡Œè®¡ç®—æ“ä½œè€Œä¸ä¼šç›¸äº’å¹²æ‰°**





ä¸€èˆ¬æ¥è¯´è¦æŠŠæœ‰çŠ¶æ€çš„Beanè®¾è®¡ä¸ºå¤šä¾‹ï¼ŒæŠŠæ— çŠ¶æ€çš„Beanè®¾è®¡ä¸ºå•ä¾‹

æœ‰çŠ¶æ€çš„BeanåŒ…å«çŠ¶æ€æˆ–æ•°æ®ï¼Œå¯èƒ½ä¼šåœ¨ä¸åŒçš„æ–¹æ³•è°ƒç”¨ä¹‹é—´ä¿æŒçŠ¶æ€ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦åœ¨å¤šä¸ªè¯·æ±‚æˆ–ä¼šè¯ä¹‹é—´å…±äº«æ•°æ®ã€‚å°†æœ‰çŠ¶æ€çš„Beanè®¾è®¡ä¸ºå¤šä¾‹å¯ä»¥ç¡®ä¿æ¯æ¬¡è·å–Beanæ—¶éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œé¿å…å¤šä¸ªè¯·æ±‚æˆ–ä¼šè¯ä¹‹é—´çš„çŠ¶æ€å…±äº«é—®é¢˜ã€‚

**æ— çŠ¶æ€çš„Beanä¸åŒ…å«çŠ¶æ€æˆ–æ•°æ®ï¼Œæ¯æ¬¡æ–¹æ³•è°ƒç”¨ä¹‹é—´ä¸ä¿æŒçŠ¶æ€ï¼Œä¹Ÿä¸éœ€è¦å…±äº«æ•°æ®ã€‚å°†æ— çŠ¶æ€çš„Beanè®¾è®¡ä¸ºå•ä¾‹å¯ä»¥èŠ‚çœèµ„æºï¼Œé¿å…é‡å¤åˆ›å»ºå®ä¾‹çš„å¼€é”€ï¼Œå¹¶ä¸”å¯ä»¥æ–¹ä¾¿åœ°åœ¨åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å…±äº«å’Œé‡ç”¨**





**å†å›åˆ°æœ€åˆçš„é—®é¢˜ä¸Šæ¥ï¼Œå•ä¾‹æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ**

åœ¨Springä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒBeançš„ä½œç”¨åŸŸæ˜¯Singletonï¼ˆå•ä¾‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ä¸­åªå­˜åœ¨ä¸€ä¸ªBeanå®ä¾‹ï¼Œå•ä¾‹Beanåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š

1. å•ä¸€å®ä¾‹ï¼šå•ä¾‹Beanåªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨äºå†…å­˜ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªå®ä¾‹ã€‚å› æ­¤ï¼Œä¸å­˜åœ¨å¤šä¸ªå®ä¾‹ä¹‹é—´çš„ç«æ€æ¡ä»¶æˆ–**æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜**ã€‚

2. æ— å¯å˜çŠ¶æ€ï¼šå•ä¾‹Beané€šå¸¸åº”è¯¥æ˜¯æ— çŠ¶æ€æˆ–ä¸å¯å˜çš„ï¼Œ**å®ƒä»¬ä¸ä¼šç»´æŠ¤å¯å˜çš„çŠ¶æ€ä¿¡æ¯**ï¼Œæˆ–è€…å°†çŠ¶æ€ä¿¡æ¯å°è£…åœ¨ä¸å¯å˜çš„å¯¹è±¡ä¸­ã€‚å› æ­¤ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»å–å•ä¾‹Beançš„çŠ¶æ€ï¼Œè€Œä¸ä¼šå¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

3. çº¿ç¨‹å®‰å…¨è®¾è®¡ï¼šSpringæ¡†æ¶æœ¬èº«ä¼šç¡®ä¿å•ä¾‹Beançš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œ**Springå®¹å™¨åœ¨åˆå§‹åŒ–å•ä¾‹Beanæ—¶ï¼Œä¼šå¤„ç†å¹¶å‘è®¿é—®å’ŒçŠ¶æ€åˆå§‹åŒ–çš„é—®é¢˜**ï¼Œä»¥ç¡®ä¿å•ä¾‹Beançš„æ­£ç¡®æ€§

   

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶å•ä¾‹Beanæœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†**å¦‚æœå•ä¾‹Beanä¾èµ–äºå…±äº«çš„å¯å˜èµ„æº** ä¾‹å¦‚é™æ€å˜é‡ã€å…¨å±€å˜é‡æˆ–å…±äº«çš„æ•°æ®åº“è¿æ¥ç­‰ (**ä¸‹é¢å°±æœ‰ä¸ªä¾‹å­é’ˆå¯¹å•ä¾‹ä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜**)ï¼Œä»ç„¶éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨æ€§å¹¶é‡‡å–é€‚å½“çš„å¹¶å‘æ§åˆ¶æªæ–½

æ€»ç»“è€Œè¨€ï¼Œå•ä¾‹Beanåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸€èˆ¬æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å”¯ä¸€çš„å®ä¾‹ï¼Œé€šå¸¸æ²¡æœ‰å¯å˜çš„çŠ¶æ€ï¼Œå¹¶ä¸”Springæ¡†æ¶ä¼šç¡®ä¿å…¶çº¿ç¨‹å®‰å…¨æ€§ã€‚ä½†éœ€è¦æ³¨æ„ï¼Œå¦‚æœå•ä¾‹Beanä¾èµ–äºå…±äº«çš„å¯å˜èµ„æºï¼Œä»éœ€è°¨æ…å¤„ç†å¹¶å‘è®¿é—®å’ŒçŠ¶æ€ä¿®æ”¹çš„é—®é¢˜





åœ¨Springæ¡†æ¶ä¸­ï¼Œå•ä¾‹Beançš„çº¿ç¨‹å®‰å…¨æ€§æ˜¯é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥ç¡®ä¿çš„ï¼š

1. **æ— çŠ¶æ€çš„Beanï¼š** Springé¼“åŠ±å°†å•ä¾‹Beanè®¾è®¡ä¸ºæ— çŠ¶æ€çš„ï¼Œå³ä¸åŒ…å«å®ä¾‹å˜é‡ã€‚æ— çŠ¶æ€Beanä¸ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çŠ¶æ€ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ã€‚
2. **åªè¯»æ“ä½œï¼š** å¦‚æœå•ä¾‹BeanåŒ…å«çŠ¶æ€ï¼Œä½†ä»…è¿›è¡Œåªè¯»æ“ä½œï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«Beanå®ä¾‹ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚åªè¯»æ“ä½œä¸ä¼šå¼•å‘å¹¶å‘é—®é¢˜ã€‚
3. **æ–¹æ³•å†…éƒ¨å˜é‡ï¼š** Springé€šè¿‡å°†å®ä¾‹å˜é‡å£°æ˜ä¸ºæ–¹æ³•å†…éƒ¨å˜é‡ï¼ˆæ–¹æ³•å±€éƒ¨å˜é‡ï¼‰æ¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚è¿™æ˜¯å› ä¸ºæ–¹æ³•å†…éƒ¨å˜é‡åœ¨æ ˆä¸Šåˆ†é…ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿçº¿ç¨‹ä¹‹é—´çš„å¹²æ‰°ã€‚
4. **åŒæ­¥æ§åˆ¶ï¼š** åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå¦‚æœå•ä¾‹Beançš„çŠ¶æ€éœ€è¦åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œæ‚¨å¯ä»¥åœ¨Beançš„æ–¹æ³•ä¸­ä½¿ç”¨åŒæ­¥æœºåˆ¶ï¼ˆå¦‚`synchronized`å…³é”®å­—ï¼‰æ¥ç¡®ä¿æ–¹æ³•çº§åˆ«çš„çº¿ç¨‹å®‰å…¨ã€‚
5. **ThreadLocalå˜é‡ï¼š** Springæ”¯æŒåœ¨å•ä¾‹Beanä¸­ä½¿ç”¨ThreadLocalå˜é‡ï¼Œè¿™ä½¿å¾—æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œé¿å…äº†å…±äº«çŠ¶æ€å¸¦æ¥çš„é—®é¢˜ã€‚











> å¼•ç”³:`Spring`å¦‚ä½•ä½¿ç”¨`ThreadLocal`è§£å†³å•ä¾‹ä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ

åœ¨ä½¿ç”¨Springæ—¶ï¼Œå¾ˆå¤šäººå¯èƒ½å¯¹Springä¸­ä¸ºä»€ä¹ˆDAOå’ŒServiceå¯¹è±¡é‡‡ç”¨å•å®ä¾‹æ–¹å¼å¾ˆè¿·æƒ‘ï¼Œè¿™äº›è¯»è€…æ˜¯è¿™ä¹ˆè®¤ä¸ºçš„:"DAOå¯¹è±¡å¿…é¡»åŒ…å«ä¸€ä¸ªæ•°æ®åº“çš„è¿æ¥Connectionï¼Œ**è€Œè¿™ä¸ªConnectionä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ¯ä¸ªDAOéƒ½è¦åŒ…å«ä¸€ä¸ªä¸åŒçš„Connectionå¯¹è±¡å®ä¾‹ï¼Œè¿™æ ·ä¸€æ¥DAOå¯¹è±¡å°±ä¸èƒ½æ˜¯å•å®ä¾‹çš„äº†**"

ä¸Šè¿°è§‚ç‚¹å¯¹äº†ä¸€åŠ,å¯¹çš„æ˜¯â€œæ¯ä¸ªDAOå¯¹è±¡éƒ½è¦åŒ…å«ä¸€ä¸ªä¸åŒçš„Connectionå¯¹è±¡å®ä¾‹â€è¿™å¥è¯ï¼Œé”™çš„æ˜¯â€œDAOå¯¹è±¡å°±ä¸èƒ½æ˜¯å•å®ä¾‹â€ã€‚å…¶å®Springåœ¨å®ç°Serviceå’ŒDAOå¯¹è±¡æ—¶ï¼Œä½¿ç”¨äº†`ThreadLocal`è¿™ä¸ªç±»ï¼Œè¿™ä¸ªæ˜¯ä¸€åˆ‡çš„æ ¸å¿ƒ:



ä¸€èˆ¬çš„Webåº”ç”¨åˆ’åˆ†ä¸ºå±•ç°å±‚ã€æœåŠ¡å±‚å’ŒæŒä¹…å±‚ä¸‰ä¸ªå±‚æ¬¡ï¼Œåœ¨ä¸åŒçš„å±‚ä¸­ç¼–å†™å¯¹åº”çš„é€»è¾‘ï¼Œä¸‹å±‚é€šè¿‡æ¥å£å‘ä¸Šå±‚å¼€æ”¾åŠŸèƒ½è°ƒç”¨ã€‚**åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä»æ¥æ”¶è¯·æ±‚åˆ°è¿”å›å“åº”æ‰€ç»è¿‡çš„æ‰€æœ‰ç¨‹åºè°ƒç”¨éƒ½åŒå±äºä¸€ä¸ªçº¿ç¨‹**ã€‚è¿™æ ·ä½ å°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå°†ä¸€äº›éçº¿ç¨‹å®‰å…¨çš„å˜é‡ä»¥ThreadLocalå­˜æ”¾ï¼Œåœ¨åŒä¸€æ¬¡è¯·æ±‚å“åº”çš„è°ƒç”¨çº¿ç¨‹ä¸­ï¼Œæ‰€æœ‰å…³è”çš„å¯¹è±¡å¼•ç”¨åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡
ä¸‹é¢çš„å®ä¾‹èƒ½å¤Ÿä½“ç°Springå¯¹æœ‰çŠ¶æ€Beançš„æ”¹é€ æ€è·¯ï¼š

```JAVA
public class TopicDao {
    
	//â‘ ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨çš„å˜é‡
ã€€ã€€private Connection conn;
    
	//â‘¡å¼•ç”¨éçº¿ç¨‹å®‰å…¨å˜é‡
ã€€ã€€public void addTopic() {
		Statement stat = conn.createStatement();
ã€€ã€€}
}



```

ç”±äºâ‘ å¤„çš„connæ˜¯æˆå‘˜å˜é‡ï¼Œå› ä¸ºaddTopic()æ–¹æ³•æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¿…é¡»åœ¨ä½¿ç”¨æ—¶åˆ›å»ºä¸€ä¸ªæ–°TopicDaoå®ä¾‹ï¼ˆésingletonï¼‰ã€‚ä¸‹é¢ä½¿ç”¨ThreadLocalå¯¹connè¿™ä¸ªéçº¿ç¨‹å®‰å…¨çš„çŠ¶æ€è¿›è¡Œæ”¹é€ ï¼š

```JAVA
public class TopicDao {  
    //â‘ ä½¿ç”¨ThreadLocalMapä¿å­˜Connectionå˜é‡â€”â€”connThreadLocalä¸ºMap<K,V>ä¸­çš„K
    private static ThreadLocal <Connection>connThreadLocal = newThreadLocal<Connection>();  
    public static Connection getConnection() {  
   // â‘¡å¦‚æœconnThreadLocalæ²¡æœ‰æœ¬çº¿ç¨‹å¯¹åº”çš„Connection åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„Connectionï¼Œ  
   // å¹¶å°†å…¶ä¿å­˜åˆ°çº¿ç¨‹æœ¬åœ°å˜é‡ä¸­  
       if (connThreadLocal.get() == null) {  
           Connection conn = getConnection();  
           connThreadLocal.set(conn);  
           return conn;  
       }
       // â‘¢ç›´æ¥è¿”å›çº¿ç¨‹æœ¬åœ°å˜é‡
       return connThreadLocal.get();  
    }

    public void addTopic() {  
       // â‘£ä»ThreadLocalä¸­è·å–çº¿ç¨‹å¯¹åº”çš„Connection  
       try {
           Statement stat = getConnection().createStatement();  
       } catch (SQLException e) {  
           e.printStackTrace();  
       }
    }
}

```

ä¸åŒçš„çº¿ç¨‹åœ¨ä½¿ç”¨TopicDaoæ—¶ï¼Œå…ˆåˆ¤æ–­`connThreadLocal`å¯¹åº”çš„`value`æ˜¯å¦æ˜¯nullï¼Œå¦‚æœæ˜¯nullåˆ™è¯´æ˜å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„`Connection`å¯¹è±¡ï¼Œ**è¿™æ—¶åˆ›å»ºä¸€ä¸ªConnectionå¯¹è±¡å¹¶æ·»åŠ åˆ°æœ¬åœ°çº¿ç¨‹å˜é‡ä¸­**ï¼›å¦‚æœä¸ä¸ºnullï¼Œåˆ™è¯´æ˜å½“å‰çš„çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†Connectionå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨å°±å¯ä»¥äº†ã€‚è¿™æ ·ï¼Œå°±ä¿è¯äº†ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨çº¿ç¨‹ç›¸å…³çš„Connectionï¼Œè€Œä¸ä¼šä½¿ç”¨å…¶å®ƒçº¿ç¨‹çš„Connectionã€‚å› æ­¤ï¼Œè¿™ä¸ªTopicDaoå°±å¯ä»¥åšåˆ°**singletonå…±äº«**äº†

æ€»ç»“ï¼š

`Spring`ä¸­`DAO`å’Œ`Service`éƒ½æ˜¯ä»¥å•å®ä¾‹çš„`bean`å½¢å¼å­˜åœ¨ï¼Œ**Springé€šè¿‡`ThreadLocal`ç±»å°†Beanå…·æœ‰çš„æœ‰çŠ¶æ€å˜é‡ï¼ˆä¾‹å¦‚æ•°æ®åº“è¿æ¥`Connection`ï¼‰æœ¬åœ°çº¿ç¨‹åŒ–ï¼Œä»è€Œåšåˆ°å¤šçº¿ç¨‹çŠ¶å†µä¸‹çš„å®‰å…¨**ã€‚åœ¨ä¸€æ¬¡è¯·æ±‚å“åº”çš„å¤„ç†çº¿ç¨‹ä¸­ï¼Œ è¯¥çº¿ç¨‹è´¯é€šå±•ç¤ºã€æœåŠ¡ã€æ•°æ®æŒä¹…åŒ–ä¸‰å±‚ï¼Œé€šè¿‡`ThreadLocal`ä½¿å¾—æ‰€æœ‰å…³è”çš„å¯¹è±¡å¼•ç”¨åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡









`JavaGuide`ä¸Šå¯¹äºBeanæ˜¯å¦çº¿ç¨‹å®‰å…¨çš„è¯´æ³•ï¼š

> Spring æ¡†æ¶ä¸­çš„ Bean æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Œå–å†³äºå…¶ä½œç”¨åŸŸå’ŒçŠ¶æ€ã€‚
>
> æˆ‘ä»¬è¿™é‡Œä»¥æœ€å¸¸ç”¨çš„ä¸¤ç§ä½œç”¨åŸŸ prototype å’Œ singleton ä¸ºä¾‹ä»‹ç»ã€‚å‡ ä¹æ‰€æœ‰åœºæ™¯çš„ Bean ä½œç”¨åŸŸéƒ½æ˜¯ä½¿ç”¨é»˜è®¤çš„ singleton ï¼Œé‡ç‚¹å…³æ³¨ singleton ä½œç”¨åŸŸå³å¯ã€‚
>
> prototype ä½œç”¨åŸŸä¸‹ï¼Œæ¯æ¬¡è·å–éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ bean å®ä¾‹ï¼Œä¸å­˜åœ¨èµ„æºç«äº‰é—®é¢˜ï¼Œæ‰€ä»¥ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚singleton ä½œç”¨åŸŸä¸‹ï¼ŒIoC å®¹å™¨ä¸­åªæœ‰å”¯ä¸€çš„ bean å®ä¾‹ï¼Œå¯èƒ½ä¼šå­˜åœ¨èµ„æºç«äº‰é—®é¢˜ï¼ˆå–å†³äº Bean æ˜¯å¦æœ‰çŠ¶æ€ï¼‰ã€‚å¦‚æœè¿™ä¸ª bean æ˜¯æœ‰çŠ¶æ€çš„è¯ï¼Œé‚£å°±å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆæœ‰çŠ¶æ€ Bean æ˜¯æŒ‡åŒ…å«å¯å˜çš„æˆå‘˜å˜é‡çš„å¯¹è±¡ï¼‰ã€‚
>
> ä¸è¿‡ï¼Œå¤§éƒ¨åˆ† Bean å®é™…éƒ½æ˜¯æ— çŠ¶æ€ï¼ˆæ²¡æœ‰å®šä¹‰å¯å˜çš„æˆå‘˜å˜é‡ï¼‰çš„ï¼ˆæ¯”å¦‚ Daoã€Serviceï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ Bean æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
>
> å¯¹äºæœ‰çŠ¶æ€å•ä¾‹ Bean çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¸¸è§çš„æœ‰ä¸¤ç§è§£å†³åŠæ³•ï¼š
>
> 
>
> 1. åœ¨ Bean ä¸­å°½é‡é¿å…å®šä¹‰å¯å˜çš„æˆå‘˜å˜é‡â€”â€”â€”â€”Beanå®ä¾‹çš„æˆå‘˜å±æ€§æœ€å¥½ä¸è¦æ˜¯æœ‰çŠ¶æ€çš„
> 2. åœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ª `ThreadLocal` æˆå‘˜å˜é‡ï¼Œå°†éœ€è¦çš„å¯å˜æˆå‘˜å˜é‡ä¿å­˜åœ¨ `ThreadLocal` ä¸­ï¼ˆæ¨èçš„ä¸€ç§æ–¹å¼ï¼‰
>
> 







> å°†æœ‰çŠ¶æ€çš„`bean`è®¾è®¡ä¸ºå¤šä¾‹  å’Œ ä½¿ç”¨`threadlocal`æ¥è®¾è®¡æ— çŠ¶æ€çš„beanï¼Œè¿™ä¸¤è€…åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ

æœ‰çŠ¶æ€çš„ `bean` è®¾è®¡ä¸ºå¤šä¾‹ å’Œ "ä½¿ç”¨ `ThreadLocal` æ¥è®¾è®¡æ— çŠ¶æ€çš„`bean`" éƒ½æ˜¯åœ¨ Java ä¸­å¤„ç†å¯¹è±¡å®ä¾‹çŠ¶æ€çš„æ–¹æ³•ï¼Œä½†å®ƒä»¬è§£å†³çš„é—®é¢˜å’Œåº”ç”¨åœºæ™¯ç•¥æœ‰ä¸åŒï¼š

1. **æœ‰çŠ¶æ€çš„Beanè®¾è®¡ä¸ºå¤šä¾‹ï¼š**åœ¨ Spring æ¡†æ¶ä¸­ï¼ŒBean å¯ä»¥è¢«å®šä¹‰ä¸ºå•ä¾‹æˆ–å¤šä¾‹ã€‚æœ‰çŠ¶æ€çš„ Bean æŒ‡çš„æ˜¯æ¯ä¸ªå®ä¾‹éƒ½ç»´æŠ¤ç€è‡ªå·±çš„çŠ¶æ€ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå—åˆ°å¤šä¸ªå®¢æˆ·ç«¯çš„äº¤äº’å½±å“ã€‚å¦‚æœä½ å°†æœ‰çŠ¶æ€çš„ Bean è®¾è®¡ä¸ºå¤šä¾‹ï¼Œæ„å‘³ç€æ¯æ¬¡è¯·æ±‚è¯¥ Bean çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œä¸åŒçš„å®¢æˆ·ç«¯è¯·æ±‚ä¸ä¼šå…±äº«çŠ¶æ€ã€‚è¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯ä»¥é¿å…çŠ¶æ€æ··ä¹±çš„é—®é¢˜ï¼Œä½†ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´èµ„æºæ¶ˆè€—è¾ƒå¤§
2. **ä½¿ç”¨ ThreadLocal æ¥è®¾è®¡æ— çŠ¶æ€çš„Beanï¼š** ThreadLocal æ˜¯ Java æä¾›çš„ä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œå®ƒèƒ½å¤Ÿè®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ã€‚è¿™å¯¹äºè®¾è®¡æ— çŠ¶æ€çš„ Bean å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºæ— çŠ¶æ€çš„ Bean ä¸ä¾èµ–äºç‰¹å®šçš„å®¢æˆ·ç«¯çŠ¶æ€ã€‚é€šè¿‡åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­ç»´æŠ¤ä¸€ä¸ªå‰¯æœ¬ï¼Œå¯ä»¥é¿å…å¤šçº¿ç¨‹ä¹‹é—´çš„çŠ¶æ€å¹²æ‰°ã€‚è¿™åœ¨æŸäº›æƒ…å†µä¸‹èƒ½å¤Ÿæé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†çº¿ç¨‹åŒæ­¥çš„å¼€é”€









### Beanç”Ÿå‘½å‘¨æœŸ

å¯¹äº Spring Bean çš„ç”Ÿå‘½å‘¨æœŸæ¥è¯´ï¼š

- å®ä¾‹åŒ– Instantiation
- å±æ€§èµ‹å€¼ Populate
- åˆå§‹åŒ– Initialization
- é”€æ¯ Destruction

å®ä¾‹åŒ– -> å±æ€§èµ‹å€¼ -> åˆå§‹åŒ– -> é”€æ¯



`Spring` åªå¸®æˆ‘ä»¬ç®¡ç†å•ä¾‹æ¨¡å¼ `Bean` çš„**å®Œæ•´**ç”Ÿå‘½å‘¨æœŸï¼Œå¯¹äº `prototype` çš„ `bean` ï¼Œ`Spring` åœ¨åˆ›å»ºå¥½äº¤ç»™ä½¿ç”¨è€…ä¹‹ååˆ™ä¸ä¼šå†ç®¡ç†åç»­çš„ç”Ÿå‘½å‘¨æœŸ

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/spring-framework-ioc-source-102.png)

ä¸Šå›¾ä¸ºå•ä¾‹Beançš„ç”Ÿå‘½å‘¨æœŸ(**é’ˆå¯¹çš„æ˜¯éæ‡’åŠ è½½çš„Bean**)ï¼Œæ€»ç»“ä¸ºä»¥ä¸‹å‡ æ¡ï¼š

- å¦‚æœ `BeanFactoryPostProcessor` å’Œ `Bean` å…³è”, åˆ™è°ƒç”¨`postProcessBeanFactory`æ–¹æ³•(å³é¦–**å…ˆå°è¯•ä»Beanå·¥å‚ä¸­è·å–Bean**)
- `Bean`å®¹å™¨æ‰¾åˆ°é…ç½®æ–‡ä»¶ä¸­`Bean`çš„å®šä¹‰ï¼Œè°ƒç”¨è¯¥`Bean`çš„`Construct`æ— å‚æ„é€ æ–¹æ³•**å®ä¾‹åŒ– Bean**

   åœ¨`Spring`å®¹å™¨ä¸­ï¼Œåˆ›å»º`Bean`å®ä¾‹çš„æ–¹å¼å–å†³äºä½¿ç”¨çš„å®ä¾‹åŒ–ç­–ç•¥ã€‚ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ç”¨åå°„åˆ›å»º`Bean`å®ä¾‹ï¼šå½“å®šä¹‰çš„`Bean`é€šè¿‡æ— å‚æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–æ—¶ï¼Œ`Spring`å®¹å™¨ä¼šä½¿ç”¨åå°„æœºåˆ¶æ¥åˆ›å»º`Bean`å®ä¾‹ã€‚å®ƒä¼šé€šè¿‡è°ƒç”¨`Bean`ç±»çš„æ— å‚æ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–å¯¹è±¡ã€‚è¿™ç§æ–¹å¼é€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µï¼Œå½“`Bean`çš„å®ä¾‹åŒ–è¿‡ç¨‹æ²¡æœ‰ç‰¹æ®Šè¦æ±‚æ—¶ï¼ŒSpringä¼šè‡ªåŠ¨ä½¿ç”¨åå°„æœºåˆ¶åˆ›å»ºå®ä¾‹ã€‚
2. åˆ©ç”¨Beanç±»çš„æ„é€ æ–¹æ³•åˆ›å»ºBeanå®ä¾‹ï¼šæœ‰æ—¶å€™ï¼ŒBeançš„å®ä¾‹åŒ–å¯èƒ½éœ€è¦ç‰¹æ®Šçš„å¤„ç†é€»è¾‘æˆ–ä¾èµ–æ³¨å…¥ï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡**åœ¨Beanç±»ä¸­å®šä¹‰å¸¦å‚æ•°çš„æ„é€ æ–¹æ³•æ¥å®ç°**ã€‚å½“ä½¿ç”¨æ„é€ æ–¹æ³•æ³¨å…¥æˆ–é€šè¿‡`FactoryBean`ç­‰æ–¹å¼å®ä¾‹åŒ–`Bean`æ—¶ï¼ŒSpringå®¹å™¨ä¼šè°ƒç”¨Beanç±»çš„ç‰¹å®šæ„é€ æ–¹æ³•æ¥åˆ›å»ºBeanå®ä¾‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒSpringä¼šä½¿ç”¨æŒ‡å®šçš„æ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–Beanå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åå°„æœºåˆ¶ã€‚

- åˆ©ç”¨ä¾èµ–æ³¨å…¥DI(Setterã€æ„é€ å‡½æ•°æ³¨å…¥ã€å­—æ®µæ³¨å…¥)å®Œæˆ Bean ä¸­æ‰€æœ‰**å±æ€§å€¼çš„é…ç½®æ³¨å…¥**

- **è°ƒç”¨ä¸€ç³»åˆ—xxxAwareæ¥å£** (**è®©å½“å‰Beanæ„ŸçŸ¥åˆ°å„ç§ä¸œè¥¿**) 
>è¿™é‡Œç‰¹åˆ«è¯´æ˜ä¸€ä¸‹Awareæ¥å£:**Springçš„ä¾èµ–æ³¨å…¥æœ€å¤§äº®ç‚¹å°±æ˜¯æ‰€æœ‰çš„Beanå¯¹Springå®¹å™¨çš„å­˜åœ¨æ˜¯æ²¡æœ‰æ„è¯†çš„**ã€‚ä½†æ˜¯åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æœ‰æ—¶ä¸å¯é¿å…çš„è¦ç”¨åˆ°Springå®¹å™¨æœ¬èº«æä¾›çš„èµ„æºï¼Œè¿™æ—¶å€™è¦è®© Bean **ä¸»åŠ¨æ„è¯†åˆ°Springå®¹å™¨çš„å­˜åœ¨**ï¼Œ**æ‰èƒ½è°ƒç”¨Springæ‰€æä¾›çš„èµ„æº**ï¼Œè¿™å°±æ˜¯Springçš„Awareæ¥å£ï¼Œ**Awareæ¥å£æ˜¯ä¸ªæ ‡è®°æ¥å£ï¼Œæ ‡è®°è¿™ä¸€ç±»æ¥å£æ˜¯ç”¨æ¥â€œæ„ŸçŸ¥â€å±æ€§çš„**ï¼ŒAwareçš„ä¼—å¤šå­æ¥å£åˆ™æ˜¯è¡¨å¾äº†å…·ä½“è¦â€œæ„ŸçŸ¥â€ä»€ä¹ˆå±æ€§ã€‚ä¾‹å¦‚BeanNameAwareæ¥å£ç”¨äºâ€œæ„ŸçŸ¥â€è‡ªå·±çš„åç§°ï¼ŒApplicationContextAwareæ¥å£ç”¨äºâ€œæ„ŸçŸ¥â€è‡ªå·±æ‰€å¤„çš„ä¸Šä¸‹æ–‡ã€‚å…¶å®Springçš„Awareæ¥å£æ˜¯Springè®¾è®¡ä¸ºæ¡†æ¶å†…éƒ¨ä½¿ç”¨çš„ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨ä»»ä½•Awareæ¥å£ï¼Œé™¤éæˆ‘ä»¬çœŸçš„éœ€è¦å®ƒä»¬ï¼Œå®ç°äº†è¿™äº›æ¥å£ä¼šä½¿åº”ç”¨å±‚ä»£ç è€¦åˆåˆ°Springæ¡†æ¶ä»£ç ä¸­

- ç¬¬ä¸€ç±»Awareæ¥å£
  
  - å¦‚æœ Bean å®ç°äº† `BeanNameAware` æ¥å£(ç”¨äºé€šçŸ¥ Bean å…¶åœ¨å®¹å™¨ä¸­çš„åç§°ï¼ˆå³ Bean çš„ ID æˆ–åç§°ï¼‰,å…è®¸ Bean åœ¨å®¹å™¨ä¸­æ„ŸçŸ¥è‡ªå·±çš„åç§°ï¼Œä»¥ä¾¿äºè¿›è¡Œä¸€äº›è‡ªå®šä¹‰çš„é€»è¾‘å¤„ç†)ï¼Œåˆ™ Spring è°ƒç”¨ Bean çš„ `setBeanName`() æ–¹æ³•ä¼ å…¥å½“å‰ Bean çš„ id å€¼
    - å¦‚æœ Bean å®ç°äº† `BeanClassLoaderAware` æ¥å£ï¼Œåˆ™ Spring è°ƒç”¨ `setBeanClassLoader`() æ–¹æ³•ä¼ å…¥`classLoader`çš„å¼•ç”¨åˆ°beanä¸­
    - å¦‚æœ Bean å®ç°äº† `BeanFactoryAware` æ¥å£ï¼Œåˆ™ Spring è°ƒç”¨ `setBeanFactory`() æ–¹æ³•ä¼ å…¥å½“å‰å·¥å‚å®ä¾‹çš„å¼•ç”¨åˆ°beanä¸­
  
- ç¬¬äºŒç±»Awareæ¥å£
  
  - å¦‚æœ Bean å®ç°äº† `EnvironmentAware` æ¥å£ï¼Œåˆ™ Spring è°ƒç”¨ `setEnvironment`() æ–¹æ³•ä¼ å…¥å½“å‰ `Environment` å®ä¾‹çš„å¼•ç”¨åˆ°Beanä¸­
  
  - å¦‚æœ Bean å®ç°äº† `EmbeddedValueResolverAware` æ¥å£ï¼Œåˆ™ Spring è°ƒç”¨ `setEmbeddedValueResolver`() æ–¹æ³•ä¼ å…¥å½“å‰ `StringValueResolver` å®ä¾‹çš„å¼•ç”¨åˆ°beanä¸­
  
  - å¦‚æœ Bean å®ç°äº† `ApplicationContextAware` æ¥å£ï¼Œåˆ™ `Spring` è°ƒç”¨ `setApplicationContext`() æ–¹æ³•ä¼ å…¥å½“å‰ `ApplicationContext` å®ä¾‹çš„å¼•ç”¨åˆ°beanä¸­
- å¦‚æœ `BeanPostProcessor` å’Œ Bean å…³è”ï¼Œåˆ™ Spring å°†è°ƒç”¨è¯¥æ¥å£çš„é¢„åˆå§‹åŒ–æ–¹æ³• `postProcessBeforeInitialzation`() å¯¹ Bean è¿›è¡Œ**åŠ å·¥**æ“ä½œï¼Œ(æ­¤å¤„éå¸¸é‡è¦!! **AOP å°±æ˜¯åˆ©ç”¨å®ƒå®ç°çš„**)

- å¦‚æœ Bean å®ç°äº† `InitializingBean` æ¥å£ï¼Œåˆ™ Spring å°†è°ƒç”¨ `afterPropertiesSet`() æ–¹æ³•ã€‚(æˆ–è€…æœ‰æ‰§è¡Œ@`PostConstruct`æ³¨è§£çš„æ–¹æ³•)

- å¦‚æœåœ¨Beané…ç½®æ–‡ä»¶ä¸­é€šè¿‡ **init-method** å±æ€§æŒ‡å®šäº†åˆå§‹åŒ–æ–¹æ³•ï¼Œåˆ™è°ƒç”¨è¯¥åˆå§‹åŒ–æ–¹æ³•

```xml
<bean id="myBean" class="com.example.MyBean" init-method="init"/>
```

ä¸Šè¿°é…ç½®æŒ‡å®šäº†`MyBean`ç±»çš„`init()`æ–¹æ³•ä½œä¸ºåˆå§‹åŒ–æ–¹æ³•ï¼Œåœ¨Beanå®ä¾‹åŒ–åè°ƒç”¨

```java
@Component
public class MyBean {
  //ä½¿ç”¨æ³¨è§£æ¥æ ‡æ³¨Beançš„åˆå§‹åŒ–æ–¹æ³•ã€‚é€šè¿‡åœ¨Beanç±»çš„æ–¹æ³•ä¸Šæ·»åŠ @PostConstructæ³¨è§£ï¼Œè¯¥æ–¹æ³•å°†è¢«æ ‡è¯†ä¸ºBeançš„åˆå§‹åŒ–æ–¹æ³•
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–é€»è¾‘
    }
}

```

ä¸Šè¿°ä»£ç ä½¿ç”¨`@PostConstruct`æ³¨è§£æ ‡æ³¨äº†`init()`æ–¹æ³•ï¼Œä½¿å…¶æˆä¸ºBeançš„åˆå§‹åŒ–æ–¹æ³•

- æ­¤æ—¶å¦‚æœ `BeanPostProcessor` å’Œ Bean å…³è”(ç»“åˆå‰é¢çš„)ï¼Œåˆ™ Spring å°†è°ƒç”¨è¯¥æ¥å£çš„åˆå§‹åŒ–æ–¹æ³• `postProcessAfterInitialization`()ï¼Œæ­¤æ—¶ Bean å·²ç»å¯ä»¥è¢«ç³»ç»Ÿä½¿ç”¨

- å¦‚æœåœ¨ `<bean>` ä¸­æŒ‡å®šäº†è¯¥ Bean çš„ä½œç”¨èŒƒå›´ä¸º scope="singleton"ï¼Œåˆ™å°†è¯¥ Bean æ”¾å…¥ Spring IoC çš„ç¼“å­˜æ± ä¸­ï¼Œå°†è§¦å‘ Spring å¯¹è¯¥ Bean çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼›å¦‚æœåœ¨ `<bean>` ä¸­æŒ‡å®šäº†è¯¥ Bean çš„ä½œç”¨èŒƒå›´ä¸º scope="prototype"ï¼Œåˆ™å°†è¯¥ Bean äº¤ç»™è°ƒç”¨è€…ï¼Œè°ƒç”¨è€…ç®¡ç†è¯¥ Bean çš„ç”Ÿå‘½å‘¨æœŸï¼ŒSpring ä¸å†ç®¡ç†è¯¥ Bean

- å¦‚æœ Bean å®ç°äº† DisposableBean æ¥å£ï¼Œåˆ™ Spring ä¼šè°ƒç”¨ destory() æ–¹æ³•å°† Spring ä¸­çš„ Bean é”€æ¯ï¼›(æˆ–è€…æœ‰æ‰§è¡Œ@PreDestroyæ³¨è§£çš„æ–¹æ³•)

- å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­é€šè¿‡ **destory-method** å±æ€§æŒ‡å®šäº† Bean çš„é”€æ¯æ–¹æ³•ï¼Œåˆ™ Spring å°†è°ƒç”¨è¯¥æ–¹æ³•å¯¹ Bean è¿›è¡Œé”€æ¯

  

  

  
  
  
  
  
  
  â€‹    

### Beançš„å¾ªç¯ä¾èµ–é—®é¢˜ æœªå®Œç»“:sleeping:

Beançš„å¾ªç¯ä¾èµ–é—®é¢˜æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªBeanä¹‹é—´å­˜åœ¨ç›¸äº’ä¾èµ–å…³ç³»ï¼Œå½¢æˆäº†ä¸€ä¸ªå¾ªç¯é“¾ï¼Œå¯¼è‡´**æ— æ³•æ­£ç¡®å®ä¾‹åŒ–å’Œæ³¨å…¥è¿™äº›Beançš„ä¾èµ–å…³ç³»**ã€‚ä¾‹å¦‚ï¼Œå‡è®¾Bean A ä¾èµ–äº Bean Bï¼Œè€Œ Bean B åˆä¾èµ–äº Bean Aï¼Œå®ƒä»¬ä¹‹é—´å½¢æˆäº†ä¸€ä¸ªå¾ªç¯ä¾èµ–ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å®¹å™¨å°è¯•å®ä¾‹åŒ–è¿™äº›Beanæ—¶ï¼Œä¼šé™·å…¥æ— é™å¾ªç¯ï¼Œå¯¼è‡´ç¨‹åºæ— æ³•æ­£å¸¸å¯åŠ¨æˆ–å‡ºç°æ­»é”çš„æƒ…å†µï¼Œä½“ç°åˆ°ä»£ç å±‚é¢ä¸Šæ˜¯è¿™ä¸ªæ ·å­ï¼š

```java
@Component
public class A {
    // Aä¸­æ³¨å…¥äº†B
    @Autowired
    private B b;
}
@Component
public class B {
    // Bä¸­ä¹Ÿæ³¨å…¥äº†A
    @Autowired
    private A a;
}
```







ä½†æ˜¯Springè§£å†³å¾ªç¯ä¾èµ–æ˜¯æœ‰å‰ç½®æ¡ä»¶çš„ï¼š

å‡ºç°å¾ªç¯ä¾èµ–çš„Beanåªèƒ½æ˜¯å•ä¾‹  (ä¸ºä»€ä¹ˆâ“â“)

> å¾ªç¯ä¾èµ–é—®é¢˜ä¸»è¦å­˜åœ¨äºå•ä¾‹ï¼ˆSingletonï¼‰ä½œç”¨åŸŸçš„Beanä¹‹é—´ï¼Œè€ŒåŸå‹ï¼ˆPrototypeï¼‰ä½œç”¨åŸŸçš„Beanä¸ä¼šå¼•å‘å¾ªç¯ä¾èµ–é—®é¢˜ã€‚è¿™æ˜¯å› ä¸º**å•ä¾‹Beançš„å®ä¾‹åŒ–å’Œä¾èµ–æ³¨å…¥å‘ç”Ÿåœ¨å®¹å™¨å¯åŠ¨é˜¶æ®µï¼Œè€ŒåŸå‹Beançš„å®ä¾‹åŒ–å’Œä¾èµ–æ³¨å…¥å‘ç”Ÿåœ¨æ¯æ¬¡è·å–Beanå®ä¾‹çš„æ—¶å€™**(è¿™æ ·æ¯ä¸ªBeanå®ä¾‹åŒ–çš„æ—¶é—´å°±**é”™å¼€**äº†)
>
> å½“ä¸¤ä¸ªæˆ–å¤šä¸ªå•ä¾‹Beanä¹‹é—´å­˜åœ¨ç›¸äº’ä¾èµ–å…³ç³»æ—¶ï¼Œå®ƒä»¬çš„å®ä¾‹åŒ–å’Œä¾èµ–æ³¨å…¥æ˜¯åœ¨å®¹å™¨å¯åŠ¨é˜¶æ®µåŒæ—¶è¿›è¡Œçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä¸¤ä¸ªBeanäº’ç›¸ä¾èµ–ï¼Œå®¹å™¨å°†æ— æ³•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå› ä¸ºå…¶ä¸­ä¸€ä¸ªBeançš„å®ä¾‹åŒ–éœ€è¦å¦ä¸€ä¸ªBeançš„å®ä¾‹ï¼Œè€Œå¦ä¸€ä¸ªBeançš„å®ä¾‹åŒ–åˆéœ€è¦ç¬¬ä¸€ä¸ªBeançš„å®ä¾‹ï¼Œå½¢æˆäº†ä¸€ä¸ªå¾ªç¯é“¾ï¼Œå¯¼è‡´æ— æ³•å®Œæˆä¾èµ–çš„è§£æå’Œæ³¨å…¥
>
> ä¸ºäº†è§£å†³å•ä¾‹Beanä¹‹é—´çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼ŒSpringä½¿ç”¨äº†"**æå‰æš´éœ²åŠæˆå“**"çš„æœºåˆ¶ã€‚å½“å®¹å™¨åˆ›å»ºä¸€ä¸ªå•ä¾‹Beanæ—¶ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ªåŠæˆå“çš„Beanå®ä¾‹ï¼Œå¹¶å°†å…¶æš´éœ²ç»™å…¶ä»–Beanè¿›è¡Œä¾èµ–æ³¨å…¥ã€‚ç„¶åï¼Œåœ¨ä¾èµ–æ³¨å…¥å®Œæˆåï¼Œå®¹å™¨ä¼šå›è¿‡å¤´æ¥å®ŒæˆåŠæˆå“Beanå®ä¾‹çš„åˆ›å»ºå’Œå±æ€§å¡«å……

```java
@Component
public class A {
//    @Autowired
//    private B b;
    public A(B b) {

    }
}

@Component
public class B {

//    @Autowired
//    private A a;

    public B(A a){

    }
}
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAä¸­æ³¨å…¥Bçš„æ–¹å¼æ˜¯é€šè¿‡æ„é€ å™¨ï¼ŒBä¸­æ³¨å…¥Açš„æ–¹å¼ä¹Ÿæ˜¯é€šè¿‡æ„é€ å™¨ï¼Œè¿™ä¸ªæ—¶å€™å¾ªç¯ä¾èµ–æ˜¯æ— æ³•è¢«è§£å†³ï¼Œå¦‚æœä½ çš„é¡¹ç›®ä¸­æœ‰ä¸¤ä¸ªè¿™æ ·ç›¸äº’ä¾èµ–çš„Beanï¼Œåœ¨å¯åŠ¨æ—¶å°±ä¼šæŠ¥å‡ºä»¥ä¸‹é”™è¯¯ï¼š

```java
Caused by: org.springframework.beans.factory.BeanCurrentlyInCreationException: Error creating bean with name 'a': Requested bean is currently in creation: Is there an unresolvable circular reference?
```

ä¸ºäº†æµ‹è¯•å¾ªç¯ä¾èµ–çš„è§£å†³æƒ…å†µè·Ÿæ³¨å…¥æ–¹å¼çš„å…³ç³»ï¼Œæˆ‘ä»¬åšå¦‚ä¸‹å››ç§æƒ…å†µçš„æµ‹è¯•

|        ä¾èµ–æƒ…å†µ        |                    ä¾èµ–æ³¨å…¥æ–¹å¼                    | å¾ªç¯ä¾èµ–æ˜¯å¦è¢«è§£å†³ |
| :--------------------: | :------------------------------------------------: | :----------------- |
| ABç›¸äº’ä¾èµ–ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ |                å‡é‡‡ç”¨setteræ–¹æ³•æ³¨å…¥                | æ˜¯                 |
| ABç›¸äº’ä¾èµ–ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ |                  å‡é‡‡ç”¨æ„é€ å™¨æ³¨å…¥                  | å¦                 |
| ABç›¸äº’ä¾èµ–ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ | Aä¸­æ³¨å…¥Bçš„æ–¹å¼ä¸ºsetteræ–¹æ³•ï¼ŒBä¸­æ³¨å…¥Açš„æ–¹å¼ä¸ºæ„é€ å™¨ | æ˜¯                 |
| ABç›¸äº’ä¾èµ–ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ | Bä¸­æ³¨å…¥Açš„æ–¹å¼ä¸ºsetteræ–¹æ³•ï¼ŒAä¸­æ³¨å…¥Bçš„æ–¹å¼ä¸ºæ„é€ å™¨ | å¦                 |

ä»ä¸Šé¢çš„æµ‹è¯•ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸æ˜¯åªæœ‰åœ¨setteræ–¹æ³•æ³¨å…¥çš„æƒ…å†µä¸‹å¾ªç¯ä¾èµ–æ‰èƒ½è¢«è§£å†³ï¼Œå³ä½¿å­˜åœ¨æ„é€ å™¨æ³¨å…¥çš„åœºæ™¯ä¸‹ï¼Œå¾ªç¯ä¾èµ–ä¾ç„¶è¢«å¯ä»¥è¢«æ­£å¸¸å¤„ç†æ‰



æ¥ç€æ¥çœ‹çœ‹Springå¦‚ä½•è§£å†³æœ€åŸºç¡€çš„å¾ªç¯ä¾èµ–ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬è¦çŸ¥é“**Springåœ¨åˆ›å»ºBeançš„æ—¶å€™é»˜è®¤æ˜¯æŒ‰ç…§è‡ªç„¶æ’åºæ¥è¿›è¡Œåˆ›å»ºçš„ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥Springä¼šå»åˆ›å»ºA**

åˆ›å»ºAçš„è¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯è°ƒç”¨`getBean`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸¤å±‚å«ä¹‰

1. ä»ç¼“å­˜ä¸­è·å–åˆ°å·²ç»è¢«åˆ›å»ºçš„å¯¹è±¡
2. ç¼“å­˜ä¸­æ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„Bean

æ•…é¦–å…ˆä¼šè°ƒç”¨`getSingleton(a)`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åˆä¼šè°ƒç”¨`getSingleton(beanName, true)`

```java
public Object getSingleton(String beanName) {
    return getSingleton(beanName, true);
}
```

`getSingleton(beanName, true)`è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šå°±æ˜¯åˆ°ç¼“å­˜ä¸­å°è¯•å»è·å–Beanï¼Œæ•´ä¸ªç¼“å­˜åˆ†ä¸ºä¸‰çº§

1. `singletonObjects`ï¼Œä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨çš„æ˜¯æ‰€æœ‰åˆ›å»ºå¥½äº†çš„å•ä¾‹Bean
2. `earlySingletonObjects`ï¼Œå®Œæˆå®ä¾‹åŒ–ï¼Œä½†æ˜¯è¿˜æœªè¿›è¡Œå±æ€§æ³¨å…¥åŠåˆå§‹åŒ–çš„å¯¹è±¡
3. `singletonFactories`ï¼Œæå‰æš´éœ²çš„ä¸€ä¸ªå•ä¾‹å·¥å‚ï¼ŒäºŒçº§ç¼“å­˜ä¸­å­˜å‚¨çš„å°±æ˜¯ä»è¿™ä¸ªå·¥å‚ä¸­è·å–





å½“Aå®Œæˆäº†å®ä¾‹åŒ–å¹¶æ·»åŠ è¿›äº†ä¸‰çº§ç¼“å­˜åï¼Œå°±è¦å¼€å§‹ä¸ºAè¿›è¡Œå±æ€§æ³¨å…¥äº†ï¼Œåœ¨æ³¨å…¥æ—¶å‘ç°Aä¾èµ–äº†Bï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™Springåˆä¼šå»`getBean(b)`ï¼Œç„¶ååå°„è°ƒç”¨`setter`æ–¹æ³•å®Œæˆå±æ€§æ³¨å…¥

å› ä¸ºBéœ€è¦æ³¨å…¥Aï¼Œæ‰€ä»¥åœ¨åˆ›å»ºBçš„æ—¶å€™ï¼Œåˆä¼šå»è°ƒç”¨`getBean(a)`ï¼Œè¿™ä¸ªæ—¶å€™å°±åˆå›åˆ°ä¹‹å‰çš„æµç¨‹äº†ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œä¹‹å‰çš„`getBean`æ˜¯ä¸ºäº†åˆ›å»ºBeanï¼Œè€Œæ­¤æ—¶å†è°ƒç”¨`getBean()`ä¸æ˜¯ä¸ºäº†åˆ›å»ºäº†ï¼Œè€Œæ˜¯è¦ä»ç¼“å­˜ä¸­è·å–ï¼Œå› ä¸ºä¹‹å‰Aåœ¨å®ä¾‹åŒ–åå·²ç»å°†å…¶æ”¾å…¥äº†ä¸‰çº§ç¼“å­˜`singletonFactories`ä¸­

è¿™æ ·æ³¨å…¥åˆ°Bä¸­çš„Aæ˜¯é€šè¿‡`getEarlyBeanReference`æ–¹æ³•æå‰æš´éœ²å‡ºå»çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¿˜ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„Bean,å³åœ¨åˆ›å»ºBæ—¶ä¼šæå‰ç»™Bæ³¨å…¥äº†ä¸€ä¸ªè¿˜æœªåˆå§‹åŒ–çš„Aå¯¹è±¡ï¼Œä½†æ˜¯åœ¨åˆ›å»ºAçš„æµç¨‹ä¸­ä¸€ç›´ä½¿ç”¨çš„æ˜¯æ³¨å…¥åˆ°Bä¸­çš„Aå¯¹è±¡çš„å¼•ç”¨ï¼Œä¹‹åä¼šæ ¹æ®è¿™ä¸ªå¼•ç”¨å¯¹Aè¿›è¡Œåˆå§‹åŒ–





æ€»ç»“å°±æ˜¯ï¼š

1. Aåˆ›å»ºè¿‡ç¨‹éœ€è¦Bï¼Œäºæ˜¯Aå°†è‡ªå·±æ”¾åœ¨ä¸‰çº§ç¼“å­˜ä¸­ï¼Œå»å®ä¾‹åŒ–B    
2. Bå®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦Aï¼Œäºæ˜¯Bå…ˆæŸ¥æ‰¾ä¸€çº§ç¼“å­˜ï¼Œæ²¡æœ‰ï¼Œå†æŸ¥äºŒçº§ç¼“å­˜ï¼Œè¿˜æ˜¯æ²¡æœ‰ï¼Œå†æŸ¥ä¸‰çº§ç¼“å­˜ï¼Œæœ‰äº†ï¼Œäºæ˜¯å°†ä¸‰çº§ç¼“å­˜ä¸­çš„Aæ”¾åœ¨äºŒçº§ç¼“å­˜ä¸­ï¼Œå¹¶åˆ é™¤ä¸‰çº§ç¼“å­˜ä¸­çš„A 
3. Bé¡ºåˆ©åˆå§‹åŒ–å®Œæˆåï¼Œå°†è‡ªå·±æ”¾åˆ°ä¸€çº§ç¼“å­˜ä¸­ï¼ˆæ­¤æ—¶Bä¸­çš„Aä»æ˜¯åˆ›å»ºä¸­çŠ¶æ€ï¼‰ 
4. æ­¤æ—¶è¿”å›æ¥ç»§ç»­åˆ›å»ºAï¼Œæ­¤æ—¶Bå·²ç»åˆ›å»ºç»“æŸäº†ï¼Œç›´æ¥ä»ä¸€çº§ç¼“å­˜æ‹¿åˆ°Bï¼Œç„¶åå®Œæˆåˆ›å»ºï¼Œå¹¶å°†Aæ”¾å…¥åˆ° ä¸€çº§ç¼“å­˜ä¸­ï¼ˆæ­¤æ—¶Bä¸­çš„Aå·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´å®ä¾‹ï¼Œå› ä¸ºæŒ‡å‘çš„æ˜¯å†…å­˜ä¸­çš„åŒä¸€å—åœ°æ–¹ï¼‰













ä¸ºä»€ä¹ˆ`Setter()`æ³¨å…¥å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ

- å…·ä½“æ¥è¯´ï¼Œå½“å®¹å™¨åˆ›å»ºä¸€ä¸ªBeanå®ä¾‹æ—¶ï¼Œå¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–å…³ç³»ï¼Œå®¹å™¨ä¼šå…ˆåˆ›å»ºBeançš„ä¸€ä¸ªåŠæˆå“å®ä¾‹ï¼Œå¹¶å°†å…¶æš´éœ²ç»™å…¶ä»–éœ€è¦ä¾èµ–å®ƒçš„Beanè¿›è¡Œæ³¨å…¥ã€‚åœ¨è¿›è¡Œä¾èµ–æ³¨å…¥æ—¶ï¼ŒSpringä¼šä½¿ç”¨ä»£ç†å¯¹è±¡æ¥ä»£æ›¿çœŸæ­£çš„Beanå®ä¾‹ï¼Œä»¥ç¡®ä¿å…¶ä»–Beanå¯ä»¥æ­£ç¡®åœ°å¼•ç”¨åˆ°è¯¥ä¾èµ–
- å¯¹äºSetteræ–¹æ³•æ³¨å…¥ï¼ŒSpringä¼šé¦–å…ˆåˆ›å»ºBeançš„åŠæˆå“å®ä¾‹ï¼Œå¹¶å°†å…¶æ³¨å…¥åˆ°å…¶ä»–Beanä¸­ã€‚ç„¶åï¼Œåœ¨å®Œæˆæ‰€æœ‰Beançš„åˆ›å»ºå’Œä¾èµ–æ³¨å…¥åï¼Œå®¹å™¨ä¼šå›è¿‡å¤´æ¥è°ƒç”¨ç›¸åº”çš„Setteræ–¹æ³•ï¼Œå°†çœŸæ­£çš„Beanå®ä¾‹æ³¨å…¥åˆ°å…¶ä»–Beanä¸­ã€‚è¿™æ ·ï¼Œé€šè¿‡Setteræ–¹æ³•æ³¨å…¥ï¼Œå®¹å™¨å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£å†³å¾ªç¯ä¾èµ–ï¼Œç¡®ä¿æ‰€æœ‰Beanéƒ½èƒ½æ­£ç¡®åœ°è·å–åˆ°å®ƒä»¬æ‰€ä¾èµ–çš„å…¶ä»–Beanå®ä¾‹
- éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSetteræ–¹æ³•æ³¨å…¥æ˜¯é€šè¿‡å¼•å…¥ä»£ç†å¯¹è±¡æ¥å®ç°çš„ï¼Œå› æ­¤åœ¨ä»£ç ä¸­ä½¿ç”¨Setteræ³¨å…¥æ—¶ï¼Œåº”å½“é¿å…åœ¨æ„é€ å‡½æ•°ä¸­è®¿é—®ä¾èµ–çš„Beanã€‚å› ä¸ºåœ¨æ„é€ å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¾èµ–çš„Beanå¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨åˆå§‹åŒ–





### BeanFactoryä¸FactoryBeanåŒºåˆ«



`BeanFactory`ï¼š `BeanFactory`æ˜¯Spring Frameworkä¸­çš„æ ¸å¿ƒæ¥å£ä¹‹ä¸€ï¼Œå®ƒæ˜¯`Spring`çš„IoCå®¹å™¨çš„åŸºç¡€ã€‚`BeanFactory`è´Ÿè´£åˆ›å»ºã€ç®¡ç†å’Œæä¾›åº”ç”¨ç¨‹åºä¸­çš„Beanå¯¹è±¡ã€‚å®ƒæ˜¯ä¸€ä¸ªå·¥å‚æ¨¡å¼çš„å®ç°ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†Beançš„å®ä¾‹ã€‚`BeanFactory`æ¥å£æä¾›äº†å„ç§æ–¹æ³•ï¼Œå¦‚`getBean()`æ¥è·å–Beanå®ä¾‹ã€`containsBean()`æ¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„Beanç­‰ï¼Œ`isSingleton()`æ¥åˆ¤æ–­è¯¥Beanæ˜¯å¦ä¸ºå•ä¾‹Bean

BeanFactoryçš„ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. Beançš„å®ä¾‹åŒ–ï¼šBeanFactoryè´Ÿè´£æ ¹æ®é…ç½®ä¿¡æ¯å®ä¾‹åŒ–Beanå¯¹è±¡ã€‚å®ƒå¯ä»¥é€šè¿‡XMLé…ç½®æ–‡ä»¶ã€Javaæ³¨è§£æˆ–Javaä»£ç æ¥å®šä¹‰Beançš„é…ç½®å…ƒæ•°æ®(åº•å±‚å®ä¾‹åŒ–çš„åŸç†éƒ½æ˜¯åŸºäºåå°„è·å–åˆ°Classå¯¹è±¡ï¼Œç„¶ååˆ©ç”¨ `Class` å¯¹è±¡çš„ `newInstance()` æ–¹æ³•åˆ›å»ºç±»çš„å®ä¾‹ã€‚è¿™ä¼šè°ƒç”¨ç±»çš„æ— å‚æ„é€ æ–¹æ³•æ¥å®Œæˆå®ä¾‹åŒ–ã€‚å¦‚æœç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œæˆ–è€…æ„é€ æ–¹æ³•ä¸ºç§æœ‰ï¼Œé‚£ä¹ˆå®ä¾‹åŒ–è¿‡ç¨‹ä¼šå¤±è´¥)
2. ä¾èµ–æ³¨å…¥ï¼šBeanFactoryæ”¯æŒä¾èµ–æ³¨å…¥ï¼Œå³å°†Beanæ‰€ä¾èµ–çš„å…¶ä»–Beanæ³¨å…¥åˆ°å®ƒä»¬ä¹‹ä¸­ã€‚è¿™æ ·å¯ä»¥é€šè¿‡é…ç½®çš„æ–¹å¼æ¥è§£å†³Beanä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—Beanå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–æ‰€éœ€çš„ä¾èµ–å¯¹è±¡ã€‚
3. ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šBeanFactoryç®¡ç†Beançš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬Beançš„åˆ›å»ºã€åˆå§‹åŒ–å’Œé”€æ¯è¿‡ç¨‹ã€‚å®ƒå¯ä»¥åœ¨Beanåˆ›å»ºä¹‹å‰å’Œé”€æ¯ä¹‹åæ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œï¼Œå¦‚åˆå§‹åŒ–å›è°ƒæ–¹æ³•ã€é”€æ¯å›è°ƒæ–¹æ³•ç­‰ã€‚
4. å»¶è¿Ÿåˆå§‹åŒ–ï¼šBeanFactoryæ”¯æŒå»¶è¿Ÿåˆå§‹åŒ–(`@Lazy`æ³¨è§£ã€`lazy-init`å±æ€§)ï¼Œå³åœ¨éœ€è¦ä½¿ç”¨Beanæ—¶æ‰è¿›è¡Œå®ä¾‹åŒ–ã€‚è¿™å¯ä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå†…å­˜æ•ˆç‡ï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—
5. å®¹å™¨ç®¡ç†ï¼šBeanFactoryä½œä¸ºä¸€ä¸ªIoCå®¹å™¨ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰çš„Beanå¯¹è±¡ã€‚å®ƒæä¾›äº†å„ç§æ–¹æ³•æ¥è·å–Beanå®ä¾‹ï¼Œå¦‚æŒ‰åç§°è·å–ã€æŒ‰ç±»å‹è·å–ç­‰â€”â€”â€”â€” getBean(String name)ã€ getBean(Class<T> requiredType)







`FactoryBean`ï¼š `FactoryBean`æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Beanï¼Œå®ƒæ˜¯ç”±å®ç°äº†`FactoryBean`æ¥å£çš„ç±»æ‰€åˆ›å»ºçš„ã€‚`FactoryBean`çš„ä½œç”¨æ˜¯åœ¨åˆ›å»ºBeanå®ä¾‹æ—¶æä¾›æ›´é«˜çº§çš„æ§åˆ¶å’Œå®šåˆ¶èƒ½åŠ›ã€‚é€šè¿‡è®©ä¸€ä¸ªç±»å®ç°`FactoryBean`æ¥å£ï¼Œå¼€å‘äººå‘˜å¯ä»¥åœ¨è¯¥ç±»ä¸­è‡ªå®šä¹‰å®ç°å…¶ä»–Beançš„åˆ›å»ºé€»è¾‘ï¼ŒåŒ…æ‹¬åˆ›å»ºè¿‡ç¨‹ã€åˆå§‹åŒ–å‚æ•°ã€ä¾èµ–å…³ç³»ç­‰ã€‚`FactoryBean`å¯ä»¥åˆ›å»ºéå¸¸çµæ´»çš„Beanå®ä¾‹ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå…¶ä»–Beançš„ä»£ç†

> FactoryBeanæ¥å£çš„æ ¸å¿ƒæ–¹æ³•æ˜¯`getObject()`ï¼Œå®ƒç”¨äºè¿”å›è¯¥å·¥å‚åˆ›å»ºçš„Beanå®ä¾‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒFactoryBeanæ¥å£è¿˜æä¾›äº†å…¶ä»–ä¸€äº›æ–¹æ³•ï¼Œå¦‚`getObjectType()`ç”¨äºè·å–åˆ›å»ºçš„Beançš„ç±»å‹ï¼Œ`isSingleton()`ç”¨äºæŒ‡ç¤ºåˆ›å»ºçš„Beanæ˜¯å¦æ˜¯å•ä¾‹ç­‰
>
> ```java
> T getObject() throws Exception;
> 	
> Class<?> getObjectType();
> 
> default boolean isSingleton() {
> 		return true;
> 	}
> ```
>
> 

ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„`FactoryBean`å®ç°ç±»`MyFactoryBean`ï¼Œå®ƒå¯ä»¥åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡`MyObject`(å¯¹è¯¥Beanè¿›è¡Œè‡ªå®šä¹‰)ï¼š

```java
public class MyObject {
    // ...
}

public class MyFactoryBean implements FactoryBean<MyObject> {

    public MyObject getObject() throws Exception {
        // åœ¨è¿™é‡Œè‡ªå®šä¹‰åˆ›å»ºMyObjectçš„é€»è¾‘
        MyObject myObject = new MyObject();
        // ...
        return myObject;
    }

    public Class<?> getObjectType() {
        return MyObject.class;
    }

    public boolean isSingleton() {
        return true; // è¿™é‡ŒæŒ‡å®šåˆ›å»ºçš„Beanæ˜¯å•ä¾‹çš„
    }
}
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`MyFactoryBean`å®ç°äº†`FactoryBean<MyObject>`æ¥å£ï¼Œå¹¶å®ç°äº†`getObject()`æ–¹æ³•æ¥è‡ªå®šä¹‰åˆ›å»º`MyObject`å®ä¾‹çš„é€»è¾‘ã€‚åœ¨`getObject()`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›å¤æ‚çš„æ“ä½œï¼Œå¦‚å®ä¾‹åŒ–å¯¹è±¡ã€è®¾ç½®å±æ€§ã€ä¾èµ–æ³¨å…¥ç­‰ã€‚`getObjectType()`æ–¹æ³•æŒ‡å®šäº†åˆ›å»ºçš„Beançš„ç±»å‹ä¸º`MyObject.class`ï¼Œ`isSingleton()`æ–¹æ³•æŒ‡å®šäº†åˆ›å»ºçš„Beanæ˜¯å•ä¾‹çš„å½“ä½¿ç”¨`FactoryBean`æ—¶ï¼Œéœ€è¦åœ¨Springé…ç½®æ–‡ä»¶ä¸­è¿›è¡Œç›¸åº”çš„é…ç½®ï¼š

```xml
<bean id="myObjectFactory" class="com.example.MyFactoryBean" />

<bean id="myObject" factory-bean="myObjectFactory" factory-method="getObject" />
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡`<bean>`æ ‡ç­¾é…ç½®äº†`myObject`çš„åˆ›å»ºæ–¹å¼ï¼Œä½¿ç”¨äº†`myObjectFactory`ä½œä¸º`FactoryBean`ï¼Œå¹¶æŒ‡å®šäº†`getObject`æ–¹æ³•ä½œä¸ºåˆ›å»ºå®ä¾‹çš„æ–¹æ³•

é€šè¿‡`FactoryBean`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»º`Bean`çš„è¿‡ç¨‹ä¸­è¿›è¡Œæ›´å¤šçš„å®šåˆ¶å’Œæ§åˆ¶ï¼Œä½¿å¾—Beançš„åˆ›å»ºé€»è¾‘æ›´åŠ çµæ´»å’Œè‡ªå®šä¹‰åŒ–







ChatGPTå¯¹ä¸¤è€…åŒºåˆ«çš„æ€»ç»“å¦‚ä¸‹ï¼š

1. **FactoryBeanï¼š** `FactoryBean` æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…è®¸å¼€å‘è€…åˆ›å»ºè‡ªå®šä¹‰çš„å·¥å‚ç±»ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†ç‰¹å®šç±»å‹çš„ Beanã€‚é€šè¿‡å®ç° `FactoryBean` æ¥å£ï¼Œ**ä½ å¯ä»¥åœ¨ Spring å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ªå·¥å‚ Beanï¼Œè¿™ä¸ªå·¥å‚ Bean è´Ÿè´£è¿”å›ç‰¹å®šç±»å‹çš„å®ä¾‹åŒ–å¯¹è±¡**ã€‚é€šè¿‡ä½¿ç”¨ `FactoryBean`ï¼Œä½ å¯ä»¥åœ¨å®ä¾‹åŒ– Bean çš„è¿‡ç¨‹ä¸­è¿›è¡Œä¸€äº›è‡ªå®šä¹‰é€»è¾‘ï¼Œä»è€Œå®ç°æ›´çµæ´»çš„ Bean åˆ›å»ºã€‚

   ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª `DataSource` çš„å·¥å‚ï¼Œå®ƒå¯ä»¥æ ¹æ®é…ç½®è¿”å›æ•°æ®åº“è¿æ¥æ± çš„å®ä¾‹ã€‚å½“ä½ é€šè¿‡ `getBean("dataSource")` è·å– `DataSource` Bean æ—¶ï¼Œå®é™…ä¸Šå¾—åˆ°çš„æ˜¯è¿™ä¸ªå·¥å‚æ‰€åˆ›å»ºçš„å¯¹è±¡ã€‚

2. **BeanFactoryï¼š** `BeanFactory` æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒæ¥å£ä¹‹ä¸€ï¼Œå®ƒæ˜¯ç”¨äºç®¡ç†å’Œè®¿é—® Spring å®¹å™¨ä¸­çš„å„ç§ Bean çš„æ¥å£ã€‚`BeanFactory` æä¾›äº†å„ç§æ–¹æ³•æ¥è·å–ã€åˆ›å»ºå’Œç®¡ç† Bean å®ä¾‹ã€‚å®ƒæ˜¯ Spring å®¹å™¨çš„åº•å±‚æ¥å£ï¼Œå®šä¹‰äº†è®¿é—® Bean çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŒ…æ‹¬å®ä¾‹åŒ– Beanã€ä¾èµ–æ³¨å…¥ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­‰ã€‚

   `BeanFactory` æ¥å£çš„å®ç°ç±»åŒ…æ‹¬ `ApplicationContext`ï¼Œå®ƒæ˜¯ Spring çš„ä¸€ä¸ªæ›´é«˜çº§åˆ«çš„æ¥å£ï¼Œæä¾›äº†é™¤äº† BeanFactory å¤–çš„å…¶ä»–åŠŸèƒ½ï¼Œå¦‚å›½é™…åŒ–ã€äº‹ä»¶å‘å¸ƒç­‰ã€‚

åŒºåˆ«ï¼š

- `FactoryBean` æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…è®¸ä½ è‡ªå®šä¹‰ä¸€ä¸ªå·¥å‚ï¼Œç”¨äºåˆ›å»ºç‰¹å®šç±»å‹çš„ Bean å®ä¾‹ã€‚
- `BeanFactory` æ˜¯ Spring å®¹å™¨çš„æ ¸å¿ƒæ¥å£ï¼Œç”¨äºç®¡ç†å’Œè®¿é—®å®¹å™¨ä¸­çš„å„ç§ Beanã€‚
- é€šè¿‡å®ç° `FactoryBean` æ¥å£ï¼Œä½ å¯ä»¥å®ç°è‡ªå®šä¹‰é€»è¾‘æ¥åˆ›å»º Beanï¼Œè€Œ `BeanFactory` æ˜¯æ•´ä¸ªå®¹å™¨çš„åŸºç¡€ç»“æ„ï¼Œæä¾›äº†è·å– Bean çš„åŸºæœ¬æ–¹æ³•ã€‚
- `FactoryBean` æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª Beanï¼Œå¯ä»¥åœ¨ Spring å®¹å™¨ä¸­æ³¨å†Œå’Œç®¡ç†ã€‚
- å½“ä½ ä» Spring å®¹å™¨ä¸­è·å–ä¸€ä¸ªé€šè¿‡ `FactoryBean` åˆ›å»ºçš„ Bean æ—¶ï¼Œå®é™…ä¸Šè·å–çš„æ˜¯å·¥å‚è¿”å›çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å·¥å‚æœ¬èº«ã€‚





## AOP

OOPé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œé’ˆå¯¹ä¸šåŠ¡å¤„ç†è¿‡ç¨‹çš„å®ä½“åŠå…¶å±æ€§å’Œè¡Œä¸ºè¿›è¡ŒæŠ½è±¡å°è£…ï¼Œä»¥è·å¾—æ›´åŠ æ¸…æ™°é«˜æ•ˆçš„é€»è¾‘å•å…ƒåˆ’åˆ†ã€‚è€ŒAOPåˆ™æ˜¯é’ˆå¯¹ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„åˆ‡é¢è¿›è¡Œæå–ï¼Œå®ƒæ‰€é¢å¯¹çš„æ˜¯å¤„ç†è¿‡ç¨‹çš„æŸä¸ªæ­¥éª¤æˆ–é˜¶æ®µ

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/spring-framework-aop-2.png)

AOP(Aspect-Oriented Programming:é¢å‘åˆ‡é¢ç¼–ç¨‹)èƒ½å¤Ÿå°†é‚£äº›**ä¸ä¸šåŠ¡æ— å…³ï¼Œå´ä¸ºä¸šåŠ¡æ¨¡å—æ‰€å…±åŒè°ƒç”¨**çš„é€»è¾‘æˆ–è´£ä»»ï¼ˆä¾‹å¦‚äº‹åŠ¡å¤„ç†ã€**æ—¥å¿—ç®¡ç†ã€æƒé™æ§åˆ¶**ç­‰ï¼‰å°è£…èµ·æ¥ï¼Œä¾¿äºå‡å°‘ç³»ç»Ÿçš„é‡å¤ä»£ç ï¼Œé™ä½æ¨¡å—é—´çš„è€¦åˆåº¦





### AOPæœ¯è¯­



**è¿æ¥ç‚¹ï¼ˆJointpointï¼‰**ï¼šè¡¨ç¤ºéœ€è¦åœ¨ç¨‹åºä¸­æ’å…¥æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ‰©å±•ç‚¹ï¼Œ**è¿æ¥ç‚¹å¯èƒ½æ˜¯ç±»åˆå§‹åŒ–ã€æ–¹æ³•æ‰§è¡Œã€æ–¹æ³•è°ƒç”¨ã€å­—æ®µè°ƒç”¨æˆ–å¤„ç†å¼‚å¸¸ç­‰ç­‰**ï¼ŒSpringåªæ”¯æŒæ–¹æ³•æ‰§è¡Œè¿æ¥ç‚¹ï¼Œåœ¨AOPä¸­è¡¨ç¤ºä¸º**åœ¨å“ªé‡Œå¹²**ï¼›

**åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰**ï¼š é€‰æ‹©ä¸€ç»„ç›¸å…³è¿æ¥ç‚¹çš„æ¨¡å¼ï¼Œå³å¯ä»¥è®¤ä¸ºè¿æ¥ç‚¹çš„é›†åˆï¼ŒSpringæ”¯æŒperl5æ­£åˆ™è¡¨è¾¾å¼å’ŒAspectJåˆ‡å…¥ç‚¹æ¨¡å¼ï¼ŒSpringé»˜è®¤ä½¿ç”¨AspectJè¯­æ³•ï¼Œåœ¨AOPä¸­è¡¨ç¤ºä¸º**åœ¨å“ªé‡Œå¹²çš„é›†åˆ**ï¼›

**é€šçŸ¥ï¼ˆAdviceï¼‰**ï¼šåœ¨è¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„è¡Œä¸ºï¼Œé€šçŸ¥æä¾›äº†åœ¨AOPä¸­éœ€è¦åœ¨åˆ‡å…¥ç‚¹æ‰€é€‰æ‹©çš„è¿æ¥ç‚¹å¤„è¿›è¡Œæ‰©å±•ç°æœ‰è¡Œä¸ºçš„æ‰‹æ®µï¼›åŒ…æ‹¬å‰ç½®é€šçŸ¥ï¼ˆbefore adviceï¼‰ã€åç½®é€šçŸ¥(after advice)ã€ç¯ç»•é€šçŸ¥ï¼ˆaround adviceï¼‰ï¼Œåœ¨Springä¸­é€šè¿‡ä»£ç†æ¨¡å¼å®ç°AOPï¼Œå¹¶é€šè¿‡æ‹¦æˆªå™¨æ¨¡å¼ä»¥ç¯ç»•è¿æ¥ç‚¹çš„æ‹¦æˆªå™¨é“¾ç»‡å…¥é€šçŸ¥ï¼›åœ¨AOPä¸­è¡¨ç¤ºä¸º**å¹²ä»€ä¹ˆ**ï¼›

**æ–¹é¢/åˆ‡é¢ï¼ˆAspectï¼‰**ï¼šæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–ï¼Œæ¯”å¦‚ä¸Šè¾¹æåˆ°çš„æ—¥å¿—ç»„ä»¶ã€‚å¯ä»¥è®¤ä¸ºæ˜¯é€šçŸ¥ã€å¼•å…¥å’Œåˆ‡å…¥ç‚¹çš„ç»„åˆï¼›åœ¨Springä¸­å¯ä»¥ä½¿ç”¨Schemaå’Œ@AspectJæ–¹å¼è¿›è¡Œç»„ç»‡å®ç°ï¼›åœ¨AOPä¸­è¡¨ç¤ºä¸º**åœ¨å“ªå¹²å’Œå¹²ä»€ä¹ˆé›†åˆ**ï¼›

**å¼•å…¥ï¼ˆinter-type declarationï¼‰**ï¼šä¹Ÿç§°ä¸ºå†…éƒ¨ç±»å‹å£°æ˜ï¼Œä¸ºå·²æœ‰çš„ç±»æ·»åŠ é¢å¤–æ–°çš„å­—æ®µæˆ–æ–¹æ³•ï¼ŒSpringå…è®¸å¼•å…¥æ–°çš„æ¥å£ï¼ˆå¿…é¡»å¯¹åº”ä¸€ä¸ªå®ç°ï¼‰åˆ°æ‰€æœ‰è¢«ä»£ç†å¯¹è±¡ï¼ˆç›®æ ‡å¯¹è±¡ï¼‰, åœ¨AOPä¸­è¡¨ç¤ºä¸º**å¹²ä»€ä¹ˆï¼ˆå¼•å…¥ä»€ä¹ˆï¼‰**ï¼›

**ç›®æ ‡å¯¹è±¡ï¼ˆTarget Objectï¼‰**ï¼šéœ€è¦è¢«ç»‡å…¥æ¨ªåˆ‡å…³æ³¨ç‚¹çš„å¯¹è±¡ï¼Œå³è¯¥å¯¹è±¡æ˜¯åˆ‡å…¥ç‚¹é€‰æ‹©çš„å¯¹è±¡ï¼Œéœ€è¦è¢«é€šçŸ¥çš„å¯¹è±¡ï¼Œä»è€Œä¹Ÿå¯ç§°ä¸ºè¢«é€šçŸ¥å¯¹è±¡ï¼›ç”±äºSpring AOP é€šè¿‡ä»£ç†æ¨¡å¼å®ç°ï¼Œä»è€Œè¿™ä¸ªå¯¹è±¡æ°¸è¿œæ˜¯è¢«ä»£ç†å¯¹è±¡ï¼Œåœ¨AOPä¸­è¡¨ç¤ºä¸º**å¯¹è°å¹²**ï¼›

**ç»‡å…¥ï¼ˆWeavingï¼‰**ï¼šæŠŠåˆ‡é¢è¿æ¥åˆ°å…¶å®ƒçš„åº”ç”¨ç¨‹åºç±»å‹æˆ–è€…å¯¹è±¡ä¸Šï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè¢«é€šçŸ¥çš„å¯¹è±¡ã€‚è¿™äº›å¯ä»¥åœ¨ç¼–è¯‘æ—¶ï¼ˆä¾‹å¦‚ä½¿ç”¨AspectJç¼–è¯‘å™¨ï¼‰ï¼Œç±»åŠ è½½æ—¶å’Œè¿è¡Œæ—¶å®Œæˆã€‚Springå’Œå…¶ä»–çº¯Java AOPæ¡†æ¶ä¸€æ ·ï¼Œåœ¨è¿è¡Œæ—¶å®Œæˆç»‡å…¥ã€‚åœ¨AOPä¸­è¡¨ç¤ºä¸º**æ€ä¹ˆå®ç°çš„**ï¼›

**AOPä»£ç†ï¼ˆAOP Proxyï¼‰**ï¼šAOPæ¡†æ¶ä½¿ç”¨ä»£ç†æ¨¡å¼åˆ›å»ºçš„å¯¹è±¡ï¼Œä»è€Œå®ç°åœ¨è¿æ¥ç‚¹å¤„æ’å…¥é€šçŸ¥ï¼ˆå³åº”ç”¨åˆ‡é¢ï¼‰ï¼Œå°±æ˜¯é€šè¿‡ä»£ç†æ¥å¯¹ç›®æ ‡å¯¹è±¡åº”ç”¨åˆ‡é¢ã€‚åœ¨Springä¸­ï¼ŒAOPä»£ç†å¯ä»¥ç”¨JDKåŠ¨æ€ä»£ç†æˆ–CGLIBä»£ç†å®ç°ï¼Œè€Œé€šè¿‡æ‹¦æˆªå™¨æ¨¡å‹åº”ç”¨åˆ‡é¢ã€‚åœ¨AOPä¸­è¡¨ç¤ºä¸º**æ€ä¹ˆå®ç°çš„ä¸€ç§å…¸å‹æ–¹å¼**ï¼›



> **é€šçŸ¥ç±»å‹**ï¼š

- **å‰ç½®é€šçŸ¥ï¼ˆBefore adviceï¼‰**ï¼šåœ¨æŸè¿æ¥ç‚¹ä¹‹å‰æ‰§è¡Œçš„é€šçŸ¥ï¼Œä½†è¿™ä¸ªé€šçŸ¥ä¸èƒ½é˜»æ­¢è¿æ¥ç‚¹ä¹‹å‰çš„æ‰§è¡Œæµç¨‹ï¼ˆé™¤éå®ƒæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼‰
- **åç½®é€šçŸ¥ï¼ˆAfter returning adviceï¼‰**ï¼šåœ¨æŸè¿æ¥ç‚¹æ­£å¸¸å®Œæˆåæ‰§è¡Œçš„é€šçŸ¥ï¼šä¾‹å¦‚ï¼Œä¸€ä¸ªæ–¹æ³•æ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œæ­£å¸¸è¿”å›
- **å¼‚å¸¸é€šçŸ¥ï¼ˆAfter throwing adviceï¼‰**ï¼šåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸é€€å‡ºæ—¶æ‰§è¡Œçš„é€šçŸ¥
- **æœ€ç»ˆé€šçŸ¥ï¼ˆAfter (finally) adviceï¼‰**ï¼šå½“æŸè¿æ¥ç‚¹é€€å‡ºçš„æ—¶å€™æ‰§è¡Œçš„é€šçŸ¥ï¼ˆä¸è®ºæ˜¯æ­£å¸¸è¿”å›è¿˜æ˜¯å¼‚å¸¸é€€å‡ºï¼‰
- **ç¯ç»•é€šçŸ¥ï¼ˆAround Adviceï¼‰**ï¼šåŒ…å›´ä¸€ä¸ªè¿æ¥ç‚¹çš„é€šçŸ¥ï¼Œå¦‚æ–¹æ³•è°ƒç”¨ã€‚è¿™æ˜¯æœ€å¼ºå¤§çš„ä¸€ç§é€šçŸ¥ç±»å‹ã€‚ç¯ç»•é€šçŸ¥å¯ä»¥åœ¨æ–¹æ³•è°ƒç”¨å‰åå®Œæˆè‡ªå®šä¹‰çš„è¡Œä¸ºã€‚å®ƒä¹Ÿä¼šé€‰æ‹©æ˜¯å¦ç»§ç»­æ‰§è¡Œè¿æ¥ç‚¹æˆ–ç›´æ¥è¿”å›å®ƒè‡ªå·±çš„è¿”å›å€¼æˆ–æŠ›å‡ºå¼‚å¸¸æ¥ç»“æŸæ‰§è¡Œ

ç¯ç»•é€šçŸ¥æ˜¯æœ€å¸¸ç”¨çš„é€šçŸ¥ç±»å‹ã€‚å’ŒAspectJä¸€æ ·ï¼ŒSpringæä¾›æ‰€æœ‰ç±»å‹çš„é€šçŸ¥ï¼Œæˆ‘ä»¬æ¨èä½ ä½¿ç”¨å°½å¯èƒ½ç®€å•çš„é€šçŸ¥ç±»å‹æ¥å®ç°éœ€è¦çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œ**å¦‚æœä½ åªæ˜¯éœ€è¦ä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼æ¥æ›´æ–°ç¼“å­˜ï¼Œæœ€å¥½ä½¿ç”¨åç½®é€šçŸ¥è€Œä¸æ˜¯ç¯ç»•é€šçŸ¥**ï¼Œå°½ç®¡ç¯ç»•é€šçŸ¥ä¹Ÿèƒ½å®ŒæˆåŒæ ·çš„äº‹æƒ…



æˆ‘ä»¬æŠŠè¿™äº›æœ¯è¯­ä¸²è”åˆ°ä¸€èµ·ï¼Œæ–¹ä¾¿ç†è§£ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/spring-framework-aop-3.png)









### AspectJ

AspectJæ˜¯ä¸€ä¸ªjavaå®ç°çš„AOPæ¡†æ¶ï¼Œå®ƒèƒ½å¤Ÿå¯¹javaä»£ç è¿›è¡ŒAOPç¼–è¯‘ï¼ˆä¸€èˆ¬åœ¨ç¼–è¯‘æœŸè¿›è¡Œï¼‰ï¼Œè®©javaä»£ç å…·æœ‰AspectJçš„AOPåŠŸèƒ½ï¼ˆå½“ç„¶éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨ï¼‰

- AspectJæ˜¯æ›´å¼ºçš„AOPæ¡†æ¶ï¼Œæ˜¯å®é™…æ„ä¹‰çš„**AOPæ ‡å‡†**ï¼›
- Springä¸ºä½•ä¸å†™ç±»ä¼¼AspectJçš„æ¡†æ¶ï¼Ÿ Spring AOPä½¿ç”¨çº¯Javaå®ç°, å®ƒä¸éœ€è¦ä¸“é—¨çš„ç¼–è¯‘è¿‡ç¨‹, å®ƒä¸€ä¸ª**é‡è¦çš„åŸåˆ™å°±æ˜¯æ— ä¾µå…¥æ€§ï¼ˆnon-invasivenessï¼‰**; Spring å°ç»„å®Œå…¨æœ‰èƒ½åŠ›å†™ç±»ä¼¼çš„æ¡†æ¶ï¼Œåªæ˜¯Spring AOPä»æ¥æ²¡æœ‰æ‰“ç®—é€šè¿‡æä¾›ä¸€ç§å…¨é¢çš„AOPè§£å†³æ–¹æ¡ˆæ¥ä¸AspectJç«äº‰ã€‚Springçš„å¼€å‘å°ç»„ç›¸ä¿¡æ— è®ºæ˜¯åŸºäºä»£ç†ï¼ˆproxy-basedï¼‰çš„æ¡†æ¶å¦‚Spring AOPæˆ–è€…æ˜¯æˆç†Ÿçš„æ¡†æ¶å¦‚AspectJéƒ½æ˜¯å¾ˆæœ‰ä»·å€¼çš„ï¼Œä»–ä»¬ä¹‹é—´åº”è¯¥æ˜¯**äº’è¡¥è€Œä¸æ˜¯ç«äº‰çš„å…³ç³»**
- Springå°ç»„å–œæ¬¢@AspectJæ³¨è§£é£æ ¼æ›´èƒœäºSpring XMLé…ç½®ï¼› æ‰€ä»¥**åœ¨Spring 2.0ä½¿ç”¨äº†å’ŒAspectJ 5ä¸€æ ·çš„æ³¨è§£ï¼Œå¹¶ä½¿ç”¨AspectJæ¥åšåˆ‡å…¥ç‚¹è§£æå’ŒåŒ¹é…**ã€‚**ä½†æ˜¯ï¼ŒAOPåœ¨è¿è¡Œæ—¶ä»æ—§æ˜¯çº¯çš„Spring AOPï¼Œå¹¶ä¸ä¾èµ–äºAspectJçš„ç¼–è¯‘å™¨æˆ–è€…ç»‡å…¥å™¨ï¼ˆweaverï¼‰**
- Spring 2.5å¯¹AspectJçš„æ”¯æŒï¼šåœ¨ä¸€äº›ç¯å¢ƒä¸‹ï¼Œå¢åŠ äº†å¯¹AspectJçš„è£…è½½æ—¶ç¼–ç»‡æ”¯æŒï¼ŒåŒæ—¶æä¾›äº†ä¸€ä¸ªæ–°çš„beanåˆ‡å…¥ç‚¹



äº†è§£AspectJåº”ç”¨åˆ°javaä»£ç çš„è¿‡ç¨‹ï¼ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**ç»‡å…¥**ï¼‰ï¼Œå¯¹äºç»‡å…¥è¿™ä¸ªæ¦‚å¿µï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºaspect(åˆ‡é¢)åº”ç”¨åˆ°ç›®æ ‡å‡½æ•°(ç±»)çš„è¿‡ç¨‹ã€‚å¯¹äºè¿™ä¸ªè¿‡ç¨‹ï¼Œä¸€èˆ¬åˆ†ä¸º**åŠ¨æ€ç»‡å…¥**å’Œ**é™æ€ç»‡å…¥**ï¼š

1. åŠ¨æ€ç»‡å…¥çš„æ–¹å¼æ˜¯åœ¨**è¿è¡Œæ—¶åŠ¨æ€å°†è¦å¢å¼ºçš„ä»£ç ç»‡å…¥åˆ°ç›®æ ‡ç±»**ä¸­ï¼Œè¿™æ ·å¾€å¾€æ˜¯é€šè¿‡åŠ¨æ€ä»£ç†æŠ€æœ¯å®Œæˆçš„ï¼Œå¦‚Java JDKçš„åŠ¨æ€ä»£ç†(Proxyï¼Œåº•å±‚é€šè¿‡åå°„å®ç°)æˆ–è€…CGLIBçš„åŠ¨æ€ä»£ç†(åº•å±‚é€šè¿‡ç»§æ‰¿å®ç°)ï¼ŒSpring AOPé‡‡ç”¨çš„å°±æ˜¯åŸºäºè¿è¡Œæ—¶å¢å¼ºçš„ä»£ç†æŠ€æœ¯
2. ApectJé‡‡ç”¨çš„å°±æ˜¯é™æ€ç»‡å…¥çš„æ–¹å¼ã€‚ApectJä¸»è¦é‡‡ç”¨çš„æ˜¯**ç¼–è¯‘æœŸç»‡å…¥**ï¼Œ**åœ¨è¿™ä¸ªæœŸé—´ä½¿ç”¨AspectJçš„acjç¼–è¯‘å™¨(ç±»ä¼¼javac)æŠŠaspectç±»ç¼–è¯‘æˆclasså­—èŠ‚ç åï¼Œåœ¨javaç›®æ ‡ç±»ç¼–è¯‘æ—¶ç»‡å…¥ï¼Œå³å…ˆç¼–è¯‘aspectç±»å†ç¼–è¯‘ç›®æ ‡ç±»**

   ![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/spring-framework-aop-6.png)



æ³¨æ„ï¼šä¸åŸºäºä»£ç†çš„Spring AOPä¸åŒï¼Œä½¿ç”¨`AspectJ`æ—¶ä¸éœ€è¦ä½¿ç”¨`@EnableAspectJAutoProxy`æ³¨è§£æ¥å¯ç”¨AOPã€‚`AspectJ`ä¼šåœ¨è¿è¡Œæ—¶é€šè¿‡ç¼–è¯‘æ—¶ç»‡å…¥æˆ–åŠ è½½æ—¶ç»‡å…¥çš„æ–¹å¼è‡ªåŠ¨ç»‡å…¥åˆ‡é¢

### Aopé…ç½®æ–¹å¼

åœ¨Spring AOPä¸­ï¼Œæœ‰ä¸¤ç§ä¸»è¦çš„é…ç½®æ–¹å¼ï¼š

1. åŸºäºXMLçš„é…ç½®æ–¹å¼ï¼šè¿™æ˜¯ä¸€ç§ä¼ ç»Ÿçš„é…ç½®æ–¹å¼ï¼Œä½¿ç”¨XMLæ–‡ä»¶å®šä¹‰åˆ‡é¢ã€åˆ‡ç‚¹å’Œé€šçŸ¥ç­‰å…ƒç´ 
2. åŸºäº@AspectJæ³¨è§£çš„é…ç½®æ–¹å¼(å¸¸ç”¨)

å¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼ŒSpring AOPå°†ä½¿ç”¨åŸºäºæ¥å£çš„ä»£ç†ï¼›å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼ŒSpring AOPå°†ä½¿ç”¨CGLIBæ¥åˆ›å»ºåŸºäºç±»çš„ä»£ç†



>  é‚£ä¹ˆ**å¦‚ä½•å£°æ˜ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Ÿ**

æ³¨æ„`pointcut`åˆ‡å…¥ç‚¹çš„å£°æ˜è§„åˆ™æœ‰å¤šç§ï¼š

(1)ä½¿ç”¨`@Pointcut`ç›´æ¥å£°æ˜åˆ‡å…¥ç‚¹ï¼š è¿™æ ·å¥½å¤„æ˜¯å¯ä»¥åœ¨å¤šä¸ªé€šçŸ¥ä¸­å…±äº«åŒä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œé¿å…äº†ä»£ç çš„é‡å¤ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿä½¿åˆ‡é¢ç±»çš„ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œç†è§£

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.annotation.Before;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class LoggingAspect {
    
    @Pointcut("execution(public * com.example.MyService.*(..))")
    public void myPointcut() {}
    
    @Before("myPointcut()")
    public void beforeAdvice() {
        System.out.println("Before advice: Logging before method execution");
    }
}

```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`@Pointcut`æ³¨è§£å£°æ˜äº†ä¸€ä¸ªåä¸º`myPointcut()`çš„åˆ‡å…¥ç‚¹ï¼Œå®ƒåŒ¹é…äº†`com.example.MyService`ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚

ç„¶åï¼Œåœ¨`@Before`æ³¨è§£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`myPointcut()`æ¥å¼•ç”¨è¿™ä¸ªåˆ‡å…¥ç‚¹ï¼Œå¹¶å°†å…¶ä½œä¸ºåˆ‡é¢çš„é€šçŸ¥





(2)ç›´æ¥ä½¿ç”¨`execution`å‚æ•°æ¥å®šä¹‰åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼š

```java
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.springframework.stereotype.Component;

@Aspect
@Component
public class LoggingAspect {

    @Before("execution(public * com.example.MyService.*(..)) && execution(public void com.example.MyService.someMethod())")
    public void beforeAdvice() {
        System.out.println("Before advice: Logging before method execution");
    }
}
```

ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨`@Before`æ³¨è§£ä¸­ä½¿ç”¨`execution`å‚æ•°æ¥å®šä¹‰åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ã€‚åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„è¯­æ³•å’Œè§„åˆ™ä¸ä¹‹å‰ç›¸åŒï¼Œé€šè¿‡`execution`å…³é”®å­—æŒ‡å®šåŒ¹é…çš„æ–¹æ³•



#### jdkåŠ¨æ€ä»£ç†

ç¤ºä¾‹1 æ¥å£å­ç±»ä½¿ç”¨JDKä»£ç†ï¼š

- å®šä¹‰æ¥å£

```java
/**
 * Jdk Proxy Service.
 *
 * @author pdai
 */
public interface IJdkProxyService {

    void doMethod1();

    String doMethod2();

    String doMethod3() throws Exception;
}
```

- å®ç°ç±»

```java
/**
 * @author pdai
 */
@Service
public class JdkProxyDemoServiceImpl implements IJdkProxyService {

    @Override
    public void doMethod1() {
        System.out.println("JdkProxyServiceImpl.doMethod1()");
    }

    @Override
    public String doMethod2() {
        System.out.println("JdkProxyServiceImpl.doMethod2()");
        return "hello world";
    }

    @Override
    public String doMethod3() throws Exception {
        System.out.println("JdkProxyServiceImpl.doMethod3()");
        throw new Exception("some exception");
    }
}
```

- **å®šä¹‰åˆ‡é¢**

```java
package tech.pdai.springframework.aspect;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.AfterThrowing;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.context.annotation.EnableAspectJAutoProxy;
import org.springframework.stereotype.Component;

//ç¡®ä¿åœ¨Springé…ç½®ä¸­å¯ç”¨äº†AspectJè‡ªåŠ¨ä»£ç†ï¼Œä»¥ä¾¿è®©Springè¯†åˆ«å’Œåº”ç”¨è¿™äº›åˆ‡é¢
@EnableAspectJAutoProxy
@Component
@Aspect
public class LogAspect {

    /**
     * define point cut. åˆ‡å…¥ç‚¹(è¿æ¥ç‚¹çš„é›†åˆ)â€”â€”åœ¨å“ªé‡Œç»‡å…¥é€šçŸ¥(å¤šç±»å‹)
     */
    @Pointcut("execution(* tech.pdai.springframework.service.*.*(..))")
    private void pointCutMethod() {
     //pointCutMethod() æ–¹æ³•å®é™…ä¸Šè¢«ç”¨ä½œä¸€ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„å ä½ç¬¦
    }


    /**
     * ç¯ç»•é€šçŸ¥
     *
     * @param pjp pjp
     * @return obj
     * @throws Throwable exception
     */
    @Around("pointCutMethod()")
    public Object doAround(ProceedingJoinPoint pjp) throws Throwable {
        System.out.println("-----------------------");
        System.out.println("ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•");
        Object o = pjp.proceed();
        System.out.println("ç¯ç»•é€šçŸ¥: é€€å‡ºæ–¹æ³•");
        return o;
    }

    /**
     * å‰ç½®é€šçŸ¥
     *doBefore()æ–¹æ³•æ˜¯ä¸€ä¸ªå‰ç½®é€šçŸ¥ï¼Œä½¿ç”¨@Beforeæ³¨è§£æ ‡è®°
     *å®ƒç»‘å®šäº†åˆ‡å…¥ç‚¹pointCutMethod()ï¼Œè¡¨ç¤ºåœ¨åˆ‡å…¥ç‚¹å¤„æ‰§è¡Œå‰ç½®é€šçŸ¥é€»è¾‘
     *
     */
    @Before("pointCutMethod()")
    public void doBefore() {
        System.out.println("å‰ç½®é€šçŸ¥");
    }


    /**
     * åç½®é€šçŸ¥
     *
     * @param result return val
     */
    @AfterReturning(pointcut = "pointCutMethod()", returning = "result")
    public void doAfterReturning(String result) {
        System.out.println("åç½®é€šçŸ¥, è¿”å›å€¼: " + result);
    }

    /**
     * å¼‚å¸¸é€šçŸ¥
     *
     * @param e exception
     */
    @AfterThrowing(pointcut = "pointCutMethod()", throwing = "e")
    public void doAfterThrowing(Exception e) {
        System.out.println("å¼‚å¸¸é€šçŸ¥, å¼‚å¸¸: " + e.getMessage());
    }

    /**
     * æœ€ç»ˆé€šçŸ¥
     */
    @After("pointCutMethod()")
    public void doAfter() {
        System.out.println("æœ€ç»ˆé€šçŸ¥");
    }

}
```



- **è¾“å‡º**

```java
-----------------------
ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•
å‰ç½®é€šçŸ¥
JdkProxyServiceImpl.doMethod1()
æœ€ç»ˆé€šçŸ¥
ç¯ç»•é€šçŸ¥: é€€å‡ºæ–¹æ³•
-----------------------
ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•
å‰ç½®é€šçŸ¥
JdkProxyServiceImpl.doMethod2()
åç½®é€šçŸ¥, è¿”å›å€¼: hello world
æœ€ç»ˆé€šçŸ¥
ç¯ç»•é€šçŸ¥: é€€å‡ºæ–¹æ³•
-----------------------
ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•
å‰ç½®é€šçŸ¥
JdkProxyServiceImpl.doMethod3()
å¼‚å¸¸é€šçŸ¥, å¼‚å¸¸: some exception
æœ€ç»ˆé€šçŸ¥
```



å½“ç„¶ä¹Ÿå¯ä»¥ä¸æŒ‡æ˜`@pointcut`å®ç°AOPä»£ç†ï¼š

```java
public interface MyServiceInterface {
    void doSomething();
}

public class MyService implements MyServiceInterface {
    public void doSomething() {
        System.out.println("Doing something...");
    }
}

@Aspect
@Component
public class LoggingAspect {
    @Before("execution(* com.example.MyServiceInterface.doSomething())")
    public void beforeAdvice() {
        System.out.println("Before advice");
    }
}

```

ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ`MyService`ç±»å®ç°äº†`MyServiceInterface`æ¥å£ï¼Œå¹¶å®šä¹‰äº†ä¸€ä¸ª`doSomething()`æ–¹æ³•ã€‚`LoggingAspect`åˆ‡é¢çš„åˆ‡ç‚¹è¡¨è¾¾å¼åŒ¹é…äº†`MyServiceInterface`æ¥å£ä¸­çš„`doSomething()`æ–¹æ³•







#### CglibåŠ¨æ€ä»£ç†

ç¤ºä¾‹2 éæ¥å£å­ç±»ä½¿ç”¨Cglibä»£ç†ï¼š

- **ç±»å®šä¹‰**

```java
/**
 * Cglib proxy.
 *
 * @author pdai
 */
@Service
public class CglibProxyDemoServiceImpl {

    public void doMethod1() {
        System.out.println("CglibProxyDemoServiceImpl.doMethod1()");
    }

    public String doMethod2() {
        System.out.println("CglibProxyDemoServiceImpl.doMethod2()");
        return "hello world";
    }

    public String doMethod3() throws Exception {
        System.out.println("CglibProxyDemoServiceImpl.doMethod3()");
        throw new Exception("some exception");
    }
}
```

- **åˆ‡é¢å®šä¹‰**

å’Œä¸Šé¢ç›¸åŒ

- **è¾“å‡º**

```java
-----------------------
ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•
å‰ç½®é€šçŸ¥
CglibProxyDemoServiceImpl.doMethod1()
æœ€ç»ˆé€šçŸ¥
ç¯ç»•é€šçŸ¥: é€€å‡ºæ–¹æ³•
-----------------------
ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•
å‰ç½®é€šçŸ¥
CglibProxyDemoServiceImpl.doMethod2()
åç½®é€šçŸ¥, è¿”å›å€¼: hello world
æœ€ç»ˆé€šçŸ¥
ç¯ç»•é€šçŸ¥: é€€å‡ºæ–¹æ³•
-----------------------
ç¯ç»•é€šçŸ¥: è¿›å…¥æ–¹æ³•
å‰ç½®é€šçŸ¥
CglibProxyDemoServiceImpl.doMethod3()
å¼‚å¸¸é€šçŸ¥, å¼‚å¸¸: some exception
æœ€ç»ˆé€šçŸ¥
```





### AOPåº”ç”¨



**1ã€ `Mybatis` ä¸­çš„åˆ†é¡µæ‹¦æˆªå™¨**

```java
@Configuration
@MapperScan("com.xuecheng.content.mapper")
public class MybatisPlusConfig {

    //å®šä¹‰åˆ†é¡µçš„æ‹¦æˆªå™¨
    @Bean
    public MybatisPlusInterceptor getMybatisPlusInterceptor(){
        MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();
        mybatisPlusInterceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return mybatisPlusInterceptor;
    }
}
```

ä¸‹é¢æ˜¯åˆ†æ Mybatis-Plus åˆ†é¡µæ’ä»¶çš„ç®€è¦å·¥ä½œåŸç†ï¼š

1. **åˆ›å»ºåˆ†é¡µæ‹¦æˆªå™¨ï¼š** åœ¨ä½ çš„ä»£ç ä¸­ï¼Œé€šè¿‡åˆ›å»º `MybatisPlusInterceptor` å¯¹è±¡ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª `PaginationInnerInterceptor` å¯¹è±¡ä½œä¸ºå†…éƒ¨æ‹¦æˆªå™¨ï¼Œç”¨äºå¤„ç†åˆ†é¡µé€»è¾‘ã€‚
2. **æ‹¦æˆª SQL æ‰§è¡Œï¼š** `PaginationInnerInterceptor` ä¼šæ‹¦æˆªæ‰§è¡Œçš„ SQL è¯­å¥ï¼Œç„¶ååœ¨æ‰§è¡Œå‰å¯¹ SQL è¿›è¡Œæ”¹é€ ï¼Œæ·»åŠ åˆ†é¡µé€»è¾‘ã€‚
3. **å¤„ç†åˆ†é¡µé€»è¾‘ï¼š** åˆ†é¡µæ‹¦æˆªå™¨ä¼šæ ¹æ®ä¼ å…¥çš„åˆ†é¡µå‚æ•°ï¼ˆå¦‚é¡µç ã€æ¯é¡µæ¡æ•°ï¼‰æ¥ä¿®æ”¹ SQL è¯­å¥ï¼Œæ·»åŠ  LIMIT å­å¥ï¼ˆåœ¨ MySQL ä¸­ï¼‰æˆ–ç±»ä¼¼çš„åˆ†é¡µé™åˆ¶æ¡ä»¶ï¼Œä»è€ŒåªæŸ¥è¯¢ç¬¦åˆåˆ†é¡µæ¡ä»¶çš„æ•°æ®ã€‚
4. **æ‰§è¡Œ SQL æŸ¥è¯¢ï¼š** ä¿®æ”¹åçš„ SQL è¯­å¥ä¼šè¢«ä¼ é€’ç»™åº•å±‚æ•°æ®åº“ï¼Œæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œè¿”å›åˆ†é¡µåçš„ç»“æœæ•°æ®ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMybatis-Plus åˆ†é¡µæ’ä»¶çš„å·¥ä½œåŸç†ç±»ä¼¼äº AOPï¼Œå®ƒåœ¨æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢å‰ï¼Œå°†åˆ†é¡µé€»è¾‘ç»‡å…¥åˆ°åŸå§‹çš„ SQL æŸ¥è¯¢è¯­å¥ä¸­ï¼Œä»è€Œå®ç°äº†åˆ†é¡µåŠŸèƒ½ã€‚è¿™ä½¿å¾—å¼€å‘è€…å¯ä»¥åœ¨æŸ¥è¯¢æ–¹æ³•ä¸­ä¸éœ€è¦ç¼–å†™åˆ†é¡µé€»è¾‘ï¼Œè€Œæ˜¯é€šè¿‡é…ç½®æ‹¦æˆªå™¨æ¥å®ç°åˆ†é¡µã€‚



ä¾‹å¦‚æƒ³è¦å®ç°æŸ¥è¯¢å­¦ç”Ÿè¯¾ç¨‹çš„åˆ†é¡µï¼Œè®¾ç½®æ¯é¡µæ˜¾ç¤º 10 æ¡æ•°æ®ã€‚å‡è®¾ä½ æœ‰ä¸€ä¸ª `StudentCourseMapper` æ¥å£ç”¨äºæŸ¥è¯¢å­¦ç”Ÿè¯¾ç¨‹ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹çš„ä»£ç æ¼”ç¤ºï¼š

1ã€å®šä¹‰Mapperæ¥å£ï¼š

```java
// StudentCourseMapper.java
@Mapper
public interface StudentCourseMapper extends BaseMapper<StudentCourse> {
    List<StudentCourse> getStudentCourses();
}
```



2ã€**ç¼–å†™æŸ¥è¯¢æ–¹æ³•ï¼š**

```java
// StudentCourseService.java
@Service
public class StudentCourseService {

@Autowired
private StudentCourseMapper studentCourseMapper;

public Page<StudentCourse> getStudentCoursesWithPagination(int currentPage) {
Page<StudentCourse> page = new Page<>(currentPage, 10); // æ¯é¡µæ˜¾ç¤º 10 æ¡æ•°æ®
studentCourseMapper.selectPage(page, null); // ç¬¬äºŒä¸ªå‚æ•°ä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œè¿™é‡Œè®¾ä¸º null è¡¨ç¤ºä¸è®¾ç½®æ¡ä»¶
return page;
}
}
```



3ã€é…ç½® **MyBatis-Plus åˆ†é¡µæ’ä»¶ï¼š**

```java
// MybatisPlusConfig.java
@Configuration
@MapperScan("com.xuecheng.content.mapper")
public class MybatisPlusConfig {

    @Bean
    public MybatisPlusInterceptor getMybatisPlusInterceptor() {
        MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();
        mybatisPlusInterceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return mybatisPlusInterceptor;
    }
}
```



åœ¨ MyBatis-Plus ä¸­ï¼Œåˆ†é¡µæ‹¦æˆªå™¨çš„é…ç½®å·²ç»åœ¨ `MybatisPlusConfig` ç±»ä¸­å®Œæˆäº†ï¼Œä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªåˆ†é¡µæ‹¦æˆªå™¨çš„ Beanï¼Œå¹¶ä¸”å°†å…¶æ·»åŠ åˆ°äº† `MybatisPlusInterceptor` ä¸­ã€‚è¿™ä¸ªæ‹¦æˆªå™¨ä¼šè‡ªåŠ¨åœ°åœ¨æŸ¥è¯¢è¯­å¥æ‰§è¡Œå‰ï¼Œæ ¹æ®åˆ†é¡µå‚æ•°æ¥ä¿®æ”¹ SQL è¯­å¥ï¼Œä»è€Œå®ç°äº†åˆ†é¡µåŠŸèƒ½ã€‚

åœ¨ `getStudentCoursesWithPagination` æ–¹æ³•ä¸­ï¼Œä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ª MyBatis-Plus çš„ `Page` å¯¹è±¡ï¼Œ**å¹¶ä¼ å…¥å½“å‰é¡µç å’Œæ¯é¡µæ˜¾ç¤ºæ¡æ•°**ã€‚ç„¶åï¼Œé€šè¿‡è°ƒç”¨ `selectPage` æ–¹æ³•ï¼ŒMyBatis-Plus æ¡†æ¶ä¼šè‡ªåŠ¨è¯†åˆ«åˆ†é¡µå‚æ•°å¹¶åº”ç”¨åˆ†é¡µæ‹¦æˆªå™¨ï¼Œä»¥æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢ã€‚

æ‰€ä»¥ï¼Œè™½ç„¶ä½ åœ¨ `getStudentCoursesWithPagination` æ–¹æ³•ä¸­æ²¡æœ‰ç›´æ¥çœ‹åˆ°åˆ†é¡µæ‹¦æˆªå™¨çš„é…ç½®ï¼Œä½†è¿™æ˜¯å› ä¸º MyBatis-Plus åœ¨èƒŒåå·²ç»åšäº†è¿™ä¸ªå·¥ä½œã€‚è¿™å°±æ˜¯ MyBatis-Plus åˆ†é¡µæ’ä»¶çš„æ–¹ä¾¿ä¹‹å¤„ï¼Œå®ƒå°†åˆ†é¡µé€»è¾‘çš„å¤„ç†ä»ä½ çš„ä¸šåŠ¡ä»£ç ä¸­è§£è€¦å‡ºæ¥ï¼Œä½¿ä½ åªéœ€è¦å…³æ³¨åˆ†é¡µå‚æ•°å’ŒæŸ¥è¯¢ç»“æœã€‚	







## SpringMVC

### æ‰§è¡Œæµç¨‹

MVCæ¶æ„ç”¨ä¸€ç§ä¸šåŠ¡é€»è¾‘ã€æ•°æ®ã€ç•Œé¢æ˜¾ç¤ºåˆ†ç¦»çš„æ–¹æ³•ï¼Œå°†ä¸šåŠ¡é€»è¾‘èšé›†åˆ°ä¸€ä¸ªéƒ¨ä»¶é‡Œé¢ï¼Œåœ¨æ”¹è¿›å’Œä¸ªæ€§åŒ–å®šåˆ¶ç•Œé¢åŠç”¨æˆ·äº¤äº’çš„åŒæ—¶ï¼Œä¸éœ€è¦é‡æ–°ç¼–å†™ä¸šåŠ¡é€»è¾‘



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/spring-springframework-mvc-4.png" style="zoom:67%;" />

- **Model**ï¼ˆæ¨¡å‹ï¼‰æ˜¯åº”ç”¨ç¨‹åºä¸­ç”¨äºå¤„ç†åº”ç”¨ç¨‹åºæ•°æ®é€»è¾‘çš„éƒ¨åˆ†ã€‚é€šå¸¸**æ¨¡å‹å¯¹è±¡è´Ÿè´£åœ¨æ•°æ®åº“ä¸­å­˜å–æ•°æ®**
- **View**ï¼ˆè§†å›¾ï¼‰æ˜¯åº”ç”¨ç¨‹åºä¸­å¤„ç†æ•°æ®æ˜¾ç¤ºçš„éƒ¨åˆ†ã€‚é€šå¸¸è§†å›¾æ˜¯ä¾æ®æ¨¡å‹æ•°æ®åˆ›å»ºçš„
- **Controller**ï¼ˆæ§åˆ¶å™¨ï¼‰æ˜¯åº”ç”¨ç¨‹åºä¸­å¤„ç†ç”¨æˆ·äº¤äº’çš„éƒ¨åˆ†ã€‚é€šå¸¸æ§åˆ¶å™¨è´Ÿè´£ä»è§†å›¾è¯»å–æ•°æ®ï¼Œæ§åˆ¶ç”¨æˆ·è¾“å…¥ï¼Œå¹¶å‘æ¨¡å‹å‘é€æ•°æ®



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mvcspring.png)

è®°ä½äº†ä¸‹é¢è¿™äº›ç»„ä»¶ï¼Œä¹Ÿå°±è®°ä½äº† SpringMVC çš„å·¥ä½œåŸç†

- **`DispatcherServlet`**ï¼š**æ ¸å¿ƒçš„ä¸­å¤®å¤„ç†å™¨**ï¼Œè´Ÿè´£æ¥æ”¶è¯·æ±‚ã€åˆ†å‘ï¼Œå¹¶ç»™äºˆå®¢æˆ·ç«¯å“åº”ã€‚
- **`HandlerMapping`**ï¼š**å¤„ç†å™¨æ˜ å°„å™¨**ï¼Œæ ¹æ® uri å»åŒ¹é…æŸ¥æ‰¾èƒ½å¤„ç†çš„ `Handler` ï¼Œå¹¶ä¼šå°†è¯·æ±‚æ¶‰åŠåˆ°çš„æ‹¦æˆªå™¨å’Œ `Handler` ä¸€èµ·å°è£…ã€‚
- **`HandlerAdapter`**ï¼š**å¤„ç†å™¨é€‚é…å™¨**ï¼Œæ ¹æ® `HandlerMapping` æ‰¾åˆ°çš„ `Handler` ï¼Œé€‚é…æ‰§è¡Œå¯¹åº”çš„ `Handler`ï¼›
- **`Handler`**ï¼š**è¯·æ±‚å¤„ç†å™¨**ï¼Œå¤„ç†å®é™…è¯·æ±‚çš„å¤„ç†å™¨ã€‚
- **`ViewResolver`**ï¼š**è§†å›¾è§£æå™¨**ï¼Œæ ¹æ® `Handler` è¿”å›çš„é€»è¾‘è§†å›¾ / è§†å›¾ï¼Œè§£æå¹¶æ¸²æŸ“çœŸæ­£çš„è§†å›¾ï¼Œå¹¶ä¼ é€’ç»™ `DispatcherServlet` å“åº”å®¢æˆ·ç«¯



SpringMvcæµç¨‹å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å‘é€httpè¯·æ±‚ï¼Œ`DispatcherServlet`è´Ÿè´£æ‹¦æˆªå‘æ¥çš„è¯·æ±‚
2. `DispatcherServlet`æ˜¯Spring MVCçš„æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œå®ƒä½œä¸ºå‰ç«¯æ§åˆ¶å™¨æ¥æ”¶æ‰€æœ‰çš„HTTPè¯·æ±‚ã€‚å½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œ`DispatcherServlet`è´Ÿè´£å¤„ç†è¯·æ±‚å¹¶å°†å…¶è·¯ç”±åˆ°é€‚å½“çš„å¤„ç†å™¨
3. `DispatcherServlet` æ ¹æ®è¯·æ±‚ä¿¡æ¯è°ƒç”¨ `HandlerMapping`ï¼Œ`HandlerMapping` æ ¹æ®è¯·æ±‚çš„URLè·¯å¾„å’Œå…¶ä»–æ¡ä»¶ï¼ˆå¦‚è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚å‚æ•°ç­‰ï¼‰ç¡®å®šåº”è¯¥ç”±å“ªä¸ªå¤„ç†å™¨ï¼ˆ`Controller`ï¼‰æ¥å¤„ç†è¯·æ±‚ï¼Œå¤„ç†å™¨æ˜ å°„å™¨ç»´æŠ¤ä¸€ä¸ªå¤„ç†å™¨æ˜ å°„è¡¨ï¼Œå°†è¯·æ±‚æ˜ å°„åˆ°ç›¸åº”çš„å¤„ç†å™¨
4. å¤„ç†å™¨é€‚é…å™¨`HandlerAdapter`è´Ÿè´£è°ƒç”¨é€‰å®šçš„å¤„ç†å™¨çš„å¤„ç†æ–¹æ³•`Handler`ï¼Œå¹¶å¤„ç†å¤„ç†æ–¹æ³•çš„è¿”å›å€¼,éšåè¿”å›ä¸€ä¸ª `ModelAndView` å¯¹è±¡ç»™`DispatcherServlet`ï¼Œ`ModelAndView`é¡¾åæ€ä¹‰ï¼šåŒ…å«äº†æ•°æ®æ¨¡å‹ä»¥åŠç›¸åº”çš„è§†å›¾çš„ä¿¡æ¯ã€‚`Model` æ˜¯è¿”å›çš„æ•°æ®å¯¹è±¡ï¼Œ`View` æ˜¯ä¸ªé€»è¾‘ä¸Šçš„ `View`
5. è§†å›¾è§£æå™¨`ViewResolver`å°†**é€»è¾‘è§†å›¾åç§°è§£æä¸ºå®é™…çš„è§†å›¾å¯¹è±¡**ã€‚å®ƒæ ¹æ®é…ç½®è§„åˆ™æŸ¥æ‰¾è§†å›¾èµ„æºï¼Œå¹¶å°†å…¶ä¸æ¨¡å‹æ•°æ®è¿›è¡Œç»“åˆï¼Œç”Ÿæˆæœ€ç»ˆçš„è§†å›¾å“åº”`View`
6. ä¸Šæ­¥ç”Ÿæˆçš„æœ€ç»ˆè§†å›¾å“åº”`View`è´Ÿè´£å°†æ¨¡å‹æ•°æ®`Model`æ¸²æŸ“åˆ°æœ€ç»ˆçš„è¾“å‡ºæ ¼å¼ï¼Œå¦‚HTMLã€XMLæˆ–JSONã€‚è§†å›¾é€šå¸¸ä½¿ç”¨æ¨¡æ¿å¼•æ“ï¼ˆå¦‚`Thymeleaf`ã€`FreeMarker`ï¼‰æˆ–å…¶ä»–æŠ€æœ¯æ¥ç”ŸæˆåŠ¨æ€å†…å®¹
7. è§†å›¾å“åº”è¢«å‘é€å›å®¢æˆ·ç«¯ï¼Œæˆä¸ºHTTPå“åº”ã€‚å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰å°†æ˜¾ç¤ºæœ€ç»ˆçš„å“åº”å†…å®¹







### æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº







### æºç å‰–æ









## Springä¸‰çº§ç¼“å­˜





## Springæ¡†æ¶ä¸­çš„è®¾è®¡æ¨¡å¼ :astonished:



### å·¥å‚æ¨¡å¼

### å•ä¾‹æ¨¡å¼



### **ä»£ç†æ¨¡å¼**

Spring AOPé€šè¿‡åŠ¨æ€ä»£ç†å®ç°ä»£ç†æ¨¡å¼ï¼Œä¸»è¦æœ‰ä¸¤ç§ä»£ç†æ–¹å¼ï¼šåŸºäºæ¥å£çš„ä»£ç†ï¼ˆJDKåŠ¨æ€ä»£ç†ï¼‰å’ŒåŸºäºç±»çš„ä»£ç†ï¼ˆCGLIBåŠ¨æ€ä»£ç†ï¼‰ã€‚

1. åŸºäºæ¥å£çš„ä»£ç†ï¼ˆJDKåŠ¨æ€ä»£ç†ï¼‰ï¼š å½“ç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£æ—¶ï¼ŒSpring AOPä¼šä½¿ç”¨JDKåŠ¨æ€ä»£ç†æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚JDKåŠ¨æ€ä»£ç†è¦æ±‚ç›®æ ‡å¯¹è±¡å®ç°æ¥å£ï¼Œå¹¶ä¸”é€šè¿‡åå°„æœºåˆ¶åŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªå®ç°äº†ç›¸åŒæ¥å£çš„ä»£ç†å¯¹è±¡ã€‚ä»£ç†å¯¹è±¡æ‹¦æˆªç›®æ ‡å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œå¹¶åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ‰§è¡Œåˆ‡é¢é€»è¾‘ã€‚
2. åŸºäºç±»çš„ä»£ç†ï¼ˆCGLIBåŠ¨æ€ä»£ç†ï¼‰ï¼š å½“ç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£æ—¶ï¼ŒSpring AOPä¼šä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚CGLIBï¼ˆCode Generation Libraryï¼‰æ˜¯ä¸€ä¸ªåŸºäºå­—èŠ‚ç ç”Ÿæˆçš„ç±»åº“ï¼Œå®ƒå¯ä»¥åŠ¨æ€åœ°ç”Ÿæˆç›®æ ‡å¯¹è±¡çš„å­ç±»ä½œä¸ºä»£ç†å¯¹è±¡ã€‚ä»£ç†å¯¹è±¡ç»§æ‰¿è‡ªç›®æ ‡å¯¹è±¡ï¼Œæ‹¦æˆªç›®æ ‡å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œå¹¶åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ‰§è¡Œåˆ‡é¢é€»è¾‘ã€‚

æ— è®ºæ˜¯JDKåŠ¨æ€ä»£ç†è¿˜æ˜¯CGLIBåŠ¨æ€ä»£ç†ï¼Œä»£ç†å¯¹è±¡éƒ½å®ç°äº†ä¸ç›®æ ‡å¯¹è±¡ç›¸åŒçš„æ¥å£æˆ–ç»§æ‰¿äº†ç›®æ ‡å¯¹è±¡çš„ç±»ï¼Œä½¿å¾—ä»£ç†å¯¹è±¡å¯ä»¥æ›¿ä»£åŸå§‹å¯¹è±¡ä½¿ç”¨ã€‚åœ¨æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä»£ç†å¯¹è±¡ä¼šæ‹¦æˆªæ–¹æ³•çš„æ‰§è¡Œï¼Œæ ¹æ®é…ç½®çš„åˆ‡é¢é€»è¾‘æ‰§è¡Œç›¸åº”çš„é€šçŸ¥ï¼ˆå¦‚å‰ç½®é€šçŸ¥ã€åç½®é€šçŸ¥ã€ç¯ç»•é€šçŸ¥ç­‰ï¼‰ã€‚



### æ¨¡æ¿æ¨¡å¼





### **è§‚å¯Ÿè€…æ¨¡å¼**



åœ¨Springæ¡†æ¶ä¸­ï¼Œè§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰è¢«å¹¿æ³›åº”ç”¨äºäº‹ä»¶é©±åŠ¨çš„ç¼–ç¨‹æ¨¡å‹ï¼Œä»¥å®ç°è§£è€¦å’Œäº‹ä»¶é€šçŸ¥çš„åŠŸèƒ½,æ¯”å¦‚æˆ‘ä»¬æ¯æ¬¡æ·»åŠ å•†å“çš„æ—¶å€™éƒ½éœ€è¦é‡æ–°æ›´æ–°å•†å“ç´¢å¼•ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åˆ©ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜

**Spring äº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸­çš„ä¸‰ç§è§’è‰²**:

1ã€äº‹ä»¶è§’è‰²`ApplicationEvent` 

`ApplicationEvent` (`org.springframework.context`åŒ…ä¸‹)å……å½“äº‹ä»¶çš„è§’è‰²,è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿`ApplicationEvent`å¹¶å®šä¹‰è‡ªå·±çš„äº‹ä»¶ç±»ï¼Œæ¥è¡¨ç¤ºç‰¹å®šçš„äº‹ä»¶

```java
public class CustomEvent extends ApplicationEvent {
    // è‡ªå®šä¹‰äº‹ä»¶çš„æ„é€ å‡½æ•°å’Œæ–¹æ³•
    // ...
}
```



2ã€äº‹ä»¶ç›‘å¬è€…è§’è‰²`ApplicationListener`

å®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå®šä¹‰äº‹ä»¶ç›‘å¬å™¨ã€‚å¼€å‘äººå‘˜å¯ä»¥å®ç°`ApplicationListener`æ¥å£æ¥åˆ›å»ºè‡ªå®šä¹‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œå¹¶åœ¨ç›‘å¬å™¨(`onApplicationEvent`)ä¸­å¤„ç†ç‰¹å®šçš„äº‹ä»¶

```java
public class CustomEventListener implements ApplicationListener<CustomEvent> {
    @Override
    public void onApplicationEvent(CustomEvent event) {
        // å¤„ç†è‡ªå®šä¹‰äº‹ä»¶çš„é€»è¾‘
    }
}
```



3ã€äº‹ä»¶å‘å¸ƒè€…è§’è‰² `ApplicationEventPublisher` 

å……å½“äº†äº‹ä»¶çš„å‘å¸ƒè€…ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£,`ApplicationContext`å®ç°äº†è¯¥æ¥å£ï¼Œæ•…è¯¥ç±»ä¹Ÿæ˜¯ä¸€ä¸ªå‘å¸ƒè€…è§’è‰²ï¼Œé€šè¿‡`ApplicationContext`çš„`publishEvent()`æ–¹æ³•æ¥å‘å¸ƒäº‹ä»¶ã€‚**å½“å‘å¸ƒäº‹ä»¶æ—¶ï¼Œ`ApplicationContext`ä¼šé€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å™¨ï¼Œå¹¶å°†äº‹ä»¶ä¼ é€’ç»™ç›¸åº”çš„ç›‘å¬å™¨è¿›è¡Œå¤„ç†(ç¬¬äºŒæ­¥ä¸­çš„)**:

```java
ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
CustomEvent customEvent = new CustomEvent("Custom Event"); //åˆ›é€ äº‹ä»¶
applicationContext.publishEvent(customEvent);//äº‹ä»¶å‘å¸ƒè€…å°†äº‹ä»¶å‘å¸ƒé€šçŸ¥ç»™äº‹ä»¶ç›‘å¬è€…
```





Spring çš„äº‹ä»¶æµç¨‹æ€»ç»“

1. å®šä¹‰ä¸€ä¸ªäº‹ä»¶: å®ç°ä¸€ä¸ªç»§æ‰¿è‡ª `ApplicationEvent`ï¼Œå¹¶ä¸”å†™ç›¸åº”çš„æ„é€ å‡½æ•°ï¼›
2. å®šä¹‰ä¸€ä¸ªäº‹ä»¶ç›‘å¬è€…ï¼šå®ç° `ApplicationListener` æ¥å£ï¼Œé‡å†™ `onApplicationEvent()` æ–¹æ³•ï¼›
3. ä½¿ç”¨äº‹ä»¶å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯: å¯ä»¥é€šè¿‡ `ApplicationEventPublisher` çš„ `publishEvent()` æ–¹æ³•å‘å¸ƒæ¶ˆæ¯





### **é€‚é…å™¨æ¨¡å¼**

åœ¨ Spring MVC ä¸­ï¼Œ`DispatcherServlet` æ ¹æ®è¯·æ±‚ä¿¡æ¯è°ƒç”¨ `HandlerMapping`ï¼Œè§£æè¯·æ±‚å¯¹åº”çš„ `Handler`ã€‚è§£æåˆ°å¯¹åº”çš„ `Handler`ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸è¯´çš„ `Controller` æ§åˆ¶å™¨ï¼‰åï¼Œå¼€å§‹ç”±`HandlerAdapter` é€‚é…å™¨å¤„ç†ã€‚`HandlerAdapter` ä½œä¸ºæœŸæœ›æ¥å£ï¼Œå…·ä½“çš„é€‚é…å™¨å®ç°ç±»ç”¨äºå¯¹ç›®æ ‡ç±»è¿›è¡Œé€‚é…ï¼Œ`Controller` ä½œä¸ºè¢«é€‚é…çš„ç±»

**ä¸ºä»€ä¹ˆè¦åœ¨ Spring MVC ä¸­ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Ÿ**

Spring MVC ä¸­çš„ `Controller` ç§ç±»ä¼—å¤šï¼Œä¸åŒç±»å‹çš„ `Controller` é€šè¿‡ä¸åŒçš„æ–¹æ³•æ¥å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚å¦‚æœä¸åˆ©ç”¨é€‚é…å™¨æ¨¡å¼çš„è¯ï¼Œ`DispatcherServlet` ç›´æ¥è·å–å¯¹åº”ç±»å‹çš„ `Controller`ï¼Œéœ€è¦çš„è‡ªè¡Œæ¥åˆ¤æ–­ï¼Œåƒä¸‹é¢è¿™æ®µä»£ç ä¸€æ ·ï¼š

```java
if(mappedHandler.getHandler() instanceof MultiActionController){
   ((MultiActionController)mappedHandler.getHandler()).xxx
}else if(mappedHandler.getHandler() instanceof XXX){
    ...
}else if(...){
   ...
}
```





## Springäº‹åŠ¡

Spring æ”¯æŒä¸¤ç§æ–¹å¼çš„äº‹åŠ¡ç®¡ç†

### ç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†

é€šè¿‡ `TransactionTemplate`æˆ–è€…`TransactionManager`æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡ï¼Œå®é™…åº”ç”¨ä¸­å¾ˆå°‘ä½¿ç”¨

ä½¿ç”¨`TransactionTemplate` è¿›è¡Œç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Autowired
private TransactionTemplate transactionTemplate;
public void testTransaction() {

        transactionTemplate.execute(new TransactionCallbackWithoutResult() {
            @Override
            protected void doInTransactionWithoutResult(TransactionStatus transactionStatus) {

                try {

                    // ....  ä¸šåŠ¡ä»£ç 
                } catch (Exception e){
                    //å‡ºç°å¼‚å¸¸æ—¶éœ€è¦å›æ»š
                    transactionStatus.setRollbackOnly();
                }

            }
        });
}

```

ä½¿ç”¨ `TransactionManager` è¿›è¡Œç¼–ç¨‹å¼äº‹åŠ¡ç®¡ç†çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Autowired
private PlatformTransactionManager transactionManager;

public void testTransaction() {
  TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());
          try {
               // ....  ä¸šåŠ¡ä»£ç 
              transactionManager.commit(status);
          } catch (Exception e) {
              transactionManager.rollback(status);
          }
}
```

åœ¨ç¼–ç¨‹å¼äº‹åŠ¡ä¸­ï¼Œå¿…é¡»åœ¨æ¯ä¸ªä¸šåŠ¡æ“ä½œä¸­åŒ…å«é¢å¤–çš„äº‹åŠ¡ç®¡ç†ä»£ç ï¼Œå¯¼è‡´ä»£ç çœ‹èµ·æ¥éå¸¸çš„è‡ƒè‚¿





### å£°æ˜å¼äº‹åŠ¡ç®¡ç†  :sunglasses:

æ¨èä½¿ç”¨ï¼ˆä»£ç ä¾µå…¥æ€§æœ€å°ï¼‰ï¼Œå®é™…æ˜¯é€šè¿‡ AOP å®ç°ï¼ˆåŸºäº`@Transactional` çš„å…¨æ³¨è§£æ–¹å¼ä½¿ç”¨æœ€å¤šï¼‰ã€‚

ä½¿ç”¨ `@Transactional`æ³¨è§£è¿›è¡Œäº‹åŠ¡ç®¡ç†çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```java
@Transactional(propagation = Propagation.REQUIRED)
public void aMethod {
  //do something
  B b = new B();
  C c = new C();
  b.bMethod();
  c.cMethod();
}
```

**å£°æ˜å¼äº‹åŠ¡è™½ç„¶ä¼˜äºç¼–ç¨‹å¼äº‹åŠ¡ï¼Œä½†ä¹Ÿæœ‰ä¸è¶³ï¼Œå£°æ˜å¼äº‹åŠ¡ç®¡ç†çš„ç²’åº¦æ˜¯æ–¹æ³•çº§åˆ«ï¼Œè€Œç¼–ç¨‹å¼äº‹åŠ¡æ˜¯å¯ä»¥ç²¾ç¡®åˆ°ä»£ç å—çº§åˆ«çš„**



Spring æ¡†æ¶ä¸­ï¼Œäº‹åŠ¡ç®¡ç†(**ä»¥ä¸‹æè¿°å‡é’ˆå¯¹å£°æ˜å¼äº‹åŠ¡**)ç›¸å…³æœ€é‡è¦çš„ 3 ä¸ªæ¥å£å¦‚ä¸‹ï¼š

- **`PlatformTransactionManager`**ï¼šï¼ˆå¹³å°ï¼‰äº‹åŠ¡ç®¡ç†å™¨ï¼Œ`Spring`äº‹åŠ¡ç­–ç•¥çš„æ ¸å¿ƒ
- **`TransactionDefinition`**ï¼šäº‹åŠ¡å®šä¹‰ä¿¡æ¯(äº‹åŠ¡éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºã€è¶…æ—¶ã€åªè¯»ã€å›æ»šè§„åˆ™)
- **`TransactionStatus`**ï¼šäº‹åŠ¡è¿è¡ŒçŠ¶æ€



**`PlatformTransactionManager`** ä¼šæ ¹æ® **`TransactionDefinition`** çš„å®šä¹‰æ¯”å¦‚äº‹åŠ¡è¶…æ—¶æ—¶é—´ã€éš”ç¦»çº§åˆ«ã€ä¼ æ’­è¡Œä¸ºç­‰æ¥è¿›è¡Œäº‹åŠ¡ç®¡ç† ï¼Œè€Œ **`TransactionStatus`** æ¥å£åˆ™æä¾›äº†ä¸€äº›æ–¹æ³•æ¥è·å–äº‹åŠ¡ç›¸åº”çš„çŠ¶æ€æ¯”å¦‚æ˜¯å¦æ–°äº‹åŠ¡ã€æ˜¯å¦å¯ä»¥å›æ»šç­‰ç­‰



`Spring` å°†äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒæŠ½è±¡ä¸ºä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨ï¼ˆ`TransactionManager`ï¼‰ï¼Œå®ƒçš„æºç åªæœ‰ä¸€ä¸ªç®€å•çš„æ¥å£å®šä¹‰ï¼Œå±äºä¸€ä¸ªæ ‡è®°æ¥å£ï¼š

```java
public interface TransactionManager {
}
```

è¯¥æ¥å£æœ‰ä¸¤ä¸ªå­æ¥å£ï¼Œåˆ†åˆ«æ˜¯ç¼–ç¨‹å¼äº‹åŠ¡æ¥å£ `ReactiveTransactionManager` å’Œå£°æ˜å¼äº‹åŠ¡æ¥å£ `PlatformTransactionManager`ã€‚æˆ‘ä»¬æ¥é‡ç‚¹è¯´è¯´ `PlatformTransactionManager`ï¼Œè¯¥æ¥å£å®šä¹‰äº† 3 ä¸ªæ¥å£æ–¹æ³•ï¼š

```java
interface PlatformTransactionManager extends TransactionManager{
    // æ ¹æ®äº‹åŠ¡å®šä¹‰è·å–äº‹åŠ¡çŠ¶æ€
    TransactionStatus getTransaction(TransactionDefinition definition)
            throws TransactionException;

    // æäº¤äº‹åŠ¡
    void commit(TransactionStatus status) throws TransactionException;

    // äº‹åŠ¡å›æ»š
    void rollback(TransactionStatus status) throws TransactionException;
}
```

- é€šè¿‡ `PlatformTransactionManager` è¿™ä¸ªæ¥å£ï¼Œ`Spring` ä¸ºå„ä¸ªå¹³å°å¦‚ JDBC(`DataSourceTransactionManager`)ã€Hibernate(`HibernateTransactionManager`)ã€JPA(`JpaTransactionManager`)ç­‰éƒ½æä¾›äº†å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨ï¼Œä½†æ˜¯å…·ä½“çš„å®ç°å°±æ˜¯å„ä¸ªå¹³å°è‡ªå·±çš„äº‹æƒ…äº†
- **å‚æ•° `TransactionDefinition` å’Œ `@Transactional` æ³¨è§£æ˜¯å¯¹åº”çš„**ï¼Œæ¯”å¦‚è¯´ `@Transactional` æ³¨è§£ä¸­å®šä¹‰çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€äº‹åŠ¡è¶…æ—¶æ—¶é—´ã€äº‹åŠ¡æ˜¯å¦åªè¯»ç­‰å±æ€§ï¼Œåœ¨ `TransactionDefinition` éƒ½å¯ä»¥æ‰¾å¾—åˆ°
- è¿”å›ç±»å‹ `TransactionStatus` ä¸»è¦ç”¨æ¥å­˜å‚¨å½“å‰äº‹åŠ¡çš„ä¸€äº›çŠ¶æ€å’Œæ•°æ®ï¼Œæ¯”å¦‚è¯´äº‹åŠ¡èµ„æºï¼ˆ`connection`ï¼‰ã€å›æ»šçŠ¶æ€ç­‰



1ã€é¦–å…ˆæ¥çœ‹ä¸€ä¸‹`TransactionDefinition.javaï¼š`åšäº†ä»€ä¹ˆå·¥ä½œï¼š

```java
public interface TransactionDefinition {
    
    //äº‹åŠ¡ä¼ æ’­æœºåˆ¶
    int PROPAGATION_REQUIRED = 0;
    int PROPAGATION_SUPPORTS = 1;
    int PROPAGATION_MANDATORY = 2;
    int PROPAGATION_REQUIRES_NEW = 3;
    int PROPAGATION_NOT_SUPPORTED = 4;
    int PROPAGATION_NEVER = 5;
    int PROPAGATION_NESTED = 6;
    
    //äº‹åŠ¡éš”ç¦»çº§åˆ«
    int ISOLATION_DEFAULT = -1;
    int ISOLATION_READ_UNCOMMITTED = 1;
    int ISOLATION_READ_COMMITTED = 2;
    int ISOLATION_REPEATABLE_READ = 4;
    int ISOLATION_SERIALIZABLE = 8;
    int TIMEOUT_DEFAULT = -1;

  // äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º
  default int getPropagationBehavior() {
    return PROPAGATION_REQUIRED;
  }

  // äº‹åŠ¡çš„éš”ç¦»çº§åˆ«
  default int getIsolationLevel() {
    return ISOLATION_DEFAULT;
  }

  // äº‹åŠ¡è¶…æ—¶æ—¶é—´
  default int getTimeout() {
    return TIMEOUT_DEFAULT;
  }

  // äº‹åŠ¡æ˜¯å¦åªè¯»
  default boolean isReadOnly() {
    return false;
  }
}
```



2ã€`TransactionStatus.java`çš„å†…å®¹ï¼š

`TransactionStatus`æ¥å£ç”¨æ¥è®°å½•äº‹åŠ¡çš„çŠ¶æ€ è¯¥æ¥å£å®šä¹‰äº†ä¸€ç»„æ–¹æ³•,ç”¨æ¥è·å–æˆ–åˆ¤æ–­äº‹åŠ¡çš„ç›¸åº”çŠ¶æ€ä¿¡æ¯

`PlatformTransactionManager.getTransaction(â€¦)`æ–¹æ³•è¿”å›ä¸€ä¸ª`TransactionStatus` å¯¹è±¡

**`TransactionStatus` æ¥å£å†…å®¹å¦‚ä¸‹ï¼š**

```java
public interface TransactionStatus{
    boolean isNewTransaction(); // æ˜¯å¦æ˜¯æ–°çš„äº‹åŠ¡
    boolean hasSavepoint(); // æ˜¯å¦æœ‰æ¢å¤ç‚¹
    void setRollbackOnly();  // è®¾ç½®ä¸ºåªå›æ»š
    boolean isRollbackOnly(); // æ˜¯å¦ä¸ºåªå›æ»š
    boolean isCompleted; // æ˜¯å¦å·²å®Œæˆ
}
```





3ã€æœ€åçœ‹`Transactional`æ³¨è§£åšäº†ä»€ä¹ˆï¼š

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
public @interface Transactional {ã€
  //å››ä¸ªå±æ€§å€¼
  Propagation propagation() default Propagation.REQUIRED;
  Isolation isolation() default Isolation.DEFAULT;
  int timeout() default TransactionDefinition.TIMEOUT_DEFAULT;
  boolean readOnly() default false;
                 
}
```

 å¤§æ¦‚è®²ä¸€ä¸‹è¿™ä¸ªç”¨åˆ°æœ€å¤šçš„æ³¨è§£`@Transactional`:

- `@Transactional` æ³¨è§£ä¸­çš„ `propagation` å¯¹åº” `TransactionDefinition` ä¸­çš„ `getPropagationBehavior`ï¼Œé»˜è®¤å€¼ä¸º `Propagation.REQUIRED(TransactionDefinition.PROPAGATION_REQUIRED)`
- `@Transactional` æ³¨è§£ä¸­çš„ `isolation` å¯¹åº” `TransactionDefinition` ä¸­çš„ `getIsolationLevel`ï¼Œé»˜è®¤å€¼ä¸º `DEFAULT(TransactionDefinition.ISOLATION_DEFAULT)`ã€‚
- `@Transactional` æ³¨è§£ä¸­çš„ `timeout` å¯¹åº” `TransactionDefinition` ä¸­çš„ `getTimeout`ï¼Œé»˜è®¤å€¼ä¸º`TransactionDefinition.TIMEOUT_DEFAULT`
- `@Transactional` æ³¨è§£ä¸­çš„ `readOnly` å¯¹åº” `TransactionDefinition` ä¸­çš„ `isReadOnly`ï¼Œé»˜è®¤å€¼ä¸º `false`







### äº‹åŠ¡ä¼ æ’­æœºåˆ¶

**äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯ä¸ºäº†è§£å†³ä¸šåŠ¡å±‚æ–¹æ³•ä¹‹é—´äº’ç›¸è°ƒç”¨çš„äº‹åŠ¡é—®é¢˜**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬åœ¨ A ç±»çš„`aMethod()`æ–¹æ³•ä¸­è°ƒç”¨äº† B ç±»çš„ `bMethod()` æ–¹æ³•ã€‚è¿™ä¸ªæ—¶å€™å°±æ¶‰åŠåˆ°ä¸šåŠ¡å±‚æ–¹æ³•ä¹‹é—´äº’ç›¸è°ƒç”¨çš„äº‹åŠ¡é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬çš„ `bMethod()`å¦‚æœå‘ç”Ÿå¼‚å¸¸éœ€è¦å›æ»šï¼Œå¦‚ä½•é…ç½®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ‰èƒ½è®© `aMethod()`ä¹Ÿè·Ÿç€å›æ»šå‘¢ï¼Ÿ 

```java
@Service
Class A {
    @Autowired
    B b;
    @Transactional(propagation = Propagation.xxx)
    public void aMethod {
        //æ¶‰åŠåˆ°äº‹åŠ¡ä¼ æ’­è¡Œä¸ºäº†
        b.bMethod();  
    }
}

@Service
Class B {
    @Transactional(propagation = Propagation.xxx)
    public void bMethod {
       //do something
    }
}
```





äº†è§£äº†ä¸Šè¿°åœºæ™¯åï¼Œå†æ¥çœ‹çœ‹å£°æ˜å¼äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼Œå¯ä»¥é€šè¿‡ `@Transactional` æ³¨è§£ä¸­çš„ `propagation` å±æ€§æ¥å®šä¹‰ï¼Œæ¯”å¦‚è¯´ï¼š

```java
@Transactional(propagation = Propagation.REQUIRED)
public void savePosts(PostsParam postsParam) {
}
```

`TransactionDefinition` ä¸€å…±å®šä¹‰äº† 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š

01ã€`PROPAGATION_REQUIRED`

è¿™ä¹Ÿæ˜¯ @Transactional é»˜è®¤çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼ŒæŒ‡çš„æ˜¯å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ã€‚æ›´ç¡®åˆ‡åœ°æ„æ€æ˜¯ï¼š

- å¦‚æœå¤–éƒ¨æ–¹æ³•æ²¡æœ‰å¼€å¯äº‹åŠ¡çš„è¯ï¼Œ`Propagation.REQUIRED` ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•ä¼šå¼€å¯è‡ªå·±çš„äº‹åŠ¡ï¼Œä¸”å¼€å¯çš„äº‹åŠ¡ç›¸äº’ç‹¬ç«‹(ç›¸å¯¹å¤–éƒ¨äº‹åŠ¡ç‹¬ç«‹)ï¼Œäº’ä¸å¹²æ‰°ï¼Œæ­¤æ—¶å†…éƒ¨äº‹åŠ¡ä¸Šä¿®é¥°çš„`Propagation.REQUIRED=Propagation.NESTED`
- **å¦‚æœå¤–éƒ¨æ–¹æ³•å¼€å¯äº‹åŠ¡å¹¶ä¸”æ˜¯ `Propagation.REQUIRED` çš„è¯ï¼Œæ‰€æœ‰ `Propagation.REQUIRED` ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•å’Œå¤–éƒ¨æ–¹æ³•å‡å±äºåŒä¸€äº‹åŠ¡ ï¼Œåªè¦ä¸€ä¸ªæ–¹æ³•å›æ»šï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½éœ€è¦å›æ»š**ï¼Œä½†æ˜¯å¦‚æœå†…éƒ¨äº‹åŠ¡æ²¡æœ‰è¢«`Propagation.REQUIRED`ä¿®é¥°çš„è¯ï¼Œåˆæ˜¯å¦ä¸€å›äº‹äº†

```java
Class A {
    @Transactional(propagation=Propagation.PROPAGATION_REQUIRED)
    public void aMethod { //è¿™é‡Œçš„aå°±æ˜¯å¤–éƒ¨æ–¹æ³•
        //do something
        B b = new B();
        b.bMethod();  //bä¸ºå†…éƒ¨æ–¹æ³•
    }
}

Class B {
    @Transactional(propagation=Propagation.PROPAGATION_REQUIRED)
    public void bMethod {
       //do something
    }
}
```

è¿™ä¸ªä¼ æ’­è¡Œä¸ºä¹Ÿæœ€å¥½ç†è§£ï¼Œ`aMethod` è°ƒç”¨äº† `bMethod`ï¼Œ**åªè¦å…¶ä¸­ä¸€ä¸ªæ–¹æ³•å›æ»šï¼Œæ•´ä¸ªäº‹åŠ¡å‡å›æ»š**



02ã€`PROPAGATION_REQUIRES_NEW`

åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ç®¡å¤–éƒ¨æ–¹æ³•æ˜¯å¦å¼€å¯äº‹åŠ¡ï¼Œ`Propagation.REQUIRES_NEW` ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•éƒ½ä¼šå¼€å¯è‡ªå·±çš„äº‹åŠ¡ï¼Œä¸”å¼€å¯çš„äº‹åŠ¡ä¸å¤–éƒ¨çš„äº‹åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°

```java
Class A {
    @Transactional(propagation=Propagation.PROPAGATION_REQUIRED)
    public void aMethod {
        //do something
        B b = new B();
        b.bMethod();
    }
}

Class B {
    @Transactional(propagation=Propagation.REQUIRES_NEW)
    public void bMethod {
       //do something
    }
}
```

å¦‚æœ `aMethod()`å‘ç”Ÿå¼‚å¸¸å›æ»šï¼Œ`bMethod()`ä¸ä¼šè·Ÿç€å›æ»šï¼Œå› ä¸º `bMethod()`å¼€å¯äº†ç‹¬ç«‹çš„äº‹åŠ¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœ `bMethod()`æŠ›å‡ºäº†æœªè¢«æ•è·çš„å¼‚å¸¸å¹¶ä¸”**è¿™ä¸ªå¼‚å¸¸æ»¡è¶³äº‹åŠ¡å›æ»šè§„åˆ™**çš„è¯,`aMethod()`åŒæ ·ä¹Ÿä¼šå›æ»šï¼Œå› ä¸ºè¿™ä¸ªå¼‚å¸¸è¢« `aMethod()`çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶æ£€æµ‹åˆ°äº†

03ã€`PROPAGATION_NESTED`



è¡¨ç¤ºåœ¨ä¸€ä¸ªç°æœ‰çš„äº‹åŠ¡ä¸­åˆ›å»ºä¸€ä¸ªåµŒå¥—çš„äº‹åŠ¡ã€‚åµŒå¥—äº‹åŠ¡æ˜¯å¤–éƒ¨äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œä½†æœ‰è‡ªå·±çš„ä¿å­˜ç‚¹ï¼ˆ`savepoint`ï¼‰å’Œæäº¤æˆ–å›æ»šçš„æ§åˆ¶

- **åœ¨å¤–å›´æ–¹æ³•æœªå¼€å¯äº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œ`Propagation.NESTED`å’Œ`Propagation.REQUIRED`ä½œç”¨ç›¸åŒï¼Œä¿®é¥°çš„å†…éƒ¨æ–¹æ³•éƒ½ä¼šæ–°å¼€å¯è‡ªå·±çš„äº‹åŠ¡ï¼Œä¸”å¼€å¯çš„äº‹åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°**

- **åœ¨å¤–å›´æ–¹æ³•å¼€å¯äº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œ`Propagation.NESTED`ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•å±äºå¤–éƒ¨äº‹åŠ¡çš„å­äº‹åŠ¡ï¼Œå¤–å›´ä¸»äº‹åŠ¡å›æ»šï¼Œå­äº‹åŠ¡ä¸€å®šå›æ»šï¼Œä½†å†…éƒ¨å­äº‹åŠ¡å¯ä»¥å•ç‹¬å›æ»šè€Œä¸å½±å“å¤–å›´ä¸»äº‹åŠ¡å’Œå…¶ä»–å­äº‹åŠ¡**

è¿™é‡Œè¿˜æ˜¯ç®€å•ä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœ `bMethod()` å›æ»šçš„è¯ï¼Œ`aMethod()`ä¸ä¼šå›æ»šã€‚å¦‚æœ `aMethod()` å›æ»šçš„è¯ï¼Œ`bMethod()`ä¼šå›æ»š

```java
@Service
Class A {
    @Autowired
    B b;
    @Transactional(propagation = Propagation.REQUIRED)
    public void aMethod {
        //do something
        b.bMethod();
    }
}

@Service
Class B {
    @Transactional(propagation = Propagation.NESTED)
    public void bMethod {
       //do something
    }
}
```



å†æ¥çœ‹ä¸€ä¸ªå®ä¾‹ï¼š

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ³¨å†Œçš„æ–¹æ³•ï¼Œæ–¹æ³•ä¸­è°ƒç”¨æ·»åŠ ç§¯åˆ†çš„æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬è§„å®šæ³¨å†Œå¤±è´¥è¦å½±å“`addPoint()`æ–¹æ³•ï¼ˆ**æ³¨å†Œæ–¹æ³•å›æ»šæ·»åŠ ç§¯åˆ†æ–¹æ³•ä¹Ÿéœ€è¦å›æ»š**ï¼‰ï¼Œé‚£ä¹ˆ`addPoint()`æ–¹æ³•å°±éœ€è¦è¿™æ ·å®ç°ï¼š

```java
@Service
   public class MembershipPointServiceImpl implements MembershipPointService{

        @Transactional(propagation = Propagation.NESTED)
        public void addPoint(Point point){

            try {
                recordService.addRecord(Record record);
            } catch (Exception e) {
               //çœç•¥...
            }
            //çœç•¥...
        }
        //çœç•¥...
   }
```



`REQUIRED`,`REQUIRES_NEW`,`NESTED` å¼‚åŒï¼š

1. **NESTED å’Œ REQUIRED ä¿®é¥°çš„å†…éƒ¨æ–¹æ³•éƒ½å±äºå¤–å›´æ–¹æ³•äº‹åŠ¡ï¼Œå¦‚æœå¤–å›´æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„äº‹åŠ¡éƒ½ä¼šè¢«å›æ»šã€‚ä½†æ˜¯ REQUIRED æ˜¯åŠ å…¥å¤–å›´æ–¹æ³•äº‹åŠ¡ï¼Œæ‰€ä»¥å’Œå¤–å›´äº‹åŠ¡åŒå±äºä¸€ä¸ªäº‹åŠ¡ï¼Œä¸€æ—¦ REQUIRED äº‹åŠ¡æŠ›å‡ºå¼‚å¸¸è¢«å›æ»šï¼Œå¤–å›´æ–¹æ³•äº‹åŠ¡ä¹Ÿå°†è¢«å›æ»šã€‚è€Œ NESTED æ˜¯å¤–å›´æ–¹æ³•çš„å­äº‹åŠ¡ï¼Œæœ‰å•ç‹¬çš„ä¿å­˜ç‚¹ï¼Œæ‰€ä»¥ NESTED æ–¹æ³•æŠ›å‡ºå¼‚å¸¸è¢«å›æ»šï¼Œä¸ä¼šå½±å“åˆ°å¤–å›´æ–¹æ³•çš„äº‹åŠ¡**
2. **NESTED å’Œ REQUIRES_NEW éƒ½å¯ä»¥åšåˆ°å†…éƒ¨æ–¹æ³•äº‹åŠ¡å›æ»šè€Œä¸å½±å“å¤–å›´æ–¹æ³•äº‹åŠ¡ã€‚ä½†æ˜¯å› ä¸º NESTED æ˜¯åµŒå¥—äº‹åŠ¡ï¼Œæ‰€ä»¥å¤–å›´æ–¹æ³•å›æ»šä¹‹åï¼Œä½œä¸ºå¤–å›´æ–¹æ³•äº‹åŠ¡çš„å­äº‹åŠ¡ä¹Ÿä¼šè¢«å›æ»šã€‚è€Œ REQUIRES_NEW æ˜¯é€šè¿‡å¼€å¯æ–°çš„äº‹åŠ¡å®ç°çš„ï¼Œå†…éƒ¨äº‹åŠ¡å’Œå¤–å›´äº‹åŠ¡æ˜¯ä¸¤ä¸ªäº‹åŠ¡ï¼Œå¤–å›´äº‹åŠ¡å›æ»šä¸ä¼šå½±å“å†…éƒ¨äº‹åŠ¡**



04ã€`PROPAGATION_MANDATORY`

å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

05ã€`PROPAGATION_SUPPORTS`

å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œã€‚

06ã€`PROPAGATION_NOT_SUPPORTED`

ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‚

07ã€`PROPAGATION_NEVER`

ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

3ã€4ã€5ã€6ã€7 è¿™ 5 ç§äº‹åŠ¡ä¼ æ’­æ–¹å¼ä¸å¸¸ç”¨ï¼Œäº†è§£å³å¯





### äº‹åŠ¡å¤±æ•ˆ

1. äº‹åŠ¡æ–¹æ³•çš„è®¿é—®ä¿®é¥°ç¬¦ä¸ºépublicï¼ŒSpringæºç åˆ¤æ–­ä¸ºépublicï¼Œä¼šä¸è¿›è¡Œäº‹åŠ¡ç®¡ç† ä¿®æ”¹æ–¹æ³•ï¼šå°†æ–¹æ³•ä¿®æ”¹ä¸ºpublicï¼› å¼€å¯AspectJä»£ç†æ¨¡å¼ æ³¨æ„ï¼šå¦‚æœäº‹åŠ¡æ–¹æ³•æ˜¯staticã€finalçš„ï¼ŒåŒæ ·æ— æ³•é€šè¿‡åŠ¨æ€ä»£ç†ï¼Œäº‹åŠ¡ä¹Ÿæ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ springçš„å£°æ˜å¼äº‹åŠ¡æ˜¯åŸºäºåŠ¨æ€ä»£ç†å®ç°çš„ï¼Œæˆ‘ä»¬æ— æ³•é‡å†™finalä¿®é¥°çš„æ–¹æ³•; ä¸ç®¡æ˜¯JDKåŠ¨æ€ä»£ç†è¿˜æ˜¯Cglibçš„åŠ¨æ€ä»£ç†ï¼Œéƒ½æ˜¯è¦é€šè¿‡ä»£ç†çš„æ–¹å¼è·å–åˆ°ä»£ç†çš„å…·ä½“å¯¹è±¡ï¼Œè€Œstaticä¿® é¥°çš„æ–¹æ³•æ˜¯å±äºç±»çš„ï¼Œä¸å±äºä»»ä½•å¯¹è±¡ï¼Œæ‰€ä»¥staticæ–¹æ³•ä¸èƒ½è¢«é‡å†™ï¼Œå³ä¾¿å†™æ³•ä¸Šæ˜¯é‡å†™ï¼Œä½†æ˜¯å¹¶ä¸å…· å¤‡é‡å†™çš„å«ä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´staticæ–¹æ³•ä¹Ÿä¸èƒ½è¿›è¡ŒåŠ¨æ€ä»£ç† 

2. æŠ›å‡ºäº†æŸä¸ªå¼‚å¸¸ï¼Œä½†æ˜¯è¿™ä¸ªå¼‚å¸¸åœ¨`@Transactional`ä¸­çš„`rollbackFor`å±æ€§å†…æ²¡æœ‰å£°æ˜è¯¥å¼‚å¸¸

3. æ•°æ®è¡¨æœ¬èº«ä¸æ”¯æŒäº‹åŠ¡ ä¾‹å¦‚ä½¿ç”¨çš„æ˜¯MyIsamå­˜å‚¨å¼•æ“ 

4. å¿˜è®°åŠ æ³¨è§£äº†ï¼Œä¾‹å¦‚æ²¡æœ‰åŠ ä¸Š`@Service`æ³¨è§£ï¼Œå› æ­¤`@Transactional`æ³¨è§£æ‰€åœ¨çš„ç±»æ²¡æœ‰è¢«`spring`ç®¡ç†ï¼Œ å¯¼è‡´äº‹åŠ¡å¤±æ•ˆ  è§£å†³æ–¹æ³•æ˜¯åŠ ä¸Š`@Service`æ³¨è§£æˆ–è€…å…¶ä»–èƒ½æ³¨å†Œ`Spring Bean`çš„æ–¹å¼ 

5. åœ¨è‡ªå·±çš„ä¸€ä¸ªImplç±»é‡Œé¢ï¼Œä¸€ä¸ªéäº‹åŠ¡æ–¹æ³•è°ƒç”¨äº†è‡ªèº«çš„äº‹åŠ¡æ–¹æ³• ç”±äº@Transactionalçš„å®ç°åŸç†æ˜¯AOPï¼Œè€ŒAOPçš„å®ç°åŸç†æ˜¯åŠ¨æ€ä»£ç†ï¼Œè€Œè‡ªå·±è°ƒç”¨è‡ªå·±çš„è¿‡ç¨‹ï¼Œå¹¶ä¸ å­˜åœ¨ä»£ç†å¯¹è±¡çš„è°ƒç”¨ï¼Œè¿™æ ·å°±å‡ºç°äº†è‡ª è°ƒç”¨æ³¨è§£å¤±æ•ˆçš„é—®é¢˜ 

   è§£å†³åŠæ³•ï¼šä¸¤ä¸ªæ–¹æ³•æ‹†å¼€æ”¾åœ¨ä¸åŒçš„ç±»é‡Œé¢ï¼Œè‡ªå·±æ³¨å…¥è‡ªå·±ï¼Œè¿™ä¸ªæ—¶å€™è‡ªèº«çš„è°ƒç”¨å°±ä¸æ˜¯é€šè¿‡thisäº†ï¼Œè€Œæ˜¯é€šè¿‡è·å–ä»£ç†ç±»ï¼Œ`AopContext.currentProxy()`.å…·ä½“æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ï¼Œæ³¨æ„éœ€è¦åœ¨ä¸»åŠ¨è°ƒç”¨çš„é‚£ä¸ªæ–¹æ³•ä¸Šæ·»åŠ @Transactionalæ³¨è§£  

6. Aè°ƒç”¨Bï¼ŒBä½¿ç”¨çš„æ˜¯Propagation.NOT_SUPPORTED è¡¨ç¤ºä¸ä»¥äº‹åŠ¡è¿è¡Œï¼Œå½“å‰è‹¥å­˜åœ¨äº‹åŠ¡å­˜æŒ‚èµ·ï¼Œä¸»åŠ¨ä»¥éäº‹åŠ¡çš„æ–¹å¼è¿è¡Œ 

7. å¤šçº¿ç¨‹å¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼š ä¸¤ä¸ªæ–¹æ³•ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œè·å–åˆ°çš„æ•°æ®åº“è¿æ¥ä¸ä¸€æ ·ï¼Œä»è€Œæ˜¯ä¸¤ä¸ªä¸åŒçš„äº‹åŠ¡ã€‚æˆ‘ä»¬è¯´çš„åŒä¸€ä¸ªäº‹ åŠ¡ï¼Œå…¶å®æ˜¯æŒ‡åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œåªæœ‰æ‹¥æœ‰åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥æ‰èƒ½åŒæ—¶æäº¤å’Œå›æ»šã€‚å¦‚æœåœ¨ä¸åŒçš„çº¿ ç¨‹ï¼Œæ‹¿åˆ°çš„æ•°æ®åº“è¿æ¥è‚¯å®šæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ˜¯ä¸åŒçš„äº‹åŠ¡ã€‚







### @Transactionalæ³¨è§£åŸç†



`@Transactional` çš„ä½œç”¨èŒƒå›´:

1. **æ–¹æ³•**ï¼šæ¨èå°†æ³¨è§£ä½¿ç”¨äºæ–¹æ³•ä¸Šï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š**è¯¥æ³¨è§£åªèƒ½åº”ç”¨åˆ° public æ–¹æ³•ä¸Šï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚**
2. **ç±»**ï¼šå¦‚æœè¿™ä¸ªæ³¨è§£ä½¿ç”¨åœ¨ç±»ä¸Šçš„è¯ï¼Œè¡¨æ˜è¯¥æ³¨è§£å¯¹è¯¥ç±»ä¸­æ‰€æœ‰çš„ public æ–¹æ³•éƒ½ç”Ÿæ•ˆã€‚
3. **æ¥å£**ï¼šä¸æ¨èåœ¨æ¥å£ä¸Šä½¿ç”¨





**`@Transactional` çš„å¸¸ç”¨é…ç½®å‚æ•°æ€»ç»“**:

| å±æ€§å        | è¯´æ˜                                                         |
| :------------ | :----------------------------------------------------------- |
| `propagation` | äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸ºï¼Œé»˜è®¤å€¼ä¸º REQUIRED                            |
| `isolation`   | äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œé»˜è®¤å€¼é‡‡ç”¨ DEFAULT                           |
| `timeout`     | äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º-1(ä¸ä¼šè¶…æ—¶),å¦‚æœè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶ä½†äº‹åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™è‡ªåŠ¨å›æ»šäº‹åŠ¡ |
| `readOnly`    | æŒ‡å®šäº‹åŠ¡æ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡ï¼Œé»˜è®¤å€¼ä¸º `false`                     |
| `rollbackFor` | ç”¨äºæŒ‡å®šèƒ½å¤Ÿè§¦å‘äº‹åŠ¡å›æ»šçš„å¼‚å¸¸ç±»å‹ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šå¤šä¸ªå¼‚å¸¸ç±»å‹ |





æˆ‘ä»¬çŸ¥é“ï¼Œ**`@Transactional` çš„å·¥ä½œæœºåˆ¶æ˜¯åŸºäº AOP å®ç°çš„ï¼ŒAOP åˆæ˜¯ä½¿ç”¨åŠ¨æ€ä»£ç†å®ç°çš„ã€‚å¦‚æœç›®æ ‡å¯¹è±¡å®ç°äº†æ¥å£ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šé‡‡ç”¨ JDK çš„åŠ¨æ€ä»£ç†ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰å®ç°äº†æ¥å£,ä¼šä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†ã€‚**

ğŸ¤ å¤šæä¸€å˜´ï¼š`createAopProxy()` æ–¹æ³• å†³å®šäº†æ˜¯ä½¿ç”¨ `JDK` è¿˜æ˜¯ `Cglib` æ¥åšåŠ¨æ€ä»£ç†ï¼Œæºç å¦‚ä¸‹ï¼š

------



```JAVA
public class DefaultAopProxyFactory implements AopProxyFactory, Serializable {
	@Override
	public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException {
		if (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) {
	Class<?> targetClass = config.getTargetClass();
	if (targetClass == null) {
throw new AopConfigException("TargetSource cannot determine target class: " +
	"Either an interface or a target is required for proxy creation.");
			}
			if (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) {
				return new JdkDynamicAopProxy(config);
			}
			return new ObjenesisCglibAopProxy(config);
		}
		else {
			return new JdkDynamicAopProxy(config);
		}
	}
  .......
}
```

å¦‚æœä¸€ä¸ªç±»æˆ–è€…ä¸€ä¸ªç±»ä¸­çš„ `public` æ–¹æ³•ä¸Šè¢«æ ‡æ³¨`@Transactional` æ³¨è§£çš„è¯ï¼Œ`Spring` å®¹å™¨å°±ä¼šåœ¨å¯åŠ¨çš„æ—¶å€™ä¸ºå…¶åˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œåœ¨è°ƒç”¨è¢«`@Transactional` æ³¨è§£çš„ `public` æ–¹æ³•çš„æ—¶å€™ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ï¼Œ`TransactionInterceptor` ç±»ä¸­çš„ `invoke()`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯åœ¨ç›®æ ‡æ–¹æ³•ä¹‹å‰å¼€å¯äº‹åŠ¡ï¼Œæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¼‚å¸¸çš„æ—¶å€™å›æ»šäº‹åŠ¡ï¼Œæ–¹æ³•è°ƒç”¨å®Œæˆä¹‹åæäº¤äº‹åŠ¡

> äº‹åŠ¡æ‹¦æˆªå™¨ï¼ˆTransactionInterceptorï¼‰ï¼šäº‹åŠ¡æ‹¦æˆªå™¨æ˜¯å®ç°äº‹åŠ¡åˆ‡é¢çš„å…³é”®ç»„ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè´Ÿè´£æ‹¦æˆªè¢«`@Transactional`æ³¨è§£æ ‡è®°çš„æ–¹æ³•è°ƒç”¨ã€‚å½“æ–¹æ³•è°ƒç”¨è¿›å…¥äº‹åŠ¡æ‹¦æˆªå™¨æ—¶ï¼Œä¼šæ ¹æ®æ³¨è§£ä¸­çš„äº‹åŠ¡å±æ€§ï¼ˆå¦‚äº‹åŠ¡ä¼ æ’­è¡Œä¸ºã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ç­‰ï¼‰æ¥å†³å®šæ˜¯å¦å¼€å¯æ–°çš„äº‹åŠ¡ï¼Œæˆ–åŠ å…¥å·²æœ‰çš„äº‹åŠ¡ã€‚







## SpringBoot





### SpringBootå¦‚ä½•ç®€åŒ–é…ç½®å¼€å‘ï¼Ÿ

ä»¥ä¸‹æ˜¯ä¸€äº›Spring Bootç®€åŒ–Springé…ç½®å¼€å‘çš„æ–¹å¼ï¼š

1. è‡ªåŠ¨é…ç½®ï¼šSpring Bootæä¾›äº†å¤§é‡çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œå®ƒä»¬ä¼šæ ¹æ®åº”ç”¨ç¨‹åºçš„ä¾èµ–å’Œé…ç½®è‡ªåŠ¨é…ç½®å„ç§ç»„ä»¶ã€‚ä¾‹å¦‚ï¼Œ**å¦‚æœæ·»åŠ äº†Spring Data JPAçš„ä¾èµ–ï¼ŒSpring Bootä¼šè‡ªåŠ¨é…ç½®æ•°æ®æºã€å®ä½“ç®¡ç†å™¨å·¥å‚ç­‰ç›¸å…³ç»„ä»¶ï¼Œä½ åªéœ€è¦æä¾›æ•°æ®åº“è¿æ¥çš„é…ç½®**å³å¯

2. Starterä¾èµ–ï¼šSpring Bootæä¾›äº†ä¸€ç³»åˆ—çš„Starterä¾èµ–ï¼Œè¿™äº›Starterä¾èµ–åŒ…å«äº†ä¸€ç»„ç›¸å…³çš„ä¾èµ–åº“å’Œé»˜è®¤çš„é…ç½®ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦å¼•å…¥ç›¸åº”çš„Starterä¾èµ–ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨é…ç½®æ‰€éœ€çš„ç»„ä»¶å’ŒåŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³å¼€å‘Webåº”ç”¨ç¨‹åºï¼Œå¯ä»¥å¼•å…¥`spring-boot-starter-web`ä¾èµ–ï¼Œå®ƒä¼šè‡ªåŠ¨é…ç½®Webç›¸å…³çš„ç»„ä»¶

3. æ³¨è§£é©±åŠ¨å¼€å‘ï¼šSpring Booté¼“åŠ±**ä½¿ç”¨æ³¨è§£æ¥ç®€åŒ–é…ç½®**ï¼Œé€šè¿‡ä½¿ç”¨æ³¨è§£ï¼Œä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å£°æ˜å„ç§é…ç½®ã€Beanã€è¯·æ±‚æ˜ å°„ç­‰ï¼Œè€Œ**æ— éœ€æ‰‹åŠ¨ç¼–å†™å¤§é‡çš„XMLé…ç½®æ–‡ä»¶**

4. å¤–éƒ¨åŒ–é…ç½®ï¼šSpring Bootæ”¯æŒå¤–éƒ¨åŒ–é…ç½®ï¼Œä½ å¯ä»¥å°†é…ç½®ä¿¡æ¯æ”¾åœ¨å¤–éƒ¨çš„å±æ€§æ–‡ä»¶ã€YAMLæ–‡ä»¶ã€ç¯å¢ƒå˜é‡ç­‰ä¸­ï¼Œå¹¶é€šè¿‡é…ç½®æ³¨è§£æˆ–é…ç½®ç±»å°†å…¶åŠ è½½åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚è¿™æ ·ï¼Œä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ ¹æ®ä¸åŒçš„ç¯å¢ƒæˆ–éœ€æ±‚è¿›è¡Œé…ç½®

5. å†…åµŒæœåŠ¡å™¨ï¼š**Spring Bootå†…ç½®äº†å¸¸è§çš„WebæœåŠ¡å™¨ï¼ˆå¦‚Tomcatã€Jettyç­‰ï¼‰**ï¼Œä½ å¯ä»¥å°†åº”ç”¨ç¨‹åºæ‰“åŒ…æˆå¯æ‰§è¡Œçš„JARæ–‡ä»¶ï¼Œç›´æ¥è¿è¡Œï¼Œè€Œæ— éœ€å®‰è£…å’Œé…ç½®å¤–éƒ¨æœåŠ¡å™¨

   
   
   
   
   

### è‡ªåŠ¨è£…é…åŸç†

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ SpringBoot çš„æ ¸å¿ƒæ³¨è§£ `SpringBootApplication`ï¼š

```java
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
<1.>@SpringBootConfiguration
<2.>@ComponentScan
<3.>@EnableAutoConfiguration
public @interface SpringBootApplication {

}

@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Configuration //å®é™…ä¸Šå®ƒä¹Ÿæ˜¯ä¸€ä¸ªé…ç½®ç±»
public @interface SpringBootConfiguration {
}

```

å¯ä»¥æŠŠ `@SpringBootApplication`çœ‹ä½œæ˜¯ `@Configuration`ã€`@EnableAutoConfiguration`ã€`@ComponentScan` æ³¨è§£çš„é›†åˆã€‚æ ¹æ® SpringBoot å®˜ç½‘ï¼Œè¿™ä¸‰ä¸ªæ³¨è§£çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š

- `@EnableAutoConfiguration`ï¼šå¯ç”¨ SpringBoot çš„è‡ªåŠ¨é…ç½®æœºåˆ¶
- `@Configuration`ï¼šå…è®¸åœ¨ä¸Šä¸‹æ–‡ä¸­æ³¨å†Œé¢å¤–çš„ bean æˆ–å¯¼å…¥å…¶ä»–é…ç½®ç±»
- `@ComponentScan`ï¼šæ‰«æè¢«`@Component` (`@Service`,`@Controller`)æ³¨è§£çš„ beanï¼Œæ³¨è§£é»˜è®¤ä¼šæ‰«æå¯åŠ¨ç±»æ‰€åœ¨çš„åŒ…ä¸‹æ‰€æœ‰çš„ç±» ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸æ‰«ææŸäº› bean



`EnableAutoConfiguration` åªæ˜¯ä¸€ä¸ªç®€å•çš„æ³¨è§£ï¼Œè‡ªåŠ¨è£…é…æ ¸å¿ƒåŠŸèƒ½çš„å®ç°å®é™…æ˜¯é€šè¿‡ `AutoConfigurationImportSelector`ç±»ï¼š

```java
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage //ä½œç”¨ï¼šå°†mainåŒ…ä¸‹çš„æ‰€æœ‰ç»„ä»¶æ³¨å†Œåˆ°å®¹å™¨ä¸­
@Import({AutoConfigurationImportSelector.class}) //åŠ è½½è‡ªåŠ¨è£…é…ç±» xxxAutoconfiguration
public @interface EnableAutoConfiguration {
    String ENABLED_OVERRIDE_PROPERTY = "spring.boot.enableautoconfiguration";

    Class<?>[] exclude() default {};

    String[] excludeName() default {};
}

```



`AutoConfigurationImportSelector`ç±»çš„ç»§æ‰¿ä½“ç³»å¦‚ä¸‹ï¼š

```java
public class AutoConfigurationImportSelector implements DeferredImportSelector, BeanClassLoaderAware, ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered {

}

public interface DeferredImportSelector extends ImportSelector {

}

public interface ImportSelector {
    String[] selectImports(AnnotationMetadata var1);
}
```

å¯ä»¥çœ‹å‡ºï¼Œ`AutoConfigurationImportSelector` ç±»å®ç°äº† `ImportSelector`æ¥å£ï¼Œä¹Ÿå°±å®ç°äº†è¿™ä¸ªæ¥å£ä¸­çš„ `selectImports`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äº**è·å–æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç±»çš„å…¨é™å®šç±»åï¼Œè¿™äº›ç±»éœ€è¦è¢«åŠ è½½åˆ° IoC å®¹å™¨ä¸­**

```JAVA
private static final String[] NO_IMPORTS = new String[0];

public String[] selectImports(AnnotationMetadata annotationMetadata) {
        // <1>.åˆ¤æ–­è‡ªåŠ¨è£…é…å¼€å…³æ˜¯å¦æ‰“å¼€
        if (!this.isEnabled(annotationMetadata)) {
            return NO_IMPORTS;
        } else {
          //<2>.è·å–æ‰€æœ‰éœ€è¦è£…é…çš„bean
            AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(this.beanClassLoader);
            AutoConfigurationImportSelector.AutoConfigurationEntry autoConfigurationEntry = this.getAutoConfigurationEntry(autoConfigurationMetadata, annotationMetadata);
            return StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());
        }
    }

```





ä»¥ä¸‹æ˜¯Spring Bootè‡ªåŠ¨è£…é…çš„ä¸»è¦åŸç†ï¼š

1. æ¡ä»¶åŒ–é…ç½®ï¼ˆ`Conditional Configuration`ï¼‰ï¼š`Spring Boot`ä½¿ç”¨æ¡ä»¶åŒ–é…ç½®æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥å¯ç”¨æŸä¸ªé…ç½®æˆ–ç»„ä»¶ã€‚æ¡ä»¶åŒ–é…ç½®é€šè¿‡æ¡ä»¶æ³¨è§£ï¼ˆä¾‹å¦‚`@ConditionalOnClass`ã€`@ConditionalOnBean`ã€`@ConditionalOnProperty`ç­‰ï¼‰æ¥åˆ¤æ–­ç‰¹å®šæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œåªæœ‰æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç›¸å…³çš„é…ç½®æˆ–ç»„ä»¶æ‰ä¼šè¢«è‡ªåŠ¨è£…é…

2. ç»„ä»¶æ‰«æï¼ˆ`Component Scanning`ï¼‰ï¼š`Spring Boot`ä¼šè‡ªåŠ¨æ‰«æé¡¹ç›®ä¸­çš„ç±»ï¼Œå¯»æ‰¾è¢«ç‰¹å®šæ³¨è§£æ ‡è®°çš„ç±»ï¼Œå¦‚`@Component`ã€`@Service`ã€`@Repository`ç­‰ã€‚è¢«æ‰«æåˆ°çš„ç±»å°†è¢«æ³¨å†Œä¸ºSpringå®¹å™¨ä¸­çš„Beanï¼Œä»è€Œå¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è¢«æ³¨å…¥å’Œä½¿ç”¨

3. è‡ªåŠ¨é…ç½®ç±»ï¼ˆ`Auto-Configuration Classes`ï¼‰ï¼š`Spring Boot`ä¼šæä¾›å¤§é‡çš„è‡ªåŠ¨é…ç½®ç±»ï¼Œè¿™äº›ç±»é€šè¿‡æ¡ä»¶åŒ–é…ç½®æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é…ç½®ç‰¹å®šçš„Beanã€‚è‡ªåŠ¨é…ç½®ç±»é€šå¸¸ä½¿ç”¨`@Configuration`æ³¨è§£ï¼Œå¹¶æä¾›äº†é»˜è®¤çš„é…ç½®ï¼Œè¿™äº›é…ç½®ä¼šåœ¨æ¡ä»¶æ»¡è¶³æ—¶ç”Ÿæ•ˆ

4. `spring.factories`æ–‡ä»¶ï¼š`Spring Boot`ä½¿ç”¨`spring.factories`æ–‡ä»¶æ¥å®šä¹‰è‡ªåŠ¨è£…é…çš„é…ç½®ç±»ã€‚è¯¥æ–‡ä»¶ä½äº`META-INF/spring.factories`è·¯å¾„ä¸‹ï¼Œå…¶ä¸­åˆ—å‡ºäº†æ‰€æœ‰è‡ªåŠ¨é…ç½®ç±»çš„å…¨é™å®šåã€‚`Spring Boot`åœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½è¿™äº›é…ç½®ç±»å¹¶è¿›è¡Œæ¡ä»¶åŒ–é…ç½®

   å½“Spring Bootåº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼ŒSpring Bootä¼šè¯»å–`spring.factories`æ–‡ä»¶ä¸­çš„é…ç½®ï¼ŒåŠ è½½å’Œå®ä¾‹åŒ–å…¶ä¸­æŒ‡å®šçš„è‡ªåŠ¨é…ç½®ç±»ã€‚è¿™äº›è‡ªåŠ¨é…ç½®ç±»ä½¿ç”¨æ¡ä»¶åŒ–é…ç½®ï¼ˆ`Conditional Configuration`ï¼‰å’Œç»„ä»¶æ‰«æï¼ˆ`Component Scanning`ï¼‰ç­‰æœºåˆ¶æ¥å†³å®šæ˜¯å¦éœ€è¦é…ç½®ç›¸å…³çš„Beanï¼Œè¿™ç§æœºåˆ¶å¯ä»¥ä½¿å¾—Spring Bootåº”ç”¨ç¨‹åºåœ¨å¼•å…¥ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œè‡ªåŠ¨è·å¾—è¯¥åº“æ‰€æä¾›çš„ç‰¹æ€§å’Œé…ç½®ã€‚åŒæ—¶ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡è‡ªå®šä¹‰è‡ªå·±çš„`spring.factories`æ–‡ä»¶ï¼Œè¦†ç›–é»˜è®¤çš„è‡ªåŠ¨é…ç½®ï¼Œå®ç°è‡ªå·±çš„é…ç½®å’Œæ‰©å±•

   













# MySQL





## æ‰§è¡Œä¸€æ¡Sqlè¯­å¥çš„è¿‡ç¨‹

1ã€è¿æ¥å™¨ï¼š

- ä¸å®¢æˆ·ç«¯è¿›è¡Œ TCP ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼›
- æ ¡éªŒå®¢æˆ·ç«¯çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦‚æœç”¨æˆ·åæˆ–å¯†ç ä¸å¯¹ï¼Œåˆ™ä¼šæŠ¥é”™ï¼›
- å¦‚æœç”¨æˆ·åå’Œå¯†ç éƒ½å¯¹äº†ï¼Œåˆ™è¯»å–è¯¥ç”¨æˆ·çš„æƒé™ï¼Œåç»­çš„æƒé™é€»è¾‘åˆ¤æ–­éƒ½åŸºäºæ­¤æ—¶è¯»å–åˆ°çš„æƒé™ï¼›

2ã€æŸ¥è¯¢ç¼“å­˜(æ¯”è¾ƒé¸¡è‚‹)ï¼šå°†`sql`è¯­å¥å‘é€ç»™`Mysql`æœåŠ¡ï¼Œ`Mysql`**å»æŸ¥è¯¢ç¼“å­˜çœ‹çœ‹ä¹‹å‰æœ‰æ²¡æœ‰æ‰§è¡Œè¿‡è¯¥å‘½ä»¤ï¼Œå¦‚æœæŸ¥è¯¢çš„è¯­å¥å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿”å› value ç»“æœç»™å®¢æˆ·ç«¯**ã€‚å¦‚æœæŸ¥è¯¢çš„è¯­å¥æ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆå°±è¦å¾€ä¸‹ç»§ç»­æ‰§è¡Œï¼Œç­‰æ‰§è¡Œå®Œåï¼ŒæŸ¥è¯¢çš„ç»“æœå°±ä¼šè¢«å­˜å…¥æŸ¥è¯¢ç¼“å­˜ä¸­(å› ä¸ºåªè¦ä¸€ä¸ªè¡¨æœ‰æ›´æ–°æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªè¡¨çš„æŸ¥è¯¢ç¼“å­˜å°±ä¼šè¢«æ¸…ç©º,æ‰€ä»¥ç¼“å­˜å‘½ä¸­ç‡ä¸€èˆ¬å¾ˆä½)

> æ­¤å¤„æŸ¥è¯¢ç¼“å­˜æ˜¯ server å±‚çš„ï¼Œä¹Ÿå°±æ˜¯ MySQL 8.0 ç‰ˆæœ¬ç§»é™¤çš„æ˜¯ server å±‚çš„æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ä¸æ˜¯ Innodb å­˜å‚¨å¼•æ“ä¸­çš„ buffer pool



3ã€è§£æå™¨+ä¼˜åŒ–å™¨ï¼š(è§£æsqlä¸­çš„å…³é”®å­—ï¼Œä¼˜åŒ–sqlå¤„ç†é€»è¾‘)

é€šè¿‡**è¯æ³•åˆ†æ**è¯†åˆ«è¾“å…¥`sql`å­—ç¬¦ä¸²ä¸­çš„å…³é”®å­—ï¼Œè¿›è€Œæ„å»ºå‡º `SQL` è¯­æ³•æ ‘ï¼Œç„¶åå†`è¯­æ³•åˆ†æ`ï¼Œæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­è¾“å…¥çš„ `SQL` è¯­å¥æ˜¯å¦æ»¡è¶³ `MySQL` è¯­æ³•

**ä¼˜åŒ–å™¨åˆ™ä¸»è¦è´Ÿè´£å°† SQL æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆç¡®å®šä¸‹æ¥**ï¼Œæ¯”å¦‚åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œä¼˜åŒ–å™¨ä¼šåŸºäºæŸ¥è¯¢æˆæœ¬çš„è€ƒè™‘ï¼Œæ¥å†³å®šé€‰æ‹©ä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼Œä¸‹å›¾çš„sqlè¯­å¥ç»ä¼˜åŒ–åèµ°äº†ä¸»é”®ç´¢å¼•ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/explain%20%E7%B4%A2%E5%BC%95.png)

4ã€æ‰§è¡Œå™¨ï¼šç»å†å®Œä¼˜åŒ–å™¨åï¼Œå°±ç¡®å®šäº†æ‰§è¡Œæ–¹æ¡ˆï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œå™¨å°±ä¼šå’Œå­˜å‚¨å¼•æ“äº¤äº’äº†ï¼Œä»å­˜å‚¨å¼•æ“è¯»å–è®°å½•ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mysql%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B.webp" style="zoom:67%;" />







## Explainç”¨æ³•

[Explain æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’](https://xiaolincoding.com/mysql/index/index_interview.html#%E9%98%B2%E6%AD%A2%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88)

å¯¹äºæ‰§è¡Œè®¡åˆ’ï¼Œå‚æ•°æœ‰ï¼š

- idï¼šæ¯ä¸ª select å…³é”®å­—éƒ½å¯¹åº”ä¸€ä¸ªå”¯ä¸€idï¼›
- select_typeï¼šselectå…³é”®å­—å¯¹åº”çš„é‚£ä¸ªæŸ¥è¯¢çš„ç±»å‹ï¼Œå¦‚ SIMPLEã€PRIMARYã€SUBQUERYã€DEPENDENTã€SNIONï¼›

- tableï¼šæ¯ä¸ªæŸ¥è¯¢å¯¹åº”çš„è¡¨åï¼›

- possible_keys å­—æ®µè¡¨ç¤ºå¯èƒ½ç”¨åˆ°çš„ç´¢å¼•ï¼›
- key å­—æ®µè¡¨ç¤ºå®é™…ç”¨çš„ç´¢å¼•ï¼Œå¦‚æœè¿™ä¸€é¡¹ä¸º NULLï¼Œè¯´æ˜æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼›
- key_len è¡¨ç¤ºç´¢å¼•çš„é•¿åº¦ï¼›
- rows è¡¨ç¤º MySQL åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥æ—¶ï¼Œéœ€è¦æ‰«æçš„è¡Œæ•°çš„é¢„ä¼°å€¼ã€‚
- type è¡¨ç¤ºæ•°æ®æ‰«æç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹çœ‹è¿™ä¸ªã€‚

`type` å­—æ®µå°±æ˜¯æè¿°äº†æ‰¾åˆ°æ‰€éœ€æ•°æ®æ—¶ä½¿ç”¨çš„æ‰«ææ–¹å¼æ˜¯ä»€ä¹ˆï¼Œå¸¸è§æ‰«æç±»å‹çš„**æ‰§è¡Œæ•ˆç‡ä»ä½åˆ°é«˜çš„é¡ºåºä¸º**ï¼š

- Allï¼ˆå…¨è¡¨æ‰«æï¼‰ï¼›
- indexï¼ˆå…¨ç´¢å¼•æ‰«æï¼‰ï¼›
- rangeï¼ˆç´¢å¼•èŒƒå›´æ‰«æï¼‰ï¼›
- refï¼ˆéå”¯ä¸€ç´¢å¼•æ‰«æï¼‰ï¼›
- eq_refï¼ˆå”¯ä¸€ç´¢å¼•æ‰«æï¼‰ï¼›
- constï¼ˆç»“æœåªæœ‰ä¸€æ¡çš„ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æ‰«æï¼‰ã€‚

åœ¨è¿™äº›æƒ…å†µé‡Œï¼Œall æ˜¯æœ€åçš„æƒ…å†µï¼Œå› ä¸ºé‡‡ç”¨äº†å…¨è¡¨æ‰«æçš„æ–¹å¼ã€‚index å’Œ all å·®ä¸å¤šï¼Œåªä¸è¿‡ index å¯¹ç´¢å¼•è¡¨è¿›è¡Œå…¨æ‰«æï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸å†éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œä½†æ˜¯å¼€é”€ä¾ç„¶å¾ˆå¤§ã€‚æ‰€ä»¥ï¼Œè¦å°½é‡é¿å…å…¨è¡¨æ‰«æå’Œå…¨ç´¢å¼•æ‰«æã€‚

range è¡¨ç¤ºé‡‡ç”¨äº†ç´¢å¼•èŒƒå›´æ‰«æï¼Œä¸€èˆ¬åœ¨ where å­å¥ä¸­ä½¿ç”¨ < ã€>ã€inã€between ç­‰å…³é”®è¯ï¼Œåªæ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œï¼Œå±äºèŒƒå›´æŸ¥æ‰¾ã€‚**ä»è¿™ä¸€çº§åˆ«å¼€å§‹ï¼Œç´¢å¼•çš„ä½œç”¨ä¼šè¶Šæ¥è¶Šæ˜æ˜¾ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°½é‡è®© SQL æŸ¥è¯¢å¯ä»¥ä½¿ç”¨åˆ° range è¿™ä¸€çº§åˆ«åŠä»¥ä¸Šçš„ type è®¿é—®æ–¹å¼**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/explainYongfa.png)

const ç±»å‹è¡¨ç¤ºä½¿ç”¨äº†ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•ä¸å¸¸é‡å€¼è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”å¦‚ select name from product where id=1ã€‚

éœ€è¦è¯´æ˜çš„æ˜¯ const ç±»å‹å’Œ eq_ref éƒ½ä½¿ç”¨äº†ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼Œä¸è¿‡è¿™ä¸¤ä¸ªç±»å‹æœ‰æ‰€åŒºåˆ«ï¼Œconst æ˜¯ä¸å¸¸é‡è¿›è¡Œæ¯”è¾ƒï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šæ›´å¿«ï¼Œè€Œ eq_ref é€šå¸¸ç”¨äºå¤šè¡¨è”æŸ¥ä¸­ã€‚

é™¤äº†å…³æ³¨ typeï¼Œä¹Ÿè¦å…³æ³¨ extra æ˜¾ç¤ºçš„ç»“æœï¼Œè¿™é‡Œè¯´å‡ ä¸ªé‡è¦çš„å‚è€ƒæŒ‡æ ‡ï¼š

1ã€Using filesort ï¼šå½“æŸ¥è¯¢è¯­å¥ä¸­åŒ…å« group by æ“ä½œï¼Œè€Œä¸”æ— æ³•åˆ©ç”¨ç´¢å¼•å®Œæˆæ’åºæ“ä½œçš„æ—¶å€™ï¼Œ è¿™æ—¶ä¸å¾—ä¸é€‰æ‹©ç›¸åº”çš„æ’åºç®—æ³•è¿›è¡Œï¼Œç”šè‡³å¯èƒ½ä¼šé€šè¿‡æ–‡ä»¶æ’åºï¼Œæ•ˆç‡æ˜¯å¾ˆä½çš„ï¼Œæ‰€ä»¥è¦é¿å…è¿™ç§é—®é¢˜çš„å‡ºç°ã€‚

2ã€Using temporaryï¼šä½¿äº†ç”¨ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼ŒMySQL åœ¨å¯¹æŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œå¸¸è§äºæ’åº order by å’Œåˆ†ç»„æŸ¥è¯¢ group byã€‚æ•ˆç‡ä½ï¼Œè¦é¿å…è¿™ç§é—®é¢˜çš„å‡ºç°ã€‚

3ã€Using indexï¼šæ‰€éœ€æ•°æ®åªéœ€åœ¨ç´¢å¼•å³å¯å…¨éƒ¨è·å¾—ï¼Œä¸é¡»è¦å†åˆ°è¡¨ä¸­å–æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œé¿å…äº†å›è¡¨æ“ä½œï¼Œæ•ˆç‡ä¸é”™ã€‚



## ä¸¤é˜¶æ®µæäº¤åè®®

äº‹åŠ¡æäº¤åï¼Œredo log å’Œ binlog éƒ½è¦æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ˜¯ç‹¬ç«‹çš„é€»è¾‘ï¼Œå¯èƒ½å‡ºç°åŠæˆåŠŸçš„çŠ¶æ€ï¼Œè¿™æ ·å°±é€ æˆä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸ä¸€è‡´ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ id = 1 è¿™è¡Œæ•°æ®çš„å­—æ®µ name çš„å€¼åŸæœ¬æ˜¯ 'jay'ï¼Œç„¶åæ‰§è¡Œ `UPDATE t_user SET name = 'xiaolin' WHERE id = 1;` å¦‚æœåœ¨æŒä¹…åŒ– redo log å’Œ binlog ä¸¤ä¸ªæ—¥å¿—çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†åŠæˆåŠŸçŠ¶æ€ï¼Œé‚£ä¹ˆå°±æœ‰ä¸¤ç§æƒ…å†µï¼š

- **å¦‚æœåœ¨å°† redo log åˆ·å…¥åˆ°ç£ç›˜ä¹‹åï¼Œ MySQL çªç„¶å®•æœºäº†ï¼Œè€Œ binlog è¿˜æ²¡æœ‰æ¥å¾—åŠå†™å…¥**ã€‚MySQL é‡å¯åï¼Œé€šè¿‡ redo log èƒ½å°† Buffer Pool ä¸­ id = 1 è¿™è¡Œæ•°æ®çš„ name å­—æ®µæ¢å¤åˆ°æ–°å€¼ xiaolinï¼Œä½†æ˜¯ binlog é‡Œé¢æ²¡æœ‰è®°å½•è¿™æ¡æ›´æ–°è¯­å¥ï¼Œåœ¨ä¸»ä»æ¶æ„ä¸­ï¼Œbinlog ä¼šè¢«å¤åˆ¶åˆ°ä»åº“ï¼Œç”±äº binlog ä¸¢å¤±äº†è¿™æ¡æ›´æ–°è¯­å¥ï¼Œä»åº“çš„è¿™ä¸€è¡Œ name å­—æ®µæ˜¯æ—§å€¼ jayï¼Œä¸ä¸»åº“çš„å€¼ä¸ä¸€è‡´æ€§ï¼›
- **å¦‚æœåœ¨å°† binlog åˆ·å…¥åˆ°ç£ç›˜ä¹‹åï¼Œ MySQL çªç„¶å®•æœºäº†ï¼Œè€Œ redo log è¿˜æ²¡æœ‰æ¥å¾—åŠå†™å…¥**ã€‚ç”±äº redo log è¿˜æ²¡å†™ï¼Œå´©æºƒæ¢å¤ä»¥åè¿™ä¸ªäº‹åŠ¡æ— æ•ˆï¼Œæ‰€ä»¥ id = 1 è¿™è¡Œæ•°æ®çš„ name å­—æ®µè¿˜æ˜¯æ—§å€¼ jayï¼Œè€Œ binlog é‡Œé¢è®°å½•äº†è¿™æ¡æ›´æ–°è¯­å¥ï¼Œåœ¨ä¸»ä»æ¶æ„ä¸­ï¼Œbinlog ä¼šè¢«å¤åˆ¶åˆ°ä»åº“ï¼Œä»åº“æ‰§è¡Œäº†è¿™æ¡æ›´æ–°è¯­å¥ï¼Œé‚£ä¹ˆè¿™ä¸€è¡Œ name å­—æ®µæ˜¯æ–°å€¼ xiaolinï¼Œä¸ä¸»åº“çš„å€¼ä¸ä¸€è‡´æ€§ï¼›

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æŒä¹…åŒ– redo log å’Œ binlog è¿™ä¸¤ä»½æ—¥å¿—çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°åŠæˆåŠŸçš„çŠ¶æ€ï¼Œå°±ä¼šé€ æˆä¸»ä»ç¯å¢ƒçš„æ•°æ®ä¸ä¸€è‡´æ€§ã€‚è¿™æ˜¯å› ä¸º redo log å½±å“ä¸»åº“çš„æ•°æ®ï¼Œbinlog å½±å“ä»åº“çš„æ•°æ®ï¼Œæ‰€ä»¥ redo log å’Œ binlog å¿…é¡»ä¿æŒä¸€è‡´æ‰èƒ½ä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´ã€‚

**MySQL ä¸ºäº†é¿å…å‡ºç°ä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä½¿ç”¨äº†ã€Œä¸¤é˜¶æ®µæäº¤ã€æ¥è§£å†³**ï¼Œä¸¤é˜¶æ®µæäº¤å…¶å®æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§åè®®ï¼Œå®ƒå¯ä»¥ä¿è¯å¤šä¸ªé€»è¾‘æ“ä½œè¦ä¸å…¨éƒ¨æˆåŠŸï¼Œè¦ä¸å…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°åŠæˆåŠŸçš„çŠ¶æ€

**ä¸¤é˜¶æ®µæäº¤æŠŠå•ä¸ªäº‹åŠ¡çš„æäº¤æ‹†åˆ†æˆäº† 2 ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ã€Œå‡†å¤‡ï¼ˆPrepareï¼‰é˜¶æ®µã€å’Œã€Œæäº¤ï¼ˆCommitï¼‰é˜¶æ®µã€**ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½ç”±åè°ƒè€…ï¼ˆCoordinatorï¼‰å’Œå‚ä¸è€…ï¼ˆParticipantï¼‰å…±åŒå®Œæˆã€‚æ³¨æ„ï¼Œä¸è¦æŠŠæäº¤ï¼ˆCommitï¼‰é˜¶æ®µå’Œ commit è¯­å¥æ··æ·†äº†ï¼Œcommit è¯­å¥æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šåŒ…å«æäº¤ï¼ˆCommitï¼‰é˜¶æ®µ



å‚è€ƒ[ä¸¤é˜¶æ®µæäº¤çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„?](https://xiaolincoding.com/mysql/log/how_update.html#%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E7%9A%84%E8%BF%87%E7%A8%8B%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84)



ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆTwo-Phase Commit Protocol, 2PCï¼‰æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿è¯äº‹åŠ¡çš„åŸå­æ€§å’Œä¸€è‡´æ€§çš„åè®®ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œäº‹åŠ¡å¯èƒ½ä¼šè·¨è¶Šå¤šä¸ªèŠ‚ç‚¹ï¼Œè€Œè¿™äº›èŠ‚ç‚¹ä¹‹é—´éœ€è¦åè°ƒä»¥ä¿è¯äº‹åŠ¡çš„æ­£ç¡®æ€§ã€‚ä¸¤é˜¶æ®µæäº¤åè®®å°±æ˜¯ç”¨æ¥åè°ƒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹åŠ¡çš„ã€‚

ä¸¤é˜¶æ®µæäº¤åè®®åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œäº‹åŠ¡åè°ƒå™¨ï¼ˆTransaction Coordinatorï¼‰ä¼šå‘**æ‰€æœ‰å‚ä¸è€…**ï¼ˆParticipantï¼‰å‘é€å‡†å¤‡è¯·æ±‚ï¼Œè¯¢é—®å‚ä¸è€…æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æ“ä½œã€‚å¦‚æœå‚ä¸è€…å¯ä»¥æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œåˆ™ä¼šå‘äº‹åŠ¡åè°ƒå™¨å‘é€â€œåŒæ„â€å“åº”ï¼Œå¦åˆ™ä¼šå‘é€â€œä¸­æ­¢â€å“åº”ã€‚

ç¬¬äºŒé˜¶æ®µï¼šæäº¤é˜¶æ®µã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œ**å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½åŒæ„æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œåˆ™äº‹åŠ¡åè°ƒå™¨ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€æäº¤è¯·æ±‚ï¼Œè¦æ±‚å®ƒä»¬æ‰§è¡Œäº‹åŠ¡æ“ä½œã€‚å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªå‚ä¸è€…å‘é€äº†â€œä¸­æ­¢â€å“åº”ï¼Œåˆ™äº‹åŠ¡åè°ƒå™¨ä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€å›æ»šè¯·æ±‚ï¼Œè¦æ±‚å®ƒä»¬å›æ»šäº‹åŠ¡æ“ä½œã€‚**

ä¸¤é˜¶æ®µæäº¤åè®®çš„ä¼˜ç‚¹æ˜¯å¯ä»¥ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­äº‹åŠ¡çš„åŸå­æ€§å’Œä¸€è‡´æ€§ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µä¸­ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½ä¼šå…ˆè¿›è¡Œå‡†å¤‡æ“ä½œï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰å‚ä¸è€…éƒ½å¯ä»¥æ‰§è¡Œäº‹åŠ¡æ“ä½œã€‚åœ¨ç¬¬äºŒé˜¶æ®µä¸­ï¼Œå¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½åŒæ„æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œåˆ™å¯ä»¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªå‚ä¸è€…æ— æ³•æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œåˆ™å…¨éƒ¨å›æ»šï¼Œä¿è¯äº‹åŠ¡çš„åŸå­æ€§ã€‚





å¦ä¸€ç§ç†è§£ï¼š :exclamation:

2PCï¼Œæ˜¯ Two-Phase-Comimit çš„ç¼©å†™ï¼Œå³ã€Œ**äºŒé˜¶æ®µæäº¤**ã€ï¼Œæ˜¯è®¡ç®—æœºç½‘ç»œå°¤å…¶æ˜¯æ•°æ®åº“é¢†åŸŸå†…ï¼Œä¸ºäº†ä½¿åŸºäºåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„çš„æ‰€æœ‰èŠ‚ç‚¹åœ¨è¿›è¡Œ**äº‹åŠ¡å¤„ç†**è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒåŸå­æ€§å’Œä¸€è‡´æ€§è€Œè®¾è®¡çš„ä¸€ç§åè®®ã€‚ç°åœ¨å¾ˆå¤šæ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨çš„äºŒé˜¶æ®µæäº¤åè®®æ¥å®Œæˆ**åˆ†å¸ƒå¼äº‹åŠ¡**çš„å¤„ç†ã€‚äºŒé˜¶æ®µï¼Œé¡¾åæ€ä¹‰å°±æ˜¯åˆ†ä¸¤ä¸ªé˜¶æ®µå¤„ç†äº‹åŠ¡ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

é˜¶æ®µä¸€ï¼šæäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆâ€æŠ•ç¥¨é˜¶æ®µâ€œï¼‰

å½“è¦æ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡å‘èµ·è€…é¦–å…ˆå‘åè°ƒè€… `Coordinator` å‘èµ·äº‹åŠ¡è¯·æ±‚ï¼Œç„¶ååè°ƒè€…ä¼šç»™æ‰€æœ‰å‚ä¸è€…   `Participant` å‘é€ `prepare` è¯·æ±‚ï¼ˆå…¶ä¸­åŒ…æ‹¬äº‹åŠ¡å†…å®¹ï¼‰å‘Šè¯‰å‚ä¸è€…ä½ ä»¬éœ€è¦æ‰§è¡Œäº‹åŠ¡äº†ï¼Œ**å¦‚æœèƒ½æ‰§è¡Œæˆ‘å‘çš„äº‹åŠ¡å†…å®¹é‚£ä¹ˆå°±å…ˆæ‰§è¡Œä½†ä¸æäº¤ï¼Œæ‰§è¡Œåè¯·ç»™æˆ‘å›å¤**ã€‚ç„¶åå‚ä¸è€…æ”¶åˆ° `prepare` æ¶ˆæ¯åï¼Œä»–ä»¬ä¼šå¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼ˆä½†ä¸æäº¤ï¼‰ï¼Œå¹¶å°† `Undo` å’Œ `Redo` ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œä¹‹åå‚ä¸è€…å°±å‘åè°ƒè€…åé¦ˆæ˜¯å¦å‡†å¤‡å¥½äº†



é˜¶æ®µäºŒï¼šæ‰§è¡Œäº‹åŠ¡æäº¤

åè°ƒè€…æ ¹æ®å„å‚ä¸è€…çš„åé¦ˆæƒ…å†µå†³å®šæœ€ç»ˆæ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡ï¼Œ**å¦‚æœåé¦ˆéƒ½æ˜¯Yesï¼Œå‘é€æäº¤ `commit` è¯·æ±‚**ï¼Œå‚ä¸è€…æäº¤æˆåŠŸåè¿”å› `Ack` æ¶ˆæ¯ï¼Œåè°ƒè€…æ¥æ”¶åå°±å®Œæˆäº†ã€‚**å¦‚æœåé¦ˆæ˜¯ No æˆ–è€…è¶…æ—¶æœªåé¦ˆï¼Œå‘é€ `Rollback` è¯·æ±‚**ï¼Œåˆ©ç”¨é˜¶æ®µä¸€è®°å½•è¡¨çš„ `Undo` ä¿¡æ¯æ‰§è¡Œå›æ»šï¼Œå¹¶åé¦ˆç»™åè°ƒè€… `Ack` ï¼Œä¸­æ–­æ¶ˆæ¯





ç¼ºç‚¹å¦‚ä¸‹ï¼š

- **å•ç‚¹æ•…éšœé—®é¢˜**ï¼Œå¦‚æœåè°ƒè€…æŒ‚äº†é‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿéƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€äº†
- **é˜»å¡é—®é¢˜**ï¼Œå³å½“åè°ƒè€…å‘é€ `prepare` è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå¦‚æœèƒ½å¤„ç†é‚£ä¹ˆå®ƒå°†ä¼šè¿›è¡Œäº‹åŠ¡çš„å¤„ç†ä½†å¹¶ä¸æäº¤ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä¸€ç›´å ç”¨ç€èµ„æºä¸é‡Šæ”¾ï¼Œå¦‚æœæ­¤æ—¶åè°ƒè€…æŒ‚äº†ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºéƒ½ä¸ä¼šå†é‡Šæ”¾äº†ï¼Œè¿™ä¼šæå¤§å½±å“æ€§èƒ½
- **æ•°æ®ä¸ä¸€è‡´é—®é¢˜**ï¼Œæ¯”å¦‚å½“ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…åªå‘é€äº†ä¸€éƒ¨åˆ†çš„ `commit` è¯·æ±‚å°±æŒ‚äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼Œæ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œè€Œåé¢æ²¡æ”¶åˆ°çš„åˆ™ä¸ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜











## å­˜å‚¨å¼•æ“å¯¹æ¯”

1.äº‹åŠ¡æ”¯æŒï¼š

- MyISAMï¼šMyISAMå­˜å‚¨å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ï¼Œå®ƒä½¿ç”¨è¡¨çº§é”å®šï¼ˆTable-level lockingï¼‰æ¥å¤„ç†å¹¶å‘è®¿é—®ã€‚è¿™æ„å‘³ç€åœ¨æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šé”å®šæ•´ä¸ªè¡¨ï¼Œå¯èƒ½å¯¼è‡´å¹¶å‘æ€§èƒ½ä¸‹é™å’Œæ•°æ®å†²çª
- InnoDBï¼š**InnoDBå­˜å‚¨å¼•æ“æ”¯æŒäº‹åŠ¡**ï¼Œå®ƒ**ä½¿ç”¨è¡Œçº§é”å®š**ï¼ˆRow-level lockingï¼‰ï¼Œå¯ä»¥å®ç°æ›´å¥½çš„å¹¶å‘æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ã€‚InnoDBæ”¯æŒACIDï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ï¼‰å±æ€§ï¼Œå¯ä»¥ç¡®ä¿äº‹åŠ¡çš„åŸå­æ€§å’Œæ•°æ®çš„å®Œæ•´æ€§

2.å¹¶å‘æ€§èƒ½:

- MyISAMï¼šç”±äºä½¿ç”¨è¡¨çº§é”å®šï¼ŒMyISAMåœ¨å¹¶å‘å†™å…¥åœºæ™¯ä¸‹æ€§èƒ½å¯èƒ½å—åˆ°è¾ƒå¤§å½±å“ã€‚å¹¶å‘å†™å…¥å¯èƒ½ä¼šå¯¼è‡´é”å†²çªï¼Œéœ€è¦ç­‰å¾…å…¶ä»–äº‹åŠ¡å®Œæˆæ‰èƒ½æ‰§è¡Œ
- InnoDBï¼šInnoDBä½¿ç”¨è¡Œçº§é”å®šï¼Œæ”¯æŒæ›´é«˜çš„å¹¶å‘æ€§èƒ½ã€‚å®ƒå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå¹¶å‘äº‹åŠ¡çš„è¯»å†™æ“ä½œï¼Œå‡å°‘äº†é”å†²çªçš„å¯èƒ½æ€§ï¼Œæé«˜äº†å¹¶å‘æ€§èƒ½

3.æ•°æ®å®Œæ•´æ€§ï¼š

- MyISAMï¼šMyISAMå­˜å‚¨å¼•æ“ä¸æä¾›å¤–é”®çº¦æŸå’Œå´©æºƒæ¢å¤æœºåˆ¶ã€‚å®ƒæ²¡æœ‰å†…ç½®çš„æ•…éšœæ¢å¤æœºåˆ¶ï¼Œå½“å‡ºç°å´©æºƒæˆ–æ–­ç”µç­‰æ•…éšœæ—¶ï¼Œæ•°æ®å¯èƒ½ä¼šæŸåæˆ–ä¸¢å¤±ã€‚æ— `redolog`
- InnoDBï¼šInnoDBå­˜å‚¨å¼•æ“æ”¯æŒå¤–é”®çº¦æŸã€äº‹åŠ¡å’Œå´©æºƒæ¢å¤æœºåˆ¶ã€‚å®ƒå¯ä»¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ï¼Œå¹¶æä¾›äº†äº‹åŠ¡å›æ»šå’Œå´©æºƒæ¢å¤çš„èƒ½åŠ›ã€‚æœ‰`redolog`





## é¢„è¯»å¤±æ•ˆ & `BufferPool` æ±¡æŸ“

æˆ‘ä»¬éƒ½çŸ¥é“ï¼šç®€å•çš„ LRU ç®—æ³•å¹¶æ²¡æœ‰è¢« MySQL ä½¿ç”¨ï¼Œå› ä¸ºç®€å•çš„ LRU ç®—æ³•æ— æ³•é¿å…ä¸‹é¢è¿™ä¸¤ä¸ªé—®é¢˜

- é¢„è¯»å¤±æ•ˆï¼›
- Buffer Pool æ±¡æŸ“ï¼›

> ä»€ä¹ˆæ˜¯é¢„è¯»å¤±æ•ˆï¼Ÿ

å…ˆæ¥è¯´è¯´ MySQL çš„é¢„è¯»æœºåˆ¶ã€‚ç¨‹åºæ˜¯æœ‰ç©ºé—´å±€éƒ¨æ€§çš„ï¼Œé è¿‘å½“å‰è¢«è®¿é—®æ•°æ®çš„æ•°æ®ï¼Œåœ¨æœªæ¥å¾ˆå¤§æ¦‚ç‡ä¼šè¢«è®¿é—®åˆ°ã€‚æ‰€ä»¥ï¼Œ**MySQL åœ¨åŠ è½½æ•°æ®é¡µæ—¶ï¼Œä¼šæå‰æŠŠå®ƒç›¸é‚»çš„æ•°æ®é¡µä¸€å¹¶åŠ è½½è¿›æ¥**ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘ç£ç›˜ IOã€‚

ä½†æ˜¯å¯èƒ½è¿™äº›**è¢«æå‰åŠ è½½è¿›æ¥çš„æ•°æ®é¡µï¼Œå¹¶æ²¡æœ‰è¢«è®¿é—®**ï¼Œç›¸å½“äºè¿™ä¸ªé¢„è¯»æ˜¯ç™½åšäº†ï¼Œè¿™ä¸ªå°±æ˜¯**é¢„è¯»å¤±æ•ˆ**ã€‚

å¦‚æœä½¿ç”¨ç®€å•çš„ LRU ç®—æ³•ï¼Œå°±ä¼šæŠŠé¢„è¯»é¡µæ”¾åˆ° LRU é“¾è¡¨å¤´éƒ¨ï¼Œè€Œå½“ Buffer Poolç©ºé—´ä¸å¤Ÿçš„æ—¶å€™ï¼Œè¿˜éœ€è¦æŠŠæœ«å°¾çš„é¡µæ·˜æ±°æ‰ã€‚

å¦‚æœè¿™äº›é¢„è¯»é¡µå¦‚æœä¸€ç›´ä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œå°±ä¼šå‡ºç°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œä¸ä¼šè¢«è®¿é—®çš„é¢„è¯»é¡µå´å ç”¨äº† LRU é“¾è¡¨å‰æ’çš„ä½ç½®ï¼Œè€Œæœ«å°¾æ·˜æ±°çš„é¡µï¼Œå¯èƒ½æ˜¯é¢‘ç¹è®¿é—®çš„é¡µï¼Œè¿™æ ·å°±å¤§å¤§é™ä½äº†ç¼“å­˜å‘½ä¸­ç‡ã€‚



InnoDB å¯¹ LRU åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ LRU ç®—æ³•é€šå¸¸æ˜¯å°†æœ€è¿‘æŸ¥è¯¢çš„æ•°æ®æ”¾åˆ° LRU é“¾è¡¨çš„å¤´éƒ¨ï¼Œè€Œ InnoDB åš 2 ç‚¹ä¼˜åŒ–ï¼š

- å°† LRU é“¾è¡¨ åˆ†ä¸º**young å’Œ old ä¸¤ä¸ªåŒºåŸŸ**ï¼Œ**åˆ’åˆ†è¿™ä¸¤ä¸ªåŒºåŸŸåï¼Œé¢„è¯»çš„é¡µå°±åªéœ€è¦åŠ å…¥åˆ° old åŒºåŸŸçš„å¤´éƒ¨ï¼Œå½“é¡µè¢«çœŸæ­£è®¿é—®çš„æ—¶å€™ï¼Œæ‰å°†é¡µæ’å…¥ young åŒºåŸŸçš„å¤´éƒ¨**ã€‚å¦‚æœé¢„è¯»çš„é¡µä¸€ç›´æ²¡æœ‰è¢«è®¿é—®ï¼Œå°±ä¼šä» old åŒºåŸŸç§»é™¤ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“ young åŒºåŸŸä¸­çš„çƒ­ç‚¹æ•°æ®ã€‚



> ä»€ä¹ˆæ˜¯`BufferPool`æ±¡æŸ“ï¼Ÿ

å½“æŸä¸€ä¸ªSQL è¯­å¥æ‰«æäº†å¤§é‡çš„æ•°æ®æ—¶ï¼Œåœ¨Buffer Pool ç©ºé—´æ¯”è¾ƒæœ‰é™çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå°†Buffer Pool é‡Œçš„æ‰€æœ‰é¡µéƒ½æ›¿æ¢å‡ºå»ï¼Œå¯¼è‡´å¤§é‡çƒ­æ•°æ®è¢«æ·˜æ±°äº†ï¼Œç­‰è¿™äº›çƒ­æ•°æ®åˆè¢«å†æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œç”±äºç¼“å­˜æœªå‘½ä¸­ï¼Œå°±ä¼šäº§ç”Ÿå¤§é‡çš„ç£ç›˜IOï¼ŒMySQL æ€§èƒ½å°±ä¼šæ€¥å‰§ä¸‹é™ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºBuffer Pool æ±¡æŸ“ã€‚









## æ•°æ®å­˜å‚¨ :cat::kissing_cat::smile_cat:

> ä»¥ä¸‹å†…å®¹å‡é’ˆå¯¹çš„æ˜¯`innodb`å­˜å‚¨å¼•æ“

æ¯åˆ›å»ºä¸€ä¸ª `database`ï¼ˆæ•°æ®åº“ï¼‰ï¼Œéƒ½ä¼šåœ¨ /var/lib/mysql/ ç›®å½•é‡Œé¢åˆ›å»ºä¸€ä¸ªä»¥ database ä¸ºåçš„ç›®å½•ï¼Œç„¶åä¿å­˜è¡¨ç»“æ„å’Œè¡¨æ•°æ®çš„æ–‡ä»¶éƒ½ä¼šå­˜æ”¾åœ¨è¿™ä¸ªç›®å½•é‡Œï¼Œè¯¥ç›®å½•ä¸‹ä¸€èˆ¬æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼š

- `db.opt`ï¼šç”¨æ¥å­˜å‚¨å½“å‰æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†å’Œå­—ç¬¦æ ¡éªŒè§„åˆ™
- `t_order.frm`ï¼št_order çš„**è¡¨ç»“æ„**ä¼šä¿å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ã€‚åœ¨ `MySQL` ä¸­å»ºç«‹ä¸€å¼ è¡¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ª.frm æ–‡ä»¶ï¼Œ**è¯¥æ–‡ä»¶æ˜¯ç”¨æ¥ä¿å­˜æ¯ä¸ªè¡¨çš„å…ƒæ•°æ®ä¿¡æ¯çš„ï¼Œä¸»è¦åŒ…å«è¡¨ç»“æ„å®šä¹‰**
- `t_order.ibd`ï¼št_order çš„**è¡¨æ•°æ®**ä¼šä¿å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ã€‚è¡¨æ•°æ®æ—¢å¯ä»¥å­˜åœ¨å…±äº«è¡¨ç©ºé—´æ–‡ä»¶ï¼ˆæ–‡ä»¶åï¼šibdata1ï¼‰é‡Œï¼Œä¹Ÿå¯ä»¥å­˜æ”¾åœ¨ç‹¬å è¡¨ç©ºé—´æ–‡ä»¶ï¼ˆæ–‡ä»¶åï¼šè¡¨åå­—.ibdï¼‰ã€‚è¿™ä¸ªè¡Œä¸ºæ˜¯ç”±å‚æ•° `innodb_file_per_table` æ§åˆ¶çš„ï¼Œè‹¥è®¾ç½®äº†å‚æ•° `innodb_file_per_table` ä¸º 1ï¼Œåˆ™ä¼šå°†å­˜å‚¨çš„æ•°æ®ã€ç´¢å¼•ç­‰ä¿¡æ¯å•ç‹¬å­˜å‚¨åœ¨ä¸€ä¸ªç‹¬å è¡¨ç©ºé—´ï¼Œä» MySQL 5.6.6 ç‰ˆæœ¬å¼€å§‹ï¼Œå®ƒçš„é»˜è®¤å€¼å°±æ˜¯ 1 äº†ï¼Œå› æ­¤ä»è¿™ä¸ªç‰ˆæœ¬ä¹‹åï¼Œ **MySQL ä¸­æ¯ä¸€å¼ è¡¨çš„æ•°æ®éƒ½å­˜æ”¾åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ .ibd æ–‡ä»¶**,è¿™ä¸ªæ–‡ä»¶ä¹Ÿç§°ä¸ºç‹¬å è¡¨ç©ºé—´æ–‡ä»¶ (**`innodb`ä¸­`ibd`æ–‡ä»¶åŒ…å«äº†è¡¨æ•°æ®å’Œç´¢å¼•**ï¼Œè€Œ`myisam`ä¸­è¡¨çš„æ•°æ®å’Œç´¢å¼•åˆ™åˆ†åˆ«å­˜å‚¨åœ¨ `.MYD` å’Œ `.MYI` æ–‡ä»¶ä¸­)â€”â€”â€”â€”â€”â€”`MyIsam`ä¸­è¡¨æ•°æ®å’Œç´¢å¼•åˆ†å¼€å­˜å‚¨ï¼Œ`Innodb`ä¸æ˜¯





`InnoDB` å­˜å‚¨å¼•æ“ä½¿ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸ºâ€œè¡¨ç©ºé—´â€çš„æ–‡ä»¶ç»„ç»‡æ–¹å¼æ¥**å­˜å‚¨è¡¨çš„æ•°æ®å’Œç´¢å¼•**ã€‚

**è¡¨ç©ºé—´ç”±æ®µï¼ˆ`segment`ï¼‰ã€åŒºï¼ˆ`extent`ï¼‰ã€é¡µï¼ˆ`page`ï¼‰ã€è¡Œï¼ˆ`row`ï¼‰ç»„æˆ**ï¼Œ**InnoDB**å­˜å‚¨å¼•æ“çš„é€»è¾‘å­˜å‚¨ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾ï¼š<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%A1%A8%E7%A9%BA%E9%97%B4%E7%BB%93%E6%9E%84.drawio.webp"  />

1ã€è¡Œï¼šæ•°æ®åº“è¡¨ä¸­çš„è®°å½•éƒ½æ˜¯æŒ‰è¡Œï¼ˆrowï¼‰è¿›è¡Œå­˜æ”¾çš„ï¼Œæ¯è¡Œè®°å½•æ ¹æ®ä¸åŒçš„è¡Œæ ¼å¼ï¼Œæœ‰ä¸åŒçš„å­˜å‚¨ç»“æ„

2ã€é¡µï¼š**è®°å½•æ˜¯æŒ‰ç…§è¡Œæ¥å­˜å‚¨çš„ï¼Œä½†æ˜¯æ•°æ®åº“çš„è¯»å–å¹¶ä¸ä»¥ã€Œè¡Œã€ä¸ºå•ä½ï¼Œå¦åˆ™ä¸€æ¬¡è¯»å–ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¬¡ I/O æ“ä½œï¼‰åªèƒ½å¤„ç†ä¸€è¡Œæ•°æ®ï¼Œæ•ˆç‡ä¼šéå¸¸ä½**ï¼Œ**InnoDB çš„æ•°æ®æ˜¯æŒ‰ã€Œé¡µã€ä¸ºå•ä½æ¥è¯»å†™çš„**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ**å½“éœ€è¦è¯»ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯å°†è¿™ä¸ªè¡Œè®°å½•ä»ç£ç›˜è¯»å‡ºæ¥ï¼Œè€Œæ˜¯ä»¥é¡µä¸ºå•ä½ï¼Œå°†å…¶æ•´ä½“è¯»å…¥å†…å­˜**,**é»˜è®¤æ¯ä¸ªé¡µçš„å¤§å°ä¸º 16KB**,æ„å‘³ç€æ•°æ®åº“æ¯æ¬¡è¯»å†™éƒ½æ˜¯ä»¥ 16KB ä¸ºå•ä½çš„ï¼Œä¸€æ¬¡æœ€å°‘ä»ç£ç›˜ä¸­è¯»å– 16KB çš„å†…å®¹åˆ°å†…å­˜ä¸­ï¼Œä¸€æ¬¡æœ€å°‘æŠŠå†…å­˜ä¸­çš„ 16K å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ä¸­

3ã€åŒºï¼š`InnoDB` å­˜å‚¨å¼•æ“æ˜¯ç”¨ B+ æ ‘æ¥ç»„ç»‡æ•°æ®,**B+ æ ‘æ¯ä¸€å±‚ä¸­çš„ç›¸é‚»é¡µéƒ½æ˜¯é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥èµ·æ¥çš„**ï¼Œ**å¦‚æœæ˜¯ä»¥é¡µä¸ºå•ä½æ¥åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œé‚£ä¹ˆé“¾è¡¨ä¸­ç›¸é‚»çš„ä¸¤ä¸ªé¡µä¹‹é—´çš„ç‰©ç†ä½ç½®å¹¶ä¸æ˜¯è¿ç»­çš„ï¼Œå¯èƒ½ç¦»å¾—éå¸¸è¿œï¼Œé‚£ä¹ˆç£ç›˜æŸ¥è¯¢æ—¶å°±ä¼šæœ‰å¤§é‡çš„éšæœºI/O,é‚£ä¹ˆè®©é“¾è¡¨ä¸­ç›¸é‚»çš„é¡µçš„ç‰©ç†ä½ç½®ä¹Ÿç›¸é‚»ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨é¡ºåº I/O äº†**ï¼Œ**ä¸ºæŸä¸ªç´¢å¼•åˆ†é…ç©ºé—´çš„æ—¶å€™å°±ä¸å†æŒ‰ç…§é¡µä¸ºå•ä½åˆ†é…äº†ï¼Œè€Œæ˜¯æŒ‰ç…§åŒºï¼ˆ`extent`ï¼‰ä¸ºå•ä½åˆ†é…ã€‚æ¯ä¸ªåŒºçš„å¤§å°ä¸º 1MBï¼Œå¯¹äº 16KB çš„é¡µæ¥è¯´ï¼Œè¿ç»­çš„ 64 ä¸ªé¡µä¼šè¢«åˆ’ä¸ºä¸€ä¸ªåŒºï¼Œè¿™æ ·å°±ä½¿å¾—é“¾è¡¨ä¸­ç›¸é‚»çš„é¡µçš„ç‰©ç†ä½ç½®ä¹Ÿç›¸é‚»ï¼Œå°±èƒ½ä½¿ç”¨é¡ºåº I/O äº†**

4ã€æ®µï¼šè¡¨ç©ºé—´æ˜¯ç”±å„ä¸ªæ®µï¼ˆ`segment`ï¼‰ç»„æˆçš„ï¼Œæ®µæ˜¯ç”±å¤šä¸ªåŒºï¼ˆ`extent`ï¼‰ç»„æˆçš„ï¼Œ**æ®µä¸€èˆ¬åˆ†ä¸ºæ•°æ®æ®µã€ç´¢å¼•æ®µå’Œå›æ»šæ®µ**ç­‰

- ç´¢å¼•æ®µï¼šå­˜æ”¾ B + æ ‘çš„éå¶å­èŠ‚ç‚¹çš„åŒºçš„é›†åˆï¼›
- æ•°æ®æ®µï¼šå­˜æ”¾ B + æ ‘çš„å¶å­èŠ‚ç‚¹çš„åŒºçš„é›†åˆï¼›
- `undolog` å›æ»šæ®µï¼šå­˜æ”¾çš„æ˜¯å›æ»šæ•°æ®çš„åŒºçš„é›†åˆï¼Œ`äº‹åŠ¡éš”ç¦» (opens new window)`ä¸­çš„ `MVCC` åˆ©ç”¨äº†å›æ»šæ®µå®ç°äº†å¤šç‰ˆæœ¬æŸ¥è¯¢æ•°æ®



> æ€»ç»“ä¸€ä¸‹ï¼š
>
> - `Innodb`ä½¿ç”¨è¡¨ç©ºé—´æ¥å­˜å‚¨è¡¨æ•°æ®å’Œè¡¨ç´¢å¼•ï¼Œè¡¨çš„ç»“æ„å®šä¹‰åˆ™å­˜å‚¨åœ¨`MySQL`çš„ç³»ç»Ÿè¡¨ä¸­
> - `InnoDB` å­˜å‚¨å¼•æ“ä¼šä»¥åŒºä¸ºå•ä½è¿›è¡Œåˆ†é…ï¼Œ**æ¯ä¸ªåŒºçš„å¤§å°ä¸º 1MBï¼Œå¯¹äº 16KB çš„é¡µæ¥è¯´ï¼Œè¿ç»­çš„ 64 ä¸ªé¡µä¼šè¢«åˆ’ä¸ºä¸€ä¸ªåŒºï¼Œè¿™æ ·å°±ä½¿å¾—é“¾è¡¨ä¸­ç›¸é‚»çš„é¡µçš„ç‰©ç†ä½ç½®ä¹Ÿç›¸é‚»ï¼Œå°±èƒ½ä½¿ç”¨é¡ºåº I/O äº†**ï¼ŒæŒ‰é¡µåˆ†é…çš„è¯ï¼ŒB+æ ‘ä¸­ç›¸é‚»çš„é¡µ(èŠ‚ç‚¹)ï¼ŒOSåœ¨ä¾æ¬¡ç»™è¿™äº›ç›¸é‚»é¡µåˆ†é…ç£ç›˜ç©ºé—´æ—¶ä¸ä¸€å®šæ˜¯èƒ½åˆ†é…åˆ°ç›¸é‚»çš„ä½ç½®
> - `InnoDB` çš„æ•°æ®æ˜¯æŒ‰ã€Œé¡µã€ä¸ºå•ä½æ¥è¯»å†™çš„





### `InnoDB`å¦‚ä½•å­˜å‚¨æ•°æ® (æ•°æ®é¡µçš„è§’åº¦)

**InnoDB**ä¸­è®°å½•æ˜¯æŒ‰è¡Œæ¥å­˜å‚¨çš„ï¼Œä½†æ˜¯æ•°æ®åº“çš„è¯»å–å¹¶ä¸ä»¥ã€Œè¡Œã€ä¸ºå•ä½ï¼Œå¦åˆ™ä¸€æ¬¡è¯»å–ï¼ˆä¹Ÿå°±æ˜¯ä¸€æ¬¡ I/O æ“ä½œï¼‰åªèƒ½å¤„ç†ä¸€è¡Œæ•°æ®ï¼Œæ•°æ®åº“çš„è¯»å–æ˜¯æŒ‰**ã€Œæ•°æ®é¡µã€ä¸ºå•ä½æ¥è¯»å†™çš„**ï¼Œ I/O æ“ä½œçš„æœ€å°å•ä½æ˜¯é¡µï¼Œ**InnoDB æ•°æ®é¡µçš„é»˜è®¤å¤§å°æ˜¯ 16KB**ï¼Œæ„å‘³ç€æ•°æ®åº“æ¯æ¬¡è¯»å†™éƒ½æ˜¯ä»¥ 16KB ä¸ºå•ä½çš„ï¼Œä¸€æ¬¡æœ€å°‘ä»ç£ç›˜ä¸­è¯»å– 16KB çš„å†…å®¹åˆ°å†…å­˜ä¸­ï¼Œä¸€æ¬¡æœ€å°‘æŠŠå†…å­˜ä¸­çš„ 16KB å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ä¸­

æ¯ä¸ªæ•°æ®é¡µä¸­çš„`File Header` å¤„æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ä¸Šä¸€ä¸ªæ•°æ®é¡µå’Œä¸‹ä¸€ä¸ªæ•°æ®é¡µï¼Œè¿æ¥èµ·æ¥çš„é¡µç›¸å½“äºä¸€ä¸ªåŒå‘çš„é“¾è¡¨(B+æ ‘æ¯å±‚éƒ½æ˜¯åŒå‘é“¾è¡¨)ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%95%B0%E6%8D%AE%E9%A1%B5.webp" style="zoom:80%;" />

é‡‡ç”¨é“¾è¡¨çš„ç»“æ„æ˜¯è®©æ•°æ®é¡µä¹‹é—´ä¸éœ€è¦æ˜¯ç‰©ç†ä¸Šçš„è¿ç»­çš„ï¼Œè€Œæ˜¯é€»è¾‘ä¸Šçš„è¿ç»­

é¡µç›®å½•(èµ·åˆ°ç´¢å¼•ä½œç”¨)ä¸æ¯æ¡è¡Œè®°å½•`Record`çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E9%A1%B5%E7%9B%AE%E5%BD%95%E4%B8%8E%E8%AE%B0%E5%BD%95%E5%85%B3%E7%B3%BB.webp" style="zoom:80%;" />

é¡µç›®å½•åˆ›å»ºçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å°†æ‰€æœ‰çš„è®°å½•åˆ’åˆ†æˆå‡ ä¸ªç»„ï¼Œè¿™äº›è®°å½•åŒ…æ‹¬æœ€å°è®°å½•å’Œæœ€å¤§è®°å½•ï¼Œä½†ä¸åŒ…æ‹¬æ ‡è®°ä¸ºâ€œå·²åˆ é™¤â€çš„è®°å½•ï¼›
2. æ¯ä¸ªè®°å½•ç»„çš„æœ€åä¸€æ¡è®°å½•å°±æ˜¯ç»„å†…æœ€å¤§çš„é‚£æ¡è®°å½•ï¼Œå¹¶ä¸”æœ€åä¸€æ¡è®°å½•çš„å¤´ä¿¡æ¯ä¸­ä¼šå­˜å‚¨è¯¥ç»„ä¸€å…±æœ‰å¤šå°‘æ¡è®°å½•ï¼Œä½œä¸º `n_owned` å­—æ®µï¼ˆä¸Šå›¾ä¸­ç²‰çº¢è‰²å­—æ®µï¼‰
3. **é¡µç›®å½•ç”¨æ¥å­˜å‚¨æ¯ç»„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡**ï¼Œè¿™äº›åœ°å€åç§»é‡ä¼šæŒ‰ç…§å…ˆåé¡ºåºå­˜å‚¨èµ·æ¥ï¼Œæ¯ç»„çš„åœ°å€åç§»é‡ä¹Ÿè¢«ç§°ä¹‹ä¸ºæ§½ï¼ˆslotï¼‰ï¼Œ**æ¯ä¸ªæ§½ç›¸å½“äºæŒ‡é’ˆæŒ‡å‘äº†ä¸åŒç»„çš„æœ€åä¸€ä¸ªè®°å½•**ã€‚

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ**é¡µç›®å½•å°±æ˜¯ç”±å¤šä¸ªæ§½ç»„æˆçš„ï¼Œæ§½ç›¸å½“äºåˆ†ç»„è®°å½•çš„ç´¢å¼•**ã€‚ç„¶åï¼Œå› ä¸ºè®°å½•æ˜¯æŒ‰ç…§ã€Œä¸»é”®å€¼ã€ä»å°åˆ°å¤§æ’åºçš„ï¼Œæ‰€ä»¥**æˆ‘ä»¬é€šè¿‡æ§½æŸ¥æ‰¾è®°å½•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨äºŒåˆ†æ³•å¿«é€Ÿå®šä½è¦æŸ¥è¯¢çš„è®°å½•åœ¨å“ªä¸ªæ§½ï¼ˆå“ªä¸ªè®°å½•åˆ†ç»„ï¼‰ï¼Œå®šä½åˆ°æ§½åï¼Œå†éå†æ§½å†…çš„æ‰€æœ‰è®°å½•ï¼Œæ‰¾åˆ°å¯¹åº”çš„è®°å½•**ï¼Œæ— éœ€ä»æœ€å°è®°å½•å¼€å§‹éå†æ•´ä¸ªé¡µä¸­çš„è®°å½•é“¾è¡¨

ä»¥ä¸Šé¢é‚£å¼ å›¾ä¸¾ä¸ªä¾‹å­ï¼Œ5 ä¸ªæ§½çš„ç¼–å·åˆ†åˆ«ä¸º 0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œæˆ‘æƒ³æŸ¥æ‰¾ä¸»é”®ä¸º 11 çš„ç”¨æˆ·è®°å½•ï¼š

- å…ˆäºŒåˆ†å¾—å‡ºæ§½ä¸­é—´ä½æ˜¯ (0+4)/2=2 ï¼Œ2å·æ§½é‡Œæœ€å¤§çš„è®°å½•ä¸º 8ã€‚å› ä¸º 11 > 8ï¼Œæ‰€ä»¥éœ€è¦ä» 2 å·æ§½åç»§ç»­æœç´¢è®°å½•ï¼›
- å†ä½¿ç”¨äºŒåˆ†æœç´¢å‡º 2 å·å’Œ 4 æ§½çš„ä¸­é—´ä½æ˜¯ (2+4)/2= 3ï¼Œ3 å·æ§½é‡Œæœ€å¤§çš„è®°å½•ä¸º 12ã€‚å› ä¸º 11 < 12ï¼Œæ‰€ä»¥ä¸»é”®ä¸º 11 çš„è®°å½•åœ¨ 3 å·æ§½é‡Œï¼›
- è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œ**ã€Œæ§½å¯¹åº”çš„å€¼éƒ½æ˜¯è¿™ä¸ªç»„çš„ä¸»é”®æœ€å¤§çš„è®°å½•ï¼Œå¦‚ä½•æ‰¾åˆ°ç»„é‡Œæœ€å°çš„è®°å½•ã€**ï¼Ÿæ¯”å¦‚æ§½ 3 å¯¹åº”æœ€å¤§ä¸»é”®æ˜¯ 12 çš„è®°å½•ï¼Œé‚£å¦‚ä½•æ‰¾åˆ°æœ€å°è®°å½• 9ã€‚è§£å†³åŠæ³•æ˜¯ï¼šé€šè¿‡æ§½ 3 æ‰¾åˆ° æ§½ 2 å¯¹åº”çš„è®°å½•ï¼Œä¹Ÿå°±æ˜¯ä¸»é”®ä¸º 8 çš„è®°å½•ã€‚ä¸»é”®ä¸º 8 çš„è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•å°±æ˜¯æ§½ 3 å½“ä¸­ä¸»é”®æœ€å°çš„ 9 è®°å½•ï¼Œç„¶åå¼€å§‹å‘ä¸‹æœç´¢ 2 æ¬¡ï¼Œå®šä½åˆ°ä¸»é”®ä¸º 11 çš„è®°å½•ï¼Œå–å‡ºè¯¥æ¡è®°å½•çš„ä¿¡æ¯å³ä¸ºæˆ‘ä»¬æƒ³è¦æŸ¥æ‰¾çš„å†…å®¹ã€‚



### B+æ ‘å¦‚ä½•è¿›è¡ŒæŸ¥è¯¢

åœ¨ä¸€ä¸ªæ•°æ®é¡µä¸­è¿›è¡Œè®°å½•æ£€ç´¢æ—¶ï¼šå› ä¸ºä¸€ä¸ªæ•°æ®é¡µä¸­çš„è®°å½•æ˜¯æœ‰é™çš„ï¼Œä¸”ä¸»é”®å€¼æœ‰åºï¼Œæ‰€ä»¥é€šè¿‡å¯¹æ‰€æœ‰è®°å½•è¿›è¡Œåˆ†ç»„ï¼Œç„¶åå°†  **æ§½å·â€”â€”æ¯ç»„æœ€åä¸€æ¡è®°å½•çš„åœ°å€åç§»é‡**  å­˜å‚¨åˆ°é¡µç›®å½•ï¼Œä½¿å…¶èµ·åˆ°ç´¢å¼•ä½œç”¨ï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾ä¸»é”®çš„æ–¹æ³•å¿«é€Ÿæ£€ç´¢åˆ°è®°å½•(**æˆ–è€…è¯´è®°å½•å¯¹åº”çš„æ•°æ®é¡µ**)åœ¨å“ªä¸ªåˆ†ç»„ï¼Œæ¥é™ä½æ£€ç´¢çš„æ—¶é—´å¤æ‚åº¦

InnoDB é‡Œçš„ B+ æ ‘ä¸­çš„**æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæ•°æ®é¡µ**ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

1. **åªæœ‰å¶å­èŠ‚ç‚¹å¯¹åº”çš„æ•°æ®é¡µæ‰ä¼šåœ¨é¡µå†…éƒ¨å­˜æ”¾å¤šä¸ªåˆ†ç»„(æ¯ä¸ªåˆ†ç»„ä¸­çš„è¡Œè®°å½•(è¯¥è¡Œè®°å½•ä¸ä¸€å®šå­˜æ”¾çš„æ˜¯çœŸå®æ•°æ®å€¼ï¼)é€šè¿‡å•å‘é“¾è¡¨æ¥è¿æ¥)**
2. **éå¶å­èŠ‚ç‚¹å¯¹åº”çš„æ•°æ®é¡µ é¡µå†…è™½ç„¶ä¹Ÿæœ‰é¡µç›®å½•ï¼Œä½†æ˜¯é¡µä¸­çš„æ¯ä¸ªåˆ†ç»„åªä¼šå­˜æ”¾ç´¢å¼•åˆ—å€¼å’Œå…¶å¯¹åº”çš„ä¸‹ä¸€ä¸ªæ•°æ®é¡µçš„ä½ç½®ï¼ï¼ç­‰äºè¯´ç”±ä¸Šè€Œä¸‹æŸ¥æ‰¾æ—¶æŸ¥æ‰¾åˆ°å¶å­èŠ‚ç‚¹ä¹‹å‰éƒ½åªæ˜¯ä¸ºäº†æŸ¥åˆ°è¯¥æ•°æ®åˆ°åº•ä½äºå“ªä¸ªæ•°æ®é¡µï¼ŒæŸ¥åˆ°ä»¥åæ‰ä¼šåœ¨é¡µå†…é€šè¿‡æ§½æ¥äºŒåˆ†æŸ¥æ‰¾æ•°æ®ä½äºå“ªä¸ªåˆ†ç»„ä¸‹ï¼Œæœ€ååœ¨åˆ†ç»„å†…è¿›è¡Œé“¾è¡¨çš„é¡ºåºéå†**

ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/B+%E6%A0%91%E6%9F%A5%E8%AF%A2.webp" style="zoom: 80%;" />

æˆ‘ä»¬å†çœ‹çœ‹ B+ æ ‘å¦‚ä½•å®ç°å¿«é€ŸæŸ¥æ‰¾ä¸»é”®ä¸º 6 çš„è®°å½•ï¼Œä»¥ä¸Šå›¾ä¸ºä¾‹å­ï¼š

- ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ç¬¦åˆé¡µå†…èŒƒå›´åŒ…å«æŸ¥è¯¢å€¼çš„é¡µï¼Œå› ä¸ºæŸ¥è¯¢çš„ä¸»é”®å€¼ä¸º 6ï¼Œåœ¨[1, 7)èŒƒå›´ä¹‹é—´ï¼Œæ‰€ä»¥åˆ°é¡µ 30 ä¸­æŸ¥æ‰¾æ›´è¯¦ç»†çš„ç›®å½•é¡¹ï¼›
- åœ¨éå¶å­èŠ‚ç‚¹ï¼ˆé¡µ30ï¼‰ä¸­ï¼Œç»§ç»­é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°ç¬¦åˆé¡µå†…èŒƒå›´åŒ…å«æŸ¥è¯¢å€¼çš„é¡µï¼Œä¸»é”®å€¼å¤§äº 5ï¼Œæ‰€ä»¥å°±åˆ°å¶å­èŠ‚ç‚¹ï¼ˆé¡µ16ï¼‰æŸ¥æ‰¾è®°å½•ï¼›
- æ¥ç€ï¼Œåœ¨å¶å­èŠ‚ç‚¹ï¼ˆé¡µ16ï¼‰ä¸­ï¼Œé€šè¿‡æ§½æŸ¥æ‰¾è®°å½•æ—¶ï¼Œä½¿ç”¨äºŒåˆ†æ³•å¿«é€Ÿå®šä½è¦æŸ¥è¯¢çš„è®°å½•åœ¨å“ªä¸ªæ§½ï¼ˆå“ªä¸ªè®°å½•åˆ†ç»„ï¼‰ï¼Œå®šä½åˆ°æ§½åï¼Œå†éå†æ§½å†…çš„æ‰€æœ‰è®°å½•ï¼Œæ‰¾åˆ°ä¸»é”®ä¸º 6 çš„è®°å½•ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å®šä½è®°å½•æ‰€åœ¨å“ªä¸€ä¸ªé¡µæ—¶ï¼Œä¹Ÿæ˜¯é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½åˆ°åŒ…å«è¯¥è®°å½•çš„é¡µã€‚å®šä½åˆ°è¯¥é¡µåï¼Œåˆä¼šåœ¨è¯¥é¡µå†…è¿›è¡ŒäºŒåˆ†æ³•å¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„åˆ†ç»„ï¼ˆæ§½å·ï¼‰ï¼Œæœ€ååœ¨åˆ†ç»„å†…è¿›è¡Œéå†æŸ¥æ‰¾



**æ•°æ®é¡µä¸­çš„è®°å½•æŒ‰ç…§ã€Œä¸»é”®ã€é¡ºåºç»„æˆå•å‘é“¾è¡¨**

**è€Œæ•°æ®é¡µä¹‹é—´åˆ™é€šè¿‡`File Header`çš„ä¸¤ä¸ªæŒ‡é’ˆç»„æˆåŒå‘é“¾è¡¨**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/v2-6bc6d5074f2a94ab0bc413381abd75c1_720w.webp)



### Mysqlä¸­ä¸€è¡Œè®°å½•å¦‚ä½•å­˜å‚¨

ä¸€æ¡è¡Œè®°å½•çš„æ ¼å¼é»˜è®¤è®¾ç½®æˆ `compact`è¡Œæ ¼å¼ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/COMPACT.drawio.webp)

å…·ä½“å…³æ³¨ï¼šä¸‰ä¸ªéšå¼åˆ—ã€å˜é•¿å­—æ®µé•¿åº¦åˆ—è¡¨(å­˜æ”¾åˆ—å±æ€§ä¸ºvarcharçš„å…·ä½“é•¿åº¦-å³è¯¥åˆ—å…·ä½“å ç”¨å¤šå°‘å­—èŠ‚)ã€Nullå€¼åˆ—è¡¨(æ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªåˆ—å±æ€§æ˜¯å¦ä¸ºNull ä¸º1æ—¶ä»£è¡¨å¯¹åº”åˆ—å€¼ä¸ºNull)ã€è®°å½•å¤´ä¿¡æ¯( delete_mask ï¼šæ ‡è¯†æ­¤æ¡æ•°æ®æ˜¯å¦è¢«åˆ ä»¥åŠ next_recordï¼šä¸‹ä¸€æ¡è®°å½•çš„ä½ç½®)
https://xiaolincoding.com/mysql/base/row_format.html#%E8%AE%B0%E5%BD%95%E7%9A%84%E9%A2%9D%E5%A4%96%E4%BF%A1%E6%81%AF







## ç´¢å¼•

å¯ä»¥æŒ‰ç…§å››ä¸ªè§’åº¦æ¥åˆ†ç±»ç´¢å¼•

- æŒ‰ã€Œæ•°æ®ç»“æ„ã€åˆ†ç±»ï¼š**B+treeç´¢å¼•ã€Hashç´¢å¼•ã€Full-textç´¢å¼•**
- æŒ‰ã€Œç‰©ç†å­˜å‚¨ã€åˆ†ç±»ï¼š**èšç°‡ç´¢å¼•ï¼ˆå¯èƒ½æ˜¯ä¸»é”®ç´¢å¼•ï¼‰ã€äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ï¼‰**
- æŒ‰ã€Œå­—æ®µç‰¹æ€§ã€åˆ†ç±»ï¼š**ä¸»é”®ç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€æ™®é€šç´¢å¼•ã€å‰ç¼€ç´¢å¼•**
- æŒ‰ã€Œå­—æ®µä¸ªæ•°ã€åˆ†ç±»ï¼š**å•åˆ—ç´¢å¼•ã€è”åˆç´¢å¼•**

åœ¨åˆ›å»ºè¡¨æ—¶ï¼Œ`InnoDB` å­˜å‚¨å¼•æ“ä¼šæ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸åŒçš„åˆ—ä½œä¸ºç´¢å¼•ï¼š(ä¸»é”®ç´¢å¼•ä¸ä¸€å®šç­‰äºèšç°‡ç´¢å¼•)

- å¦‚æœæœ‰ä¸»é”®ï¼Œé»˜è®¤ä¼šä½¿ç”¨ä¸»é”®ä½œä¸ºèšç°‡ç´¢å¼•(æ¯å¼ è¡¨åªèƒ½æœ‰ä¸€ä¸ª)çš„ç´¢å¼•é”®ï¼ˆkeyï¼‰ï¼Œæ­¤æ—¶ä¸»é”®ç´¢å¼•ç­‰äºèšé›†ç´¢å¼•ï¼›
- å¦‚æœ**æ²¡æœ‰ä¸»é”®ï¼Œå°±é€‰æ‹©ç¬¬ä¸€ä¸ªä¸åŒ…å« NULL å€¼çš„å”¯ä¸€åˆ—(Unique)ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®**ï¼ˆkeyï¼‰ï¼›
- åœ¨ä¸Šé¢ä¸¤ä¸ªéƒ½æ²¡æœ‰çš„æƒ…å†µä¸‹ï¼Œ`InnoDB` å°†è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšå¼è‡ªå¢ id åˆ—ä½œä¸ºèšç°‡ç´¢å¼•çš„ç´¢å¼•é”®ï¼ˆkeyï¼‰ï¼›

å…¶å®ƒç´¢å¼•éƒ½å±äºè¾…åŠ©ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ä¸­ç´¢å¼•çš„é€»è¾‘é¡ºåºä¸ç£ç›˜ä¸Šè¡Œçš„ç‰©ç†å­˜å‚¨é¡ºåºä¸åŒï¼Œä¸€ä¸ªè¡¨ä¸­å¯ä»¥æ‹¥æœ‰å¤šä¸ªéèšé›†ç´¢å¼•ï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•æˆ–éèšç°‡ç´¢å¼•ã€‚**åˆ›å»ºçš„ä¸»é”®ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•é»˜è®¤ä½¿ç”¨çš„æ˜¯ `B+Tree` ç´¢å¼•**

> èšç°‡ç´¢å¼•ï¼ˆClustered Indexï¼‰æ˜¯æ•°æ®åº“ä¸­ä¸€ç§ç´¢å¼•ç±»å‹ï¼Œå®ƒå†³å®šäº†è¡¨ä¸­è®°å½•çš„ç‰©ç†æ’åºå’Œå­˜å‚¨æ–¹å¼ã€‚èšç°‡ç´¢å¼•çš„ä¸»è¦ç‰¹ç‚¹æ˜¯**æ ¹æ®ç´¢å¼•åˆ—çš„å€¼å¯¹è®°å½•è¿›è¡Œç‰©ç†æ’åº**ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ç£ç›˜ä¸Šç›¸é‚»çš„ä½ç½®ã€‚
>
> åœ¨èšç°‡ç´¢å¼•ä¸­ï¼Œ**ç´¢å¼•çš„é¡ºåºå†³å®šäº†æ•°æ®åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨é¡ºåºã€‚æ¢å¥è¯è¯´ï¼Œå…·æœ‰ç›¸ä¼¼ç´¢å¼•å€¼çš„è®°å½•å°†åœ¨ç£ç›˜ä¸Šç‰©ç†ä¸Šç›¸é‚»å­˜å‚¨**ã€‚è¿™ç§å­˜å‚¨æ–¹å¼ä½¿å¾—æ ¹æ®**èšç°‡ç´¢å¼•åˆ—è¿›è¡ŒèŒƒå›´æŸ¥è¯¢å’Œé¡ºåºè®¿é—®çš„æ“ä½œéå¸¸é«˜æ•ˆï¼Œå› ä¸ºç›¸å…³çš„æ•°æ®åœ¨ç‰©ç†ä¸Šç´§å¯†æ’åˆ—**ï¼Œæ˜¾è‘—å‡å°‘äº†ç£ç›˜I/Oæ“ä½œ
>
> 
>
> ä¸ºäº†æ›´å¥½åœ°ç†è§£èšç°‡ç´¢å¼•ï¼Œè€ƒè™‘ä¸€ä¸ªç¤ºä¾‹è¡¨æ ¼ï¼ŒåŒ…å«å‘˜å·¥çš„ä¿¡æ¯ï¼Œå¦‚å‘˜å·¥IDã€å§“åã€éƒ¨é—¨ã€å·¥èµ„ç­‰ã€‚å¦‚æœæˆ‘ä»¬æ ¹æ®å‘˜å·¥IDåˆ›å»ºèšç°‡ç´¢å¼•ï¼Œé‚£ä¹ˆè¡¨æ ¼çš„æ•°æ®å°†æ ¹æ®å‘˜å·¥IDçš„é¡ºåºè¿›è¡Œæ’åºï¼Œå¹¶ä¸”å…·æœ‰ç›¸é‚»å‘˜å·¥IDçš„è¡Œå°†å­˜å‚¨åœ¨ç›¸é‚»çš„ç£ç›˜é¡µé¢ä¸Š(B+æ ‘ä¸­ç›¸é‚»çš„å¶å­èŠ‚ç‚¹åœ¨ç£ç›˜ä¸Šå­˜å‚¨çš„ç‰©ç†ä½ç½®ä¹Ÿæ˜¯ç›¸é‚»çš„)ã€‚è¿™æ ·ï¼Œå½“ä½¿ç”¨å‘˜å·¥IDä½œä¸ºæ£€ç´¢æ¡ä»¶æ—¶ï¼ŒDBMSå¯ä»¥å¿«é€Ÿå®šä½åˆ°ç›¸å…³çš„ç£ç›˜é¡µé¢ï¼Œå¹¶ç›´æ¥è·å–æ‰€éœ€çš„æ•°æ®è¡Œï¼Œè€Œæ— éœ€æ‰«ææ•´ä¸ªè¡¨
>
> 
>
> 
>
> è¿˜æ˜¯è¯¥è¡¨ï¼Œå‡è®¾åœ¨å·¥èµ„åˆ—ä¸Šå»ºç«‹äº†äºŒçº§ç´¢å¼•(éèšç°‡ç´¢å¼•)ï¼Œåœ¨è¯¥äºŒçº§ç´¢å¼•çš„B+æ ‘ä¸Šç›¸é‚»çš„ä¸¤ä¸ªå¶å­èŠ‚ç‚¹(å‡è®¾ä¸€ä¸ªå‘˜å·¥å·¥èµ„ä¸º3000ï¼Œå¦ä¸€ä¸ªå‘˜å·¥å·¥èµ„ä¸º3001)ï¼Œå¯¹åº”çš„ä¸¤æ¡è¡Œè®°å½•åœ¨ç£ç›˜ä¸­çš„ç‰©ç†åœ°å€å¹¶ä¸ä¸€å®šç›¸é‚»ï¼Œå› ä¸ºäºŒçº§ç´¢å¼•B+æ ‘å¶å­èŠ‚ç‚¹ä¸­keyä¸ºå·¥èµ„å€¼ï¼Œdataä¸ºå…¶è¡Œè®°å½•å¯¹åº”çš„ä¸»é”®ï¼Œæ­¤æ—¶è¿˜è¦å†å»èšç°‡ç´¢å¼•(ä¸€èˆ¬æ˜¯ä¸»é”®ç´¢å¼•)å¯¹åº”çš„B+æ ‘ä¸Šå†æ¬¡è¿›è¡ŒæŸ¥æ‰¾â€”â€”â€”â€”å›è¡¨æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸¤æ¡è¡Œè®°å½•åœ¨èšç°‡ç´¢å¼•çš„B+æ ‘ä¸ŠæŸ¥æ‰¾å°±å¯èƒ½èµ°ä¸åŒçš„è·¯å¾„ï¼Œæ‰€å¯¹åº”çš„ç£ç›˜ç‰©ç†åœ°å€ä¹Ÿä¸ä¸€å®šç›¸åŒäº†
>
> 
>
> 
>
> å…¶å®æƒ³æƒ³ä¸Šé¢çš„ä¾‹å­ï¼Œä¹Ÿèƒ½ä½“ä¼šåˆ°ï¼š
>
> - èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯å®é™…æ•°æ®ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ï¼›
> - äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®ã€‚
>
> å› ä¸ºç”¨æˆ·è®°å½•å­˜æ”¾åœ¨èšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹æ—¶ï¼Œä¸¤æ¡ç›¸ä¼¼çš„è®°å½•ä½äºåŒä¸€é¡µå†…/æˆ–è€…æ˜¯ç›¸é‚»é¡µï¼Œè€Œ`innodb`æŒ‰åŒºåˆ’åˆ†ç©ºé—´ï¼Œè¿™å°±å¯¼è‡´è¿™ä¸¤æ¡è®°å½•åœ¨ç£ç›˜ä½ç½®ä¸Šå¤§æ¦‚ç‡ä¹Ÿæ˜¯ç›¸é‚»çš„ï¼Œè€Œå¦‚æœéèšç°‡ç´¢å¼•çš„è¯ï¼Œç”±äºå¶å­èŠ‚ç‚¹æ²¡æœ‰å­˜æ”¾å®é™…æ•°æ®ï¼Œå°±éœ€è¦å†æ¬¡å»æŸ¥èšç°‡ç´¢å¼•å¯¹åº”çš„B+æ ‘ï¼Œè¿™æ ·å°±å¾ˆå¯èƒ½èµ°äº†ä¸åŒçš„æŸ¥æ‰¾è·¯å¾„ï¼Œæœ€ç»ˆå¯¼è‡´ä¸¤æ¡è®°å½•å¯¹åº”çš„æ•°æ®é¡µç›¸éš”å¤ªè¿œï¼Œåœ¨ç£ç›˜ä¸Šçš„ä½ç½®ä¹Ÿä¸ç›¸é‚»äº†(éèšç°‡çš„ç†è§£)







### B+æ ‘ç›¸å…³é—®é¢˜



![image-20240324235914615](https://cdn.jsdelivr.net/gh/amonstercat/PicGo@master/202403242359029.png)



B æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹æœ€å¤šå¯ä»¥åŒ…æ‹¬ M ä¸ªå­èŠ‚ç‚¹ï¼ŒM ç§°ä¸º B æ ‘çš„é˜¶ï¼Œæ‰€ä»¥ B æ ‘å°±æ˜¯ä¸€ä¸ªå¤šå‰æ ‘

å‡è®¾ M = 3ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€æ£µ 3 é˜¶çš„ B æ ‘ï¼Œç‰¹ç‚¹å°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šæœ‰ 2 ä¸ªï¼ˆM-1ä¸ªï¼‰æ•°æ®å’Œæœ€å¤šæœ‰ 3 ä¸ªï¼ˆMä¸ªï¼‰å­èŠ‚ç‚¹ï¼Œè¶…è¿‡è¿™äº›è¦æ±‚çš„è¯ï¼Œå°±ä¼šåˆ†è£‚èŠ‚ç‚¹



è™½ç„¶ï¼ŒInnoDB å’Œ MyISAM éƒ½æ”¯æŒ B+ æ ‘ç´¢å¼•ï¼Œä½†æ˜¯å®ƒä»¬èšé›†ç´¢å¼•çš„å­˜å‚¨ç»“æ„å®ç°ä¸åŒï¼š

- InnoDB å­˜å‚¨å¼•æ“ï¼šB+ æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜æ•°æ®æœ¬èº«ï¼›
- MyISAM å­˜å‚¨å¼•æ“ï¼š**B+ æ ‘ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¿å­˜æ•°æ®çš„ç‰©ç†åœ°å€**ï¼›



1ã€ä¸ºä»€ä¹ˆç”¨B+æ ‘ï¼Ÿå…¶ä»–æ•°æ®ç»“æ„æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿ

æ•°ç»„â€”â€”>Hashç´¢å¼•â€”â€”>äºŒå‰æŸ¥æ‰¾æ ‘BSTâ€”â€”>å¹³è¡¡äºŒå‰æ ‘AVLâ€”â€”>çº¢é»‘æ ‘â€”â€”>Bæ ‘â€”â€”>B+æ ‘

- **æ•°ç»„ äºŒåˆ†æ³•ç†è®ºä¸Šæ—¶é—´å¤æ‚åº¦å¯è¡Œï¼Œä½†æ˜¯æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œéœ€è¦å°†è¿™ä¸ªå…ƒç´ ä¹‹åçš„æ‰€æœ‰å…ƒç´ åç§»ä¸€ä½ï¼Œæ—¶é—´å¤æ‚åº¦O(N),æ‰€ä»¥ä¸èƒ½ç”¨çº¿æ€§ç»“æ„**

- Hash ä¸é€‚ç”¨äºèŒƒå›´ã€é¡ºåºæŸ¥è¯¢,è™½ç„¶æŸ¥æ‰¾å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)
- BST æ—¶é—´å¤æ‚åº¦å®¹æ˜“ä»O(log2N)é€€åŒ–ä¸ºé“¾è¡¨çš„O(N)
- AVLéœ€è¦é¢‘ç¹åœ°è¿›è¡Œæ—‹è½¬æ“ä½œæ¥ä¿æŒå¹³è¡¡ï¼Œä¼šæœ‰è¾ƒå¤§çš„è®¡ç®—å¼€é”€,ä¸”æ¯ä¸ªæ ‘èŠ‚ç‚¹ä»…å­˜å‚¨ä¸€ä¸ªæ•°æ®ï¼Œè€Œæ¯æ¬¡è¿›è¡Œç£ç›˜ I/O æ—¶åªèƒ½è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢çš„æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œå¤šæ¬¡ç£ç›˜ I/O
- çº¢é»‘æ ‘

> çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œé€šè¿‡åœ¨æ’å…¥å’Œåˆ é™¤èŠ‚ç‚¹æ—¶è¿›è¡Œ**é¢œè‰²å˜æ¢å’Œæ—‹è½¬**æ“ä½œï¼Œä½¿å¾—æ ‘å§‹ç»ˆä¿æŒå¹³è¡¡çŠ¶æ€ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
>
> 1. æ¯ä¸ªèŠ‚ç‚¹éçº¢å³é»‘ï¼›
> 2. æ ¹èŠ‚ç‚¹æ€»æ˜¯é»‘è‰²çš„ï¼›
> 3. æ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²çš„ç©ºèŠ‚ç‚¹ï¼ˆNIL èŠ‚ç‚¹ï¼‰ï¼›
> 4. å¦‚æœèŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œåˆ™å®ƒçš„å­èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²çš„ï¼ˆåä¹‹ä¸ä¸€å®šï¼‰ï¼›
> 5. ä»æ ¹èŠ‚ç‚¹åˆ°å¶èŠ‚ç‚¹æˆ–ç©ºå­èŠ‚ç‚¹çš„æ¯æ¡è·¯å¾„ï¼Œå¿…é¡»åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ï¼ˆå³ç›¸åŒçš„é»‘è‰²é«˜åº¦ï¼‰
>
> å’Œ AVL æ ‘ä¸åŒçš„æ˜¯ï¼Œçº¢é»‘æ ‘å¹¶ä¸è¿½æ±‚ä¸¥æ ¼çš„å¹³è¡¡ï¼Œè€Œæ˜¯å¤§è‡´çš„å¹³è¡¡ã€‚æ­£å› å¦‚æ­¤ï¼Œçº¢é»‘æ ‘çš„æŸ¥è¯¢æ•ˆç‡ç¨æœ‰ä¸‹é™ï¼Œå› ä¸ºçº¢é»‘æ ‘çš„å¹³è¡¡æ€§ç›¸å¯¹è¾ƒå¼±ï¼Œ**å¯èƒ½ä¼šå¯¼è‡´æ ‘çš„é«˜åº¦è¾ƒé«˜**ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ•°æ®éœ€è¦è¿›è¡Œå¤šæ¬¡ç£ç›˜I/O æ“ä½œæ‰èƒ½æŸ¥è¯¢åˆ°ï¼Œè¿™ä¹Ÿæ˜¯ MySQL æ²¡æœ‰é€‰æ‹©çº¢é»‘æ ‘çš„ä¸»è¦åŸå› ã€‚ä¹Ÿæ­£å› å¦‚æ­¤ï¼Œ**çº¢é»‘æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œæ•ˆç‡å¤§å¤§æé«˜äº†ï¼Œå› ä¸ºçº¢é»‘æ ‘åœ¨æ’å…¥å’Œåˆ é™¤èŠ‚ç‚¹æ—¶åªéœ€è¿›è¡Œ O(1) æ¬¡æ•°çš„æ—‹è½¬å’Œå˜è‰²æ“ä½œï¼Œå³å¯ä¿æŒåŸºæœ¬å¹³è¡¡çŠ¶æ€ï¼Œè€Œä¸éœ€è¦åƒ AVL æ ‘ä¸€æ ·è¿›è¡Œ O(logn) æ¬¡æ•°çš„æ—‹è½¬æ“ä½œ**





- Bæ ‘ï¼š Bæ ‘çš„æ£€ç´¢è¿‡ç¨‹ç›¸å½“äºå¯¹èŒƒå›´å†…çš„æ¯ä¸ªèŠ‚ç‚¹çš„å…³é”®å­—åšäºŒåˆ†æŸ¥æ‰¾ï¼Œå¯èƒ½è¿˜æ²¡æœ‰åˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼Œæ£€ç´¢å°±ç»“æŸäº†ã€‚è€Œ B+æ ‘çš„æ£€ç´¢æ•ˆç‡å°±å¾ˆç¨³å®šäº†ï¼Œä»»ä½•æŸ¥æ‰¾éƒ½æ˜¯ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚**ä¸”åœ¨ B æ ‘ä¸­è¿›è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶ï¼Œé¦–å…ˆæ‰¾åˆ°è¦æŸ¥æ‰¾çš„ä¸‹é™ï¼Œç„¶åå¯¹ B æ ‘è¿›è¡Œä¸­åºéå†ï¼Œç›´åˆ°æ‰¾åˆ°æŸ¥æ‰¾çš„ä¸Šé™**ï¼›è€Œ B+æ ‘çš„èŒƒå›´æŸ¥è¯¢ï¼Œåªéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†å³å¯

> è¡¥å……ï¼š
>
> B æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«æ•°æ®ï¼ˆç´¢å¼•+è®°å½•ï¼‰ï¼Œè€Œç”¨æˆ·çš„è®°å½•æ•°æ®çš„å¤§å°å¾ˆæœ‰å¯èƒ½è¿œè¿œè¶…è¿‡äº†ç´¢å¼•æ•°æ®ï¼Œè¿™å°±éœ€è¦èŠ±è´¹æ›´å¤šçš„ç£ç›˜ I/O æ“ä½œæ¬¡æ•°æ¥è¯»åˆ°ã€Œæœ‰ç”¨çš„ç´¢å¼•æ•°æ®ã€ã€‚
>
> è€Œä¸”ï¼Œåœ¨æˆ‘ä»¬æŸ¥è¯¢ä½äºåº•å±‚çš„æŸä¸ªèŠ‚ç‚¹ï¼ˆæ¯”å¦‚ A è®°å½•ï¼‰è¿‡ç¨‹ä¸­ï¼Œã€Œé A è®°å½•èŠ‚ç‚¹ã€é‡Œçš„è®°å½•æ•°æ®ä¼šä»ç£ç›˜åŠ è½½åˆ°å†…å­˜`BufferPool`ä¸­ï¼Œä½†æ˜¯è¿™äº›è®°å½•æ•°æ®æ˜¯æ²¡ç”¨çš„ï¼Œæˆ‘ä»¬åªæ˜¯æƒ³è¯»å–è¿™äº›èŠ‚ç‚¹çš„ç´¢å¼•æ•°æ®æ¥åšæ¯”è¾ƒæŸ¥è¯¢ï¼Œè€Œã€Œé A è®°å½•èŠ‚ç‚¹ã€é‡Œçš„è®°å½•æ•°æ®å¯¹æˆ‘ä»¬æ˜¯æ²¡ç”¨çš„ï¼Œè¿™æ ·ä¸ä»…å¢å¤šç£ç›˜ I/O æ“ä½œæ¬¡æ•°ï¼Œä¹Ÿå ç”¨å†…å­˜èµ„æº

- B+æ ‘ï¼šå¯¹äºæœ‰ N ä¸ªå¶å­èŠ‚ç‚¹çš„ B+Treeï¼Œå…¶æœç´¢å¤æ‚åº¦ä¸º`O(logdN)`ï¼Œå…¶ä¸­ d è¡¨ç¤ºèŠ‚ç‚¹å…è®¸çš„æœ€å¤§å­èŠ‚ç‚¹ä¸ªæ•°ä¸º d ä¸ª



2ã€B+æ ‘ä¸­æ•°æ®æ˜¯æ€ä¹ˆå­˜æ”¾çš„ï¼Ÿ

`MyISAM` å¼•æ“ä¸­ï¼ŒB+Tree å¶èŠ‚ç‚¹çš„ `data` åŸŸå­˜æ”¾çš„æ˜¯æ•°æ®è®°å½•çš„åœ°å€ã€‚åœ¨ç´¢å¼•æ£€ç´¢çš„æ—¶å€™ï¼Œé¦–å…ˆæŒ‰ç…§ B+Tree æœç´¢ç®—æ³•æœç´¢ç´¢å¼•ï¼Œå¦‚æœæŒ‡å®šçš„ `Key` å­˜åœ¨ï¼Œåˆ™å–å‡ºå…¶ `data` åŸŸçš„å€¼ï¼Œç„¶åä»¥ `data` åŸŸçš„å€¼ä¸ºåœ°å€è¯»å–ç›¸åº”çš„æ•°æ®è®°å½•ã€‚è¿™è¢«ç§°ä¸ºâ€œ**éèšç°‡ç´¢å¼•(éèšé›†ç´¢å¼•)**â€

`InnoDB` å¼•æ“ä¸­ï¼Œå…¶æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ã€‚ç›¸æ¯” `MyISAM`ï¼Œç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œå…¶è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰ B+Tree ç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼Œæ ‘çš„å¶èŠ‚ç‚¹ data åŸŸä¿å­˜äº†å®Œæ•´çš„æ•°æ®è®°å½•ã€‚è¿™ä¸ªç´¢å¼•çš„ `key` æ˜¯æ•°æ®è¡¨çš„ä¸»é”®ï¼Œå› æ­¤ `InnoDB` è¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ä¸»ç´¢å¼•,è¿™è¢«ç§°ä¸ºâ€œ**èšç°‡ç´¢å¼•ï¼ˆèšé›†ç´¢å¼•ï¼‰**â€ã€‚è€Œå…¶ä½™çš„ç´¢å¼•éƒ½ä½œä¸º **è¾…åŠ©ç´¢å¼•** ï¼Œè¾…åŠ©ç´¢å¼•çš„ `data` åŸŸå­˜å‚¨ç›¸åº”è®°å½•ä¸»é”®çš„å€¼è€Œä¸æ˜¯åœ°å€ï¼Œè¿™ä¹Ÿæ˜¯å’Œ `MyISAM` ä¸åŒçš„åœ°æ–¹ã€‚åœ¨æ ¹æ®ä¸»ç´¢å¼•æœç´¢æ—¶ï¼Œç›´æ¥æ‰¾åˆ° `key` æ‰€åœ¨çš„èŠ‚ç‚¹å³å¯å–å‡ºæ•°æ®ï¼›åœ¨æ ¹æ®è¾…åŠ©ç´¢å¼•æŸ¥æ‰¾æ—¶ï¼Œåˆ™éœ€è¦å…ˆå–å‡ºä¸»é”®çš„å€¼ï¼Œå†èµ°ä¸€éä¸»ç´¢å¼•

ä¸»é”®ç´¢å¼•çš„ B+Tree å’ŒäºŒçº§ç´¢å¼•çš„ B+Tree åŒºåˆ«å¦‚ä¸‹ï¼š

- ä¸»é”®ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹ä¸­ data å€¼å­˜æ”¾çš„æ˜¯å®é™…æ•°æ®ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨ä¸»é”®ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹é‡Œï¼Œéå¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®å’Œé¡µå·ï¼›

- äºŒçº§ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹ä¸­ data å€¼å­˜æ”¾çš„æ˜¯ä¸»é”®å€¼ï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®

  <img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%9B%9E%E8%A1%A8.drawio.webp"  />

å½“æŸ¥è¯¢çš„æ•°æ®æ˜¯èƒ½åœ¨äºŒçº§ç´¢å¼•çš„ B+Tree çš„å¶å­èŠ‚ç‚¹é‡ŒæŸ¥è¯¢åˆ°ï¼Œè¿™æ—¶å°±ä¸ç”¨å†æŸ¥ä¸»é”®ç´¢å¼•ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ¡æŸ¥è¯¢è¯­å¥ï¼š

```sql
select id from product where product_no = '0002';
```

**è¿™ç§åœ¨äºŒçº§ç´¢å¼•çš„ B+Tree å°±èƒ½æŸ¥è¯¢åˆ°ç»“æœçš„è¿‡ç¨‹å°±å«ä½œã€Œè¦†ç›–ç´¢å¼•ã€**







### ç´¢å¼•å¤±æ•ˆ

1ã€æ¥çœ‹çœ‹**è”åˆç´¢å¼•**ä¸­çš„ç´¢å¼•å¤±æ•ˆé—®é¢˜ï¼š

é¦–å…ˆçœ‹ä¸€ä¸ªè”åˆç´¢å¼•ï¼š

```sql
CREATE INDEX index_product_no_name ON product(product_no, name);
```

è”åˆç´¢å¼•çš„éå¶å­èŠ‚ç‚¹ç”¨ä¸¤ä¸ªå­—æ®µçš„å€¼`(product_no, name)`ä½œä¸º B+Tree çš„ key å€¼,è”åˆç´¢å¼•æŸ¥è¯¢çš„ `B+Tree` æ˜¯å…ˆæŒ‰ product_no è¿›è¡Œæ’åºï¼Œåœ¨ `product_no` ç›¸åŒçš„æƒ…å†µå†æŒ‰ name å­—æ®µæ’åºï¼Œä½¿ç”¨è”åˆç´¢å¼•æ—¶ï¼Œå­˜åœ¨**æœ€å·¦åŒ¹é…åŸåˆ™**ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§æœ€å·¦ä¼˜å…ˆçš„æ–¹å¼è¿›è¡Œç´¢å¼•çš„åŒ¹é…ã€‚å¦‚æœä¸éµå¾ªã€Œæœ€å·¦åŒ¹é…åŸåˆ™ã€ï¼Œè”åˆç´¢å¼•ä¼šå¤±æ•ˆ

æ¯”å¦‚ï¼Œå¦‚æœåˆ›å»ºäº†ä¸€ä¸ª `(a, b, c)` è”åˆç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æ˜¯ä»¥ä¸‹è¿™å‡ ç§ï¼Œå°±å¯ä»¥åŒ¹é…ä¸Šè”åˆç´¢å¼•ï¼š

- where a=1ï¼›
- where a=1 and b=2 and c=3ï¼›
- where a=1 and b=2ï¼›

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºæœ‰æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼Œæ‰€ä»¥ a å­—æ®µåœ¨ where å­å¥çš„é¡ºåºå¹¶ä¸é‡è¦ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶æ˜¯ä»¥ä¸‹è¿™å‡ ç§ï¼Œå› ä¸ºä¸ç¬¦åˆæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œæ‰€ä»¥å°±æ— æ³•åŒ¹é…ä¸Šè”åˆç´¢å¼•ï¼Œè”åˆç´¢å¼•å°±ä¼šå¤±æ•ˆ:

- where b=2ï¼›
- where c=3ï¼›
- where b=2 and c=3ï¼›

ä¸Šé¢è¿™äº›æŸ¥è¯¢æ¡ä»¶ä¹‹æ‰€ä»¥ä¼šå¤±æ•ˆï¼Œæ˜¯å› ä¸º`(a, b, c)` è”åˆç´¢å¼•ï¼Œæ˜¯å…ˆæŒ‰ a æ’åºï¼Œåœ¨ a ç›¸åŒçš„æƒ…å†µå†æŒ‰ b æ’åºï¼Œåœ¨ b ç›¸åŒçš„æƒ…å†µå†æŒ‰ c æ’åºã€‚æ‰€ä»¥ï¼Œ**b å’Œ c æ˜¯å…¨å±€æ— åºï¼Œå±€éƒ¨ç›¸å¯¹æœ‰åºçš„**ï¼Œè¿™æ ·åœ¨æ²¡æœ‰éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ³•åˆ©ç”¨åˆ°ç´¢å¼•çš„

è§£é‡Šä¸€ä¸‹å…¨å±€æ— åºï¼Œå±€éƒ¨æœ‰åºï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E6%A1%88%E4%BE%8B.drawio.webp" style="zoom:80%;" />



å¯ä»¥çœ‹åˆ°ï¼Œa æ˜¯å…¨å±€æœ‰åºçš„ï¼ˆ1, 2, 2, 3, 4, 5, 6, 7 ,8ï¼‰ï¼Œè€Œ b æ˜¯å…¨å±€æ˜¯æ— åºçš„ï¼ˆ12ï¼Œ7ï¼Œ8ï¼Œ2ï¼Œ3ï¼Œ8ï¼Œ10ï¼Œ5ï¼Œ2ï¼‰ã€‚å› æ­¤ï¼Œç›´æ¥æ‰§è¡Œ`where b = 2`è¿™ç§æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰åŠæ³•åˆ©ç”¨è”åˆç´¢å¼•çš„ï¼Œ**åˆ©ç”¨ç´¢å¼•çš„å‰ææ˜¯ç´¢å¼•é‡Œçš„ key æ˜¯æœ‰åºçš„**

åªæœ‰åœ¨ a ç›¸åŒçš„æƒ…å†µæ‰ï¼Œb æ‰æ˜¯æœ‰åºçš„ï¼Œæ¯”å¦‚ a ç­‰äº 2 çš„æ—¶å€™ï¼Œb çš„å€¼ä¸ºï¼ˆ7ï¼Œ8ï¼‰ï¼Œè¿™æ—¶å°±æ˜¯æœ‰åºçš„ï¼Œè¿™ä¸ªæœ‰åºçŠ¶æ€æ˜¯å±€éƒ¨çš„ï¼Œå› æ­¤ï¼Œæ‰§è¡Œ`where a = 2 and b = 7`æ˜¯ a å’Œ b å­—æ®µèƒ½ç”¨åˆ°è”åˆç´¢å¼•çš„ï¼Œä¹Ÿå°±æ˜¯è”åˆç´¢å¼•ç”Ÿæ•ˆäº†



è”åˆç´¢å¼•æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œ**å¹¶ä¸æ˜¯æŸ¥è¯¢è¿‡ç¨‹ä½¿ç”¨äº†è”åˆç´¢å¼•æŸ¥è¯¢ï¼Œå°±ä»£è¡¨è”åˆç´¢å¼•ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½ç”¨åˆ°äº†è”åˆç´¢å¼•è¿›è¡Œç´¢å¼•æŸ¥è¯¢**ï¼Œä¹Ÿå°±æ˜¯**å¯èƒ½å­˜åœ¨éƒ¨åˆ†å­—æ®µç”¨åˆ°è”åˆç´¢å¼•çš„ B+Treeï¼Œéƒ¨åˆ†å­—æ®µæ²¡æœ‰ç”¨åˆ°è”åˆç´¢å¼•çš„ B+Tree** çš„æƒ…å†µï¼Œè¿™ç§ç‰¹æ®Šæƒ…å†µå°±å‘ç”Ÿåœ¨èŒƒå›´æŸ¥è¯¢ã€‚è”åˆç´¢å¼•çš„æœ€å·¦åŒ¹é…åŸåˆ™ä¼šä¸€ç›´å‘å³åŒ¹é…ç›´åˆ°é‡åˆ°ã€ŒèŒƒå›´æŸ¥è¯¢ã€å°±ä¼šåœæ­¢åŒ¹é…ã€‚**ä¹Ÿå°±æ˜¯èŒƒå›´æŸ¥è¯¢çš„å­—æ®µå¯ä»¥ç”¨åˆ°è”åˆç´¢å¼•ï¼Œä½†æ˜¯åœ¨èŒƒå›´æŸ¥è¯¢å­—æ®µçš„åé¢çš„å­—æ®µæ— æ³•ç”¨åˆ°è”åˆç´¢å¼•**ï¼š



æ¥ä¸‹æ¥çœ‹å‡ ä¸ªèŒƒå›´æŸ¥è¯¢çš„ä¾‹å­ï¼š

```sql
Q1: select * from t_table where a > 1 and b = 2ï¼Œè”åˆç´¢å¼•ï¼ˆa, bï¼‰å“ªä¸€ä¸ªå­—æ®µç”¨åˆ°äº†è”åˆç´¢å¼•çš„ B+Treeï¼Ÿ
```

ç”±äºè”åˆç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰æ˜¯å…ˆæŒ‰ç…§ a å­—æ®µçš„å€¼æ’åºçš„ï¼Œæ‰€ä»¥ç¬¦åˆ a > 1 æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•è‚¯å®šæ˜¯ç›¸é‚»ï¼Œåœ¨è¿›è¡Œç´¢å¼•æ‰«æçš„æ—¶å€™ï¼Œå¯ä»¥å®šä½åˆ°ç¬¦åˆ a > 1 æ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œç„¶åæ²¿ç€è®°å½•æ‰€åœ¨çš„é“¾è¡¨å‘åæ‰«æï¼Œç›´åˆ°æŸæ¡è®°å½•ä¸ç¬¦åˆ a > 1 æ¡ä»¶ä½ç½®ã€‚æ‰€ä»¥ a å­—æ®µå¯ä»¥åœ¨è”åˆç´¢å¼•çš„ B+Tree ä¸­è¿›è¡Œç´¢å¼•æŸ¥è¯¢

**ä½†æ˜¯åœ¨ç¬¦åˆ a > 1 æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•çš„èŒƒå›´é‡Œï¼Œb å­—æ®µçš„å€¼æ˜¯æ— åºçš„**ã€‚æ¯”å¦‚å‰é¢å›¾çš„è”åˆç´¢å¼•çš„ B+ Tree é‡Œï¼Œä¸‹é¢è¿™ä¸‰æ¡è®°å½•çš„ a å­—æ®µçš„å€¼éƒ½ç¬¦åˆ a > 1 æŸ¥è¯¢æ¡ä»¶ï¼Œè€Œ b å­—æ®µçš„å€¼æ˜¯æ— åºçš„ï¼š

- a å­—æ®µå€¼ä¸º 5 çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ b å­—æ®µå€¼ä¸º 8ï¼›
- a å­—æ®µå€¼ä¸º 6 çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ b å­—æ®µå€¼ä¸º 10ï¼›
- a å­—æ®µå€¼ä¸º 7 çš„è®°å½•ï¼Œè¯¥è®°å½•çš„ b å­—æ®µå€¼ä¸º 5ï¼›

å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½æ ¹æ®æŸ¥è¯¢æ¡ä»¶ b = 2 æ¥è¿›ä¸€æ­¥å‡å°‘éœ€è¦æ‰«æçš„è®°å½•æ•°é‡ï¼ˆb å­—æ®µæ— æ³•åˆ©ç”¨è”åˆç´¢å¼•è¿›è¡Œç´¢å¼•æŸ¥è¯¢çš„æ„æ€ï¼‰æ•…**Q1 è¿™æ¡æŸ¥è¯¢è¯­å¥åªæœ‰ a å­—æ®µç”¨åˆ°äº†è”åˆç´¢å¼•è¿›è¡Œç´¢å¼•æŸ¥è¯¢ï¼Œè€Œ b å­—æ®µå¹¶æ²¡æœ‰ä½¿ç”¨åˆ°è”åˆç´¢å¼•**





```sql
Q2: select * from t_table where a >= 1 and b = 2ï¼Œè”åˆç´¢å¼•ï¼ˆa, bï¼‰å“ªä¸€ä¸ªå­—æ®µç”¨åˆ°äº†è”åˆç´¢å¼•çš„ B+Treeï¼Ÿ
```

ç”±äºè”åˆç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰æ˜¯å…ˆæŒ‰ç…§ a å­—æ®µçš„å€¼æ’åºçš„ï¼Œæ‰€ä»¥ç¬¦åˆ >= 1 æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•è‚¯å®šæ˜¯ç›¸é‚»ï¼Œäºæ˜¯åœ¨è¿›è¡Œç´¢å¼•æ‰«æçš„æ—¶å€™ï¼Œå¯ä»¥å®šä½åˆ°ç¬¦åˆ >= 1 æ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œç„¶åæ²¿ç€è®°å½•æ‰€åœ¨çš„é“¾è¡¨å‘åæ‰«æï¼Œç›´åˆ°æŸæ¡è®°å½•ä¸ç¬¦åˆ a>= 1 æ¡ä»¶ä½ç½®ã€‚æ‰€ä»¥ a å­—æ®µå¯ä»¥åœ¨è”åˆç´¢å¼•çš„ B+Tree ä¸­è¿›è¡Œç´¢å¼•æŸ¥è¯¢ã€‚

è™½ç„¶åœ¨ç¬¦åˆ a>= 1 æ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•çš„èŒƒå›´é‡Œï¼Œb å­—æ®µçš„å€¼æ˜¯ã€Œæ— åºã€çš„ï¼Œ**ä½†æ˜¯å¯¹äºç¬¦åˆ a = 1 çš„äºŒçº§ç´¢å¼•è®°å½•çš„èŒƒå›´é‡Œï¼Œb å­—æ®µçš„å€¼æ˜¯ã€Œæœ‰åºã€çš„**ï¼ˆå› ä¸ºå¯¹äºè”åˆç´¢å¼•ï¼Œæ˜¯å…ˆæŒ‰ç…§ a å­—æ®µçš„å€¼æ’åºï¼Œç„¶ååœ¨ a å­—æ®µçš„å€¼ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå†æŒ‰ç…§ b å­—æ®µçš„å€¼è¿›è¡Œæ’åºï¼‰

äºæ˜¯ï¼Œåœ¨ç¡®å®šéœ€è¦æ‰«æçš„äºŒçº§ç´¢å¼•çš„èŒƒå›´æ—¶ï¼Œå½“äºŒçº§ç´¢å¼•è®°å½•çš„ a å­—æ®µå€¼ä¸º 1 æ—¶ï¼Œå¯ä»¥é€šè¿‡ b = 2 æ¡ä»¶å‡å°‘éœ€è¦æ‰«æçš„äºŒçº§ç´¢å¼•è®°å½•èŒƒå›´ï¼ˆb å­—æ®µå¯ä»¥åˆ©ç”¨è”åˆç´¢å¼•è¿›è¡Œç´¢å¼•æŸ¥è¯¢çš„æ„æ€ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»ç¬¦åˆ a = 1 and b = 2 æ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•å¼€å§‹æ‰«æï¼Œè€Œä¸éœ€è¦ä»ç¬¬ä¸€ä¸ª a å­—æ®µå€¼ä¸º 1 çš„è®°å½•å¼€å§‹æ‰«æ





```sql
Q3: SELECT * FROM t_table WHERE a BETWEEN 2 AND 8 AND b = 2ï¼Œè”åˆç´¢å¼•ï¼ˆa, bï¼‰å“ªä¸€ä¸ªå­—æ®µç”¨åˆ°äº†è”åˆç´¢å¼•çš„ B+Treeï¼Ÿ
```

**è¯¥æŸ¥è¯¢æ¡ä»¶ä¸­ `a BETWEEN 2 AND 8` çš„æ„æ€æ˜¯æŸ¥è¯¢ a å­—æ®µçš„å€¼åœ¨ 2 å’Œ 8 ä¹‹é—´çš„è®°å½•ã€‚ä¸åŒçš„æ•°æ®åº“å¯¹ BETWEEN ... AND å¤„ç†æ–¹å¼æ˜¯æœ‰å·®å¼‚çš„ã€‚åœ¨ MySQL ä¸­ï¼ŒBETWEEN åŒ…å«äº† value1 å’Œ value2 è¾¹ç•Œå€¼ï¼Œç±»ä¼¼äº >= and =<**ï¼Œå› æ­¤ **Q3 è¿™æ¡æŸ¥è¯¢è¯­å¥ a å’Œ b å­—æ®µéƒ½ç”¨åˆ°äº†è”åˆç´¢å¼•è¿›è¡Œç´¢å¼•æŸ¥è¯¢**





```sql
Q4: SELECT * FROM t_user WHERE name like 'j%' and age = 22ï¼Œè”åˆç´¢å¼•ï¼ˆname, ageï¼‰å“ªä¸€ä¸ªå­—æ®µç”¨åˆ°äº†è”åˆç´¢å¼•çš„ B+Treeï¼Ÿ
```

ç›´æ¥è¯´ç»“è®ºï¼šnameå’Œageå­—æ®µéƒ½ç”¨åˆ°äº†è”åˆç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/q4-2.drawio.webp" style="zoom:67%;" />

è™½ç„¶åœ¨ç¬¦åˆå‰ç¼€ä¸º â€˜jâ€™ çš„ name å­—æ®µçš„äºŒçº§ç´¢å¼•è®°å½•çš„èŒƒå›´é‡Œï¼Œage å­—æ®µçš„å€¼æ˜¯ã€Œæ— åºã€çš„ï¼Œ**ä½†æ˜¯å¯¹äºç¬¦åˆ name = j çš„äºŒçº§ç´¢å¼•è®°å½•èŒƒå›´é‡Œï¼Œageå­—æ®µçš„å€¼æ˜¯ã€Œæœ‰åºã€çš„**ï¼ˆå› ä¸ºå¯¹äºè”åˆç´¢å¼•ï¼Œæ˜¯å…ˆæŒ‰ç…§ name å­—æ®µçš„å€¼æ’åºï¼Œç„¶ååœ¨ name å­—æ®µçš„å€¼ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œå†æŒ‰ç…§ age å­—æ®µçš„å€¼è¿›è¡Œæ’åºï¼‰ï¼Œå³è¯¥æŸ¥è¯¢è¯­å¥ä¼šä»ç¬¦åˆ `name = 'j' and age = 22` æ¡ä»¶çš„ç¬¬ä¸€æ¡è®°å½•æ—¶å¼€å§‹æ‰«æï¼Œè€Œä¸éœ€è¦ä»ç¬¬ä¸€ä¸ª name ä¸º j çš„è®°å½•å¼€å§‹æ‰«æï¼





2ã€å¯¹ç´¢å¼•å­—æ®µä½¿ç”¨å‡½æ•°ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆ

æ¯”å¦‚ä¸‹é¢è¿™æ¡è¯­å¥æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ **name** å­—æ®µä½¿ç”¨äº† `LENGTH` å‡½æ•°ï¼Œæ‰§è¡Œè®¡åˆ’ä¸­çš„ `type=ALL`ï¼Œä»£è¡¨äº†å…¨è¡¨æ‰«æï¼š

```sql
// name ä¸ºäºŒçº§ç´¢å¼•â€”â€”è¾…åŠ©ç´¢å¼•
select * from t_user where length(name)=6;
```

å› ä¸ºç´¢å¼•ä¿å­˜çš„æ˜¯ç´¢å¼•å­—æ®µçš„åŸå§‹å€¼ï¼Œè€Œä¸æ˜¯ç»è¿‡å‡½æ•°è®¡ç®—åçš„å€¼ï¼Œè‡ªç„¶å°±æ²¡åŠæ³•èµ°ç´¢å¼•äº†

ä½†æ˜¯ä» MySQL 8.0 å¼€å§‹ï¼Œç´¢å¼•ç‰¹æ€§å¢åŠ äº†å‡½æ•°ç´¢å¼•ï¼Œå³**å¯ä»¥é’ˆå¯¹å‡½æ•°è®¡ç®—åçš„å€¼å»ºç«‹ä¸€ä¸ªç´¢å¼•**ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥ç´¢å¼•çš„å€¼æ˜¯å‡½æ•°è®¡ç®—åçš„å€¼ï¼Œæ‰€ä»¥å°±å¯ä»¥é€šè¿‡æ‰«æç´¢å¼•æ¥æŸ¥è¯¢æ•°æ®ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘é€šè¿‡ä¸‹é¢è¿™æ¡è¯­å¥ï¼Œå¯¹ length(name) çš„è®¡ç®—ç»“æœå»ºç«‹ä¸€ä¸ªåä¸º `idx_name_length` çš„ç´¢å¼•ã€‚

```text
alter table t_user add key idx_name_length ((length(name)));
```





3ã€åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•è¿›è¡Œè¡¨è¾¾å¼è®¡ç®—ï¼Œä¹Ÿä¼šå¯¼è‡´å¤±æ•ˆ

æ¯”å¦‚ï¼Œä¸‹é¢è¿™æ¡æŸ¥è¯¢è¯­å¥ï¼Œæ‰§è¡Œè®¡åˆ’ä¸­ type = ALLï¼Œè¯´æ˜æ˜¯é€šè¿‡å…¨è¡¨æ‰«æçš„æ–¹å¼æŸ¥è¯¢æ•°æ®çš„ï¼š

```sql
explain select * from t_user where id + 1 = 10;
```

ä½†æ˜¯ï¼Œå¦‚æœæŠŠæŸ¥è¯¢è¯­å¥çš„æ¡ä»¶æ”¹æˆ where id = 10 - 1ï¼Œè¿™æ ·å°±ä¸æ˜¯åœ¨ç´¢å¼•å­—æ®µè¿›è¡Œè¡¨è¾¾å¼è®¡ç®—äº†ï¼Œäºæ˜¯å°±å¯ä»¥èµ°ç´¢å¼•æŸ¥è¯¢äº†



4ã€ä½¿ç”¨å·¦æˆ–è€…å·¦å³æ¨¡ç³ŠåŒ¹é…ä¹Ÿå°±æ˜¯ `like %xx` æˆ–è€… `like %xx%` è¿™ä¸¤ç§æ–¹å¼éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆ

æ¯”å¦‚ä¸‹é¢çš„ like è¯­å¥ï¼ŒæŸ¥è¯¢ name åç¼€ä¸ºã€Œæ—ã€çš„ç”¨æˆ·ï¼Œæ‰§è¡Œè®¡åˆ’ä¸­çš„ type=ALL å°±ä»£è¡¨äº†å…¨è¡¨æ‰«æï¼Œè€Œæ²¡æœ‰èµ°ç´¢å¼•ã€‚

```sql
// name å­—æ®µä¸ºäºŒçº§ç´¢å¼•
select * from t_user where name like '%æ—';
```



å¦‚æœæ˜¯æŸ¥è¯¢ name å‰ç¼€ä¸ºæ—çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆå°±ä¼šèµ°ç´¢å¼•æ‰«æï¼Œæ‰§è¡Œè®¡åˆ’ä¸­çš„ type=range è¡¨ç¤ºèµ°ç´¢å¼•æ‰«æï¼Œkey=index_name çœ‹åˆ°å®é™…èµ°äº† index_name ç´¢å¼•ï¼š

```sql
// name å­—æ®µä¸ºäºŒçº§ç´¢å¼•
select * from t_user where name like 'æ—%';
```





5ã€`WHERE` å­å¥ä¸­çš„ `OR`

åœ¨ WHERE å­å¥ä¸­ï¼Œå¦‚æœåœ¨ OR å‰çš„æ¡ä»¶åˆ—æ˜¯ç´¢å¼•åˆ—ï¼Œè€Œåœ¨ OR åçš„æ¡ä»¶åˆ—ä¸æ˜¯ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆç´¢å¼•ä¼šå¤±æ•ˆ

æ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢è¯­å¥ï¼Œid æ˜¯ä¸»é”®ï¼Œage æ˜¯æ™®é€šåˆ—ï¼Œä»æ‰§è¡Œè®¡åˆ’çš„ç»“æœçœ‹ï¼Œæ˜¯èµ°äº†å…¨è¡¨æ‰«æã€‚

```sql
select * from t_user where id = 1 or age = 18;
```

è¿™æ˜¯å› ä¸º OR çš„å«ä¹‰å°±æ˜¯ä¸¤ä¸ªåªè¦æ»¡è¶³ä¸€ä¸ªå³å¯ï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªæ¡ä»¶åˆ—æ˜¯ç´¢å¼•åˆ—æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œ**åªè¦æœ‰æ¡ä»¶åˆ—ä¸æ˜¯ç´¢å¼•åˆ—ï¼Œå°±ä¼šè¿›è¡Œå…¨è¡¨æ‰«æ**

è¦è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œå°† age å­—æ®µè®¾ç½®ä¸ºç´¢å¼•å³å¯







### ç´¢å¼•ä¸‹æ¨

å¯¹äºè”åˆç´¢å¼•ï¼ˆa, bï¼‰ï¼Œåœ¨æ‰§è¡Œ `select * from table where a > 1 and b = 2` è¯­å¥çš„æ—¶å€™ï¼Œåªæœ‰ a å­—æ®µèƒ½ç”¨åˆ°ç´¢å¼•ï¼Œé‚£åœ¨è”åˆç´¢å¼•çš„ B+Tree æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ä¸»é”®å€¼ï¼ˆID ä¸º 2ï¼‰åï¼Œè¿˜éœ€è¦åˆ¤æ–­å…¶ä»–æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼ˆçœ‹ b æ˜¯å¦ç­‰äº 2ï¼‰ï¼Œé‚£æ˜¯åœ¨è”åˆç´¢å¼•é‡Œåˆ¤æ–­ï¼Ÿè¿˜æ˜¯å›ä¸»é”®ç´¢å¼•å»åˆ¤æ–­å‘¢ï¼Ÿ

- åœ¨ MySQL 5.6 ä¹‹å‰ï¼Œåªèƒ½ä» ID2 ï¼ˆä¸»é”®å€¼ï¼‰å¼€å§‹ä¸€ä¸ªä¸ªå›è¡¨ï¼Œåˆ°ã€Œä¸»é”®ç´¢å¼•ã€ä¸Šæ‰¾å‡ºæ•°æ®è¡Œï¼Œå†å¯¹æ¯” b å­—æ®µå€¼ã€‚
- è€Œ MySQL 5.6 å¼•å…¥çš„**ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–**ï¼ˆindex condition pushdown)ï¼Œ **å¯ä»¥åœ¨è”åˆç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹è”åˆç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°**





å‡è®¾åˆ›å»ºäº†ä¸€ä¸ª `(a, b, c)` è”åˆç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸º`where a = 1 and c = 3` ï¼Œç¬¦åˆæœ€å·¦åŒ¹é…å—ï¼Ÿ

MySQL 5.5 çš„è¯ï¼Œå‰é¢ a ä¼šèµ°ç´¢å¼•ï¼Œåœ¨è”åˆç´¢å¼•æ‰¾åˆ°ä¸»é”®å€¼åï¼Œå¼€å§‹å›è¡¨ï¼Œåˆ°ä¸»é”®ç´¢å¼•è¯»å–æ•°æ®è¡Œï¼ŒServer å±‚ä»å­˜å‚¨å¼•æ“å±‚è·å–åˆ°æ•°æ®è¡Œåï¼Œç„¶ååœ¨ Server å±‚å†æ¯”å¯¹ c å­—æ®µçš„å€¼ã€‚

ä» MySQL 5.6 ä¹‹åï¼Œæœ‰ä¸€ä¸ª**ç´¢å¼•ä¸‹æ¨åŠŸèƒ½**ï¼Œå¯ä»¥åœ¨å­˜å‚¨å¼•æ“å±‚è¿›è¡Œç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•ï¼Œå†è¿”è¿˜ç»™ Server å±‚ï¼Œä»è€Œå‡å°‘å›è¡¨æ¬¡æ•°ã€‚

ç´¢å¼•ä¸‹æ¨çš„å¤§æ¦‚åŸç†æ˜¯ï¼šæˆªæ–­çš„å­—æ®µä¸ä¼šåœ¨ Server å±‚è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œè€Œæ˜¯ä¼šè¢«ä¸‹æ¨åˆ°ã€Œå­˜å‚¨å¼•æ“å±‚ã€è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼ˆå› ä¸º c å­—æ®µçš„å€¼æ˜¯åœ¨ `(a, b, c)` è”åˆç´¢å¼•é‡Œçš„ï¼‰ï¼Œç„¶åè¿‡æ»¤å‡ºç¬¦åˆæ¡ä»¶çš„æ•°æ®åå†è¿”å›ç»™ Server å±‚ã€‚**ç”±äºåœ¨å¼•æ“å±‚å°±è¿‡æ»¤æ‰å¤§é‡çš„æ•°æ®ï¼Œæ— éœ€å†å›è¡¨è¯»å–æ•°æ®æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°**ï¼Œä»è€Œæå‡äº†æ€§èƒ½ã€‚







### ç´¢å¼•ä¼˜åŒ–

1. **å»ºç«‹è”åˆç´¢å¼•æ—¶ï¼Œè¦æŠŠåŒºåˆ†åº¦å¤§çš„å­—æ®µæ’åœ¨å‰é¢ï¼Œè¿™æ ·åŒºåˆ†åº¦å¤§çš„å­—æ®µè¶Šæœ‰å¯èƒ½è¢«æ›´å¤šçš„ SQL ä½¿ç”¨åˆ°**ï¼Œæ¯”å¦‚ï¼Œæ€§åˆ«çš„åŒºåˆ†åº¦å°±å¾ˆå°ï¼Œä¸é€‚åˆå»ºç«‹ç´¢å¼•æˆ–ä¸é€‚åˆæ’åœ¨è”åˆç´¢å¼•åˆ—çš„é å‰çš„ä½ç½®ï¼Œè€Œ `UUID` è¿™ç±»å­—æ®µå°±æ¯”è¾ƒé€‚åˆåšç´¢å¼•æˆ–æ’åœ¨è”åˆç´¢å¼•åˆ—çš„é å‰çš„ä½ç½®ï¼š æ¯”å¦‚å»ºç«‹ä¸€ä¸ª(aï¼Œbï¼Œc)çš„è”åˆç´¢å¼•ï¼Œaçš„åŒºåˆ†åº¦æ¯”è¾ƒå¤§ï¼Œ`innodb`åœ¨å¯¹aåˆ—è¿›è¡ŒæŸ¥æ‰¾æ—¶å°±å·²ç»è¿‡æ»¤æ‰äº†å¤§å¤šæ•°æ— æ•ˆæ•°æ®

2. å‰ç¼€ç´¢å¼•ä¼˜åŒ–ï¼šæ‰€è°“å‰ç¼€ç´¢å¼•ï¼Œè¯´ç™½äº†å°±æ˜¯**å¯¹æ–‡æœ¬çš„å‰å‡ ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•ï¼ˆå…·ä½“æ˜¯å‡ ä¸ªå­—ç¬¦åœ¨å»ºç«‹ç´¢å¼•æ—¶å»æŒ‡å®šï¼‰**ï¼Œæ¯”å¦‚ä»¥äº§å“åç§°çš„å‰ 10 ä½æ¥å»ºç´¢å¼•ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•æ˜¯ä¸ºäº†å‡å°ç´¢å¼•å­—æ®µå¤§å°ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªç´¢å¼•é¡µä¸­å­˜å‚¨çš„ç´¢å¼•å€¼ï¼Œæœ‰æ•ˆæé«˜ç´¢å¼•çš„æŸ¥è¯¢é€Ÿåº¦ã€‚åœ¨ä¸€äº›å¤§å­—ç¬¦ä¸²çš„å­—æ®µä½œä¸ºç´¢å¼•æ—¶ï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‡å°ç´¢å¼•é¡¹çš„å¤§å°

3. è¦†ç›–ç´¢å¼•ä¼˜åŒ–ï¼šæ˜¯æŒ‡ SQLè¯­å¥ ä¸­æŸ¥è¯¢çš„æ‰€æœ‰å­—æ®µï¼Œä»äºŒçº§ç´¢å¼•ä¸­å°±èƒ½æŸ¥è¯¢å¾—åˆ°è®°å½•ï¼Œè€Œä¸éœ€è¦é€šè¿‡èšç°‡ç´¢å¼•æŸ¥è¯¢è·å¾—ï¼Œé¿å…å›è¡¨æ“ä½œ

   å‡è®¾åªéœ€è¦æŸ¥è¯¢å•†å“çš„åç§°ã€ä»·æ ¼ï¼Œæœ‰ä»€ä¹ˆæ–¹å¼å¯ä»¥é¿å…å›è¡¨å‘¢ï¼Ÿ

   å¯ä»¥å»ºç«‹ä¸€ä¸ªè”åˆç´¢å¼•ï¼Œå³ã€Œå•†å“IDã€åç§°ã€ä»·æ ¼ã€ä½œä¸ºä¸€ä¸ªè”åˆç´¢å¼•ã€‚å¦‚æœç´¢å¼•ä¸­å­˜åœ¨è¿™äº›æ•°æ®ï¼ŒæŸ¥è¯¢å°†ä¸ä¼šå†æ¬¡æ£€ç´¢ä¸»é”®ç´¢å¼•ï¼Œä»è€Œé¿å…å›è¡¨

   æ‰€ä»¥ï¼Œ**ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„å¥½å¤„å°±æ˜¯ï¼Œä¸éœ€è¦æŸ¥è¯¢å‡ºåŒ…å«æ•´è¡Œè®°å½•çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¹Ÿå°±å‡å°‘äº†å¤§é‡çš„ I/O æ“ä½œï¼Œå…¶å®å°±æ˜¯å°½é‡é¿å…å›è¡¨æ“ä½œï¼Œé¿å…ä¸¤æ¬¡æŸ¥æ‰¾B+æ ‘ï¼Œæœ€å¥½åœ¨ç¬¬ä¸€æ¬¡äºŒçº§ç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸Šå°±èƒ½æŸ¥åˆ°æ•°æ®**

4. **ä¸»é”®ç´¢å¼•æœ€å¥½è‡ªå¢**ï¼šInnoDB åˆ›å»ºä¸»é”®ç´¢å¼•é»˜è®¤ä¸ºèšç°‡ç´¢å¼•ï¼Œæ•°æ®è¢«å­˜æ”¾åœ¨äº† B+Tree çš„å¶å­èŠ‚ç‚¹ä¸Šï¼ŒåŒä¸€ä¸ªå¶å­èŠ‚ç‚¹å†…çš„å„ä¸ªæ•°æ®æ˜¯æŒ‰ä¸»é”®é¡ºåºå­˜æ”¾çš„ï¼Œå› æ­¤ï¼Œæ¯å½“æœ‰ä¸€æ¡æ–°çš„æ•°æ®æ’å…¥æ—¶ï¼Œæ•°æ®åº“ä¼šæ ¹æ®ä¸»é”®å°†å…¶æ’å…¥åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ä¸­

   **å¦‚æœæˆ‘ä»¬ä½¿ç”¨è‡ªå¢ä¸»é”®**ï¼Œé‚£ä¹ˆæ¯æ¬¡æ’å…¥çš„æ–°æ•°æ®å°±ä¼šæŒ‰é¡ºåºæ·»åŠ åˆ°å½“å‰ç´¢å¼•èŠ‚ç‚¹çš„ä½ç½®ï¼Œä¸éœ€è¦ç§»åŠ¨å·²æœ‰çš„æ•°æ®ï¼Œå½“é¡µé¢å†™æ»¡ï¼Œå°±ä¼šè‡ªåŠ¨å¼€è¾Ÿä¸€ä¸ªæ–°é¡µé¢ã€‚å› ä¸ºæ¯æ¬¡**æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼Œéƒ½æ˜¯è¿½åŠ æ“ä½œï¼Œä¸éœ€è¦é‡æ–°ç§»åŠ¨æ•°æ®**

   **å¦‚æœæˆ‘ä»¬ä½¿ç”¨éè‡ªå¢ä¸»é”®**ï¼Œç”±äºæ¯æ¬¡æ’å…¥ä¸»é”®çš„ç´¢å¼•å€¼éƒ½æ˜¯éšæœºçš„ï¼Œå› æ­¤**æ¯æ¬¡æ’å…¥æ–°çš„æ•°æ®æ—¶ï¼Œå°±å¯èƒ½ä¼šæ’å…¥åˆ°ç°æœ‰æ•°æ®é¡µä¸­é—´çš„æŸä¸ªä½ç½®ï¼Œè¿™å°†ä¸å¾—ä¸ç§»åŠ¨å…¶å®ƒæ•°æ®æ¥æ»¡è¶³æ–°æ•°æ®çš„æ’å…¥ï¼Œç”šè‡³éœ€è¦ä»ä¸€ä¸ªé¡µé¢å¤åˆ¶æ•°æ®åˆ°å¦å¤–ä¸€ä¸ªé¡µé¢**ï¼Œæˆ‘ä»¬é€šå¸¸å°†è¿™ç§æƒ…å†µç§°ä¸º**é¡µåˆ†è£‚**ï¼Œ**é¡µåˆ†è£‚è¿˜æœ‰å¯èƒ½ä¼šé€ æˆå¤§é‡çš„å†…å­˜ç¢ç‰‡ï¼Œå¯¼è‡´ç´¢å¼•ç»“æ„ä¸ç´§å‡‘ï¼Œä»è€Œå½±å“æŸ¥è¯¢æ•ˆç‡**

   

5. ç´¢å¼•åˆ—æœ€å¥½è®¾ç½®`NOT NULL`çº¦æŸ: ç´¢å¼•åˆ—å­˜åœ¨ NULL å°±ä¼šå¯¼è‡´ä¼˜åŒ–å™¨åœ¨åšç´¢å¼•é€‰æ‹©çš„æ—¶å€™æ›´åŠ å¤æ‚ï¼Œæ›´åŠ éš¾ä»¥ä¼˜åŒ–,ä¸”`NULL` å€¼æ˜¯ä¸€ä¸ªæ²¡æ„ä¹‰çš„å€¼ï¼Œä½†æ˜¯å®ƒä¼šå ç”¨ç‰©ç†ç©ºé—´

6. é˜²æ­¢ç´¢å¼•å¤±æ•ˆï¼šå…ˆç®€å•è¯´ä¸€ä¸‹ï¼Œå‘ç”Ÿç´¢å¼•å¤±æ•ˆçš„æƒ…å†µï¼š

   - å½“æˆ‘ä»¬ä½¿ç”¨å·¦æˆ–è€…å·¦å³æ¨¡ç³ŠåŒ¹é…çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ `like %xx` æˆ–è€… `like %xx%`è¿™ä¸¤ç§æ–¹å¼éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼›
   - å½“æˆ‘ä»¬åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•åˆ—åšäº†è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢æ“ä½œï¼Œè¿™äº›æƒ…å†µä¸‹éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼›
   - è”åˆç´¢å¼•è¦èƒ½æ­£ç¡®ä½¿ç”¨éœ€è¦éµå¾ªæœ€å·¦åŒ¹é…åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§æœ€å·¦ä¼˜å…ˆçš„æ–¹å¼è¿›è¡Œç´¢å¼•çš„åŒ¹é…ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼›
   - **åœ¨ `WHERE` å­å¥ä¸­**ï¼Œ**å¦‚æœåœ¨ OR å‰çš„æ¡ä»¶åˆ—æ˜¯ç´¢å¼•åˆ—ï¼Œè€Œåœ¨ OR åçš„æ¡ä»¶åˆ—ä¸æ˜¯ç´¢å¼•åˆ—ï¼Œé‚£ä¹ˆç´¢å¼•ä¼šå¤±æ•ˆ**









### ä»€ä¹ˆæ—¶å€™é€‚ç”¨/ä¸é€‚ç”¨ç´¢å¼•ï¼Ÿ

é€‚ç”¨ç´¢å¼•çš„ï¼š 

- å­—æ®µæœ‰å”¯ä¸€æ€§é™åˆ¶çš„ï¼Œæ¯”å¦‚å•†å“ç¼–ç ï¼›
- ç»å¸¸ç”¨äº `WHERE` æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µï¼Œè¿™æ ·èƒ½å¤Ÿæé«˜æ•´ä¸ªè¡¨çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œå¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸æ˜¯ä¸€ä¸ªå­—æ®µï¼Œå¯ä»¥å»ºç«‹è”åˆç´¢å¼•ï¼›
- ç»å¸¸ç”¨äº `GROUP BY` å’Œ `ORDER BY` çš„å­—æ®µï¼Œè¿™æ ·åœ¨æŸ¥è¯¢çš„æ—¶å€™å°±ä¸éœ€è¦å†å»åšä¸€æ¬¡æ’åºäº†ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½å·²ç»çŸ¥é“äº†å»ºç«‹ç´¢å¼•ä¹‹ååœ¨ B+Tree ä¸­çš„è®°å½•éƒ½æ˜¯æ’åºå¥½çš„
- å¤§è¡¨çš„æŸ¥è¯¢ä¼˜åŒ–ï¼š å¯¹äºå¤§å‹è¡¨ï¼Œä½¿ç”¨ç´¢å¼•å¯ä»¥æå¤§åœ°æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥å‡å°‘éœ€è¦æ‰«æçš„æ•°æ®é‡ã€‚

ä¸é€‚ç”¨çš„æƒ…å†µï¼š

- **ç»å¸¸æ›´æ–°çš„å­—æ®µä¸ç”¨åˆ›å»ºç´¢å¼•**ï¼Œæ¯”å¦‚ä¸è¦å¯¹ç”µå•†é¡¹ç›®çš„ç”¨æˆ·ä½™é¢å»ºç«‹ç´¢å¼•ï¼Œå› ä¸ºç´¢å¼•å­—æ®µé¢‘ç¹ä¿®æ”¹ï¼Œç”±äºè¦ç»´æŠ¤ B+Treeçš„æœ‰åºæ€§ï¼Œé‚£ä¹ˆå°±éœ€è¦é¢‘ç¹çš„é‡å»ºç´¢å¼•ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ä¼šå½±å“æ•°æ®åº“æ€§èƒ½ï¼›
- `WHERE` æ¡ä»¶ï¼Œ`GROUP BY`ï¼Œ`ORDER BY` é‡Œç”¨ä¸åˆ°çš„å­—æ®µï¼Œç´¢å¼•çš„ä»·å€¼æ˜¯å¿«é€Ÿå®šä½ï¼Œå¦‚æœèµ·ä¸åˆ°å®šä½çš„å­—æ®µé€šå¸¸æ˜¯ä¸éœ€è¦åˆ›å»ºç´¢å¼•çš„ï¼Œå› ä¸ºç´¢å¼•æ˜¯ä¼šå ç”¨ç‰©ç†ç©ºé—´çš„ï¼›
- å­—æ®µä¸­å­˜åœ¨å¤§é‡é‡å¤æ•°æ®ï¼Œä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Œæ¯”å¦‚æ€§åˆ«å­—æ®µï¼Œåªæœ‰ç”·å¥³ï¼Œå¦‚æœæ•°æ®åº“è¡¨ä¸­ï¼Œç”·å¥³çš„è®°å½•åˆ†å¸ƒå‡åŒ€ï¼Œé‚£ä¹ˆæ— è®ºæœç´¢å“ªä¸ªå€¼éƒ½å¯èƒ½å¾—åˆ°ä¸€åŠçš„æ•°æ®ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œè¿˜ä¸å¦‚ä¸è¦ç´¢å¼•ï¼Œ**å› ä¸º `MySQL` è¿˜æœ‰ä¸€ä¸ªæŸ¥è¯¢ä¼˜åŒ–å™¨ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å‘ç°æŸä¸ªå€¼å‡ºç°åœ¨è¡¨çš„æ•°æ®è¡Œä¸­çš„ç™¾åˆ†æ¯”å¾ˆé«˜çš„æ—¶å€™ï¼Œå®ƒä¸€èˆ¬ä¼šå¿½ç•¥ç´¢å¼•ï¼Œè¿›è¡Œå…¨è¡¨æ‰«æ**ï¼›
- è¡¨æ•°æ®å¤ªå°‘çš„æ—¶å€™ï¼Œä¸éœ€è¦åˆ›å»ºç´¢å¼•
- å°è¡¨ï¼š å¯¹äºå°å‹è¡¨ï¼Œç´¢å¼•å¯èƒ½ä¸ä¼šå¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç”šè‡³å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œå› ä¸ºé¢å¤–çš„ç´¢å¼•å¯èƒ½å¢åŠ äº†å†™æ“ä½œçš„å¼€é”€ã€‚







## äº‹åŠ¡

 `MySQL` åŸç”Ÿçš„ `MyISAM` å¼•æ“å°±ä¸æ”¯æŒäº‹åŠ¡,æˆ‘ä»¬å¸¸è§çš„ `InnoDB` å¼•æ“å®ƒæ˜¯æ”¯æŒäº‹åŠ¡çš„



### ACID

**åŸå­æ€§ï¼ˆAtomicityï¼‰**ï¼šåŸå­æ€§ç¡®ä¿**ä¸€ä¸ªäº‹åŠ¡**ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸå®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šåˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ã€‚äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œï¼Œè€ƒè™‘ä¸€ä¸ªè½¬è´¦æ“ä½œçš„äº‹åŠ¡ï¼ŒåŒ…æ‹¬ä»ä¸€ä¸ªè´¦æˆ·æ‰£æ¬¾å’Œå‘å¦ä¸€ä¸ªè´¦æˆ·å­˜æ¬¾ã€‚åŸå­æ€§è¦æ±‚å¦‚æœä»»ä¸€éƒ¨åˆ†æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½åº”å›æ»šï¼Œä¸åº”æœ‰éƒ¨åˆ†è½¬è´¦æˆåŠŸæˆ–å¤±è´¥çš„æƒ…å†µå‘ç”Ÿ



**ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**ï¼šæ˜¯æŒ‡äº‹åŠ¡æ“ä½œå‰å’Œæ“ä½œåï¼Œæ•°æ®æ»¡è¶³å®Œæ•´æ€§çº¦æŸï¼Œæ•°æ®åº“ä¿æŒä¸€è‡´æ€§çŠ¶æ€ã€‚æ¯”å¦‚ï¼Œç”¨æˆ· A å’Œç”¨æˆ· B åœ¨é“¶è¡Œåˆ†åˆ«æœ‰ 800 å…ƒå’Œ 600 å…ƒï¼Œæ€»å…± 1400 å…ƒï¼Œç”¨æˆ· A ç»™ç”¨æˆ· B è½¬è´¦ 200 å…ƒï¼Œåˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼Œä» A çš„è´¦æˆ·æ‰£é™¤ 200 å…ƒå’Œå¯¹ B çš„è´¦æˆ·å¢åŠ  200 å…ƒã€‚ä¸€è‡´æ€§å°±æ˜¯è¦æ±‚ä¸Šè¿°æ­¥éª¤æ“ä½œåï¼Œæœ€åçš„ç»“æœæ˜¯ç”¨æˆ· A è¿˜æœ‰ 600 å…ƒï¼Œç”¨æˆ· B æœ‰ 800 å…ƒï¼Œæ€»å…± 1400 å…ƒï¼Œè€Œä¸ä¼šå‡ºç°ç”¨æˆ· A æ‰£é™¤äº† 200 å…ƒï¼Œä½†ç”¨æˆ· B æœªå¢åŠ çš„æƒ…å†µï¼ˆè¯¥æƒ…å†µï¼Œç”¨æˆ· A å’Œ B å‡ä¸º 600 å…ƒï¼Œæ€»å…± 1200 å…ƒï¼‰

**éš”ç¦»æ€§ï¼ˆIsolationï¼‰**ï¼šæ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹å…¶æ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œ**éš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´**ï¼Œ**å› ä¸ºå¤šä¸ªäº‹åŠ¡åŒæ—¶ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ—¶ï¼Œä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå®Œæ•´çš„æ•°æ®ç©ºé—´ï¼Œå¯¹å…¶ä»–å¹¶å‘äº‹åŠ¡æ˜¯éš”ç¦»çš„**

**æŒä¹…æ€§ï¼ˆDurabilityï¼‰**ï¼šæŒä¹…æ€§ç¡®ä¿ä¸€æ—¦äº‹åŠ¡æäº¤`commit`ï¼Œå…¶**å¯¹æ•°æ®åº“çš„æ”¹å˜å°†æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿åœ¨ç³»ç»Ÿæ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿæ˜¯å¦‚æ­¤**ã€‚å·²æäº¤çš„äº‹åŠ¡çš„ç»“æœå°†è¢«å†™å…¥æ°¸ä¹…å­˜å‚¨ä»‹è´¨ï¼ˆå¦‚ç£ç›˜ï¼‰ï¼Œä»¥ä¾¿åœ¨ç³»ç»Ÿæ•…éšœåå¯ä»¥æ¢å¤



InnoDB å¼•æ“é€šè¿‡ä»€ä¹ˆæŠ€æœ¯æ¥ä¿è¯äº‹åŠ¡çš„è¿™å››ä¸ªç‰¹æ€§çš„å‘¢ï¼Ÿ

- æŒä¹…æ€§æ˜¯é€šè¿‡ `redo log` ï¼ˆé‡åšæ—¥å¿—ï¼‰æ¥ä¿è¯çš„ï¼›
- åŸå­æ€§æ˜¯é€šè¿‡ `undo log`ï¼ˆå›æ»šæ—¥å¿—ï¼‰ æ¥ä¿è¯çš„ï¼›
- éš”ç¦»æ€§æ˜¯é€šè¿‡ `MVCC`ï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ æˆ–é”æœºåˆ¶æ¥ä¿è¯çš„ï¼›
- ä¸€è‡´æ€§åˆ™æ˜¯é€šè¿‡æŒä¹…æ€§+åŸå­æ€§+éš”ç¦»æ€§æ¥ä¿è¯ï¼›





### å¹¶è¡Œäº‹åŠ¡é—®é¢˜+éš”ç¦»çº§åˆ«

1ã€è„è¯»(ä¸€ä¸ªäº‹åŠ¡è¯»å–åˆ°äº†å¦ä¸€ä¸ªäº‹åŠ¡æœªæäº¤ä¿®æ”¹çš„æ•°æ®)

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%84%8F%E8%AF%BB.webp" style="zoom:80%;" />

å› ä¸ºäº‹åŠ¡ A æ˜¯è¿˜æ²¡æäº¤äº‹åŠ¡çš„ï¼Œä¹Ÿå°±æ˜¯å®ƒéšæ—¶å¯èƒ½å‘ç”Ÿå›æ»šæ“ä½œï¼Œ**å¦‚æœåœ¨ä¸Šé¢è¿™ç§æƒ…å†µäº‹åŠ¡ A å‘ç”Ÿäº†å›æ»šï¼Œé‚£ä¹ˆäº‹åŠ¡ B åˆšæ‰å¾—åˆ°çš„æ•°æ®å°±æ˜¯è¿‡æœŸçš„æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±è¢«ç§°ä¸ºè„è¯»**

äº‹åŠ¡Aåœ¨æœªæäº¤ä¹‹å‰ï¼Œè¯»åˆ°äº†å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®äº†ï¼



2ã€ä¸å¯é‡å¤è¯»

**åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€ä¸ªæ•°æ®**ï¼Œå¦‚æœå‡ºç°å‰åä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†ã€Œä¸å¯é‡å¤è¯»ã€ç°è±¡ï¼Œå‡è®¾æœ‰ A å’Œ B è¿™ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶åœ¨å¤„ç†ï¼Œäº‹åŠ¡ A å…ˆå¼€å§‹ä»æ•°æ®åº“ä¸­è¯»å–å°æ—çš„ä½™é¢æ•°æ®ï¼Œç„¶åç»§ç»­æ‰§è¡Œä»£ç é€»è¾‘å¤„ç†ï¼Œ**åœ¨è¿™è¿‡ç¨‹ä¸­å¦‚æœäº‹åŠ¡ B æ›´æ–°äº†è¿™æ¡æ•°æ®ï¼Œå¹¶æäº¤äº†äº‹åŠ¡ï¼Œé‚£ä¹ˆå½“äº‹åŠ¡ A å†æ¬¡è¯»å–è¯¥æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç°å‰åä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™ç§ç°è±¡å°±è¢«ç§°ä¸ºä¸å¯é‡å¤è¯»**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB.webp" style="zoom:80%;" />

äº‹åŠ¡Aåœ¨æœªæäº¤ä¹‹å‰ï¼Œè¯»åˆ°äº†å…¶ä»–äº‹åŠ¡æäº¤çš„æ•°æ®äº†ï¼





3ã€å¹»è¯»

**åœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢**æŸä¸ªç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„ã€Œè®°å½•æ•°é‡ã€ï¼Œå¦‚æœå‡ºç°å‰åä¸¤æ¬¡æŸ¥è¯¢åˆ°çš„è®°å½•æ•°é‡ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†ã€Œå¹»è¯»ã€ç°è±¡

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%B9%BB%E8%AF%BB.webp" style="zoom:80%;" />



é’ˆå¯¹ä»¥ä¸Šä¸‰ç§ç°è±¡ï¼ŒSQL æ ‡å‡†æå‡ºäº†å››ç§éš”ç¦»çº§åˆ«æ¥è§„é¿è¿™äº›ç°è±¡ï¼Œéš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ€§èƒ½æ•ˆç‡å°±è¶Šä½

è¿™å››ä¸ªéš”ç¦»çº§åˆ«å¦‚ä¸‹ï¼š

- **è¯»æœªæäº¤ï¼ˆread uncommittedï¼‰**æŒ‡ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°(å¯¹åº”è„è¯»)ï¼›
- **è¯»æäº¤ï¼ˆread committedï¼‰**æŒ‡ä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰èƒ½è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ï¼Œæœªæäº¤çš„æ•°æ®å…¶ä»–äº‹åŠ¡æ˜¯çœ‹ä¸åˆ°çš„(è§£å†³äº†è„è¯»ï¼Œä½†æ˜¯æ²¡æœ‰è§£å†³ä¸å¯é‡å¤è¯»)ï¼›
- **å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰**ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œä¸€ç›´è·Ÿè¿™ä¸ªäº‹åŠ¡å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œ**MySQL InnoDB å¼•æ“çš„é»˜è®¤éš”ç¦»çº§åˆ«**(è§£å†³äº†å¯é‡å¤è¯»ï¼Œ**å¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³äº†å¹»è¯»**)ï¼›
- **ä¸²è¡ŒåŒ–ï¼ˆserializableï¼‰**ï¼›ä¼šå¯¹è®°å½•åŠ ä¸Šè¯»å†™é”ï¼Œåœ¨å¤šä¸ªäº‹åŠ¡å¯¹è¿™æ¡è®°å½•è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå¦‚æœå‘ç”Ÿäº†è¯»å†™å†²çªçš„æ—¶å€™ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼›



**å¦‚ä½•è§£å†³å¹»è¯»ï¼Ÿ**



**`MySQL` å¹¶ä¸ä¼šä½¿ç”¨ã€Œä¸²è¡ŒåŒ–ã€éš”ç¦»çº§åˆ«æ¥é¿å…å¹»è¯»ç°è±¡çš„å‘ç”Ÿ**ï¼Œå› ä¸ºä½¿ç”¨ã€Œä¸²è¡ŒåŒ–ã€éš”ç¦»çº§åˆ«ä¼šå½±å“æ€§èƒ½ï¼Œ`Innodb`é»˜è®¤éš”ç¦»çº§åˆ«ã€Œå¯é‡å¤è¯»ã€é¿å…å¹»è¯»çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š

- é’ˆå¯¹**å¿«ç…§è¯»**ï¼ˆæ™®é€š `select` è¯­å¥ï¼‰ï¼Œæ˜¯**é€šè¿‡ MVCC æ–¹å¼è§£å†³äº†å¹»è¯»**ï¼Œå› ä¸ºå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œä¸€ç›´è·Ÿè¿™ä¸ªäº‹åŠ¡å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œå³ä½¿ä¸­é€”æœ‰å…¶ä»–äº‹åŠ¡æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œæ˜¯æŸ¥è¯¢ä¸å‡ºæ¥è¿™æ¡æ•°æ®çš„ï¼Œæ‰€ä»¥å°±å¾ˆå¥½äº†é¿å…å¹»è¯»é—®é¢˜

- é’ˆå¯¹**å½“å‰è¯»**ï¼ˆ`select` ... `for update` ã€`select .... for share`è¯­å¥ï¼‰ï¼Œæ˜¯**é€šè¿‡ `next-key lock`ï¼ˆè®°å½•é”+é—´éš™é”ï¼‰æ–¹å¼è§£å†³äº†å¹»è¯»**ï¼Œå› ä¸ºå½“æ‰§è¡Œ `select ... for update` è¯­å¥çš„æ—¶å€™ï¼Œä¼šåŠ ä¸Š `next-key lock`ï¼Œå¦‚æœæœ‰å…¶ä»–äº‹åŠ¡åœ¨ `next-key lock` é”èŒƒå›´å†…æ’å…¥äº†ä¸€æ¡è®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ’å…¥è¯­å¥å°±ä¼šè¢«é˜»å¡ï¼Œæ— æ³•æˆåŠŸæ’å…¥ï¼Œæ‰€ä»¥å°±å¾ˆå¥½äº†é¿å…å¹»è¯»é—®é¢˜

  > `SELECT FOR SHARE` å’Œ `SELECT IN SHARE MODE` éƒ½æ˜¯ç”¨äºæŸ¥è¯¢æ—¶è®¾ç½®å…±äº«é”(é˜»å¡å†™æ“ä½œ)çš„æ–¹å¼ï¼Œå®ƒä»¬éƒ½ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡çš„å†™æ“ä½œï¼Œä½†ä¸ä¼šé˜»å¡å…¶ä»–äº‹åŠ¡çš„è¯»æ“ä½œ

 







### MVCC :astonished:

`MVCC` = éšå¼åˆ—å±æ€§ + `undo log`ç‰ˆæœ¬é“¾(åŒä¸€è¡Œè®°å½•åœ¨ä¸åŒæ—¶é—´ç‚¹ä¸Šçš„`Undo Log`å½¢æˆçš„é“¾å¼ç»“æ„) + `ReadView`



**éšå¼åˆ—ï¼š**

é¦–å…ˆæ¥çœ‹çœ‹ä¸€è¡Œè®°å½•çš„çœŸå®å­—æ®µæœ‰å“ªäº›

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%AE%B0%E5%BD%95%E7%9A%84%E7%9C%9F%E5%AE%9E%E6%95%B0%E6%8D%AE.webp)

- `row_id`

å¦‚æœæˆ‘ä»¬å»ºè¡¨çš„æ—¶å€™æŒ‡å®šäº†ä¸»é”®æˆ–è€…å”¯ä¸€çº¦æŸåˆ—ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰ row_id éšè—å­—æ®µäº†ã€‚å¦‚æœæ—¢æ²¡æœ‰æŒ‡å®šä¸»é”®ï¼Œåˆæ²¡æœ‰å”¯ä¸€çº¦æŸï¼Œé‚£ä¹ˆ InnoDB å°±ä¼šä¸ºè®°å½•æ·»åŠ  row_id éšè—å­—æ®µï¼Œ`row_id`ä¸æ˜¯å¿…éœ€çš„

- `trx_id`

äº‹åŠ¡idï¼Œè¡¨ç¤ºè¿™ä¸ªæ•°æ®æ˜¯ç”±å“ªä¸ª**æœ€æ–°**äº‹åŠ¡æ“ä½œè¿‡çš„ï¼Œ `trx_id`æ˜¯å¿…éœ€çš„

- `roll_pointer`

æŒ‡å‘è¿™æ¡è®°å½•ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„æŒ‡é’ˆï¼Œ`roll_pointer` æ˜¯å¿…éœ€çš„

å‡è®¾åœ¨è´¦æˆ·ä½™é¢è¡¨æ’å…¥ä¸€æ¡å°æ—ä½™é¢ä¸º 100 ä¸‡çš„è®°å½•ï¼Œç„¶åæˆ‘æŠŠè¿™ä¸¤ä¸ªéšè—åˆ—ä¹Ÿç”»å‡ºæ¥ï¼Œè¯¥è®°å½•çš„æ•´ä¸ªç¤ºæ„å›¾å¦‚ä¸‹ï¼š![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E9%9A%90%E5%A3%AB%E5%88%97.webp)

å¯¹äºä½¿ç”¨ InnoDB å­˜å‚¨å¼•æ“çš„æ•°æ®åº“è¡¨ï¼Œå®ƒçš„èšç°‡ç´¢å¼•è®°å½•ä¸­éƒ½åŒ…å«ä¸‹é¢ä¸¤ä¸ªéšè—åˆ—ï¼š

- `trx_id`ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶(å› ä¸ºä¸€æ—¦å¯¹æŸæ¡è®°å½•åšäº†ä¿®æ”¹ï¼Œå­˜å‚¨åœ¨èšç°‡ç´¢å¼•B+æ ‘å¶å­èŠ‚ç‚¹çš„æ•°æ®è‚¯å®šä¹Ÿä¼šå˜æ›´)ï¼Œå°±ä¼š**æŠŠè¯¥äº‹åŠ¡çš„äº‹åŠ¡ id è®°å½•åœ¨ trx_id éšè—åˆ—é‡Œ**ï¼›
- `roll_pointer`ï¼Œæ¯æ¬¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§ç‰ˆæœ¬çš„è®°å½•å†™å…¥åˆ° undo æ—¥å¿—ä¸­ï¼Œç„¶å**è¿™ä¸ªéšè—åˆ—æ˜¯ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ¯ä¸€ä¸ªæ—§ç‰ˆæœ¬è®°å½•**ï¼Œäºæ˜¯å°±å¯ä»¥é€šè¿‡å®ƒæ‰¾åˆ°ä¿®æ”¹å‰çš„è®°å½•





**Read-View:**

**Read-Viewæ˜¯"å¿«ç…§è¯»"SQLæ‰§è¡Œæ—¶MVCCæå–æ•°æ®çš„ä¾æ®**ï¼Œå¿«ç…§è¯»å°±æ˜¯æ™®é€šçš„selectè¯­å¥ï¼Œå½“å‰è¯»æŒ‡çš„æ˜¯æ‰§è¡Œä¸‹åˆ—sqlè¯­å¥æ—¶è¿›è¡Œæ•°æ®è¯»å–(æ­¤æ—¶ä½¿ç”¨next-key lock)çš„æ–¹å¼ï¼š

Insertã€Updateã€Deleteã€Select... for updateã€Select... lock in share mode 

å†æ¥çœ‹çœ‹`Read-View`

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/readview%E7%BB%93%E6%9E%84.drawio.webp" style="zoom:67%;" />

æ¯ä¸ªRead View æœ‰å››ä¸ªé‡è¦çš„å­—æ®µï¼š

- `m_ids` ï¼šæŒ‡çš„æ˜¯åœ¨åˆ›å»º Read View æ—¶ï¼Œå½“å‰æ•°æ®åº“ä¸­ã€Œæ´»è·ƒäº‹åŠ¡ã€çš„**äº‹åŠ¡ id åˆ—è¡¨**ï¼Œæ³¨æ„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œ**â€œæ´»è·ƒäº‹åŠ¡â€æŒ‡çš„å°±æ˜¯ï¼Œå¯åŠ¨äº†ä½†è¿˜æ²¡æäº¤çš„äº‹åŠ¡**
- `min_trx_id` ï¼šæŒ‡çš„æ˜¯åœ¨åˆ›å»º Read View æ—¶ï¼Œå½“å‰æ•°æ®åº“ä¸­ã€Œæ´»è·ƒäº‹åŠ¡ã€ä¸­äº‹åŠ¡ **id æœ€å°çš„äº‹åŠ¡**ï¼Œä¹Ÿå°±æ˜¯ m_ids çš„æœ€å°å€¼
- `max_trx_id` ï¼šè¿™ä¸ªå¹¶ä¸æ˜¯ m_ids çš„æœ€å¤§å€¼ï¼Œè€Œæ˜¯**åˆ›å»º Read View æ—¶å½“å‰æ•°æ®åº“ä¸­åº”è¯¥ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ id å€¼**ï¼Œä¹Ÿå°±æ˜¯**å…¨å±€äº‹åŠ¡ä¸­æœ€å¤§çš„äº‹åŠ¡ id å€¼ + 1**ï¼›
- `creator_trx_id` ï¼šæŒ‡çš„æ˜¯**åˆ›å»ºè¯¥ Read View çš„äº‹åŠ¡çš„äº‹åŠ¡ id**



æ¯æ¬¡å¿«ç…§è¯»æ‰§è¡Œæ—¶ä¼šç”Ÿæˆä¸€ä¸ª`Read-View` 

åœ¨åˆ›å»º `Read View` åï¼Œæˆ‘ä»¬å¯ä»¥å°†è®°å½•ä¸­çš„ `trx_id` åˆ’åˆ†è¿™ä¸‰ç§æƒ…å†µï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/ReadView.drawio.webp)

å½“ä¸€ä¸ªäº‹åŠ¡å»è®¿é—®ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œé™¤äº†è‡ªå·±çš„æ›´æ–°è®°å½•æ€»æ˜¯å¯è§ä¹‹å¤–ï¼Œè¿˜æœ‰è¿™å‡ ç§æƒ…å†µï¼š

- å¦‚æœè¯¥è®°å½•çš„ trx_id å€¼å°äº Read View ä¸­çš„ `min_trx_id` å€¼ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬çš„è®°å½•æ˜¯**åœ¨åˆ›å»º Read View å‰å·²ç»æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„**ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**å¯è§**
- å¦‚æœè¯¥è®°å½•çš„ trx_id å€¼**å¤§äºç­‰äº** Read View ä¸­çš„ `max_trx_id` å€¼ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬çš„è®°å½•æ˜¯**åœ¨åˆ›å»º Read View åæ‰å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„**ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**ä¸å¯è§**
- å¦‚æœè¯¥è®°å½•çš„ `trx_id` å€¼åœ¨ Read View çš„ `min_trx_id` å’Œ `max_trx_id` ä¹‹é—´ï¼Œéœ€è¦åˆ¤æ–­ trx_id æ˜¯å¦åœ¨ m_ids åˆ—è¡¨ä¸­:
  - å¦‚æœè®°å½•çš„ trx_id **åœ¨** `m_ids` åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºç”Ÿæˆè¯¥ç‰ˆæœ¬è®°å½•çš„æ´»è·ƒäº‹åŠ¡ä¾ç„¶æ´»è·ƒç€ï¼ˆ**è¿˜æ²¡æäº¤äº‹åŠ¡**ï¼‰ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**ä¸å¯è§**
  - å¦‚æœè®°å½•çš„ trx_id **ä¸åœ¨** `m_ids`åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºç”Ÿæˆè¯¥ç‰ˆæœ¬è®°å½•çš„æ´»è·ƒäº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**å¯è§**



**ä¸€æ—¦å‡ºç°äº†ä¸å¯è§çš„æƒ…å†µï¼Œå°±æ²¿`undolog`ç‰ˆæœ¬é“¾å›é€€åˆ°å‰ä¸€ç‰ˆæœ¬çš„è¡Œè®°å½•ï¼Œç„¶åå†ç”¨å‰ä¸€ä¸ªç‰ˆæœ¬çš„`trx_id`å†æ¬¡å’Œ`ReadView`åšæ¯”å¯¹**







`Innodb`å¼•æ“ä¸‹é»˜è®¤å°±å¯ä»¥è§£å†³ä¸å¯é‡å¤è¯»å’Œå¹»è¯»(ä¸€å®šç¨‹åº¦ä¸Š)ï¼Œä¸‹é¢æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼š

1ã€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸åŒçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¼šå¯¼è‡´select1+select2è¯­å¥çš„ç»“æœä¸ä¸€è‡´ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE1.png)



è¯¥ä¾‹å­ä¸‹åŸºäº`UNDO-LOG`çš„ç‰ˆæœ¬é“¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE2.png)

æ³¨æ„ï¼šæ— è®º`Update`æ“ä½œæ˜¯å¦æäº¤éƒ½å°†è¢«è®°å½•åˆ°`undo-log`ç‰ˆæœ¬é“¾ä¸­ï¼Œä¸”`undo-log`ç‰ˆæœ¬é“¾ç”¨å®Œåä¸æ˜¯ç«‹å³åˆ é™¤ï¼Œ`Mysql`ç¡®ä¿ç‰ˆæœ¬é“¾æ•°æ®ä¸å†è¢«"å¼•ç”¨"åæ‰ä¼šè¿›è¡Œåˆ é™¤



2ã€æ¥çœ‹ä¸€ä¸‹è¯»å·²æäº¤(RC)çº§åˆ«ä¸‹,ä¸¤æ¬¡å¿«ç…§è¯»å„ç”Ÿæˆçš„`Read-View`ï¼š





3ã€å†ç»“åˆ`undo-log`ç‰ˆæœ¬é“¾å’Œ`Read-View`åˆ†æä¸€ä¸‹å¿«ç…§è¯»çš„ç»“æœï¼š

ç¬¬ä¸€æ¬¡å¿«ç…§è¯»çš„ç»“æœï¼šå…ˆç”¨`trx_id`ä¸º2çš„ç‰ˆæœ¬åšæ¯”å¯¹ï¼Œå‘ç°æ¯”è¾ƒä¸å‡ºç»“æœåï¼Œå†æ²¿`undolog`é“¾è¡¨éå†å›é€€åˆ°å‰ä¸€ä¸ªç‰ˆæœ¬ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒ

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mvcc1.png)





ç¬¬äºŒæ¬¡å¿«ç…§è¯»çš„ç»“æœï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mvcc2.png)



**å³æ¯æ¬¡æ¯”è¾ƒæ—¶ï¼Œä»`undo log`ç‰ˆæœ¬é“¾çš„æœ€é¡¶ç«¯å’Œå½“å‰å¿«ç…§è¯»ç”Ÿæˆçš„Read-Viewè§†å›¾æ¥è¿›è¡Œä¸€ä¸€æ¯”å¯¹(æ¯”å¯¹è§„åˆ™åœ¨å›¾ä¸­)ï¼Œå¦‚æœæ¯”å¯¹å¤±è´¥åˆ™å‘ä¸‹éå†`undo log`ç‰ˆæœ¬é“¾ï¼Œç›´è‡³æ¯”å¯¹æˆåŠŸ**







**è€Œå¯¹äºå¯é‡å¤è¯»RRéš”ç¦»çº§åˆ«ï¼Œä»…åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§è¯»æ—¶ç”ŸæˆRead-View,åç»­å¿«ç…§è¯»ä¼šå¤ç”¨ï¼**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mvcc3.png)

å³åœ¨RRçº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Dç¬¬äºŒæ¬¡å¿«ç…§è¯»æ—¶ç”Ÿæˆçš„Read-Viewç›´æ¥å¤ç”¨äº†ä¸Šä¸€æ¬¡å¿«ç…§è¯»æ‰€ç”Ÿæˆçš„ï¼Œè€Œundo-logç‰ˆæœ¬é“¾ä¹Ÿæ²¡æœ‰å‘ç”Ÿå˜åŒ–(æ²¡æœ‰å…¶ä»–äº‹åŠ¡è¿›è¡Œæ›´æ–°æ“ä½œ)ï¼Œå› æ­¤è§£å†³äº†ä¸å¯é‡å¤è¯»





å†æ¥çœ‹çœ‹RRçº§åˆ«ä¸‹å‘ç”Ÿå¹»è¯»çš„ä¾‹å­ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%B9%BB%E8%AF%BB.png)



**æ€»ç»“ï¼š**

- **RCçº§åˆ«ä¸‹ï¼šæ¯æ¬¡å¿«ç…§è¯»å‡ä¼šç”Ÿæˆ `Read-View`(å› æ­¤ä¼šå¯¼è‡´ä¸å¯é‡å¤è¯»ï¼ï¼ï¼)**
- RRçº§åˆ«ä¸‹ï¼šè¿ç»­å¤šæ¬¡å¿«ç…§è¯»ï¼Œ`Read-View` ä¼šäº§ç”Ÿå¤ç”¨ï¼Œæ²¡æœ‰ä¸å¯é‡å¤è¯»é—®é¢˜
- RRçº§åˆ«ä¸‹ï¼šå½“ä¸¤æ¬¡å¿«ç…§è¯»ä¹‹é—´å­˜åœ¨å½“å‰è¯»ï¼Œ`Read-View` ä¼šé‡æ–°ç”Ÿæˆï¼Œå¯¼è‡´äº§ç”Ÿå¹»è¯»
- RRçº§åˆ«ä¸‹ï¼š é’ˆå¯¹ç¬¬ä¸‰æ¡å¯èƒ½äº§ç”Ÿçš„å¹»è¯»é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å½“å‰è¯»(`select for update`)æ¥å¯¹è®°å½•åŠ `next-key Lock`(è®°å½•é”+é—´éš™é”)ï¼Œå³**å°½é‡åœ¨å¼€å¯äº‹åŠ¡ä¹‹åï¼Œé©¬ä¸Šæ‰§è¡Œ `select ... for update` è¿™ç±»å½“å‰è¯»çš„è¯­å¥ï¼Œå› ä¸ºå®ƒä¼šå¯¹è®°å½•åŠ  `next-key lock`ï¼Œä»è€Œé¿å…å…¶ä»–äº‹åŠ¡æ’å…¥ä¸€æ¡æ–°è®°å½•**















## é”



æ ¹æ®åŠ é”èŒƒå›´ï¼Œå¯ä»¥åˆ†æˆ**å…¨å±€é”ã€è¡¨çº§é”å’Œè¡Œé”**ä¸‰ç±»

### å…¨å±€é”

```sql
flush tables with read lock  #1
set global readonly=true #2
```

æ‰§è¡Œåï¼Œ**æ•´ä¸ªæ•°æ®åº“å°±å¤„äºåªè¯»çŠ¶æ€äº†**,ä»»ä½•å¯¹æ•°æ®çš„å¢åˆ æ”¹ã€å¯¹è¡¨ç»“æ„çš„æ“ä½œéƒ½ä¼šè¢«é˜»å¡

å…¨å±€é”çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œåšå…¨åº“é€»è¾‘å¤‡ä»½ï¼ˆ`mysqldump`â€”â€”ç”¨äºå¤‡ä»½æ•´ä¸ªæ•°æ®åº“çš„é€»è¾‘ç»“æ„å’Œæ•°æ®ã€‚å®ƒæ˜¯é€šè¿‡å¯¼å‡ºæ•°æ®åº“ä¸­çš„æ•°æ®å’Œå¯¹è±¡å®šä¹‰è¯­å¥æ¥åˆ›å»ºå¤‡ä»½ï¼Œå¤‡ä»½çš„æ˜¯sqlè¯­å¥ï¼‰ï¼Œå¤‡ä»½æœŸé—´ä¼šé€ æˆä¸šåŠ¡åœæ»

æ—¢ç„¶è¦å…¨åº“åªè¯»ï¼Œ**ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ `set global readonly=true` çš„æ–¹å¼å‘¢**ï¼Ÿç¡®å® `readonly` æ–¹å¼ä¹Ÿå¯ä»¥è®©å…¨åº“è¿›å…¥åªè¯»çŠ¶æ€ï¼Œä½†è¿˜æ˜¯å»ºè®®ç”¨ `FTWRL` æ–¹å¼ï¼Œä¸»è¦æœ‰å‡ ä¸ªåŸå› ï¼š 

ä¸€æ˜¯ï¼Œåœ¨æœ‰äº›ç³»ç»Ÿä¸­ï¼Œ`readonly` çš„å€¼ä¼šè¢«ç”¨æ¥åšå…¶ä»–é€»è¾‘ï¼Œæ¯”å¦‚ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªåº“æ˜¯ä¸»åº“è¿˜æ˜¯å¤‡åº“ã€‚å› æ­¤ï¼Œä¿®æ”¹ `global` å˜é‡çš„æ–¹å¼å½±å“é¢æ›´å¤§

äºŒæ˜¯ï¼Œåœ¨å¼‚å¸¸å¤„ç†æœºåˆ¶ä¸Šæœ‰å·®å¼‚ã€‚å¦‚æœæ‰§è¡Œ`FTWRL å‘½ä»¤ä¹‹åç”±äºå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸æ–­å¼€ï¼Œé‚£ä¹ˆ MySQL ä¼šè‡ªåŠ¨é‡Šæ”¾è¿™ä¸ªå…¨å±€é”`ï¼Œæ•´ä¸ªåº“å›åˆ°å¯ä»¥æ­£å¸¸æ›´æ–°çš„çŠ¶æ€ã€‚è€Œå°†æ•´ä¸ªåº“è®¾ç½®ä¸º `readonly` ä¹‹åï¼Œå¦‚æœå®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™æ•°æ®åº“å°±ä¼šä¸€ç›´ä¿æŒ `readonly` çŠ¶æ€ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ•´ä¸ªåº“é•¿æ—¶é—´å¤„äºä¸å¯å†™çŠ¶æ€ï¼Œé£é™©è¾ƒé«˜

ä¸‰æ˜¯ï¼Œ`readonly` å¯¹`super`ç”¨æˆ·æƒé™æ— æ•ˆ

ä¸šåŠ¡çš„æ›´æ–°ä¸åªæ˜¯å¢åˆ æ”¹æ•°æ®ï¼ˆDML)ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯åŠ å­—æ®µç­‰ä¿®æ”¹è¡¨ç»“æ„çš„æ“ä½œï¼ˆDDLï¼‰ï¼Œä¸è®ºæ˜¯å“ªç§æ–¹æ³•ï¼Œä¸€ä¸ªåº“è¢«å…¨å±€é”ä¸Šä»¥åï¼Œä½ è¦å¯¹é‡Œé¢ä»»ä½•ä¸€ä¸ªè¡¨åšåŠ å­—æ®µæ“ä½œï¼Œéƒ½æ˜¯ä¼šè¢«é”ä½çš„



### è¡¨çº§é”

MySQL é‡Œé¢è¡¨çº§åˆ«çš„é”æœ‰è¿™å‡ ç§ï¼š

- è¡¨é”ï¼›
- å…ƒæ•°æ®é”ï¼ˆMDLï¼‰ï¼›
- æ„å‘é”ï¼›
- AUTO-INC é”ï¼›



1ã€è¡¨é”

å¦‚æœæˆ‘ä»¬æƒ³å¯¹å­¦ç”Ÿè¡¨ï¼ˆt_studentï¼‰åŠ è¡¨é”ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š

```sql
//è¡¨çº§åˆ«çš„å…±äº«é”ï¼Œä¹Ÿå°±æ˜¯è¯»é”ï¼›
lock tables t_student read;   

//è¡¨çº§åˆ«çš„ç‹¬å é”ï¼Œä¹Ÿå°±æ˜¯å†™é”ï¼›
lock tables t_stuent write;

```

å¦‚æœæœ¬çº¿ç¨‹å¯¹å­¦ç”Ÿè¡¨åŠ äº†ã€Œå…±äº«è¡¨é”ã€ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹æ¥ä¸‹æ¥å¦‚æœè¦å¯¹å­¦ç”Ÿè¡¨æ‰§è¡Œå†™æ“ä½œçš„è¯­å¥ï¼Œæ˜¯ä¼šè¢«é˜»å¡çš„ï¼Œå½“ç„¶å…¶ä»–çº¿ç¨‹å¯¹å­¦ç”Ÿè¡¨è¿›è¡Œå†™æ“ä½œæ—¶ä¹Ÿä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾(**è¯»å†™äº’æ–¥**)



2ã€å…ƒæ•°æ®é”(`Meta Data Lock`)

å½“æˆ‘ä»¬å¯¹æ•°æ®åº“è¡¨è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šè‡ªåŠ¨é»˜è®¤åœ°ç»™è¿™ä¸ªè¡¨åŠ ä¸Š MDLï¼š

- å¯¹ä¸€å¼ è¡¨è¿›è¡Œ `CRUD` æ“ä½œæ—¶ï¼ŒåŠ çš„æ˜¯ **MDL è¯»é”**(è¯»é”ä¹‹é—´ä¸äº’æ–¥ï¼Œä¸ºäº†ä¿è¯å¤šä¸ªçº¿ç¨‹åŒæ—¶crudæ“ä½œä¸é˜»å¡)ï¼›
- å¯¹ä¸€å¼ è¡¨åšç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ çš„æ˜¯ **MDL å†™é”**ï¼›

MDL æ˜¯ä¸ºäº†ä¿è¯å½“ç”¨æˆ·å¯¹è¡¨æ‰§è¡Œ CRUD æ“ä½œæ—¶ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æ„åšäº†å˜æ›´

å½“æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œ `select` è¯­å¥ï¼ˆ åŠ  MDL è¯»é”ï¼‰çš„æœŸé—´ï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹è¦æ›´æ”¹è¯¥è¡¨çš„ç»“æ„ï¼ˆ ç”³è¯· MDL å†™é”ï¼‰ï¼Œé‚£ä¹ˆå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ‰§è¡Œå®Œ `select` è¯­å¥ï¼ˆ é‡Šæ”¾ MDL è¯»é”ï¼‰ã€‚

åä¹‹ï¼Œå½“æœ‰çº¿ç¨‹å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´ï¼ˆ åŠ  MDL å†™é”ï¼‰çš„æœŸé—´ï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº† `CRUD` æ“ä½œï¼ˆ ç”³è¯· MDL è¯»é”ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¡¨ç»“æ„å˜æ›´å®Œæˆï¼ˆ é‡Šæ”¾ MDL å†™é”ï¼‰ã€æˆ–å…¶ä»–çº¿ç¨‹æƒ³è¦ä¿®æ”¹è¡¨ç»“æ„æ—¶(ç”³è¯·MDLå†™é”)åŒæ ·ä¼šè¢«é˜»å¡

- MDL æ˜¯åœ¨äº‹åŠ¡æäº¤åæ‰ä¼šé‡Šæ”¾ï¼Œè¿™æ„å‘³ç€**äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒMDL æ˜¯ä¸€ç›´æŒæœ‰çš„**

- ç”³è¯· MDL é”çš„æ“ä½œä¼šå½¢æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­**å†™é”è·å–ä¼˜å…ˆçº§é«˜äºè¯»é”**ï¼Œä¸€æ—¦å‡ºç° MDL å†™é”ç­‰å¾…ï¼Œä¼šé˜»å¡åç»­è¯¥è¡¨çš„æ‰€æœ‰ CRUD æ“ä½œ







3ã€æ„å‘é”

- åœ¨ä½¿ç”¨ InnoDB å¼•æ“çš„è¡¨é‡Œå¯¹**æŸäº›è®°å½•**åŠ ä¸Šã€Œå…±äº«é”ã€ä¹‹å‰ï¼Œéœ€**è¦å…ˆåœ¨è¡¨çº§åˆ«åŠ **ä¸Šä¸€ä¸ªã€Œ**æ„å‘å…±äº«é”**ã€ï¼›
- åœ¨ä½¿ç”¨ InnoDB å¼•æ“çš„è¡¨é‡Œå¯¹æŸäº›çºªå½•åŠ ä¸Šã€Œç‹¬å é”ã€ä¹‹å‰ï¼Œéœ€**è¦å…ˆåœ¨è¡¨çº§åˆ«åŠ **ä¸Šä¸€ä¸ªã€Œ**æ„å‘ç‹¬å é”**ã€ï¼›

ä¹Ÿå°±æ˜¯ï¼Œå½“æ‰§è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œéœ€è¦å…ˆå¯¹è¡¨åŠ ä¸Šã€Œæ„å‘ç‹¬å é”ã€ï¼Œç„¶åå¯¹è¯¥è®°å½•åŠ ç‹¬å é”

(å³åŠ è¡Œé”å‰è¦å…ˆåŠ ä¸€ä¸ªæ„å‘è¡¨é”)

è€Œæ™®é€šçš„ `select` æ˜¯**ä¸ä¼šåŠ è¡Œçº§é”**çš„ï¼Œæ™®é€šçš„ `select` è¯­å¥æ˜¯åˆ©ç”¨ `MVCC` å®ç°ä¸€è‡´æ€§è¯»ï¼Œæ˜¯æ— é”çš„

ä¸è¿‡ï¼Œ`select` ä¹Ÿæ˜¯å¯ä»¥å¯¹è®°å½•åŠ å…±äº«é”å’Œç‹¬å é”çš„ï¼Œå…·ä½“æ–¹å¼å¦‚ä¸‹ï¼š

```sql
//å…ˆåœ¨è¡¨ä¸ŠåŠ ä¸Šæ„å‘å…±äº«é”ï¼Œç„¶åå¯¹è¯»å–çš„è®°å½•åŠ å…±äº«é”  è¿™é‡Œçš„å…±äº«é”æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
select ... lock in share mode;

//å…ˆè¡¨ä¸ŠåŠ ä¸Šæ„å‘ç‹¬å é”ï¼Œç„¶åå¯¹è¯»å–çš„è®°å½•åŠ ç‹¬å é”(Next key lock)
select ... for update;
```

æ„å‘å…±äº«é”å’Œæ„å‘ç‹¬å é”æ˜¯è¡¨çº§é”ï¼Œä¸ä¼šå’Œ**è¡Œçº§çš„å…±äº«é”å’Œç‹¬å é”å‘ç”Ÿå†²çª**ï¼Œè€Œä¸”**æ„å‘é”ä¹‹é—´ä¹Ÿä¸ä¼šå‘ç”Ÿå†²çª**ï¼Œåªä¼šå’Œå…±äº«è¡¨é”ï¼ˆ`lock tables ... read`ï¼‰å’Œç‹¬å è¡¨é”ï¼ˆ`lock tables ... write`ï¼‰å‘ç”Ÿå†²çªã€‚

**æ„å‘é”çš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿåˆ¤æ–­è¡¨é‡Œæ˜¯å¦æœ‰è®°å½•è¢«åŠ é”:**

æœ‰äº†ã€Œæ„å‘é”ã€ï¼Œç”±äºåœ¨å¯¹è®°å½•åŠ ç‹¬å é”å‰ï¼Œå…ˆä¼šåŠ ä¸Šè¡¨çº§åˆ«çš„æ„å‘ç‹¬å é”ï¼Œ**é‚£ä¹ˆåœ¨åŠ ã€Œç‹¬å è¡¨é”ã€æ—¶ï¼Œç›´æ¥æŸ¥è¯¥è¡¨æ˜¯å¦æœ‰æ„å‘ç‹¬å é”ï¼Œå¦‚æœæœ‰å°±æ„å‘³ç€è¡¨é‡Œå·²ç»æœ‰è®°å½•è¢«åŠ äº†ç‹¬å é”ï¼Œè¿™æ ·å°±ä¸ç”¨å»éå†è¡¨é‡Œçš„è®°å½•**







4ã€ Auto-INCé”

è¡¨é‡Œçš„ä¸»é”®é€šå¸¸éƒ½ä¼šè®¾ç½®æˆè‡ªå¢çš„ï¼Œè¿™æ˜¯é€šè¿‡å¯¹ä¸»é”®å­—æ®µå£°æ˜ `AUTO_INCREMENT` å±æ€§å®ç°çš„

**åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œä¼šåŠ ä¸€ä¸ªè¡¨çº§åˆ«çš„ AUTO-INC é”**ï¼Œç„¶åä¸ºè¢« `AUTO_INCREMENT` ä¿®é¥°çš„å­—æ®µèµ‹å€¼é€’å¢çš„å€¼ï¼Œç­‰æ’å…¥è¯­å¥æ‰§è¡Œå®Œæˆåï¼Œæ‰ä¼šæŠŠ AUTO-INC é”é‡Šæ”¾æ‰ã€‚é‚£ä¹ˆï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨æŒæœ‰ `AUTO-INC` é”çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡çš„å¦‚æœè¦å‘è¯¥è¡¨æ’å…¥è¯­å¥éƒ½ä¼šè¢«é˜»å¡ï¼Œä»è€Œä¿è¯æ’å…¥æ•°æ®æ—¶ï¼Œè¢« `AUTO_INCREMENT` ä¿®é¥°çš„å­—æ®µçš„å€¼æ˜¯è¿ç»­é€’å¢çš„

ä½†æ˜¯ï¼Œ AUTO-INC é”å†å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’å…¥çš„æ—¶å€™ï¼Œä¼šå½±å“æ’å…¥æ€§èƒ½ï¼Œå› ä¸ºå¦ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ’å…¥ä¼šè¢«é˜»å¡(å…¶ä»–äº‹åŠ¡è¦ç­‰å¾…æ‰€æœ‰æ•°æ®å…¨éƒ¨æ’å…¥å®Œæˆåæ‰èƒ½ç»§ç»­æ“ä½œï¼Œå› æ­¤åé¢å¼•å‡ºæ¥è½»é‡çº§é”ï¼Œæ’å…¥æ–°è®°å½•çš„äº‹åŠ¡åœ¨ç”³è¯·åˆ°ä¸»é”®åå°±å¯ä»¥é‡Šæ”¾è¯¥é”ï¼Œä¸ç”¨ç­‰åˆ°æ•´ä¸ªæ’å…¥è¯­å¥å®Œæˆ)



åœ¨ MySQL 5.1.22 ç‰ˆæœ¬å¼€å§‹ï¼ŒInnoDB å­˜å‚¨å¼•æ“æä¾›äº†ä¸€ç§**è½»é‡çº§çš„é”**æ¥å®ç°è‡ªå¢ï¼š

ä¸€æ ·ä¹Ÿæ˜¯åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šä¸ºè¢« `AUTO_INCREMENT` ä¿®é¥°çš„å­—æ®µåŠ ä¸Šè½»é‡çº§é”ï¼Œ**ç„¶åç»™è¯¥å­—æ®µèµ‹å€¼ä¸€ä¸ªè‡ªå¢çš„å€¼ï¼Œå°±æŠŠè¿™ä¸ªè½»é‡çº§é”é‡Šæ”¾äº†ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ’å…¥è¯­å¥æ‰§è¡Œå®Œåæ‰é‡Šæ”¾é”**

InnoDB å­˜å‚¨å¼•æ“æä¾›äº†ä¸ª `innodb_autoinc_lock_mode` çš„ç³»ç»Ÿå˜é‡ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶é€‰æ‹©ç”¨ AUTO-INC é”ï¼Œè¿˜æ˜¯è½»é‡çº§çš„é”

- å½“ `innodb_autoinc_lock_mode` = 0ï¼Œå°±é‡‡ç”¨ `AUTO-INC` é”ï¼Œè¯­å¥æ‰§è¡Œç»“æŸåæ‰é‡Šæ”¾é”ï¼›
- å½“ `innodb_autoinc_lock_mode` = 2ï¼Œ**å°±é‡‡ç”¨è½»é‡çº§é”ï¼Œç”³è¯·è‡ªå¢ä¸»é”®åå°±é‡Šæ”¾é”ï¼Œå¹¶ä¸éœ€è¦ç­‰è¯­å¥æ‰§è¡Œåæ‰é‡Šæ”¾ã€‚**
- å½“ `innodb_autoinc_lock_mode` = 1ï¼š
  - æ™®é€š insert è¯­å¥ï¼Œè‡ªå¢é”åœ¨ç”³è¯·åˆ°è‡ªå¢ä¸»é”®å€¼ä¹‹åå°±é©¬ä¸Šé‡Šæ”¾ï¼›
  - ç±»ä¼¼ insert â€¦ select è¿™æ ·çš„æ‰¹é‡æ’å…¥æ•°æ®çš„è¯­å¥ï¼Œè‡ªå¢é”è¿˜æ˜¯è¦ç­‰æ¯æ¡sqlè¯­å¥ç»“æŸåæ‰è¢«é‡Šæ”¾ï¼›





### è¡Œçº§é” :imp:

`Innodb`ä¸åŒéš”ç¦»çº§åˆ«ä¸‹ï¼Œè¡Œçº§é”çš„ç§ç±»æ˜¯ä¸åŒçš„:

åœ¨è¯»å·²æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¡Œçº§é”çš„ç§ç±»åªæœ‰è®°å½•é”ï¼Œä¹Ÿå°±æ˜¯ä»…ä»…æŠŠä¸€æ¡è®°å½•é”ä¸Šã€‚

åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¡Œçº§é”çš„ç§ç±»é™¤äº†æœ‰è®°å½•é”ï¼Œè¿˜æœ‰é—´éš™é”ï¼ˆç›®çš„æ˜¯ä¸ºäº†é¿å…å¹»è¯»ï¼‰

åœ¨å¯ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨è®°å½•é”å’Œé—´éš™é”ï¼Œç±»ä¼¼äºå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ã€‚ä½†æ˜¯ï¼Œ**ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¼šåœ¨è¯»å–èŒƒå›´å†…çš„æ‰€æœ‰è®°å½•å’Œé—´éš™ä¸Šè®¾ç½®å…±äº«é”(æ­¤å¤„æ˜¯è¡Œé”)**ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ã€ä¿®æ”¹æˆ–åˆ é™¤èŒƒå›´å†…çš„ä»»ä½•è®°å½•



#### Record Lock Xé”

å½“ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œäº†ä¸‹é¢è¿™æ¡è¯­å¥ï¼š

```sql
mysql > begin;
mysql > select * from t_test where id = 1 for update; #åŠ äº†æ’ä»–é”
mysql > select * from t_test where id = 1 lock in share mode ; #åŠ äº†å…±äº«é”
```

ç¬¬ 2 è¡Œå°±æ˜¯å¯¹ `t_test` è¡¨ä¸­ä¸»é”® id ä¸º 1 çš„è¿™æ¡è®°å½•åŠ ä¸Š X å‹çš„è®°å½•é”ï¼Œè¿™æ ·å…¶ä»–äº‹åŠ¡å°±æ— æ³•å¯¹è¿™æ¡è®°å½•è¿›è¡Œä¿®æ”¹äº†

`Record Lock` æ˜¯æœ‰ S é”å’Œ X é”ä¹‹åˆ†çš„ï¼š

- å½“ä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€æ¡è®°å½•åŠ äº† S å‹è®°å½•é”åï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿå¯ä»¥ç»§ç»­å¯¹è¯¥è®°å½•åŠ  S å‹è®°å½•é”ï¼ˆS å‹ä¸ S é”å…¼å®¹ï¼‰ï¼Œä½†æ˜¯ä¸å¯ä»¥å¯¹è¯¥è®°å½•åŠ  X å‹è®°å½•é”ï¼ˆS å‹ä¸ X é”ä¸å…¼å®¹ï¼‰;
- å½“ä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€æ¡è®°å½•åŠ äº† X å‹è®°å½•é”åï¼Œå…¶ä»–äº‹åŠ¡æ—¢ä¸å¯ä»¥å¯¹è¯¥è®°å½•åŠ  S å‹è®°å½•é”ï¼ˆS å‹ä¸ X é”ä¸å…¼å®¹ï¼‰ï¼Œä¹Ÿä¸å¯ä»¥å¯¹è¯¥è®°å½•åŠ  X å‹è®°å½•é”ï¼ˆX å‹ä¸ X é”ä¸å…¼å®¹ï¼‰







#### Gap Lock Sé”

`Gap Lock`é—´éš™é”åªå­˜åœ¨äº**å¯é‡å¤è¯»**éš”ç¦»çº§åˆ«ï¼Œç›®çš„æ˜¯ä¸ºäº†è§£å†³å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å¹»è¯»çš„ç°è±¡ï¼š

å‡è®¾è¡¨ä¸­æœ‰ä¸€ä¸ªèŒƒå›´ id ä¸ºï¼ˆ3ï¼Œ5ï¼‰é—´éš™é”ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡å°±æ— æ³•æ’å…¥ id = 4 è¿™æ¡è®°å½•äº†ï¼Œè¿™æ ·å°±æœ‰æ•ˆçš„é˜²æ­¢å¹»è¯»ç°è±¡çš„å‘ç”Ÿ

é—´éš™é”è™½ç„¶å­˜åœ¨ X å‹é—´éš™é”å’Œ S å‹é—´éš™é”ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œ**é—´éš™é”ä¹‹é—´æ˜¯å…¼å®¹çš„ï¼Œå³ä¸¤ä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰åŒ…å«å…±åŒé—´éš™èŒƒå›´çš„é—´éš™é”ï¼Œå¹¶ä¸å­˜åœ¨äº’æ–¥å…³ç³»ï¼Œå› ä¸ºé—´éš™é”çš„ç›®çš„æ˜¯é˜²æ­¢æ’å…¥å¹»å½±è®°å½•è€Œæå‡ºçš„**



ä¸**æ’å…¥æ„å‘é”**çš„åŒºåˆ«ï¼š

ä¸€ä¸ªäº‹åŠ¡åœ¨æ’å…¥ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œéœ€è¦åˆ¤æ–­æ’å…¥ä½ç½®æ˜¯å¦å·²è¢«å…¶ä»–äº‹åŠ¡åŠ äº†é—´éš™é”ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæ’å…¥æ“ä½œå°±ä¼šå‘ç”Ÿ**é˜»å¡**ï¼Œç›´åˆ°æ‹¥æœ‰é—´éš™é”çš„é‚£ä¸ªäº‹åŠ¡æäº¤ä¸ºæ­¢ï¼ˆé‡Šæ”¾é—´éš™é”çš„æ—¶åˆ»ï¼‰ï¼Œåœ¨æ­¤æœŸé—´ä¼šç”Ÿæˆä¸€ä¸ª**æ’å…¥æ„å‘é”**ï¼Œè¡¨æ˜æœ‰äº‹åŠ¡æƒ³åœ¨æŸä¸ªåŒºé—´æ’å…¥æ–°è®°å½•ï¼Œä½†æ˜¯**ç°åœ¨å¤„äºç­‰å¾…çŠ¶æ€**

æ’å…¥æ„å‘é”åå­—è™½ç„¶æœ‰æ„å‘é”ï¼Œä½†æ˜¯å®ƒå¹¶**ä¸æ˜¯æ„å‘é”(è¡¨é”)ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„é—´éš™é”ï¼Œå±äºè¡Œçº§åˆ«é”**









#### Next-Key Lock Xé”+Sé”

`Next-Key Lock` ç§°ä¸ºä¸´ç•Œé”ï¼Œæ˜¯ `Record Lock` + `Gap Lock` çš„ç»„åˆï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«

å‡è®¾ï¼Œè¡¨ä¸­æœ‰ä¸€ä¸ªèŒƒå›´ id ä¸ºï¼ˆ3ï¼Œ5] çš„ `next-key lock`ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡æ—¢ä¸èƒ½æ’å…¥ id = 4 è®°å½•ï¼Œä¹Ÿä¸èƒ½ä¿®æ”¹ id = 5 è¿™æ¡è®°å½•

**`next-key lock` æ˜¯åŒ…å«é—´éš™é”+è®°å½•é”çš„ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡è·å–äº† X å‹çš„ `next-key lock`ï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªäº‹åŠ¡åœ¨è·å–ç›¸åŒèŒƒå›´çš„ X å‹çš„ `next-key lock` æ—¶ï¼Œæ˜¯ä¼šè¢«é˜»å¡çš„**



è¡Œçº§é”åŠ é”çš„å¯¹è±¡æ˜¯**ç´¢å¼•**ï¼ŒåŠ é”çš„åŸºæœ¬å•ä½æ˜¯ `next-key lock`ï¼Œå®ƒæ˜¯ç”±è®°å½•é”å’Œé—´éš™é”ç»„åˆè€Œæˆçš„ï¼Œ**`next-key lock` æ˜¯å‰å¼€åé—­åŒºé—´ï¼Œè€Œé—´éš™é”æ˜¯å‰å¼€åå¼€åŒºé—´**,å› ä¸ºæŸ¥è¯¢è¯­å¥æ‰«æçš„ B+ æ ‘æ˜¯èšç°‡ç´¢å¼•æ ‘ï¼Œå³ä¸»é”®ç´¢å¼•æ ‘ï¼Œæ‰€ä»¥æ˜¯å¯¹ä¸»é”®ç´¢å¼•åŠ é”ã€‚å°†å¯¹åº”è®°å½•çš„ä¸»é”®ç´¢å¼•åŠ  è®°å½•é”åï¼Œå°±æ„å‘³ç€å…¶ä»–äº‹åŠ¡æ— æ³•å¯¹è¯¥è®°å½•è¿›è¡Œæ›´æ–°å’Œåˆ é™¤æ“ä½œäº†

**åœ¨èƒ½ä½¿ç”¨è®°å½•é”æˆ–è€…é—´éš™é”å°±èƒ½é¿å…å¹»è¯»ç°è±¡çš„åœºæ™¯ä¸‹ï¼Œ `next-key lock` å°±ä¼šé€€åŒ–æˆè®°å½•é”æˆ–é—´éš™é”**









`Next-key lock` å®é™…ä¸Šæ˜¯ä¸€ä¸ªèŒƒå›´é”ï¼Œç”¨äºä¿æŠ¤ç´¢å¼•é”®èŒƒå›´å†…çš„æ•°æ®ã€‚å®ƒåœ¨ InnoDB çš„ç´¢å¼•è®°å½•å’Œé—´éš™ä¹‹é—´åˆ›å»ºé”å®šèŒƒå›´ã€‚ä¸‹é¢æ˜¯ `Next-key lock` çš„è¡Œä¸ºï¼š

1. å¯¹äºå­˜åœ¨çš„ç´¢å¼•è®°å½•ï¼ˆè¡Œçº§é”ï¼‰ï¼š
   - å½“ä½¿ç”¨å…±äº«é”æ—¶ï¼Œè·å–å…±äº«é”ä»¥è¯»å–æ•°æ®ã€‚
   - å½“ä½¿ç”¨æ’ä»–é”æ—¶ï¼Œè·å–æ’ä»–é”ä»¥ä¿®æ”¹æ•°æ®ã€‚
2. å¯¹äºä¸å­˜åœ¨çš„ç´¢å¼•è®°å½•ï¼ˆé—´éš™é”ï¼‰ï¼š
   - å½“ä½¿ç”¨å…±äº«é”æ—¶ï¼Œè·å–é—´éš™å…±äº«é”ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥å…·æœ‰ç›¸åŒç´¢å¼•å€¼çš„æ–°è®°å½•ã€‚
   - å½“ä½¿ç”¨æ’ä»–é”æ—¶ï¼Œè·å–é—´éš™æ’ä»–é”ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥å…·æœ‰ç›¸åŒç´¢å¼•å€¼çš„æ–°è®°å½•ï¼Œä¹Ÿé˜»æ­¢å…¶ä»–äº‹åŠ¡ä¿®æ”¹å…·æœ‰ç›¸åŒç´¢å¼•å€¼çš„è®°å½•ã€‚

å› æ­¤ï¼Œ`Next-key lock` æ˜¯ä¸€ç§ç»„åˆäº†å…±äº«é”å’Œæ’ä»–é”çš„é”ç±»å‹









>  ä»€ä¹ˆæ—¶å€™åŠ `Next-Key Lock`å‘¢ï¼Ÿ

åœ¨InnoDBä¸­ï¼Œå½“æ‰§è¡Œä»¥ä¸‹ç±»å‹çš„SQLè¯­å¥æ—¶ï¼Œä¼šéšå¼åœ°åŠ ä¸Š**Next-Key Lock**ï¼š

1. `UPDATE`è¯­å¥ï¼šå½“ä½¿ç”¨`UPDATE`è¯­å¥æ›´æ–°è¡¨ä¸­çš„è¡Œæ—¶ï¼ŒInnoDBä¼šåœ¨æ›´æ–°æœŸé—´ä¸ºè¢«ä¿®æ”¹çš„è¡ŒåŠ ä¸Š`Next-Key Lock`ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¹¶å‘äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Œå¹¶é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¯»å–æˆ–ä¿®æ”¹è¢«æ›´æ–°çš„è¡Œæ—¶å‘ç”Ÿå†²çªã€‚
2. `DELETE`è¯­å¥ï¼šæ‰§è¡Œ`DELETE`è¯­å¥åˆ é™¤è¡Œæ—¶ï¼ŒInnoDBä¼šä¸ºè¦åˆ é™¤çš„è¡ŒåŠ ä¸Š`Next-Key Lock`ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨åˆ é™¤æ“ä½œè¿›è¡ŒæœŸé—´å¯¹è¿™äº›è¡Œè¿›è¡Œè¯»å–æˆ–ä¿®æ”¹ã€‚
3. `SELECT`è¯­å¥ï¼ˆä½¿ç”¨WHEREå­å¥ï¼‰ï¼šå½“ä½¿ç”¨`SELECT`è¯­å¥å¹¶å¸¦æœ‰WHEREå­å¥æ—¶ï¼ŒInnoDBä¼šä¸ºæ»¡è¶³WHEREæ¡ä»¶çš„è¡ŒåŠ ä¸Š`Next-Key Lock`ã€‚è¿™æ ·å¯ä»¥é¿å…å…¶ä»–äº‹åŠ¡åœ¨è¯»å–æˆ–ä¿®æ”¹è¿™äº›è¡Œæ—¶å¼•å‘å†²çª(**ä½†æ˜¯ä¼šæ¶‰åŠåˆ°é”çš„é€€åŒ–**)







#### é”é€€åŒ–åœºæ™¯åˆ†æ

è®°ä½ä¸€ä¸ªå‰æï¼šé”é€€åŒ–æ˜¯ä¸ºäº†å‡å°‘é”çš„ç²’åº¦ï¼Œä½†æ˜¯é€€åŒ–å¿…é¡»è¦ä¿è¯ä¸å‘ç”Ÿå¹»è¯»ï¼

<img src="https://segmentfault.com/img/remote/1460000040129112/view" alt="preview" style="zoom:50%;" />





**1ã€å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢**

å½“æˆ‘ä»¬ç”¨å”¯ä¸€ç´¢å¼•è¿›è¡Œç­‰å€¼æŸ¥è¯¢çš„æ—¶å€™ï¼ŒæŸ¥è¯¢çš„è®°å½•å­˜ä¸å­˜åœ¨ï¼ŒåŠ é”çš„è§„åˆ™ä¹Ÿä¼šä¸åŒï¼š

- å½“æŸ¥è¯¢çš„è®°å½•æ˜¯ã€Œå­˜åœ¨ã€çš„ï¼Œåœ¨ç´¢å¼•æ ‘ä¸Šå®šä½åˆ°è¿™ä¸€æ¡è®°å½•åï¼Œå°†è¯¥è®°å½•çš„ç´¢å¼•ä¸­çš„ `next-key lock` ä¼š**é€€åŒ–æˆã€Œè®°å½•é”ã€`Record Lock`**
- å½“æŸ¥è¯¢çš„è®°å½•æ˜¯ã€Œä¸å­˜åœ¨ã€çš„ï¼Œåœ¨ç´¢å¼•æ ‘æ‰¾åˆ°ç¬¬ä¸€æ¡å¤§äºè¯¥æŸ¥è¯¢è®°å½•çš„è®°å½•åï¼Œå°†è¯¥è®°å½•çš„ç´¢å¼•ä¸­çš„ `next-key lock` ä¼š**é€€åŒ–æˆã€Œé—´éš™é”ã€ `Gap Lock`**

å‡è®¾äº‹åŠ¡ A æ‰§è¡Œäº†è¿™æ¡ç­‰å€¼æŸ¥è¯¢è¯­å¥ï¼ŒæŸ¥è¯¢çš„è®°å½•**ã€Œå­˜åœ¨ã€**äºè¡¨ä¸­:

```sql
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from user where id = 1 for update;
+----+--------+-----+
| id | name   | age |
+----+--------+-----+
|  1 | è·¯é£   |  19 |
+----+--------+-----+
1 row in set (0.02 sec)
```

é‚£ä¹ˆï¼Œäº‹åŠ¡ A ä¼šä¸º id ä¸º 1 çš„è¿™æ¡è®°å½•å°±ä¼šåŠ ä¸Š **X å‹çš„è®°å½•é”**

å› ä¸ºåœ¨å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢å¹¶ä¸”æŸ¥è¯¢è®°å½•å­˜åœ¨çš„åœºæ™¯ä¸‹ï¼Œä»…é è®°å½•é”ä¹Ÿèƒ½é¿å…å¹»è¯»çš„é—®é¢˜

- ç”±äºä¸»é”®å…·æœ‰å”¯ä¸€æ€§ï¼Œæ‰€ä»¥**å…¶ä»–äº‹åŠ¡æ’å…¥ id = 1 çš„æ—¶å€™ï¼Œä¼šå› ä¸ºä¸»é”®å†²çªï¼Œå¯¼è‡´æ— æ³•æ’å…¥ id = 1 çš„æ–°è®°å½•**ã€‚è¿™æ ·äº‹åŠ¡ A åœ¨å¤šæ¬¡æŸ¥è¯¢ id = 1 çš„è®°å½•çš„æ—¶å€™ï¼Œä¸ä¼šå‡ºç°å‰åä¸¤æ¬¡æŸ¥è¯¢çš„ç»“æœé›†ä¸åŒï¼Œä¹Ÿå°±é¿å…äº†å¹»è¯»çš„é—®é¢˜ã€‚

- ç”±äºå¯¹ id = 1 åŠ äº†è®°å½•é”ï¼Œ**å…¶ä»–äº‹åŠ¡æ— æ³•åˆ é™¤è¯¥è®°å½•**ï¼Œè¿™æ ·äº‹åŠ¡ A åœ¨å¤šæ¬¡æŸ¥è¯¢ id = 1 çš„è®°å½•çš„æ—¶å€™ï¼Œä¸ä¼šå‡ºç°å‰åä¸¤æ¬¡æŸ¥è¯¢çš„ç»“æœé›†ä¸åŒï¼Œä¹Ÿå°±é¿å…äº†å¹»è¯»çš„é—®é¢˜









å‡è®¾äº‹åŠ¡ A æ‰§è¡Œäº†è¿™æ¡ç­‰å€¼æŸ¥è¯¢è¯­å¥ï¼ŒæŸ¥è¯¢çš„è®°å½•**ã€Œä¸å­˜åœ¨ã€**äºè¡¨ä¸­:

```sql
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from user where id = 2 for update;
Empty set (0.03 sec)
```

æ¥ä¸‹æ¥ï¼Œé€šè¿‡ `select * from performance_schema.data_locks\G;` è¿™æ¡è¯­å¥ï¼ŒæŸ¥çœ‹äº‹åŠ¡æ‰§è¡Œ SQL è¿‡ç¨‹ä¸­åŠ äº†ä»€ä¹ˆé”

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E4%BA%8B%E5%8A%A1a%E5%88%86%E6%9E%901.webp" style="zoom: 50%;" />

**æ­¤æ—¶äº‹åŠ¡ A åœ¨ id = 5 è®°å½•çš„ä¸»é”®ç´¢å¼•ä¸ŠåŠ çš„æ˜¯é—´éš™é”ï¼Œé”ä½çš„èŒƒå›´æ˜¯ (1, 5)**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E9%97%B4%E9%9A%99%E9%94%81.drawio.webp" style="zoom:67%;" />

æ¥ä¸‹æ¥ï¼Œå¦‚æœæœ‰å…¶ä»–äº‹åŠ¡æ’å…¥ id å€¼ä¸º 2ã€3ã€4 è¿™ä¸€äº›è®°å½•çš„è¯ï¼Œè¿™äº›æ’å…¥è¯­å¥éƒ½ä¼šå‘ç”Ÿé˜»å¡

æ³¨æ„ï¼Œå¦‚æœå…¶ä»–äº‹åŠ¡æ’å…¥çš„ id = 1 æˆ–è€… id = 5 çš„è®°å½•è¯ï¼Œå¹¶ä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œè€Œæ˜¯æŠ¥ä¸»é”®å†²çªçš„é”™è¯¯ï¼Œå› ä¸ºè¡¨ä¸­å·²ç»å­˜åœ¨ id = 1 å’Œ id = 5 çš„è®°å½•äº†

> é—´éš™é”çš„èŒƒå›´`(1, 5)` ï¼Œæ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Ÿ

æ ¹æ®æˆ‘çš„ç»éªŒï¼Œå¦‚æœ `LOCK_MODE` æ˜¯ next-key é”æˆ–è€…é—´éš™é”ï¼Œé‚£ä¹ˆ LOCK_DATA å°±è¡¨ç¤ºé”çš„èŒƒå›´ã€Œå³è¾¹ç•Œã€ï¼Œæ­¤æ¬¡çš„äº‹åŠ¡ A çš„ LOCK_DATA æ˜¯ 5

ç„¶åé”èŒƒå›´çš„**ã€Œå·¦è¾¹ç•Œã€æ˜¯è¡¨ä¸­ id ä¸º 5 çš„ä¸Šä¸€æ¡è®°å½•çš„ id å€¼**ï¼Œå³ 1

å› æ­¤ï¼Œé—´éš™é”çš„èŒƒå›´ä¸º`(1, 5)`

> ä¸ºä»€ä¹ˆå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢å¹¶ä¸”æŸ¥è¯¢è®°å½•ã€Œä¸å­˜åœ¨ã€çš„åœºæ™¯ä¸‹ï¼Œåœ¨ç´¢å¼•æ ‘æ‰¾åˆ°ç¬¬ä¸€æ¡å¤§äºè¯¥æŸ¥è¯¢è®°å½•çš„è®°å½•åï¼Œè¦å°†è¯¥è®°å½•çš„ç´¢å¼•ä¸­çš„ next-key lock ä¼šé€€åŒ–æˆã€Œé—´éš™é”ã€ï¼Ÿ

åŸå› å°±æ˜¯åœ¨å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢å¹¶ä¸”æŸ¥è¯¢è®°å½•ä¸å­˜åœ¨çš„åœºæ™¯ä¸‹ï¼Œ**ä»…é é—´éš™é”å°±èƒ½é¿å…å¹»è¯»çš„é—®é¢˜**ã€‚

- ä¸ºä»€ä¹ˆ id = 5 è®°å½•ä¸Šçš„ä¸»é”®ç´¢å¼•çš„é”ä¸å¯ä»¥æ˜¯ next-key lockï¼Ÿå¦‚æœæ˜¯ next-key lockï¼Œå°±æ„å‘³ç€å…¶ä»–äº‹åŠ¡æ— æ³•åˆ é™¤ id = 5 è¿™æ¡è®°å½•ï¼Œä½†æ˜¯è¿™æ¬¡çš„æ¡ˆä¾‹æ˜¯æŸ¥è¯¢ id = 2 çš„è®°å½•ï¼Œåªè¦ä¿è¯å‰åä¸¤æ¬¡æŸ¥è¯¢ id = 2 çš„ç»“æœé›†ç›¸åŒï¼Œå°±èƒ½é¿å…å¹»è¯»çš„é—®é¢˜äº†ï¼Œæ‰€ä»¥å³ä½¿ id =5 è¢«åˆ é™¤ï¼Œä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œé‚£å°±æ²¡å¿…é¡»åŠ  next-key lockï¼Œå› æ­¤**åªéœ€è¦åœ¨ id = 5 åŠ é—´éš™é”ï¼Œé¿å…å…¶ä»–äº‹åŠ¡æ’å…¥ id = 2 çš„æ–°è®°å½•**å°±è¡Œäº†ã€‚
- ä¸ºä»€ä¹ˆä¸å¯ä»¥é’ˆå¯¹ä¸å­˜åœ¨çš„è®°å½•åŠ è®°å½•é”ï¼Ÿ**é”æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šçš„**ï¼Œè€Œè¿™ä¸ªåœºæ™¯ä¸‹æŸ¥è¯¢çš„è®°å½•æ˜¯ä¸å­˜åœ¨çš„ï¼Œè‡ªç„¶å°±æ²¡åŠæ³•é”ä½è¿™æ¡ä¸å­˜åœ¨çš„è®°å½•





2ã€å”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢ (æœªå®Œå¾…ç»­ã€‚ã€‚ã€‚ã€‚)





3ã€éå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢

å½“æˆ‘ä»¬ç”¨éå”¯ä¸€ç´¢å¼•è¿›è¡Œç­‰å€¼æŸ¥è¯¢çš„æ—¶å€™ï¼Œ**å› ä¸ºå­˜åœ¨ä¸¤ä¸ªç´¢å¼•ï¼Œä¸€ä¸ªæ˜¯ä¸»é”®ç´¢å¼•ï¼Œä¸€ä¸ªæ˜¯éå”¯ä¸€ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰ï¼Œæ‰€ä»¥åœ¨åŠ é”æ—¶ï¼ŒåŒæ—¶ä¼šå¯¹è¿™ä¸¤ä¸ªç´¢å¼•éƒ½åŠ é”ï¼Œä½†æ˜¯å¯¹ä¸»é”®ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œåªæœ‰æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è®°å½•æ‰ä¼šå¯¹å®ƒä»¬çš„ä¸»é”®ç´¢å¼•åŠ é”**





é’ˆå¯¹éå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢çš„è®°å½•å­˜ä¸å­˜åœ¨ï¼ŒåŠ é”çš„è§„åˆ™ä¹Ÿä¼šä¸åŒï¼š

- å½“æŸ¥è¯¢çš„è®°å½•ã€Œå­˜åœ¨ã€æ—¶ï¼Œç”±äºä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œæ‰€ä»¥è‚¯å®šå­˜åœ¨ç´¢å¼•å€¼ç›¸åŒçš„è®°å½•ï¼Œäºæ˜¯**éå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ‰«æçš„è¿‡ç¨‹ï¼Œç›´åˆ°æ‰«æåˆ°ç¬¬ä¸€ä¸ªä¸ç¬¦åˆæ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•å°±åœæ­¢æ‰«æï¼Œç„¶ååœ¨æ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ‰«æåˆ°çš„äºŒçº§ç´¢å¼•è®°å½•åŠ çš„æ˜¯ next-key é”ï¼Œè€Œå¯¹äºç¬¬ä¸€ä¸ªä¸ç¬¦åˆæ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œè¯¥äºŒçº§ç´¢å¼•çš„ next-key é”ä¼šé€€åŒ–æˆé—´éš™é”ã€‚åŒæ—¶ï¼Œåœ¨ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„è®°å½•çš„ä¸»é”®ç´¢å¼•ä¸ŠåŠ è®°å½•é”**ã€‚
- å½“æŸ¥è¯¢çš„è®°å½•ã€Œä¸å­˜åœ¨ã€æ—¶ï¼Œ**æ‰«æåˆ°ç¬¬ä¸€æ¡ä¸ç¬¦åˆæ¡ä»¶çš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œè¯¥äºŒçº§ç´¢å¼•çš„ next-key é”ä¼šé€€åŒ–æˆé—´éš™é”ã€‚å› ä¸ºä¸å­˜åœ¨æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è®°å½•ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹ä¸»é”®ç´¢å¼•åŠ é”**ã€‚





æˆ–è€…ç›´æ¥çœ‹è¿™ç¯‡æ–‡ç« å§ï¼Œåº”è¯¥è¶³å¤Ÿåº”ä»˜é¢è¯•äº†ï¼š

https://segmentfault.com/a/1190000040129107



### æ­»é”é—®é¢˜

#### Mysqlä¸‹å¦‚ä½•äº§ç”Ÿæ­»é”çš„ï¼Ÿ

**Innodb å¼•æ“ä¸ºäº†è§£å†³ã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«ä¸‹çš„å¹»è¯»é—®é¢˜ï¼Œå°±å¼•å‡ºäº† next-key é”**ï¼Œå®ƒæ˜¯è®°å½•é”å’Œé—´éš™é”çš„ç»„åˆ

æ™®é€šçš„ select è¯­å¥æ˜¯ä¸ä¼šå¯¹è®°å½•åŠ é”çš„ï¼Œå› ä¸ºå®ƒæ˜¯é€šè¿‡ MVCC çš„æœºåˆ¶å®ç°çš„å¿«ç…§è¯»ï¼Œå¦‚æœè¦åœ¨æŸ¥è¯¢æ—¶å¯¹è®°å½•åŠ è¡Œé”ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹å¼ï¼š

```sql
begin;
//å¯¹è¯»å–çš„è®°å½•åŠ å…±äº«é”
select ... lock in share mode;
commit; //é”é‡Šæ”¾

begin;
//å¯¹è¯»å–çš„è®°å½•åŠ æ’ä»–é”
select ... for update;
commit; //é”é‡Šæ”¾
```

è¡Œé”çš„é‡Šæ”¾æ—¶æœºæ˜¯åœ¨äº‹åŠ¡æäº¤ï¼ˆcommitï¼‰åï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶ä¸æ˜¯ä¸€æ¡è¯­å¥æ‰§è¡Œå®Œå°±é‡Šæ”¾è¡Œé”







å†æ¥çœ‹ä¸€ä¸ªæ­»é”çš„ç¤ºä¾‹ï¼š

1ã€é¦–å…ˆå»ºäº†ä¸€å¼ è®¢å•è¡¨ï¼Œå…¶ä¸­ id å­—æ®µä¸ºä¸»é”®ç´¢å¼•ï¼Œorder_no å­—æ®µæ™®é€šç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯éå”¯ä¸€ç´¢å¼•ï¼š

```sql
CREATE TABLE `t_order` (
  `id` int NOT NULL AUTO_INCREMENT,
  `order_no` int DEFAULT NULL,
  `create_date` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_order` (`order_no`) USING BTREE
) ENGINE=InnoDB ;
```

ç„¶åæ–°å¢å‡ æ¡è®°å½•ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/54fc00f9f87a60ab7b5ba92d824a892d.webp" style="zoom:50%;" />

2ã€äº‹åŠ¡Aã€Bå…ˆåæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%AD%BB%E9%94%81%E5%AE%9E%E4%BE%8B.webp)

äº‹åŠ¡ A åœ¨æ‰§è¡Œä¸‹é¢è¿™æ¡è¯­å¥çš„æ—¶å€™ï¼š

```sql
select id from t_order where order_no = 1007 for update;
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `select * from performance_schema.data_locks\G;` è¿™æ¡è¯­å¥ï¼ŒæŸ¥çœ‹äº‹åŠ¡æ‰§è¡Œ SQL è¿‡ç¨‹ä¸­åŠ äº†ä»€ä¹ˆé”

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%AD%BB%E9%94%811.webp" style="zoom:67%;" />

ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œå…±åŠ äº†ä¸¤ä¸ªé”ï¼Œåˆ†åˆ«æ˜¯ï¼š

- è¡¨é”ï¼šX ç±»å‹çš„æ„å‘é”ï¼›
- è¡Œé”ï¼šX ç±»å‹çš„é—´éš™é”ï¼›

è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨è¡Œé”ï¼Œå›¾ä¸­ LOCK_TYPE ä¸­çš„ RECORD è¡¨ç¤ºè¡Œçº§é”ï¼Œè€Œä¸æ˜¯è®°å½•é”çš„æ„æ€ï¼Œé€šè¿‡ LOCK_MODE å¯ä»¥ç¡®è®¤æ˜¯ next-key é”ï¼Œè¿˜æ˜¯é—´éš™é”ï¼Œè¿˜æ˜¯è®°å½•é”ï¼š

- å¦‚æœ LOCK_MODE ä¸º `X`ï¼Œè¯´æ˜æ˜¯ X å‹çš„ next-key é”ï¼›
- å¦‚æœ LOCK_MODE ä¸º `X, REC_NOT_GAP`ï¼Œè¯´æ˜æ˜¯ X å‹çš„è®°å½•é”ï¼›
- å¦‚æœ LOCK_MODE ä¸º `X, GAP`ï¼Œè¯´æ˜æ˜¯ X å‹çš„é—´éš™é”ï¼›



**å› æ­¤ï¼Œæ­¤æ—¶äº‹åŠ¡ A åœ¨äºŒçº§ç´¢å¼•ï¼ˆINDEX_NAME : index_orderï¼‰ä¸ŠåŠ çš„æ˜¯ X å‹çš„ next-key é”ï¼Œé”èŒƒå›´æ˜¯`(1006, +âˆ]`**

æ ¹æ®ç»éªŒï¼Œå¦‚æœ LOCK_MODE æ˜¯ next-key é”æˆ–è€…é—´éš™é”ï¼Œé‚£ä¹ˆ LOCK_DATA å°±è¡¨ç¤ºé”çš„èŒƒå›´æœ€å³å€¼ï¼Œæ­¤æ¬¡çš„äº‹åŠ¡ A çš„ LOCK_DATA æ˜¯ supremum pseudo-recordï¼Œè¡¨ç¤ºçš„æ˜¯ +âˆã€‚ç„¶åé”èŒƒå›´çš„æœ€å·¦å€¼æ˜¯ t_order è¡¨ä¸­æœ€åä¸€ä¸ªè®°å½•çš„ index_order çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 1006ã€‚å› æ­¤ï¼Œnext-key é”çš„èŒƒå›´ (1006, +âˆ]

+

å› æ­¤å½“äº‹åŠ¡ B å¾€äº‹åŠ¡ Açš„`next-key` é”çš„èŒƒå›´ (1006, +âˆ] é‡Œæ’å…¥ id = 1008 çš„è®°å½•å°±ä¼šè¢«é”ä½ï¼š

```sql
Insert into t_order (order_no, create_date) values (1008, now());
```

å› ä¸ºå½“æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹æ’å…¥è¯­å¥æ—¶ï¼Œä¼šåœ¨æ’å…¥é—´éš™ä¸Šè·å–æ’å…¥æ„å‘é”ï¼Œè€Œæ’å…¥æ„å‘é”ä¸é—´éš™é”æ˜¯å†²çªçš„ï¼Œæ‰€ä»¥å½“å…¶å®ƒäº‹åŠ¡æŒæœ‰è¯¥é—´éš™çš„é—´éš™é”æ—¶ï¼Œéœ€è¦ç­‰å¾…å…¶å®ƒäº‹åŠ¡é‡Šæ”¾é—´éš™é”ä¹‹åï¼Œæ‰èƒ½è·å–åˆ°æ’å…¥æ„å‘é”ã€‚è€Œé—´éš™é”ä¸é—´éš™é”ä¹‹é—´æ˜¯å…¼å®¹çš„ï¼Œæ‰€ä»¥æ‰€ä»¥ä¸¤ä¸ªäº‹åŠ¡ä¸­ `select ... for update` è¯­å¥å¹¶ä¸ä¼šç›¸äº’å½±å“



æ¡ˆä¾‹ä¸­çš„äº‹åŠ¡ A å’Œäº‹åŠ¡ B åœ¨æ‰§è¡Œå®Œå `select ... for update` è¯­å¥åéƒ½æŒæœ‰èŒƒå›´ä¸º`(1006,+âˆ]`çš„`next-key` é”ï¼Œè€Œæ¥ä¸‹æ¥çš„æ’å…¥æ“ä½œä¸ºäº†è·å–åˆ°æ’å…¥æ„å‘é”ï¼Œéƒ½åœ¨ç­‰å¾…å¯¹æ–¹äº‹åŠ¡çš„é—´éš™é”é‡Šæ”¾ï¼Œäºæ˜¯å°±é€ æˆäº†å¾ªç¯ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”



#### å¦‚ä½•é¿å…æ­»é”ï¼Ÿ

åœ¨æ•°æ®åº“å±‚é¢ï¼Œæœ‰ä¸¤ç§ç­–ç•¥é€šè¿‡ã€Œæ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶ã€æ¥è§£é™¤æ­»é”çŠ¶æ€ï¼š

- **è®¾ç½®äº‹åŠ¡ç­‰å¾…é”çš„è¶…æ—¶æ—¶é—´**ï¼š**å½“ä¸€ä¸ªäº‹åŠ¡çš„ç­‰å¾…æ—¶é—´è¶…è¿‡è¯¥å€¼åï¼Œå°±å¯¹è¿™ä¸ªäº‹åŠ¡è¿›è¡Œ`rollback`å›æ»šï¼Œäºæ˜¯é”å°±é‡Šæ”¾äº†**ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ã€‚åœ¨ `InnoDB` ä¸­ï¼Œå‚æ•° `innodb_lock_wait_timeout` æ˜¯ç”¨æ¥è®¾ç½®è¶…æ—¶æ—¶é—´çš„ï¼Œé»˜è®¤å€¼æ—¶ 50 ç§’
- **å¼€å¯ä¸»åŠ¨æ­»é”æ£€æµ‹**ã€‚ä¸»åŠ¨æ­»é”æ£€æµ‹åœ¨å‘ç°æ­»é”åï¼Œä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚å°†å‚æ•° `innodb_deadlock_detect` è®¾ç½®ä¸º onï¼Œè¡¨ç¤ºå¼€å¯è¿™ä¸ªé€»è¾‘ï¼Œé»˜è®¤å°±å¼€å¯











### ä¸€æ¡sqlè¯­å¥æ‰§è¡Œæ—¶çš„åŠ é”æƒ…å†µ









## æ—¥å¿—

é¦–å…ˆè¦çŸ¥é“ï¼š

- **undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰**ï¼šæ˜¯ `Innodb` å­˜å‚¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œå®ç°äº†äº‹åŠ¡ä¸­çš„**åŸå­æ€§**ï¼Œä¸»è¦**ç”¨äºäº‹åŠ¡å›æ»šå’Œ MVCC**ï¼›
- **redo logï¼ˆé‡åšæ—¥å¿—ï¼‰**ï¼šæ˜¯ `Innodb` å­˜å‚¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œå®ç°äº†äº‹åŠ¡ä¸­çš„**æŒä¹…æ€§**ï¼Œä¸»è¦**ç”¨äºæ‰ç”µç­‰æ•…éšœæ¢å¤**ï¼Œå±äºç‰©ç†æ—¥å¿—ï¼›
- **bin logï¼ˆå½’æ¡£æ—¥å¿—ï¼‰**ï¼šæ˜¯ `Server` å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œä¸»è¦**ç”¨äºæ•°æ®å¤‡ä»½å’Œä¸»ä»å¤åˆ¶**



ç„¶åæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨å››ä¸ªé—®é¢˜ï¼š

1. æ¯ä¸ªæ—¥å¿—ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼Ÿ

2. å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿ

3. ä»¥ä½•ç§æ ¼å¼å­˜æ”¾ï¼Ÿ
4. ä»€ä¹ˆæ—¶å€™åˆ·ç›˜ï¼Ÿ



### undo log

æˆ‘ä»¬åœ¨æ‰§è¡Œæ‰§è¡Œä¸€æ¡â€œå¢åˆ æ”¹â€è¯­å¥çš„æ—¶å€™ï¼Œè™½ç„¶æ²¡æœ‰è¾“å…¥ `begin` å¼€å¯äº‹åŠ¡å’Œ `commit` æäº¤äº‹åŠ¡ï¼Œä½†æ˜¯ MySQL ä¼š**éšå¼å¼€å¯äº‹åŠ¡**æ¥æ‰§è¡Œâ€œå¢åˆ æ”¹â€è¯­å¥çš„(`autocommit`å‚æ•°)ï¼Œæ‰§è¡Œå®Œå°±è‡ªåŠ¨æäº¤äº‹åŠ¡

å¦‚æœæˆ‘ä»¬æ¯æ¬¡åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéƒ½è®°å½•ä¸‹å›æ»šæ—¶éœ€è¦çš„ä¿¡æ¯åˆ°ä¸€ä¸ªæ—¥å¿—é‡Œï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¸­é€”å‘ç”Ÿäº† MySQL å´©æºƒåï¼Œå°±ä¸ç”¨æ‹…å¿ƒæ— æ³•å›æ»šåˆ°äº‹åŠ¡ä¹‹å‰çš„æ•°æ®ï¼Œå®ç°è¿™ä¸€æœºåˆ¶å°±æ˜¯ **undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ï¼Œå®ƒä¿è¯äº†äº‹åŠ¡çš„ [ACID ç‰¹æ€§ (opens new window)](https://xiaolincoding.com/mysql/transaction/mvcc.html#äº‹åŠ¡æœ‰å“ªäº›ç‰¹æ€§)ä¸­çš„åŸå­æ€§ï¼ˆAtomicityï¼‰**

åœ¨äº‹åŠ¡æ²¡æäº¤ä¹‹å‰ï¼Œ`MySQL` ä¼šå…ˆè®°å½•æ›´æ–°å‰çš„æ•°æ®åˆ° `undo log` æ—¥å¿—æ–‡ä»¶é‡Œé¢ï¼š

æ¯å½“ `InnoDB` å¼•æ“å¯¹ä¸€æ¡è®°å½•è¿›è¡Œæ“ä½œï¼ˆä¿®æ”¹ã€åˆ é™¤ã€æ–°å¢ï¼‰æ—¶ï¼Œè¦æŠŠå›æ»šæ—¶éœ€è¦çš„ä¿¡æ¯éƒ½è®°å½•åˆ° `undo log` é‡Œï¼Œæ¯”å¦‚ï¼š

- åœ¨**æ’å…¥**ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•çš„ä¸»é”®å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶åªéœ€è¦æŠŠè¿™ä¸ªä¸»é”®å€¼å¯¹åº”çš„è®°å½•**åˆ æ‰**å°±å¥½äº†ï¼›
- åœ¨**åˆ é™¤**ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¿™æ¡è®°å½•ä¸­çš„å†…å®¹éƒ½è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠç”±è¿™äº›å†…å®¹ç»„æˆçš„è®°å½•**æ’å…¥**åˆ°è¡¨ä¸­å°±å¥½äº†ï¼›
- åœ¨**æ›´æ–°**ä¸€æ¡è®°å½•æ—¶ï¼Œè¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œè¿™æ ·ä¹‹åå›æ»šæ—¶å†æŠŠè¿™äº›åˆ—**æ›´æ–°ä¸ºæ—§å€¼**å°±è¡Œäº†

ä¸€æ¡è®°å½•çš„æ¯ä¸€æ¬¡æ›´æ–°æ“ä½œäº§ç”Ÿçš„ `undo log` æ ¼å¼éƒ½æœ‰ä¸€ä¸ª `roll_pointer` æŒ‡é’ˆå’Œä¸€ä¸ª `trx_id` äº‹åŠ¡idï¼š

- é€šè¿‡ `trx_id` å¯ä»¥çŸ¥é“è¯¥è®°å½•æœ€æ–°æ˜¯è¢«å“ªä¸ªäº‹åŠ¡ä¿®æ”¹çš„ï¼›
- é€šè¿‡ `roll_pointer` æŒ‡é’ˆå¯ä»¥å°†è¿™äº› `undo log` ä¸²æˆä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨å°±è¢«ç§°ä¸ºç‰ˆæœ¬é“¾ï¼›

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%89%88%E6%9C%AC%E9%93%BE.webp)

> Undo Logæ˜¯ç”¨äºå®ç°äº‹åŠ¡çš„å›æ»šæ“ä½œå’ŒMVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰çš„ä¸€ç§æ—¥å¿—æœºåˆ¶ã€‚å®ƒè®°å½•äº†äº‹åŠ¡å¯¹æ•°æ®è¡Œæ‰€åšçš„ä¿®æ”¹æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ—§å€¼ã€ä¿®æ”¹ç±»å‹ç­‰ã€‚Undo Logä½¿ç”¨å›æ»šæ®µï¼ˆRollback Segmentï¼‰çš„ç»“æ„æ¥å­˜å‚¨æ’¤é”€æ—¥å¿—çš„ä¿¡æ¯ã€‚
>
> `Roll Pointer`æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ**æŒ‡å‘å½“å‰äº‹åŠ¡çš„å›æ»šæ®µçš„èµ·å§‹ä½ç½®**ï¼Œå®ƒæ˜¯ä¸ºäº†ç®¡ç†å’Œè·Ÿè¸ªUndo Logçš„è¯»å–å’Œå›æ»šæ“ä½œè€Œå¼•å…¥çš„ã€‚æ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ—¶éƒ½ä¼šè·å¾—ä¸€ä¸ªå”¯ä¸€çš„`Roll Pointer`ï¼Œç”¨äºæ ‡è¯†è¯¥äº‹åŠ¡åœ¨Undo Logä¸­çš„ä½ç½®ã€‚
>
> Undo Logå’ŒRoll Pointerä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š
>
> - å½“äº‹åŠ¡å¯¹æ•°æ®è¡Œè¿›è¡Œä¿®æ”¹æ—¶ï¼ŒUndo Logä¼šè®°å½•è¯¥ä¿®æ”¹çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶å°†ç›¸åº”çš„Undo Logæ¡ç›®æ’å…¥åˆ°å›æ»šæ®µä¸­ã€‚
> - Roll Pointerä¼šæŒ‡å‘å›æ»šæ®µä¸­å½“å‰äº‹åŠ¡çš„èµ·å§‹ä½ç½®ï¼Œç”¨äº**æŒ‡ç¤ºå½“å‰è®°å½•çš„æœ€æ–°ç‰ˆæœ¬åœ¨Undo Logä¸­çš„ä½ç½®ã€‚**
> - åœ¨äº‹åŠ¡è¿›è¡Œå›æ»šæ“ä½œæ—¶ï¼ŒRoll Pointerä¼šæ ¹æ®éœ€è¦å‘å‰ç§»åŠ¨ï¼Œä»¥é€‰æ‹©åˆé€‚çš„Undo Logæ¡ç›®è¿›è¡Œå›æ»šæ“ä½œã€‚å›æ»šæ“ä½œä¼šæ ¹æ®Roll PointeræŒ‡ç¤ºçš„ä½ç½®é€†å‘æ‰§è¡ŒUndo Logä¸­è®°å½•çš„ä¿®æ”¹æ“ä½œï¼Œå°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ã€‚
> - å½“äº‹åŠ¡æäº¤åï¼ŒRoll Pointerå°†è¢«æ›´æ–°ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨çš„ä½ç½®ï¼Œç”¨äºä¸‹ä¸€ä¸ªäº‹åŠ¡çš„Undo Logè®°å½•ã€‚



ä¸‹å›¾ä¸º`UPDATE`æ“ä½œå¯¹åº”çš„undoæ—¥å¿—ç»“æ„ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/trx_undo_upd_exist_rec_format.jpg)



æ€»ç»“ undo log çš„ä¸¤å¤§ä½œç”¨ï¼š

- **å®ç°äº‹åŠ¡å›æ»šï¼Œä¿éšœäº‹åŠ¡çš„åŸå­æ€§**ï¼šäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯æˆ–è€…ç”¨æˆ·æ‰§è¡Œäº† ROLLBACK è¯­å¥ï¼ŒMySQL å¯ä»¥åˆ©ç”¨ undo log ä¸­çš„å†å²æ•°æ®å°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€
- **å®ç° MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰å…³é”®å› ç´ ä¹‹ä¸€**ï¼šMVCC æ˜¯é€šè¿‡ ReadView + undo log å®ç°çš„ã€‚undo log ä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä»½å†å²æ•°æ®ï¼ŒMySQL åœ¨æ‰§è¡Œå¿«ç…§è¯»ï¼ˆæ™®é€š select è¯­å¥ï¼‰çš„æ—¶å€™ï¼Œä¼šæ ¹æ®äº‹åŠ¡çš„ Read View é‡Œçš„ä¿¡æ¯ï¼Œé¡ºç€ undo log çš„ç‰ˆæœ¬é“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•



> undo log æ˜¯å¦‚ä½•åˆ·ç›˜ï¼ˆæŒä¹…åŒ–åˆ°ç£ç›˜ï¼‰çš„ï¼Ÿ
>



å¼€å¯äº‹åŠ¡åï¼ŒInnoDB å±‚æ›´æ–°è®°å½•å‰ï¼Œé¦–å…ˆè¦è®°å½•ç›¸åº”çš„ `undo log`ï¼Œå¦‚æœæ˜¯æ›´æ–°æ“ä½œï¼Œéœ€è¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¦ç”Ÿæˆä¸€æ¡ `undo log`ï¼Œundo log ä¼šå†™å…¥ Buffer Pool ä¸­çš„ Undo é¡µ

**å¯¹ Undo é¡µçš„ä¿®æ”¹ä¹Ÿéƒ½ä¼šè®°å½•åˆ° redo logã€‚redo log ä¼šæ¯ç§’åˆ·ç›˜ï¼Œæäº¤äº‹åŠ¡æ—¶ä¹Ÿä¼šåˆ·ç›˜ï¼Œæ•°æ®é¡µå’Œ undo é¡µéƒ½æ˜¯é è¿™ä¸ªæœºåˆ¶ä¿è¯æŒä¹…åŒ–çš„**











### redo log



`redo log` æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•äº†æŸä¸ªæ•°æ®é¡µåšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œæ¯”å¦‚**å¯¹ XXX è¡¨ç©ºé—´ä¸­çš„ YYY æ•°æ®é¡µ ZZZ åç§»é‡çš„åœ°æ–¹åšäº†AAA æ›´æ–°**ï¼Œæ¯å½“æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡å°±ä¼šäº§ç”Ÿè¿™æ ·çš„ä¸€æ¡æˆ–è€…å¤šæ¡ç‰©ç†æ—¥å¿—



> é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦`redo log`?  ä»ä¸¤ç‚¹æ¥ç­”



(1) äº‹åŠ¡çš„å››å¤§ç‰¹æ€§é‡Œé¢æœ‰ä¸€ä¸ªæ˜¯ **æŒä¹…æ€§** ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯**åªè¦äº‹åŠ¡æäº¤æˆåŠŸï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“åšçš„ä¿®æ”¹å°±è¢«æ°¸ä¹…ä¿å­˜ä¸‹æ¥äº†ï¼Œä¸å¯èƒ½å› ä¸ºä»»ä½•åŸå› å†å›åˆ°åŸæ¥çš„çŠ¶æ€** ã€‚é‚£ä¹ˆ `mysql`æ˜¯å¦‚ä½•ä¿è¯æŒä¹…æ€§çš„å‘¢ï¼Ÿæœ€ç®€å•çš„åšæ³•æ˜¯åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå°†è¯¥äº‹åŠ¡æ¶‰åŠä¿®æ”¹çš„æ•°æ®é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯è¿™ä¹ˆåšä¼šæœ‰ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š

1. å› ä¸º `Innodb `æ˜¯ä»¥ `é¡µ `ä¸ºå•ä½è¿›è¡Œç£ç›˜äº¤äº’çš„ï¼Œè€Œä¸€ä¸ªäº‹åŠ¡å¾ˆå¯èƒ½åªä¿®æ”¹ä¸€ä¸ªæ•°æ®é¡µé‡Œé¢çš„å‡ ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å°†å®Œæ•´çš„æ•°æ®é¡µåˆ·åˆ°ç£ç›˜çš„è¯ï¼Œå¤ªæµªè´¹èµ„æºäº†ï¼
2. ä¸€ä¸ªäº‹åŠ¡å¯èƒ½æ¶‰åŠä¿®æ”¹å¤šä¸ªæ•°æ®é¡µï¼Œå¹¶ä¸”è¿™äº›æ•°æ®é¡µåœ¨ç‰©ç†ä¸Šå¹¶ä¸è¿ç»­ï¼Œä½¿ç”¨éšæœºI/Oå†™å…¥æ€§èƒ½å¤ªå·®ï¼

å› æ­¤ `mysql `è®¾è®¡äº† `redo log `ï¼Œ **å…·ä½“æ¥è¯´å°±æ˜¯åªè®°å½•äº‹åŠ¡å¯¹æ•°æ®é¡µåšäº†å“ªäº›ä¿®æ”¹**ï¼Œè¿™æ ·å°±èƒ½å®Œç¾åœ°è§£å†³æ€§èƒ½é—®é¢˜äº†(ç›¸å¯¹è€Œè¨€æ–‡ä»¶æ›´å°å¹¶ä¸”æ˜¯é¡ºåºIO)ï¼ŒåŒæ—¶è®©æ•°æ®åº“æœ‰äº†`crash-safe`çš„èƒ½åŠ›



(2) å°†å†™æ“ä½œä»ã€Œéšæœºå†™ã€å˜æˆäº†ã€Œé¡ºåºå†™ã€ï¼Œæå‡ MySQL å†™å…¥ç£ç›˜çš„æ€§èƒ½:

- redo log buffer å†™å…¥åˆ°ç£ç›˜ä¸­çš„`redo log group`ä¸­çš„ `ib_logfile0/1`æ–‡ä»¶ä¸­ï¼Œé‡‡ç”¨çš„æ˜¯å¾ªç¯å†™
- è€ŒæŒä¹…åŒ–æ•°æ®æ—¶éœ€è¦å…ˆæ‰¾åˆ°è¯¥æ•°æ®é¡µçš„ä½ç½®ï¼Œç„¶åéå†é¡µå†…é“¾è¡¨ï¼Œä½¿ç”¨çš„æ˜¯éšæœºå†™





å½“æ‰§è¡Œä¸€ä¸ªæ›´æ–°æ“ä½œæ—¶

1. é¦–å…ˆä»ç£ç›˜ä¸­è¯»å–ç›¸åº”çš„æ•°æ®é¡µåˆ°å†…å­˜`Buffer Pool`ä¸­
2. ç„¶åæ›´æ–°å†…å­˜ä¸­çš„æ•°æ®ï¼Œ**å¹¶æ ‡è®°è¯¥å†…å­˜ä¸­çš„æ•°æ®é¡µä¸ºè„é¡µ(Flushé“¾è¡¨)**
3. ç„¶åè®°å½•`redo log`æ—¥å¿—(ç›¸åº”çš„ `Redo Log` æ¡ç›®ä¼šå¾ˆå¿«åœ°è¢«å†™å…¥åˆ°ç£ç›˜ä¸­çš„`redo log`æ–‡ä»¶ä¸­)ï¼Œå®é™…ä¸Š`redo log` ä¹Ÿæœ‰è‡ªå·±çš„ç¼“å­˜â€”â€” **`redo log buffer`**ï¼Œæ¯å½“äº§ç”Ÿä¸€æ¡ `redo log` æ—¶ï¼Œä¼šå…ˆå†™å…¥åˆ° `redo log buffer`ï¼Œåç»­å†æŒä¹…åŒ–åˆ°ç£ç›˜(äº‹åŠ¡æäº¤åredo logå…ˆåˆ·ç›˜åˆ°redo log groupä¸­)
4. éšåInnoDB å¼•æ“åœ¨é€‚å½“çš„æ—¶å€™ç”±åå°çº¿ç¨‹å°†ç¼“å­˜åœ¨ Buffer Pool çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜é‡Œ

> - å³åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œåªè¦å…ˆå°† redo log æŒä¹…åŒ–åˆ°ç£ç›˜å³å¯ï¼Œå¯ä»¥ä¸éœ€è¦ç­‰åˆ°å°†ç¼“å­˜åœ¨ Buffer Pool é‡Œçš„è„é¡µæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜
>
> - å½“ç³»ç»Ÿå´©æºƒæ—¶ï¼Œè™½ç„¶è„é¡µæ•°æ®æ²¡æœ‰æŒä¹…åŒ–ï¼Œä½†æ˜¯ redo log å·²ç»æŒä¹…åŒ–ï¼Œæ¥ç€ MySQL é‡å¯åï¼Œå¯ä»¥æ ¹æ® redo log çš„å†…å®¹ï¼Œå°†æ‰€æœ‰æ•°æ®æ¢å¤åˆ°æœ€æ–°çš„çŠ¶æ€
>
> - **ä¸ä»…redo logè¦å…ˆåˆ·ç›˜ï¼Œæ•°æ®ä¹Ÿè¦å†™å…¥ç£ç›˜ï¼ï¼** ä¸¤è€…åŒºåˆ«åœ¨äºï¼š
>
>   å†™å…¥ redo log çš„æ–¹å¼ä½¿ç”¨äº†è¿½åŠ æ“ä½œï¼Œ æ‰€ä»¥ç£ç›˜æ“ä½œæ˜¯**é¡ºåºå†™**ï¼Œè€Œå†™å…¥æ•°æ®éœ€è¦å…ˆæ‰¾åˆ°å†™å…¥ä½ç½®ï¼Œç„¶åæ‰å†™åˆ°ç£ç›˜ï¼Œæ‰€ä»¥ç£ç›˜æ“ä½œæ˜¯**éšæœºå†™**ã€‚
>
>   ç£ç›˜çš„ã€Œé¡ºåºå†™ ã€æ¯”ã€Œéšæœºå†™ã€ é«˜æ•ˆçš„å¤šï¼Œå› æ­¤ redo log å†™å…¥ç£ç›˜çš„å¼€é”€æ›´å°ã€‚
>
>   è¿™æ˜¯ WAL æŠ€æœ¯çš„å¦å¤–ä¸€ä¸ªä¼˜ç‚¹ï¼š**MySQL çš„å†™æ“ä½œä»ç£ç›˜çš„ã€Œéšæœºå†™ã€å˜æˆäº†ã€Œé¡ºåºå†™ã€**ï¼Œæå‡è¯­å¥çš„æ‰§è¡Œæ€§èƒ½ã€‚













**question1**ï¼š  **`redo log` å’Œ `binlog` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

*1ã€é€‚ç”¨å¯¹è±¡ä¸åŒï¼š*

- binlog æ˜¯ MySQL çš„ Server å±‚å®ç°çš„æ—¥å¿—ï¼Œæ‰€æœ‰å­˜å‚¨å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ï¼›
- redo log æ˜¯ Innodb å­˜å‚¨å¼•æ“å®ç°çš„æ—¥å¿—ï¼›

*2ã€æ–‡ä»¶æ ¼å¼ä¸åŒï¼š*

- binlog æœ‰ 3 ç§æ ¼å¼ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ STATEMENTï¼ˆé»˜è®¤æ ¼å¼ï¼‰ã€ROWã€ MIXEDï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š
  - STATEMENTï¼šæ¯ä¸€æ¡ä¿®æ”¹æ•°æ®çš„ SQL éƒ½ä¼šè¢«è®°å½•åˆ° `binlog` ä¸­ï¼ˆç›¸å½“äºè®°å½•äº†é€»è¾‘æ“ä½œï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ç§æ ¼å¼ï¼Œ `binlog` å¯ä»¥ç§°ä¸ºé€»è¾‘æ—¥å¿—ï¼‰ï¼Œä¸»ä»å¤åˆ¶ä¸­ slave ç«¯å†æ ¹æ® SQL è¯­å¥é‡ç°ã€‚ä½† STATEMENT æœ‰åŠ¨æ€å‡½æ•°çš„é—®é¢˜ï¼Œæ¯”å¦‚ä½ ç”¨äº† uuid æˆ–è€… now è¿™äº›å‡½æ•°ï¼Œä½ åœ¨ä¸»åº“ä¸Šæ‰§è¡Œçš„ç»“æœå¹¶ä¸æ˜¯ä½ åœ¨ä»åº“æ‰§è¡Œçš„ç»“æœï¼Œè¿™ç§éšæ—¶åœ¨å˜çš„å‡½æ•°ä¼šå¯¼è‡´å¤åˆ¶çš„æ•°æ®ä¸ä¸€è‡´ï¼›
  - ROWï¼šè®°å½•è¡Œæ•°æ®æœ€ç»ˆè¢«ä¿®æ”¹æˆä»€ä¹ˆæ ·äº†ï¼ˆè¿™ç§æ ¼å¼çš„æ—¥å¿—ï¼Œå°±ä¸èƒ½ç§°ä¸ºé€»è¾‘æ—¥å¿—äº†ï¼‰ï¼Œä¸ä¼šå‡ºç° STATEMENT ä¸‹åŠ¨æ€å‡½æ•°çš„é—®é¢˜ã€‚ä½† **ROW çš„ç¼ºç‚¹æ˜¯æ¯è¡Œæ•°æ®çš„å˜åŒ–ç»“æœéƒ½ä¼šè¢«è®°å½•ï¼Œæ¯”å¦‚æ‰§è¡Œæ‰¹é‡ update è¯­å¥ï¼Œæ›´æ–°å¤šå°‘è¡Œæ•°æ®å°±ä¼šäº§ç”Ÿå¤šå°‘æ¡è®°å½•ï¼Œä½¿ binlog æ–‡ä»¶è¿‡å¤§ï¼Œè€Œåœ¨ STATEMENT æ ¼å¼ä¸‹æ¯æ¬¡çš„æ›´æ–°åªä¼šè®°å½•ä¸€ä¸ª update ç±»å‹çš„sqlè¯­å¥è€Œå·²**ï¼›
  - MIXEDï¼šåŒ…å«äº† STATEMENT å’Œ ROW æ¨¡å¼ï¼Œå®ƒä¼šæ ¹æ®ä¸åŒçš„æƒ…å†µè‡ªåŠ¨ä½¿ç”¨ ROW æ¨¡å¼å’Œ STATEMENT æ¨¡å¼ï¼›
- redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯åœ¨æŸä¸ªæ•°æ®é¡µåšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œæ¯”å¦‚å¯¹ XXX è¡¨ç©ºé—´ä¸­çš„ YYY æ•°æ®é¡µ ZZZ åç§»é‡çš„åœ°æ–¹åšäº†AAA æ›´æ–°ï¼›



> `binlog`ä¸­çš„`row`æ ¼å¼å’Œ`statement`æ ¼å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ?

å‡è®¾æœ‰ä¸€ä¸ªè¡¨æ ¼ `employees`ï¼Œå…¶ä¸­æœ‰ä»¥ä¸‹è®°å½•ï¼š

| id   | name  | salary |
| ---- | ----- | ------ |
| 1    | John  | 50000  |
| 2    | Alice | 60000  |
| 3    | Bob   | 55000  |

å¦‚æœè¿›è¡Œä¸€ä¸ª `UPDATE` æ“ä½œï¼š

```SQL
UPDATE employees SET salary = 58000 WHERE id = 2;
```

åœ¨ `binlog` ä¸­ä»¥ `row` æ ¼å¼è®°å½•çš„è¯ï¼Œä¼šè®°å½•è¿™æ ·çš„ä¿¡æ¯ï¼š

| Event Type | Table Name | Row Data (after change) |
| ---------- | ---------- | ----------------------- |
| UPDATE     | employees  | (2, Alice, 58000)       |

è¿™è¡¨ç¤ºè¿›è¡Œäº†ä¸€æ¬¡ UPDATE æ“ä½œï¼Œä¿®æ”¹äº† `id` ä¸º 2 çš„å‘˜å·¥çš„è–ªæ°´ä¸º 58000ã€‚è®°å½•çš„æ˜¯ä¿®æ”¹åçš„æ•°æ® `(2, Alice, 58000)`



ç°åœ¨æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ª `UPDATE` è¯­å¥ï¼Œå°†æ‰€æœ‰å‘˜å·¥çš„è–ªæ°´å¢åŠ 10%ï¼šä½†æ˜¯è¿™æ¬¡ä½¿ç”¨çš„æ˜¯`statement`æ ¼å¼å­˜å‚¨çš„binlog:

```sql
UPDATE employees SET salary = salary * 1.1;
```

åœ¨ `binlog` ä¸­ä»¥ `statement` æ ¼å¼è®°å½•çš„è¯ï¼Œä¼šè®°å½•è¿™æ ·çš„ä¿¡æ¯ï¼š

| Event Type | SQL Statement                               |
| ---------- | ------------------------------------------- |
| UPDATE     | UPDATE employees SET salary = salary * 1.1; |









*3ã€å†™å…¥æ–¹å¼ä¸åŒï¼š*

- binlog æ˜¯**è¿½åŠ å†™**ï¼Œ**å†™æ»¡ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç»§ç»­å†™ï¼Œä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ï¼Œä¿å­˜çš„æ˜¯å…¨é‡çš„æ—¥å¿—ã€‚**
- redo log æ˜¯å¾ªç¯å†™ï¼Œæ—¥å¿—ç©ºé—´å¤§å°æ˜¯å›ºå®šï¼Œå…¨éƒ¨å†™æ»¡å°±ä»å¤´å¼€å§‹ï¼Œä¿å­˜æœªè¢«åˆ·å…¥ç£ç›˜çš„è„é¡µæ—¥å¿—



*4ã€ç”¨é€”ä¸åŒï¼š*

- binlog ç”¨äºå¤‡ä»½æ¢å¤ã€**ä¸»ä»å¤åˆ¶**(slaveèŠ‚ç‚¹é‡æ”¾masterèŠ‚ç‚¹ä¼ æ¥çš„binlog)ï¼›
- redo log ç”¨äºæ‰ç”µç­‰æ•…éšœæ¢å¤







**question2**ï¼š  **`redo log` ä½•æ—¶åˆ·ç›˜ï¼Ÿ**



> å‰æï¼š
>
> 1. å½“äº‹åŠ¡æ‰§è¡Œ UPDATEã€INSERT æˆ– DELETE ç­‰ä¿®æ”¹æ•°æ®çš„æ“ä½œæ—¶ï¼Œè¿™äº›æ›´æ”¹æ“ä½œä¸ä¼šç›´æ¥å†™å…¥ç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ï¼Œè€Œæ˜¯é¦–å…ˆå†™å…¥ `Redo Log Buffer` ä¸­ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œé¿å…é¢‘ç¹çš„ç£ç›˜å†™å…¥
>
>    
>
> 2. åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œ`Redo Log Buffer` ä¸­çš„ redo ä¿¡æ¯å°†è¢«åˆ·æ–°åˆ° `Redo Log` æ–‡ä»¶ç»„ä¸­çš„ä¸€ä¸ª redo log æ–‡ä»¶ä¸­ï¼Œç„¶åæ‰ä¼šæ›´æ–°ç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ã€‚



ç¼“å­˜åœ¨ `redo log buffer` é‡Œçš„ `redo log` è¿˜æ˜¯åœ¨å†…å­˜ä¸­ï¼Œå®ƒä»€ä¹ˆæ—¶å€™åˆ·æ–°åˆ°ç£ç›˜ï¼Ÿ

ä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªæ—¶æœºï¼š

- MySQL æ­£å¸¸å…³é—­æ—¶ï¼›
- å½“ **redo log buffer ä¸­è®°å½•çš„å†™å…¥é‡å¤§äº redo log buffer å†…å­˜ç©ºé—´çš„ä¸€åŠæ—¶**ï¼Œä¼šè§¦å‘è½ç›˜(è½ç›˜åˆ°`redo log group`ä¸­çš„æŸä¸€ä¸ªæ–‡ä»¶)ï¼›
- InnoDB çš„**åå°çº¿ç¨‹æ¯éš” 1 ç§’ï¼Œå°† `redo log buffer` æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­çš„`redo log group`æ–‡ä»¶**ä¸­ï¼›
- **æ¯æ¬¡äº‹åŠ¡æäº¤**æ—¶éƒ½å°†ç¼“å­˜åœ¨ redo log buffer é‡Œçš„ redo log ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ˆè¿™ä¸ªç­–ç•¥å¯ç”± `innodb_flush_log_at_trx_commit` å‚æ•°æ§åˆ¶





**question3ï¼š  `redo log` æ–‡ä»¶å†™æ»¡äº†æ€ä¹ˆåŠï¼Ÿ**

 InnoDB å­˜å‚¨å¼•æ“æœ‰ 1 ä¸ª `redo log Group`,ã€Œé‡åšæ—¥å¿—æ–‡ä»¶ç»„ã€ç”±æœ‰ 2 ä¸ª redo log æ–‡ä»¶ç»„æˆï¼Œè¿™ä¸¤ä¸ª redo æ—¥å¿—çš„æ–‡ä»¶åå« ï¼š`ib_logfile0` å’Œ `ib_logfile1` ,æ¯ä¸ª redo log File çš„å¤§å°æ˜¯å›ºå®šä¸”ä¸€è‡´çš„ï¼Œå‡è®¾æ¯ä¸ª redo log File è®¾ç½®çš„ä¸Šé™æ˜¯ 1 GBï¼Œé‚£ä¹ˆæ€»å…±å°±å¯ä»¥è®°å½• 2GB çš„æ“ä½œ

é‡åšæ—¥å¿—æ–‡ä»¶ç»„(**ä½äºç£ç›˜ä¸­** â—â—â— )æ˜¯ä»¥**å¾ªç¯å†™**çš„æ–¹å¼å·¥ä½œçš„ï¼Œä»å¤´å¼€å§‹å†™ï¼Œå†™åˆ°æœ«å°¾å°±åˆå›åˆ°å¼€å¤´ï¼Œæ‰€ä»¥ InnoDB å­˜å‚¨å¼•æ“ä¼šå…ˆå†™ ib_logfile0 æ–‡ä»¶ï¼Œå½“ ib_logfile0 æ–‡ä»¶è¢«å†™æ»¡çš„æ—¶å€™ï¼Œä¼šåˆ‡æ¢è‡³ ib_logfile1 æ–‡ä»¶ï¼Œå½“ ib_logfile1 æ–‡ä»¶ä¹Ÿè¢«å†™æ»¡æ—¶ï¼Œä¼šåˆ‡æ¢å› ib_logfile0 æ–‡ä»¶

redo log æ˜¯å¾ªç¯å†™çš„æ–¹å¼ï¼Œç›¸å½“äºä¸€ä¸ªç¯å½¢ï¼ŒInnoDB ç”¨ `write pos` è¡¨ç¤º redo log å½“å‰è®°å½•å†™åˆ°çš„ä½ç½®ï¼Œç”¨ checkpoint è¡¨ç¤ºå½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œå¦‚ä¸‹å›¾ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/checkpoint.webp" style="zoom:50%;" />



- write pos å’Œ checkpoint çš„ç§»åŠ¨éƒ½æ˜¯é¡ºæ—¶é’ˆæ–¹å‘ï¼›
- write pos ï½ checkpoint ä¹‹é—´çš„éƒ¨åˆ†ï¼ˆå›¾ä¸­çš„çº¢è‰²éƒ¨åˆ†ï¼‰ï¼Œç”¨æ¥è®°å½•æ–°çš„æ›´æ–°æ“ä½œï¼›
- check point ï½ write pos ä¹‹é—´çš„éƒ¨åˆ†ï¼ˆå›¾ä¸­è“è‰²éƒ¨åˆ†ï¼‰ï¼š**å¾…è½ç›˜çš„è„æ•°æ®é¡µè®°å½•ï¼›**

å¦‚æœ write pos è¿½ä¸Šäº† checkpointï¼Œå°±æ„å‘³ç€ **redo log æ–‡ä»¶æ»¡äº†ï¼Œè¿™æ—¶ MySQL ä¸èƒ½å†æ‰§è¡Œæ–°çš„æ›´æ–°æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ MySQL ä¼šè¢«é˜»å¡**ï¼Œæ­¤æ—¶**ä¼šåœä¸‹æ¥å°† Buffer Pool ä¸­çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œç„¶åæ ‡è®° redo log å“ªäº›è®°å½•å¯ä»¥è¢«æ“¦é™¤ï¼Œæ¥ç€å¯¹æ—§çš„ redo log è®°å½•è¿›è¡Œæ“¦é™¤ï¼Œç­‰æ“¦é™¤å®Œæ—§è®°å½•è…¾å‡ºäº†ç©ºé—´ï¼Œcheckpoint å°±ä¼šå¾€åç§»åŠ¨ï¼ˆå›¾ä¸­é¡ºæ—¶é’ˆï¼‰**ï¼Œç„¶å MySQL æ¢å¤æ­£å¸¸è¿è¡Œï¼Œç»§ç»­æ‰§è¡Œæ–°çš„æ›´æ–°æ“ä½œ

æ‰€ä»¥ï¼Œä¸€æ¬¡ checkpoint çš„è¿‡ç¨‹å°±æ˜¯è„é¡µåˆ·æ–°åˆ°ç£ç›˜ä¸­å˜æˆå¹²å‡€é¡µï¼Œç„¶åæ ‡è®° redo log å“ªäº›è®°å½•å¯ä»¥è¢«è¦†ç›–çš„è¿‡ç¨‹













### bin log

MySQL åœ¨å®Œæˆä¸€æ¡æ›´æ–°æ“ä½œåï¼Œ`Server` å±‚è¿˜ä¼šç”Ÿæˆä¸€æ¡ `binlog`(**redo logæ˜¯åœ¨äº‹åŠ¡è¿›è¡Œä¸­æ¯æ‰§è¡Œä¸€æ¡å¢åˆ æ”¹æ“ä½œåï¼Œå…ˆè®°å½•å¯¹åº”çš„redo logåˆ°buffer poolä¸­çš„redo log bufferé‡Œï¼Œåç»­å†åˆ·ç›˜**)ï¼Œç­‰ä¹‹åäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œä¼šå°†è¯¥äº‹ç‰©æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ‰€æœ‰ `binlog` ç»Ÿä¸€å†™å…¥ `binlog` æ–‡ä»¶

MySQLçš„Binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰å’ŒRedo Logï¼ˆé‡åšæ—¥å¿—ï¼‰æ˜¯ä¸¤ç§ä¸åŒçš„æ—¥å¿—æœºåˆ¶ï¼Œç”¨äºä¸åŒçš„ç›®çš„ï¼Œå¹¶åœ¨MySQLä¸­æ‰®æ¼”ä¸åŒçš„è§’è‰²ã€‚

1. Binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ï¼š
   - Binlogæ˜¯MySQLçš„ä¸»è¦æ—¥å¿—ï¼Œç”¨äºè®°å½•å¯¹æ•°æ®åº“è¿›è¡Œçš„ä¿®æ”¹æ“ä½œï¼Œå¦‚INSERTã€UPDATEã€DELETEç­‰
   - Binlogé€šå¸¸ç”¨äºå®ç°æ•°æ®å¤åˆ¶ï¼ˆreplicationï¼‰å’Œæ¢å¤ï¼ˆrecoveryï¼‰æ“ä½œã€‚å®ƒå¯ä»¥è¢«å…¶ä»–MySQLå®ä¾‹ï¼ˆå¦‚ä»æœåŠ¡å™¨ï¼‰è¯»å–å’Œåº”ç”¨ï¼Œä»¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§å’Œå¤åˆ¶æ›´æ–°æ“ä½œ
   - Binlogæ˜¯**é€»è¾‘æ—¥å¿—(ä»…ä»…åœ¨statementæ ¼å¼ä¸‹)**ï¼Œå®ƒè®°å½•çš„æ˜¯SQLè¯­å¥çš„é€»è¾‘æ“ä½œï¼Œè€Œä¸æ˜¯ç‰©ç†æ“ä½œ
   
2. Redo Logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼š
   - Redo Logæ˜¯Innodbçš„äº‹åŠ¡æ—¥å¿—ï¼Œç”¨äºè®°å½•æ•°æ®åº“çš„ç‰©ç†ä¿®æ”¹æ“ä½œï¼Œå¦‚æ•°æ®é¡µçš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œ
   - Redo Logä»¥å¾ªç¯å†™ï¼ˆcircular writeï¼‰çš„æ–¹å¼è®°å½•ï¼Œæ˜¯ä¸€ä¸ªæŒä¹…çš„ã€é¡ºåºè¿½åŠ çš„æ—¥å¿—æ–‡ä»¶
   - Redo Logçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿åœ¨ç³»ç»Ÿå´©æºƒæˆ–æ„å¤–æ–­ç”µç­‰æƒ…å†µä¸‹ï¼Œå¯ä»¥å°†å°šæœªæŒä¹…åŒ–åˆ°ç£ç›˜çš„äº‹åŠ¡ä¿®æ”¹é‡æ–°åº”ç”¨ï¼Œä¿æŒæ•°æ®çš„ä¸€è‡´æ€§
   - Redo Logæ˜¯**ç‰©ç†æ—¥å¿—**ï¼Œå®ƒè®°å½•çš„æ˜¯innodbå¼•æ“å±‚é¢çš„ç‰©ç†ä¿®æ”¹æ“ä½œï¼Œä»¥ä¾¿åœ¨å´©æºƒæ¢å¤æ—¶é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œï¼Œä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§
   
   

> é€»è¾‘æ—¥å¿—æ˜¯æŒ‡MySQLä¸­çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinary logï¼‰ã€‚å®ƒæ˜¯MySQLæœåŠ¡å™¨å°†æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„æ“ä½œè®°å½•ä¸‹æ¥çš„ä¸€ç§æ–¹å¼ã€‚é€»è¾‘æ—¥å¿—ä»¥ä¸€ç§é€šç”¨çš„ã€ä¸å…·ä½“å­˜å‚¨å¼•æ“æ— å…³çš„æ ¼å¼è®°å½•äº†æ•°æ®åº“çš„é€»è¾‘æ“ä½œï¼Œå¦‚æ’å…¥ï¼ˆINSERTï¼‰ã€æ›´æ–°ï¼ˆUPDATEï¼‰ã€åˆ é™¤ï¼ˆDELETEï¼‰ç­‰ã€‚**é€»è¾‘æ—¥å¿—è®°å½•çš„æ˜¯SQLè¯­å¥çš„é€»è¾‘å†…å®¹(åŒæ ·æ˜¯åªæ˜¯åœ¨statementæ ¼å¼ä¸‹)**ï¼Œè€Œä¸æ˜¯å…·ä½“çš„ç‰©ç†ä¿®æ”¹
>
> 
>
> ç‰©ç†æ—¥å¿—å®ƒè®°å½•äº†å¯¹æ•°æ®åº“ä¸­æ•°æ®è¿›è¡Œç‰©ç†ä¿®æ”¹çš„è¯¦ç»†ä¿¡æ¯ã€‚ç‰©ç†æ—¥å¿—ä»¥ä¸€ç§ä¸å…·ä½“å­˜å‚¨å¼•æ“ç›¸å…³çš„æ ¼å¼è®°å½•äº†æ•°æ®åº“çš„ç‰©ç†æ“ä½œï¼Œå¦‚åœ¨ç£ç›˜ä¸Šçš„é¡µæˆ–å—ä¸­è¿›è¡Œçš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ã€‚ç‰©ç†æ—¥å¿—è®°å½•äº†å…·ä½“çš„ä¿®æ”¹ï¼Œè€Œä¸ä»…ä»…æ˜¯SQLè¯­å¥çš„é€»è¾‘å†…å®¹ï¼Œ**ä¾‹å¦‚redo logå°±è®°å½•äº†å¯¹innodbä¸­çš„è¡¨ç©ºé—´å†…çš„å“ªä¸ªåŒºä¸­çš„å“ªä¸ªé¡µå†…çš„å¤šå°‘åç§»é‡ä½ç½®å¤„åšäº†XXXä¿®æ”¹**



[å°æ—Codingä¸Šå¯¹binlogå’Œredo logçš„åŒºåˆ«æ€»ç»“:](https://xiaolincoding.com/mysql/log/how_update.html#redo-log-%E5%92%8C-binlog-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB)

*1ã€é€‚ç”¨å¯¹è±¡ä¸åŒï¼š*

- binlog æ˜¯ MySQL çš„ Server å±‚å®ç°çš„æ—¥å¿—ï¼Œæ‰€æœ‰å­˜å‚¨å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ï¼›
- redo log æ˜¯ Innodb å­˜å‚¨å¼•æ“å®ç°çš„æ—¥å¿—ï¼›

*2ã€æ–‡ä»¶æ ¼å¼ä¸åŒï¼š*

- binlog æœ‰ 3 ç§æ ¼å¼ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ STATEMENTï¼ˆé»˜è®¤æ ¼å¼ï¼‰ã€ROWã€ MIXEDï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š
  - åŸºäºè¯­å¥ï¼ˆStatement-Basedï¼‰æ ¼å¼ï¼š
    - **è®°å½•çš„æ˜¯æ‰§è¡Œçš„SQLè¯­å¥æœ¬èº«**ï¼Œä¾‹å¦‚INSERTã€UPDATEã€DELETEç­‰(åªè®°å½•ä¿®æ”¹æ•°æ®çš„sql)ã€‚
    - è¾ƒä¸ºç®€æ´ï¼Œæ—¥å¿—æ–‡ä»¶ç›¸å¯¹è¾ƒå°ã€‚
    - ä¸»è¦å¤åˆ¶çš„æ˜¯SQLè¯­å¥ï¼Œä»æœåŠ¡å™¨åœ¨é‡æ”¾æ—¶ä¼šæ‰§è¡Œç›¸åŒçš„SQLè¯­å¥æ¥è¾¾åˆ°æ•°æ®ä¸€è‡´æ€§ã€‚
    - å¯èƒ½å­˜åœ¨éç¡®å®šæ€§çš„ç»“æœï¼Œå› ä¸ºæŸäº›æ“ä½œå¯èƒ½ä¾èµ–äºéšæœºå› ç´ æˆ–ç³»ç»ŸçŠ¶æ€ã€‚
  - åŸºäºè¡Œï¼ˆRow-Basedï¼‰æ ¼å¼ï¼š
    - è®°å½•çš„æ˜¯å¯¹æ•°æ®è¡Œçš„å…·ä½“ä¿®æ”¹ï¼Œä¾‹å¦‚å°†æŸä¸€è¡Œæ”¹ä¸ºä»€ä¹ˆå€¼
    - ä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…éœ€è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº† 
  - æ··åˆï¼ˆMixedï¼‰æ ¼å¼ï¼š
    - æ˜¯åŸºäºsqlè¯­å¥æ ¼å¼å’ŒåŸºäºè¡Œæ ¼å¼çš„ç»„åˆ
    - åœ¨MySQLä¸­æ˜¯é»˜è®¤çš„äºŒè¿›åˆ¶æ—¥å¿—æ ¼å¼
    - æ ¹æ®å…·ä½“çš„æ“ä½œé€‰æ‹©ä½¿ç”¨åŸºäºè¯­å¥æ ¼å¼è¿˜æ˜¯åŸºäºè¡Œæ ¼å¼è¿›è¡Œè®°å½•
    - å¤§å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨åŸºäºè¯­å¥æ ¼å¼ï¼Œä½†å¯¹äºæŸäº›ç‰¹æ®Šçš„æ“ä½œä¼šåˆ‡æ¢åˆ°åŸºäºè¡Œæ ¼å¼
    - æ—¢å¯ä»¥å¤åˆ¶SQLè¯­å¥ï¼Œåˆå¯ä»¥å¤åˆ¶å…·ä½“çš„æ•°æ®è¡Œä¿®æ”¹æ“ä½œ



- redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯åœ¨æŸä¸ªæ•°æ®é¡µåšäº†ä»€ä¹ˆä¿®æ”¹ï¼Œæ¯”å¦‚å¯¹ XXX è¡¨ç©ºé—´ä¸­çš„ YYY æ•°æ®é¡µ ZZZ åç§»é‡çš„åœ°æ–¹åšäº†AAA æ›´æ–°ï¼›

*3ã€å†™å…¥æ–¹å¼ä¸åŒï¼š*

- bin log æ˜¯è¿½åŠ å†™ï¼Œå†™æ»¡ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç»§ç»­å†™ï¼Œä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ï¼Œä¿å­˜çš„æ˜¯å…¨é‡çš„æ—¥å¿—
- redo log æ˜¯å¾ªç¯å†™ï¼Œæ—¥å¿—ç©ºé—´å¤§å°æ˜¯å›ºå®šï¼Œå…¨éƒ¨å†™æ»¡å°±ä»å¤´å¼€å§‹ï¼Œä¿å­˜æœªè¢«åˆ·å…¥ç£ç›˜çš„è„é¡µæ—¥å¿—

*4ã€ç”¨é€”ä¸åŒï¼š*

- bin log ç”¨äºå¤‡ä»½æ¢å¤ã€ä¸»ä»å¤åˆ¶ï¼›
- redo log ç”¨äºæ‰ç”µç­‰æ•…éšœæ¢å¤ã€‚







> å¦‚æœä¸å°å¿ƒæ•´ä¸ªæ•°æ®åº“çš„æ•°æ®è¢«åˆ é™¤äº†ï¼Œèƒ½ä½¿ç”¨ redo log æ–‡ä»¶æ¢å¤æ•°æ®å—ï¼Ÿ

ä¸å¯ä»¥ä½¿ç”¨ redo log æ–‡ä»¶æ¢å¤ï¼Œåªèƒ½ä½¿ç”¨ binlog æ–‡ä»¶æ¢å¤

**å› ä¸º redo log æ–‡ä»¶æ˜¯å¾ªç¯å†™ï¼Œæ˜¯ä¼šè¾¹å†™è¾¹æ“¦é™¤æ—¥å¿—çš„ï¼Œåªè®°å½•æœªè¢«åˆ·å…¥ç£ç›˜çš„æ•°æ®çš„ç‰©ç†æ—¥å¿—ï¼Œå·²ç»åˆ·å…¥ç£ç›˜çš„æ•°æ®éƒ½ä¼šä» redo log æ–‡ä»¶é‡Œæ“¦é™¤**

binlog æ–‡ä»¶ä¿å­˜çš„æ˜¯å…¨é‡çš„æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜äº†æ‰€æœ‰æ•°æ®å˜æ›´çš„æƒ…å†µï¼Œç†è®ºä¸Šåªè¦è®°å½•åœ¨ binlog ä¸Šçš„æ•°æ®ï¼Œéƒ½å¯ä»¥æ¢å¤ï¼Œæ‰€ä»¥å¦‚æœä¸å°å¿ƒæ•´ä¸ªæ•°æ®åº“çš„æ•°æ®è¢«åˆ é™¤äº†ï¼Œå¾—ç”¨ binlog æ–‡ä»¶æ¢å¤æ•°æ®









> **binlog ä½•æ—¶åˆ·ç›˜ï¼Ÿ**

äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠæ—¥å¿—å†™åˆ° `binlog cache`ï¼ˆMySQL ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ç‰‡å†…å­˜ç”¨äºç¼“å†² `binlog` ï¼‰ï¼Œäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå†æŠŠ `binlog cache` å†™åˆ° `binlog` æ–‡ä»¶ä¸­ï¼Œå¹¶æ¸…ç©º `binlog cache`

è™½ç„¶æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·± `binlog cache`ï¼Œä½†æ˜¯æœ€ç»ˆéƒ½å†™åˆ°åŒä¸€ä¸ª `binlog` æ–‡ä»¶ï¼š![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/binlogcache.drawio.webp)



- å›¾ä¸­çš„ `write`ï¼ŒæŒ‡çš„å°±æ˜¯æŒ‡æŠŠæ—¥å¿—å†™å…¥åˆ° `binlog` æ–‡ä»¶(ä½äºå†…å­˜ä¸­)ï¼Œä½†æ˜¯**å¹¶æ²¡æœ‰æŠŠæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå› ä¸ºæ•°æ®è¿˜ç¼“å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ `page cache` é‡Œ**ï¼Œ`write` çš„å†™å…¥é€Ÿåº¦è¿˜æ˜¯æ¯”è¾ƒå¿«çš„ï¼Œå› ä¸ºä¸æ¶‰åŠç£ç›˜ I/Oã€‚
- å›¾ä¸­çš„ fsync(ç”¨äºå°†ç¼“å†²åŒºä¸­çš„æ•°æ®å¼ºåˆ¶å†™å…¥ç£ç›˜)ï¼Œæ‰æ˜¯å°†`binlog`æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¼šæ¶‰åŠç£ç›˜ I/Oï¼Œæ‰€ä»¥é¢‘ç¹çš„ fsync ä¼šå¯¼è‡´ç£ç›˜çš„ I/O å‡é«˜



MySQLæä¾›ä¸€ä¸ª sync_binlog å‚æ•°æ¥æ§åˆ¶æ•°æ®åº“çš„ binlog åˆ·åˆ°ç£ç›˜ä¸Šçš„é¢‘ç‡ï¼š

- sync_binlog = 0 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª writeï¼Œä¸ fsyncï¼Œåç»­äº¤ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼›
- sync_binlog = 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼š writeï¼Œç„¶åé©¬ä¸Šæ‰§è¡Œ fsyncï¼›
- sync_binlog =N(N>1) çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ writeï¼Œä½†ç´¯ç§¯ N ä¸ªäº‹åŠ¡åæ‰ fsyncã€‚









### ä¸»ä»å¤åˆ¶

MySQL çš„ä¸»ä»å¤åˆ¶ä¾èµ–äº binlog ï¼Œä¹Ÿå°±æ˜¯è®°å½• MySQL ä¸Šçš„æ‰€æœ‰å˜åŒ–å¹¶ä»¥äºŒè¿›åˆ¶å½¢å¼ä¿å­˜åœ¨ç£ç›˜ä¸Šã€‚å¤åˆ¶çš„è¿‡ç¨‹å°±æ˜¯å°† binlog ä¸­çš„æ•°æ®ä»ä¸»åº“ä¼ è¾“åˆ°ä»åº“ä¸Š

è¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬æ˜¯**å¼‚æ­¥**çš„ï¼Œä¹Ÿå°±æ˜¯ä¸»åº“ä¸Šæ‰§è¡Œäº‹åŠ¡æ“ä½œçš„çº¿ç¨‹ä¸ä¼šç­‰å¾…å¤åˆ¶ binlog çš„çº¿ç¨‹åŒæ­¥å®Œæˆ

MySQL é›†ç¾¤çš„ä¸»ä»å¤åˆ¶è¿‡ç¨‹æ¢³ç†æˆ 3 ä¸ªé˜¶æ®µï¼š

- **å†™å…¥ Binlog**ï¼šä¸»åº“æäº¤äº‹åŠ¡å å†™binlog æ—¥å¿—(write `binlog cache`)ï¼Œå¹¶æ›´æ–°æœ¬åœ°å­˜å‚¨æ•°æ®(`fsync`å†™å…¥ç£ç›˜)
- **åŒæ­¥ Binlog**ï¼šä¸»åº“åå°å¯åŠ¨ä¸€ä¸ª`log dump`çº¿ç¨‹ï¼ŒæŠŠ binlog å¤åˆ¶åˆ°æ‰€æœ‰ä»åº“ä¸Šï¼Œæ¯ä¸ªä»åº“æŠŠ binlog å†™åˆ°æš‚å­˜æ—¥å¿—**`relay log`**ä¸­(ä»åº“ä¸Šå¯åŠ¨IOçº¿ç¨‹å®Œæˆè¿™äº›æ“ä½œ)
- **å›æ”¾ Binlog**ï¼šä»åº“æœ€åå¯åŠ¨ä¸€ä¸ª SQL çº¿ç¨‹æ¥å›æ”¾ binlog (åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œäº‹åŠ¡æ—¥å¿—ï¼ˆBinary Logï¼‰çš„å†…å®¹)ï¼Œå¹¶æ›´æ–°å…¶å„è‡ªå­˜å‚¨å¼•æ“ä¸­çš„æ•°æ®

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E8%BF%87%E7%A8%8B.drawio.webp)

å…·ä½“è¯¦ç»†è¿‡ç¨‹å¦‚ä¸‹ï¼š

- MySQL ä¸»åº“åœ¨æ”¶åˆ°å®¢æˆ·ç«¯æäº¤äº‹åŠ¡çš„è¯·æ±‚ä¹‹åï¼Œä¼šå…ˆå†™å…¥ binlogï¼Œå†æäº¤äº‹åŠ¡ï¼Œæ›´æ–°å­˜å‚¨å¼•æ“ä¸­çš„æ•°æ®ï¼Œäº‹åŠ¡æäº¤å®Œæˆåï¼Œè¿”å›ç»™å®¢æˆ·ç«¯â€œæ“ä½œæˆåŠŸâ€çš„å“åº”
- ä»åº“ä¼šåˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ I/O çº¿ç¨‹ï¼Œè¿æ¥ä¸»åº“çš„ `log dump` çº¿ç¨‹ï¼Œæ¥æ¥æ”¶ä¸»åº“çš„ binlog æ—¥å¿—ï¼Œ**å†æŠŠ binlog ä¿¡æ¯å†™å…¥ `relay log` çš„ä¸­ç»§æ—¥å¿—é‡Œ**ï¼Œå†è¿”å›ç»™ä¸»åº“â€œå¤åˆ¶æˆåŠŸâ€çš„å“åº”
- ä»åº“ä¼šåˆ›å»ºä¸€ä¸ªç”¨äºå›æ”¾ binlog çš„çº¿ç¨‹(SQLçº¿ç¨‹)ï¼Œå»è¯» `relay log` ä¸­ç»§æ—¥å¿—ï¼Œç„¶åå›æ”¾ binlog æ›´æ–°å­˜å‚¨å¼•æ“ä¸­çš„æ•°æ®ï¼Œæœ€ç»ˆå®ç°ä¸»ä»çš„æ•°æ®ä¸€è‡´æ€§





`Relay log`çš„ä½œç”¨æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1. æ•°æ®ä¼ é€’ï¼šä¸»æ•°æ®åº“æœåŠ¡å™¨å°†äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary Logï¼‰ä¸­çš„æ›´æ”¹æ“ä½œä¼ è¾“ç»™ä»æ•°æ®åº“æœåŠ¡å™¨ã€‚ä»æ•°æ®åº“æœåŠ¡å™¨æ¥æ”¶åˆ°è¿™äº›æ›´æ”¹æ“ä½œåï¼Œå°†å…¶è®°å½•åˆ° Relay Log ä¸­ã€‚
2. é‡æ”¾æ“ä½œï¼šä»æ•°æ®åº“
æœåŠ¡å™¨æ ¹æ® Relay Log ä¸­çš„è®°å½•ï¼ŒæŒ‰ç…§ç›¸åŒçš„é¡ºåºé‡æ–°æ‰§è¡Œä¸»æ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„æ›´æ”¹æ“ä½œï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿ä»æ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„æ•°æ®ä¸ä¸»æ•°æ®åº“æœåŠ¡å™¨ä¿æŒä¸€è‡´ã€‚
3. å®¹é”™æ¢å¤ï¼šå¦‚æœä»æ•°æ®åº“æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæˆ–æ–­å¼€è¿æ¥ï¼Œå¹¶é‡æ–°è¿æ¥åˆ°ä¸»æ•°æ®åº“æœåŠ¡å™¨ï¼ŒRelay Log å¯ä»¥ç”¨æ¥æ¢å¤ä¸¢å¤±çš„æ›´æ”¹æ“ä½œã€‚**ä»æ•°æ®åº“æœåŠ¡å™¨å¯ä»¥æ ¹æ® Relay Log ä¸­çš„è®°å½•ï¼Œä»ä¸Šæ¬¡æ–­å¼€è¿æ¥çš„ä½ç½®ç»§ç»­è¿›è¡Œå¤åˆ¶**ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ã€‚
4. **å»¶è¿Ÿå¤åˆ¶**ï¼šRelay Log è¿˜å¯ä»¥ç”¨äºå®ç°ä¸»ä»å¤åˆ¶çš„å»¶è¿Ÿã€‚ é€šè¿‡åœ¨ä»æ•°æ®åº“æœåŠ¡å™¨ä¸Šä¿ç•™ Relay Log çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥å»¶è¿Ÿä»æ•°æ®åº“æœåŠ¡å™¨æ‰§è¡Œä¸»æ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„æ›´æ”¹æ“ä½œï¼Œä»è€Œå®ç°æ•°æ®å¤åˆ¶çš„å»¶è¿Ÿæ•ˆæœã€‚



å…¶å®ä¸»è¦å°±æ˜¯èµ·äº†ç¼“å†²çš„ä½œç”¨,ç±»ä¼¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„`Broker`

> å…³äº**å»¶è¿Ÿå¤åˆ¶**ï¼šåœ¨ MySQL ä¸­ï¼Œå»¶è¿Ÿå¤åˆ¶æ˜¯æŒ‡ä»æ•°æ®åº“æœåŠ¡å™¨åœ¨ä¸»ä»å¤åˆ¶ä¸­æ•…æ„å»¶è¿Ÿåº”ç”¨ä¸»æ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„æ›´æ”¹æ“ä½œã€‚å»¶è¿Ÿå¤åˆ¶å¯ä»¥åœ¨ä»æœåŠ¡å™¨ä¸Šå¼•å…¥ä¸€å®šçš„æ—¶é—´å»¶è¿Ÿï¼Œä½¿ä»æœåŠ¡å™¨çš„æ•°æ®å˜æ›´ç›¸å¯¹äºä¸»æœåŠ¡å™¨æœ‰ä¸€å®šçš„æ»åã€‚å»¶è¿Ÿå¤åˆ¶çš„ç›®çš„æœ‰å‡ ä¸ªå¯èƒ½çš„åŸå› ï¼š
>
> 1. æ•…éšœæ¢å¤ï¼šå¦‚æœåœ¨ä¸»æœåŠ¡å™¨ä¸Šå‘ç”Ÿäº†è¯¯æ“ä½œã€é”™è¯¯çš„æ•°æ®æ›´æ”¹æˆ–è€…æ•°æ®æŸåï¼Œé€šè¿‡å»¶è¿Ÿå¤åˆ¶ï¼Œå¯ä»¥æä¾›ä¸€å®šçš„æ—¶é—´çª—å£æ¥æ£€æµ‹é—®é¢˜å¹¶é‡‡å–å¿…è¦çš„æªæ–½ï¼Œä¾‹å¦‚ä¸­æ­¢å¤åˆ¶æˆ–è¿˜åŸåˆ°è¾ƒæ—©çš„æ—¶é—´ç‚¹ã€‚
> 2. æ•°æ®éªŒè¯ï¼šå»¶è¿Ÿå¤åˆ¶å¯ä»¥æä¾›é¢å¤–çš„æ—¶é—´æ¥éªŒè¯ä¸»æœåŠ¡å™¨ä¸Šçš„æ›´æ”¹æ“ä½œï¼Œä»¥ç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å¯ä»¥ç”¨äºæ£€æµ‹ä¸»æœåŠ¡å™¨ä¸Šçš„é”™è¯¯æ“ä½œæˆ–æ•°æ®å†²çªã€‚
> 3. è´Ÿè½½æ§åˆ¶ï¼šå»¶è¿Ÿå¤åˆ¶å¯ä»¥åœ¨ä»æœåŠ¡å™¨ä¸Šå¼•å…¥ä¸€å®šçš„å»¶è¿Ÿï¼Œä»è€Œå‡è½»ä»æœåŠ¡å™¨çš„è´Ÿè½½ã€‚è¿™å¯¹äºå¤§å‹å¤åˆ¶ç¯å¢ƒæˆ–è€…ä»æœåŠ¡å™¨ä¸ŠåŒæ—¶æ‰§è¡Œå…¶ä»–é‡è¦ä»»åŠ¡çš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨





**MySQL ä¸»ä»å¤åˆ¶æœ‰å“ªäº›æ¨¡å‹ï¼Ÿ**

ä¸»è¦æœ‰ä¸‰ç§ï¼š

- **åŒæ­¥å¤åˆ¶**ï¼šMySQL ä¸»åº“æäº¤äº‹åŠ¡çš„çº¿ç¨‹è¦ç­‰å¾…æ‰€æœ‰ä»åº“çš„å¤åˆ¶æˆåŠŸå“åº”ï¼Œæ‰è¿”å›å®¢æˆ·ç«¯ç»“æœã€‚è¿™ç§æ–¹å¼åœ¨å®é™…é¡¹ç›®ä¸­ï¼ŒåŸºæœ¬ä¸Šæ²¡æ³•ç”¨ï¼ŒåŸå› æœ‰ä¸¤ä¸ªï¼šä¸€æ˜¯æ€§èƒ½å¾ˆå·®ï¼Œå› ä¸ºè¦å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹æ‰è¿”å›å“åº”ï¼›äºŒæ˜¯å¯ç”¨æ€§ä¹Ÿå¾ˆå·®ï¼Œä¸»åº“å’Œæ‰€æœ‰ä»åº“ä»»ä½•ä¸€ä¸ªæ•°æ®åº“å‡ºé—®é¢˜ï¼Œéƒ½ä¼šå½±å“ä¸šåŠ¡ã€‚
- **å¼‚æ­¥å¤åˆ¶**ï¼ˆé»˜è®¤æ¨¡å‹ï¼‰ï¼šMySQL ä¸»åº“æäº¤äº‹åŠ¡çš„çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾… binlog åŒæ­¥åˆ°å„ä»åº“ï¼Œå°±è¿”å›å®¢æˆ·ç«¯ç»“æœã€‚è¿™ç§æ¨¡å¼ä¸€æ—¦ä¸»åº“å®•æœºï¼Œæ•°æ®å°±ä¼šå‘ç”Ÿä¸¢å¤±ã€‚
- **åŠåŒæ­¥å¤åˆ¶**ï¼šMySQL 5.7 ç‰ˆæœ¬ä¹‹åå¢åŠ çš„ä¸€ç§å¤åˆ¶æ–¹å¼ï¼Œä»‹äºä¸¤è€…ä¹‹é—´ï¼Œäº‹åŠ¡çº¿ç¨‹ä¸ç”¨ç­‰å¾…æ‰€æœ‰çš„ä»åº“å¤åˆ¶æˆåŠŸå“åº”ï¼Œåªè¦ä¸€éƒ¨åˆ†å¤åˆ¶æˆåŠŸå“åº”å›æ¥å°±è¡Œï¼Œæ¯”å¦‚ä¸€ä¸»äºŒä»çš„é›†ç¾¤ï¼Œåªè¦æ•°æ®æˆåŠŸå¤åˆ¶åˆ°ä»»æ„ä¸€ä¸ªä»åº“ä¸Šï¼Œä¸»åº“çš„äº‹åŠ¡çº¿ç¨‹å°±å¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™ç§**åŠåŒæ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œå…¼é¡¾äº†å¼‚æ­¥å¤åˆ¶å’ŒåŒæ­¥å¤åˆ¶çš„ä¼˜ç‚¹ï¼Œå³ä½¿å‡ºç°ä¸»åº“å®•æœºï¼Œè‡³å°‘è¿˜æœ‰ä¸€ä¸ªä»åº“æœ‰æœ€æ–°çš„æ•°æ®ï¼Œä¸å­˜åœ¨æ•°æ®ä¸¢å¤±çš„é£é™©**











### Buffer Pool

`Innodb` å­˜å‚¨å¼•æ“è®¾è®¡äº†ä¸€ä¸ª**ç¼“å†²æ± ï¼ˆBuffer Poolï¼‰**,æ¥æ›¿ä»£`Server`å±‚ä¸­çš„æŸ¥è¯¢ç¼“å­˜(æ¯”è¾ƒé¸¡è‚‹ï¼Œä¸€æ—¦æ¶‰åŠåˆ°`update`ç­‰æ“ä½œæŸ¥è¯¢ç¼“å­˜å°±ä¼šå¤±æ•ˆ)ï¼Œ`Buffer Pool`ï¼ˆç¼“å†²æ± ï¼‰æ˜¯åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ã€‚åœ¨`InnoDB`å­˜å‚¨å¼•æ“ä¸­ï¼Œ`Buffer Pool`æ˜¯ä¸€ä¸ªç”¨äºç¼“å­˜æ•°æ®åº“è¡¨æ•°æ®å’Œç´¢å¼•çš„å†…å­˜åŒºåŸŸ

æœ‰äº† `Buffer Pool` åï¼š

- å½“è¯»å–æ•°æ®æ—¶ï¼Œå¦‚æœæ•°æ®å­˜åœ¨äº `Buffer Pool` ä¸­ï¼Œå®¢æˆ·ç«¯å°±ä¼šç›´æ¥è¯»å– `Buffer Pool` ä¸­çš„æ•°æ®ï¼Œå¦åˆ™å†å»ç£ç›˜ä¸­è¯»å–
- å½“ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¦‚æœæ•°æ®å­˜åœ¨äº `Buffer Pool` ä¸­ï¼Œé‚£ç›´æ¥ä¿®æ”¹ `Buffer Pool` ä¸­æ•°æ®æ‰€åœ¨çš„é¡µï¼Œç„¶åå°†å…¶é¡µè®¾ç½®ä¸ºè„é¡µï¼ˆè¯¥é¡µçš„å†…å­˜æ•°æ®å’Œç£ç›˜ä¸Šçš„æ•°æ®å·²ç»ä¸ä¸€è‡´ï¼‰ï¼Œ**ä¸ºäº†å‡å°‘ç£ç›˜I/O**ï¼Œä¸ä¼šç«‹å³å°†è„é¡µå†™å…¥ç£ç›˜ï¼Œåç»­ç”±åå°çº¿ç¨‹é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ—¶æœºå°†è„é¡µå†™å…¥åˆ°ç£ç›˜



`InnoDB` ä¼šæŠŠå­˜å‚¨çš„æ•°æ®åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªã€Œé¡µã€ï¼Œä»¥é¡µä½œä¸ºç£ç›˜å’Œå†…å­˜äº¤äº’çš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ªé¡µçš„é»˜è®¤å¤§å°ä¸º 16KBã€‚å› æ­¤ï¼Œ`Buffer Pool` **åŒæ ·éœ€è¦æŒ‰ã€Œé¡µã€æ¥åˆ’åˆ†**

åœ¨ MySQL å¯åŠ¨çš„æ—¶å€™ï¼Œ**`InnoDB` ä¼šä¸º `Buffer Pool` ç”³è¯·ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œç„¶åæŒ‰ç…§é»˜è®¤çš„`16KB`çš„å¤§å°åˆ’åˆ†å‡ºä¸€ä¸ªä¸ªçš„é¡µ(å¯¹åº”Innodbä¸­é¡µçš„å¤§å°)ï¼Œ `Buffer Pool` ä¸­çš„é¡µå°±å«åšç¼“å­˜é¡µ**ã€‚æ­¤æ—¶è¿™äº›ç¼“å­˜é¡µéƒ½æ˜¯ç©ºé—²çš„ï¼Œä¹‹åéšç€ç¨‹åºçš„è¿è¡Œï¼Œæ‰ä¼šæœ‰ç£ç›˜ä¸Šçš„é¡µè¢«ç¼“å­˜åˆ° `Buffer Pool` ä¸­

`Buffer Pool` é™¤äº†ç¼“å­˜ã€Œç´¢å¼•é¡µã€å’Œã€Œæ•°æ®é¡µã€ï¼Œè¿˜åŒ…æ‹¬äº† Undo é¡µï¼Œæ’å…¥ç¼“å­˜ã€è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ã€é”ä¿¡æ¯ç­‰ç­‰ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/bufferpool%E5%86%85%E5%AE%B9.drawio.webp" style="zoom: 67%;" />



åœ¨å¼€å¯äº‹åŠ¡åï¼Œ`InnoDB` å±‚æ›´æ–°è®°å½•å‰ï¼Œé¦–å…ˆè¦è®°å½•ç›¸åº”çš„ `undo log`(å¦‚æœæ˜¯æ›´æ–°æ“ä½œï¼Œéœ€è¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¦ç”Ÿæˆä¸€æ¡ `undo log`)ï¼Œ`undo log` ä¼šå†™å…¥ `Buffer Pool` ä¸­çš„ `Undo` é¡µé¢

å½“æˆ‘ä»¬æŸ¥è¯¢ä¸€æ¡è®°å½•æ—¶ï¼ŒInnoDB æ˜¯ä¼šæŠŠæ•´ä¸ªé¡µçš„æ•°æ®åŠ è½½åˆ° Buffer Pool ä¸­ï¼Œå°†é¡µåŠ è½½åˆ° Buffer Pool åï¼Œå†é€šè¿‡é¡µé‡Œçš„ã€Œé¡µç›®å½•ã€å»å®šä½åˆ°æŸæ¡å…·ä½“çš„è®°å½•(åˆ†ç»„å¤–äºŒåˆ†æŸ¥æ‰¾ï¼Œåˆ†ç»„å†…é¡ºåºéå†)







(1) Free é“¾è¡¨ï¼š Buffer Pool æ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå½“ MySQL è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œè¿™ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­çš„ç¼“å­˜é¡µæ—¢æœ‰ç©ºé—²çš„ï¼Œä¹Ÿæœ‰è¢«ä½¿ç”¨çš„ã€‚é‚£å½“æˆ‘ä»¬ä»ç£ç›˜è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œæ€»ä¸èƒ½é€šè¿‡éå†è¿™ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´æ¥æ‰¾åˆ°ç©ºé—²çš„ç¼“å­˜é¡µå§ï¼Œè¿™æ ·æ•ˆç‡å¤ªä½äº†ã€‚æ‰€ä»¥ï¼Œ**ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç©ºé—²çš„ç¼“å­˜é¡µï¼Œå¯ä»¥ä½¿ç”¨é“¾è¡¨ç»“æ„ï¼Œå°†ç©ºé—²ç¼“å­˜é¡µçš„ã€Œæ§åˆ¶å—ã€ä½œä¸ºé“¾è¡¨çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªé“¾è¡¨ç§°ä¸º Free é“¾è¡¨ï¼ˆç©ºé—²é“¾è¡¨ï¼‰**



(2)Flush é“¾è¡¨ï¼š æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è¦å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯å°† Buffer Pool å¯¹åº”çš„ç¼“å­˜é¡µæ ‡è®°ä¸º**è„é¡µ**ï¼Œç„¶åå†ç”±åå°çº¿ç¨‹å°†è„é¡µå†™å…¥åˆ°ç£ç›˜ã€‚é‚£ä¸ºäº†èƒ½å¿«é€ŸçŸ¥é“å“ªäº›ç¼“å­˜é¡µæ˜¯è„çš„ï¼Œäºæ˜¯å°±è®¾è®¡å‡º **Flush é“¾è¡¨**,å®ƒè·Ÿ Free é“¾è¡¨ç±»ä¼¼çš„ï¼Œé“¾è¡¨çš„èŠ‚ç‚¹ä¹Ÿæ˜¯æ§åˆ¶å—ï¼Œ**åŒºåˆ«åœ¨äº Flush é“¾è¡¨çš„å…ƒç´ éƒ½æ˜¯è„é¡µ**



(3)LRU é“¾è¡¨ï¼šBuffer Pool çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œå¯¹äºä¸€äº›é¢‘ç¹è®¿é—®çš„æ•°æ®æˆ‘ä»¬å¸Œæœ›å¯ä»¥ä¸€ç›´ç•™åœ¨ Buffer Pool ä¸­ï¼Œè€Œä¸€äº›å¾ˆå°‘è®¿é—®çš„æ•°æ®å¸Œæœ›å¯ä»¥åœ¨æŸäº›æ—¶æœºå¯ä»¥æ·˜æ±°æ‰ï¼Œä»è€Œä¿è¯ Buffer Pool ä¸ä¼šå› ä¸ºæ»¡äº†è€Œå¯¼è‡´æ— æ³•å†ç¼“å­˜æ–°çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯å¸¸ç”¨æ•°æ®ç•™åœ¨ Buffer Pool ä¸­ï¼Œå› æ­¤å¯¹äºClean Pageå’ŒDirty Pageéƒ½éœ€è¦ä½¿ç”¨LRUé“¾è¡¨æ¥è¿æ¥





å³ Buffer Pool é‡Œæœ‰ä¸‰ç§æ•°æ®é¡µå’Œé“¾è¡¨æ¥ç®¡ç†æ•°æ®:

- Free Pageï¼ˆç©ºé—²é¡µï¼‰ï¼Œè¡¨ç¤ºæ­¤é¡µè¿˜æœªè¢«ç¼“å­˜æ ‡è®°ï¼Œä½äº `Free` é“¾è¡¨ï¼›
- Clean Pageï¼ˆå¹²å‡€é¡µï¼‰ï¼Œè¡¨ç¤ºæ­¤é¡µå·²è¢«ä½¿ç”¨(å·²ç»æœ‰å¯¹åº”çš„æ•°æ®é¡µä»ç£ç›˜åŠ å…¥è‡³è¯¥é¡µ)ï¼Œä½†æ˜¯é¡µé¢æœªå‘ç”Ÿä¿®æ”¹ï¼Œä½äº`LRU` é“¾è¡¨;
- Dirty Pageï¼ˆè„é¡µï¼‰ï¼Œè¡¨ç¤ºæ­¤é¡µã€Œå·²è¢«ä½¿ç”¨ã€ä¸”ã€Œå·²ç»è¢«ä¿®æ”¹ã€ï¼Œå…¶æ•°æ®å’Œç£ç›˜ä¸Šçš„æ•°æ®å·²ç»ä¸ä¸€è‡´ã€‚å½“è„é¡µä¸Šçš„æ•°æ®å†™å…¥ç£ç›˜åï¼Œå†…å­˜æ•°æ®å’Œç£ç›˜æ•°æ®ä¸€è‡´ï¼Œé‚£ä¹ˆè¯¥é¡µå°±å˜æˆäº†å¹²å‡€é¡µã€‚è„é¡µåŒæ—¶å­˜åœ¨äº `LRU` é“¾è¡¨å’Œ **`Flush` é“¾è¡¨**







> **WALæŠ€æœ¯ï¼š**

`Buffer Pool` æ˜¯åŸºäºå†…å­˜çš„ï¼Œè€Œå†…å­˜æ€»æ˜¯ä¸å¯é ï¼Œä¸‡ä¸€æ–­ç”µé‡å¯ï¼Œè¿˜æ²¡æ¥å¾—åŠ**è½ç›˜**çš„è„é¡µæ•°æ®å°±ä¼šä¸¢å¤±

ä¸ºäº†é˜²æ­¢æ–­ç”µå¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜ï¼Œå½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼Œ`InnoDB` å¼•æ“å°±ä¼šå…ˆæ›´æ–°å†…å­˜ï¼ˆåŒæ—¶æ ‡è®°ä¸ºè„é¡µï¼‰ï¼Œç„¶åå°†æœ¬æ¬¡å¯¹è¿™ä¸ªé¡µçš„ä¿®æ”¹ä»¥ `redo log` çš„å½¢å¼è®°å½•ä¸‹æ¥ï¼Œ**è¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†**

åç»­ï¼Œ`InnoDB` å¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œç”±**åå°çº¿ç¨‹å°†ç¼“å­˜åœ¨ `Buffer Pool` çš„è„é¡µåˆ·æ–°åˆ°ç£ç›˜é‡Œ**ï¼Œè¿™å°±æ˜¯ **WAL ï¼ˆWrite-Ahead Loggingï¼‰æŠ€æœ¯**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/wal.webp" style="zoom:67%;" />

åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œåªè¦å…ˆå°† redo log æŒä¹…åŒ–åˆ°ç£ç›˜å³å¯ï¼Œå¯ä»¥ä¸éœ€è¦ç­‰åˆ°å°†ç¼“å­˜åœ¨ Buffer Pool é‡Œçš„è„é¡µæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™æ ·å½“ç³»ç»Ÿå´©æºƒæ—¶ï¼Œè™½ç„¶è„é¡µæ•°æ®æ²¡æœ‰æŒä¹…åŒ–ï¼Œä½†æ˜¯ redo log å·²ç»æŒä¹…åŒ–ï¼Œæ¥ç€ MySQL é‡å¯åï¼Œå¯ä»¥æ ¹æ® redo log çš„å†…å®¹ï¼Œå°†æ‰€æœ‰æ•°æ®æ¢å¤åˆ°æœ€æ–°çš„çŠ¶æ€



> **è„é¡µä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ·å…¥ç£ç›˜?**

å¼•å…¥äº† Buffer Pool åï¼Œå½“ä¿®æ”¹æ•°æ®æ—¶ï¼Œé¦–å…ˆæ˜¯ä¿®æ”¹ Buffer Pool ä¸­æ•°æ®æ‰€åœ¨çš„é¡µï¼Œç„¶åå°†å…¶é¡µè®¾ç½®ä¸ºè„é¡µï¼Œä½†æ˜¯ç£ç›˜ä¸­è¿˜æ˜¯åŸæ•°æ®ã€‚å› æ­¤ï¼Œè„é¡µéœ€è¦è¢«åˆ·å…¥ç£ç›˜ï¼Œä¿è¯ç¼“å­˜å’Œç£ç›˜æ•°æ®ä¸€è‡´ï¼Œä½†æ˜¯è‹¥æ¯æ¬¡ä¿®æ”¹æ•°æ®éƒ½åˆ·å…¥ç£ç›˜ï¼Œåˆ™æ€§èƒ½ä¼šå¾ˆå·®ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ä¼šåœ¨ä¸€å®šæ—¶æœºè¿›è¡Œæ‰¹é‡åˆ·ç›˜ä¸‹é¢å‡ ç§æƒ…å†µä¼šè§¦å‘è„é¡µçš„åˆ·æ–°ï¼š

- å½“ redo log æ—¥å¿—(ä½äºç£ç›˜ä¸Š)æ»¡äº†çš„æƒ…å†µä¸‹ï¼Œä¼šä¸»åŠ¨è§¦å‘è„é¡µåˆ·æ–°åˆ°ç£ç›˜ï¼›
- Buffer Pool ç©ºé—´ä¸è¶³æ—¶ï¼Œéœ€è¦å°†ä¸€éƒ¨åˆ†æ•°æ®é¡µæ·˜æ±°æ‰ï¼Œå¦‚æœæ·˜æ±°çš„æ˜¯è„é¡µï¼Œéœ€è¦å…ˆå°†è„é¡µåŒæ­¥åˆ°ç£ç›˜ï¼›
- MySQL è®¤ä¸ºç©ºé—²æ—¶ï¼Œåå°çº¿ç¨‹ä¼šå®šæœŸå°†é€‚é‡çš„è„é¡µåˆ·å…¥åˆ°ç£ç›˜ï¼›
- MySQL æ­£å¸¸å…³é—­ä¹‹å‰ï¼Œä¼šæŠŠæ‰€æœ‰çš„è„é¡µåˆ·å…¥åˆ°ç£ç›˜ï¼›





### ä¸€æ¡sqlè¯­å¥æ‰§è¡Œæ—¶çš„æ—¥å¿—å˜åŒ–

å…·ä½“æ›´æ–°ä¸€æ¡è®°å½• `UPDATE t_user SET name = 'xiaolin' WHERE id = 1;` çš„æµç¨‹å¦‚ä¸‹:

1. æ‰§è¡Œå™¨è´Ÿè´£å…·ä½“æ‰§è¡Œï¼Œä¼šè°ƒç”¨å­˜å‚¨å¼•æ“çš„æ¥å£ï¼Œé€šè¿‡ä¸»é”®ç´¢å¼•æ ‘æœç´¢è·å– id = 1 è¿™ä¸€è¡Œè®°å½•ï¼š
   - å¦‚æœ id=1 è¿™ä¸€è¡Œæ‰€åœ¨çš„æ•°æ®é¡µæœ¬æ¥å°±åœ¨ buffer pool ä¸­ï¼Œå°±ç›´æ¥è¿”å›ç»™æ‰§è¡Œå™¨æ›´æ–°ï¼›
   - å¦‚æœè®°å½•ä¸åœ¨ buffer poolï¼Œå°†æ•°æ®é¡µä»ç£ç›˜è¯»å…¥åˆ° buffer poolï¼Œè¿”å›è®°å½•ç»™æ‰§è¡Œå™¨(æ¶‰åŠåˆ°åœ¨B+æ ‘ä¸ŠåŠæ¯ä¸ªæ•°æ®é¡µå†…éƒ¨ æ§½çš„äºŒåˆ†æŸ¥è¯¢ã€ç»„å†…éƒ¨çš„é“¾è¡¨éå†)ã€‚
2. æ‰§è¡Œå™¨å¾—åˆ°èšç°‡ç´¢å¼•è®°å½•åï¼Œä¼šçœ‹ä¸€ä¸‹æ›´æ–°å‰çš„è®°å½•å’Œæ›´æ–°åçš„è®°å½•æ˜¯å¦ä¸€æ ·ï¼š
   - å¦‚æœä¸€æ ·çš„è¯å°±ä¸è¿›è¡Œåç»­æ›´æ–°æµç¨‹ï¼›
   - å¦‚æœä¸ä¸€æ ·çš„è¯å°±æŠŠæ›´æ–°å‰çš„è®°å½•å’Œæ›´æ–°åçš„è®°å½•éƒ½å½“ä½œå‚æ•°ä¼ ç»™ InnoDB å±‚ï¼Œè®© InnoDB çœŸæ­£çš„æ‰§è¡Œæ›´æ–°è®°å½•çš„æ“ä½œï¼›
3. å¼€å¯äº‹åŠ¡ï¼Œ InnoDB å±‚æ›´æ–°è®°å½•å‰ï¼Œé¦–å…ˆè¦è®°å½•ç›¸åº”çš„ undo logï¼Œå› ä¸ºè¿™æ˜¯æ›´æ–°æ“ä½œï¼Œéœ€è¦æŠŠè¢«æ›´æ–°çš„åˆ—çš„æ—§å€¼è®°ä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¦ç”Ÿæˆä¸€æ¡ undo logï¼Œundo log ä¼šå†™å…¥ Buffer Pool ä¸­çš„ Undo é¡µé¢ï¼Œä¸è¿‡åœ¨å†…å­˜ä¿®æ”¹è¯¥ Undo é¡µé¢åï¼Œéœ€è¦è®°å½•å¯¹åº”çš„ redo log
4. InnoDB å±‚å¼€å§‹æ›´æ–°è®°å½•ï¼Œä¼šå…ˆæ›´æ–°å†…å­˜ï¼ˆåŒæ—¶æ ‡è®°ä¸ºè„é¡µï¼‰ï¼Œç„¶åå°†è®°å½•å†™åˆ° redo log é‡Œé¢ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚ä¸ºäº†å‡å°‘ç£ç›˜I/Oï¼Œä¸ä¼šç«‹å³å°†è„é¡µå†™å…¥ç£ç›˜ï¼Œåç»­ç”±åå°çº¿ç¨‹é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æ—¶æœºå°†è„é¡µå†™å…¥åˆ°ç£ç›˜ã€‚è¿™å°±æ˜¯ **WAL æŠ€æœ¯**ï¼ŒMySQL çš„å†™æ“ä½œå¹¶ä¸æ˜¯ç«‹åˆ»å†™åˆ°ç£ç›˜ä¸Šï¼Œè€Œæ˜¯å…ˆå†™ redo æ—¥å¿—ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶é—´å†å°†ä¿®æ”¹çš„è¡Œæ•°æ®å†™åˆ°ç£ç›˜ä¸Š
6. åœ¨ä¸€æ¡æ›´æ–°è¯­å¥æ‰§è¡Œå®Œæˆåï¼ŒServerå±‚å¼€å§‹è®°å½•è¯¥è¯­å¥å¯¹åº”çš„ binlogï¼Œæ­¤æ—¶è®°å½•çš„ binlog ä¼šè¢«ä¿å­˜åˆ° binlog cacheï¼Œå¹¶æ²¡æœ‰åˆ·æ–°åˆ°ç¡¬ç›˜ä¸Šçš„ binlog æ–‡ä»¶ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šç»Ÿä¸€å°†è¯¥äº‹åŠ¡è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ binlog åˆ·æ–°åˆ°ç¡¬ç›˜









# Redis





## Redisçº¿ç¨‹æ¨¡å‹



**`Redis` å•çº¿ç¨‹æŒ‡çš„æ˜¯ã€Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚->è§£æè¯·æ±‚ ->è¿›è¡Œæ•°æ®è¯»å†™ç­‰æ“ä½œ->å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ã€è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰æ¥å®Œæˆçš„**ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´ `Redis` æ˜¯å•çº¿ç¨‹çš„åŸå› 

ä½†æ˜¯ï¼Œ**`Redis` ç¨‹åºå¹¶ä¸æ˜¯å•çº¿ç¨‹çš„**ï¼Œ`Redis` åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯ä¼š**å¯åŠ¨åå°çº¿ç¨‹**ï¼ˆ`BIO`ï¼‰çš„ï¼š

- **`Redis` åœ¨ 2.6 ç‰ˆæœ¬**ï¼Œä¼šå¯åŠ¨ 2 ä¸ªåå°çº¿ç¨‹ï¼Œåˆ†åˆ«å¤„ç†å…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜è¿™ä¸¤ä¸ªä»»åŠ¡ï¼›
- **`Redis` åœ¨ 4.0 ç‰ˆæœ¬ä¹‹å**ï¼Œæ–°å¢äº†ä¸€ä¸ªæ–°çš„åå°çº¿ç¨‹ï¼Œç”¨æ¥å¼‚æ­¥é‡Šæ”¾ `Redis` å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ `lazyfree` çº¿ç¨‹ã€‚ä¾‹å¦‚æ‰§è¡Œ unlink key / flushdb async / flushall async ç­‰å‘½ä»¤ï¼Œä¼šæŠŠè¿™äº›åˆ é™¤æ“ä½œäº¤ç»™åå°çº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¥½å¤„æ˜¯ä¸ä¼šå¯¼è‡´ Redis ä¸»çº¿ç¨‹å¡é¡¿ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è¦åˆ é™¤ä¸€ä¸ªå¤§ key çš„æ—¶å€™ï¼Œä¸è¦ä½¿ç”¨ del å‘½ä»¤åˆ é™¤ï¼Œå› ä¸º del æ˜¯åœ¨ä¸»çº¿ç¨‹å¤„ç†çš„ï¼Œè¿™æ ·ä¼šå¯¼è‡´ `Redis` ä¸»çº¿ç¨‹å¡é¡¿ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥**ä½¿ç”¨ unlink å‘½ä»¤æ¥å¼‚æ­¥åˆ é™¤å¤§key**

ä¹‹æ‰€ä»¥ `Redis` ä¸ºã€Œ**å…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜ã€é‡Šæ”¾å†…å­˜**ã€è¿™äº›ä»»åŠ¡åˆ›å»ºå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†ï¼Œæ˜¯å› ä¸ºè¿™äº›ä»»åŠ¡çš„æ“ä½œéƒ½æ˜¯å¾ˆè€—æ—¶çš„ï¼Œå¦‚æœæŠŠè¿™äº›ä»»åŠ¡éƒ½æ”¾åœ¨ä¸»çº¿ç¨‹æ¥å¤„ç†ï¼Œé‚£ä¹ˆ `Redis` ä¸»çº¿ç¨‹å°±å¾ˆå®¹æ˜“å‘ç”Ÿé˜»å¡ï¼Œè¿™æ ·å°±æ— æ³•å¤„ç†åç»­çš„è¯·æ±‚äº†

åå°çº¿ç¨‹ç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç”Ÿäº§è€…æŠŠè€—æ—¶ä»»åŠ¡ä¸¢åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…ï¼ˆBIOï¼‰ä¸åœè½®è¯¢è¿™ä¸ªé˜Ÿåˆ—ï¼Œæ‹¿å‡ºä»»åŠ¡å°±å»æ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å³å¯

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B.webp" style="zoom:67%;" />

å…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜ã€é‡Šæ”¾å†…å­˜è¿™ä¸‰ä¸ªä»»åŠ¡éƒ½æœ‰å„è‡ªçš„ä»»åŠ¡é˜Ÿåˆ—ï¼š

- BIO_CLOSE_FILEï¼Œå…³é—­æ–‡ä»¶ä»»åŠ¡é˜Ÿåˆ—ï¼šå½“é˜Ÿåˆ—æœ‰ä»»åŠ¡åï¼Œåå°çº¿ç¨‹ä¼šè°ƒç”¨ close(fd) ï¼Œå°†æ–‡ä»¶å…³é—­ï¼›
- BIO_AOF_FSYNCï¼ŒAOFåˆ·ç›˜ä»»åŠ¡é˜Ÿåˆ—ï¼šå½“ AOF æ—¥å¿—é…ç½®æˆ everysec é€‰é¡¹åï¼Œä¸»çº¿ç¨‹ä¼šæŠŠ AOF å†™æ—¥å¿—æ“ä½œå°è£…æˆä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿæ”¾åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“å‘ç°é˜Ÿåˆ—æœ‰ä»»åŠ¡åï¼Œåå°çº¿ç¨‹ä¼šè°ƒç”¨ fsync(fd)ï¼Œå°† AOF æ–‡ä»¶åˆ·ç›˜ï¼Œ
- BIO_LAZY_FREEï¼Œlazy free ä»»åŠ¡é˜Ÿåˆ—ï¼šå½“é˜Ÿåˆ—æœ‰ä»»åŠ¡åï¼Œåå°çº¿ç¨‹ä¼š `free(obj)` é‡Šæ”¾å¯¹è±¡ / `free(dict)` åˆ é™¤æ•°æ®åº“æ‰€æœ‰å¯¹è±¡ / `free(skiplist)` é‡Šæ”¾è·³è¡¨å¯¹è±¡





### å•çº¿ç¨‹æ¨¡å‹

Redis 6.0 ç‰ˆæœ¬ä¹‹å‰çš„å•çº¿ç¨‹æ¨¡å¼å¦‚ä¸‹å›¾ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B.drawio.webp)





**ç”±äºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆfile event handlerï¼‰æ˜¯å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½è¯´ Redis æ˜¯å•çº¿ç¨‹æ¨¡å‹**

> `epoll()`æ˜¯ä¸€ç§é«˜æ€§èƒ½çš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œç”¨äºå¤„ç†å¤§é‡å¹¶å‘è¿æ¥çš„æƒ…å†µ,`epoll()`ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ç§éé˜»å¡çš„I/Oæ¨¡å‹ï¼Œå¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å¹¶ä¸”åœ¨è¿™äº›æ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œ
>
> `epoll()`çš„ç”¨æ³•å¦‚ä¸‹ï¼š
>
> 1. åˆ›å»º`epoll`å®ä¾‹ï¼šé¦–å…ˆï¼Œéœ€è¦é€šè¿‡`epoll_create()`ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ª`epoll`å®ä¾‹ï¼Œè¯¥å®ä¾‹ä¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºæ ‡è¯†è¿™ä¸ª`epoll`å®ä¾‹ã€‚
> 2. æ·»åŠ æ–‡ä»¶æè¿°ç¬¦åˆ°`epoll`ï¼š**ä½¿ç”¨`epoll_ctl()`ç³»ç»Ÿè°ƒç”¨å°†éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°`epoll`å®ä¾‹ä¸­**(ç›‘å¬Channel)ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®äº‹ä»¶ç±»å‹ï¼ˆä¾‹å¦‚å¯è¯»äº‹ä»¶ã€å¯å†™äº‹ä»¶ç­‰ï¼‰æ¥æŒ‡å®šç›‘è§†çš„äº‹ä»¶ã€‚
> 3. ç­‰å¾…äº‹ä»¶å°±ç»ªï¼šä½¿ç”¨`epoll_wait()`ç³»ç»Ÿè°ƒç”¨ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ªã€‚**å½“æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ªæ—¶ï¼Œ`epoll_wait()`ä¼šé˜»å¡ï¼Œå¹¶è¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ä»¥åŠå¯¹åº”çš„äº‹ä»¶ç±»å‹**ã€‚
> 4. å¤„ç†äº‹ä»¶**ï¼šä¸€æ—¦`epoll_wait()`è¿”å›æœ‰å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è¯»å–æˆ–å†™å…¥æ•°æ®æ¥å¤„ç†è¿™äº›äº‹ä»¶**ã€‚
>
> ä½¿ç”¨`epoll()`çš„ä¼˜åŠ¿åœ¨äºå®ƒé¿å…äº†ä¼ ç»Ÿçš„é˜»å¡å¼I/Oæ¨¡å‹ä¸­çš„å¤§é‡çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä»è€Œå‡å°‘äº†çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€ã€‚å®ƒå¯ä»¥åŒæ—¶ç›‘è§†å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å’Œååé‡ã€‚å› æ­¤ï¼Œå¯¹äºé«˜å¹¶å‘çš„ç½‘ç»œç¼–ç¨‹ï¼Œ`epoll()`æ˜¯ä¸€ç§é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶
>
> 
>
> 
>
> å…¶ä¸`poll()`çš„å¯¹æ¯”ï¼š
>
> 1. äº‹ä»¶æ³¨å†Œï¼š
>    - `poll()`ä½¿ç”¨`pollfd`ç»“æ„æ¥æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œå¹¶é€šè¿‡`poll()`ç³»ç»Ÿè°ƒç”¨ç­‰å¾…äº‹ä»¶å°±ç»ª
>    - `epoll()`ä½¿ç”¨`epoll_event`ç»“æ„æ¥æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œå¹¶**é€šè¿‡`epoll_wait()`ç³»ç»Ÿè°ƒç”¨ç­‰å¾…äº‹ä»¶å°±ç»ª**
> 2. æ•°æ®ç»“æ„ï¼š
>    - `poll()`ä½¿ç”¨çº¿æ€§æ•°ç»„æ¥å­˜å‚¨æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œéœ€è¦éå†æ•´ä¸ªæ•°ç»„æ¥æŸ¥æ‰¾å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
>    - `epoll()`ä½¿ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä½¿ç”¨åŒé“¾è¡¨æ¥å­˜å‚¨å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥å¿«é€ŸæŸ¥æ‰¾å’Œå¤„ç†å°±ç»ªäº‹ä»¶ã€‚
> 3. æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼š
>    - `poll()`å°†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œå› æ­¤æœ‰ä¸€ä¸ªæœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶ï¼ˆé€šå¸¸æ˜¯1024ï¼‰ã€‚
>    - `epoll()`ä½¿ç”¨çº¢é»‘æ ‘æ¥å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ã€‚
>
> ç»¼ä¸Šæ‰€è¿°ï¼Œ`epoll()`ç›¸æ¯”`poll()`åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶æœ‰æ›´é«˜çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œå¹¶ä¸”æ²¡æœ‰æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ã€‚



ä¸Šå›¾ä¸­çš„è“è‰²éƒ¨åˆ†æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯(æ— é™å¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­ç­‰å¾…å¹¶å¤„ç†äº‹ä»¶çš„åˆ°æ¥)ï¼Œæ˜¯ç”±ä¸»çº¿ç¨‹è´Ÿè´£çš„ï¼Œå¯ä»¥çœ‹åˆ°ç½‘ç»œ I/O å’Œå‘½ä»¤å¤„ç†éƒ½æ˜¯å•çº¿ç¨‹ã€‚ `Redis` åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåšä¸‹é¢è¿™å‡ ä»¶äº‹æƒ…ï¼š

- é¦–å…ˆï¼Œè°ƒç”¨ `epoll_create()` åˆ›å»ºä¸€ä¸ª `epoll` å¯¹è±¡å’Œè°ƒç”¨ `socket()` åˆ›å»ºä¸€ä¸ªæœåŠ¡ç«¯ `socket`(ip+port)
- ç„¶åï¼Œè°ƒç”¨ `bind()` **å°†å¥—æ¥å­—ç»‘å®šåˆ°æŒ‡å®šçš„IPåœ°å€å’Œç«¯å£å·ä¸Š**ï¼ŒåŒæ—¶è°ƒç”¨ `listen()` è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼›
- ç„¶åï¼Œå°†è°ƒç”¨ `epoll_ctl()` å°† `listen socket` åŠ å…¥åˆ° `epoll`å®ä¾‹ä¸­ï¼ŒåŒæ—¶**æ³¨å†Œã€Œè¿æ¥äº‹ä»¶ã€å¤„ç†å‡½æ•°**(å³è¯¥ç›‘å¬`socket`è´Ÿè´£å¤„ç†è¿æ¥åº”ç­”)



`Redis` åŸºäº `Reactor` æ¨¡å¼å¼€å‘äº†è‡ªå·±çš„ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼šè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆ`file event handler`ï¼‰

**æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆ`multiplexing`ï¼‰ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—ç›®å‰æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨**

å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­”ï¼ˆacceptï¼‰ã€è¯»å–ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰ã€å…³ é—­ï¼ˆcloseï¼‰ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šè°ƒç”¨å¥—æ¥å­—ä¹‹å‰å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚

è™½ç„¶æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œè¿™ä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§

æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆ`file event handler`ï¼‰ä¸»è¦æ˜¯åŒ…å« 4 ä¸ªéƒ¨åˆ†ï¼š

- å¤šä¸ª `socket`ï¼ˆå®¢æˆ·ç«¯è¿æ¥ï¼‰
- IO å¤šè·¯å¤ç”¨ç¨‹åºï¼ˆæ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥çš„å…³é”®ï¼‰
- æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼ˆå°† `socket` å…³è”åˆ°ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼‰
- äº‹ä»¶å¤„ç†å™¨ï¼ˆè¿æ¥åº”ç­”å¤„ç†å™¨ã€å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ã€å‘½ä»¤å›å¤å¤„ç†å™¨ï¼‰



åˆå§‹åŒ–å®Œåï¼Œä¸»çº¿ç¨‹å°±è¿›å…¥åˆ°ä¸€ä¸ª**äº‹ä»¶æ— é™å¾ªç¯å‡½æ•°`EventLoop`**ï¼Œä¸»è¦ä¼šåšä»¥ä¸‹äº‹æƒ…ï¼š

- é¦–å…ˆï¼Œå…ˆè°ƒç”¨**å¤„ç†å‘é€é˜Ÿåˆ—å‡½æ•°**ï¼Œçœ‹å‘é€é˜Ÿåˆ—é‡Œæ˜¯å¦æœ‰ä»»åŠ¡ï¼Œå¦‚æœæœ‰å‘é€ä»»åŠ¡ï¼Œåˆ™é€šè¿‡ `write` å‡½æ•°å°†å®¢æˆ·ç«¯å‘é€ç¼“å­˜åŒºé‡Œçš„æ•°æ®å‘é€å‡ºå»ï¼Œå¦‚æœè¿™ä¸€è½®æ•°æ®æ²¡æœ‰å‘é€å®Œï¼Œå°±ä¼šæ³¨å†Œå†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç­‰å¾… `epoll_wait` å‘ç°å¯å†™åå†å¤„ç† 
- æ¥ç€ï¼Œè°ƒç”¨ `epoll_wait` å‡½æ•°ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥ï¼š
  - å¦‚æœæ˜¯**è¿æ¥äº‹ä»¶**åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨**è¿æ¥äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šè°ƒç”¨ `accpet` è·å–å·²è¿æ¥çš„ `socket` -> è°ƒç”¨ `epoll_ctl` å°†å·²è¿æ¥çš„ `socket` åŠ å…¥åˆ° `epoll` -> æ³¨å†Œã€Œè¯»äº‹ä»¶ã€å¤„ç†å‡½æ•°(å°†è¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯Socketæ–¹çš„**æ–‡ä»¶æè¿°ç¬¦**åŠ å…¥åˆ°`epoll`å®ä¾‹ä¸­)ï¼›
  - å¦‚æœæ˜¯**è¯»äº‹ä»¶**åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨**è¯»äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šè°ƒç”¨ `read` è·å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ® -> è§£æå‘½ä»¤ -> å¤„ç†å‘½ä»¤ -> å°†å®¢æˆ·ç«¯å¯¹è±¡æ·»åŠ åˆ°å‘é€é˜Ÿåˆ— -> å°†æ‰§è¡Œç»“æœå†™åˆ°å‘é€ç¼“å­˜åŒºç­‰å¾…å‘é€ï¼›
  - å¦‚æœæ˜¯**å†™äº‹ä»¶**åˆ°æ¥ï¼Œåˆ™ä¼šè°ƒç”¨**å†™äº‹ä»¶å¤„ç†å‡½æ•°**ï¼Œè¯¥å‡½æ•°ä¼šåšè¿™äº›äº‹æƒ…ï¼šé€šè¿‡ `write` å‡½æ•°å°†å®¢æˆ·ç«¯å‘é€ç¼“å­˜åŒºé‡Œçš„æ•°æ®å‘é€å‡ºå»ï¼Œå¦‚æœè¿™ä¸€è½®æ•°æ®æ²¡æœ‰å‘é€å®Œï¼Œå°±ä¼šç»§ç»­æ³¨å†Œå†™äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œç­‰å¾… `epoll_wait` å‘ç°å¯å†™åå†å¤„ç†





### Rediså•çº¿ç¨‹ä¸ºä»€ä¹ˆå¿«ï¼Ÿ

ä¹‹æ‰€ä»¥ Redis é‡‡ç”¨å•çº¿ç¨‹ï¼ˆç½‘ç»œ I/O å’Œæ‰§è¡Œå‘½ä»¤ï¼‰é‚£ä¹ˆå¿«ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªåŸå› ï¼š

- çº¯å†…å­˜æ“ä½œï¼šRedis çš„å¤§éƒ¨åˆ†æ“ä½œ**éƒ½åœ¨å†…å­˜ä¸­å®Œæˆ**ï¼Œå¹¶ä¸”é‡‡ç”¨äº†é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå› æ­¤ **Redis ç“¶é¢ˆå¯èƒ½æ˜¯æœºå™¨çš„å†…å­˜æˆ–è€…ç½‘ç»œå¸¦å®½ï¼Œè€Œå¹¶é CPU**ï¼Œæ—¢ç„¶ CPU ä¸æ˜¯ç“¶é¢ˆï¼Œé‚£ä¹ˆè‡ªç„¶å°±é‡‡ç”¨å•çº¿ç¨‹çš„è§£å†³æ–¹æ¡ˆäº†ï¼›
- é¿å…äº†çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼šRedis é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹å¯ä»¥**é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ç«äº‰**ï¼Œ**çœå»äº†å¤šçº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„æ—¶é—´å’Œæ€§èƒ½ä¸Šçš„å¼€é”€**ï¼Œè€Œä¸”ä¸æ¶‰åŠçº¿ç¨‹åŒæ­¥åŠé”çš„ç«äº‰ï¼›
- Redis é‡‡ç”¨äº† **I/O å¤šè·¯å¤ç”¨æœºåˆ¶**å¤„ç†å¤§é‡çš„å®¢æˆ·ç«¯ Socket è¯·æ±‚ï¼ŒIO å¤šè·¯å¤ç”¨æœºåˆ¶æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ª IO æµï¼Œå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„ select/epoll æœºåˆ¶ã€‚ç®€å•æ¥è¯´ï¼Œåœ¨ Redis åªè¿è¡Œå•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œè¯¥æœºåˆ¶å…è®¸å†…æ ¸ä¸­ï¼ŒåŒæ—¶å­˜åœ¨å¤šä¸ªç›‘å¬ Socket å’Œå·²è¿æ¥ Socketã€‚å†…æ ¸ä¼šä¸€ç›´ç›‘å¬è¿™äº› Socket ä¸Šçš„è¿æ¥è¯·æ±‚æˆ–æ•°æ®è¯·æ±‚ã€‚ä¸€æ—¦æœ‰è¯·æ±‚åˆ°è¾¾ï¼Œå°±ä¼šäº¤ç»™ Redis çº¿ç¨‹å¤„ç†ï¼Œè¿™å°±å®ç°äº†ä¸€ä¸ª Redis çº¿ç¨‹å¤„ç†å¤šä¸ª IO æµçš„æ•ˆæœï¼›
- **éæŒä¹…åŒ–ç‰¹æ€§ï¼šRedisé»˜è®¤æƒ…å†µä¸‹ä¸è¿›è¡Œæ•°æ®æŒä¹…åŒ–**ï¼Œåªå°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸éœ€è¦è¿›è¡Œé¢‘ç¹çš„ç£ç›˜è¯»å†™ï¼Œæé«˜äº†è¯»å†™æ€§èƒ½ï¼›





### å¤šçº¿ç¨‹æ¨¡å‹

è™½ç„¶ Redis çš„ä¸»è¦å·¥ä½œï¼ˆ**ç½‘ç»œ I/O å’Œæ‰§è¡Œå‘½ä»¤**ï¼‰ä¸€ç›´æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œä½†æ˜¯**åœ¨ Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼Œä¹Ÿé‡‡ç”¨äº†å¤šä¸ª I/O çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚**ï¼Œ**è¿™æ˜¯å› ä¸ºéšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼ŒRedis çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ I/O çš„å¤„ç†ä¸Š**

ä¸ºäº†æé«˜ç½‘ç»œ I/O çš„å¹¶è¡Œåº¦ï¼ŒRedis 6.0 å¯¹äºç½‘ç»œ I/O é‡‡ç”¨å¤šçº¿ç¨‹æ¥å¤„ç†ã€‚**ä½†æ˜¯å¯¹äºå‘½ä»¤çš„æ‰§è¡Œï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†ï¼Œæ‰€ä»¥ä¸è¦è¯¯è§£** **Redis ç”±å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œå‘½ä»¤**

Redis 6.0 ç‰ˆæœ¬æ”¯æŒçš„ I/O å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œé»˜è®¤æƒ…å†µä¸‹ I/O å¤šçº¿ç¨‹åªé’ˆå¯¹å‘é€å“åº”æ•°æ®ï¼ˆ`write client socket`ï¼‰ï¼Œå¹¶ä¸ä¼šä»¥å¤šçº¿ç¨‹çš„æ–¹å¼å¤„ç†è¯»è¯·æ±‚ï¼ˆ`read client socket`ï¼‰ã€‚è¦æƒ³å¼€å¯å¤šçº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯è¯»è¯·æ±‚ï¼Œå°±éœ€è¦æŠŠ Redis.conf é…ç½®æ–‡ä»¶ä¸­çš„ io-threads-do-reads é…ç½®é¡¹è®¾ä¸º yesã€‚

```conf
//è¯»è¯·æ±‚ä¹Ÿä½¿ç”¨ioå¤šçº¿ç¨‹
io-threads-do-reads yes 
```

åŒæ—¶ï¼Œ Redis.conf é…ç½®æ–‡ä»¶ä¸­æä¾›äº† IO å¤šçº¿ç¨‹ä¸ªæ•°çš„é…ç½®é¡¹ã€‚

```conf
// io-threads Nï¼Œè¡¨ç¤ºå¯ç”¨ N-1 ä¸ª I/O å¤šçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ä¹Ÿç®—ä¸€ä¸ª I/O çº¿ç¨‹ï¼‰
io-threads 4 
```



å› æ­¤ï¼Œ Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼ŒRedis åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼š**é¢å¤–åˆ›å»º 6 ä¸ªçº¿ç¨‹**ï¼ˆ*è¿™é‡Œçš„çº¿ç¨‹æ•°ä¸åŒ…æ‹¬ä¸»çº¿ç¨‹*ï¼‰ï¼š

- Redis-server ï¼š Redisçš„ä¸»çº¿ç¨‹ï¼Œä¸»è¦è´Ÿè´£æ‰§è¡Œå‘½ä»¤ï¼›
- bio_close_fileã€bio_aof_fsyncã€bio_lazy_freeï¼šä¸‰ä¸ªåå°çº¿ç¨‹ï¼Œåˆ†åˆ«å¼‚æ­¥å¤„ç†å…³é—­æ–‡ä»¶ä»»åŠ¡ã€AOFåˆ·ç›˜ä»»åŠ¡ã€é‡Šæ”¾å†…å­˜ä»»åŠ¡ï¼›
- io_thd_1ã€io_thd_2ã€io_thd_3ï¼šä¸‰ä¸ª I/O çº¿ç¨‹ï¼Œio-threads é»˜è®¤æ˜¯ 4 ï¼Œæ‰€ä»¥ä¼šå¯åŠ¨ 3ï¼ˆ4-1ï¼‰ä¸ª I/O å¤šçº¿ç¨‹ï¼Œç”¨æ¥åˆ†æ‹… Redis ç½‘ç»œ I/O çš„å‹åŠ›



















## åŸºæœ¬æ•°æ®ç±»å‹

æ€»è§ˆï¼š

Redis æä¾›äº†ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼Œå¸¸è§çš„æœ‰äº”ç§æ•°æ®ç±»å‹ï¼š**Stringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒHashï¼ˆå“ˆå¸Œï¼‰ï¼ŒListï¼ˆåˆ—è¡¨ï¼‰ï¼ŒSetï¼ˆé›†åˆï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰** `Redis` äº”ç§æ•°æ®ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼š

- String ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼š**ç¼“å­˜å¯¹è±¡**ã€å¸¸è§„è®¡æ•°ã€**åˆ†å¸ƒå¼é”**ã€**å…±äº« session ä¿¡æ¯**
- List ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼š**æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š1. ç”Ÿäº§è€…éœ€è¦è‡ªè¡Œå®ç°å…¨å±€å”¯ä¸€ IDï¼›2. ä¸èƒ½ä»¥æ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®ï¼‰ç­‰
- Hash ç±»å‹**ï¼šç¼“å­˜å¯¹è±¡**ã€è´­ç‰©è½¦ç­‰
- Set ç±»å‹ï¼šèšåˆè®¡ç®—ï¼ˆå¹¶é›†ã€äº¤é›†ã€å·®é›†ï¼‰åœºæ™¯ï¼Œæ¯”å¦‚**ç‚¹èµ**ã€**å…±åŒå…³æ³¨**ã€æŠ½å¥–æ´»åŠ¨ç­‰
- Zset ç±»å‹ï¼šæ’åºåœºæ™¯ï¼Œæ¯”å¦‚**æ’è¡Œæ¦œ**ã€ç”µè¯å’Œå§“åæ’åºç­‰

Redis åç»­ç‰ˆæœ¬åˆæ”¯æŒå››ç§æ•°æ®ç±»å‹ï¼Œå®ƒä»¬çš„åº”ç”¨åœºæ™¯å¦‚ä¸‹ï¼š

- BitMapï¼ˆ2.2 ç‰ˆæ–°å¢ï¼‰ï¼šäºŒå€¼çŠ¶æ€ç»Ÿè®¡çš„åœºæ™¯ï¼Œæ¯”å¦‚ç­¾åˆ°ã€åˆ¤æ–­ç”¨æˆ·ç™»é™†çŠ¶æ€ã€è¿ç»­ç­¾åˆ°ç”¨æˆ·æ€»æ•°ç­‰ï¼›
- HyperLogLogï¼ˆ2.8 ç‰ˆæ–°å¢ï¼‰ï¼šæµ·é‡æ•°æ®åŸºæ•°ç»Ÿè®¡çš„åœºæ™¯ï¼Œæ¯”å¦‚ç™¾ä¸‡çº§ç½‘é¡µ UV è®¡æ•°ç­‰ï¼›
- GEOï¼ˆ3.2 ç‰ˆæ–°å¢ï¼‰ï¼šå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯çš„åœºæ™¯ï¼Œæ¯”å¦‚æ»´æ»´å«è½¦ï¼›
- Streamï¼ˆ5.0 ç‰ˆæ–°å¢ï¼‰ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç›¸æ¯”äºåŸºäº List ç±»å‹å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ‰è¿™ä¸¤ä¸ªç‰¹æœ‰çš„ç‰¹æ€§ï¼š**è‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€æ€§æ¶ˆæ¯ID**ï¼Œæ”¯æŒ**ä»¥æ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®**









### String

`String` ç±»å‹çš„åº•å±‚çš„æ•°æ®ç»“æ„å®ç°ä¸»è¦æ˜¯  `SDS`ï¼ˆç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼‰

- **SDS ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®**ã€‚SDS çš„æ‰€æœ‰ API éƒ½ä¼šä»¥å¤„ç†äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å¤„ç† SDS å­˜æ”¾åœ¨ `buf[]` æ•°ç»„é‡Œçš„æ•°æ®ã€‚æ‰€ä»¥ SDS ä¸å…‰èƒ½å­˜æ”¾æ–‡æœ¬æ•°æ®ï¼Œè€Œä¸”èƒ½ä¿å­˜å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®
- **SDS è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)** å› ä¸º C è¯­è¨€çš„å­—ç¬¦ä¸²å¹¶ä¸è®°å½•è‡ªèº«é•¿åº¦ï¼Œæ‰€ä»¥è·å–é•¿åº¦çš„å¤æ‚åº¦ä¸º O(n)ï¼›è€Œ `SDS`å¯¹åº”çš„ç»“æ„ä½“é‡Œç”¨ `len` å±æ€§è®°å½•äº†å­—ç¬¦ä¸²é•¿åº¦ï¼Œæ‰€ä»¥å¤æ‚åº¦ä¸º `O(1)`





> **ä»€ä¹ˆæ˜¯SDS?**

Redisæ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€ä¼ ç»Ÿçš„å­—ç¬¦ä¸²è¡¨ç¤º(ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦æ•°ç»„)ï¼Œè€Œæ˜¯ä½¿ç”¨äº†`SDS`ï¼ŒSDSçš„åº•å±‚å®ç°æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒåŒ…å«ä¸‰ä¸ªå­—æ®µï¼š

1. `len`ï¼šä¸€ä¸ªæ•´æ•°ç±»å‹çš„å­—æ®µï¼Œç”¨äº**è®°å½•SDSä¸­ä¿å­˜çš„å­—ç¬¦ä¸²çš„é•¿åº¦**ã€‚è¿™ä¸ªå­—æ®µè¡¨ç¤ºäº†SDSä¸­å®é™…ä¿å­˜çš„å­—ç¬¦æ•°é‡ï¼Œä¸åŒ…æ‹¬ç»“å°¾çš„ç©ºå­—ç¬¦'\0'ã€‚
2. `free`ï¼šä¸€ä¸ªæ•´æ•°ç±»å‹çš„å­—æ®µï¼Œè¡¨ç¤ºSDSä¸­æœªä½¿ç”¨çš„å­—èŠ‚æ•°é‡ã€‚è¿™ä¸ªå­—æ®µç”¨äºåœ¨SDSæ‰©å±•æ—¶è®°å½•å¯ç”¨çš„æœªä½¿ç”¨ç©ºé—´å¤§å°ã€‚
3. `buf`ï¼šä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œç”¨äºå­˜å‚¨å®é™…çš„å­—ç¬¦ä¸²æ•°æ®ã€‚SDSä¸­çš„å­—ç¬¦æ•°æ®å­˜å‚¨åœ¨è¿™ä¸ªç¼“å†²åŒºä¸­ã€‚

```c
struct sdshdr {
    int len;        // å­—ç¬¦ä¸²çš„å®é™…é•¿åº¦
    int free;       // æœªä½¿ç”¨çš„ç©ºé—´å¤§å°
    char buf[];     // å­—ç¬¦ä¸²æ•°æ®
};
```

SDSçš„å®ç°ä½¿ç”¨äº†Cè¯­è¨€çš„**æŸ”æ€§æ•°ç»„**ï¼ˆflexible array memberâ€”â€”å¯å˜é•¿åº¦+åŠ¨æ€å†…å­˜åˆ†é…ï¼‰ç‰¹æ€§ï¼Œ`buf`å­—æ®µå¯ä»¥åŠ¨æ€åœ°æ ¹æ®å®é™…éœ€è¦åˆ†é…å†…å­˜ç©ºé—´ã€‚è¿™ä½¿å¾—SDSå¯ä»¥æ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦**åŠ¨æ€è°ƒæ•´**è‡ªå·±çš„å¤§å°ï¼Œä»è€ŒèŠ‚çœå†…å­˜å¹¶æé«˜æ•ˆç‡ã€‚

SDSçš„åŠ¨æ€è°ƒæ•´å¤§å°æ“ä½œä¸»è¦åŒ…æ‹¬ï¼š

1. åœ¨å­—ç¬¦ä¸²é•¿åº¦å¢åŠ æ—¶ï¼ŒSDSä¼šè‡ªåŠ¨åˆ†é…æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œä»¥é€‚åº”æ–°çš„é•¿åº¦ï¼Œå¹¶æ›´æ–°`free`å­—æ®µçš„å€¼ã€‚
2. åœ¨å­—ç¬¦ä¸²é•¿åº¦å‡å°æ—¶ï¼ŒSDSä¼šè‡ªåŠ¨å›æ”¶å¤šä½™çš„å†…å­˜ç©ºé—´ï¼Œå¹¶æ›´æ–°`free`å­—æ®µçš„å€¼ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSDSå¯ä»¥çµæ´»åœ°ç®¡ç†å†…å­˜ï¼Œé¿å…äº†é¢‘ç¹çš„å†…å­˜é‡æ–°åˆ†é…æ“ä½œï¼Œæé«˜äº†æ€§èƒ½å¹¶å‡å°‘äº†å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿã€‚





>  SDSå¦‚ä½•å®ç°åŠ¨æ€æ‰©å±•ï¼Ÿ

å½“SDSéœ€è¦æ‰©å±•ï¼ˆå¢åŠ é•¿åº¦ï¼‰ä»¥å®¹çº³æ›´å¤šçš„å­—ç¬¦æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤æ¥åŠ¨æ€è°ƒæ•´å¤§å°ï¼š

1. è®¡ç®—æ–°çš„é•¿åº¦ï¼šé¦–å…ˆï¼ŒSDSä¼šæ ¹æ®éœ€è¦æ·»åŠ çš„å­—ç¬¦æ•°è®¡ç®—å‡ºæ–°çš„é•¿åº¦ã€‚æ–°çš„é•¿åº¦ç­‰äºå½“å‰å­—ç¬¦ä¸²é•¿åº¦åŠ ä¸Šè¦æ·»åŠ çš„å­—ç¬¦æ•°ã€‚
2. æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å±•ï¼šSDSä¼šæ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„æœªä½¿ç”¨ç©ºé—´ï¼ˆ`free`å­—æ®µçš„å€¼ï¼‰æ¥å®¹çº³æ–°çš„å­—ç¬¦ã€‚å¦‚æœæœ‰è¶³å¤Ÿçš„æœªä½¿ç”¨ç©ºé—´ï¼Œé‚£ä¹ˆæ— éœ€è¿›è¡Œæ‰©å±•æ“ä½œã€‚
3. æ‰©å±•å†…å­˜ï¼šå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æœªä½¿ç”¨ç©ºé—´ï¼ŒSDSå°±éœ€è¦è¿›è¡Œæ‰©å±•æ“ä½œã€‚å®ƒä¼šæ ¹æ®éœ€è¦çš„æ–°é•¿åº¦ï¼Œé‡æ–°åˆ†é…ä¸€å—æ›´å¤§çš„å†…å­˜åŒºåŸŸæ¥å®¹çº³æ–°çš„å­—ç¬¦æ•°æ®ã€‚
4. å¤åˆ¶æ•°æ®ï¼šåœ¨åˆ†é…æ–°çš„å†…å­˜åŒºåŸŸåï¼ŒSDSä¼šå°†åŸæœ‰çš„å­—ç¬¦ä¸²æ•°æ®å¤åˆ¶åˆ°æ–°çš„å†…å­˜åŒºåŸŸä¸­ã€‚
5. æ›´æ–°é•¿åº¦å’Œæœªä½¿ç”¨ç©ºé—´ï¼šå®Œæˆæ•°æ®å¤åˆ¶åï¼ŒSDSä¼šæ›´æ–°`len`å­—æ®µä¸ºæ–°çš„é•¿åº¦ï¼Œå¹¶ä¸”è®¡ç®—æ–°çš„æœªä½¿ç”¨ç©ºé—´å¤§å°ï¼Œç„¶åæ›´æ–°`free`å­—æ®µçš„å€¼ã€‚



æ¥çœ‹ä¸€ä¸ªä¾‹å­å°±çŸ¥é“äº†,é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç©ºçš„Stringç±»å‹çš„é”®ï¼Œé”®åä¸º"my_string"ï¼š

```shell
SET my_string ""
```

æ­¤æ—¶ï¼ŒRedisä¼šåˆ›å»ºä¸€ä¸ªç©ºçš„SDSå¯¹è±¡æ¥å­˜å‚¨ç©ºå­—ç¬¦ä¸²

ç„¶åï¼Œæˆ‘ä»¬å¯¹è¯¥é”®è¿›è¡Œå­—ç¬¦ä¸²çš„è¿½åŠ æ“ä½œï¼Œå‘"my_string"é”®ä¸­è¿½åŠ 10ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼š

```shell
APPEND my_string "HelloWorld!"
```

ç”±äº"my_string"é”®ä¸­å½“å‰çš„SDSå¯¹è±¡ç©ºé—´è¾ƒå°ï¼Œæ— æ³•å®¹çº³10ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥SDSä¼šè¿›è¡ŒåŠ¨æ€æ‰©å±•ã€‚å®ƒä¼šé‡æ–°åˆ†é…ä¸€ä¸ªæ›´å¤§çš„å†…å­˜ç©ºé—´ï¼Œå°†åŸæœ‰çš„æ•°æ®"Hello"å¤åˆ¶åˆ°æ–°çš„å†…å­˜åŒºåŸŸï¼Œå¹¶å°†å­—ç¬¦ä¸²"World!"è¿½åŠ åˆ°æ–°çš„å†…å­˜ç©ºé—´ä¸­ã€‚æ­¤æ—¶ï¼ŒSDSçš„ç»“æ„å¯èƒ½ç±»ä¼¼äºä¸‹é¢ï¼š

```shell
+--------+--------+----------------------------+
|  len   |  free  |          buf (æ•°æ®åŒº)       |
+--------+--------+----------------------------+
|   10   |   2    |  "Hello"World!" (æ–°æ•°æ®åŒº)  |
+--------+--------+----------------------------+
```

æ¥ç€ï¼Œæˆ‘ä»¬å†å¯¹"my_string"é”®è¿›è¡Œè®¾ç½®æ“ä½œï¼Œå°†ä¸€ä¸ªé•¿åº¦ä¸º15çš„æ–°å­—ç¬¦ä¸²èµ‹å€¼ç»™å®ƒï¼š

```shell
SET my_string "This is a new string!"
```

ç”±äºæ–°å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º15ï¼Œè¶…è¿‡äº†åŸæœ‰SDSçš„é•¿åº¦10ï¼ŒSDSéœ€è¦è¿›è¡ŒåŠ¨æ€æ‰©å±•ã€‚å®ƒä¼šé‡æ–°åˆ†é…ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å†…å­˜ç©ºé—´ï¼Œå°†æ–°å­—ç¬¦ä¸²å¤åˆ¶åˆ°æ–°çš„å†…å­˜åŒºåŸŸï¼Œå¹¶æ›´æ–°SDSçš„é•¿åº¦å’Œæœªä½¿ç”¨ç©ºé—´å­—æ®µã€‚æ­¤æ—¶ï¼ŒSDSçš„ç»“æ„å¯èƒ½ç±»ä¼¼äºä¸‹é¢ï¼š

```shell
+--------+--------+---------------------------+
|  len   |  free  |       buf (æ–°æ•°æ®åŒº)       |
+--------+--------+---------------------------+
|   21   |   5    |  "This is a new string!"  |
+--------+--------+---------------------------+
```





**åº”ç”¨åœºæ™¯:**

ï¼ˆ1ï¼‰Stringå¸¸ç”¨æ¥ç¼“å­˜å¯¹è±¡,æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š

ç›´æ¥ç¼“å­˜æ•´ä¸ªå¯¹è±¡çš„JSONï¼Œ`SET user:1 '{"name":"xiaolin", "age":18}'`

é‡‡ç”¨å°† key è¿›è¡Œåˆ†ç¦»ä¸º user:ID:å±æ€§ï¼Œé‡‡ç”¨ `MSET`(**Mutil-Set**) å­˜å‚¨ï¼Œç”¨ `MGET` è·å–å„å±æ€§å€¼ï¼Œå‘½ä»¤ä¾‹å­ï¼š `MSET user:1:name xiaolin   user:1:age 18 `

ç¤ºä¾‹ï¼šä½¿ç”¨`Redisson`æ¥ç¼“å­˜å¯¹è±¡ï¼š

```java
config.useSingleServer().setAddress("redis://localhost:6379"); 
// æ›¿æ¢æˆå®é™…çš„Redisåœ°å€å’Œç«¯å£
       RedissonClient redisson = Redisson.create(config);
        // åˆ›å»ºä¸€ä¸ªç”¨æˆ·ä¿¡æ¯å¯¹è±¡
        UserInfo user = new UserInfo();
        user.setId("1");
        user.setName("John Doe");
        user.setAge(30);

        // å°†ç”¨æˆ·ä¿¡æ¯å¯¹è±¡å­˜å‚¨åˆ°Redisç¼“å­˜ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·å¯¹è±¡å¯¹åº”ä¸€ä¸ªBucket
        RBucket<UserInfo> bucket = redisson.getBucket("user:" + user.getId());
        bucket.set(user);
        
                // ä»Redisç¼“å­˜ä¸­è·å–ç”¨æˆ·ä¿¡æ¯å¯¹è±¡
        UserInfo cachedUser = bucket.get();
        
        
        
        // å…³é—­Redissonå®¢æˆ·ç«¯
        redisson.shutdown();
```

`Redisson`ä¸­è®¾ç½®`Bucket`çš„æ–¹æ³•ï¼š

```
  @Override
    public <V> RBucket<V> getBucket(String name) {
        return new RedissonBucket<V>(connectionManager.getCommandExecutor(), name);
    }
```







ï¼ˆ2ï¼‰å¸¸è§„è®¡æ•°ï¼šå› ä¸º Redis å¤„ç†å‘½ä»¤æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥æ‰§è¡Œå‘½ä»¤çš„è¿‡ç¨‹æ˜¯åŸå­çš„ã€‚å› æ­¤ String æ•°æ®ç±»å‹é€‚åˆè®¡æ•°åœºæ™¯ï¼Œæ¯”å¦‚è®¡ç®—è®¿é—®æ¬¡æ•°ã€ç‚¹èµã€è½¬å‘ã€åº“å­˜æ•°é‡





ï¼ˆ3ï¼‰**åˆ†å¸ƒå¼é”**ï¼šSET å‘½ä»¤æœ‰ä¸ª NX å‚æ•°å¯ä»¥å®ç°ã€Œkeyä¸å­˜åœ¨æ‰æ’å…¥ã€ï¼Œå¯ä»¥ç”¨å®ƒæ¥å®ç°åˆ†å¸ƒå¼é”ï¼š

- å¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™æ˜¾ç¤ºæ’å…¥æˆåŠŸï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºåŠ é”æˆåŠŸï¼›
- å¦‚æœ key å­˜åœ¨ï¼Œåˆ™ä¼šæ˜¾ç¤ºæ’å…¥å¤±è´¥ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºåŠ é”å¤±è´¥ã€‚

ä¸€èˆ¬è€Œè¨€ï¼Œè¿˜ä¼šå¯¹åˆ†å¸ƒå¼é”åŠ ä¸Šè¿‡æœŸæ—¶é—´ï¼Œåˆ†å¸ƒå¼é”çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
SET lock_key unique_value NX PX 10000
```

- lock_key å°±æ˜¯ key é”®ï¼›
- unique_value æ˜¯å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€çš„æ ‡è¯†ï¼›
- NX ä»£è¡¨åªåœ¨ lock_key ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹ lock_key è¿›è¡Œè®¾ç½®æ“ä½œï¼›
- PX 10000 è¡¨ç¤ºè®¾ç½® lock_key çš„è¿‡æœŸæ—¶é—´ä¸º 10sï¼Œè¿™æ˜¯ä¸ºäº†é¿å…å®¢æˆ·ç«¯å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”



è€Œè§£é”çš„è¿‡ç¨‹å°±æ˜¯å°† `lock_key` é”®åˆ é™¤ï¼Œä½†ä¸èƒ½ä¹±åˆ ï¼Œè¦**ä¿è¯æ‰§è¡Œåˆ é”æ“ä½œçš„å®¢æˆ·ç«¯å°±æ˜¯åŠ é”çš„å®¢æˆ·ç«¯**ã€‚æ‰€ä»¥è§£é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦å…ˆåˆ¤æ–­é”çš„ `unique_value` æ˜¯å¦ä¸ºåŠ é”å®¢æˆ·ç«¯ï¼Œæ˜¯çš„è¯ï¼Œæ‰å°† `lock_key` é”®åˆ é™¤

å¯ä»¥çœ‹åˆ°ï¼Œè§£é”æ˜¯æœ‰ä¸¤ä¸ªæ“ä½œï¼Œè¿™æ—¶å°±éœ€è¦ **Lua è„šæœ¬**æ¥ä¿è¯è§£é”çš„åŸå­æ€§(å‚è€ƒ[Luaè„šæœ¬å®ç°åˆ†å¸ƒå¼é”](https://www.cnblogs.com/niceyoo/p/13711149.html))ï¼Œå› ä¸º Redis åœ¨æ‰§è¡Œ Lua è„šæœ¬æ—¶ï¼Œå¯ä»¥ä»¥åŸå­æ€§çš„æ–¹å¼æ‰§è¡Œï¼Œä¿è¯äº†é”é‡Šæ”¾æ“ä½œçš„åŸå­æ€§ï¼š

```lua
// é‡Šæ”¾é”æ—¶ï¼Œå…ˆæ¯”è¾ƒ unique_value æ˜¯å¦ç›¸ç­‰ï¼Œé¿å…é”çš„è¯¯é‡Šæ”¾
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end

//luaè„šæœ¬ç¤ºä¾‹
```

è¿™æ ·ä¸€æ¥ï¼Œå°±é€šè¿‡ä½¿ç”¨ SET å‘½ä»¤å’Œ Lua è„šæœ¬åœ¨ Redis å•èŠ‚ç‚¹ä¸Šå®Œæˆäº†åˆ†å¸ƒå¼é”çš„åŠ é”å’Œè§£é”



> ä¸ºä»€ä¹ˆRedisæ‰§è¡Œluaè„šæœ¬çš„æ—¶å€™å¯ä»¥ä¿è¯åŸå­æ€§ï¼Ÿ
>
>  
>
> åœ¨Redisä¸­ï¼ŒLuaè„šæœ¬èƒ½å¤Ÿä¿è¯åŸå­æ€§çš„ä¸»è¦åŸå› è¿˜æ˜¯**Redisé‡‡ç”¨äº†å•çº¿ç¨‹**æ‰§è¡Œæ¨¡å‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“Redisæ‰§è¡ŒLuaè„šæœ¬æ—¶ï¼ŒRedis**ä¼šæŠŠLuaè„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“å¹¶æŠŠå®ƒå½“ä½œä¸€ä¸ªä»»åŠ¡åŠ å…¥åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­**ï¼Œç„¶åå•çº¿ç¨‹æŒ‰ç…§é˜Ÿåˆ—çš„é¡ºåºä¾æ¬¡æ‰§è¡Œè¿™äº›ä»»åŠ¡ï¼Œ**åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­Luaè„šæœ¬æ˜¯ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æˆ–è¯·æ±‚æ‰“æ–­**ï¼Œå› æ­¤å¯ä»¥ä¿è¯æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œéƒ½æ˜¯åŸå­æ€§çš„





(4) **å…±äº« `Session` ä¿¡æ¯**: é€šå¸¸æˆ‘ä»¬åœ¨å¼€å‘åå°ç®¡ç†ç³»ç»Ÿæ—¶ï¼Œä¼šä½¿ç”¨ `Session` æ¥ä¿å­˜ç”¨æˆ·çš„ä¼šè¯(ç™»å½•)çŠ¶æ€ï¼Œè¿™äº› `Session` ä¿¡æ¯ä¼šè¢«ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ï¼Œä½†è¿™åªé€‚ç”¨äºå•ç³»ç»Ÿåº”ç”¨ï¼Œå¦‚æœæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæ­¤æ¨¡å¼å°†ä¸å†é€‚ç”¨ã€‚ä¾‹å¦‚ç”¨æˆ·ä¸€çš„ `Session` ä¿¡æ¯è¢«å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸€ï¼Œä½†ç¬¬äºŒæ¬¡è®¿é—®æ—¶ç”¨æˆ·ä¸€è¢«åˆ†é…åˆ°æœåŠ¡å™¨äºŒï¼Œè¿™ä¸ªæ—¶å€™æœåŠ¡å™¨å¹¶æ²¡æœ‰ç”¨æˆ·ä¸€çš„ `Session` ä¿¡æ¯ï¼Œå°±ä¼šå‡ºç°**éœ€è¦é‡å¤ç™»å½•**çš„é—®é¢˜ï¼Œé—®é¢˜åœ¨äºåˆ†å¸ƒå¼ç³»ç»Ÿæ¯æ¬¡ä¼šæŠŠè¯·æ±‚éšæœºåˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦**å€ŸåŠ© `Redis` å¯¹è¿™äº› `Session` ä¿¡æ¯è¿›è¡Œç»Ÿä¸€çš„å­˜å‚¨å’Œç®¡ç†ï¼Œè¿™æ ·æ— è®ºè¯·æ±‚å‘é€åˆ°é‚£å°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå»åŒä¸€ä¸ª `Redis` è·å–ç›¸å…³çš„ `Session` ä¿¡æ¯**ï¼Œè¿™æ ·å°±è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ `Session` å­˜å‚¨çš„é—®é¢˜

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/session%E5%85%B1%E4%BA%AB.png)







### List



**åº•å±‚å®ç°ï¼š**

æ—§ç‰ˆæœ¬ä¸‹ ä½¿ç”¨ `ziplist`+`linkedlist`

- å¦‚æœåˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°å°äº `512` ä¸ªï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± `list-max-ziplist-entries` é…ç½®ï¼‰ï¼Œåˆ—è¡¨æ¯ä¸ªå…ƒç´ çš„å€¼éƒ½å°äº `64` å­—èŠ‚ï¼ˆé»˜è®¤å€¼ï¼Œå¯ç”± `list-max-ziplist-value` é…ç½®ï¼‰ï¼ŒRedis ä¼šä½¿ç”¨**å‹ç¼©åˆ—è¡¨**ä½œä¸º List ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœåˆ—è¡¨çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨**åŒå‘é“¾è¡¨**ä½œä¸º List ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›

æ–°ç‰ˆæœ¬ä¸‹ **åœ¨ Redis 3.2 ç‰ˆæœ¬ä¹‹åï¼ŒList æ•°æ®ç±»å‹åº•å±‚æ•°æ®ç»“æ„å°±åªç”± `quicklist` å®ç°äº†ï¼Œæ›¿ä»£äº†åŒå‘é“¾è¡¨å’Œå‹ç¼©åˆ—è¡¨**







å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
# å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼valueæ’å…¥åˆ°keyåˆ—è¡¨çš„è¡¨å¤´(æœ€å·¦è¾¹)ï¼Œæœ€åçš„å€¼åœ¨æœ€å‰é¢
LPUSH key value [value ...] 
# å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼valueæ’å…¥åˆ°keyåˆ—è¡¨çš„è¡¨å°¾(æœ€å³è¾¹)
RPUSH key value [value ...]
# è¿”å›åˆ—è¡¨keyä¸­æŒ‡å®šåŒºé—´å†…çš„å…ƒç´ ï¼ŒåŒºé—´ä»¥åç§»é‡startå’ŒstopæŒ‡å®šï¼Œä»0å¼€å§‹
LRANGE key start stop
```



ä¾‹å¦‚æ“ä½œ`player`è¿™ä¸ª`list`:

```shell
127.0.0.1:6379> lpush player   cadian teses jabbi siush
(integer) 4
127.0.0.1:6379> rpush player stavn 
(integer) 5
```



ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/player_list.png" style="zoom: 80%;" />









**åº”ç”¨åœºæ™¯:**

ï¼ˆ1ï¼‰æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯é˜Ÿåˆ—åœ¨å­˜å–æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»è¦æ»¡è¶³ä¸‰ä¸ªéœ€æ±‚ï¼Œåˆ†åˆ«æ˜¯**æ¶ˆæ¯ä¿åºã€å¤„ç†é‡å¤çš„æ¶ˆæ¯å’Œä¿è¯æ¶ˆæ¯å¯é æ€§**ã€‚Redis çš„ List å’Œ Stream ä¸¤ç§æ•°æ®ç±»å‹ï¼Œå°±å¯ä»¥æ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„è¿™ä¸‰ä¸ªéœ€æ±‚ã€‚List å¯ä»¥ä½¿ç”¨ LPUSH + RPOP ï¼ˆæˆ–è€…åè¿‡æ¥ï¼ŒRPUSH+LPOPï¼‰å‘½ä»¤å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/list%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97.jpg)

ä¸è¿‡ï¼Œåœ¨æ¶ˆè´¹è€…è¯»å–æ•°æ®æ—¶ï¼Œæœ‰ä¸€ä¸ªæ½œåœ¨çš„æ€§èƒ½é£é™©ç‚¹ï¼š
**åœ¨ç”Ÿäº§è€…å¾€ List ä¸­å†™å…¥æ•°æ®æ—¶ï¼ŒList å¹¶ä¸ä¼šä¸»åŠ¨åœ°é€šçŸ¥æ¶ˆè´¹è€…æœ‰æ–°æ¶ˆæ¯å†™å…¥ï¼Œå¦‚æœæ¶ˆè´¹è€…æƒ³è¦åŠæ—¶å¤„ç†æ¶ˆæ¯ï¼Œå°±éœ€è¦åœ¨ç¨‹åºä¸­ä¸åœåœ°è°ƒç”¨ `RPOP` å‘½ä»¤**ï¼ˆæ¯”å¦‚ä½¿ç”¨ä¸€ä¸ªwhile(1)å¾ªç¯ï¼‰ã€‚å¦‚æœæœ‰æ–°æ¶ˆæ¯å†™å…¥ï¼ŒRPOPå‘½ä»¤å°±ä¼šè¿”å›ç»“æœï¼Œå¦åˆ™ï¼ŒRPOPå‘½ä»¤è¿”å›ç©ºå€¼ï¼Œå†ç»§ç»­å¾ªç¯ã€‚æ‰€ä»¥ï¼Œå³ä½¿æ²¡æœ‰æ–°æ¶ˆæ¯å†™å…¥Listï¼Œæ¶ˆè´¹è€…ä¹Ÿè¦ä¸åœåœ°è°ƒç”¨ RPOP å‘½ä»¤ï¼Œè¿™å°±ä¼šå¯¼è‡´æ¶ˆè´¹è€…ç¨‹åºçš„ CPU ä¸€ç›´æ¶ˆè€—åœ¨æ‰§è¡Œ RPOP å‘½ä»¤ä¸Šï¼Œå¸¦æ¥ä¸å¿…è¦çš„æ€§èƒ½æŸå¤±ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisæä¾›äº† BRPOP(`Blocking Right Pop`) å‘½ä»¤ã€‚**BRPOPå‘½ä»¤ä¹Ÿç§°ä¸ºé˜»å¡å¼è¯»å–(é˜»å¡å¸‚ç­‰å¾…æœŸé—´çº¿ç¨‹ä¸æ¶ˆè€—CPUèµ„æºçš„)ï¼Œå®¢æˆ·ç«¯åœ¨æ²¡æœ‰è¯»åˆ°é˜Ÿåˆ—æ•°æ®æ—¶ï¼Œè‡ªåŠ¨é˜»å¡ï¼Œç›´åˆ°æœ‰æ–°çš„æ•°æ®å†™å…¥é˜Ÿåˆ—ï¼Œå†å¼€å§‹è¯»å–æ–°æ•°æ®**ã€‚å’Œæ¶ˆè´¹è€…ç¨‹åºè‡ªå·±ä¸åœåœ°è°ƒç”¨RPOPå‘½ä»¤ç›¸æ¯”ï¼Œè¿™ç§æ–¹å¼èƒ½èŠ‚çœCPUå¼€é”€

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/BRpop%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97.jpg)

åŒæ—¶æ¶ˆè´¹è€…è¦å®ç°é‡å¤æ¶ˆæ¯çš„åˆ¤æ–­ï¼Œè¿™éœ€è¦2ä¸ªæ–¹é¢çš„è¦æ±‚ï¼š

- æ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªå…¨å±€çš„ ID
- æ¶ˆè´¹è€…è¦è®°å½•å·²ç»å¤„ç†è¿‡çš„æ¶ˆæ¯çš„ IDã€‚å½“æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯åï¼Œæ¶ˆè´¹è€…ç¨‹åºå°±å¯ä»¥å¯¹æ¯”æ”¶åˆ°çš„æ¶ˆæ¯ ID å’Œè®°å½•çš„å·²å¤„ç†è¿‡çš„æ¶ˆæ¯ IDï¼Œæ¥åˆ¤æ–­å½“å‰æ”¶åˆ°çš„æ¶ˆæ¯æœ‰æ²¡æœ‰ç»è¿‡å¤„ç†ã€‚å¦‚æœå·²ç»å¤„ç†è¿‡ï¼Œé‚£ä¹ˆï¼Œæ¶ˆè´¹è€…ç¨‹åºå°±ä¸å†è¿›è¡Œå¤„ç†äº†

ä½†æ˜¯ **List å¹¶ä¸ä¼šä¸ºæ¯ä¸ªæ¶ˆæ¯ç”Ÿæˆ ID å·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªè¡Œä¸ºæ¯ä¸ªæ¶ˆæ¯ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€ID**ï¼Œç”Ÿæˆä¹‹åï¼Œæˆ‘ä»¬åœ¨ç”¨ LPUSH å‘½ä»¤æŠŠæ¶ˆæ¯æ’å…¥ List æ—¶ï¼Œéœ€è¦åœ¨æ¶ˆæ¯ä¸­åŒ…å«è¿™ä¸ªå…¨å±€å”¯ä¸€ IDã€‚ä¾‹å¦‚ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±æŠŠä¸€æ¡å…¨å±€ ID ä¸º 111000102ã€åº“å­˜é‡ä¸º 99 çš„æ¶ˆæ¯æ’å…¥äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼š

```shell
> LPUSH mq "111000102:stock:99"
(integer) 1
```

åŸºäº List ç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰å¤§éœ€æ±‚ï¼ˆæ¶ˆæ¯ä¿åºã€å¤„ç†é‡å¤çš„æ¶ˆæ¯å’Œä¿è¯æ¶ˆæ¯å¯é æ€§ï¼‰

- æ¶ˆæ¯ä¿åºï¼šä½¿ç”¨ LPUSH + RPOPï¼›
- é˜»å¡è¯»å–ï¼šä½¿ç”¨ BRPOPï¼›
- é‡å¤æ¶ˆæ¯å¤„ç†ï¼šç”Ÿäº§è€…è‡ªè¡Œå®ç°å…¨å±€å”¯ä¸€ IDï¼›
- æ¶ˆæ¯çš„å¯é æ€§ï¼šä½¿ç”¨ BRPOPã€LPUSH







> List ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿ

**List ä¸æ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯**ï¼Œå› ä¸ºä¸€æ—¦æ¶ˆè´¹è€…æ‹‰å–ä¸€æ¡æ¶ˆæ¯åï¼Œè¿™æ¡æ¶ˆæ¯å°±ä» List ä¸­åˆ é™¤äº†ï¼Œæ— æ³•è¢«å…¶å®ƒæ¶ˆè´¹è€…å†æ¬¡æ¶ˆè´¹ã€‚è¦å®ç°ä¸€æ¡æ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œé‚£ä¹ˆå°±è¦å°†å¤šä¸ªæ¶ˆè´¹è€…ç»„æˆä¸€ä¸ªæ¶ˆè´¹ç»„ï¼Œä½¿å¾—å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯(è®©ä¸€æ¡æ¶ˆæ¯è½¬å‘è‡³å¯¹åº”çš„ç»„å†…ï¼Œç»„å†…æ‰€æœ‰æˆå‘˜éƒ½å¯ä»¥æ”¶åˆ°æ¶ˆæ¯)ï¼Œä½†æ˜¯ **List ç±»å‹å¹¶ä¸æ”¯æŒæ¶ˆè´¹ç»„çš„å®ç°**(å®é™…ä¸Šæ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼)ã€‚



 Redis ä» 5.0 ç‰ˆæœ¬å¼€å§‹æä¾›çš„ Stream æ•°æ®ç±»å‹äº†ï¼ŒStream åŒæ ·èƒ½å¤Ÿæ»¡è¶³æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰å¤§éœ€æ±‚ï¼Œè€Œä¸”å®ƒè¿˜æ”¯æŒã€Œæ¶ˆè´¹ç»„ã€å½¢å¼çš„æ¶ˆæ¯è¯»å–ã€‚

### Hash

Hash æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey - valueï¼‰é›†åˆï¼Œå…¶ä¸­ value çš„å½¢å¼å¦‚ï¼š `value=[{field1ï¼Œvalue1}ï¼Œ...{fieldNï¼ŒvalueN}]`ã€‚Hash ç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡,Hash ä¸ String å¯¹è±¡çš„åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤º:![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/hash-string-difference.jpg)


å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
SET user '{"name":"harrykane", "age":29}'   #Stringç±»å‹ Jsonå­˜å‚¨Userå¯¹è±¡

HMSET user1   name harrykane age 30            #Hashå­˜å‚¨Playerå¯¹è±¡,keyä¸ºå®ä½“ç±»åï¼Œfield-valueä¸ºé”®å€¼å¯¹

### å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°†ç”¨æˆ·å¯¹è±¡çš„ä¿¡æ¯å­˜å‚¨åˆ° Hash ç±»å‹
HMSET uid:1 name Tom age 15
HMSET uid:2 name Jerry age 13
HMSET uid:3 name David age 20

#è·å–uidä¸º1å¯¹è±¡æ“ä½œå¦‚ä¸‹ï¼š
HGETALL  uid:1
1) "name"
2) "Tom"
3) "age"
4) "15"
```

ä¸Šé¢ä»‹ç»åˆ°String + Jsonä¹Ÿæ˜¯å­˜å‚¨å¯¹è±¡çš„ä¸€ç§æ–¹å¼ï¼Œé‚£ä¹ˆå­˜å‚¨å¯¹è±¡æ—¶ï¼Œé‚£ä¹ˆåˆ°åº•ç”¨ String + json è¿˜æ˜¯ç”¨ Hash å‘¢ï¼Ÿå®é™…ä¸Šä¸€èˆ¬å¯¹è±¡ç”¨String + Json å­˜å‚¨ï¼Œå¯¹è±¡ä¸­æŸäº›é¢‘ç¹å˜åŒ–çš„å±æ€§å¯ä»¥è€ƒè™‘æŠ½å‡ºæ¥ç”¨ Hash ç±»å‹å­˜å‚¨(å› ä¸ºStringç”¨çš„SDSåŠ¨æ€å­—ç¬¦ä¸²)



### Set&Zset

Set ç±»å‹æ˜¯ä¸€ä¸ªæ— åºå¹¶å”¯ä¸€çš„é”®å€¼é›†åˆï¼Œå®ƒçš„å­˜å‚¨é¡ºåºä¸ä¼šæŒ‰ç…§æ’å…¥çš„å…ˆåé¡ºåºè¿›è¡Œå­˜å‚¨,Set ç±»å‹å’Œ List ç±»å‹çš„åŒºåˆ«å¦‚ä¸‹ï¼š

- List å¯ä»¥å­˜å‚¨é‡å¤å…ƒç´ ï¼Œ**Set åªèƒ½å­˜å‚¨éé‡å¤å…ƒç´ **ï¼›
- List æ˜¯æŒ‰ç…§å…ƒç´ çš„å…ˆåé¡ºåºå­˜å‚¨å…ƒç´ çš„ï¼Œè€Œ Set åˆ™æ˜¯æ— åºæ–¹å¼å­˜å‚¨å…ƒç´ çš„



å†…éƒ¨å®ç°ï¼š

Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±**å“ˆå¸Œè¡¨æˆ–æ•´æ•°é›†åˆ**å®ç°çš„ï¼š

- å¦‚æœé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äº `512` ï¼ˆé»˜è®¤å€¼ï¼Œ`set-maxintset-entries`é…ç½®ï¼‰ä¸ªï¼ŒRedis ä¼šä½¿ç”¨**æ•´æ•°é›†åˆ**ä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœé›†åˆä¸­çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼Œåˆ™ Redis ä½¿ç”¨**å“ˆå¸Œè¡¨**ä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„





Set ç±»å‹æ¯”è¾ƒé€‚åˆç”¨æ¥æ•°æ®å»é‡å’Œä¿éšœæ•°æ®çš„å”¯ä¸€æ€§,ä¾‹å¦‚ç‚¹èµ,Set ç±»å‹å¯ä»¥ä¿è¯ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹ä¸€ä¸ªèµï¼›Set ç±»å‹åŒæ—¶æ”¯æŒäº¤é›†è¿ç®—ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥è®¡ç®—å…±åŒå…³æ³¨çš„å¥½å‹ã€å…¬ä¼—å·ç­‰



1.è®¡ç®—ç‚¹èµé‡

Set ç±»å‹å¯ä»¥ä¿è¯ä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹ä¸€ä¸ªèµï¼Œè¿™é‡Œä¸¾ä¾‹å­ä¸€ä¸ªåœºæ™¯ï¼Œkey æ˜¯æ–‡ç« idï¼Œvalue æ˜¯ç”¨æˆ·id,

- æŸ¥çœ‹æ–‡ç« article2æœ‰å“ªäº›ç”¨æˆ·ç‚¹èµäº†(æ¯ä¸ªç”¨æˆ·åªèƒ½ç‚¹ä¸€æ¬¡èµ)ï¼š

```shell
127.0.0.1:6379> SADD article2 user1 user2 user3 user4
(integer) 4
```

- æŸ¥çœ‹å“ªäº›ç”¨æˆ·ç»™article2å’Œarticle1å‡ç‚¹äº†èµ(è®¡ç®—äº¤é›†)ï¼š

```shell
127.0.0.1:6379> SINTER article2  article1 
1) "user3"
2) "user2"
3) "user1"
```







`Zset` ç±»å‹ï¼ˆä¹Ÿç§°`SortedSet`ï¼‰ç›¸æ¯”äº Set ç±»å‹å¤šäº†ä¸€ä¸ªæ’åºå±æ€§ scoreï¼ˆåˆ†å€¼ï¼‰ï¼Œå¯¹äºæœ‰åºé›†åˆ `Zset` æ¥è¯´ï¼Œæ¯ä¸ªå­˜å‚¨å…ƒç´ ç›¸å½“äºæœ‰ä¸¤ä¸ªå€¼ç»„æˆçš„ï¼Œä¸€ä¸ªæ˜¯æœ‰åºé›†åˆçš„å…ƒç´ å€¼ï¼Œä¸€ä¸ªæ˜¯æ’åºå€¼ã€‚æœ‰åºé›†åˆä¿ç•™äº†é›†åˆä¸èƒ½æœ‰é‡å¤æˆå‘˜çš„ç‰¹æ€§ï¼ˆåˆ†å€¼å¯ä»¥é‡å¤ï¼‰ï¼Œä½†ä¸åŒçš„æ˜¯**æœ‰åºé›†åˆä¸­çš„å…ƒç´ å¯ä»¥æ’åº**:

![Zset](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/zset.jpg)



å†…éƒ¨å®ç°ï¼š

`Zset` ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±**å‹ç¼©åˆ—è¡¨æˆ–è·³è¡¨**å®ç°çš„ï¼š

- å¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº `128` ä¸ªï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äº `64` å­—èŠ‚æ—¶ï¼ŒRedis ä¼šä½¿ç”¨**å‹ç¼©åˆ—è¡¨**ä½œä¸º Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›
- å¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨**è·³è¡¨**ä½œä¸º Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›



Zset ç±»å‹ï¼ˆSorted Setï¼Œæœ‰åºé›†åˆï¼‰ å¯ä»¥**æ ¹æ®å…ƒç´ çš„æƒé‡**æ¥æ’åºï¼Œå¯ä»¥è‡ªå·±æ¥å†³å®šæ¯ä¸ªå…ƒç´ çš„æƒé‡å€¼ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…ƒç´ æ’å…¥ Sorted Set çš„æ—¶é—´ç¡®å®šæƒé‡å€¼ï¼Œå…ˆæ’å…¥çš„å…ƒç´ æƒé‡å°ï¼Œåæ’å…¥çš„å…ƒç´ æƒé‡å¤§,åœ¨é¢å¯¹éœ€è¦å±•ç¤ºæœ€æ–°åˆ—è¡¨ã€æ’è¡Œæ¦œç­‰åœºæ™¯æ—¶ï¼Œå¦‚æœæ•°æ®æ›´æ–°é¢‘ç¹æˆ–è€…éœ€è¦åˆ†é¡µæ˜¾ç¤ºï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨ Sorted Set,æœ‰åºé›†åˆæ¯”è¾ƒå…¸å‹çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯æ’è¡Œæ¦œã€‚ä¾‹å¦‚å­¦ç”Ÿæˆç»©çš„æ’åæ¦œã€æ¸¸æˆç§¯åˆ†æ’è¡Œæ¦œã€è§†é¢‘æ’­æ”¾æ’åã€ç”µå•†ç³»ç»Ÿä¸­å•†å“çš„é”€é‡æ’åç­‰ã€‚

ä»¥åšæ–‡ç‚¹èµæ’åä¸ºä¾‹ï¼Œå°æ—å‘è¡¨äº†äº”ç¯‡åšæ–‡ï¼Œåˆ†åˆ«è·å¾—èµä¸º 200ã€40ã€100ã€50ã€150

```shell
# å¾€æœ‰åºé›†åˆkeyä¸­åŠ å…¥å¸¦åˆ†å€¼å…ƒç´ 
ZADD key score member [[score member]...] 

# arcticle:1 æ–‡ç« è·å¾—äº†200ä¸ªèµ
> ZADD user:xiaolin:ranking 200 arcticle:1
(integer) 1
# arcticle:2 æ–‡ç« è·å¾—äº†40ä¸ªèµ
> ZADD user:xiaolin:ranking 40 arcticle:2
(integer) 1
# arcticle:3 æ–‡ç« è·å¾—äº†100ä¸ªèµ
> ZADD user:xiaolin:ranking 100 arcticle:3
(integer) 1
# arcticle:4 æ–‡ç« è·å¾—äº†50ä¸ªèµ
> ZADD user:xiaolin:ranking 50 arcticle:4
(integer) 1
# arcticle:5 æ–‡ç« è·å¾—äº†150ä¸ªèµ
> ZADD user:xiaolin:ranking 150 arcticle:5
(integer) 1
```

è·å–å°æ—æ–‡ç« èµæ•°æœ€å¤šçš„ 3 ç¯‡æ–‡ç« ï¼Œå¯ä»¥ä½¿ç”¨ ZREVRANGE å‘½ä»¤ï¼ˆå€’åºè·å–æœ‰åºé›†åˆ key ä»startä¸‹æ ‡åˆ°stopä¸‹æ ‡çš„å…ƒç´ ï¼‰ï¼š

```shell
# WITHSCORES è¡¨ç¤ºæŠŠ score ä¹Ÿæ˜¾ç¤ºå‡ºæ¥
> ZREVRANGE user:xiaolin:ranking 0 2 WITHSCORES
1) "arcticle:1"
2) "200"
3) "arcticle:5"
4) "150"
5) "arcticle:3"
6) "100"
```



æ¯”å¦‚ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªå­¦ç”Ÿçš„æˆç»©æ’åï¼š

```shell
127.0.0.1:6379> ZADD  kane 155 course1 165 course2  250 course3 55 course4 100 course5
(integer) 5

#è·å–è¯¥å­¦ç”Ÿæˆç»©æœ€é«˜çš„ä¸‰é—¨è¯¾
127.0.0.1:6379> zrevrange kane 0 2 withscores
1) "course3"
2) "250"
3) "course2"
4) "165"
5) "course1"
6) "155"
```





### BitMap

ä½å›¾ï¼Œæ˜¯ä¸€ä¸²è¿ç»­çš„äºŒè¿›åˆ¶æ•°ç»„ï¼ˆ0å’Œ1ï¼‰ï¼Œå¯ä»¥é€šè¿‡åç§»é‡ï¼ˆoffsetï¼‰å®šä½å…ƒç´ ã€‚`BitMap`é€šè¿‡æœ€å°çš„å•ä½bitæ¥è¿›è¡Œ`0|1`çš„è®¾ç½®ï¼Œè¡¨ç¤ºæŸä¸ªå…ƒç´ çš„å€¼æˆ–è€…çŠ¶æ€ï¼Œ`BitMap`ç‰¹åˆ«é€‚åˆä¸€äº›æ•°æ®é‡å¤§ä¸”ä½¿ç”¨**äºŒå€¼ç»Ÿè®¡çš„åœºæ™¯**



**å†…éƒ¨å®ç°ï¼š**

Bitmap æœ¬èº«æ˜¯ç”¨ String ç±»å‹ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„å®ç°çš„ä¸€ç§ç»Ÿè®¡äºŒå€¼çŠ¶æ€çš„æ•°æ®ç±»å‹

String ç±»å‹æ˜¯ä¼šä¿å­˜ä¸ºäºŒè¿›åˆ¶çš„å­—èŠ‚æ•°ç»„ï¼Œæ‰€ä»¥ï¼ŒRedis å°±æŠŠå­—èŠ‚æ•°ç»„çš„æ¯ä¸ª bit ä½åˆ©ç”¨èµ·æ¥ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå…ƒç´ çš„äºŒå€¼çŠ¶æ€ï¼Œä½ å¯ä»¥æŠŠ Bitmap çœ‹ä½œæ˜¯ä¸€ä¸ª bit æ•°ç»„



**åº”ç”¨åœºæ™¯ï¼š**

1. ç”¨æˆ·åœ¨çº¿çŠ¶æ€ï¼šå¯ä»¥ä½¿ç”¨Bitmapæ¥è·Ÿè¸ªç”¨æˆ·çš„åœ¨çº¿çŠ¶æ€ã€‚æ¯ä¸ªä½ä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·åœ¨çº¿åˆ™è®¾ç½®ä¸º1ï¼Œç¦»çº¿åˆ™è®¾ç½®ä¸º0
2. å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰ï¼šBitmapæ˜¯**å¸ƒéš†è¿‡æ»¤å™¨**çš„åŸºæœ¬å®ç°ä¹‹ä¸€ã€‚å¯ä»¥**ä½¿ç”¨Bitmapæ¥å¿«é€Ÿåˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œè™½ç„¶æœ‰ä¸€å®šçš„è¯¯åˆ¤ç‡**ï¼Œä½†æ˜¯åœ¨å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶ï¼Œæ€§èƒ½éå¸¸é«˜æ•ˆ





æ¥çœ‹å‡ ä¸ªä¾‹å­å§ï¼š

(1) åœ¨ç­¾åˆ°æ‰“å¡çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬åªç”¨è®°å½•ç­¾åˆ°ï¼ˆ1ï¼‰æˆ–æœªç­¾åˆ°ï¼ˆ0ï¼‰ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯éå¸¸å…¸å‹çš„äºŒå€¼çŠ¶æ€ã€‚ç­¾åˆ°ç»Ÿè®¡æ—¶ï¼Œæ¯ä¸ªç”¨æˆ·ä¸€å¤©çš„ç­¾åˆ°ç”¨ 1 ä¸ª bit ä½å°±èƒ½è¡¨ç¤ºï¼Œä¸€ä¸ªæœˆï¼ˆå‡è®¾æ˜¯ 31 å¤©ï¼‰çš„ç­¾åˆ°æƒ…å†µç”¨ 31 ä¸ª bit ä½å°±å¯ä»¥ï¼Œè€Œä¸€å¹´çš„ç­¾åˆ°ä¹Ÿåªéœ€è¦ç”¨ 365 ä¸ª bit ä½ï¼Œæ ¹æœ¬ä¸ç”¨å¤ªå¤æ‚çš„é›†åˆç±»å‹ã€‚å‡è®¾æˆ‘ä»¬è¦ç»Ÿè®¡idä¸º100çš„ç”¨æˆ·åœ¨2023å¹´6æœˆçš„ç­¾åˆ°æƒ…å†µï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢æ­¥éª¤æ¥è¿›è¡Œï¼š

```shell
# ç”¨æˆ·IDä¸º1001ï¼Œåœ¨1æœˆ1æ—¥ã€1æœˆ5æ—¥å’Œ1æœˆ20æ—¥ç­¾åˆ°
SETBIT user_signins:1001 1 1
SETBIT user_signins:1001 5 1
SETBIT user_signins:1001 20 1

```

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/bitmap.png" style="zoom:67%;" />

å¯ä»¥çœ‹åˆ°ç¬¬1ä½ã€ç¬¬5ä½ã€ç¬¬20ä½å·²ç»è¢«ç½®ä¸º1äº†





(2)åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨çº¿



å‡å¦‚æˆ‘ä»¬è¦åˆ¤æ–­ ID = 10086 çš„ç”¨æˆ·çš„ç™»é™†æƒ…å†µï¼š

ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œè¡¨ç¤ºç”¨æˆ·å·²ç™»å½•

```shell
SETBIT login_status 10086 1
```

ç¬¬äºŒæ­¥ï¼Œæ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦ç™»é™†ï¼Œè¿”å›å€¼ 1 è¡¨ç¤ºå·²ç™»å½•

```shell
GETBIT login_status 10086
```

ç¬¬ä¸‰æ­¥ï¼Œç™»å‡ºï¼Œå°† offset å¯¹åº”çš„ value è®¾ç½®æˆ 0

```shell
SETBIT login_status 10086 0
```







### Stream

Redis Stream æ˜¯ Redis 5.0 ç‰ˆæœ¬æ–°å¢åŠ çš„æ•°æ®ç±»å‹ï¼ŒRedis ä¸“é—¨ä¸ºæ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡çš„æ•°æ®ç±»å‹ã€‚

åœ¨ Redis 5.0 Stream æ²¡å‡ºæ¥ä¹‹å‰ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°æ–¹å¼éƒ½æœ‰ç€å„è‡ªçš„ç¼ºé™·ï¼Œä¾‹å¦‚ï¼š

- å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œä¸èƒ½æŒä¹…åŒ–ä¹Ÿå°±æ— æ³•å¯é çš„ä¿å­˜æ¶ˆæ¯ï¼Œå¹¶ä¸”å¯¹äºç¦»çº¿é‡è¿çš„å®¢æˆ·ç«¯ä¸èƒ½è¯»å–å†å²æ¶ˆæ¯çš„ç¼ºé™·ï¼›
- List å®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼ä¸èƒ½é‡å¤æ¶ˆè´¹ï¼Œä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹å®Œå°±ä¼šè¢«åˆ é™¤ï¼Œè€Œä¸”**ç”Ÿäº§è€…éœ€è¦è‡ªè¡Œå®ç°å…¨å±€å”¯ä¸€ ID**ã€‚

åŸºäºä»¥ä¸Šé—®é¢˜ï¼ŒRedis 5.0 ä¾¿æ¨å‡ºäº† Stream ç±»å‹ä¹Ÿæ˜¯æ­¤ç‰ˆæœ¬æœ€é‡è¦çš„åŠŸèƒ½ï¼Œç”¨äºå®Œç¾åœ°å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒæ”¯æŒæ¶ˆæ¯çš„æŒä¹…åŒ–ã€æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDã€æ”¯æŒ ack ç¡®è®¤æ¶ˆæ¯çš„æ¨¡å¼ã€æ”¯æŒæ¶ˆè´¹ç»„æ¨¡å¼ç­‰ï¼Œè®©æ¶ˆæ¯é˜Ÿåˆ—æ›´åŠ çš„ç¨³å®šå’Œå¯é 





#### æ¶ˆæ¯é˜Ÿåˆ—

Stream å¯ä»¥ä½¿ç”¨ **`XGROUP` åˆ›å»ºæ¶ˆè´¹ç»„**ï¼Œåˆ›å»ºæ¶ˆè´¹ç»„ä¹‹åï¼ŒStream å¯ä»¥ä½¿ç”¨ `XREADGROUP` å‘½ä»¤è®©æ¶ˆè´¹ç»„å†…çš„æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯,åˆ›å»ºä¸¤ä¸ªæ¶ˆè´¹ç»„ï¼Œè¿™ä¸¤ä¸ªæ¶ˆè´¹ç»„æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ `mymq`ï¼Œéƒ½æŒ‡å®šä»ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ï¼š

```shell
# åˆ›å»ºä¸€ä¸ªåä¸º group1 çš„æ¶ˆè´¹ç»„ï¼Œ0-0 è¡¨ç¤ºä»ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ã€‚
> XGROUP CREATE mymq group1 0-0
OK
# åˆ›å»ºä¸€ä¸ªåä¸º group2 çš„æ¶ˆè´¹ç»„ï¼Œ0-0 è¡¨ç¤ºä»ç¬¬ä¸€æ¡æ¶ˆæ¯å¼€å§‹è¯»å–ã€‚
> XGROUP CREATE mymq group2 0-0
OK
```

æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„**æŸä¸€æ¡æ¶ˆæ¯**ä¸€æ—¦è¢«æ¶ˆè´¹ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–äº†ï¼Œå°±ä¸èƒ½å†è¢«è¯¥æ¶ˆè´¹ç»„å†…çš„å…¶ä»–æ¶ˆè´¹è€…è¯»å–äº†ï¼Œå³åŒä¸€ä¸ªæ¶ˆè´¹ç»„é‡Œçš„æ¶ˆè´¹è€…ä¸èƒ½æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯ï¼Œ**ä¸åŒæ¶ˆè´¹ç»„çš„æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯ï¼ˆä½†æ˜¯æœ‰å‰ææ¡ä»¶ï¼Œåˆ›å»ºæ¶ˆæ¯ç»„çš„æ—¶å€™ï¼Œä¸åŒæ¶ˆè´¹ç»„æŒ‡å®šäº†ç›¸åŒä½ç½®å¼€å§‹è¯»å–æ¶ˆæ¯**:

```shell
127.0.0.1:6379> xadd  mymq *  name xiaolin
"1679378689141-0"
127.0.0.1:6379> XGROUP CREATE mymq group1 0-0
OK
127.0.0.1:6379>  XGROUP CREATE mymq group2 0-0
OK
127.0.0.1:6379> XREADGROUP GROUP group1 consumer1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378689141-0"
         2) 1) "name"
            2) "xiaolin"
127.0.0.1:6379> XREADGROUP GROUP group1 consumer1 STREAMS mymq >
(nil)
127.0.0.1:6379> XREADGROUP GROUP group1 consumer2 STREAMS mymq >
(nil)
127.0.0.1:6379> XREADGROUP GROUP group2 consumer1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378689141-0"
         2) 1) "name"
            2) "xiaolin"

```

ä½¿ç”¨æ¶ˆè´¹ç»„çš„ç›®çš„æ˜¯è®©ç»„å†…çš„å¤šä¸ªæ¶ˆè´¹è€…å…±åŒåˆ†æ‹…è¯»å–æ¶ˆæ¯ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè®©æ¯ä¸ªæ¶ˆè´¹è€…è¯»å–éƒ¨åˆ†æ¶ˆæ¯ï¼Œä»è€Œå®ç°æ¶ˆæ¯è¯»å–è´Ÿè½½åœ¨å¤šä¸ªæ¶ˆè´¹è€…é—´æ˜¯å‡è¡¡åˆ†å¸ƒçš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
##å†æ¬¡æ·»åŠ å››æ¡æ¶ˆæ¯ï¼Œè¿™æ ·mymqä¸­ä¸€å…±æœ‰5æ¡æ¶ˆæ¯

127.0.0.1:6379> XADD mymq *  player kane
"1679378913264-0"
127.0.0.1:6379> XADD mymq *  age 30
"1679378922998-0"
127.0.0.1:6379> XADD mymq *  club  spurs
"1679378928773-0"
127.0.0.1:6379> XADD mymq *  number   9
"1679378936160-0"

##è®¾ç½®ä¸‰ä¸ªæ¶ˆè´¹è€…ç»„ï¼Œè§‚å¯Ÿå…¶è¯»å–æ¶ˆæ¯çš„æƒ…å†µï¼š

127.0.0.1:6379>  XREADGROUP GROUP group2 consumer1 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378913264-0"
         2) 1) "player"
            2) "kane"
127.0.0.1:6379>  XREADGROUP GROUP group1 consumer1 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378913264-0"
         2) 1) "player"
            2) "kane"
127.0.0.1:6379>  XREADGROUP GROUP group3 consumer1 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378689141-0"
         2) 1) "name"
            2) "xiaolin"
127.0.0.1:6379>  XREADGROUP GROUP group3 consumer2 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378913264-0"
         2) 1) "player"
            2) "kane"
127.0.0.1:6379>  XREADGROUP GROUP group3 consumer3 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378922998-0"
         2) 1) "age"
            2) "30"
127.0.0.1:6379>  XREADGROUP GROUP group3 consumer4 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378928773-0"
         2) 1) "club"
            2) "spurs"
127.0.0.1:6379>  XREADGROUP GROUP group3 consumer5 COUNT 1 STREAMS mymq >
1) 1) "mymq"
   2) 1) 1) "1679378936160-0"
         2) 1) "number"
            2) "9"
127.0.0.1:6379>  XREADGROUP GROUP group3 consumer6 COUNT 1 STREAMS mymq >
(nil)
127.0.0.1:6379> 

```

å†æ¬¡éªŒè¯äº†åŒä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…consumeræ‰€è¯»å–ï¼Œä½†æ˜¯å¯ä»¥è¢«ä¸åŒæ¶ˆè´¹è€…ç»„çš„å¤šä¸ªæ¶ˆè´¹è€…æ‰€è¯»å–ï¼Œå¹¶ä¸”ï¼Œä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…ç»„é‡Œçš„æ‰€æœ‰æ¶ˆè´¹è€…å‡åŒ€åˆ†é…ï¼ˆç»„å†…çš„å¤šä¸ªæ¶ˆè´¹è€…å…±åŒåˆ†æ‹…è¯»å–æ¶ˆæ¯ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè®©æ¯ä¸ªæ¶ˆè´¹è€…è¯»å–éƒ¨åˆ†æ¶ˆæ¯ï¼Œä»è€Œå®ç°æ¶ˆæ¯è¯»å–è´Ÿè½½åœ¨å¤šä¸ªæ¶ˆè´¹è€…é—´æ˜¯å‡è¡¡åˆ†å¸ƒçš„ï¼‰

> åŸºäº Stream å®ç°çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚ä½•ä¿è¯æ¶ˆè´¹è€…åœ¨å‘ç”Ÿæ•…éšœæˆ–å®•æœºå†æ¬¡é‡å¯åï¼Œä»ç„¶å¯ä»¥è¯»å–æœªå¤„ç†å®Œçš„æ¶ˆæ¯ï¼Ÿ

Streams ä¼šè‡ªåŠ¨ä½¿ç”¨å†…éƒ¨é˜Ÿåˆ—ï¼ˆä¹Ÿç§°ä¸º `PENDING List`ï¼‰ç•™å­˜æ¶ˆè´¹ç»„é‡Œæ¯ä¸ªæ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯ï¼Œç›´åˆ°æ¶ˆè´¹è€…ä½¿ç”¨ `XACK` å‘½ä»¤é€šçŸ¥ Streamâ€œæ¶ˆæ¯å·²ç»å¤„ç†å®Œæˆâ€ã€‚**æ¶ˆæ¯ç¡®è®¤**å¢åŠ äº†æ¶ˆæ¯çš„å¯é æ€§ï¼Œä¸€èˆ¬åœ¨ä¸šåŠ¡å¤„ç†å®Œæˆä¹‹åï¼Œéœ€è¦æ‰§è¡Œ `XACK `ç¡®è®¤æ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹å®Œæˆ

![Stream-Ack](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4.jpg)

å¦‚æœæ¶ˆè´¹è€…æ²¡æœ‰æˆåŠŸå¤„ç†æ¶ˆæ¯ï¼Œå®ƒå°±ä¸ä¼šç»™ `Streams` å‘é€ `XACK` å‘½ä»¤ï¼Œæ¶ˆæ¯ä»ç„¶ä¼šç•™å­˜ã€‚æ­¤æ—¶ï¼Œ**æ¶ˆè´¹è€…å¯ä»¥åœ¨é‡å¯åï¼Œç”¨ `XPENDING` å‘½ä»¤æŸ¥çœ‹å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤å¤„ç†å®Œæˆçš„æ¶ˆæ¯**ï¼ŒæŸ¥çœ‹ `group2` ä¸­å„ä¸ªæ¶ˆè´¹è€…**å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤**çš„æ¶ˆæ¯ä¸ªæ•°å‘½ä»¤å¦‚ä¸‹ï¼š

```shell
127.0.0.1:6379> XPENDING mymq group2
1) (integer) 3
2) "1654254953808-0"  # è¡¨ç¤º group2 ä¸­æ‰€æœ‰æ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯æœ€å° ID
3) "1654256271337-0"  # è¡¨ç¤º group2 ä¸­æ‰€æœ‰æ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯æœ€å¤§ ID
4) 1) 1) "consumer1"
      2) "1"
   2) 1) "consumer2"
      2) "1"
   3) 1) "consumer3"
      2) "1"
```





> Redis åŸºäº Stream æ¶ˆæ¯é˜Ÿåˆ—ä¸ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›å·®è·ï¼Ÿ

1. Redis Stream æ¶ˆæ¯ä¼šä¸¢å¤±å—

- Redis ç”Ÿäº§è€…ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Ÿç”Ÿäº§è€…ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Œå–å†³äºç”Ÿäº§è€…å¯¹äºå¼‚å¸¸æƒ…å†µçš„å¤„ç†æ˜¯å¦åˆç†ã€‚ **ä»æ¶ˆæ¯è¢«ç”Ÿäº§å‡ºæ¥ï¼Œç„¶åæäº¤ç»™ MQ çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦èƒ½æ­£å¸¸æ”¶åˆ° ï¼ˆ MQ ä¸­é—´ä»¶ï¼‰ çš„ ACK ç¡®è®¤å“åº”ï¼Œå°±è¡¨ç¤ºå‘é€æˆåŠŸ**ï¼Œæ‰€ä»¥åªè¦å¤„ç†å¥½è¿”å›å€¼å’Œå¼‚å¸¸ï¼Œå¦‚æœè¿”å›å¼‚å¸¸åˆ™è¿›è¡Œæ¶ˆæ¯é‡å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜¶æ®µæ˜¯ä¸ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„ã€‚

- Redis æ¶ˆè´¹è€…ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Ÿä¸ä¼šï¼Œ**å› ä¸º Stream ï¼ˆ MQ ä¸­é—´ä»¶ï¼‰ä¼šè‡ªåŠ¨ä½¿ç”¨å†…éƒ¨é˜Ÿåˆ—ï¼ˆä¹Ÿç§°ä¸º PENDING Listï¼‰ç•™å­˜æ¶ˆè´¹ç»„é‡Œæ¯ä¸ªæ¶ˆè´¹è€…è¯»å–çš„æ¶ˆæ¯**ï¼Œ**ä½†æ˜¯æœªè¢«ç¡®è®¤çš„æ¶ˆæ¯**ã€‚æ¶ˆè´¹è€…å¯ä»¥åœ¨é‡å¯åï¼Œç”¨ XPENDING å‘½ä»¤æŸ¥çœ‹å·²è¯»å–ã€ä½†å°šæœªç¡®è®¤å¤„ç†å®Œæˆçš„æ¶ˆæ¯ã€‚**ç­‰åˆ°æ¶ˆè´¹è€…æ‰§è¡Œå®Œä¸šåŠ¡é€»è¾‘åï¼Œå†å‘é€æ¶ˆè´¹ç¡®è®¤ XACK å‘½ä»¤ï¼Œä¹Ÿèƒ½ä¿è¯æ¶ˆæ¯çš„ä¸ä¸¢å¤±**

- Redis æ¶ˆæ¯ä¸­é—´ä»¶ä¼šä¸ä¼šä¸¢æ¶ˆæ¯ï¼Ÿä¼šï¼ŒRedis åœ¨ä»¥ä¸‹ 2 ä¸ªåœºæ™¯ä¸‹ï¼Œéƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼š

  - AOF æŒä¹…åŒ–é…ç½®ä¸ºæ¯ç§’å†™ç›˜ï¼Œä½†è¿™ä¸ªå†™ç›˜è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼ŒRedis å®•æœºæ—¶ä¼šå­˜åœ¨æ•°æ®ä¸¢å¤±çš„å¯èƒ½

  - ä¸»ä»å¤åˆ¶ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œ[ä¸»ä»åˆ‡æ¢æ—¶ï¼Œä¹Ÿå­˜åœ¨ä¸¢å¤±æ•°æ®çš„å¯èƒ½ ](https://xiaolincoding.com/redis/cluster/master_slave_replication.html#redis-ä¸»ä»åˆ‡æ¢å¦‚ä½•å‡å°‘æ•°æ®ä¸¢å¤±)

Redis åœ¨é˜Ÿåˆ—ä¸­é—´ä»¶ç¯èŠ‚æ— æ³•ä¿è¯æ¶ˆæ¯ä¸ä¸¢ã€‚åƒ `RabbitMQ` æˆ– `Kafka` è¿™ç±»ä¸“ä¸šçš„é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œåœ¨ä½¿ç”¨æ—¶æ˜¯éƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ï¼Œç”Ÿäº§è€…åœ¨å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œé˜Ÿåˆ—ä¸­é—´ä»¶é€šå¸¸ä¼šå†™ã€Œå¤šä¸ªèŠ‚ç‚¹ã€ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå³ä¾¿å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œä¹Ÿèƒ½ä¿è¯é›†ç¾¤çš„æ•°æ®ä¸ä¸¢å¤±





*2. Redis Stream æ¶ˆæ¯å¯å †ç§¯å—ï¼Ÿ* (ä¸»è¦åŸå›  Redisæ˜¯åŸºäºå†…å­˜å­˜å‚¨çš„)

Redis çš„æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿™å°±æ„å‘³ç€ä¸€æ—¦å‘ç”Ÿæ¶ˆæ¯ç§¯å‹ï¼Œåˆ™ä¼šå¯¼è‡´ Redis çš„å†…å­˜æŒç»­å¢é•¿ï¼Œå¦‚æœè¶…è¿‡æœºå™¨å†…å­˜ä¸Šé™ï¼Œå°±ä¼šé¢ä¸´ `OOM` çš„é£é™©ã€‚æ‰€ä»¥ Redis çš„ Stream æä¾›äº†å¯ä»¥æŒ‡å®šé˜Ÿåˆ—æœ€å¤§é•¿åº¦çš„åŠŸèƒ½ã€‚å½“æŒ‡å®šé˜Ÿåˆ—æœ€å¤§é•¿åº¦æ—¶ï¼Œé˜Ÿåˆ—é•¿åº¦è¶…è¿‡ä¸Šé™åï¼Œæ—§æ¶ˆæ¯ä¼šè¢«åˆ é™¤ï¼Œåªä¿ç•™å›ºå®šé•¿åº¦çš„æ–°æ¶ˆæ¯ã€‚è¿™ä¹ˆæ¥çœ‹ï¼ŒStream åœ¨æ¶ˆæ¯ç§¯å‹æ—¶ï¼Œå¦‚æœæŒ‡å®šäº†æœ€å¤§é•¿åº¦ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¸¢å¤±æ¶ˆæ¯çš„ã€‚ä½† Kafkaã€RabbitMQ ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—å®ƒä»¬çš„æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå½“æ¶ˆæ¯ç§¯å‹æ—¶ï¼Œæ— éå°±æ˜¯å¤šå ç”¨ä¸€äº›ç£ç›˜ç©ºé—´







## æŒä¹…åŒ–



### AOF

Redis å†™å…¥ AOF æ—¥å¿—çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾ï¼š

<img src="https://cdn.xiaolincoding.com//mysql/other/4eeef4dd1bedd2ffe0b84d4eaa0dbdea.png" alt="img" style="zoom:50%;" />



1. Redis æ‰§è¡Œå®Œå†™æ“ä½œå‘½ä»¤åï¼Œä¼šå°†å‘½ä»¤è¿½åŠ åˆ° `server.aof_buf` ç¼“å†²åŒºï¼›
2. ç„¶åé€šè¿‡ write() ç³»ç»Ÿè°ƒç”¨ï¼Œå°† aof_buf ç¼“å†²åŒºçš„æ•°æ®å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œæ­¤æ—¶æ•°æ®å¹¶æ²¡æœ‰å†™å…¥åˆ°ç¡¬ç›˜ï¼Œè€Œæ˜¯æ‹·è´åˆ°äº†å†…æ ¸ç¼“å†²åŒº page cacheï¼Œç­‰å¾…å†…æ ¸å°†æ•°æ®å†™å…¥ç¡¬ç›˜ï¼›
3. å…·ä½“å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®ä»€ä¹ˆæ—¶å€™å†™å…¥åˆ°ç¡¬ç›˜ï¼Œç”±å†…æ ¸å†³å®šã€‚

Redis æä¾›äº† 3 ç§å†™å›ç¡¬ç›˜çš„ç­–ç•¥ï¼Œæ§åˆ¶çš„å°±æ˜¯ä¸Šé¢è¯´çš„ç¬¬ä¸‰æ­¥çš„è¿‡ç¨‹ã€‚

åœ¨ `redis.conf` é…ç½®æ–‡ä»¶ä¸­çš„ `appendfsync` é…ç½®é¡¹å¯ä»¥æœ‰ä»¥ä¸‹ 3 ç§å‚æ•°å¯å¡«ï¼š

- **Always**ï¼Œè¿™ä¸ªå•è¯çš„æ„æ€æ˜¯ã€Œæ€»æ˜¯ã€ï¼Œæ‰€ä»¥å®ƒçš„æ„æ€æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼ŒåŒæ­¥å°† AOF æ—¥å¿—æ•°æ®å†™å›ç¡¬ç›˜ï¼›
- **Everysec**ï¼Œè¿™ä¸ªå•è¯çš„æ„æ€æ˜¯ã€Œæ¯ç§’ã€ï¼Œæ‰€ä»¥å®ƒçš„æ„æ€æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶çš„å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åæ¯éš”ä¸€ç§’å°†ç¼“å†²åŒºé‡Œçš„å†…å®¹å†™å›åˆ°ç¡¬ç›˜ï¼›(**æŠ˜ä¸­æ–¹å¼ï¼Œå…è®¸æœ€å¤šä¸€ç§’çš„æ•°æ®ä¸¢å¤±**)
- **No**ï¼Œæ„å‘³ç€ä¸ç”± Redis æ§åˆ¶å†™å›ç¡¬ç›˜çš„æ—¶æœºï¼Œè½¬äº¤ç»™æ“ä½œç³»ç»Ÿæ§åˆ¶å†™å›çš„æ—¶æœºï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶çš„å†…æ ¸ç¼“å†²åŒºï¼Œå†ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç¡¬ç›˜

æ·±å…¥åˆ°æºç åï¼Œä½ å°±ä¼šå‘ç°è¿™ä¸‰ç§ç­–ç•¥åªæ˜¯åœ¨æ§åˆ¶ `fsync()` å‡½æ•°çš„è°ƒç”¨æ—¶æœºã€‚

> `fsync()`å‡½æ•°æ˜¯ç”¨äºå°†ç¼“å†²åŒºæ•°æ®åŒæ­¥å†™å…¥ç£ç›˜çš„ç³»ç»Ÿè°ƒç”¨

å½“åº”ç”¨ç¨‹åºå‘æ–‡ä»¶å†™å…¥æ•°æ®æ—¶ï¼Œå†…æ ¸é€šå¸¸å…ˆå°†æ•°æ®å¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œç„¶åæ’å…¥é˜Ÿåˆ—ï¼Œç„¶åç”±å†…æ ¸å†³å®šä½•æ—¶å†™å…¥ç¡¬ç›˜ã€‚

- Always ç­–ç•¥å°±æ˜¯æ¯æ¬¡å†™å…¥ AOF æ–‡ä»¶æ•°æ®åï¼Œå°±æ‰§è¡Œ fsync() å‡½æ•°ï¼›

- Everysec ç­–ç•¥å°±ä¼šåˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œ fsync() å‡½æ•°ï¼›

- No ç­–ç•¥å°±æ˜¯æ°¸ä¸æ‰§è¡Œ fsync() å‡½æ•°;



`AOF`çš„åˆ·ç›˜éå¸¸ç±»ä¼¼`BinLog`çš„åˆ·ç›˜



#### AOFé‡å†™

Redis ä¸ºäº†é¿å… AOF æ–‡ä»¶è¶Šå†™è¶Šå¤§ï¼Œæä¾›äº† **AOF é‡å†™æœºåˆ¶**ï¼Œ**å½“ AOF æ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼åï¼ŒRedis å°±ä¼šå¯ç”¨ AOF é‡å†™æœºåˆ¶(æ³¨æ„è§¦å‘æ—¶æœºï¼ï¼ï¼)**ï¼Œæ¥å‹ç¼© AOF æ–‡ä»¶ã€‚AOF é‡å†™æœºåˆ¶æ˜¯**åœ¨é‡å†™æ—¶ï¼Œè¯»å–å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œç„¶åå°†æ¯ä¸€ä¸ªé”®å€¼å¯¹ç”¨ä¸€æ¡å‘½ä»¤è®°å½•åˆ°ã€Œæ–°çš„ AOF æ–‡ä»¶ã€**ï¼Œç­‰åˆ°å…¨éƒ¨è®°å½•å®Œåï¼Œå°±å°†æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ‰ç°æœ‰çš„ AOF æ–‡ä»¶ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/aof%E9%87%8D%E5%86%99.jpg)

åœ¨ä½¿ç”¨é‡å†™æœºåˆ¶åï¼Œå°±ä¼šè¯»å– name æœ€æ–°çš„ valueï¼ˆé”®å€¼å¯¹ï¼‰ ï¼Œç„¶åç”¨ä¸€æ¡ ã€Œset name xiaolincodingã€å‘½ä»¤è®°å½•åˆ°æ–°çš„ AOF æ–‡ä»¶ï¼Œä¹‹å‰çš„ç¬¬ä¸€ä¸ªå‘½ä»¤å°±æ²¡æœ‰å¿…è¦è®°å½•äº†ï¼Œå› ä¸ºå®ƒå±äºã€Œå†å²ã€å‘½ä»¤ï¼Œæ²¡æœ‰ä½œç”¨äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸€ä¸ªé”®å€¼å¯¹åœ¨é‡å†™æ—¥å¿—ä¸­åªç”¨ä¸€æ¡å‘½ä»¤å°±è¡Œäº†ã€‚é‡å†™æœºåˆ¶çš„å¦™å¤„åœ¨äºï¼Œå°½ç®¡æŸä¸ªé”®å€¼å¯¹è¢«å¤šæ¡å†™å‘½ä»¤åå¤ä¿®æ”¹ï¼Œ**æœ€ç»ˆä¹Ÿåªéœ€è¦æ ¹æ®è¿™ä¸ªã€Œé”®å€¼å¯¹ã€å½“å‰çš„æœ€æ–°çŠ¶æ€ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å»è®°å½•é”®å€¼å¯¹**ï¼Œä»£æ›¿ä¹‹å‰è®°å½•è¿™ä¸ªé”®å€¼å¯¹çš„å¤šæ¡å‘½ä»¤ï¼Œè¿™æ ·å°±å‡å°‘äº† AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤æ•°é‡

Redis çš„**é‡å†™ AOF è¿‡ç¨‹æ˜¯ç”±åå°å­è¿›ç¨‹ `bgrewriteaof`æ¥å®Œæˆçš„**

- å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œä»è€Œé¿å…é˜»å¡ä¸»è¿›ç¨‹ï¼›
- å­è¿›ç¨‹å¸¦æœ‰ä¸»è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼ˆ*æ•°æ®å‰¯æœ¬æ€ä¹ˆäº§ç”Ÿçš„åé¢ä¼šè¯´*ï¼‰ï¼Œè¿™é‡Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå› ä¸ºå¦‚æœæ˜¯ä½¿ç”¨çº¿ç¨‹ï¼Œå¤šçº¿ç¨‹ä¹‹é—´ä¼šå…±äº«å†…å­˜ï¼Œé‚£ä¹ˆåœ¨ä¿®æ”¹å…±äº«å†…å­˜æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡åŠ é”æ¥ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œè€Œè¿™æ ·å°±ä¼šé™ä½æ€§èƒ½ã€‚è€Œä½¿ç”¨å­è¿›ç¨‹ï¼Œåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œçˆ¶å­è¿›ç¨‹æ˜¯å…±äº«å†…å­˜æ•°æ®çš„ï¼Œä¸è¿‡è¿™ä¸ªå…±äº«çš„å†…å­˜åªèƒ½ä»¥åªè¯»çš„æ–¹å¼ï¼Œè€Œå½“çˆ¶å­è¿›ç¨‹ä»»æ„ä¸€æ–¹ä¿®æ”¹äº†è¯¥å…±äº«å†…å­˜ï¼Œå°±ä¼šå‘ç”Ÿ**ã€Œå†™å…¥æ—¶å¤åˆ¶ã€**ï¼Œäºæ˜¯çˆ¶å­è¿›ç¨‹å°±æœ‰äº†ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬ï¼Œå°±ä¸ç”¨åŠ é”æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚



è§¦å‘é‡å†™æœºåˆ¶åï¼Œä¸»è¿›ç¨‹å°±ä¼šåˆ›å»ºé‡å†™ AOF çš„å­è¿›ç¨‹`bgrewriteaof`ï¼Œæ­¤æ—¶çˆ¶å­è¿›ç¨‹å…±äº«ç‰©ç†å†…å­˜ï¼Œé‡å†™å­è¿›ç¨‹åªä¼šå¯¹è¿™ä¸ªå†…å­˜è¿›è¡Œåªè¯»ï¼Œé‡å†™ AOF å­è¿›ç¨‹ä¼šè¯»å–å†…å­˜æ•°æ®åº“é‡Œçš„æ‰€æœ‰æ•°æ®ï¼Œ**å¹¶é€ä¸€æŠŠå†…å­˜æ•°æ®çš„é”®å€¼å¯¹è½¬æ¢æˆä¸€æ¡å‘½ä»¤ï¼Œå†å°†å‘½ä»¤è®°å½•åˆ°é‡å†™æ—¥å¿—ï¼ˆæ–°çš„ AOF æ–‡ä»¶ï¼‰**

**ä½†æ˜¯å­è¿›ç¨‹é‡å†™è¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹ä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å‘½ä»¤**

å¦‚æœæ­¤æ—¶**ä¸»è¿›ç¨‹ä¿®æ”¹äº†å·²ç»å­˜åœ¨ key-valueï¼Œå°±ä¼šå‘ç”Ÿå†™å…¥æ—¶å¤åˆ¶ï¼Œæ³¨æ„è¿™é‡Œåªä¼šå¤åˆ¶ä¸»è¿›ç¨‹ä¿®æ”¹çš„ç‰©ç†å†…å­˜æ•°æ®ï¼Œæ²¡ä¿®æ”¹çš„é‚£éƒ¨åˆ†ç‰©ç†å†…å­˜è¿˜æ˜¯ä¸å­è¿›ç¨‹å…±äº«çš„**ã€‚



> `bigkey`å¯¹`AOF`ä¸`RDB`çš„å½±å“ï¼Ÿ

æ‰€ä»¥å¦‚æœè¿™ä¸ªé˜¶æ®µä¿®æ”¹çš„æ˜¯ä¸€ä¸ª bigkeyï¼Œä¹Ÿå°±æ˜¯æ•°æ®é‡æ¯”è¾ƒå¤§çš„ key-value çš„æ—¶å€™ï¼Œè¿™æ—¶å¤åˆ¶çš„ç‰©ç†å†…å­˜æ•°æ®çš„è¿‡ç¨‹å°±ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œæœ‰é˜»å¡ä¸»è¿›ç¨‹çš„é£é™©

:question:  å†è§£é‡Šä¸€ä¸‹ï¼šå¯¹äºAOFï¼Œæœ€å¼€å§‹ä¼š`fork`å‡ºä¸€ä¸ªç”¨äºAOFé‡å†™çš„å­è¿›ç¨‹ï¼Œè®©è¯¥å­è¿›ç¨‹ä¹ŸæŒ‡å‘äº†çˆ¶è¿›ç¨‹æŒ‡å‘çš„å†…å­˜ç©ºé—´ï¼›å¯¹äºRDBæŒä¹…åŒ–ï¼Œå¦‚æœä½¿ç”¨`bgsave`å‘½ä»¤ï¼ŒåŒæ ·ä¹Ÿä¼š`fork`å‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œæ“ä½œã€‚

ä¸€æ—¦çˆ¶è¿›ç¨‹æ”¶åˆ°äº†å†™æ“ä½œå‘½ä»¤ï¼Œå°±ä¼šæ–°å¤åˆ¶å‡ºæ¥ä¸€ç‰‡å†…å­˜åŒºåŸŸ(æ­¤æ—¶å’Œå­è¿›ç¨‹æŒ‡å‘çš„å°±ä¸æ˜¯åŒä¸€ç‰‡å†…å­˜åŒºåŸŸäº†)ï¼Œå¹¶åœ¨è¯¥æ–°å†…å­˜åŒºåŸŸä¸Šè¿›è¡Œå†™æ“ä½œï¼Œè¿™æ ·å°±å½±å“ä¸åˆ°å­è¿›ç¨‹è¿›è¡Œ`aof`é‡å†™/`bgsave`è¿›è¡Œ`rdb`æŒä¹…åŒ–

å¦‚æœåˆ›å»ºå®Œå­è¿›ç¨‹åï¼Œ**çˆ¶è¿›ç¨‹å¯¹å…±äº«å†…å­˜ä¸­çš„å¤§ Key è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå†…æ ¸å°±ä¼šå‘ç”Ÿå†™å…¥æ—¶å¤åˆ¶ï¼Œä¼šæŠŠç‰©ç†å†…å­˜å¤åˆ¶ä¸€ä»½ï¼Œç”±äºå¤§ Key å ç”¨çš„ç‰©ç†å†…å­˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œé‚£ä¹ˆåœ¨å¤åˆ¶ç‰©ç†å†…å­˜è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œäºæ˜¯çˆ¶è¿›ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰å°±ä¼šå‘ç”Ÿé˜»å¡**ã€‚

æ‰€ä»¥ï¼Œæœ‰ä¸¤ä¸ªé˜¶æ®µä¼šå¯¼è‡´é˜»å¡çˆ¶è¿›ç¨‹ï¼š

- åˆ›å»ºå­è¿›ç¨‹çš„é€”ä¸­ï¼Œ**ç”±äºè¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ç­‰æ•°æ®ç»“æ„ï¼Œé˜»å¡çš„æ—¶é—´è·Ÿé¡µè¡¨çš„å¤§å°æœ‰å…³ï¼Œé¡µè¡¨è¶Šå¤§ï¼Œé˜»å¡çš„æ—¶é—´ä¹Ÿè¶Šé•¿**ï¼›
- åˆ›å»ºå®Œå­è¿›ç¨‹åï¼Œå¦‚æœå­è¿›ç¨‹æˆ–è€…çˆ¶è¿›ç¨‹ä¿®æ”¹äº†å…±äº«æ•°æ®ï¼Œå°±ä¼šå‘ç”Ÿå†™æ—¶å¤åˆ¶ï¼Œè¿™æœŸé—´ä¼šæ‹·è´ç‰©ç†å†…å­˜ï¼Œå¦‚æœå†…å­˜è¶Šå¤§ï¼Œè‡ªç„¶é˜»å¡çš„æ—¶é—´ä¹Ÿè¶Šé•¿ï¼›









### RDB

RDB å¿«ç…§å°±æ˜¯è®°å½•æŸä¸€ä¸ªç¬é—´çš„å†…å­˜æ•°æ®ï¼Œè®°å½•çš„æ˜¯**å®é™…æ•°æ®**(äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå› æ­¤å¯èƒ½æ¯”è¾ƒå¤§)ï¼Œè€Œ AOF æ–‡ä»¶è®°å½•çš„æ˜¯å‘½ä»¤æ“ä½œçš„æ—¥å¿—ï¼Œè€Œä¸æ˜¯å®é™…çš„æ•°æ®ï¼Œæ•…åœ¨ Redis æ¢å¤æ•°æ®æ—¶ï¼Œ RDB æ¢å¤æ•°æ®çš„æ•ˆç‡ä¼šæ¯” AOF é«˜äº›ï¼Œå› ä¸ºç›´æ¥å°† RDB æ–‡ä»¶è¯»å…¥å†…å­˜å°±å¯ä»¥ï¼Œä¸éœ€è¦åƒ AOF é‚£æ ·è¿˜éœ€è¦é¢å¤–æ‰§è¡Œæ“ä½œå‘½ä»¤çš„æ­¥éª¤æ‰èƒ½æ¢å¤æ•°æ®ï¼ŒRedis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ `save` å’Œ `bgsave`ï¼Œä»–ä»¬çš„åŒºåˆ«å°±åœ¨äºæ˜¯å¦åœ¨ã€Œä¸»çº¿ç¨‹ã€é‡Œæ‰§è¡Œï¼š

- æ‰§è¡Œäº† save å‘½ä»¤ï¼Œå°±ä¼šåœ¨ä¸»çº¿ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç”±äºå’Œæ‰§è¡Œæ“ä½œå‘½ä»¤åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å¦‚æœå†™å…¥ RDB æ–‡ä»¶çš„æ—¶é—´å¤ªé•¿ï¼Œ**ä¼šé˜»å¡ä¸»çº¿ç¨‹**ï¼›
- æ‰§è¡Œäº† `bgsave` å‘½ä»¤ï¼Œä¼š**åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹**æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥**é¿å…ä¸»çº¿ç¨‹çš„é˜»å¡**ï¼›



> æ‰§è¡Œå¿«ç…§æ—¶ï¼Œæ•°æ®å¯ä»¥è¢«ä¿®æ”¹å—ï¼Ÿ

åœ¨å­è¿›ç¨‹æ‰§è¡Œ `bgsave` è¿‡ç¨‹ä¸­ï¼ŒRedisä¸»çº¿ç¨‹ä¾ç„¶**å¯ä»¥ç»§ç»­å¤„ç†æ“ä½œå‘½ä»¤**çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®æ˜¯èƒ½è¢«ä¿®æ”¹çš„ï¼Œè¿™ä¾èµ–äº**å†™å…¥æ—¶å¤åˆ¶**ï¼ˆ`Copy On Write`ï¼‰:



æ‰§è¡Œ bgsave å‘½ä»¤çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ `fork()` åˆ›å»ºå­è¿›ç¨‹ï¼Œæ­¤æ—¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹æ˜¯å…±äº«åŒä¸€ç‰‡å†…å­˜æ•°æ®çš„ï¼Œå› ä¸ºåˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œä½†æ˜¯é¡µè¡¨æŒ‡å‘çš„ç‰©ç†å†…å­˜è¿˜æ˜¯ä¸€ä¸ªã€‚

<img src="https://cdn.xiaolincoding.com//mysql/other/c34a9d1f58d602ff1fe8601f7270baa7.png" alt="å›¾ç‰‡" style="zoom:67%;" />

åªæœ‰åœ¨å‘ç”Ÿä¿®æ”¹å†…å­˜æ•°æ®çš„æƒ…å†µæ—¶ï¼Œç‰©ç†å†…å­˜æ‰ä¼šè¢«å¤åˆ¶ä¸€ä»½ã€‚

<img src="https://cdn.xiaolincoding.com//mysql/other/ebd620db8a1af66fbeb8f4d4ef6adc68.png" alt="å›¾ç‰‡" style="zoom:67%;" />





æ‰§è¡Œ `bgsave` å‘½ä»¤çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ `fork()` åˆ›å»ºå­è¿›ç¨‹ï¼Œæ­¤æ—¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹æ˜¯å…±äº«åŒä¸€ç‰‡å†…å­˜æ•°æ®çš„ï¼Œç”±äºå…±äº«çˆ¶è¿›ç¨‹çš„æ‰€æœ‰å†…å­˜æ•°æ®ï¼Œäºæ˜¯å°±å¯ä»¥ç›´æ¥è¯»å–ä¸»çº¿ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é‡Œçš„å†…å­˜æ•°æ®ï¼Œå¹¶å°†æ•°æ®å†™å…¥åˆ° RDB æ–‡ä»¶

1. å½“ä¸»çº¿ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å¯¹è¿™äº›å…±äº«çš„å†…å­˜æ•°æ®ä¹Ÿéƒ½æ˜¯åªè¯»æ“ä½œï¼Œé‚£ä¹ˆï¼Œä¸»çº¿ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å’Œ bgsave å­è¿›ç¨‹ç›¸äº’ä¸å½±å“
2. ä½†æ˜¯ï¼Œå¦‚æœä¸»çº¿ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰è¦**ä¿®æ”¹å…±äº«æ•°æ®é‡Œçš„æŸä¸€å—æ•°æ®**æ—¶ï¼Œå°±ä¼šå‘ç”Ÿå†™å…¥æ—¶å¤åˆ¶ï¼Œäºæ˜¯è¿™å—æ•°æ®çš„**ç‰©ç†å†…å­˜å°±ä¼šè¢«å¤åˆ¶ä¸€ä»½**ï¼Œç„¶å**ä¸»çº¿ç¨‹åœ¨è¿™ä¸ªæ•°æ®å‰¯æœ¬ï¼ˆè¿›è¡Œä¿®æ”¹æ“ä½œï¼‰**ã€‚ä¸æ­¤åŒæ—¶ï¼Œ**bgsave å­è¿›ç¨‹å¯ä»¥ç»§ç»­æŠŠåŸæ¥çš„æ•°æ®å†™å…¥åˆ° RDB æ–‡ä»¶**ï¼Œ**è¿™ç§æƒ…å†µä¸‹RDB å¿«ç…§ä¿å­˜çš„æ˜¯åŸæœ¬çš„å†…å­˜æ•°æ®**ï¼Œè€Œä¸»çº¿ç¨‹åˆšä¿®æ”¹çš„æ•°æ®ï¼Œæ˜¯æ²¡åŠæ³•åœ¨è¿™ä¸€æ—¶é—´å†™å…¥ RDB æ–‡ä»¶çš„ï¼Œåªèƒ½äº¤ç”±ä¸‹ä¸€æ¬¡çš„ bgsave å¿«ç…§



æ‰€ä»¥ Redis åœ¨ä½¿ç”¨ bgsave å¿«ç…§è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸»çº¿ç¨‹ä¿®æ”¹äº†å†…å­˜æ•°æ®ï¼Œä¸ç®¡æ˜¯å¦æ˜¯å…±äº«çš„å†…å­˜æ•°æ®ï¼ŒRDB å¿«ç…§éƒ½æ— æ³•å†™å…¥ä¸»çº¿ç¨‹åˆšä¿®æ”¹çš„æ•°æ®ï¼Œå› ä¸ºæ­¤æ—¶ä¸»çº¿ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰çš„å†…å­˜æ•°æ®å’Œå­è¿›ç¨‹çš„å†…å­˜æ•°æ®å·²ç»åˆ†ç¦»äº†ï¼Œå­è¿›ç¨‹å†™å…¥åˆ° RDB æ–‡ä»¶çš„å†…å­˜æ•°æ®åªèƒ½æ˜¯åŸæœ¬çš„å†…å­˜æ•°æ®ã€‚





### æ··åˆæŒä¹…åŒ–

å°† RDB å’Œ AOF åˆä½“ä½¿ç”¨ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ Redis 4.0 æå‡ºçš„ï¼Œè¯¥æ–¹æ³•å«**æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§**ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ã€‚å¦‚æœæƒ³è¦å¼€å¯æ··åˆæŒä¹…åŒ–åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ Redis é…ç½®æ–‡ä»¶å°†ä¸‹é¢è¿™ä¸ªé…ç½®é¡¹è®¾ç½®æˆ yesï¼š

```shell
aof-use-rdb-preamble yes
```

å½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œ`fork` å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„**å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®**ã€‚



è¿™æ ·çš„å¥½å¤„åœ¨äºé‡å¯ Redis åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œç”±äºå‰åŠéƒ¨åˆ†æ˜¯ RDB å†…å®¹ï¼Œè¿™æ ·**åŠ è½½çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆå¿«**ã€‚åŠ è½½å®Œ RDB çš„å†…å®¹åï¼Œæ‰ä¼šåŠ è½½ååŠéƒ¨åˆ†çš„ AOF å†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹æ˜¯ Redis åå°å­è¿›ç¨‹é‡å†™ AOF æœŸé—´ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤(æ­¤æ—¶å‘ç”Ÿäº†å†™å…¥æ—¶å¤åˆ¶)ï¼Œå¯ä»¥ä½¿å¾—**æ•°æ®æ›´å°‘çš„ä¸¢å¤±**









## é«˜å¯ç”¨

> è¡¥å……ï¼š Redisåˆ é™¤ç­–ç•¥ã€å†…å­˜æ·˜æ±°ç­–ç•¥

å®šæ—¶åˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**åœ¨è®¾ç½® key çš„è¿‡æœŸæ—¶é—´æ—¶ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå®šæ—¶äº‹ä»¶ï¼Œå½“æ—¶é—´åˆ°è¾¾æ—¶ï¼Œç”±äº‹ä»¶å¤„ç†å™¨è‡ªåŠ¨æ‰§è¡Œ key çš„åˆ é™¤æ“ä½œ**

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**ä¸ä¸»åŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œæ¯æ¬¡ä»æ•°æ®åº“è®¿é—® key æ—¶ï¼Œéƒ½æ£€æµ‹ key æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤è¯¥ key**

å®šæœŸåˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**æ¯éš”ä¸€æ®µæ—¶é—´ã€Œéšæœºã€ä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„ key è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸkey**

Redis ä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ã€Œæƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤ã€ï¼Œåˆ é™¤çš„å¯¹è±¡æ˜¯å·²è¿‡æœŸçš„ keyã€‚

å†…å­˜æ·˜æ±°ç­–ç•¥æ˜¯è§£å†³å†…å­˜è¿‡å¤§çš„é—®é¢˜ï¼Œå½“ Redis çš„è¿è¡Œå†…å­˜è¶…è¿‡æœ€å¤§è¿è¡Œå†…å­˜æ—¶ï¼Œå°±ä¼šè§¦å‘å†…å­˜æ·˜æ±°ç­–ç•¥ï¼ˆå‰é¢è¯´çš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œæ˜¯åˆ é™¤å·²è¿‡æœŸçš„ keyï¼Œè€Œå½“ Redis çš„è¿è¡Œå†…å­˜å·²ç»è¶…è¿‡ Redis è®¾ç½®çš„æœ€å¤§å†…å­˜ä¹‹åï¼Œåˆ™ä¼šä½¿ç”¨å†…å­˜æ·˜æ±°ç­–ç•¥åˆ é™¤ç¬¦åˆæ¡ä»¶çš„ keyï¼Œä»¥æ­¤æ¥ä¿éšœ Redis é«˜æ•ˆçš„è¿è¡Œï¼‰



### ä¸»ä»å¤åˆ¶

ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸‹ï¼šä¸»æœåŠ¡å™¨å¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œå½“å‘ç”Ÿå†™æ“ä½œæ—¶è‡ªåŠ¨å°†å†™æ“ä½œåŒæ­¥ç»™ä»æœåŠ¡å™¨ï¼Œè€Œä»æœåŠ¡å™¨ä¸€èˆ¬æ˜¯åªè¯»ï¼Œå¹¶æ¥å—ä¸»æœåŠ¡å™¨åŒæ­¥è¿‡æ¥å†™æ“ä½œå‘½ä»¤ï¼Œç„¶åæ‰§è¡Œè¿™æ¡å‘½ä»¤

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.jpg)

å¯ä»¥ä½¿ç”¨ `replicaof`ï¼ˆRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveofï¼‰å‘½ä»¤å½¢æˆä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨çš„å…³ç³»

æ¯”å¦‚ï¼Œç°åœ¨æœ‰æœåŠ¡å™¨ A å’Œ æœåŠ¡å™¨ Bï¼Œæˆ‘ä»¬åœ¨æœåŠ¡å™¨ B ä¸Šæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š

```shell
# æœåŠ¡å™¨ B æ‰§è¡Œè¿™æ¡å‘½ä»¤
replicaof <æœåŠ¡å™¨ A çš„ IP åœ°å€> <æœåŠ¡å™¨ A çš„ Redis ç«¯å£å·>
```

ä¸»ä»æœåŠ¡å™¨é—´çš„ç¬¬ä¸€æ¬¡åŒæ­¥çš„è¿‡ç¨‹å¯åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

- ç¬¬ä¸€é˜¶æ®µæ˜¯å»ºç«‹è¿æ¥ã€åå•†åŒæ­¥ï¼›

  ä»æœåŠ¡å™¨å°±ä¼šç»™ä¸»æœåŠ¡å™¨å‘é€ `psync` å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ã€‚

  psync å‘½ä»¤åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯**ä¸»æœåŠ¡å™¨çš„ runID** å’Œ**å¤åˆ¶è¿›åº¦ offset**ã€‚

  - runIDï¼Œæ¯ä¸ª Redis æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿäº§ä¸€ä¸ªéšæœºçš„ ID æ¥å”¯ä¸€æ ‡è¯†è‡ªå·±ã€‚å½“ä»æœåŠ¡å™¨å’Œä¸»æœåŠ¡å™¨ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»æœåŠ¡å™¨çš„ run IDï¼Œæ‰€ä»¥å°†å…¶è®¾ç½®ä¸º "?"ã€‚
  - offsetï¼Œè¡¨ç¤ºå¤åˆ¶çš„è¿›åº¦ï¼Œç¬¬ä¸€æ¬¡åŒæ­¥æ—¶ï¼Œå…¶å€¼ä¸º -1ã€‚

  ä¸»æœåŠ¡å™¨æ”¶åˆ° psync å‘½ä»¤åï¼Œä¼šç”¨ `FULLRESYNC` ä½œä¸ºå“åº”å‘½ä»¤è¿”å›ç»™å¯¹æ–¹ã€‚

  å¹¶ä¸”è¿™ä¸ªå“åº”å‘½ä»¤ä¼šå¸¦ä¸Šä¸¤ä¸ªå‚æ•°ï¼šä¸»æœåŠ¡å™¨çš„ runID å’Œä¸»æœåŠ¡å™¨ç›®å‰çš„å¤åˆ¶è¿›åº¦ offsetã€‚ä»æœåŠ¡å™¨æ”¶åˆ°å“åº”åï¼Œä¼šè®°å½•è¿™ä¸¤ä¸ªå€¼ã€‚

  FULLRESYNC å“åº”å‘½ä»¤çš„æ„å›¾æ˜¯é‡‡ç”¨**å…¨é‡å¤åˆ¶**çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸»æœåŠ¡å™¨ä¼šæŠŠæ‰€æœ‰çš„æ•°æ®éƒ½åŒæ­¥ç»™ä»æœåŠ¡å™¨





- ç¬¬äºŒé˜¶æ®µæ˜¯ä¸»æœåŠ¡å™¨åŒæ­¥æ•°æ®ç»™ä»æœåŠ¡å™¨ï¼ˆä¸»æœåŠ¡å™¨ä¼šæ‰§è¡Œ bgsave å‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç„¶åæŠŠæ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼‰

  æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„ï¼Œå› ä¸º bgsave å‘½ä»¤æ˜¯forkäº†ä¸€ä¸ªå­è¿›ç¨‹æ¥åšç”Ÿæˆ RDB æ–‡ä»¶çš„å·¥ä½œï¼Œæ˜¯å¼‚æ­¥å·¥ä½œçš„ï¼Œè¿™æ · Redis ä¾ç„¶å¯ä»¥æ­£å¸¸å¤„ç†å‘½ä»¤ã€‚ä½†æ˜¯ï¼Œ**è¿™æœŸé—´çš„å†™æ“ä½œå‘½ä»¤å¹¶æ²¡æœ‰è®°å½•åˆ°åˆšåˆšç”Ÿæˆçš„ RDB æ–‡ä»¶ä¸­ï¼Œè¿™æ—¶ä¸»ä»æœåŠ¡å™¨é—´çš„æ•°æ®å°±ä¸ä¸€è‡´äº†**

  

  ä¸ºäº†ä¿è¯ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§ï¼Œ**ä¸»æœåŠ¡å™¨åœ¨ä¸‹é¢è¿™ä¸‰ä¸ªæ—¶é—´é—´éš™ä¸­å°†æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼Œå†™å…¥åˆ° `replication buffer` ç¼“å†²åŒºé‡Œ**ï¼š

  - ä¸»æœåŠ¡å™¨ç”Ÿæˆ RDB æ–‡ä»¶æœŸé—´ï¼›
  - ä¸»æœåŠ¡å™¨å‘é€ RDB æ–‡ä»¶ç»™ä»æœåŠ¡å™¨æœŸé—´ï¼›
  - ã€Œä»æœåŠ¡å™¨ã€åŠ è½½ RDB æ–‡ä»¶æœŸé—´ï¼›



- ç¬¬ä¸‰é˜¶æ®µæ˜¯ä¸»æœåŠ¡å™¨å‘é€æ–°å†™æ“ä½œå‘½ä»¤ç»™ä»æœåŠ¡å™¨

  ä»æœåŠ¡å™¨æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¸¢å¼ƒæ‰€æœ‰æ—§æ•°æ®ï¼Œå°† RDB æ•°æ®è½½å…¥åˆ°å†…å­˜ã€‚å®Œæˆ RDB çš„è½½å…¥åï¼Œä¼šå›å¤ä¸€ä¸ªACKç¡®è®¤æ¶ˆæ¯ç»™ä¸»æœåŠ¡å™¨ã€‚æ¥ç€ï¼Œä¸»æœåŠ¡å™¨å°† `replication buffer` ç¼“å†²åŒºé‡Œæ‰€è®°å½•çš„å†™æ“ä½œå‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œæ¥è‡ªä¸»æœåŠ¡å™¨ `replication buffer` ç¼“å†²åŒºé‡Œå‘æ¥çš„å‘½ä»¤ï¼Œè¿™æ—¶ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®å°±ä¸€è‡´äº†ã€‚



> Replication Bufferç”¨äºæš‚æ—¶ä¿å­˜ä¸»èŠ‚ç‚¹å‘é€ç»™ä»èŠ‚ç‚¹çš„æ•°æ®ï¼ŒåŒ…æ‹¬å‘½ä»¤å’Œæ•°æ®æ›´æ–°ã€‚ä¸»èŠ‚ç‚¹å‘é€æ•°æ®çš„é€Ÿç‡å¯èƒ½å¿«äºä»èŠ‚ç‚¹æ¥æ”¶å’Œæ‰§è¡Œæ•°æ®çš„é€Ÿç‡ï¼Œè¿™å¯èƒ½å¯¼è‡´ä»èŠ‚ç‚¹ä¸¢å¤±éƒ¨åˆ†æ•°æ®ï¼Œå°¤å…¶åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å‡ºç°å»¶è¿Ÿæˆ–ç½‘ç»œæŠ–åŠ¨æ—¶ã€‚ä¸ºäº†é¿å…æ•°æ®ä¸¢å¤±ï¼ŒRedisä½¿ç”¨Replication Bufferæ¥æš‚å­˜ä¸»èŠ‚ç‚¹å‘é€çš„æ•°æ®
>
> 
>
> å½“ä»èŠ‚ç‚¹å‡†å¤‡å¥½æ¥æ”¶æ–°çš„æ•°æ®æ—¶ï¼Œå®ƒä¼šä»Replication Bufferä¸­è·å–æ•°æ®å¹¶åº”ç”¨åˆ°è‡ªå·±çš„æ•°æ®é›†ä¸­ï¼Œä»è€Œä¿æŒä¸ä¸»èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥ã€‚ä¸€æ—¦æ•°æ®åœ¨ä»èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸï¼Œä»èŠ‚ç‚¹ä¼šå‘ä¸»èŠ‚ç‚¹å‘é€ç¡®è®¤ï¼Œè¡¨ç¤ºå·²ç»æ¥æ”¶å¹¶å¤„ç†äº†æ•°æ®





ä¸»ä»æœåŠ¡å™¨åœ¨å®Œæˆç¬¬ä¸€æ¬¡åŒæ­¥åï¼ŒåŒæ–¹ä¹‹é—´å°±ä¼šç»´æŠ¤ä¸€ä¸ª TCP è¿æ¥ï¼Œåç»­ä¸»æœåŠ¡å™¨å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥ç»§ç»­å°†å†™æ“ä½œå‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨æ‰§è¡Œè¯¥å‘½ä»¤ï¼Œä½¿å¾—ä¸ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ç›¸åŒã€‚è€Œä¸”è¿™ä¸ªè¿æ¥æ˜¯é•¿è¿æ¥çš„ï¼Œç›®çš„æ˜¯é¿å…é¢‘ç¹çš„ TCP è¿æ¥å’Œæ–­å¼€å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚ä¸Šé¢çš„è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º**åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­**ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥ä¿è¯ç¬¬ä¸€æ¬¡åŒæ­¥åçš„ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§





ä¸»ä»å¤åˆ¶å…±æœ‰ä¸‰ç§æ¨¡å¼ï¼š**å…¨é‡å¤åˆ¶ã€åŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ã€å¢é‡å¤åˆ¶**

ä¸»ä»æœåŠ¡å™¨ç¬¬ä¸€æ¬¡åŒæ­¥çš„æ—¶å€™ï¼Œå°±æ˜¯é‡‡ç”¨å…¨é‡å¤åˆ¶ï¼Œæ­¤æ—¶ä¸»æœåŠ¡å™¨ä¼šä¸¤ä¸ªè€—æ—¶çš„åœ°æ–¹ï¼Œåˆ†åˆ«æ˜¯ç”Ÿæˆ RDB æ–‡ä»¶å’Œä¼ è¾“ RDB æ–‡ä»¶ã€‚ä¸ºäº†é¿å…è¿‡å¤šçš„ä»æœåŠ¡å™¨å’Œä¸»æœåŠ¡å™¨è¿›è¡Œå…¨é‡å¤åˆ¶ï¼Œå¯ä»¥æŠŠä¸€éƒ¨åˆ†ä»æœåŠ¡å™¨å‡çº§ä¸ºã€Œç»ç†è§’è‰²ã€ï¼Œè®©å®ƒä¹Ÿæœ‰è‡ªå·±çš„ä»æœåŠ¡å™¨ï¼Œé€šè¿‡è¿™æ ·å¯ä»¥åˆ†æ‘Šä¸»æœåŠ¡å™¨çš„å‹åŠ›

ç¬¬ä¸€æ¬¡åŒæ­¥å®Œæˆåï¼Œä¸»ä»æœåŠ¡å™¨éƒ½ä¼šç»´æŠ¤ç€ä¸€ä¸ªé•¿è¿æ¥ï¼Œä¸»æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°å†™æ“ä½œå‘½ä»¤åï¼Œå°±ä¼šé€šè¿‡è¿™ä¸ªè¿æ¥å°†å†™å‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨ï¼Œæ¥ä¿è¯ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§

å¦‚æœé‡åˆ°ç½‘ç»œæ–­å¼€åˆæ¢å¤åï¼Œä¸»æœåŠ¡å™¨ä¼šé‡‡ç”¨**å¢é‡å¤åˆ¶**çš„æ–¹å¼ç»§ç»­åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯è¯´åªä¼šæŠŠç½‘ç»œæ–­å¼€æœŸé—´ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»æœåŠ¡å™¨



é‡ç‚¹æ¥çœ‹çœ‹å¢é‡å¤åˆ¶ï¼š

ä» Redis 2.8 å¼€å§‹ï¼Œç½‘ç»œæ–­å¼€åˆæ¢å¤åï¼Œä¸»ä»æœåŠ¡å™¨ä¼šé‡‡ç”¨**å¢é‡å¤åˆ¶**çš„æ–¹å¼ç»§ç»­åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯åªä¼šæŠŠç½‘ç»œæ–­å¼€æœŸé—´ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å†™æ“ä½œå‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»æœåŠ¡å™¨ã€‚

<img src="https://cdn.xiaolincoding.com//mysql/other/e081b470870daeb763062bb873a4477e.png" alt="å›¾ç‰‡" style="zoom: 67%;" />



ä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š

- ä»æœåŠ¡å™¨åœ¨æ¢å¤ç½‘ç»œåï¼Œä¼šå‘é€ psync å‘½ä»¤ç»™ä¸»æœåŠ¡å™¨ï¼Œæ­¤æ—¶çš„ psync å‘½ä»¤é‡Œçš„ offset å‚æ•°ä¸æ˜¯ -1(**å› ä¸ºä¸æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥äº†!!!**)
- ä¸»æœåŠ¡å™¨æ”¶åˆ°è¯¥å‘½ä»¤åï¼Œç„¶åç”¨ CONTINUE å“åº”å‘½ä»¤å‘Šè¯‰ä»æœåŠ¡å™¨æ¥ä¸‹æ¥é‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼åŒæ­¥æ•°æ®
- ç„¶åä¸»æœåŠ¡å°†ä¸»ä»æœåŠ¡å™¨æ–­çº¿æœŸé—´ï¼Œæ‰€æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å‘½ä»¤

é‚£ä¹ˆå…³é”®çš„é—®é¢˜æ¥äº†ï¼Œ**ä¸»æœåŠ¡å™¨æ€ä¹ˆçŸ¥é“è¦å°†å“ªäº›å¢é‡æ•°æ®å‘é€ç»™ä»æœåŠ¡å™¨å‘¢ï¼Ÿ**









### å“¨å…µ

**å“¨å…µæœ‰ä¸¤é¡¹ä»»åŠ¡ï¼šåˆ¤å®šä¸»èŠ‚ç‚¹å®•æœºä¸‹çº¿+æŠ•ç¥¨é€‰å‡ºleader**



**å“¨å…µï¼ˆ`Sentinel`ï¼‰æœºåˆ¶**ï¼Œå®ƒçš„ä½œç”¨æ˜¯å®ç°**ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»**ã€‚å®ƒä¼šç›‘æµ‹ä¸»èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒå°±ä¼šé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠæ–°ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯é€šçŸ¥ç»™ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯ï¼Œ**å“¨å…µå…¶å®æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ Redis è¿›ç¨‹ï¼Œæ‰€ä»¥å®ƒä¹Ÿæ˜¯ä¸€ä¸ªèŠ‚ç‚¹**ã€‚ä»â€œå“¨å…µâ€è¿™ä¸ªåå­—ä¹Ÿå¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œå®ƒç›¸å½“äºæ˜¯â€œè§‚å¯Ÿè€…èŠ‚ç‚¹â€ï¼Œè§‚å¯Ÿçš„å¯¹è±¡æ˜¯ä¸»ä»èŠ‚ç‚¹

> å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹çœŸçš„æ•…éšœäº†ï¼Ÿ   ç”±å“¨å…µæŠ•ç¥¨å†³å®š

å“¨å…µä¼šæ¯éš” 1 ç§’ç»™**æ‰€æœ‰ä¸»ä»èŠ‚ç‚¹**å‘é€ `PING` å‘½ä»¤ï¼Œå½“ä¸»ä»èŠ‚ç‚¹æ”¶åˆ° `PING` å‘½ä»¤åï¼Œä¼šå‘é€ä¸€ä¸ªå“åº”å‘½ä»¤ç»™å“¨å…µï¼Œè¿™æ ·å°±å¯ä»¥åˆ¤æ–­å®ƒä»¬æ˜¯å¦åœ¨æ­£å¸¸è¿è¡Œï¼Œå“¨å…µåœ¨éƒ¨ç½²çš„æ—¶å€™ä¸ä¼šåªéƒ¨ç½²ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ˜¯ç”¨å¤šä¸ªèŠ‚ç‚¹éƒ¨ç½²æˆ**å“¨å…µé›†ç¾¤**ï¼Œå½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œä¸»è§‚ä¸‹çº¿ã€åï¼Œå°±ä¼šå‘å…¶ä»–å“¨å…µå‘èµ·å‘½ä»¤ï¼Œå…¶ä»–å“¨å…µæ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæ ¹æ®è‡ªèº«å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œçŠ¶å†µï¼Œåšå‡º**èµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨**çš„å“åº”ï¼Œå½“è¿™ä¸ªå“¨å…µçš„èµåŒç¥¨æ•°è¾¾åˆ°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ `quorum `é…ç½®é¡¹è®¾å®šçš„å€¼åï¼Œè¿™æ—¶ä¸»èŠ‚ç‚¹å°±ä¼šè¢«è¯¥å“¨å…µæ ‡è®°ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œå¹¶å‡†å¤‡æ‰§è¡Œä¸»ä»èŠ‚ç‚¹åˆ‡æ¢





(ä¾‹å¦‚ï¼Œç°åœ¨æœ‰ 3 ä¸ªå“¨å…µï¼Œ`quorum` é…ç½®çš„æ˜¯ 2ï¼Œé‚£ä¹ˆä¸€ä¸ªå“¨å…µéœ€è¦ 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥æ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€äº†ã€‚**è¿™ 2 å¼ èµæˆç¥¨åŒ…æ‹¬å“¨å…µè‡ªå·±çš„ä¸€å¼ èµæˆç¥¨å’Œå¦å¤–ä¸¤ä¸ªå“¨å…µçš„èµæˆç¥¨**ã€‚`quorum` çš„å€¼ä¸€èˆ¬è®¾ç½®ä¸ºå“¨å…µä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ 1ï¼Œä¾‹å¦‚ 3 ä¸ªå“¨å…µå°±è®¾ç½® 2)







å“ªä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œè¿™ä¸ªå“¨å…µèŠ‚ç‚¹å°±æ˜¯å€™é€‰è€…ï¼Œæ‰€è°“çš„å€™é€‰è€…å°±æ˜¯æƒ³å½“ `Leader` çš„å“¨å…µã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªå“¨å…µã€‚å½“å“¨å…µ B å…ˆåˆ¤æ–­åˆ°ä¸»èŠ‚ç‚¹ã€Œä¸»è§‚ä¸‹çº¿åã€ï¼Œå°±ä¼šç»™å…¶ä»–å®ä¾‹å‘é€ is-master-down-by-addr å‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œè¿æ¥æƒ…å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”ã€‚

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/sentinel.jpg" style="zoom: 50%;" />

- å•ä¸ªå“¨å…µåˆ¤å®šä¸€ä¸ªä¸»èŠ‚ç‚¹ä¸‹çº¿ ï¼Œè¿™ç§åˆ¤å®šè¢«ç§°ä¸ºä¸»è§‚ä¸‹çº¿
- æ•´ä¸ªå“¨å…µé›†ç¾¤åœ¨ç»è¿‡æŠ•ç¥¨åˆ¤æ–­ååˆ¤å®šè¯¥ä¸»èŠ‚ç‚¹ä¸‹çº¿ï¼Œè¿™ç§åˆ¤å®šç§°ä¸º**å®¢è§‚ä¸‹çº¿**



> è°æ¥è¿›è¡Œæ•…éšœè½¬ç§»ï¼Ÿ è°æ¥å½“é€‰æ–°çš„ä¸»èŠ‚ç‚¹ï¼Ÿ



**å“ªä¸ªå“¨å…µèŠ‚ç‚¹åˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ï¼Œè¿™ä¸ªå“¨å…µèŠ‚ç‚¹å°±æ˜¯å€™é€‰è€…**ï¼Œæ‰€è°“çš„å€™é€‰è€…å°±æ˜¯æƒ³å½“ leader çš„å“¨å…µ

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªå“¨å…µã€‚å½“å“¨å…µ B å…ˆåˆ¤æ–­åˆ°ä¸»èŠ‚ç‚¹ã€Œä¸»è§‚ä¸‹çº¿åã€ï¼Œå°±ä¼šç»™å…¶ä»–å®ä¾‹å‘é€ is-master-down-by-addr å‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œè¿æ¥æƒ…å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”



æ‰§è¡Œåˆ‡æ¢ä¹‹å‰è¿˜éœ€è¦åœ¨å“¨å…µé›†ç¾¤ä¸­é€‰å‡ºä¸€ä¸ª `leader`ï¼ˆæ ‡è®°å®¢è§‚ä¸‹çº¿çš„å“¨å…µå‘å…¶ä»–å“¨å…µå‘èµ·æŠ•ç¥¨ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥å½“é€‰`leader`ï¼‰ï¼Œè®© `leader` æ¥è¿›è¡Œåˆ‡æ¢æ“ä½œ

å€™é€‰è€…ä¼šå‘å…¶ä»–å“¨å…µå‘é€å‘½ä»¤ï¼Œè¡¨æ˜å¸Œæœ›æˆä¸º `leader` æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢ï¼Œå¹¶è®©æ‰€æœ‰å…¶ä»–å“¨å…µå¯¹å®ƒè¿›è¡ŒæŠ•ç¥¨ã€‚

æ¯ä¸ªå“¨å…µåªæœ‰ä¸€æ¬¡æŠ•ç¥¨æœºä¼šï¼Œå¦‚æœç”¨å®Œåå°±ä¸èƒ½å‚ä¸æŠ•ç¥¨äº†ï¼Œå¯ä»¥æŠ•ç»™è‡ªå·±æˆ–æŠ•ç»™åˆ«äººï¼Œä½†æ˜¯åªæœ‰å€™é€‰è€…æ‰èƒ½æŠŠç¥¨æŠ•ç»™è‡ªå·±ã€‚

é‚£ä¹ˆåœ¨æŠ•ç¥¨è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªã€Œå€™é€‰è€…ã€ï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

- ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›
- ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ `quorum` å€¼



ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾å“¨å…µèŠ‚ç‚¹æœ‰ 3 ä¸ªï¼Œ`quorum` è®¾ç½®ä¸º 2ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º `leader` çš„å“¨å…µåªè¦æ‹¿åˆ° 2 å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥é€‰ä¸¾æˆåŠŸäº†(**åŠ ä¸Šè‡ªå·±çš„ä¸€ç¥¨**)ã€‚å¦‚æœæ²¡æœ‰æ»¡è¶³æ¡ä»¶ï¼Œå°±éœ€è¦é‡æ–°è¿›è¡Œé€‰ä¸¾



> ä¸ºä»€ä¹ˆå“¨å…µèŠ‚ç‚¹è‡³å°‘è¦æœ‰ 3 ä¸ªï¼Ÿ

å¦‚æœå“¨å…µé›†ç¾¤ä¸­åªæœ‰ 2 ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶å¦‚æœä¸€ä¸ªå“¨å…µæƒ³è¦æˆåŠŸæˆä¸º Leaderï¼Œå¿…é¡»è·å¾— 2 ç¥¨ï¼Œè€Œä¸æ˜¯ 1 ç¥¨ã€‚

æ‰€ä»¥ï¼Œå¦‚æœå“¨å…µé›†ç¾¤ä¸­æœ‰ä¸ªå“¨å…µæŒ‚æ‰äº†ï¼Œé‚£ä¹ˆå°±åªå‰©ä¸€ä¸ªå“¨å…µäº†ï¼Œå¦‚æœè¿™ä¸ªå“¨å…µæƒ³è¦æˆä¸º Leaderï¼Œè¿™æ—¶ç¥¨æ•°å°±æ²¡åŠæ³•è¾¾åˆ° 2 ç¥¨ï¼Œå°±æ— æ³•æˆåŠŸæˆä¸º Leaderï¼Œè¿™æ—¶æ˜¯æ— æ³•è¿›è¡Œä¸»ä»èŠ‚ç‚¹åˆ‡æ¢çš„ã€‚

å› æ­¤ï¼Œé€šå¸¸æˆ‘ä»¬è‡³å°‘ä¼šé…ç½® 3 ä¸ªå“¨å…µèŠ‚ç‚¹ã€‚è¿™æ—¶ï¼Œå¦‚æœå“¨å…µé›†ç¾¤ä¸­æœ‰ä¸ªå“¨å…µæŒ‚æ‰äº†ï¼Œé‚£ä¹ˆè¿˜å‰©ä¸‹ä¸¤ä¸ªä¸ªå“¨å…µï¼Œå¦‚æœè¿™ä¸ªå“¨å…µæƒ³è¦æˆä¸º Leaderï¼Œè¿™æ—¶è¿˜æ˜¯æœ‰æœºä¼šè¾¾åˆ° 2 ç¥¨çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯å¯ä»¥é€‰ä¸¾æˆåŠŸçš„ï¼Œä¸ä¼šå¯¼è‡´æ— æ³•è¿›è¡Œä¸»ä»èŠ‚ç‚¹åˆ‡æ¢ã€‚



å†è¯´ä¸€ä¸ªé—®é¢˜ï¼ŒRedis 1 ä¸» 4 ä»ï¼Œ5 ä¸ªå“¨å…µ ï¼Œquorum è®¾ç½®ä¸º 3ï¼Œå¦‚æœ 2 ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»èŠ‚ç‚¹å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»èŠ‚ç‚¹â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿä¸»ä»èƒ½å¦è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ

- **å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹â€œå®¢è§‚ä¸‹çº¿â€**ã€‚å“¨å…µé›†ç¾¤è¿˜å‰©ä¸‹ 3 ä¸ªå“¨å…µï¼Œå½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»èŠ‚ç‚¹â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤– 2 ä¸ªå“¨å…µåï¼Œæœ‰å¯èƒ½èƒ½æ‹¿åˆ° 3 å¼ èµåŒç¥¨ï¼Œè¿™æ—¶å°±è¾¾åˆ°äº† quorum çš„å€¼ï¼Œå› æ­¤ï¼Œå“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ã€‚
- **å“¨å…µé›†ç¾¤å¯ä»¥å®Œæˆä¸»ä»åˆ‡æ¢**ã€‚å½“æœ‰ä¸ªå“¨å…µæ ‡è®°ä¸»èŠ‚ç‚¹ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€åï¼Œå°±ä¼šè¿›è¡Œé€‰ä¸¾ Leader çš„è¿‡ç¨‹ï¼Œå› ä¸ºæ­¤æ—¶å“¨å…µé›†ç¾¤è¿˜å‰©ä¸‹ 3 ä¸ªå“¨å…µï¼Œé‚£ä¹ˆè¿˜æ˜¯å¯ä»¥æ‹¿åˆ°åŠæ•°ä»¥ä¸Šï¼ˆ5/2+1=3ï¼‰çš„ç¥¨ï¼Œè€Œä¸”ä¹Ÿè¾¾åˆ°äº† quorum å€¼ï¼Œæ»¡è¶³äº†é€‰ä¸¾ Leader çš„ä¸¤ä¸ªæ¡ä»¶ï¼Œ æ‰€ä»¥å°±èƒ½é€‰ä¸¾æˆåŠŸï¼Œå› æ­¤å“¨å…µé›†ç¾¤å¯ä»¥å®Œæˆä¸»ä»åˆ‡æ¢ã€‚

å¦‚æœ quorum è®¾ç½®ä¸º 2 ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ã€‚æ­¤æ—¶å“¨å…µé›†ç¾¤è¿˜æ˜¯å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä½†æ˜¯å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢äº†ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ¨æ¼”ä¸‹ã€‚

å¦‚æœ quorum è®¾ç½®ä¸º 3ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ï¼Œå“¨å…µé›†ç¾¤å³ä¸èƒ½åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä¹Ÿä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢äº†ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œquorum ä¸º 2 çš„æ—¶å€™ï¼Œå¹¶ä¸”å¦‚æœæœ‰ 3 ä¸ªå“¨å…µæ•…éšœçš„è¯ï¼Œè™½ç„¶å¯ä»¥åˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€ï¼Œä½†æ˜¯ä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢ï¼Œè¿™æ ·æ„Ÿè§‰ã€Œåˆ¤å®šä¸»èŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿ã€è¿™ä»¶äº‹æƒ…ç™½åšäº†ä¸€æ ·ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œè¿˜ä¸å¦‚ä¸è¦åšï¼Œquorum ä¸º 3 çš„æ—¶å€™ï¼Œå°±å¯ä»¥é¿å…è¿™ç§æ— ç”¨åŠŸã€‚

æ‰€ä»¥ï¼Œ**quorum çš„å€¼å»ºè®®è®¾ç½®ä¸ºå“¨å…µä¸ªæ•°çš„äºŒåˆ†ä¹‹ä¸€åŠ 1**ï¼Œä¾‹å¦‚ 3 ä¸ªå“¨å…µå°±è®¾ç½® 2ï¼Œ5 ä¸ªå“¨å…µè®¾ç½®ä¸º 3ï¼Œè€Œä¸”**å“¨å…µèŠ‚ç‚¹çš„æ•°é‡åº”è¯¥æ˜¯å¥‡æ•°**ã€‚





æ€»ç»“ï¼šåœ¨`Redis`å“¨å…µä¸­ï¼Œ`quorum`å€¼ç”¨äºä¸¤ä¸ªæ–¹é¢ï¼š

1. åˆ¤æ–­èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿æ—¶çš„quorumå€¼ï¼šå½“å“¨å…µèŠ‚ç‚¹æ£€æµ‹åˆ°ä¸€ä¸ªRedisèŠ‚ç‚¹ä¸å¯ç”¨æ—¶ï¼Œå®ƒä¼šå‘å…¶ä»–å“¨å…µèŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ï¼Œå¦‚æœå¾—åˆ°çš„æŠ•ç¥¨æ•°è¶…è¿‡quorumå€¼ï¼Œå°±è®¤ä¸ºèŠ‚ç‚¹å®¢è§‚ä¸‹çº¿ï¼Œå¹¶é€šçŸ¥å…¶ä»–å“¨å…µèŠ‚ç‚¹åšå‡ºç›¸åŒçš„åˆ¤æ–­ã€‚
2. é€‰ä¸¾leaderæ—¶çš„quorumå€¼ï¼šå½“Redisä¸»èŠ‚ç‚¹å¤±æ•ˆæ—¶ï¼Œå“¨å…µèŠ‚ç‚¹ä¼šè¿›è¡Œé¢†å¯¼è€…é€‰ä¸¾ï¼Œæ¯ä¸ªå“¨å…µä¼šå¯¹å€™é€‰ä¸»èŠ‚ç‚¹è¿›è¡ŒæŠ•ç¥¨ï¼Œå¦‚æœå€™é€‰ä¸»èŠ‚ç‚¹å¾—åˆ°çš„æŠ•ç¥¨æ•°è¶…è¿‡quorumå€¼ï¼Œå®ƒå°†è¢«é€‰ä¸¾ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œåˆ¤æ–­èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿æ—¶çš„quorumå€¼å’Œé€‰ä¸¾leaderæ—¶çš„quorumå€¼æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¢«è®¾ç½®ä¸ºå“¨å…µèŠ‚ç‚¹çš„å¤§å¤šæ•°ï¼ˆmajorityï¼‰ï¼Œå³(N/2) + 1ï¼Œå…¶ä¸­Næ˜¯å“¨å…µèŠ‚ç‚¹çš„æ•°é‡ã€‚







> ä¸»ä»æ•…éšœè½¬ç§»æ“ä½œåŒ…æ‹¬å“ªäº›å†…å®¹ï¼Ÿ

ä¸»ä»æ•…éšœè½¬ç§»æ“ä½œåŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

- ç¬¬ä¸€æ­¥ï¼šåœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ã€‚
- ç¬¬äºŒæ­¥ï¼šè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›
- ç¬¬ä¸‰æ­¥ï¼šå°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œ**å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶**ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯(æ¯ä¸ªå“¨å…µèŠ‚ç‚¹æä¾›å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»å“¨å…µè®¢é˜…æ¶ˆæ¯)ï¼›
- ç¬¬å››æ­¥ï¼šç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E4%B8%BB%E4%BB%8E%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB.jpg)



1.é€‰å‡ºæ–°ä¸»èŠ‚ç‚¹  (å’Œå“¨å…µé€‰ä¸¾çš„æ„ä¹‰ä¸ä¸€æ ·ï¼Œè¿™æ¬¡é€‰ä¸¾æ˜¯é€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹)

æ•…éšœè½¬ç§»æ“ä½œç¬¬ä¸€æ­¥è¦åšçš„å°±æ˜¯åœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¸­ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªçŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´çš„ä»èŠ‚ç‚¹ï¼Œç„¶åå‘è¿™ä¸ªã€Œä»èŠ‚ç‚¹ã€å‘é€ `SLAVEOF no one` å‘½ä»¤(æ™‹å‡ä¸ºæ–°ä¸»èŠ‚ç‚¹)ï¼Œå°†è¿™ä¸ªã€Œä»èŠ‚ç‚¹ã€è½¬æ¢ä¸ºã€Œä¸»èŠ‚ç‚¹ã€

å…·ä½“æ˜¯æ€ä¹ˆæŒ‘é€‰çš„å‘¢ï¼Ÿ

- ç¬¬ä¸€è½®è€ƒå¯Ÿï¼šå“¨å…µé¦–å…ˆä¼šæ ¹æ®ä»èŠ‚ç‚¹çš„ä¼˜å…ˆçº§æ¥è¿›è¡Œæ’åºï¼Œä¼˜å…ˆçº§è¶Šé«˜æ’åè¶Šé å‰( `slave-priority` é…ç½®é¡¹)ï¼Œ
- ç¬¬äºŒè½®è€ƒå¯Ÿï¼šå¦‚æœä¼˜å…ˆçº§ç›¸åŒï¼Œåˆ™æŸ¥çœ‹å¤åˆ¶çš„ä¸‹æ ‡ï¼Œå“ªä¸ªä»ã€Œä¸»èŠ‚ç‚¹ã€æ¥æ”¶çš„å¤åˆ¶æ•°æ®å¤šï¼Œå“ªä¸ªå°±é å‰
- ç¬¬ä¸‰è½®è€ƒå¯Ÿï¼šå¦‚æœä¼˜å…ˆçº§å’Œä¸‹æ ‡éƒ½ç›¸åŒï¼Œå°±é€‰æ‹©ä»èŠ‚ç‚¹ ID è¾ƒå°çš„é‚£ä¸ª





2.å°†ä»èŠ‚ç‚¹æŒ‡å‘æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹

å½“æ–°ä¸»èŠ‚ç‚¹å‡ºç°ä¹‹åï¼Œå“¨å…µ leader ä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯ï¼Œè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€æŒ‡å‘ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼Œè¿™ä¸€åŠ¨ä½œå¯ä»¥é€šè¿‡å‘ã€Œä»èŠ‚ç‚¹ã€å‘é€ `SLAVEOF` å‘½ä»¤æ¥å®ç°ã€‚





3.é€šçŸ¥å®¢æˆ·çš„ä¸»èŠ‚ç‚¹å·²æ›´æ¢

æ¯ä¸ªå“¨å…µèŠ‚ç‚¹æä¾›å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»å“¨å…µè®¢é˜…æ¶ˆæ¯ã€‚

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/%E5%93%A8%E5%85%B5/%E5%93%A8%E5%85%B5%E9%A2%91%E9%81%93.webp" alt="img" style="zoom:50%;" />

å®¢æˆ·ç«¯å’Œå“¨å…µå»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯ä¼šè®¢é˜…å“¨å…µæä¾›çš„é¢‘é“ã€‚**ä¸»ä»åˆ‡æ¢å®Œæˆåï¼Œå“¨å…µå°±ä¼šå‘ `+switch-master` é¢‘é“å‘å¸ƒæ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œç«¯å£çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±å¯ä»¥æ”¶åˆ°è¿™æ¡ä¿¡æ¯ï¼Œç„¶åç”¨è¿™é‡Œé¢çš„æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œç«¯å£è¿›è¡Œé€šä¿¡äº†**





4.å°†æ—§ä¸»èŠ‚ç‚¹å˜ä¸ºä»èŠ‚ç‚¹

æ•…éšœè½¬ç§»æ“ä½œæœ€åè¦åšçš„æ˜¯ï¼Œç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“æ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå“¨å…µé›†ç¾¤å°±ä¼šå‘å®ƒå‘é€ `SLAVEOF` å‘½ä»¤ï¼Œè®©å®ƒæˆä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹











:grey_exclamation: :heavy_exclamation_mark: :exclamation: æœ€åæ€»ç»“ä¸€ä¸‹ï¼š

 

å“¨å…µä¸€èˆ¬æ˜¯ä»¥é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œè‡³å°‘éœ€è¦ 3 ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œå“¨å…µé›†ç¾¤ä¸»è¦è´Ÿè´£ä¸‰ä»¶äº‹æƒ…ï¼š**ç›‘æ§ã€é€‰ä¸»ã€é€šçŸ¥**ã€‚

å“¨å…µèŠ‚ç‚¹é€šè¿‡ Redis çš„å‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ï¼Œå“¨å…µä¹‹é—´å¯ä»¥ç›¸äº’æ„ŸçŸ¥ï¼Œç›¸äº’è¿æ¥ï¼Œç„¶åç»„æˆå“¨å…µé›†ç¾¤ï¼ŒåŒæ—¶å“¨å…µåˆé€šè¿‡ INFO å‘½ä»¤ï¼Œåœ¨ä¸»èŠ‚ç‚¹é‡Œè·å¾—äº†æ‰€æœ‰ä»èŠ‚ç‚¹è¿æ¥ä¿¡æ¯ï¼Œäºæ˜¯å°±èƒ½å’Œä»èŠ‚ç‚¹å»ºç«‹è¿æ¥ï¼Œå¹¶è¿›è¡Œç›‘æ§äº†ã€‚



*1ã€ç¬¬ä¸€è½®æŠ•ç¥¨ï¼šåˆ¤æ–­ä¸»èŠ‚ç‚¹ä¸‹çº¿*

å½“å“¨å…µé›†ç¾¤ä¸­çš„æŸä¸ªå“¨å…µåˆ¤å®šä¸»èŠ‚ç‚¹ä¸‹çº¿ï¼ˆä¸»è§‚ä¸‹çº¿ï¼‰åï¼Œå°±ä¼šå‘å…¶ä»–å“¨å…µå‘èµ·å‘½ä»¤ï¼Œå…¶ä»–å“¨å…µæ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæ ¹æ®è‡ªèº«å’Œä¸»èŠ‚ç‚¹çš„ç½‘ç»œçŠ¶å†µï¼Œåšå‡ºèµæˆæŠ•ç¥¨æˆ–è€…æ‹’ç»æŠ•ç¥¨çš„å“åº”ã€‚

å½“è¿™ä¸ªå“¨å…µçš„èµåŒç¥¨æ•°è¾¾åˆ°å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹è®¾å®šçš„å€¼åï¼Œè¿™æ—¶ä¸»èŠ‚ç‚¹å°±ä¼šè¢«è¯¥å“¨å…µæ ‡è®°ä¸ºã€Œå®¢è§‚ä¸‹çº¿ã€ã€‚



*2ã€ç¬¬äºŒè½®æŠ•ç¥¨ï¼šé€‰å‡ºå“¨å…µleader*

æŸä¸ªå“¨å…µåˆ¤å®šä¸»èŠ‚ç‚¹å®¢è§‚ä¸‹çº¿åï¼Œè¯¥å“¨å…µå°±ä¼šå‘èµ·æŠ•ç¥¨ï¼Œå‘Šè¯‰å…¶ä»–å“¨å…µï¼Œå®ƒæƒ³æˆä¸º leaderï¼Œæƒ³æˆä¸º leader çš„å“¨å…µèŠ‚ç‚¹ï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

- ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›
- ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚





*3ã€ç”±å“¨å…µ leader è¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»*

é€‰ä¸¾å‡ºäº†å“¨å…µ leader åï¼Œå°±å¯ä»¥è¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹äº†ã€‚è¯¥æ“ä½œåŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š

- ç¬¬ä¸€æ­¥ï¼šåœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©çš„è§„åˆ™ï¼š
  - è¿‡æ»¤æ‰å·²ç»ç¦»çº¿çš„ä»èŠ‚ç‚¹ï¼›
  - è¿‡æ»¤æ‰å†å²ç½‘ç»œè¿æ¥çŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹ï¼›
  - å°†å‰©ä¸‹çš„ä»èŠ‚ç‚¹ï¼Œè¿›è¡Œä¸‰è½®è€ƒå¯Ÿï¼šä¼˜å…ˆçº§ã€å¤åˆ¶è¿›åº¦ã€ID å·ã€‚åœ¨æ¯ä¸€è½®è€ƒå¯Ÿè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªèƒœå‡ºçš„ä»èŠ‚ç‚¹ï¼Œå°±å°†å…¶ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ã€‚
- ç¬¬äºŒæ­¥ï¼šè®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›
- ç¬¬ä¸‰æ­¥ï¼šå°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œå‘å¸ƒè€…/è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼›
- ç¬¬å››æ­¥ï¼šç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼›









### é›†ç¾¤



Redis çš„å“¨å…µæ¨¡å¼è™½ç„¶å·²ç»å¯ä»¥å®ç°é«˜å¯ç”¨ï¼Œè¯»å†™åˆ†ç¦» ï¼Œä½†æ˜¯å­˜åœ¨å‡ ä¸ªæ–¹é¢çš„ä¸è¶³ï¼š

- å“¨å…µæ¨¡å¼ä¸‹æ¯å° Redis æœåŠ¡å™¨éƒ½å­˜å‚¨ç›¸åŒçš„æ•°æ®ï¼Œå¾ˆæµªè´¹å†…å­˜ç©ºé—´ï¼›æ•°æ®é‡å¤ªå¤§ï¼Œä¸»ä»åŒæ­¥æ—¶ä¸¥é‡å½±å“äº†masteræ€§èƒ½ã€‚
- å“¨å…µæ¨¡å¼æ˜¯ä¸­å¿ƒåŒ–çš„é›†ç¾¤å®ç°æ–¹æ¡ˆï¼Œæ¯ä¸ªä»æœºå’Œä¸»æœºçš„è€¦åˆåº¦å¾ˆé«˜ï¼Œmasterå®•æœºåˆ°salveé€‰ä¸¾masteræ¢å¤æœŸé—´æœåŠ¡ä¸å¯ç”¨ã€‚
- å“¨å…µæ¨¡å¼å§‹ç»ˆåªæœ‰ä¸€ä¸ªRedisä¸»æœºæ¥æ¥æ”¶å’Œå¤„ç†å†™è¯·æ±‚ï¼Œå†™æ“ä½œè¿˜æ˜¯å—å•æœºç“¶é¢ˆå½±å“ï¼Œæ²¡æœ‰å®ç°çœŸæ­£çš„åˆ†å¸ƒå¼æ¶æ„ã€‚



 Redis3.0 ä¸ŠåŠ å…¥äº† `Cluster` é›†ç¾¤æ¨¡å¼ï¼ˆRedisé›†ç¾¤æ˜¯å»ä¸­å¿ƒåŒ–çš„é›†ç¾¤æ¶æ„ï¼‰ï¼ŒåŒæ—¶å®ç°äº† Redis çš„åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆå¯¹æ•°æ®è¿›è¡Œ**åˆ†ç‰‡**ï¼Œä¹Ÿå°±æ˜¯è¯´**æ¯å° Redis èŠ‚ç‚¹ä¸Šå­˜å‚¨ä¸åŒçš„å†…å®¹**ï¼‰

`Redis Cluster`æ˜¯ä¸€ç§æœåŠ¡å™¨`Sharding`æŠ€æœ¯(åˆ†ç‰‡å’Œè·¯ç”±éƒ½æ˜¯åœ¨æœåŠ¡ç«¯å®ç°)ï¼Œé‡‡ç”¨å¤šä¸»å¤šä»ï¼Œæ¯ä¸€ä¸ªåˆ†åŒºéƒ½æ˜¯ç”±ä¸€ä¸ªRedisä¸»æœºå’Œå¤šä¸ªä»æœºç»„æˆï¼Œç‰‡åŒºå’Œç‰‡åŒºä¹‹é—´æ˜¯ç›¸äº’å¹³è¡Œçš„ã€‚`Redis Cluster`é›†ç¾¤é‡‡ç”¨äº†P2Pçš„æ¨¡å¼ï¼Œå®Œå…¨å»ä¸­å¿ƒåŒ–



> ä»€ä¹ˆæ˜¯æœåŠ¡å™¨`Sharding`ï¼Ÿ
>
> 
>
> å½“åº”ç”¨ç¨‹åºçš„æ•°æ®é‡é€æ¸å¢å¤§ï¼Œå•å°æœåŠ¡å™¨å¯èƒ½æ— æ³•æ‰¿è½½å…¨éƒ¨æ•°æ®å’Œè´Ÿè½½ã€‚æœåŠ¡å™¨`Sharding`æŠ€æœ¯å°†æ•°æ®åˆ†æˆå¤šä¸ªè¾ƒå°çš„æ•°æ®é›†ï¼Œæ¯ä¸ªæ•°æ®é›†ç§°ä¸ºä¸€ä¸ªåˆ†ç‰‡ï¼ˆ`Shard`ï¼‰ï¼Œå¹¶å°†æ¯ä¸ªåˆ†ç‰‡å­˜å‚¨åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚è¿™æ ·ï¼Œæ¯å°æœåŠ¡å™¨åªéœ€è¦å¤„ç†å…¶ä¸­ä¸€ä¸ªæˆ–ä¸€éƒ¨åˆ†åˆ†ç‰‡çš„æ•°æ®ï¼Œä»è€Œæœ‰æ•ˆåœ°åˆ†æ•£äº†è´Ÿè½½å’Œæ•°æ®å­˜å‚¨
>
> 
>
> æœåŠ¡å™¨`Sharding`æŠ€æœ¯çš„ä¸€äº›å…³é”®ç‰¹ç‚¹å’Œä¼˜åŠ¿åŒ…æ‹¬ï¼š
>
> 1. æ‰©å±•æ€§ï¼šé€šè¿‡å°†æ•°æ®åˆ†å¸ƒåœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥æ°´å¹³æ‰©å±•ç³»ç»Ÿï¼Œæ”¯æŒæ›´å¤§çš„æ•°æ®é‡å’Œæ›´é«˜çš„å¹¶å‘è¯·æ±‚ã€‚
> 2. æ€§èƒ½ï¼šåˆ†ç‰‡å¯ä»¥ä½¿æŸ¥è¯¢å’Œå†™å…¥æ“ä½œåœ¨å¤šå°æœåŠ¡å™¨ä¸Šå¹¶è¡Œæ‰§è¡Œï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„å“åº”æ€§èƒ½ã€‚
> 3. å®¹é”™æ€§ï¼šå½“ä¸€å°æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œå…¶ä»–æœåŠ¡å™¨ä¸Šçš„åˆ†ç‰‡ä»ç„¶å¯ç”¨ï¼Œä¿éšœç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚
> 4. çµæ´»æ€§ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚åŠ¨æ€æ·»åŠ æˆ–åˆ é™¤åˆ†ç‰‡ï¼Œä»¥é€‚åº”æ•°æ®é‡çš„å˜åŒ–ã€‚
> 5. æ•°æ®éš”ç¦»ï¼šå°†æ•°æ®åˆ†ç‰‡å­˜å‚¨åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥æé«˜æ•°æ®çš„éš”ç¦»æ€§ï¼Œå‡å°‘å•ä¸€æ•…éšœç‚¹çš„é£é™©ã€‚



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E9%9B%86%E7%BE%A4.jpg)



è¿™é‡Œçš„ 6 å° redisèŠ‚ç‚¹ä¸¤ä¸¤ä¹‹é—´å¹¶ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šé€šè¿‡é›†ç¾¤æ€»çº¿(cluster bus)ä¸å…¶ä»–çš„èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼ˆGossipåè®®ï¼‰ï¼ŒRedis é›†ç¾¤æœ‰16384 ä¸ªå“ˆå¸Œæ§½ï¼Œå½“æˆ‘ä»¬å­˜å–keyçš„æ—¶å€™ï¼Œæ¯ä¸ª key é€šè¿‡ CRC16 æ ¡éªŒåå¾—åˆ°ä¸€ä¸ªç»“æœï¼ŒæŠŠç»“æœå¯¹ 16384 å–æ¨¡ï¼Œæ¥å†³å®šæ”¾ç½®å“ªä¸ªæ§½ï¼Œé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†hashæ§½ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚å½“å‰é›†ç¾¤æœ‰3ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆï¼š

- èŠ‚ç‚¹ A åŒ…å« 0 åˆ° 5460 å·å“ˆå¸Œæ§½
- èŠ‚ç‚¹ B åŒ…å« 5461 åˆ° 10922 å·å“ˆå¸Œæ§½
- èŠ‚ç‚¹ C åŒ…å« 10923 åˆ° 16383 å·å“ˆå¸Œæ§½

ä½¿ç”¨å“ˆå¸Œæ§½çš„å¥½å¤„å°±åœ¨äºå¯ä»¥æ–¹ä¾¿çš„æ·»åŠ æˆ–è€…ç§»é™¤èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ— è®ºæ˜¯æ·»åŠ åˆ é™¤æˆ–è€…ä¿®æ”¹æŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½ä¸ä¼šé€ æˆé›†ç¾¤ä¸å¯ç”¨çš„çŠ¶æ€ã€‚å½“éœ€è¦å¢åŠ èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠå…¶ä»–èŠ‚ç‚¹çš„æŸäº›å“ˆå¸Œæ§½æŒªåˆ°æ–°èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼›å½“éœ€è¦ç§»é™¤èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠç§»é™¤èŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½æŒªåˆ°å…¶ä»–æ—§èŠ‚ç‚¹å°±è¡Œäº†



Clusteræ¨¡å¼é›†ç¾¤èŠ‚ç‚¹æœ€å°é…ç½®6ä¸ªèŠ‚ç‚¹(3ä¸»3ä»ï¼Œå› ä¸ºéœ€è¦åŠæ•°ä»¥ä¸Š)ï¼Œå…¶ä¸­**ä¸»èŠ‚ç‚¹æä¾›è¯»å†™æ“ä½œï¼Œä»èŠ‚ç‚¹ä½œä¸ºå¤‡ç”¨èŠ‚ç‚¹ï¼Œä¸æä¾›è¯·æ±‚ï¼Œåªä½œä¸ºæ•…éšœè½¬ç§»ä½¿ç”¨**



> Gossipåè®®æ˜¯ä¸€ç§ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­èŠ‚ç‚¹ä¹‹é—´é€šä¿¡å’Œä¿¡æ¯ä¼ æ’­çš„åè®®ã€‚å®ƒå¾—åäº"æµè¨€"ï¼ˆgossipï¼‰è¿™ä¸ªè¯ï¼Œç±»æ¯”äºèŠ‚ç‚¹ä¹‹é—´åƒä¼ æ’­è°£è¨€ä¸€æ ·ç›¸äº’äº¤æ¢ä¿¡æ¯çš„è¿‡ç¨‹ã€‚Gossipåè®®æ˜¯ä¸€ç§å»ä¸­å¿ƒåŒ–çš„ã€è‡ªç»„ç»‡çš„åè®®ï¼Œæ²¡æœ‰å•ä¸€çš„ä¸­å¤®èŠ‚ç‚¹ï¼Œæ‰€æœ‰èŠ‚ç‚¹å¹³ç­‰å‚ä¸ä¿¡æ¯ä¼ æ’­ã€‚
>
> åœ¨Gossipåè®®ä¸­**ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå‘¨æœŸæ€§åœ°é€‰æ‹©å‡ ä¸ªé‚»å±…èŠ‚ç‚¹ï¼ˆé€šå¸¸ç§°ä¸ºä¼™ä¼´èŠ‚ç‚¹ï¼‰ï¼Œç„¶åä¸è¿™äº›ä¼™ä¼´èŠ‚ç‚¹äº¤æ¢ä¿¡æ¯**ã€‚ä¿¡æ¯å¯ä»¥æ˜¯èŠ‚ç‚¹çŠ¶æ€ã€æ•°æ®ã€äº‹ä»¶ç­‰ã€‚èŠ‚ç‚¹ä¹‹é—´çš„ä¿¡æ¯ä¼ æ’­æ˜¯é€šè¿‡ç›¸äº’äº¤æ¢æ¶ˆæ¯æ¥å®ç°çš„ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°ä¿¡æ¯åä¼šå°†å…¶ä¼ æ’­ç»™å…¶å®ƒèŠ‚ç‚¹ï¼Œä»è€Œä½¿å¾—ä¿¡æ¯åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä¼ æ’­ã€‚
>
> Gossipåè®®æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
>
> 1. éšæœºæ€§ï¼šGossipåè®®ä¸­ï¼ŒèŠ‚ç‚¹é€‰æ‹©ä¼™ä¼´èŠ‚ç‚¹çš„è¿‡ç¨‹é€šå¸¸æ˜¯éšæœºçš„ã€‚è¿™ç§éšæœºæ€§å¯ä»¥å¸®åŠ©ä¿¡æ¯æ›´å¿«åœ°åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ä¼ æ’­ï¼Œé¿å…ä¿¡æ¯èšé›†åœ¨æŸäº›èŠ‚ç‚¹ä¸Šã€‚
> 2. æ²»æ„ˆæ€§ï¼šèŠ‚ç‚¹ä¸æ–­åœ°ä¸ä¼™ä¼´èŠ‚ç‚¹äº¤æ¢ä¿¡æ¯ï¼Œå°†ä¿¡æ¯ä¼ æ’­ç»™å…¶ä»–èŠ‚ç‚¹ã€‚è¿™ç§äº¤æ¢è¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼äºä¼ æŸ“ç—…çš„ä¼ æ’­ï¼Œä¸€æ—¦ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°ä¿¡æ¯ï¼Œå®ƒå°±ä¼šå°†ä¿¡æ¯ä¼ æ’­ç»™å…¶å®ƒèŠ‚ç‚¹ï¼Œä»è€Œå®ç°ä¿¡æ¯çš„å¿«é€Ÿä¼ æ’­å’Œæ²»æ„ˆã€‚
> 3. è‡ªé€‚åº”æ€§ï¼šGossipåè®®æ˜¯ä¸€ç§è‡ªé€‚åº”çš„åè®®ã€‚èŠ‚ç‚¹ä¹‹é—´æ ¹æ®å®é™…çš„ç½‘ç»œçŠ¶æ€å’Œè´Ÿè½½æƒ…å†µæ¥é€‰æ‹©ä¼™ä¼´èŠ‚ç‚¹ï¼Œè¿™ä½¿å¾—åè®®èƒ½å¤Ÿåœ¨ä¸åŒçš„ç½‘ç»œç¯å¢ƒä¸‹è¿›è¡Œé€‚åº”å’Œä¼˜åŒ–ã€‚

Redisé›†ç¾¤é‡‡ç”¨æ— ä¸­å¿ƒç»“æ„,å®ƒçš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š

1. æ‰€æœ‰çš„redisèŠ‚ç‚¹å½¼æ­¤äº’è”(PING-PONGæœºåˆ¶),å†…éƒ¨ä½¿ç”¨äºŒè¿›åˆ¶åè®®ä¼˜åŒ–ä¼ è¾“é€Ÿåº¦å’Œå¸¦å®½
2. **èŠ‚ç‚¹çš„failæ˜¯é€šè¿‡é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æ£€æµ‹å¤±æ•ˆæ—¶æ‰ç”Ÿæ•ˆ**
3. å®¢æˆ·ç«¯ä¸redisèŠ‚ç‚¹ç›´è¿,ä¸éœ€è¦ä¸­é—´ä»£ç†å±‚ã€‚å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹,è¿æ¥é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯





#### æ•…éšœè½¬ç§»

Redisé›†ç¾¤é€šè¿‡ping/pongæ¶ˆæ¯ï¼Œå®ç°æ•…éšœå‘ç°ã€‚è¿™ä¸ªç¯å¢ƒåŒ…æ‹¬**ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿**ï¼š

**ä¸»è§‚ä¸‹çº¿ï¼š** æŸä¸ªèŠ‚ç‚¹è®¤ä¸ºå¦ä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå³ä¸‹çº¿çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€å¹¶ä¸æ˜¯ç»ˆçš„æ•…éšœåˆ¤å®šï¼Œåªèƒ½ä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹çš„æ„è§ï¼Œ**å¯èƒ½å­˜åœ¨è¯¯åˆ¤æƒ…å†µ**

**å®¢è§‚ä¸‹çº¿ï¼š** æŒ‡æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹çœŸæ­£çš„ä¸‹çº¿ï¼Œé›†ç¾¤å†…å¤šä¸ªèŠ‚ç‚¹éƒ½è®¤ä¸ºè¯¥èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œä»è€Œè¾¾æˆå…±è¯†çš„ç»“æœã€‚å¦‚æœæ˜¯æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹æ•…éšœï¼Œéœ€è¦ä¸ºè¯¥èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼ˆmaster-slaveåˆ‡æ¢ï¼‰

æ•…éšœå‘ç°åï¼Œå¦‚æœä¸‹çº¿èŠ‚ç‚¹çš„æ˜¯ä¸»èŠ‚ç‚¹ï¼Œåˆ™éœ€è¦åœ¨å®ƒçš„ä»èŠ‚ç‚¹ä¸­é€‰ä¸€ä¸ªæ›¿æ¢å®ƒï¼Œä»¥ä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨





## ç¼“å­˜ç›¸å…³é—®é¢˜ :baby_chick:



![å›¾ç‰‡](https://cdn.xiaolincoding.com//mysql/other/061e2c04e0ebca3425dd75dd035b6b7b.png)





### ç¼“å­˜ç©¿é€

ç¼“å­˜ç©¿é€æ˜¯æŒ‡ç”¨æˆ·ä¸æ–­è¯·æ±‚**ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„ä¿¡æ¯ï¼ˆæŸ¥è¯¢ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„æ•°æ®ï¼ï¼‰**ï¼Œç”±äºç¼“å­˜æ˜¯ä¸å‘½ä¸­æ—¶è¢«åŠ¨å†™çš„ï¼Œå¹¶ä¸”å‡ºäºå®¹é”™è€ƒè™‘ï¼Œå¦‚æœä»å­˜å‚¨å±‚æŸ¥ä¸åˆ°æ•°æ®åˆ™ä¸å†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ°å­˜å‚¨å±‚å»æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ã€‚åœ¨æµé‡å¤§æ—¶ï¼Œå¯èƒ½DBå°±æŒ‚æ‰äº†ï¼Œè¦æ˜¯**æœ‰äººåˆ©ç”¨ä¸å­˜åœ¨çš„keyé¢‘ç¹æ”»å‡»åº”ç”¨ï¼Œå¦‚å‘èµ·è¯·æ±‚ä¸ºidä¸ºâ€œ-1â€çš„æ•°æ®æˆ–idä¸ºç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ã€‚å°±ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§**

è§£å†³æ–¹æ¡ˆï¼š

1. æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼ŒidåšåŸºç¡€æ ¡éªŒï¼Œid<=0çš„ç›´æ¥æ‹¦æˆªï¼›
2. ä»ç¼“å­˜æŸ¥ä¸åˆ°ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹ŸæŸ¥ä¸åˆ°çš„æ•°æ®ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå†™ä¸ºkey-nullï¼ˆæ¯”å¦‚ä¸€ä¸ªè¯·æ±‚æŸ¥è¯¢id=-1ï¼ŒæŸ¥ä¸åˆ°æ•°æ®åº“åç…§æ ·å°†è¯¥å€¼ç¼“å­˜åˆ°redisä¸­ï¼š**redisä¸­ç¼“å­˜ä¸€ä¸ªkeyä¸º-1ï¼Œvalueä¸ºnullçš„é”®å€¼å¯¹**ï¼‰ï¼ŒåŒæ—¶å¿…é¡»è®¾ç½®ç¼“å­˜æ—¶é—´ï¼ˆé˜²æ­¢ä¸‡ä¸€ä»¥åçœŸçš„æ·»åŠ äº†å¯¹åº”idçš„æ•°æ®è¡Œï¼Œå¦‚æœä¸è®¾ç½®è¿‡æœŸæ—¶é—´ç›´æ¥èµ°ç¼“å­˜å°±ä¼šè¿”å›ä¸€ä¸ªnullå€¼ï¼‰ï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»ï¼›
3. [å¸ƒéš†è¿‡æ»¤å™¨][https://javaguide.cn/cs-basics/data-structure/bloom-filter.html]ï¼šbloomfilterå°±ç±»ä¼¼äºä¸€ä¸ªhashsetï¼Œç”¨äºå¿«é€Ÿåˆ¤æŸä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­ï¼Œå…¶å…¸å‹çš„åº”ç”¨åœºæ™¯å°±æ˜¯å¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªkeyæ˜¯å¦å­˜åœ¨äºæŸå®¹å™¨ï¼Œä¸å­˜åœ¨å°±ç›´æ¥è¿”å›ã€‚å¸ƒéš†è¿‡æ»¤å™¨çš„å…³é”®å°±åœ¨äºhashç®—æ³•å’Œå®¹å™¨å¤§å°

>æ¯”å¦‚å½“æŸä¸€ä¸ªå­—ç¬¦ä¸²å­˜å‚¨è¦åŠ å…¥åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼Œè¯¥å­—ç¬¦ä¸²é¦–å…ˆç”±**å¤šä¸ªå“ˆå¸Œå‡½æ•°ç”Ÿæˆä¸åŒçš„å“ˆå¸Œå€¼**ï¼Œç„¶åå°†å¯¹åº”çš„ä½æ•°ç»„çš„ä¸‹æ ‡è®¾ç½®ä¸º 1ï¼ˆå½“ä½æ•°ç»„åˆå§‹åŒ–æ—¶ï¼Œæ‰€æœ‰ä½ç½®å‡ä¸º 0ï¼‰ã€‚å½“ç¬¬äºŒæ¬¡å­˜å‚¨ç›¸åŒå­—ç¬¦ä¸²æ—¶ï¼Œå› ä¸ºå…ˆå‰çš„å¯¹åº”ä½ç½®å·²è®¾ç½®ä¸º 1ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“çŸ¥é“æ­¤å€¼å·²ç»å­˜åœ¨ï¼ˆå»é‡éå¸¸æ–¹ä¾¿ï¼‰ï¼›
>
>å¦‚æœæˆ‘ä»¬éœ€è¦åˆ¤æ–­æŸä¸ªå­—ç¬¦ä¸²æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼Œåªéœ€è¦å¯¹ç»™å®šå­—ç¬¦ä¸²å†æ¬¡å¤šæ¬¡è¿›è¡Œç›¸åŒçš„å“ˆå¸Œå‡½æ•°è®¡ç®—ï¼Œå¾—åˆ°å€¼ä¹‹å**åˆ¤æ–­ä½æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º 1ï¼Œå¦‚æœå€¼éƒ½ä¸º 1ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªå€¼ä¸ä¸º 1ï¼Œè¯´æ˜è¯¥å…ƒç´ ä¸åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚**
>
>
>
>å½“åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå°†è¯¥å…ƒç´ é€šè¿‡ç›¸åŒçš„å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºä½æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœæ‰€æœ‰ä½ç½®ä¸Šçš„ä½éƒ½ä¸º1ï¼Œåˆ™è¯´æ˜å…ƒç´ å¯èƒ½å­˜åœ¨äºé›†åˆä¸­ï¼›å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªä½ç½®çš„ä½ä¸º0ï¼Œåˆ™è¯´æ˜å…ƒç´ è‚¯å®šä¸å­˜åœ¨äºé›†åˆä¸­ã€‚







### ç¼“å­˜å‡»ç©¿

**ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡å¤§é‡å¹¶å‘è®¿é—®åŒä¸€ä¸ªçƒ­ç‚¹æ•°æ®ï¼ˆç¼“å­˜é›ªå´©æ˜¯å¤šä¸ªæ•°æ®ï¼‰**æ—¶ï¼Œå½“è¯¥çƒ­ç‚¹æ•°æ®ç¼“å­˜å¤±æ•ˆååŒæ—¶è¯·æ±‚æ•°æ®åº“ï¼Œç¬é—´è€—å°½æ•°æ®åº“èµ„æºï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§

è§£å†³æ–¹æ¡ˆï¼š

1. è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸ
2. ä»…å¯¹æŸ¥è¯¢æ•°æ®åº“çš„ä¸šåŠ¡é€»è¾‘ä»£ç å—æ¥è®¾ç½®åŒæ­¥é”`synchronized(this)`

> æ¯”å¦‚æŸ¥è¯¢é€»è¾‘è°ƒç”¨çš„serviceä¸ºPublishServiceImpl,ç”±äºåœ¨å¯¹åº”çš„ServiceImplä¸Šè®¾ç½®äº†**@Service**æ³¨è§£ï¼Œæ•…è¯¥ç±»çš„å®ä¾‹ä¼šè¢«æ³¨å…¥åˆ°Springå®¹å™¨ä¸­ï¼Œè€ŒSpringé»˜è®¤Beanä¸ºå•ä¾‹çš„ï¼ˆ**Singleton**ï¼‰,å› æ­¤å¦‚æœå¤šä¸ªçº¿ç¨‹è¯·æ±‚è¿‡æ¥å…±äº«è¿™ä¸€ä¸ªå®ä¾‹ï¼Œå³å…±äº«è¿™ä¸€ä¸ªé”

3. **ç¼“å­˜é¢„çƒ­ï¼š**åœ¨ç³»ç»Ÿå¯åŠ¨æˆ–è€…æŸä¸ªæ—¶é—´ç‚¹ï¼Œæå‰åŠ è½½çƒ­é—¨æ•°æ®åˆ°ç¼“å­˜ä¸­ï¼Œé¿å…åœ¨é«˜å¹¶å‘æ—¶å¤§é‡è¯·æ±‚è®¿é—®ç¼“å­˜å¤±æ•ˆçš„æ•°æ®









### ç¼“å­˜é›ªå´©

ç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜ä¸­å¤§æ‰¹æ•°æ®ä¸€èµ·è¿‡æœŸï¼Œæ­¤æ—¶å¦‚æœå¤–æ¥è¯·æ±‚è¿‡å¤šï¼Œä½¿å¾—å¤§é‡è¯·æ±‚ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³å®•æœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œ**ç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯å¤§é‡ä¸åŒæ•°æ®ä¸€èµ·è¿‡æœŸäº†**

è§£å†³æ–¹æ¡ˆï¼š


1. å¯¹ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿã€‚

2. å¦‚æœç¼“å­˜æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒçš„ç¼“å­˜æ•°æ®åº“ä¸­ã€‚

3. ä½¿ç”¨`synchronized`åŒæ­¥é”æ§åˆ¶æŸ¥è¯¢æ•°æ®åº“çš„çº¿ç¨‹ï¼ˆå¹¶å‘åº¦å¾ˆä½ï¼‰
4. ä¸ç”¨ç­‰åˆ°è¯·æ±‚åˆ°æ¥å†å»æŸ¥è¯¢æ•°æ®åº“æ—¶æ‰å­˜å…¥ç¼“å­˜ï¼Œå¯ä»¥æå‰å°†æ•°æ®å­˜å…¥ç¼“å­˜ä¸­ï¼Œåå°é€šå¸¸æœ‰**å®šæ—¶ä»»åŠ¡å°†æ•°æ®åº“ä¸­çš„æ•°æ®å­˜å…¥ç¼“å­˜**









### æ•°æ®åº“ä¸ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜  

å…ˆæŠ›ç»“è®ºï¼š**åœ¨æ»¡è¶³å®æ—¶æ€§çš„æ¡ä»¶ä¸‹ï¼Œä¸å­˜åœ¨ä¸¤è€…å®Œå…¨ä¿å­˜ä¸€è‡´çš„æ–¹æ¡ˆï¼Œåªæœ‰æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis-shuju-yizhixing.png" style="zoom:67%;" />



**1ã€å…ˆå†™Mysql å†å†™Redis**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis-shuju-yizhixing-1.png)



> å›¾è§£è¯´æ˜ï¼š
>
> - è¿™æ˜¯ä¸€å‰¯æ—¶åºå›¾ï¼Œæè¿°è¯·æ±‚çš„å…ˆåè°ƒç”¨é¡ºåºã€çºµè½´è¡¨ç¤ºæ—¶é—´ï¼›
> - æ©˜é»„è‰²çš„çº¿æ˜¯è¯·æ±‚ Aï¼Œé»‘è‰²çš„çº¿æ˜¯è¯·æ±‚ Bï¼›
> - æ©˜é»„è‰²çš„æ–‡å­—ï¼Œæ˜¯ MySQL å’Œ Redis æœ€ç»ˆä¸ä¸€è‡´çš„æ•°æ®ï¼›
> - æ•°æ®æ˜¯ä» 10 æ›´æ–°ä¸º 11ï¼›

è¯·æ±‚ Aã€B éƒ½æ˜¯å…ˆå†™ MySQLï¼Œç„¶åå†å†™ Redisï¼Œ**åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚ A åœ¨å†™ Redis æ—¶å¡äº†ä¸€ä¼šï¼Œè¯·æ±‚ B å·²ç»ä¾æ¬¡å®Œæˆæ•°æ®çš„æ›´æ–°ï¼Œå°±ä¼šå‡ºç°å›¾ä¸­çš„é—®é¢˜**





**2ã€å…ˆå†™Redis å†å†™Mysql**

   ä¹Ÿä¼šå‡ºç°åŒæ ·çš„é—®é¢˜

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis-shuju-yizhixing-2.png)

æ‰€ä»¥ï¼Œ**æ— è®ºæ˜¯ã€Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜ã€ï¼Œè¿˜æ˜¯ã€Œå…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ã€ï¼Œè¿™ä¸¤ä¸ªæ–¹æ¡ˆéƒ½å­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œå½“ä¸¤ä¸ªè¯·æ±‚å¹¶å‘æ›´æ–°åŒä¸€æ¡æ•°æ®çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°ç¼“å­˜å’Œæ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´çš„ç°è±¡**





> å…ˆæ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ˜¯å…ˆåˆ é™¤ç¼“å­˜ï¼Ÿ

è€ƒè™‘ä»¥ä¸‹æ€è·¯ï¼š**æ›´æ–°æ•°æ®æ—¶ï¼Œä¸æ›´æ–°ç¼“å­˜ï¼Œè€Œæ˜¯åˆ é™¤ç¼“å­˜ä¸­çš„æ•°æ®ã€‚ç„¶ååˆ°è¯»å–æ•°æ®æ—¶ï¼Œå‘ç°ç¼“å­˜ä¸­æ²¡äº†æ•°æ®ä¹‹åï¼Œå†ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œæ›´æ–°åˆ°ç¼“å­˜ä¸­**ã€‚è¿™ä¸ªç­–ç•¥æ˜¯æœ‰åå­—çš„ï¼š**`Cache Aside`** â€”â€”â€”â€”æ—è·¯ç¼“å­˜ç­–ç•¥ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%97%81%E8%B7%AF%E7%BC%93%E5%AD%98.webp" style="zoom: 67%;" />

**å†™ç­–ç•¥çš„æ­¥éª¤ï¼š**

- æ›´æ–°æ•°æ®åº“ä¸­çš„æ•°æ®ï¼›
- åˆ é™¤ç¼“å­˜ä¸­çš„æ•°æ®

**è¯»ç­–ç•¥çš„æ­¥éª¤ï¼š**

- å¦‚æœè¯»å–çš„æ•°æ®å‘½ä¸­äº†ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®(è¿™ç§æƒ…å†µ**åªå¯èƒ½æ˜¯è¿ç»­å‘ç”Ÿä¸¤æ¬¡è¯»è¯·æ±‚**)ï¼›
- **å¦‚æœè¯»å–çš„æ•°æ®æ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œåˆ™ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶ä¸”è¿”å›ç»™ç”¨æˆ·**



è€Œé’ˆå¯¹å†™ç­–ç•¥ï¼Œåˆ°åº•è¯¥é€‰æ‹©å“ªç§é¡ºåºå‘¢ï¼Ÿ

- å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ï¼›
- å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜





**3ã€å…ˆåˆ é™¤Redisç¼“å­˜ã€å†å†™Mysql**

ä»¥ç”¨æˆ·è¡¨çš„åœºæ™¯æ¥åˆ†æï¼š

å‡è®¾æŸä¸ªç”¨æˆ·çš„å¹´é¾„æ˜¯ 20ï¼Œè¯·æ±‚ A è¦æ›´æ–°ç”¨æˆ·å¹´é¾„ä¸º 21ï¼Œæ‰€ä»¥å®ƒä¼šåˆ é™¤ç¼“å­˜ä¸­çš„å†…å®¹ã€‚è¿™æ—¶ï¼Œå¦ä¸€ä¸ªè¯·æ±‚ B è¦è¯»å–è¿™ä¸ªç”¨æˆ·çš„å¹´é¾„ï¼Œå®ƒ**æŸ¥è¯¢ç¼“å­˜å‘ç°æœªå‘½ä¸­åï¼Œä¼šä»æ•°æ®åº“ä¸­è¯»å–åˆ°å¹´é¾„ä¸º 20ï¼Œå¹¶ä¸”å†™å…¥åˆ°ç¼“å­˜ä¸­**ï¼Œç„¶åè¯·æ±‚ A ç»§ç»­æ›´æ”¹æ•°æ®åº“ï¼Œå°†ç”¨æˆ·çš„å¹´é¾„æ›´æ–°ä¸º 21

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%85%88%E5%88%A0%E7%BC%93%E5%AD%98%20%E5%86%8D%E5%86%99redis.webp" style="zoom: 67%;" />

æœ€ç»ˆï¼Œè¯¥ç”¨æˆ·å¹´é¾„åœ¨ç¼“å­˜ä¸­æ˜¯ 20ï¼ˆæ—§å€¼ï¼‰ï¼Œåœ¨æ•°æ®åº“ä¸­æ˜¯ 21ï¼ˆæ–°å€¼ï¼‰ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´

å¯ä»¥çœ‹åˆ°ï¼Œ**å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ï¼Œåœ¨ã€Œè¯» + å†™ã€å¹¶å‘çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šå‡ºç°ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜**





#### å»¶è¿ŸåŒåˆ 

è€Œé’ˆå¯¹ã€Œå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“ã€æ–¹æ¡ˆåœ¨ã€Œè¯» + å†™ã€å¹¶å‘è¯·æ±‚è€Œé€ æˆç¼“å­˜ä¸ä¸€è‡´çš„è§£å†³åŠæ³•æ˜¯ã€Œ**å»¶è¿ŸåŒåˆ **ã€

å»¶è¿ŸåŒåˆ å®ç°çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š

```shell
#åˆ é™¤ç¼“å­˜
redis.delKey(X)
#æ›´æ–°æ•°æ®åº“
db.update(X)
#ç¡çœ 
Thread.sleep(N)
#å†åˆ é™¤ç¼“å­˜
redis.delKey(X)
```

å³å¯¹äºâ€œå…ˆåˆ é™¤ Redisï¼Œå†å†™ MySQLâ€ï¼Œå¦‚æœè¦è§£å†³æœ€åçš„ä¸ä¸€è‡´é—®é¢˜ï¼Œå…¶å®å†å¯¹ Redis é‡æ–°åˆ é™¤å³å¯ï¼Œ**è¿™ä¸ªä¹Ÿæ˜¯å¤§å®¶å¸¸è¯´çš„â€œç¼“å­˜åŒåˆ **ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis-shuju-yizhixing-3.png" style="zoom:67%;" />



ä¸ºäº†ä¾¿äºå¤§å®¶çœ‹å›¾ï¼Œå¯¹äºè“è‰²çš„æ–‡å­—ï¼Œâ€œåˆ é™¤ç¼“å­˜ 10â€å¿…é¡»åœ¨â€œå›å†™ç¼“å­˜10â€åé¢ï¼Œé‚£å¦‚ä½•æ‰èƒ½ä¿è¯ä¸€å®šæ˜¯åœ¨åé¢å‘¢ï¼Ÿ**ç½‘ä¸Šç»™å‡ºçš„ç¬¬ä¸€ä¸ªæ–¹æ¡ˆæ˜¯ï¼Œè®©è¯·æ±‚ A çš„æœ€åä¸€æ¬¡åˆ é™¤ï¼Œç­‰å¾… 500ms**

å¯¹äºè¿™ç§æ–¹æ¡ˆï¼Œçœ‹çœ‹å°±è¡Œï¼Œé£é™©ä¸å¯æ§

**é‚£æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹æ¡ˆå‘¢ï¼Œæˆ‘å»ºè®®å¼‚æ­¥ä¸²è¡ŒåŒ–åˆ é™¤ï¼Œå³åˆ é™¤è¯·æ±‚å…¥é˜Ÿåˆ—**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redis-shuju-yizhixing-4.png" style="zoom:67%;" />

å¼‚æ­¥åˆ é™¤å¯¹çº¿ä¸Šä¸šåŠ¡æ— å½±å“ï¼Œä¸²è¡ŒåŒ–å¤„ç†ä¿éšœå¹¶å‘æƒ…å†µä¸‹æ­£ç¡®åˆ é™¤













**4ã€å…ˆå†™Mysqlã€å†åˆ é™¤Redisç¼“å­˜**

ç»§ç»­ç”¨ã€Œè¯» + å†™ã€è¯·æ±‚çš„å¹¶å‘çš„åœºæ™¯æ¥åˆ†æï¼š

å‡å¦‚æŸä¸ªç”¨æˆ·æ•°æ®åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œè¯·æ±‚ A è¯»å–æ•°æ®æ—¶ä»æ•°æ®åº“ä¸­æŸ¥è¯¢åˆ°å¹´é¾„ä¸º 20ï¼Œåœ¨æœªå†™å…¥ç¼“å­˜ä¸­æ—¶å¦ä¸€ä¸ªè¯·æ±‚ B æ›´æ–°æ•°æ®ã€‚å®ƒæ›´æ–°æ•°æ®åº“ä¸­çš„å¹´é¾„ä¸º 21ï¼Œå¹¶ä¸”æ¸…ç©ºç¼“å­˜ã€‚è¿™æ—¶è¯·æ±‚ A æŠŠä»æ•°æ®åº“ä¸­è¯»åˆ°çš„å¹´é¾„ä¸º 20 çš„æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%85%88%E5%86%99mysql.webp" style="zoom:67%;" />

æœ€ç»ˆï¼Œè¯¥ç”¨æˆ·å¹´é¾„åœ¨ç¼“å­˜ä¸­æ˜¯ 20ï¼ˆæ—§å€¼ï¼‰ï¼Œåœ¨æ•°æ®åº“ä¸­æ˜¯ 21ï¼ˆæ–°å€¼ï¼‰ï¼Œç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´

ä»ä¸Šé¢çš„ç†è®ºä¸Šåˆ†æï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ä¹Ÿæ˜¯ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œ**ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œè¿™ä¸ªé—®é¢˜å‡ºç°çš„æ¦‚ç‡å¹¶ä¸é«˜**

**å› ä¸ºç¼“å­˜çš„å†™å…¥é€šå¸¸è¦è¿œè¿œå¿«äºæ•°æ®åº“çš„å†™å…¥**ï¼Œæ‰€ä»¥**åœ¨å®é™…ä¸­å¾ˆéš¾å‡ºç°å†™è¯·æ±‚ B å·²ç»æ›´æ–°äº†æ•°æ®åº“å¹¶ä¸”åˆ é™¤äº†ç¼“å­˜ï¼Œè¯»è¯·æ±‚ A æ‰æ›´æ–°å®Œç¼“å­˜çš„æƒ…å†µ(è¯»è¯·æ±‚Aå†™ç¼“å­˜çš„é€Ÿåº¦ä¸€èˆ¬è¦å¿«äºå†™è¯·æ±‚B)**

è€Œä¸€æ—¦è¯·æ±‚ A æ—©äºè¯·æ±‚ B åˆ é™¤ç¼“å­˜ä¹‹å‰æ›´æ–°äº†ç¼“å­˜ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„è¯·æ±‚å°±ä¼šå› ä¸ºç¼“å­˜ä¸å‘½ä¸­è€Œä»æ•°æ®åº“ä¸­é‡æ–°è¯»å–æ•°æ®ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°è¿™ç§ä¸ä¸€è‡´çš„æƒ…å†µ(**å› ä¸ºè¯·æ±‚Bå·²ç»æŠŠAæ›´æ–°çš„ç¼“å­˜æ•°æ®ç»™åˆ æ‰äº†ï¼Œåç»­çš„è¯»è¯·æ±‚éœ€è¦é‡æ–°è¯»Mysql**)



æ‰€ä»¥ï¼Œ**ã€Œå…ˆæ›´æ–°æ•°æ®åº“ + å†åˆ é™¤ç¼“å­˜ã€çš„æ–¹æ¡ˆï¼Œæ˜¯å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯æ•°æ®ä¸€è‡´æ€§çš„**



**ç¼ºç‚¹ï¼š**ã€Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€çš„æ–¹æ¡ˆè™½ç„¶ä¿è¯äº†æ•°æ®åº“ä¸ç¼“å­˜çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä½†æ˜¯æ¯æ¬¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œç¼“å­˜çš„æ•°æ®éƒ½ä¼šè¢«åˆ é™¤ï¼Œè¿™æ ·ä¼šå¯¹ç¼“å­˜çš„å‘½ä¸­ç‡å¸¦æ¥å½±å“

æ‰€ä»¥ï¼Œ**å¦‚æœæˆ‘ä»¬çš„ä¸šåŠ¡å¯¹ç¼“å­˜å‘½ä¸­ç‡æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ã€Œæ›´æ–°æ•°æ®åº“ + æ›´æ–°ç¼“å­˜ã€çš„æ–¹æ¡ˆï¼Œå› ä¸ºæ›´æ–°ç¼“å­˜å¹¶ä¸ä¼šå‡ºç°ç¼“å­˜æœªå‘½ä¸­çš„æƒ…å†µ**

ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆå‰é¢æˆ‘ä»¬ä¹Ÿåˆ†æè¿‡ï¼Œåœ¨ä¸¤ä¸ªæ›´æ–°è¯·æ±‚å¹¶å‘æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå› ä¸ºæ›´æ–°æ•°æ®åº“å’Œæ›´æ–°ç¼“å­˜è¿™ä¸¤ä¸ªæ“ä½œæ˜¯ç‹¬ç«‹çš„ï¼Œè€Œæˆ‘ä»¬åˆæ²¡æœ‰å¯¹æ“ä½œåšä»»ä½•å¹¶å‘æ§åˆ¶ï¼Œé‚£ä¹ˆå½“ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ›´æ–°å®ƒä»¬çš„è¯ï¼Œå°±ä¼šå› ä¸ºå†™å…¥é¡ºåºçš„ä¸åŒé€ æˆæ•°æ®çš„ä¸ä¸€è‡´ã€‚è¿™é‡Œæä¾›ä¸¤ç§åšæ³•ï¼š

- åœ¨æ›´æ–°ç¼“å­˜å‰å…ˆåŠ ä¸ª**åˆ†å¸ƒå¼é”**ï¼Œä¿è¯åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªè¯·æ±‚æ›´æ–°ç¼“å­˜ï¼Œå°±ä¼šä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜äº†ï¼Œå½“ç„¶å¼•å…¥äº†é”åï¼Œå¯¹äºå†™å…¥çš„æ€§èƒ½å°±ä¼šå¸¦æ¥å½±å“
- åœ¨æ›´æ–°å®Œç¼“å­˜æ—¶ï¼Œç»™ç¼“å­˜åŠ ä¸Šè¾ƒçŸ­çš„**è¿‡æœŸæ—¶é—´**ï¼Œè¿™æ ·å³æ—¶å‡ºç°ç¼“å­˜ä¸ä¸€è‡´çš„æƒ…å†µï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šå¾ˆå¿«è¿‡æœŸï¼Œå¯¹ä¸šåŠ¡è¿˜æ˜¯èƒ½æ¥å—çš„







5ã€å…ˆå†™ MySQLï¼Œé€šè¿‡ Binlogï¼Œå¼‚æ­¥æ›´æ–° Redis

è¿™ç§æ–¹æ¡ˆï¼Œä¸»è¦æ˜¯ç›‘å¬ MySQL çš„ Binlogï¼Œç„¶åé€šè¿‡å¼‚æ­¥çš„æ–¹å¼ï¼Œå°†æ•°æ®æ›´æ–°åˆ° Redisï¼Œè¿™ç§æ–¹æ¡ˆæœ‰ä¸ªå‰æï¼ŒæŸ¥è¯¢çš„è¯·æ±‚ï¼Œä¸ä¼šå›å†™ Redis

![img](https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/mysql/redis-shuju-yizhixing-0da55874-8cf7-4c5a-995b-a0e6611bfac2.png)



è¿™ä¸ªæ–¹æ¡ˆï¼Œä¼šä¿è¯ MySQL å’Œ Redis çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯å¦‚æœä¸­é€”è¯·æ±‚ B éœ€è¦æŸ¥è¯¢æ•°æ®ï¼Œå¦‚æœç¼“å­˜æ— æ•°æ®ï¼Œå°±ç›´æ¥æŸ¥ DBï¼›å¦‚æœç¼“å­˜æœ‰æ•°æ®ï¼ŒæŸ¥è¯¢çš„æ•°æ®ä¹Ÿä¼šå­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µã€‚

**æ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆï¼Œæ˜¯å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯å®æ—¶æ€§**





#### æ–¹æ¡ˆæ¯”è¾ƒ

æˆ‘ä»¬å¯¹æ¯”ä¸Šé¢è®¨è®ºçš„ 6 ç§æ–¹æ¡ˆï¼š

1. å…ˆå†™ Redisï¼Œå†å†™ MySQL

- **è¿™ç§æ–¹æ¡ˆï¼Œæˆ‘è‚¯å®šä¸ä¼šç”¨**ï¼Œä¸‡ä¸€ DB æŒ‚äº†ï¼Œä½ æŠŠæ•°æ®å†™åˆ°ç¼“å­˜ï¼ŒDB æ— æ•°æ®ï¼Œè¿™ä¸ªæ˜¯ç¾éš¾æ€§çš„ï¼›
- æˆ‘ä¹‹å‰ä¹Ÿè§åŒå­¦è¿™ä¹ˆç”¨è¿‡ï¼Œå¦‚æœå†™ DB å¤±è´¥ï¼Œå¯¹ Redis è¿›è¡Œé€†æ“ä½œï¼Œé‚£å¦‚æœé€†æ“ä½œå¤±è´¥å‘¢ï¼Œæ˜¯ä¸æ˜¯è¿˜è¦æä¸ªé‡è¯•ï¼Ÿ

2. å…ˆå†™ MySQLï¼Œå†å†™ Redis

- **å¯¹äºå¹¶å‘é‡ã€ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„é¡¹ç›®ï¼Œå¾ˆå¤šå°±æ˜¯è¿™ä¹ˆç”¨çš„**ï¼Œæˆ‘ä¹‹å‰ä¹Ÿç»å¸¸è¿™ä¹ˆæï¼Œä½†æ˜¯ä¸å»ºè®®è¿™ä¹ˆåšï¼›
- å½“ Redis ç¬é—´ä¸å¯ç”¨çš„æƒ…å†µï¼Œéœ€è¦æŠ¥è­¦å‡ºæ¥ï¼Œç„¶åçº¿ä¸‹å¤„ç†ã€‚

3. å…ˆåˆ é™¤ Redisï¼Œå†å†™ MySQL

- è¿™ç§æ–¹å¼ï¼Œæˆ‘è¿˜çœŸæ²¡ç”¨è¿‡ï¼Œ**ç›´æ¥å¿½ç•¥å§ã€‚**

4. å…ˆåˆ é™¤ Redisï¼Œå†å†™ MySQLï¼Œå†åˆ é™¤ Redis

- è¿™ç§æ–¹å¼è™½ç„¶å¯è¡Œï¼Œä½†æ˜¯**æ„Ÿè§‰å¥½å¤æ‚**ï¼Œè¿˜è¦æä¸ªæ¶ˆæ¯é˜Ÿåˆ—å»å¼‚æ­¥åˆ é™¤ Redisã€‚

5. å…ˆå†™ MySQLï¼Œå†åˆ é™¤ Redis

- **æ¯”è¾ƒæ¨èè¿™ç§æ–¹å¼**ï¼Œåˆ é™¤ Redis å¦‚æœå¤±è´¥ï¼Œå¯ä»¥å†å¤šé‡è¯•å‡ æ¬¡ï¼Œå¦åˆ™æŠ¥è­¦å‡ºæ¥ï¼›
- è¿™ä¸ªæ–¹æ¡ˆï¼Œæ˜¯å®æ—¶æ€§ä¸­æœ€å¥½çš„æ–¹æ¡ˆï¼Œåœ¨ä¸€äº›é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œæ¨èè¿™ç§ã€‚

6. å…ˆå†™ MySQLï¼Œé€šè¿‡ Binlogï¼Œå¼‚æ­¥æ›´æ–° Redis

- **å¯¹äºå¼‚åœ°å®¹ç¾ã€æ•°æ®æ±‡æ€»ç­‰ï¼Œå»ºè®®ä¼šç”¨è¿™ç§æ–¹å¼**ï¼Œæ¯”å¦‚ binlog + kafkaï¼Œæ•°æ®çš„ä¸€è‡´æ€§ä¹Ÿå¯ä»¥è¾¾åˆ°ç§’çº§ï¼›
- çº¯ç²¹çš„é«˜å¹¶å‘åœºæ™¯ï¼Œä¸å»ºè®®ç”¨è¿™ç§æ–¹æ¡ˆï¼Œæ¯”å¦‚æŠ¢è´­ã€ç§’æ€ç­‰ã€‚

**ä¸ªäººç»“è®ºï¼š**

- **å®æ—¶ä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼šé‡‡ç”¨â€œå…ˆå†™ MySQLï¼Œå†åˆ é™¤ Redisâ€çš„ç­–ç•¥ï¼Œè¿™ç§æƒ…å†µè™½ç„¶ä¹Ÿä¼šå­˜åœ¨ä¸¤è€…ä¸ä¸€è‡´ï¼Œä½†æ˜¯éœ€è¦æ»¡è¶³çš„æ¡ä»¶æœ‰ç‚¹è‹›åˆ»ï¼Œ**æ‰€ä»¥æ˜¯æ»¡è¶³å®æ—¶æ€§æ¡ä»¶ä¸‹ï¼Œèƒ½å°½é‡æ»¡è¶³ä¸€è‡´æ€§çš„æœ€ä¼˜è§£ã€‚**
- **æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼šé‡‡ç”¨â€œå…ˆå†™ MySQLï¼Œé€šè¿‡ Binlogï¼Œå¼‚æ­¥æ›´æ–° Redisâ€ï¼Œå¯ä»¥é€šè¿‡ Binlogï¼Œç»“åˆæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–° Redisï¼Œ**æ˜¯æœ€ç»ˆä¸€è‡´æ€§çš„æœ€ä¼˜è§£**





## è¿‡æœŸåˆ é™¤ä¸å†…å­˜æ·˜æ±°ç­–ç•¥





### è¿‡æœŸåˆ é™¤

æ¯å½“å¯¹ä¸€ä¸ª key è®¾ç½®äº†è¿‡æœŸæ—¶é—´æ—¶ï¼Œ`Redis` ä¼šæŠŠè¯¥ `key` å¸¦ä¸Šè¿‡æœŸæ—¶é—´å­˜å‚¨åˆ°ä¸€ä¸ª**è¿‡æœŸå­—å…¸**ï¼ˆ`expires dict`ï¼‰ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ã€Œè¿‡æœŸå­—å…¸ã€ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰ key çš„è¿‡æœŸæ—¶é—´

å½“æˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸ª key æ—¶ï¼Œ`Redis` é¦–å…ˆæ£€æŸ¥è¯¥ `key` æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ä¸­ï¼š

- å¦‚æœä¸åœ¨ï¼Œåˆ™æ­£å¸¸è¯»å–é”®å€¼(è¯´æ˜è¯¥keyæœªè®¾ç½®è¿‡æœŸæ—¶é—´)ï¼›
- å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šè·å–è¯¥ key çš„è¿‡æœŸæ—¶é—´ï¼Œç„¶åä¸å½“å‰ç³»ç»Ÿæ—¶é—´è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ¯”ç³»ç»Ÿæ—¶é—´å¤§ï¼Œé‚£å°±æ²¡æœ‰è¿‡æœŸï¼Œå¦åˆ™åˆ¤å®šè¯¥ key å·²è¿‡æœŸ

è¿‡æœŸå­—å…¸å­˜å‚¨åœ¨ `redisDb` ç»“æ„ä¸­ï¼Œå¦‚ä¸‹ï¼š

```c
typedef struct redisDb {
    dict *dict;    /* æ•°æ®åº“é”®ç©ºé—´ï¼Œå­˜æ”¾ç€æ‰€æœ‰çš„é”®å€¼å¯¹ */
    dict *expires; /* é”®çš„è¿‡æœŸæ—¶é—´ */
    ....
} redisDb;
```

è¿‡æœŸå­—å…¸æ•°æ®ç»“æ„ç»“æ„å¦‚ä¸‹ï¼š

- è¿‡æœŸå­—å…¸çš„ key æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æŸä¸ªé”®å¯¹è±¡ï¼›
- è¿‡æœŸå­—å…¸çš„ value æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°ä¿å­˜äº† key çš„è¿‡æœŸæ—¶é—´ï¼›

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%BF%87%E6%9C%9F%E5%AD%97%E5%85%B8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.webp" style="zoom: 67%;" />







`Redis` è‡ªå¸¦äº†**ç»™ç¼“å­˜æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´**çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

```shell
127.0.0.1:6379> expire name 10 #   é”® nameåœ¨ 10s åè¿‡æœŸ
(integer) 1
127.0.0.1:6379> setex name 60 value # æ•°æ®åœ¨ 60s åè¿‡æœŸ (setex:[key] + [ex]pire+[value])
OK
127.0.0.1:6379> ttl key # æŸ¥çœ‹æ•°æ®è¿˜æœ‰å¤šä¹…è¿‡æœŸ
(integer) 56

```

`SETEX`å‘½ä»¤æ˜¯`Redis`ä¸­çš„ä¸€ä¸ªç”¨äºè®¾ç½®å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹çš„å‘½ä»¤ã€‚å®ƒç”¨äºå°†æŒ‡å®šçš„é”®è®¾ç½®ä¸ºæŒ‡å®šçš„å€¼ï¼Œå¹¶åœ¨ä¸€æ®µæ—¶é—´åè‡ªåŠ¨è¿‡æœŸï¼Œå‘½ä»¤æ ¼å¼ï¼š

```shell
SETEX key seconds value
```







`Redis` ä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ã€Œ**æƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤**ã€è¿™ä¸¤ç§ç­–ç•¥é…åˆä½¿ç”¨:

**æƒ°æ€§åˆ é™¤ï¼š**

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„åšæ³•æ˜¯ï¼Œ**ä¸ä¸»åŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œæ¯æ¬¡ä»æ•°æ®åº“è®¿é—® key æ—¶ï¼Œéƒ½æ£€æµ‹ key æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤è¯¥ key**

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„**ä¼˜ç‚¹**ï¼š

- å› ä¸ºæ¯æ¬¡è®¿é—®æ—¶ï¼Œæ‰ä¼šæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸï¼Œæ‰€ä»¥æ­¤ç­–ç•¥åªä¼šä½¿ç”¨å¾ˆå°‘çš„ç³»ç»Ÿèµ„æºï¼Œå› æ­¤ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹ CPU æ—¶é—´æœ€å‹å¥½ã€‚

æƒ°æ€§åˆ é™¤ç­–ç•¥çš„**ç¼ºç‚¹**ï¼š

- å¦‚æœä¸€ä¸ª key å·²ç»è¿‡æœŸï¼Œè€Œè¿™ä¸ª key åˆä»ç„¶ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªè¿‡æœŸ key ä¸€ç›´æ²¡æœ‰è¢«è®¿é—®ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜å°±ä¸ä¼šé‡Šæ”¾ï¼Œé€ æˆäº†ä¸€å®šçš„å†…å­˜ç©ºé—´æµªè´¹ã€‚æ‰€ä»¥ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹å†…å­˜ä¸å‹å¥½



Redis çš„æƒ°æ€§åˆ é™¤ç­–ç•¥ç”± db.c æ–‡ä»¶ä¸­çš„ `expireIfNeeded` å‡½æ•°å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```c
int expireIfNeeded(redisDb *db, robj *key) {
    // åˆ¤æ–­ key æ˜¯å¦è¿‡æœŸ æœªè¿‡æœŸåˆ™ç›´æ¥è¿”å›
    if (!keyIsExpired(db,key)) return 0;  
    ....
    /* åˆ é™¤è¿‡æœŸé”® */
    ....
    
    // å¦‚æœ server.lazyfree_lazy_expire ä¸º 1 è¡¨ç¤ºå¼‚æ­¥åˆ é™¤ï¼Œåä¹‹åŒæ­¥åˆ é™¤ï¼›
    return server.lazyfree_lazy_expire ? dbAsyncDelete(db,key) :
                                         dbSyncDelete(db,key);
}
```

(`lazy_free`æ˜¯ä¸€ç§å»¶è¿Ÿé‡Šæ”¾å†…å­˜çš„æœºåˆ¶,å…·ä½“æ¥è¯´ï¼Œå½“Redisåˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹æ—¶ï¼Œå®ƒä¼šå°†è¯¥é”®å€¼å¯¹çš„å†…å­˜æ ‡è®°ä¸º"å¾…é‡Šæ”¾"ï¼Œä½†å¹¶ä¸ç«‹å³é‡Šæ”¾å®ƒã€‚ç›¸åï¼ŒRedisä¼šå°†è¿™äº›å¾…é‡Šæ”¾çš„å†…å­˜å—æ·»åŠ åˆ°ä¸€ä¸ªä¸“é—¨çš„åˆ—è¡¨ä¸­ï¼Œè¯¥åˆ—è¡¨ç§°ä¸º"`lazyfree list`")ï¼Œç„¶åé€šè¿‡åå°`lazy-free`çº¿ç¨‹æ¥åˆ é™¤è¿‡æœŸçš„key

Redis åœ¨è®¿é—®æˆ–è€…ä¿®æ”¹ key ä¹‹å‰ï¼Œéƒ½ä¼šè°ƒç”¨ `expireIfNeeded` å‡½æ•°å¯¹å…¶è¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸï¼š

- å¦‚æœè¿‡æœŸï¼Œåˆ™åˆ é™¤è¯¥ keyï¼Œè‡³äºé€‰æ‹©å¼‚æ­¥åˆ é™¤ï¼Œè¿˜æ˜¯é€‰æ‹©åŒæ­¥åˆ é™¤ï¼Œæ ¹æ® `lazyfree_lazy_expire` å‚æ•°é…ç½®å†³å®šï¼ˆRedis 4.0ç‰ˆæœ¬å¼€å§‹æä¾›å‚æ•°ï¼‰ï¼Œç„¶åè¿”å› null å®¢æˆ·ç«¯ï¼›
- å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œä¸åšä»»ä½•å¤„ç†ï¼Œç„¶åè¿”å›æ­£å¸¸çš„é”®å€¼å¯¹ç»™å®¢æˆ·ç«¯ï¼›







**å®šæœŸåˆ é™¤:**

**æ¯éš”ä¸€æ®µæ—¶é—´ã€Œéšæœºã€ä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„ key è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸkeyã€‚**

Redis çš„å®šæœŸåˆ é™¤çš„æµç¨‹ï¼š

1. ä»è¿‡æœŸå­—å…¸ä¸­éšæœºæŠ½å– 20 ä¸ª keyï¼›
2. æ£€æŸ¥è¿™ 20 ä¸ª key æ˜¯å¦è¿‡æœŸï¼Œå¹¶åˆ é™¤å·²è¿‡æœŸçš„ keyï¼›
3. å¦‚æœæœ¬è½®æ£€æŸ¥çš„å·²è¿‡æœŸ key çš„æ•°é‡ï¼Œè¶…è¿‡ 5 ä¸ªï¼ˆ20/4ï¼‰ï¼Œä¹Ÿå°±æ˜¯ã€Œå·²è¿‡æœŸ key çš„æ•°é‡ã€å æ¯”ã€ŒéšæœºæŠ½å– key çš„æ•°é‡ã€å¤§äº 25%ï¼Œåˆ™ç»§ç»­é‡å¤æ­¥éª¤ 1ï¼›å¦‚æœå·²è¿‡æœŸçš„ key æ¯”ä¾‹å°äº 25%ï¼Œåˆ™åœæ­¢ç»§ç»­åˆ é™¤è¿‡æœŸ keyï¼Œç„¶åç­‰å¾…ä¸‹ä¸€è½®å†æ£€æŸ¥

å¯ä»¥çœ‹åˆ°ï¼Œå®šæœŸåˆ é™¤æ˜¯ä¸€ä¸ªå¾ªç¯çš„æµç¨‹ã€‚é‚£ Redis ä¸ºäº†ä¿è¯å®šæœŸåˆ é™¤ä¸ä¼šå‡ºç°å¾ªç¯è¿‡åº¦ï¼Œå¯¼è‡´çº¿ç¨‹å¡æ­»ç°è±¡ï¼Œä¸ºæ­¤å¢åŠ äº†å®šæœŸåˆ é™¤å¾ªç¯æµç¨‹çš„æ—¶é—´ä¸Šé™ï¼Œé»˜è®¤ä¸ä¼šè¶…è¿‡ 25ms(ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡`check key`ä¹‹å‰è¦å…ˆåˆ¤æ–­å½“å‰å¾ªç¯æ—¶é—´æ˜¯å¦è¶…å‡ºè®¾ç½®çš„æ—¶é—´ä¸Šé™ï¼Œè¶…å‡ºç›´æ¥è·³å‡ºå¾ªç¯)



å®šæœŸåˆ é™¤ç­–ç•¥çš„**ä¼˜ç‚¹**ï¼š

- é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ï¼Œæ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU çš„å½±å“ï¼Œ**è€Œä¸”åˆ é™¤ä¸€éƒ¨åˆ†è¿‡æœŸçš„æ•°æ®å‡å°‘äº†è¿‡æœŸé”®å¯¹å†…å­˜ç©ºé—´çš„æ— æ•ˆå ç”¨(ä¸»è¦)**

å®šæœŸåˆ é™¤ç­–ç•¥çš„**ç¼ºç‚¹**ï¼š

- éš¾ä»¥ç¡®å®šåˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ã€‚**å¦‚æœæ‰§è¡Œçš„å¤ªé¢‘ç¹ï¼Œå°±ä¼šå¯¹ CPU ä¸å‹å¥½ï¼›å¦‚æœæ‰§è¡Œçš„å¤ªå°‘ï¼Œé‚£åˆå’Œæƒ°æ€§åˆ é™¤ä¸€æ ·äº†ï¼Œè¿‡æœŸ key å ç”¨çš„å†…å­˜ä¸ä¼šåŠæ—¶å¾—åˆ°é‡Šæ”¾**

å¯ä»¥çœ‹åˆ°ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å’Œå®šæœŸåˆ é™¤ç­–ç•¥éƒ½æœ‰å„è‡ªçš„ä¼˜ç‚¹ï¼Œæ‰€ä»¥ **Redis é€‰æ‹©ã€Œæƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤ã€è¿™ä¸¤ç§ç­–ç•¥é…åˆä½¿ç”¨**ï¼Œä»¥æ±‚åœ¨åˆç†ä½¿ç”¨ CPU æ—¶é—´å’Œé¿å…å†…å­˜æµªè´¹ä¹‹é—´å–å¾—å¹³è¡¡





> **Redis æŒä¹…åŒ–æ—¶ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†çš„ï¼Ÿ**

Redis æŒä¹…åŒ–æ–‡ä»¶æœ‰ä¸¤ç§æ ¼å¼ï¼šRDBï¼ˆRedis Databaseï¼‰å’Œ AOFï¼ˆAppend Only Fileï¼‰ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹è¿‡æœŸé”®åœ¨è¿™ä¸¤ç§æ ¼å¼ä¸­çš„å‘ˆç°çŠ¶æ€ã€‚

RDB æ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒRDB æ–‡ä»¶ç”Ÿæˆé˜¶æ®µå’ŒåŠ è½½é˜¶æ®µ

- **RDB æ–‡ä»¶ç”Ÿæˆé˜¶æ®µ**ï¼šä»å†…å­˜çŠ¶æ€æŒä¹…åŒ–æˆ RDBï¼ˆæ–‡ä»¶ï¼‰çš„æ—¶å€™ï¼Œä¼šå¯¹ key è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œ**è¿‡æœŸçš„é”®ã€Œä¸ä¼šã€è¢«ä¿å­˜åˆ°æ–°çš„ RDB æ–‡ä»¶ä¸­**ï¼Œå› æ­¤ Redis ä¸­çš„è¿‡æœŸé”®ä¸ä¼šå¯¹ç”Ÿæˆæ–° RDB æ–‡ä»¶äº§ç”Ÿä»»ä½•å½±å“
- RDB åŠ è½½é˜¶æ®µï¼šRDB åŠ è½½é˜¶æ®µæ—¶ï¼Œè¦çœ‹æœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨è¿˜æ˜¯ä»æœåŠ¡å™¨ï¼Œåˆ†åˆ«å¯¹åº”ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š
  - **å¦‚æœ Redis æ˜¯ã€Œä¸»æœåŠ¡å™¨ã€è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ã€Œä¸ä¼šã€è¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­**ã€‚æ‰€ä»¥è¿‡æœŸé”®ä¸ä¼šå¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä¸»æœåŠ¡å™¨é€ æˆå½±å“ï¼›
  - **å¦‚æœ Redis æ˜¯ã€Œä»æœåŠ¡å™¨ã€è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¸è®ºé”®æ˜¯å¦è¿‡æœŸéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­**ã€‚**ä½†ç”±äºä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œè¿‡æœŸé”®å¯¹è½½å…¥ RDB æ–‡ä»¶çš„ä»æœåŠ¡å™¨ä¹Ÿä¸ä¼šé€ æˆå½±å“**

AOF æ–‡ä»¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼ŒAOF æ–‡ä»¶å†™å…¥é˜¶æ®µå’Œ AOF é‡å†™(`ReWrite`)é˜¶æ®µ

- **AOF æ–‡ä»¶å†™å…¥é˜¶æ®µ**ï¼šå½“ Redis ä»¥ AOF æ¨¡å¼æŒä¹…åŒ–æ—¶ï¼Œ**å¦‚æœæ•°æ®åº“æŸä¸ªè¿‡æœŸé”®è¿˜æ²¡è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¼šä¿ç•™æ­¤è¿‡æœŸé”®ï¼Œå½“æ­¤è¿‡æœŸé”®è¢«åˆ é™¤åï¼ŒRedis ä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤æ¥æ˜¾å¼åœ°åˆ é™¤è¯¥é”®å€¼**
- **AOF é‡å†™é˜¶æ®µ**ï¼šæ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œä¼šå¯¹ Redis ä¸­çš„é”®å€¼å¯¹è¿›è¡Œæ£€æŸ¥ï¼Œ**å·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„ AOF æ–‡ä»¶ä¸­**ï¼Œå› æ­¤ä¸ä¼šå¯¹ AOF é‡å†™é€ æˆä»»ä½•å½±å“









### å†…å­˜æ·˜æ±°

å‰é¢è¯´çš„è¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œæ˜¯åˆ é™¤å·²è¿‡æœŸçš„ keyï¼Œè€Œå½“ Redis çš„è¿è¡Œå†…å­˜å·²ç»è¶…è¿‡ Redis è®¾ç½®çš„æœ€å¤§å†…å­˜é˜ˆå€¼ä¹‹åï¼Œåˆ™ä¼šä½¿ç”¨å†…å­˜æ·˜æ±°ç­–ç•¥åˆ é™¤ç¬¦åˆæ¡ä»¶çš„ keyï¼Œä»¥æ­¤æ¥ä¿éšœ Redis é«˜æ•ˆçš„è¿è¡Œ



åœ¨é…ç½®æ–‡ä»¶ `redis.conf` ä¸­ï¼Œå¯ä»¥**é€šè¿‡å‚æ•° `maxmemory <bytes>` æ¥è®¾å®šæœ€å¤§è¿è¡Œå†…å­˜**ï¼Œåªæœ‰åœ¨ Redis çš„è¿è¡Œå†…å­˜è¾¾åˆ°äº†æˆ‘ä»¬è®¾ç½®çš„æœ€å¤§è¿è¡Œå†…å­˜ï¼Œæ‰ä¼šè§¦å‘å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œä¸åŒä½æ•°çš„æ“ä½œç³»ç»Ÿï¼Œ`maxmemory` çš„é»˜è®¤å€¼æ˜¯ä¸åŒçš„ï¼š

- åœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸­ï¼Œ`maxmemory` çš„é»˜è®¤å€¼æ˜¯ 0ï¼Œè¡¨ç¤ºæ²¡æœ‰å†…å­˜å¤§å°é™åˆ¶ï¼Œé‚£ä¹ˆä¸ç®¡ç”¨æˆ·å­˜æ”¾å¤šå°‘æ•°æ®åˆ° Redis ä¸­ï¼ŒRedis ä¹Ÿä¸ä¼šå¯¹å¯ç”¨å†…å­˜è¿›è¡Œæ£€æŸ¥ï¼Œç›´åˆ° Redis å®ä¾‹å› å†…å­˜ä¸è¶³è€Œå´©æºƒä¹Ÿæ— ä½œä¸º
- åœ¨ 32 ä½æ“ä½œç³»ç»Ÿä¸­ï¼Œ`maxmemory` çš„é»˜è®¤å€¼æ˜¯ 3Gï¼Œå› ä¸º 32 ä½çš„æœºå™¨æœ€å¤§åªæ”¯æŒ 4GB çš„å†…å­˜ï¼Œè€Œç³»ç»Ÿæœ¬èº«å°±éœ€è¦ä¸€å®šçš„å†…å­˜èµ„æºæ¥æ”¯æŒè¿è¡Œï¼Œæ‰€ä»¥ 32 ä½æ“ä½œç³»ç»Ÿé™åˆ¶æœ€å¤§ 3 GB çš„å¯ç”¨å†…å­˜æ˜¯éå¸¸åˆç†çš„ï¼Œè¿™æ ·å¯ä»¥é¿å…å› ä¸ºå†…å­˜ä¸è¶³è€Œå¯¼è‡´ Redis å®ä¾‹å´©æºƒ



> **å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ**

Redis å†…å­˜æ·˜æ±°ç­–ç•¥å…±æœ‰å…«ç§ï¼Œè¿™å…«ç§ç­–ç•¥å¤§ä½“åˆ†ä¸ºã€Œä¸è¿›è¡Œæ•°æ®æ·˜æ±°ã€å’Œã€Œè¿›è¡Œæ•°æ®æ·˜æ±°ã€ä¸¤ç±»ç­–ç•¥

*1ã€ä¸è¿›è¡Œæ•°æ®æ·˜æ±°çš„ç­–ç•¥*

**`noeviction`**ï¼ˆRedis3.0ä¹‹åï¼Œé»˜è®¤çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ ï¼šå®ƒè¡¨ç¤ºå½“è¿è¡Œå†…å­˜è¶…è¿‡æœ€å¤§è®¾ç½®å†…å­˜æ—¶ï¼Œä¸æ·˜æ±°ä»»ä½•æ•°æ®ï¼Œè¿™æ—¶å¦‚æœæœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œåˆ™ä¼šè§¦å‘ `OOM`ï¼Œä½†æ˜¯**å¦‚æœæ²¡æœ‰æ•°æ®å†™å…¥çš„è¯ï¼Œåªæ˜¯å•çº¯çš„æŸ¥è¯¢æˆ–è€…åˆ é™¤æ“ä½œçš„è¯ï¼Œè¿˜æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œ**

*2ã€è¿›è¡Œæ•°æ®æ·˜æ±°çš„ç­–ç•¥*

é’ˆå¯¹ã€Œè¿›è¡Œæ•°æ®æ·˜æ±°ã€è¿™ä¸€ç±»ç­–ç•¥ï¼Œåˆå¯ä»¥ç»†åˆ†ä¸ºã€Œ**åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±°**ã€å’Œã€Œ**åœ¨æ‰€æœ‰æ•°æ®èŒƒå›´å†…è¿›è¡Œæ·˜æ±°**ã€è¿™ä¸¤ç±»ç­–ç•¥ã€‚

åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±°ï¼š

- **volatile-random**ï¼šéšæœºæ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ä»»æ„é”®å€¼ï¼›
- **volatile-ttl**ï¼šä¼˜å…ˆæ·˜æ±°æ›´æ—©è¿‡æœŸçš„é”®å€¼ã€‚
- **volatile-lru**(Redis3.0å‰é»˜è®¤çš„å†…å­˜æ·˜æ±°ç­–ç•¥):æ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€é•¿æ—¶é—´æœªè¢«ä½¿ç”¨çš„é”®å€¼ï¼›
- **volatile-lfu**(Redis4.0åæ–°å¢å†…å­˜æ·˜æ±°ç­–ç•¥):æ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€å°‘ä½¿ç”¨çš„é”®å€¼ï¼›

åœ¨æ‰€æœ‰æ•°æ®èŒƒå›´å†…è¿›è¡Œæ·˜æ±°ï¼š

- **allkeys-random**ï¼šéšæœºæ·˜æ±°ä»»æ„é”®å€¼;
- **allkeys-lru**ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›
- **allkeys-lfu**ï¼ˆRedis 4.0 åæ–°å¢çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼‰ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€å°‘ä½¿ç”¨çš„é”®å€¼ã€‚

ä½¿ç”¨ `config get maxmemory-policy` å‘½ä»¤ï¼Œæ¥æŸ¥çœ‹å½“å‰ Redis çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

```shell
127.0.0.1:6379> config get maxmemory-policy
1) "maxmemory-policy"
2) "noeviction"
```

å¯ä»¥çœ‹å‡ºï¼Œå½“å‰ Redis ä½¿ç”¨çš„æ˜¯ `noeviction` ç±»å‹çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œå®ƒæ˜¯ Redis 3.0 ä¹‹åé»˜è®¤ä½¿ç”¨çš„å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œè¡¨ç¤ºå½“è¿è¡Œå†…å­˜è¶…è¿‡æœ€å¤§è®¾ç½®å†…å­˜æ—¶ï¼Œä¸æ·˜æ±°ä»»ä½•æ•°æ®ï¼Œä½†æ–°å¢æ“ä½œä¼šæŠ¥é”™





### LRU & LFU :astonished:



**LRUï¼š**

ä¼ ç»Ÿ LRU ç®—æ³•çš„å®ç°æ˜¯åŸºäºã€Œ**åŒå‘é“¾è¡¨**ã€ç»“æ„ï¼Œé“¾è¡¨ä¸­çš„å…ƒç´ æŒ‰ç…§æ“ä½œé¡ºåºä»å‰å¾€åæ’åˆ—ï¼Œæœ€æ–°æ“ä½œçš„é”®ä¼šè¢«ç§»åŠ¨åˆ°è¡¨å¤´ï¼Œå½“éœ€è¦å†…å­˜æ·˜æ±°æ—¶ï¼Œåªéœ€è¦åˆ é™¤é“¾è¡¨å°¾éƒ¨çš„å…ƒç´ å³å¯ï¼Œå› ä¸ºé“¾è¡¨å°¾éƒ¨çš„å…ƒç´ å°±ä»£è¡¨æœ€ä¹…æœªè¢«ä½¿ç”¨çš„å…ƒç´ ã€‚

Redis å¹¶æ²¡æœ‰ä½¿ç”¨è¿™æ ·çš„æ–¹å¼å®ç° LRU ç®—æ³•ï¼Œå› ä¸ºä¼ ç»Ÿçš„ LRU ç®—æ³•å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

- éœ€è¦ç”¨é“¾è¡¨ç®¡ç†æ‰€æœ‰çš„ç¼“å­˜æ•°æ®ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„ç©ºé—´å¼€é”€ï¼›
- å½“æœ‰æ•°æ®è¢«è®¿é—®æ—¶ï¼Œéœ€è¦åœ¨é“¾è¡¨ä¸ŠæŠŠè¯¥æ•°æ®ç§»åŠ¨åˆ°å¤´ç«¯ï¼Œå¦‚æœæœ‰å¤§é‡æ•°æ®è¢«è®¿é—®ï¼Œå°±ä¼šå¸¦æ¥å¾ˆå¤šé“¾è¡¨ç§»åŠ¨æ“ä½œï¼Œä¼šå¾ˆè€—æ—¶ï¼Œè¿›è€Œä¼šé™ä½ Redis ç¼“å­˜æ€§èƒ½



Redis å®ç°çš„æ˜¯ä¸€ç§**è¿‘ä¼¼ LRU ç®—æ³•**ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„èŠ‚çº¦å†…å­˜ï¼Œå®ƒçš„**å®ç°æ–¹å¼æ˜¯åœ¨ Redis çš„å¯¹è±¡ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å­—æ®µï¼Œç”¨äºè®°å½•æ­¤æ•°æ®çš„æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´**

å½“ Redis è¿›è¡Œå†…å­˜æ·˜æ±°æ—¶ï¼Œä¼šä½¿ç”¨**éšæœºé‡‡æ ·çš„æ–¹å¼æ¥æ·˜æ±°æ•°æ®**ï¼Œå®ƒæ˜¯éšæœºå– 5 ä¸ªå€¼ï¼ˆæ­¤å€¼å¯é…ç½®ï¼‰ï¼Œç„¶å**æ·˜æ±°æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„é‚£ä¸ª**

Redis å®ç°çš„ LRU ç®—æ³•çš„ä¼˜ç‚¹ï¼š

- ä¸ç”¨ä¸ºæ‰€æœ‰çš„æ•°æ®ç»´æŠ¤ä¸€ä¸ªå¤§é“¾è¡¨ï¼ŒèŠ‚çœäº†ç©ºé—´å ç”¨ï¼›
- ä¸ç”¨åœ¨æ¯æ¬¡æ•°æ®è®¿é—®æ—¶éƒ½ç§»åŠ¨é“¾è¡¨é¡¹ï¼Œæå‡äº†ç¼“å­˜çš„æ€§èƒ½ï¼›



ä½†æ˜¯ LRU ç®—æ³•æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ**æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜**ï¼Œæ¯”å¦‚åº”ç”¨ä¸€æ¬¡è¯»å–äº†å¤§é‡çš„æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®åªä¼šè¢«è¯»å–è¿™ä¸€æ¬¡ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®ä¼šç•™å­˜åœ¨ Redis ç¼“å­˜ä¸­å¾ˆé•¿ä¸€æ®µæ—¶é—´(`å› ä¸ºè¯»å–çš„è¿™äº›æ•°æ®çš„æœ€åè®¿é—®æ—¶é—´å­—æ®µéƒ½ä¼šè¢«æ›´æ–°`)ï¼Œè¿™å°±é€ æˆäº†ç¼“å­˜æ±¡æŸ“







**LFUï¼š**

LFU å…¨ç§°æ˜¯ Least Frequently Used ç¿»è¯‘ä¸º**æœ€è¿‘æœ€ä¸å¸¸ç”¨çš„**ï¼ŒLFU ç®—æ³•æ˜¯æ ¹æ®æ•°æ®è®¿é—®æ¬¡æ•°æ¥æ·˜æ±°æ•°æ®çš„,æ‰€ä»¥LFU ç®—æ³•ä¼šè®°å½•æ¯ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚å½“ä¸€ä¸ªæ•°æ®è¢«å†æ¬¡è®¿é—®æ—¶ï¼Œå°±ä¼šå¢åŠ è¯¥æ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚è¿™æ ·å°±è§£å†³äº†å¶å°”è¢«è®¿é—®ä¸€æ¬¡ä¹‹åï¼Œæ•°æ®ç•™å­˜åœ¨ç¼“å­˜ä¸­å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„é—®é¢˜ï¼Œç›¸æ¯”äº LRU ç®—æ³•ä¹Ÿæ›´åˆç†ä¸€äº›ï¼Œä¼ ç»ŸLFUç®—æ³•å®ç°æ€è·¯å¦‚ä¸‹ï¼š

- ä½¿ç”¨ä¸€ä¸ªæœ‰åºé›†åˆï¼ˆSorted Setï¼‰æ¥å®ç°å­˜å‚¨æ•°æ®
- åœ¨æœ‰åºé›†åˆä¸­ï¼Œé”®æ˜¯æ•°æ®ï¼Œå€¼æ˜¯æ•°æ®çš„è®¿é—®é¢‘ç‡è®¡æ•°
- æ¯æ¬¡è®¿é—®ä¸€ä¸ªé”®ï¼Œä¼šå°†è¯¥é”®çš„è®¿é—®é¢‘ç‡è®¡æ•°åŠ ä¸€ï¼Œå¹¶æ›´æ–°æœ‰åºé›†åˆä¸­çš„å€¼
- å½“éœ€è¦æ·˜æ±°æ•°æ®æ—¶ï¼Œä¼šä»æœ‰åºé›†åˆä¸­é€‰æ‹©è®¿é—®é¢‘ç‡æœ€ä½çš„æ•°æ®è¿›è¡Œæ·˜æ±°

è€Œåœ¨Redisä¸­ï¼ŒLFU ç®—æ³•ç›¸æ¯”äº LRU ç®—æ³•çš„å®ç°ï¼Œå¤šè®°å½•äº†ã€Œæ•°æ®çš„è®¿é—®é¢‘æ¬¡ã€çš„ä¿¡æ¯ã€‚Redis å¯¹è±¡çš„ç»“æ„å¦‚ä¸‹ï¼š

```c
typedef struct redisObject {
    ...
      
    // 24 bitsï¼Œç”¨äºè®°å½•å¯¹è±¡çš„è®¿é—®ä¿¡æ¯
    unsigned lru:24;  
    ...
} robj;
```

**åœ¨ LRU ç®—æ³•ä¸­**ï¼ŒRedis å¯¹è±¡å¤´çš„ 24 bits çš„ lru å­—æ®µæ˜¯**ç”¨æ¥è®°å½• key çš„è®¿é—®æ—¶é—´æˆ³**ï¼Œå› æ­¤åœ¨ LRU æ¨¡å¼ä¸‹ï¼ŒRediså¯ä»¥æ ¹æ®å¯¹è±¡å¤´ä¸­çš„ lru å­—æ®µè®°å½•çš„å€¼ï¼Œæ¥æ¯”è¾ƒæœ€åä¸€æ¬¡ key çš„è®¿é—®æ—¶é—´é•¿ï¼Œä»è€Œæ·˜æ±°æœ€ä¹…æœªè¢«ä½¿ç”¨çš„ key

**åœ¨ LFU ç®—æ³•ä¸­**ï¼ŒRediså¯¹è±¡å¤´çš„ 24 bits çš„ lru å­—æ®µè¢«åˆ†æˆä¸¤æ®µæ¥å­˜å‚¨ï¼Œ**é«˜ 16bit å­˜å‚¨ ldt(`Last Decrement Time`)ï¼Œä½ 8bit å­˜å‚¨ logc(`Logistic Counter`)**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/lru%E5%AD%97%E6%AE%B5.webp)

- ldt æ˜¯ç”¨æ¥è®°å½• key çš„è®¿é—®æ—¶é—´æˆ³ï¼›
- logc æ˜¯ç”¨æ¥è®°å½• key çš„è®¿é—®é¢‘æ¬¡ï¼Œå®ƒçš„å€¼è¶Šå°è¡¨ç¤ºä½¿ç”¨é¢‘ç‡è¶Šä½ï¼Œè¶Šå®¹æ˜“æ·˜æ±°ï¼Œæ¯ä¸ªæ–°åŠ å…¥çš„ key çš„logc åˆå§‹å€¼ä¸º 5
- logc å¹¶ä¸æ˜¯å•çº¯çš„è®¿é—®æ¬¡æ•°ï¼Œè€Œæ˜¯è®¿é—®é¢‘æ¬¡ï¼ˆè®¿é—®é¢‘ç‡ï¼‰ï¼Œå› ä¸º **logc ä¼šéšæ—¶é—´æ¨ç§»è€Œè¡°å‡çš„**

åœ¨æ¯æ¬¡ key è¢«è®¿é—®æ—¶ï¼Œä¼šå…ˆå¯¹ logc åšä¸€ä¸ªè¡°å‡æ“ä½œï¼Œè¡°å‡çš„å€¼è·Ÿå‰åè®¿é—®æ—¶é—´çš„å·®è·æœ‰å…³ç³»ï¼Œå¦‚æœä¸Šä¸€æ¬¡è®¿é—®çš„æ—¶é—´ä¸è¿™ä¸€æ¬¡è®¿é—®çš„æ—¶é—´å·®è·å¾ˆå¤§ï¼Œé‚£ä¹ˆè¡°å‡çš„å€¼å°±è¶Šå¤§ï¼Œè¿™æ ·å®ç°çš„ LFU ç®—æ³•æ˜¯æ ¹æ®**è®¿é—®é¢‘ç‡**æ¥æ·˜æ±°æ•°æ®çš„ï¼Œè€Œä¸åªæ˜¯è®¿é—®æ¬¡æ•°ã€‚è®¿é—®é¢‘ç‡éœ€è¦è€ƒè™‘ key çš„è®¿é—®æ˜¯å¤šé•¿æ—¶é—´æ®µå†…å‘ç”Ÿçš„ã€‚key çš„å…ˆå‰è®¿é—®è·ç¦»å½“å‰æ—¶é—´è¶Šé•¿ï¼Œé‚£ä¹ˆè¿™ä¸ª key çš„è®¿é—®é¢‘ç‡ç›¸åº”åœ°ä¹Ÿå°±ä¼šé™ä½ï¼Œè¿™æ ·è¢«æ·˜æ±°çš„æ¦‚ç‡ä¹Ÿä¼šæ›´å¤§

å¯¹ logc åšå®Œè¡°å‡æ“ä½œåï¼Œå°±å¼€å§‹å¯¹ logc è¿›è¡Œå¢åŠ æ“ä½œï¼Œ**å¢åŠ æ“ä½œå¹¶ä¸æ˜¯å•çº¯çš„ + 1ï¼Œè€Œæ˜¯æ ¹æ®æ¦‚ç‡å¢åŠ ï¼Œå¦‚æœ logc è¶Šå¤§çš„ keyï¼Œå®ƒçš„ logc å°±è¶Šéš¾å†å¢åŠ **



**æ€»ç»“ï¼š**å³å…ˆå‡ååŠ ï¼Œå‡çš„ç¨‹åº¦å’Œä¸Šæ¬¡è®¿é—®æ—¶é—´å·®è·æœ‰å…³ï¼ŒåŠ çš„ç¨‹åº¦å’Œå½“å‰logcå€¼æœ‰å…³







## åˆ†å¸ƒå¼é”





### Redisson



> æ¥çœ‹ä¸€ä¸ªå®é™…åœºæ™¯å¼•å…¥ï¼šå¾®æœåŠ¡é¡¹ç›®ä¸­ï¼Œä¸€ä¸ªå¾®æœåŠ¡é€šå¸¸ä¼šæœ‰å¤šä¸ªå®ä¾‹åœ¨è¿è¡Œ(ç”¨æˆ·è¯·æ±‚åˆ°æ¥æ—¶æ¶‰åŠåˆ°è·¯ç”±è´Ÿè½½å‡è¡¡)ï¼Œæ‰“åˆ°ä¸€ä¸ªç‰¹å®šå®ä¾‹ä¸Šçš„å¤šä¸ªçº¿ç¨‹è¯·æ±‚ï¼Œé’ˆå¯¹è¿™ä¸€ä¸ªå®ä¾‹(å•ä¸ª`jvm`è¿›ç¨‹)ä½¿ç”¨åŒæ­¥é”`synchronized`æ˜¯å¯ä»¥å®ç°è¿™äº›çº¿ç¨‹çš„åŒæ­¥æ“ä½œçš„ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦åœ¨å¤šä¸ªå®ä¾‹(å¤šä¸ª`jvm`è¿›ç¨‹)ä¸Šå®ç°æ‰€æœ‰çº¿ç¨‹è¯·æ±‚çš„åŒæ­¥ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†åˆ†å¸ƒå¼é”ï¼Œæœ¬é¡¹ç›®ä¸­ä½¿ç”¨`Redisson`æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œå…ˆæ¥çœ‹çœ‹ä¸šåŠ¡åœºæ™¯
>
> é€‰è¯¾å†²çªå¤„ç†ï¼šå½“å¤šä¸ªå­¦ç”ŸåŒæ—¶é€‰æ‹©æŸé—¨è¯¾ç¨‹æ—¶ï¼Œå¯èƒ½å‘ç”Ÿé€‰è¯¾å†²çªã€‚ä¸ºäº†é¿å…å†²çªï¼Œå¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªå­¦ç”Ÿèƒ½å¤ŸæˆåŠŸé€‰å–è¯¥è¯¾ç¨‹



ç„¶åæˆ‘ä»¬å†æ¥è®²ä¸€ä¸‹ä¼˜åŒ–çš„è¿‡ç¨‹

(1) ä½¿ç”¨setnxå‘½ä»¤ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ä½†æ˜¯è¿‡æœŸæ—¶é—´ä¸å¥½ç¡®å®š(å–å†³äºä¸šåŠ¡)ï¼Œé—®é¢˜æœ‰ä¸¤ç‚¹ï¼š

- è®¾ç½®çš„è¿‡æœŸæ—¶é—´è¾ƒçŸ­ï¼šè®©keyåˆ°æœŸåè‡ªåŠ¨é‡Šæ”¾ï¼Œå¯èƒ½å½“å‰çº¿ç¨‹æ“ä½œæœªå®Œæˆé”å°±è¢«é‡Šæ”¾ï¼›

- æ‰‹åŠ¨åˆ é™¤ï¼šæ¯æ¬¡å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œååœ¨finallyä¸­æ‰‹åŠ¨é‡Šæ”¾é”(`del key`),ä½†æ˜¯ç”±äºé”å·²ç»è¿‡æœŸï¼Œé”å½“å‰è¢«åˆ«äººå ç”¨ï¼Œæ­¤æ—¶å†åˆ é™¤å°±åˆ æ‰çš„æ˜¯å…¶ä»–çº¿ç¨‹æŒæœ‰çš„é”äº†

  

(2) ä¾æ—§ä½¿ç”¨setnxå‘½ä»¤ï¼Œä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œç”±å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ“ä½œååˆ¤æ–­é”æ˜¯å¦è¿˜æ˜¯ä¹‹å‰æ‰€è®¾ç½®çš„ï¼Œæ˜¯çš„è¯å†æ‰‹åŠ¨åˆ é™¤

è¿™ç§æ–¹å¼ä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œå› ä¸º**åˆ¤æ–­é”ä¸é‡Šæ”¾é”çš„ä»£ç ä¸æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œï¼Œå¤šçº¿ç¨‹åœºæ™¯ä¸‹CPUæ˜¯åŸºäºæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦çš„ï¼Œå‡å¦‚å½“å‰çº¿ç¨‹åˆ¤æ–­ç°åœ¨çš„é”æ˜¯å®ƒæ‰€è®¾ç½®çš„``<K,V>=<"lock",01>`ï¼Œä½†æ˜¯é©¬ä¸Šè®©å‡ºäº†æ—¶é—´ç‰‡ç»™çº¿ç¨‹2ï¼Œä¸”æ­¤æ—¶é”å¤±æ•ˆï¼Œçº¿ç¨‹2åˆ¤æ–­åˆ°é”å¤±æ•ˆæ•…æ‰§è¡Œ`setnx`å‘½ä»¤è®¾ç½®ä¸º(`<K,V>=<"lock",02>`)ï¼Œç„¶åå†æ¬¡è®©å‡ºæ—¶é—´ç‰‡ç»™çº¿ç¨‹1ï¼Œæ­¤æ—¶çº¿ç¨‹1æ‰§è¡Œåˆ é™¤é”å‘½ä»¤å°±æŠŠçº¿ç¨‹2çš„é”ç»™åˆ æ‰äº†**ï¼ï¼

```java
finally{
    if(redis.call("get","lock")=="01")
    {
        é‡Šæ”¾é”ï¼š redis.call("del","lock");
    }
}
```

(3) è§£å†³ä»¥ä¸ŠåŸå­æ€§é—®é¢˜çš„åŠæ³•æ˜¯åŸºäºluaè„šæœ¬ï¼Œluaè„šæœ¬åœ¨æ‰§è¡Œä¸Šè¿°æ“ä½œæ—¶å¯ä»¥ä¿è¯åŸå­æ€§ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨é—®é¢˜ï¼Œ**å› ä¸ºå¦‚æœå½“å‰å®ä¾‹çªç„¶å´©æºƒï¼Œ`finally`ä¸­çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå‘¢**?ç”±äºæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªé”å°±æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾æ‰ï¼ï¼

è¿™é‡Œç»™å‡ºåŸºäº`setnx`çš„åˆ†å¸ƒå¼é”å®ç°ï¼š

```java
//é€šè¿‡setnxå®ç°åˆ†å¸ƒå¼é”  2.0
public CoursePublish getCoursePublishCache2(Long courseId){

    //å…ˆä»ç¼“å­˜ä¸­æŸ¥è¯¢
    String jsonString = (String) redisTemplate.opsForValue().get("course:" + courseId);
    if(StringUtils.isNotEmpty(jsonString)){
        //System.out.println("========ä»ç¼“å­˜ä¸­æŸ¥è¯¢===========");
        //å°†jsonè½¬æˆå¯¹è±¡è¿”å›
        CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.class);
        return coursePublish;
    }else{
        //ä½¿ç”¨setnxå‘redisè®¾ç½®ä¸€ä¸ªkeyï¼Œè°è®¾ç½®æˆåŠŸè°æ‹¿åˆ°äº†åˆ†å¸ƒå¼é”
        Boolean lock001 = redisTemplate.opsForValue().setIfAbsent("lock001", "001");
        if(lock001){
            //è·å–é”è¿™ä¸ªäººå»æ‰§è¡Œè¿™é‡Œè¾¹çš„ä»£ç 
        }
        synchronized (this){
            //å†æ¬¡ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸€ä¸‹
            jsonString = (String) redisTemplate.opsForValue().get("course:" + courseId);
            if(StringUtils.isNotEmpty(jsonString)){
                //å°†jsonè½¬æˆå¯¹è±¡è¿”å›
                CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.class);
                return coursePublish;
            }
            System.out.println("ä»æ•°æ®åº“æŸ¥è¯¢...");
            //å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œè¦ä»æ•°æ®åº“æŸ¥è¯¢
            CoursePublish coursePublish = coursePublishMapper.selectById(courseId);
            //å°†ä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„æ•°æ®å­˜å…¥ç¼“å­˜
            redisTemplate.opsForValue().set("course:" + courseId,JSON.toJSONString(coursePublish),300, TimeUnit.SECONDS);

            return coursePublish ;
        }
    }
}
```



(4) åŸºäº`redisson`å®ç°ï¼Œ`redisson`åˆ†å¸ƒå¼é”ä¼˜åŠ¿å¦‚ä¸‹ï¼š

- å°†å¤šä¸ª`redis`æ“ä½œluaè„šæœ¬ä½œä¸ºæ•´ä½“æäº¤ï¼Œä¿è¯æ€§èƒ½çš„åŒæ—¶ä¿è¯æ•´ä½“åŸå­æ€§

- çœ‹é—¨ç‹—è‡ªåŠ¨å»¶ç»­é”ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢æœªå¤„ç†å®Œé”è¿‡æœŸé—®é¢˜ï¼Œä½†æ˜¯åŒæ—¶é€ æˆäº†é˜»å¡ï¼Œç”šè‡³é”æ­»

- å®ç°äº†è‡ªæ—‹é” ï¼šå‘ç°é”è¢«å ç”¨å`get ttl`è¿›è¡Œ`while true`å¯¹åº”çš„æ—¶é—´

- å®ç°äº†é‡å…¥é” ï¼šå‘ç°é”åå†çœ‹ä¸€ä¸‹`clientid`æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯+1

```java
//è§£å†³ç¼“å­˜å‡»ç©¿ï¼Œä½¿ç”¨Redissionå®ç°åˆ†å¸ƒå¼é” 3.0
public CoursePublish getCoursePublishCache(Long courseId){
    //å…ˆä»ç¼“å­˜ä¸­æŸ¥è¯¢
    String jsonString = (String) redisTemplate.opsForValue().get("course:" + courseId);
    if(StringUtils.isNotEmpty(jsonString)){
        System.out.println("========ä»ç¼“å­˜ä¸­æŸ¥è¯¢===========");
        //å°†jsonè½¬æˆå¯¹è±¡è¿”å›
        CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.class);
        return coursePublish;
    }else{
        //ä½¿ç”¨setnxå‘redisè®¾ç½®ä¸€ä¸ªkeyï¼Œè°è®¾ç½®æˆåŠŸè°æ‹¿åˆ°äº†é”
        // Boolean lock001 = redisTemplate.opsForValue().setIfAbsent("lock001", "001",300,TimeUnit.SECONDS);
        //ä½¿ç”¨redissonè·å–é”
        RLock lock = redissonClient.getLock("coursequery:" + courseId);  //ä¸ºæ¯ä¸ªcourseéƒ½è®¾ç½®é”
        //è·å–åˆ†å¸ƒå¼é”
        lock.lock();
        //æ‹¿åˆ°é”çš„æ‰ä¼šæ‰§è¡Œtry finallyä»£ç å—
        try{
            //   Thread.sleep(35000);
            //å†æ¬¡ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸€ä¸‹
            jsonString = (String) redisTemplate.opsForValue().get("course:" + courseId);
            if(StringUtils.isNotEmpty(jsonString)){
                //å°†jsonè½¬æˆå¯¹è±¡è¿”å›
                CoursePublish coursePublish = JSON.parseObject(jsonString, CoursePublish.class);
                return coursePublish;
            }
            System.out.println("ä»æ•°æ®åº“æŸ¥è¯¢...");
            //å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œè¦ä»æ•°æ®åº“æŸ¥è¯¢
            CoursePublish coursePublish = coursePublishMapper.selectById(courseId);
            //å°†ä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„æ•°æ®å­˜å…¥ç¼“å­˜ ,ç¼“å­˜ä¸­è®¾ç½®Keyä¸º "course:id"
            redisTemplate.opsForValue().set("course:" + courseId,JSON.toJSONString(coursePublish),300, TimeUnit.SECONDS);
            return coursePublish ;
        }finally {
            //é‡Šæ”¾é” ä¸ç®¡è¿‡ä¸è¿‡æœŸ ä¸šåŠ¡å®Œæˆåè¿˜æ˜¯å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾
            lock.unlock();  // redissonè§£é”æ–¹æ³•å†…éƒ¨å°è£…äº†luaè„šæœ¬ä¿è¯åŸå­æ€§
        }
    }
}
```



å†è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œè™½ç„¶`Redisson`è§£å†³äº†é”è¿‡æœŸæ—¶é—´æ— æ³•ç¡®å®šçš„é—®é¢˜(é€šè¿‡åå°`WatchDog`çº¿ç¨‹å®ç°é”è‡ªåŠ¨ç»­æœŸ)ï¼Œä½†æ˜¯å‡å¦‚å½“å‰çº¿ç¨‹å‡ºç°å¼‚å¸¸å¹¶æ²¡æœ‰æ‰§è¡Œ`finally`ä»£ç å—ä¸­çš„`unlock()`æ–¹æ³•ï¼Œè¿™å’Œä¹‹å‰`setnx`å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”å‡ºç°çš„é—®é¢˜ä¸€æ ·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹`redisson`æºç æ˜¯å¦‚ä½•ä¿è¯é”ä¸€å®šä¼šè¢«é‡Šæ”¾çš„ï¼š

```java
// é”é‡Šæ”¾ï¼Œè°ƒç”¨unlockAsync(Thread.currentThread().getId()) æ–¹æ³•æ¥å¼‚æ­¥æ‰§è¡Œé”çš„é‡Šæ”¾æ“ä½œ
public void unlock() {
    try {
        get(unlockAsync(Thread.currentThread().getId()));
    } catch (RedisException e) {
        if (e.getCause() instanceof IllegalMonitorStateException) {
            throw (IllegalMonitorStateException) e.getCause();
        } else {
            throw e;
        }
    }
}

// è¿›å…¥ unlockAsync(Thread.currentThread().getId()) æ–¹æ³• å…¥å‚æ˜¯å½“å‰çº¿ç¨‹çš„id
public RFuture<Void> unlockAsync(long threadId) {
    RPromise<Void> result = new RedissonPromise<Void>();
    //æ‰§è¡Œluaè„šæœ¬ åˆ é™¤key
    RFuture<Boolean> future = unlockInnerAsync(threadId);

    future.onComplete((opStatus, e) -> {
        // æ— è®ºæ‰§è¡Œluaè„šæœ¬æ˜¯å¦æˆåŠŸ æ‰§è¡ŒcancelExpirationRenewal(threadId) æ–¹æ³•æ¥åˆ é™¤EXPIRATION_RENEWAL_MAPä¸­çš„ç¼“å­˜
        cancelExpirationRenewal(threadId); //åœæ­¢é”çš„ç»­æœŸæœºåˆ¶

        if (e != null) {
            result.tryFailure(e);
            return;
        }

        if (opStatus == null) {
            IllegalMonitorStateException cause = new IllegalMonitorStateException("attempt to unlock lock, not locked by current thread by node id: "
                    + id + " thread-id: " + threadId);
            result.tryFailure(cause);
            return;
        }

        result.trySuccess(null);
    });

    return result;
}

// æ­¤æ–¹æ³•ä¼šåœæ­¢ watch dog æœºåˆ¶
/*
ä» EXPIRATION_RENEWAL_MAP ä¸­æŸ¥æ‰¾ä¸å½“å‰é”å…³è”çš„ç»­æœŸä»»åŠ¡ï¼Œ
ç„¶åæ ¹æ® threadId æ¥åˆ é™¤å¯¹åº”çš„çº¿ç¨‹æ ‡è¯†ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–çº¿ç¨‹åœ¨æŒæœ‰é”ã€‚
å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰é”ï¼Œå°±ä¼šå–æ¶ˆç»­æœŸä»»åŠ¡å¹¶å°†å…¶ä» EXPIRATION_RENEWAL_MAP ä¸­ç§»é™¤ã€‚
*/
void cancelExpirationRenewal(Long threadId) {
    ExpirationEntry task = EXPIRATION_RENEWAL_MAP.get(getEntryName());
    if (task == null) {
        return;
    }
    
    if (threadId != null) {
        task.removeThreadId(threadId);
    }

    if (threadId == null || task.hasNoThreads()) {
        Timeout timeout = task.getTimeout();
        if (timeout != null) {
            timeout.cancel();
        }
        EXPIRATION_RENEWAL_MAP.remove(getEntryName());
    }
}
```

é‡Šæ”¾é”çš„æ“ä½œä¸­ æœ‰ä¸€æ­¥æ“ä½œæ˜¯ä» EXPIRATION_RENEWAL_MAP ä¸­è·å– `ExpirationEntry` å¯¹è±¡ï¼Œç„¶åå°†å…¶removeï¼Œç»“åˆwatch dogä¸­çš„ç»­æœŸå‰çš„åˆ¤æ–­ï¼š

```java
EXPIRATION_RENEWAL_MAP.get(getEntryName());
if (ent == null) {
    return;
}
```

å¯ä»¥å¾—å‡ºç»“è®ºï¼šå¦‚æœé‡Šæ”¾é”æ“ä½œæœ¬èº«å¼‚å¸¸äº†ï¼Œwatch dog è¿˜ä¼šä¸åœçš„ç»­æœŸå—ï¼Ÿä¸ä¼šï¼Œå› ä¸ºæ— è®ºé‡Šæ”¾é”æ“ä½œæ˜¯å¦æˆåŠŸï¼Œ`EXPIRATION_RENEWAL_MAP`ä¸­çš„ç›®æ ‡ `ExpirationEntry` å¯¹è±¡å·²ç»è¢«ç§»é™¤äº†(å› ä¸ºçº¿ç¨‹å¼‚å¸¸é€€å‡ºäº†ï¼Œåœ¨ä¿å­˜å½“å‰æ´»è·ƒçº¿ç¨‹çš„Mapé‡Œä¹Ÿæ‰¾ä¸åˆ°äº†)ï¼Œ`watch dog`é€šè¿‡åˆ¤æ–­åå°±ä¸ä¼šç»§ç»­ç»™é”ç»­æœŸäº†





æ¥æ€»ç»“ä¸€ä¸‹ï¼š :expressionless:

ï¼ˆ1ï¼‰åŸºäº`synchronized`çš„åŒæ­¥é”é—®é¢˜ï¼š

`synchronized`é”çš„æ˜¯å½“å‰JVMï¼Œå¦‚æœ**å¤šä¸ªJVMè¿›ç¨‹**åŒæ—¶è®¿é—®ä¸€ä¸ªæ¥å£ï¼Œæ­¤æ—¶å†ä½¿ç”¨åŒæ­¥é”æ˜¯é”ä¸ä½çš„ï¼šå³ä¸€ä¸ªåŒæ­¥é”ç¨‹åºåªèƒ½ä¿è¯åŒä¸€ä¸ªè™šæ‹Ÿæœºä¸­å¤šä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æŸ¥æ•°æ®åº“ï¼Œå¦‚æœé«˜å¹¶å‘æƒ…å†µä¸‹é€šè¿‡ç½‘å…³è´Ÿè½½å‡è¡¡è½¬å‘ç»™å¤šä¸ªè™šæ‹Ÿæœºï¼Œæ­¤æ—¶å°±ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹å»æŸ¥è¯¢æ•°æ®åº“çš„æƒ…å†µï¼Œå› ä¸º**åŒæ­¥é”ï¼ˆè™šæ‹Ÿæœºå†…éƒ¨çš„é”ï¼‰æ— æ³•è·¨è™šæ‹Ÿæœºä¿è¯åŒæ­¥æ‰§è¡Œ**





ï¼ˆ2ï¼‰åŸºäº`setnx`å®ç°åˆ†å¸ƒå¼é”çš„é—®é¢˜ï¼š

`SETNX` å‘½ä»¤æ˜¯ Redis ä¸­ç”¨äºå®ç°åˆ†å¸ƒå¼é”çš„ç»å…¸æ–¹æ¡ˆä¹‹ä¸€ã€‚å®ƒå¯ä»¥å°†ä¸€ä¸ªæŒ‡å®šçš„ key è®¾ç½®ä¸ºä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œåªæœ‰å½“è¿™ä¸ª key ä¸å­˜åœ¨æ—¶æ‰èƒ½è®¾ç½®æˆåŠŸï¼Œä½†æ˜¯å½“å¤šä¸ªJVMåŒæ—¶å°è¯•è·å–åŒä¸€ä¸ªé”æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªJVMè¿›ç¨‹è·å–æˆåŠŸåéœ€è¦è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´è®¾ç½®è¿‡å°ä¼šå¯¼è‡´å½“å‰è¯·æ±‚è¿˜æœªå¤„ç†å®Œé”å°±è¢«é‡Šæ”¾ï¼›æ—¶é—´è®¾ç½®è¿‡é•¿åˆä¼šå¯¼è‡´èµ„æºæµªè´¹ï¼›è€Œå¦‚æœé‡‡å–å¤„ç†å®Œè¯·æ±‚åæ‰‹åŠ¨é‡Šæ”¾é”çš„æ–¹æ³•ï¼Œåˆä¼šäº§ç”ŸåŸå­æ€§é—®é¢˜ï¼š

```
if(ç¼“å­˜é‡Œæœ‰)
{
è¿”å›ç¼“å­˜é‡Œæ•°æ®
}else{
è·å–åˆ†å¸ƒå¼é”ï¼š set lock 01 NX
if(è·å–é”æˆåŠŸ)
{
try{
æŸ¥è¯¢æ•°æ®åº“
}
finally{
# if(redis.call("get","lock")=="01"){
# é‡Šæ”¾é”: redis.call("del","lock")
                }
           }
      }
}
```

å¯ä»¥çœ‹å‡ºredisåœ¨æ‰§è¡Œå¸¦`#`çš„ä¸¤è¡Œä»£ç æ—¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œæ•…éœ€è¦é€šè¿‡`lua`è„šæœ¬ä¿è¯åŸå­æ€§ï¼š

è§£é”è„šæœ¬çš„ä¸€ä¸ªä¾‹å­å°†ç±»ä¼¼äºä»¥ä¸‹ï¼š

```lua
if redis.call("get",KEYS[1]) == ARGV[1]
then
    return redis.call("del",KEYS[1])
else
    return 0
end
```



**ç¼ºç‚¹1ï¼š**`setnx`é”æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯å®ƒåŠ é”æ—¶åªä½œç”¨åœ¨ä¸€ä¸ª Redis èŠ‚ç‚¹ä¸Šï¼Œå³ä½¿ Redis é€šè¿‡ Sentinel(å“¨å²—ã€å“¨å…µ) ä¿è¯é«˜å¯ç”¨ï¼Œå¦‚æœè¿™ä¸ª master èŠ‚ç‚¹ç”±äºæŸäº›åŸå› å‘ç”Ÿäº†ä¸»ä»åˆ‡æ¢ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é”ä¸¢å¤±çš„æƒ…å†µï¼Œä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼š

1. åœ¨ Redis çš„ master èŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼›
2. ä½†æ˜¯è¿™ä¸ªåŠ é”çš„ key è¿˜æ²¡æœ‰åŒæ­¥åˆ° slave èŠ‚ç‚¹ï¼›
3. master æ•…éšœï¼Œå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œslave èŠ‚ç‚¹å‡çº§ä¸º masterèŠ‚ç‚¹ï¼›
4. ä¸Šè¾¹ master èŠ‚ç‚¹ä¸Šçš„é”ä¸¢å¤±

æœ‰çš„æ—¶å€™ç”šè‡³ä¸å•å•æ˜¯é”ä¸¢å¤±è¿™ä¹ˆç®€å•ï¼Œæ–°é€‰å‡ºæ¥çš„ master èŠ‚ç‚¹å¯ä»¥é‡æ–°è·å–åŒæ ·çš„é”ï¼Œå‡ºç°ä¸€æŠŠé”è¢«æ‹¿ä¸¤æ¬¡çš„åœºæ™¯ã€‚

é”è¢«æ‹¿ä¸¤æ¬¡ï¼Œä¹Ÿå°±ä¸èƒ½æ»¡è¶³å®‰å…¨æ€§äº†...

å®é™…ä¸Š`Redisson`å®ç°åˆ†å¸ƒå¼é”ä¹Ÿæœ‰ç±»ä¼¼é—®é¢˜(å› ä¸ºåº•å±‚å®ç°å°±æ˜¯setnx)ã€‚ã€‚ã€‚

> è§£å†³æ–¹æ¡ˆï¼š`RedLock`ç®—æ³•ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨äº‰è®®  [Redisé”ä»é¢è¯•è¿ç¯ç‚®èŠåˆ°ç¥ä»™æ‰“æ¶](https://mp.weixin.qq.com/s?__biz=Mzg3NjU3NTkwMQ==&mid=2247505097&idx=1&sn=5c03cb769c4458350f4d4a321ad51f5a&source=41&poc_token=HH9_u2SjM7RlF6CSz2UMIAzVXLsAAOL1-Tqt9kNw)

**ç¼ºç‚¹2ï¼š**ä¸”ä½¿ç”¨`setnx`é”æ—¶è¦è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªè¿‡æœŸæ—¶é—´ä¸å¥½æŠŠæ¡(`Redisson`ä½¿ç”¨çœ‹é—¨ç‹—æœºåˆ¶è§£å†³)

**ç¼ºç‚¹3ï¼š**`SETNX` å‘½ä»¤åˆ›å»ºçš„é”æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå³åŒä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æŒæœ‰é”æœŸé—´æ— æ³•å†æ¬¡è·å–é”ï¼Œå¦åˆ™ä¼šå‡ºç°æ­»é”(`Redisson`æ”¯æŒå¯é‡å…¥)





(3)åŸºäºRedissonå®ç°åˆ†å¸ƒå¼é”ï¼š

> éœ€è¦çš„å‰ç½®çŸ¥è¯†ï¼š
>
> `HEXISTS` æ˜¯ Redis æ•°æ®åº“ä¸­çš„ä¸€ä¸ªå‘½ä»¤ï¼Œç”¨äºæ£€æŸ¥æŒ‡å®šå“ˆå¸Œè¡¨ï¼ˆHashï¼‰ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šå­—æ®µï¼ˆFieldï¼‰ï¼›
>
> `PTTL` æ˜¯ Redis æ•°æ®åº“ä¸­çš„ä¸€ä¸ªå‘½ä»¤ï¼Œç”¨äºè·å–æŒ‡å®šé”®ï¼ˆKeyï¼‰çš„å‰©ä½™è¿‡æœŸæ—¶é—´(æ¯«ç§’)

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%9C%8B%E9%97%A8%E7%8B%97.png)



åŒæ—¶Redissonæ”¯æŒå¯é‡å…¥é”ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%8F%AF%E9%87%8D%E5%85%A5.png)



Redissonçš„åŠ é”æœºåˆ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹å»è·å–é”ï¼Œè·å–æˆåŠŸåˆ™æ‰§è¡Œluaè„šæœ¬ï¼Œä¿å­˜æ•°æ®åˆ°redisæ•°æ®åº“ã€‚å¦‚æœè·å–å¤±è´¥: ä¸€ç›´é€šè¿‡whileå¾ªç¯å°è¯•è·å–é”(å¯è‡ªå®šä¹‰ç­‰å¾…æ—¶é—´ï¼Œè¶…æ—¶åè¿”å›å¤±è´¥)ï¼Œè·å–æˆåŠŸåï¼Œæ‰§è¡Œluaè„šæœ¬ï¼Œä¿å­˜æ•°æ®åˆ°redisï¼š

![Redisson](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redisson.jpg)

å¦‚æœæ‹¿åˆ°åˆ†å¸ƒå¼é”çš„èŠ‚ç‚¹å®•æœºï¼Œä¸”è¿™ä¸ªé”æ­£å¥½å¤„äºé”ä½çš„çŠ¶æ€æ—¶ï¼Œä¼šå‡ºç°é”æ­»çš„çŠ¶æ€ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œé”éƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚è¿™æ ·ä¹Ÿå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼ŒåŠ å…¥ä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°äº†é”è®¾ç½®äº†30sè¶…æ—¶ï¼Œåœ¨30såè¿™ä¸ªçº¿ç¨‹è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œé”è¶…æ—¶é‡Šæ”¾äº†ï¼Œå°±ä¼šå¯¼è‡´é—®é¢˜ï¼ŒRedissonç»™å‡ºäº†è‡ªå·±çš„ç­”æ¡ˆï¼Œè‡ªåŠ¨å»¶æœŸ(Watch Dog)æœºåˆ¶:

Redissonæä¾›äº†ä¸€ä¸ªç›‘æ§é”çš„çœ‹é—¨ç‹—çº¿ç¨‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨Redissonå®ä¾‹è¢«å…³é—­å‰ï¼Œä¸æ–­çš„å»¶é•¿é”çš„æœ‰æ•ˆæœŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªæ‹¿åˆ°é”çš„çº¿ç¨‹ä¸€ç›´æ²¡æœ‰å®Œæˆé€»è¾‘ï¼Œé‚£ä¹ˆçœ‹é—¨ç‹—ä¼šå¸®åŠ©çº¿ç¨‹ä¸æ–­çš„å»¶é•¿é”è¶…æ—¶æ—¶é—´ï¼Œé”ä¸ä¼šå› ä¸ºè¶…æ—¶è€Œè¢«é‡Šæ”¾ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œçœ‹é—¨ç‹—çš„ç»­æœŸæ—¶é—´æ˜¯30sï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹Config.lockWatchdogTimeoutæ¥å¦è¡ŒæŒ‡å®š







**`Redisson`å®ç°åˆ†å¸ƒå¼é”ä¹Ÿæœ‰ä½¿ç”¨`setnx`åˆ†å¸ƒå¼é”ç±»ä¼¼çš„é—®é¢˜ï¼Œæ•…å¼•å‡ºåé¢çš„çº¢é”ç®—æ³•**





### RedLockç®—æ³•



åˆ†å¸ƒå¼é”è§£å†³äº†**åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ§åˆ¶å…±äº«èµ„æºè®¿é—®**çš„é—®é¢˜ã€‚ä¸å•ä½“åº”ç”¨ä¸åŒçš„æ˜¯ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç«äº‰å…±äº«èµ„æºçš„æœ€å°ç²’åº¦**ä»çº¿ç¨‹å‡çº§æˆäº†è¿›ç¨‹**ï¼Œè¦äº†è§£`RedLock`ç®—æ³•ï¼Œé¦–å…ˆåº”è¯¥çŸ¥é“`Redisson`ï¼Œ`Redisson`æä¾›äº†å¤šæ ·åŒ–çš„é”ï¼š

- å¯é‡å…¥é”ï¼ˆ`Reentrant Lock`ï¼‰ï¼š`Redisson`æä¾›äº†`RLock`æ¥å£æ¥å®ç°å¯é‡å…¥é”ï¼Œå¸¸ç”¨çš„å®ç°ç±»æ˜¯`RedissonReentrantLock`
- çº¢é”ï¼ˆ`RedLock`ï¼‰ï¼š`Redisson`æä¾›äº†`RRedLock`æ¥å£æ¥å®ç°çº¢é”ï¼Œé€šè¿‡`RedissonRedLock`å®ç°ç±»æ¥ç®¡ç†å¤šä¸ªé”ã€‚
- è¯»å†™é”ï¼ˆ`ReadWrite Lock`ï¼‰ï¼š`Redisson`æä¾›äº†`RReadWriteLock`æ¥å£æ¥å®ç°è¯»å†™é”ï¼Œé€šè¿‡`RedissonReadWriteLock`å®ç°ç±»æ¥ç®¡ç†è¯»å†™é”
- ä¿¡å·é‡ï¼ˆ`Semaphore`ï¼‰ï¼š`Redisson`æä¾›äº†`RSemaphore`æ¥å£æ¥å®ç°ä¿¡å·é‡ï¼Œé€šè¿‡`RedissonSemaphore`å®ç°ç±»æ¥ç®¡ç†ä¿¡å·é‡
- é—­é”ï¼ˆ`CountDownLatch`ï¼‰ï¼š`Redisson`æä¾›äº†`RCountDownLatch`æ¥å£æ¥å®ç°é—­é”ï¼Œé€šè¿‡`RedissonCountDownLatch`å®ç°ç±»æ¥ç®¡ç†é—­é”



`RedLock`ç®—æ³•ä½¿ç”¨äº†å¤šä¸ªç‹¬ç«‹çš„Rediså®ä¾‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š

1. é€‰æ‹©å¤šä¸ªç‹¬ç«‹çš„Rediså®ä¾‹ï¼ˆä¸€èˆ¬æ˜¯5ä¸ªï¼‰ä½œä¸ºé”çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œè¿™äº›å®ä¾‹åº”è¯¥åˆ†å¸ƒåœ¨ä¸åŒçš„ç‰©ç†èŠ‚ç‚¹ä¸Šï¼Œä»¥é™ä½æ•…éšœçš„æ¦‚ç‡ã€‚
2. å½“å®¢æˆ·ç«¯è¦è·å–é”æ—¶ï¼Œå®ƒä¼šåœ¨æ‰€æœ‰Rediså®ä¾‹ä¸Šåˆ†åˆ«æ‰§è¡ŒSETNXå‘½ä»¤ã€‚å¦‚æœè‡³å°‘æœ‰ä¸€åŠï¼ˆå³å¤§å¤šæ•°ï¼‰çš„Rediså®ä¾‹è¿”å›æˆåŠŸï¼ˆå³è·å–åˆ°äº†é”ï¼‰ï¼Œåˆ™å®¢æˆ·ç«¯è®¤ä¸ºè‡ªå·±è·å–åˆ°äº†é”ã€‚
3. å½“å®¢æˆ·ç«¯è¦é‡Šæ”¾é”æ—¶ï¼Œå®ƒä¼šåœ¨æ‰€æœ‰Rediså®ä¾‹ä¸Šæ‰§è¡ŒDELå‘½ä»¤ï¼Œä»¥ç¡®ä¿é”è¢«æ­£ç¡®é‡Šæ”¾ã€‚





**åœ¨ Redis çš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ N ä¸ª Redis Masterã€‚è¿™äº›èŠ‚ç‚¹å®Œå…¨äº’ç›¸ç‹¬ç«‹ï¼Œä¸å­˜åœ¨ä¸»ä»å¤åˆ¶æˆ–è€…å…¶ä»–é›†ç¾¤åè°ƒæœºåˆ¶ã€‚**

å‰é¢å·²ç»æè¿°äº†åœ¨å•ç‚¹ Redis ä¸‹ï¼Œæ€ä¹ˆå®‰å…¨åœ°è·å–å’Œé‡Šæ”¾é”ï¼Œæˆ‘ä»¬ç¡®ä¿å°†åœ¨ N ä¸ªå®ä¾‹ä¸Šä½¿ç”¨æ­¤æ–¹æ³•è·å–å’Œé‡Šæ”¾é”ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æœ‰ 5 ä¸ªå®Œå…¨ç‹¬ç«‹çš„ Redis Master èŠ‚ç‚¹ï¼Œä»–ä»¬åˆ†åˆ«è¿è¡Œåœ¨ 5 å°æœåŠ¡å™¨ä¸­ï¼Œå¯ä»¥ä¿è¯ä»–ä»¬ä¸ä¼šåŒæ—¶å®•æœº

ä»å®˜ç½‘ä¸Šæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å¦‚æœè¦è·å¾—é”ï¼Œå¿…é¡»ç»è¿‡ä¸‹é¢çš„äº”ä¸ªæ­¥éª¤ï¼š

1. è·å–å½“å‰Unixæ—¶é—´ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚
2. ä¾æ¬¡å°è¯•ä»5ä¸ªå®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒçš„keyå’Œå…·æœ‰å”¯ä¸€æ€§çš„valueï¼ˆä¾‹å¦‚UUIDï¼‰è·å–é”ã€‚å½“å‘Redisè¯·æ±‚è·å–é”æ—¶ï¼Œå®¢æˆ·ç«¯åº”è¯¥è®¾ç½®ä¸€ä¸ªå°è¯•ä»æŸä¸ªRediså®ä¾‹è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œåˆ™ç«‹é©¬è¯¢é—®ä¸‹ä¸€ä¸ªå®ä¾‹ï¼‰ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´åº”è¯¥å°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚ä¾‹å¦‚ä½ çš„é”è‡ªåŠ¨å¤±æ•ˆæ—¶é—´ä¸º10ç§’ï¼Œåˆ™è¶…æ—¶æ—¶é—´åº”è¯¥åœ¨5-50æ¯«ç§’ä¹‹é—´ã€‚è¿™æ ·å¯ä»¥é¿å…æœåŠ¡å™¨ç«¯Rediså·²ç»æŒ‚æ‰çš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¿˜åœ¨æ­»æ­»åœ°ç­‰å¾…å“åº”ç»“æœã€‚å¦‚æœæœåŠ¡å™¨ç«¯æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°½å¿«å°è¯•å»å¦å¤–ä¸€ä¸ªRediså®ä¾‹è¯·æ±‚è·å–é”ã€‚
3. å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”æ—¶é—´ï¼ˆæ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰å°±å¾—åˆ°è·å–é”æ¶ˆè€—çš„æ—¶é—´ã€‚å½“ä¸”ä»…å½“ä»å¤§å¤šæ•°ï¼ˆN/2+1ï¼Œè¿™é‡Œæ˜¯3ä¸ªèŠ‚ç‚¹ï¼‰çš„RedisèŠ‚ç‚¹éƒ½å–åˆ°é”ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ€»è€—æ—¶å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸã€‚
4. å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´ = æœ‰æ•ˆæ—¶é—´ï¼ˆ**è·å–é”æ—¶è®¾ç½®çš„keyçš„è‡ªåŠ¨è¶…æ—¶æ—¶é—´ï¼‰ - è·å–é”çš„æ€»è€—æ—¶ï¼ˆè¯¢é—®å„ä¸ªRediså®ä¾‹çš„æ€»è€—æ—¶ä¹‹å’Œï¼‰**å³æ­¥éª¤3è®¡ç®—çš„ç»“æœ:ä¸‹å›¾ä¸­ä¸º9000æ¯«ç§’
5. å¦‚æœå› ä¸ºæŸäº›åŸå› ï¼Œæœ€ç»ˆè·å–é”å¤±è´¥ï¼ˆå³æ²¡æœ‰åœ¨è‡³å°‘ â€œN/2+1 â€ä¸ªRediså®ä¾‹å–åˆ°é”æˆ–è€…â€œè·å–é”çš„æ€»è€—æ—¶â€è¶…è¿‡äº†â€œæœ‰æ•ˆæ—¶é—´â€ï¼‰ï¼Œå®¢æˆ·ç«¯åº”è¯¥åœ¨æ‰€æœ‰çš„Rediså®ä¾‹ä¸Šè¿›è¡Œè§£é”ï¼ˆå³ä¾¿æŸäº›Rediså®ä¾‹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢æŸäº›èŠ‚ç‚¹è·å–åˆ°é”ä½†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å¾—åˆ°å“åº”è€Œå¯¼è‡´æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ä¸èƒ½è¢«é‡æ–°è·å–é”ï¼‰



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/redlock5.png)



å¤šä¸ªjvmè¿›ç¨‹å°è¯•å»ä¿®æ”¹redisä¸­ä¸€ä¸ªkey  setnx   setnxè®¾ç½®æˆåŠŸçš„çº¿ç¨‹æ‰èƒ½è·å¾—è¯¥é”ï¼Œç„¶åå†å»ä¿®æ”¹æ•°æ®åº“ä¸­çš„ç¥¨æ•°ï¼Œ







## æ•°æ®ä¸¢å¤±é—®é¢˜  :imp:



åœ¨ä¸»ä»åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿæ•°æ®ä¸¢å¤±çš„æƒ…å†µæœ‰ä¸¤ç§ï¼š

- å¼‚æ­¥å¤åˆ¶åŒæ­¥ä¸¢å¤±
- é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤±



**1ã€å¼‚æ­¥å¤åˆ¶ä¸¢å¤±æ•°æ®ï¼š**

å¯¹äº Redis ä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®å¤åˆ¶ï¼Œæ˜¯å¼‚æ­¥å¤åˆ¶çš„ï¼Œå½“å®¢æˆ·ç«¯å‘é€å†™è¯·æ±‚ç»™ä¸»èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¼šè¿”å› okï¼Œæ¥ç€ä¸»èŠ‚ç‚¹å°†å†™è¯·æ±‚å¼‚æ­¥åŒæ­¥ç»™å„ä¸ªä»èŠ‚ç‚¹ï¼Œ**ä½†æ˜¯å¦‚æœæ­¤æ—¶ä¸»èŠ‚ç‚¹è¿˜æ²¡æ¥å¾—åŠåŒæ­¥ç»™ä»èŠ‚ç‚¹æ—¶å‘ç”Ÿäº†æ–­ç”µï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å†…å­˜ä¸­çš„æ•°æ®ä¼šä¸¢å¤±ã€‚** 



>  é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜å‘¢ï¼Ÿ



å¯¹äºæœåŠ¡å™¨ç«¯ï¼š

Redis é…ç½®é‡Œæœ‰ä¸€ä¸ªå‚æ•° min-slaves-max-lagï¼Œè¡¨ç¤ºä¸€æ—¦æ‰€æœ‰çš„ä»èŠ‚ç‚¹æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿéƒ½è¶…è¿‡äº† min-slaves-max-lag å®šä¹‰çš„å€¼ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å°±ä¼šæ‹’ç»æ¥æ”¶ä»»ä½•è¯·æ±‚

å‡è®¾å°† min-slaves-max-lag é…ç½®ä¸º 10s åï¼Œæ ¹æ®ç›®å‰ master->slave çš„å¤åˆ¶é€Ÿåº¦ï¼Œå¦‚æœæ•°æ®åŒæ­¥å®Œæˆæ‰€éœ€è¦æ—¶é—´è¶…è¿‡10sï¼Œå°±ä¼šè®¤ä¸º master æœªæ¥å®•æœºåæŸå¤±çš„æ•°æ®ä¼šå¾ˆå¤šï¼Œmaster å°±æ‹’ç»å†™å…¥æ–°è¯·æ±‚ã€‚è¿™æ ·å°±èƒ½å°† master å’Œ slave æ•°æ®å·®æ§åˆ¶åœ¨10så†…ï¼Œå³ä½¿ master å®•æœºä¹Ÿåªæ˜¯è¿™æœªå¤åˆ¶çš„ 10s æ•°æ®



å¯¹äºå®¢æˆ·ç«¯ï¼š

é‚£ä¹ˆå¯¹äºå®¢æˆ·ç«¯ï¼Œå½“å®¢æˆ·ç«¯å‘ç° master ä¸å¯å†™åï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–é™çº§æªæ–½ï¼Œå°†æ•°æ®æš‚æ—¶å†™å…¥æœ¬åœ°ç¼“å­˜å’Œç£ç›˜ä¸­ï¼Œåœ¨ä¸€æ®µæ—¶é—´ï¼ˆç­‰ master æ¢å¤æ­£å¸¸ï¼‰åé‡æ–°å†™å…¥ master æ¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œä¹Ÿå¯ä»¥å°†æ•°æ®å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰ master æ¢å¤æ­£å¸¸ï¼Œå†éš”ä¸€æ®µæ—¶é—´å»æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œè®©å°†æ•°æ®é‡æ–°å†™å…¥ master







**2ã€é›†ç¾¤è„‘è£‚ä¸¢å¤±æ•°æ®**

åœ¨ Redis ä¸­ï¼Œé›†ç¾¤è„‘è£‚äº§ç”Ÿæ•°æ®ä¸¢å¤±çš„ç°è±¡æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

åœ¨ Redis ä¸»ä»æ¶æ„ä¸­ï¼Œéƒ¨ç½²æ–¹å¼ä¸€èˆ¬æ˜¯ã€Œä¸€ä¸»å¤šä»ã€ï¼Œä¸»èŠ‚ç‚¹æä¾›å†™æ“ä½œï¼Œä»èŠ‚ç‚¹æä¾›è¯»æ“ä½œã€‚

å¦‚æœä¸»èŠ‚ç‚¹çš„ç½‘ç»œçªç„¶å‘ç”Ÿäº†é—®é¢˜ï¼Œå®ƒä¸æ‰€æœ‰çš„ä»èŠ‚ç‚¹éƒ½å¤±è”äº†ï¼Œä½†æ˜¯æ­¤æ—¶çš„ä¸»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯çš„ç½‘ç»œæ˜¯æ­£å¸¸çš„ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“ Redis å†…éƒ¨å·²ç»å‡ºç°äº†é—®é¢˜ï¼Œè¿˜åœ¨å‘è¿™ä¸ªå¤±è”çš„ä¸»èŠ‚ç‚¹å†™æ•°æ®ï¼ˆè¿‡ç¨‹Aï¼‰ï¼Œæ­¤æ—¶è¿™äº›æ•°æ®è¢«ä¸»èŠ‚ç‚¹ç¼“å­˜åˆ°äº†ç¼“å†²åŒº(`Replication Buffer`)é‡Œï¼Œå› ä¸ºä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œé—®é¢˜ï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯æ— æ³•åŒæ­¥ç»™ä»èŠ‚ç‚¹çš„ã€‚

è¿™æ—¶ï¼Œå“¨å…µä¹Ÿå‘ç°ä¸»èŠ‚ç‚¹å¤±è”äº†ï¼Œå®ƒå°±è®¤ä¸ºä¸»èŠ‚ç‚¹æŒ‚äº†ï¼ˆä½†å®é™…ä¸Šä¸»èŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯ç½‘ç»œå‡ºé—®é¢˜äº†ï¼‰ï¼Œäºæ˜¯å“¨å…µå°±ä¼šåœ¨ä»èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ª leader ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿™æ—¶é›†ç¾¤å°±æœ‰ä¸¤ä¸ªä¸»èŠ‚ç‚¹äº† â€”â€” **è„‘è£‚å‡ºç°äº†**

è¿™æ—¶å€™ç½‘ç»œçªç„¶å¥½äº†ï¼Œå“¨å…µå› ä¸ºä¹‹å‰å·²ç»é€‰ä¸¾å‡ºä¸€ä¸ªæ–°ä¸»èŠ‚ç‚¹äº†ï¼Œå®ƒå°±ä¼šæŠŠæ—§ä¸»èŠ‚ç‚¹é™çº§ä¸ºä»èŠ‚ç‚¹ï¼ˆAï¼‰ï¼Œç„¶åä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šå‘æ–°ä¸»èŠ‚ç‚¹è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œ**å› ä¸ºç¬¬ä¸€æ¬¡åŒæ­¥æ˜¯å…¨é‡åŒæ­¥çš„æ–¹å¼ï¼Œæ­¤æ—¶çš„ä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šæ¸…ç©ºæ‰è‡ªå·±æœ¬åœ°çš„æ•°æ®ï¼Œç„¶åå†åšå…¨é‡åŒæ­¥ã€‚æ‰€ä»¥ï¼Œä¹‹å‰å®¢æˆ·ç«¯åœ¨è¿‡ç¨‹ A å†™å…¥çš„æ•°æ®å°±ä¼šä¸¢å¤±äº†ï¼Œä¹Ÿå°±æ˜¯é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤±çš„é—®é¢˜**ã€‚

æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡èŠ‚ç‚¹ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„æ•°æ®ï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†



>  é‚£ä¹ˆå¦‚ä½•è§£å†³é›†ç¾¤è„‘è£‚ç°è±¡å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜å‘¢ï¼Ÿ

åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥è®¾ç½®ï¼š

- min-slaves-to-write xï¼Œä¸»èŠ‚ç‚¹å¿…é¡»è¦æœ‰**è‡³å°‘ x ä¸ªä»èŠ‚ç‚¹è¿æ¥**ï¼Œå¦‚æœå°äºè¿™ä¸ªæ•°ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚
- min-slaves-max-lag xï¼Œä¸»ä»æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿ**ä¸èƒ½è¶…è¿‡ x ç§’**ï¼Œå¦‚æœä¸»ä»åŒæ­¥çš„å»¶è¿Ÿè¶…è¿‡ x ç§’ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚



è¿™ä¸¤ä¸ªé…ç½®é¡¹ç»„åˆåçš„è¦æ±‚æ˜¯ï¼Œ**ä¸»èŠ‚ç‚¹è¿æ¥çš„ä»èŠ‚ç‚¹ä¸­è‡³å°‘æœ‰ N ä¸ªä»èŠ‚ç‚¹ï¼Œã€Œå¹¶ä¸”ã€ä¸»èŠ‚ç‚¹è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶ï¼Œæ”¶åˆ°ACK æ¶ˆæ¯å»¶è¿Ÿä¸èƒ½è¶…è¿‡ T ç§’**ï¼Œå¦åˆ™ï¼Œä¸»èŠ‚ç‚¹å°±ä¸ä¼šå†æ¥æ”¶å®¢æˆ·ç«¯çš„å†™è¯·æ±‚äº†ã€‚





å…¶å®ä¸»è¦æ€è·¯å°±æ˜¯ç¦æ­¢å†å¾€å®•æœºçš„ä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œå†™æ“ä½œã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚







## Redisé˜»å¡åŸå› 













# è®¡ç®—æœºç½‘ç»œ



## ä»æµè§ˆå™¨è¾“å…¥URLåˆ°ç½‘é¡µæ˜¾ç¤ºï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ



1ã€æµè§ˆå™¨é¦–å…ˆè¦å°†URLè§£æä¸ºIPåœ°å€ï¼Œè§£æåŸŸåå°±è¦ç”¨åˆ°DNSåè®®ï¼Œ**æµè§ˆå™¨ä¼šå…ˆçœ‹è‡ªèº«æœ‰æ²¡æœ‰å¯¹è¿™ä¸ªåŸŸåçš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›**ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±å»é—®æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼šå»çœ‹è‡ªå·±çš„ç¼“å­˜ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è¿”å›ï¼Œ**å¦‚æœæ²¡æœ‰ï¼Œå†å» hosts æ–‡ä»¶çœ‹ï¼Œä¹Ÿæ²¡æœ‰**ï¼Œ**æ‰ä¼šå»é—®ã€Œæœ¬åœ° DNS æœåŠ¡å™¨ã€**ï¼Œå‘èµ·**DNSæŸ¥è¯¢**ï¼ŒDNSæŸ¥è¯¢åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼šä¸€ç§æ˜¯é€’å½’æŸ¥è¯¢ï¼Œä¸€ç§æ˜¯è¿­ä»£æŸ¥è¯¢ 



**é€’å½’**æŸ¥è¯¢ï¼šå®¢æˆ·ç«¯å‘ä¸€æ¬¡è¯·æ±‚ï¼Œç”±å„çº§DNSæœåŠ¡å™¨ä¾æ¬¡é™çº§æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾æˆåŠŸåç›´æ¥è¿”å›ç»™æœ¬åœ°DNSæœåŠ¡å™¨ï¼Œæœ¬åœ°DNSå†è¿”å›ç»™å®¢æˆ·æœºï¼Œæµç¨‹ä¸º **å®¢æˆ·ç«¯â€”â€”>æœ¬åœ°DNSæœåŠ¡å™¨â€”â€”æ ¹DNSæœåŠ¡å™¨â€”â€”>é¡¶çº§DNSæœåŠ¡å™¨â€”â€”>æƒå¨DNSæœåŠ¡å™¨â€”â€”>æŸ¥æ‰¾æˆåŠŸï¼â€”â€”>æœ¬åœ°DNSæœåŠ¡å™¨â€”â€”>å®¢æˆ·ç«¯**

æ¯”å¦‚ `www.server.com`ï¼Œè¿™é‡Œçš„å¥ç‚¹ä»£è¡¨äº†ä¸åŒå±‚æ¬¡ä¹‹é—´çš„**ç•Œé™**ã€‚

åœ¨åŸŸåä¸­ï¼Œ**è¶Šé å³**çš„ä½ç½®è¡¨ç¤ºå…¶å±‚çº§**è¶Šé«˜**ã€‚å®é™…ä¸ŠåŸŸåæœ€åè¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œæ¯”å¦‚ `www.server.com.`ï¼Œè¿™ä¸ªæœ€åçš„ä¸€ä¸ªç‚¹ä»£è¡¨æ ¹åŸŸåã€‚

ä¹Ÿå°±æ˜¯ï¼Œ`.` æ ¹åŸŸæ˜¯åœ¨æœ€é¡¶å±‚ï¼Œå®ƒçš„ä¸‹ä¸€å±‚å°±æ˜¯ `.com` é¡¶çº§åŸŸï¼Œå†ä¸‹é¢æ˜¯ `server.com`ã€‚

æ‰€ä»¥åŸŸåçš„å±‚çº§å…³ç³»ç±»ä¼¼ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼š

- æ ¹ DNS æœåŠ¡å™¨ï¼ˆ.ï¼‰
- é¡¶çº§åŸŸ DNS æœåŠ¡å™¨ï¼ˆ.comï¼‰
- æƒå¨ DNS æœåŠ¡å™¨ï¼ˆserver.comï¼‰



![DNS æ ‘çŠ¶ç»“æ„](https://github.com/amonstercat/PicGo/blob/main/dell/202403051753818.png?raw=true)

**è¿­ä»£**æŸ¥è¯¢ï¼šå½“æ ¹åŸŸåæœåŠ¡å™¨æ”¶åˆ°æœ¬åœ°åŸŸåæœåŠ¡å™¨å‘å‡ºçš„è¿­ä»£æŸ¥è¯¢è¯·æ±‚æŠ¥æ–‡æ—¶ï¼Œè¦ä¹ˆç»™å‡ºæ‰€è¦æŸ¥è¯¢çš„IPåœ°å€ï¼Œè¦ä¹ˆå‘Šè¯‰æœ¬åœ°æœåŠ¡å™¨ï¼šâ€œä½ ä¸‹ä¸€æ­¥åº”å½“å‘å“ªä¸€ä¸ªåŸŸåæœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢â€ï¼Œç„¶åè®©æœ¬åœ°æœåŠ¡å™¨è¿›è¡Œåç»­çš„æŸ¥è¯¢ï¼Œ**æ ¹åŸŸåæœåŠ¡å™¨**é€šå¸¸æ˜¯æŠŠè‡ªå·±çŸ¥é“çš„é¡¶çº§åŸŸåæœåŠ¡å™¨çš„IPåœ°å€å‘Šè¯‰æœ¬åœ°åŸŸåæœåŠ¡å™¨ï¼Œè®©æœ¬åœ°åŸŸåæœåŠ¡å™¨å†å‘é¡¶çº§åŸŸåæœåŠ¡å™¨æŸ¥è¯¢ã€‚**é¡¶çº§åŸŸåæœåŠ¡å™¨**åœ¨æ”¶åˆ°æœ¬åœ°åŸŸåæœåŠ¡å™¨çš„æŸ¥è¯¢è¯·æ±‚åï¼Œè¦ä¹ˆç»™å‡ºæ‰€è¦æŸ¥è¯¢çš„IPåœ°å€ï¼Œè¦ä¹ˆå‘Šè¯‰æœ¬åœ°æœåŠ¡å™¨ä¸‹ä¸€æ­¥åº”å½“å‘å“ªä¸€ä¸ª**æƒå¨åŸŸåæœåŠ¡å™¨**è¿›è¡ŒæŸ¥è¯¢ã€‚æœ€åï¼ŒçŸ¥é“æ‰€è¦è§£æçš„IPåœ°å€æˆ–æ‰¾ä¸åˆ°ç»“æœæŠ¥é”™æ—¶ï¼ŒæŠŠè¿™ä¸ªç»“æœè¿”å›ç»™å‘èµ·æŸ¥è¯¢çš„ä¸»æœº



> DNSå ç”¨ **53** å·ç«¯å£ï¼ŒåŒæ—¶ä½¿ç”¨ TCP å’Œ **UDP** åè®®ã€‚DNS åœ¨åŒºåŸŸä¼ è¾“çš„æ—¶å€™ä½¿ç”¨ TCP åè®®ï¼Œå…¶ä»–æ—¶é—´ä½¿ç”¨ UDP åè®®ã€‚å¦å¤–å½“ DNS æŸ¥è¯¢è¶…è¿‡ 512 å­—èŠ‚æ—¶ï¼Œä¼šä½¿ç”¨ TCP åè®®
>
> - åŒºåŸŸä¼ è¾“ï¼šDNS æœåŠ¡å™¨ä¸»ä»å¤åˆ¶æ—¶ï¼Œæ•°æ®é‡å¾ˆå¤§ï¼Œä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨æŸ¥è¯¢æ›´æ–°æ•°æ®ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
>
> 
>
> chatgptä¸Šçš„è§£é‡Šï¼š
>
> DNSæŸ¥è¯¢é€šå¸¸ä½¿ç”¨UDPåè®®è¿›è¡Œä¼ è¾“ï¼ŒåŸå› å¦‚ä¸‹ï¼š
>
> 1. **ä½å»¶è¿Ÿï¼š** UDPæ˜¯é¢å‘æ— è¿æ¥çš„åè®®ï¼Œå®ƒä¸éœ€è¦åœ¨å‘é€æ•°æ®å‰å»ºç«‹è¿æ¥ï¼Œä¹Ÿä¸éœ€è¦ç­‰å¾…è¿æ¥çš„ç¡®è®¤ã€‚è¿™ä½¿å¾—DNSæŸ¥è¯¢å¯ä»¥æ›´å¿«åœ°å‘é€å’Œå“åº”ï¼Œå‡å°‘äº†é€šä¿¡çš„å»¶è¿Ÿã€‚
>2. **è¾ƒå°çš„æ•°æ®åŒ…ï¼š** DNSæŸ¥è¯¢é€šå¸¸éå¸¸å°ï¼ŒåªåŒ…å«ä¸€ä¸ªåŸŸåå’ŒæŸ¥è¯¢ç±»å‹ï¼Œè¿™æ ·çš„å°æ•°æ®åŒ…åœ¨UDPä¸­ä¼ è¾“æ›´åŠ é«˜æ•ˆã€‚
> 3. **ç®€å•æ€§ï¼š** UDPæ˜¯ä¸€ç§è½»é‡çº§çš„åè®®ï¼Œå®ç°èµ·æ¥è¾ƒä¸ºç®€å•ï¼Œé€‚åˆç”¨äºå¿«é€Ÿå“åº”çš„åœºæ™¯ã€‚
>
> ç„¶è€Œï¼Œç”±äºUDPæ˜¯é¢å‘æ— è¿æ¥çš„åè®®ï¼Œå®ƒåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸æä¾›å¯é æ€§ä¿è¯ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœDNSæŸ¥è¯¢ä¸¢å¤±æˆ–å‡ºç°é”™è¯¯ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå¾—åˆ°é€šçŸ¥ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨é‡æ–°å‘é€æŸ¥è¯¢ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDNSåè®®è¿˜ä½¿ç”¨TCPä½œä¸ºå¤‡ç”¨ä¼ è¾“å±‚åè®®ã€‚
> 
> DNSä½¿ç”¨TCPçš„æƒ…å†µåŒ…æ‹¬ï¼š
>
> 1. **å¤§æ•°æ®åŒ…ï¼š** å½“DNSå“åº”çš„æ•°æ®åŒ…è¶…è¿‡UDPçš„é™åˆ¶ï¼ˆé€šå¸¸ä¸º512å­—èŠ‚ï¼‰ï¼ŒDNSæœåŠ¡å™¨ä¼šä½¿ç”¨TCPåè®®æ¥ä¼ è¾“å“åº”ã€‚
>2. **å¯é æ€§è¦æ±‚ï¼š** åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯¹DNSå“åº”çš„å¯é æ€§è¦æ±‚æ¯”è¾ƒé«˜ï¼Œç‰¹åˆ«æ˜¯å¯¹äºä¸€äº›é‡è¦çš„æŸ¥è¯¢ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šä½¿ç”¨TCPæ¥ç¡®ä¿æ•°æ®çš„å¯é ä¼ è¾“ã€‚



2ã€è§£æå‡ºIPåœ°å€åï¼Œæ ¹æ®è¯¥IPåœ°å€å’Œé»˜è®¤ç«¯å£80ï¼Œ**å’ŒWebæœåŠ¡å™¨ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹TCPè¿æ¥**

3ã€æ¡æ‰‹æˆåŠŸï¼Œæµè§ˆå™¨å‘å‡ºè¯»å–æ–‡ä»¶ï¼ˆURLä¸­åŸŸååé¢éƒ¨åˆ†å¯¹åº”çš„æ–‡ä»¶ï¼‰çš„HTTPè¯·æ±‚ï¼Œå‘é€ç»™**WEBæœåŠ¡å™¨**

4ã€WEBæœåŠ¡å™¨å¯¹æµè§ˆå™¨è¯·æ±‚ä½œå‡ºå“åº”ï¼ˆè§£æç”¨æˆ·è¯·æ±‚ã€åç«¯è°ƒç”¨æ•°æ®åº“å¤„ç†è¯·æ±‚ã€å°†ç»“æœè¿”å›ç»™æµè§ˆå™¨å®¢æˆ·ç«¯ï¼‰

5ã€é‡Šæ”¾TCPè¿æ¥ï¼ˆè¿™é‡Œéœ€è¦åˆ¤æ–­æ˜¯å¦å¼€å¯äº†Keep-Aliveï¼‰

6ã€æµè§ˆå™¨è§£æèµ„æºã€æ¸²æŸ“cssæ ·å¼ã€jsäº¤äº’åæ˜¾ç¤ºç½‘é¡µå†…å®¹





## OSIä¸ƒå±‚åè®®

**ç‰©ç†å±‚ï¼ˆPhysical Layerï¼‰ï¼š** ç‰©ç†å±‚æ˜¯ç½‘ç»œé€šä¿¡çš„æœ€åº•å±‚ï¼Œå®ƒè´Ÿè´£åœ¨ç‰©ç†åª’ä»‹ä¸Šä¼ è¾“æ¯”ç‰¹æµï¼ˆ0å’Œ1ï¼‰ã€‚ä¸»è¦å…³æ³¨çš„æ˜¯æ•°æ®çš„ä¼ è¾“ã€ç”µå‹ã€æ•°æ®ä¼ è¾“é€Ÿç‡ã€è¿æ¥æ¥å£ç­‰ç‰©ç†ç‰¹æ€§ã€‚

**æ•°æ®é“¾è·¯å±‚ï¼ˆData Link Layerï¼‰ï¼š** æ•°æ®é“¾è·¯å±‚å»ºç«‹äº†ä¸¤ä¸ªç›´æ¥ç›¸è¿çš„èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®é“¾è·¯ï¼Œè´Ÿè´£å°†æ¯”ç‰¹æµåˆ†ç»„æˆæ•°æ®å¸§ï¼Œå¹¶å¤„ç†å¸§çš„é”™è¯¯æ£€æµ‹å’Œçº æ­£ã€‚å®ƒè¿˜è´Ÿè´£æµæ§åˆ¶ã€è®¿é—®æ§åˆ¶å’Œç‰©ç†åœ°å€çš„å¯»å€ï¼Œä¿è¯æ•°æ®åœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸­å¯é ä¼ è¾“ã€‚

- `ARP`

  ç”¨äºå°†IPåœ°å€ï¼ˆç½‘ç»œå±‚åœ°å€ï¼‰è§£æä¸ºå¯¹åº”çš„MACåœ°å€ï¼ˆæ•°æ®é“¾è·¯å±‚åœ°å€ï¼‰ï¼Œä»è€Œå®ç°åœ¨å±€åŸŸç½‘ä¸­çš„ä¸»æœºä¹‹é—´çš„é€šä¿¡ã€‚ARPåè®®çš„åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š

  1. **ARPè¯·æ±‚ï¼ˆARP Requestï¼‰ï¼š** å½“ä¸»æœºAéœ€è¦ä¸å¦ä¸€ä¸ªä¸»æœºBè¿›è¡Œé€šä¿¡æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æœ¬åœ°çš„ARPç¼“å­˜è¡¨ï¼ˆARP Cacheï¼‰ï¼Œçœ‹æ˜¯å¦å·²ç»çŸ¥é“ä¸»æœºBçš„MACåœ°å€ã€‚å¦‚æœç¼“å­˜è¡¨ä¸­æ²¡æœ‰å¯¹åº”çš„MACåœ°å€ï¼Œä¸»æœºAå°†å‘é€ä¸€ä¸ªARPè¯·æ±‚å¹¿æ’­ã€‚è¯¥ARPè¯·æ±‚åŒ…å«äº†ä¸»æœºAçš„IPåœ°å€å’ŒMACåœ°å€ï¼Œå¹¶æŒ‡ç¤ºéœ€è¦è§£æçš„ç›®æ ‡IPåœ°å€ï¼ˆä¸»æœºBçš„IPåœ°å€ï¼‰ã€‚ARPè¯·æ±‚çš„ç›®æ ‡MACåœ°å€å­—æ®µè®¾ç½®ä¸ºå¹¿æ’­åœ°å€ï¼ˆFF:FF:FF:FF:FF:FFï¼‰ï¼Œä»¥ç¡®ä¿åœ¨å±€åŸŸç½‘ä¸Šçš„æ‰€æœ‰ä¸»æœºéƒ½èƒ½æ¥æ”¶åˆ°è¯¥è¯·æ±‚ã€‚
  2. **ARPå“åº”ï¼ˆARP Replyï¼‰ï¼š** æ”¶åˆ°ARPè¯·æ±‚çš„ä¸»æœºBä¼šæ£€æŸ¥è¯·æ±‚ä¸­çš„ç›®æ ‡IPåœ°å€æ˜¯å¦ä¸è‡ªå·±çš„IPåœ°å€åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œä¸»æœºBä¼šæ„å»ºä¸€ä¸ªARPå“åº”æŠ¥æ–‡ï¼Œå…¶ä¸­åŒ…å«å®ƒè‡ªå·±çš„IPåœ°å€å’ŒMACåœ°å€ï¼Œå¹¶å‘é€ç»™ä¸»æœºAã€‚ARPå“åº”çš„ç›®æ ‡MACåœ°å€å­—æ®µè®¾ç½®ä¸ºä¸»æœºAçš„MACåœ°å€ï¼Œä»¥ç¡®ä¿åªæœ‰ä¸»æœºAèƒ½å¤Ÿæ¥æ”¶åˆ°è¯¥å“åº”ã€‚
  3. **ARPç¼“å­˜æ›´æ–°ï¼š** ä¸€æ—¦ä¸»æœºAæ”¶åˆ°ä¸»æœºBçš„ARPå“åº”ï¼Œå®ƒå°†ä¼šå°†ä¸»æœºBçš„IPåœ°å€å’ŒMACåœ°å€æ·»åŠ åˆ°è‡ªå·±çš„ARPç¼“å­˜è¡¨ä¸­ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡ä¸»æœºAéœ€è¦ä¸ä¸»æœºBé€šä¿¡æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„MACåœ°å€ï¼Œè€Œæ— éœ€å†å‘é€ARPè¯·æ±‚ã€‚
  4. **ARPç¼“å­˜è¡¨ï¼š** ARPç¼“å­˜è¡¨æ˜¯æ¯ä¸ªä¸»æœºç»´æŠ¤çš„ä¸€ä¸ªè¡¨æ ¼ï¼Œç”¨äºå­˜å‚¨IPåœ°å€å’Œå¯¹åº”çš„MACåœ°å€ã€‚åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¸»æœºä¼šæ ¹æ®éœ€è¦ä¸æ–­æ›´æ–°ARPç¼“å­˜è¡¨ï¼Œä»¥ç¡®ä¿æ­£ç¡®è§£æIPåœ°å€åˆ°MACåœ°å€çš„æ˜ å°„å…³ç³»ã€‚

  æ€»ç»“æ¥è¯´ï¼ŒARPåè®®çš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡ARPè¯·æ±‚å’ŒARPå“åº”æ¥å®ç°IPåœ°å€åˆ°MACåœ°å€çš„è§£æã€‚ä¸»æœºåœ¨é€šä¿¡å‰å…ˆæŸ¥çœ‹è‡ªå·±çš„ARPç¼“å­˜è¡¨ï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„MACåœ°å€ï¼Œå°±å‘é€ARPè¯·æ±‚æ¥è¯¢é—®å…¶ä»–ä¸»æœºï¼Œè¯¥IPåœ°å€å¯¹åº”çš„MACåœ°å€æ˜¯ä»€ä¹ˆã€‚ç„¶åç›®æ ‡ä¸»æœºæ”¶åˆ°ARPè¯·æ±‚åï¼Œæ ¹æ®è‡ªå·±çš„IPåœ°å€è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œå°±å‘é€ARPå“åº”æ¥å‘Šè¯‰è¯·æ±‚ä¸»æœºè‡ªå·±çš„MACåœ°å€ã€‚è¯·æ±‚ä¸»æœºæ”¶åˆ°å“åº”åï¼Œå°†IPåœ°å€å’ŒMACåœ°å€çš„æ˜ å°„å…³ç³»æ·»åŠ åˆ°è‡ªå·±çš„ARPç¼“å­˜è¡¨ä¸­ï¼Œä»¥ä¾¿åç»­é€šä¿¡ç›´æ¥ä½¿ç”¨ã€‚è¿™æ ·å°±å®ç°äº†IPåœ°å€åˆ°MACåœ°å€çš„è§£æå’Œé€šä¿¡ã€‚

  

- `Ethernet`ï¼š**ä»¥å¤ªç½‘**æ˜¯æ•°æ®é“¾è·¯å±‚çš„ä¸€ç§å…·ä½“å®ç°ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•åœ¨å±€åŸŸç½‘ä¸Šä¼ è¾“æ•°æ®ã€‚ä»¥å¤ªç½‘å¸§çš„æ ¼å¼å¦‚ä¸‹ï¼š

**ç½‘ç»œå±‚ï¼ˆNetwork Layerï¼‰ï¼š** ç½‘ç»œå±‚è´Ÿè´£æ•°æ®çš„**è·¯ç”±é€‰æ‹©å’Œè½¬å‘**ï¼Œå°†æ•°æ®åŒ…ä»æºåœ°å€ä¼ é€åˆ°ç›®æ ‡åœ°å€ï¼Œå®ç°è·¨ä¸åŒç½‘ç»œçš„æ•°æ®ä¼ è¾“ã€‚å®ƒä½¿ç”¨IPåœ°å€æ¥å¯»å€ï¼Œå¹¶å¤„ç†ä¸åŒå­ç½‘ä¹‹é—´çš„æ•°æ®è½¬å‘é—®é¢˜ã€‚

- `ICMP`(`Ping`çš„åŸç†ï¼šå‘é€**ICMPå›æ˜¾è¯·æ±‚**ä»¥åŠ**ICMPå›æ˜¾å“åº”**æŠ¥æ–‡çš„åŒæ—¶ï¼Œè®°å½•ä¸¤æ¬¡æ—¶é—´æˆ³å·®å€¼)	
- `IP`

**ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰ï¼š** ä¼ è¾“å±‚æä¾›ç«¯åˆ°ç«¯çš„æ•°æ®ä¼ è¾“æœåŠ¡ï¼Œç¡®ä¿æ•°æ®åœ¨æºå’Œç›®æ ‡ä¹‹é—´çš„å¯é ä¼ è¾“ã€‚å®ƒä½¿ç”¨ç«¯å£å·æ¥æ ‡è¯†ä¸åŒçš„åº”ç”¨ç¨‹åºï¼Œå¹¶æä¾›æ•°æ®çš„åˆ†æ®µå’Œé‡ç»„ï¼ŒåŒæ—¶è¿˜è´Ÿè´£æµé‡æ§åˆ¶å’Œé”™è¯¯æ¢å¤ã€‚

**ä¼šè¯å±‚ï¼ˆSession Layerï¼‰ï¼š** ä¼šè¯å±‚è´Ÿè´£å»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¼šè¯æˆ–è¿æ¥ã€‚å®ƒæä¾›ä¼šè¯çš„åŒæ­¥ã€æ£€æŸ¥ç‚¹ã€æ¢å¤å’Œæ•°æ®åŒæ­¥åŠŸèƒ½ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨é€šä¿¡è¿‡ç¨‹ä¸­è¿›è¡Œäº¤äº’

- `TLS`ï¼ˆhttpså››æ¬¡æ¡æ‰‹ï¼‰
- `SSH`

**è¡¨ç¤ºå±‚ï¼ˆPresentation Layerï¼‰ï¼š** è¡¨ç¤ºå±‚è´Ÿè´£æ•°æ®çš„æ ¼å¼è½¬æ¢å’Œç¼–ç ï¼Œç¡®ä¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ­£ç¡®è§£é‡Šå’Œå¤„ç†æ”¶åˆ°çš„æ•°æ®ã€‚å®ƒå¤„ç†æ•°æ®çš„åŠ å¯†å’Œè§£å¯†ï¼Œä»¥åŠæ•°æ®çš„å‹ç¼©å’Œè§£å‹ç¼©

- æ•°æ®çš„åºåˆ—åŒ–/ååºåˆ—åŒ–

**åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰ï¼š** åº”ç”¨å±‚æ˜¯æœ€é«˜å±‚ï¼Œç›´æ¥ä¸ç”¨æˆ·çš„åº”ç”¨ç¨‹åºè¿›è¡Œäº¤äº’ã€‚å®ƒæä¾›äº†å„ç§ç½‘ç»œæœåŠ¡å’Œåè®®ï¼Œå¦‚HTTPã€FTPã€SMTPç­‰ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè®¿é—®ç½‘ç»œå¹¶è¿›è¡Œæ•°æ®äº¤æ¢

- `HTTP`
- `FTP`
- `DNS`



## Linuxç³»ç»Ÿå¦‚ä½•æ”¶å‘æ•°æ®åŒ…çš„ï¼Ÿ

![img](https://github.com/amonstercat/PicGo/blob/main/dell/202403061643382.png?raw=true)

ä»ä¸Šå›¾çš„çš„ç½‘ç»œåè®®æ ˆï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼š

- åº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡**ç³»ç»Ÿè°ƒç”¨**ï¼Œ**æ¥è·Ÿ Socket å±‚è¿›è¡Œæ•°æ®äº¤äº’**ï¼›
- Socket å±‚çš„ä¸‹é¢å°±æ˜¯ä¼ è¾“å±‚ã€ç½‘ç»œå±‚å’Œç½‘ç»œæ¥å£å±‚ï¼›
- æœ€ä¸‹é¢çš„ä¸€å±‚ï¼Œåˆ™æ˜¯**ç½‘å¡**é©±åŠ¨ç¨‹åºå’Œç¡¬ä»¶**ç½‘å¡è®¾å¤‡**ï¼›



ç½‘å¡æ˜¯è®¡ç®—æœºé‡Œçš„ä¸€ä¸ªç¡¬ä»¶ï¼Œä¸“é—¨è´Ÿè´£æ¥æ”¶å’Œå‘é€ç½‘ç»œåŒ…ï¼Œå½“ç½‘å¡æ¥æ”¶åˆ°ä¸€ä¸ªç½‘ç»œåŒ…åï¼Œä¼šé€šè¿‡ DMA æŠ€æœ¯ï¼Œå°†ç½‘ç»œåŒ…å†™å…¥åˆ°æŒ‡å®šçš„å†…å­˜åœ°å€ï¼Œä¹Ÿå°±æ˜¯å†™å…¥åˆ° **Ring Buffer** ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ¥ç€å°±ä¼šå‘Šè¯‰æ“ä½œç³»ç»Ÿè¿™ä¸ªç½‘ç»œåŒ…å·²ç»åˆ°è¾¾ã€‚

![img](https://github.com/amonstercat/PicGo/blob/main/dell/202403061652820.png?raw=true)

[linuxç³»ç»Ÿæ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®åŒ…æ”¶å‘çš„ï¼Ÿ](https://xiaolincoding.com/network/1_base/how_os_deal_network_package.html#linux-%E5%8F%91%E9%80%81%E7%BD%91%E7%BB%9C%E5%8C%85%E7%9A%84%E6%B5%81%E7%A8%8B)



## WireSharkæŠ“åŒ…







## è·¯ç”±å™¨å·¥ä½œåŸç†



è·¯ç”±å™¨çš„å·¥ä½œåŸç†æ¶‰åŠè·¯ç”±é€‰æ‹©ã€æ•°æ®åŒ…è½¬å‘å’Œç½‘ç»œåˆ†å‰²ç­‰è¿‡ç¨‹ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

1. **è·¯ç”±é€‰æ‹©ï¼š** è·¯ç”±å™¨é€šè¿‡è·¯ç”±é€‰æ‹©ç®—æ³•ç¡®å®šæ•°æ®åŒ…çš„æœ€ä½³è½¬å‘è·¯å¾„ã€‚è·¯ç”±é€‰æ‹©ç®—æ³•è€ƒè™‘äº†å¤šä¸ªå› ç´ ï¼Œå¦‚ç›®æ ‡åœ°å€ã€è·³æ•°ã€å¸¦å®½ã€æ‹¥å¡ç­‰ï¼Œä»¥ç¡®ä¿æ•°æ®åŒ…èƒ½å¤Ÿå°½å¿«ã€é«˜æ•ˆåœ°åˆ°è¾¾ç›®çš„åœ°ã€‚è·¯ç”±é€‰æ‹©é€šå¸¸æ˜¯é€šè¿‡è·¯ç”±è¡¨æ¥å®ç°çš„ï¼Œè·¯ç”±è¡¨ä¸­è®°å½•äº†ä¸åŒç½‘ç»œçš„IPåœ°å€èŒƒå›´å’Œå¯¹åº”çš„å‡ºå£æ¥å£ã€‚
2. **æ•°æ®åŒ…è½¬å‘ï¼š** å½“è·¯ç”±å™¨æ”¶åˆ°ä¸€ä¸ªæ•°æ®åŒ…æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ•°æ®åŒ…çš„ç›®æ ‡IPåœ°å€ï¼Œå¹¶æ ¹æ®è·¯ç”±è¡¨é€‰æ‹©æœ€ä½³çš„è½¬å‘è·¯å¾„ã€‚è·¯ç”±å™¨ä¼šå°†æ•°æ®åŒ…ä»æ¥æ”¶ç«¯å£è½¬å‘åˆ°åˆé€‚çš„å‡ºå£ç«¯å£ï¼Œä»¥ä¾¿å°†æ•°æ®åŒ…å‘é€åˆ°ä¸‹ä¸€ä¸ªç½‘ç»œæˆ–ç›®çš„åœ°ã€‚åœ¨è½¬å‘æ•°æ®åŒ…æ—¶ï¼Œè·¯ç”±å™¨ä¼šä½¿ç”¨æ•°æ®é“¾è·¯å±‚çš„MACåœ°å€æ¥ç¡®å®šä¸‹ä¸€è·³çš„ç‰©ç†åœ°å€ã€‚
3. **ç½‘ç»œåˆ†å‰²ï¼š** è·¯ç”±å™¨å°†ä¸åŒçš„ç½‘ç»œåˆ†å‰²æˆå¤šä¸ªå­ç½‘ï¼Œå¹¶é€šè¿‡è½¬å‘æ•°æ®åŒ…å®ç°ä¸åŒå­ç½‘ä¹‹é—´çš„é€šä¿¡ã€‚æ¯ä¸ªå­ç½‘æ‹¥æœ‰è‡ªå·±çš„IPåœ°å€èŒƒå›´ï¼Œè·¯ç”±å™¨æ ¹æ®ç›®æ ‡IPåœ°å€æ¥ç¡®å®šæ•°æ®åŒ…åº”è¯¥è½¬å‘åˆ°å“ªä¸ªå­ç½‘ã€‚é€šè¿‡ç½‘ç»œåˆ†å‰²ï¼Œè·¯ç”±å™¨å®ç°äº†å¯¹ç½‘ç»œæµé‡çš„æ§åˆ¶å’Œç®¡ç†ï¼Œé¿å…äº†æ•´ä¸ªç½‘ç»œèŒƒå›´å†…çš„æ•°æ®å†²çªå’Œæ‹¥å¡ã€‚
4. **æ•°æ®åŒ…è¿‡æ»¤ï¼š** è·¯ç”±å™¨å¯ä»¥æ ¹æ®é…ç½®çš„è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰æ¥è¿‡æ»¤å’Œé™åˆ¶æ•°æ®åŒ…çš„è½¬å‘ã€‚ACLå¯ä»¥æ ¹æ®æºIPåœ°å€ã€ç›®æ ‡IPåœ°å€ã€ç«¯å£å·ç­‰æ¡ä»¶æ¥è¿‡æ»¤æ•°æ®åŒ…ï¼Œä»è€Œå®ç°ç½‘ç»œçš„å®‰å…¨ç­–ç•¥å’Œè®¿é—®æ§åˆ¶ã€‚
5. **NATï¼ˆNetwork Address Translationï¼‰ï¼š** ä¸€äº›è·¯ç”±å™¨è¿˜æ”¯æŒNATåŠŸèƒ½ï¼Œå®ƒå°†å†…éƒ¨ç§æœ‰IPåœ°å€è½¬æ¢ä¸ºå¤–éƒ¨å…¬å…±IPåœ°å€ï¼Œå®ç°å†…éƒ¨ç½‘ç»œä¸å¤–éƒ¨Internetçš„è¿æ¥ã€‚NATæŠ€æœ¯å…è®¸å¤šä¸ªå†…éƒ¨è®¾å¤‡å…±äº«ä¸€ä¸ªå…¬å…±IPåœ°å€ï¼Œæé«˜äº†ç½‘ç»œçš„å®‰å…¨æ€§å’Œç§æœ‰æ€§





## å¦‚ä½•åŸºäºUDPåè®®å®ç°å¯é ä¼ è¾“ï¼Ÿ :cry:



 TCP åè®®å››ä¸ªæ–¹é¢çš„ç¼ºé™·ï¼š

- å‡çº§ TCP çš„å·¥ä½œå¾ˆå›°éš¾ï¼›
- TCP å»ºç«‹è¿æ¥çš„å»¶è¿Ÿï¼›
- TCP å­˜åœ¨é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼›
- ç½‘ç»œè¿ç§»éœ€è¦é‡æ–°å»ºç«‹ TCP è¿æ¥ï¼›

ç°åœ¨å¸‚é¢ä¸Šå·²ç»æœ‰åŸºäº UDP åè®®å®ç°çš„å¯é ä¼ è¾“åè®®çš„æˆç†Ÿæ–¹æ¡ˆäº†ï¼Œé‚£å°±æ˜¯ QUIC åè®®ï¼Œå·²ç»åº”ç”¨åœ¨äº† HTTP/3ã€‚QUIC åè®®ä¹Ÿæœ‰ç±»ä¼¼ HTTP/2 Stream ä¸å¤šè·¯å¤ç”¨çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯å¯ä»¥åœ¨åŒä¸€æ¡è¿æ¥ä¸Šå¹¶å‘ä¼ è¾“å¤šä¸ª Streamï¼Œ**Stream å¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€æ¡ HTTP è¯·æ±‚**

è¿™æ¬¡ï¼Œ**èŠèŠ QUIC æ˜¯å¦‚ä½•å®ç°å¯é ä¼ è¾“çš„ï¼Ÿåˆæ˜¯å¦‚ä½•è§£å†³ä¸Šé¢ TCP åè®®å››ä¸ªæ–¹é¢çš„ç¼ºé™·**ï¼Ÿ

<img src="https://cdn.xiaolincoding.com//mysql/other/605d1026df934f20a5ee12f3c55aa6a7.png" alt="img" style="zoom:67%;" />

**1ã€Packet Header**

Packet Header é¦–æ¬¡å»ºç«‹è¿æ¥æ—¶å’Œæ—¥å¸¸ä¼ è¾“æ•°æ®æ—¶ä½¿ç”¨çš„ Header æ˜¯ä¸åŒçš„ã€‚å¦‚ä¸‹å›¾ï¼ˆ*æ³¨æ„æˆ‘æ²¡æœ‰æŠŠ Header æ‰€æœ‰å­—æ®µéƒ½ç”»å‡ºæ¥ï¼Œåªæ˜¯ç”»å‡ºäº†é‡è¦çš„å­—æ®µ*ï¼‰ï¼š

![Packet Header](https://cdn.xiaolincoding.com//mysql/other/bcf3ccb6a15c4cdebe1cd0527fdd9a5e.png)

Packet Header ç»†åˆ†è¿™ä¸¤ç§ï¼š

- Long Packet Header ç”¨äºé¦–æ¬¡å»ºç«‹è¿æ¥ã€‚
- Short Packet Header ç”¨äºæ—¥å¸¸ä¼ è¾“æ•°æ®ã€‚

QUIC ä¹Ÿæ˜¯éœ€è¦ä¸‰æ¬¡æ¡æ‰‹æ¥å»ºç«‹è¿æ¥çš„ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†åå•†è¿æ¥ IDã€‚åå•†å‡ºè¿æ¥ ID åï¼Œåç»­ä¼ è¾“æ—¶ï¼ŒåŒæ–¹åªéœ€è¦å›ºå®šä½è¿æ¥ IDï¼Œä»è€Œå®ç°è¿æ¥è¿ç§»åŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥çœ‹åˆ°æ—¥å¸¸ä¼ è¾“æ•°æ®çš„ Short Packet Header ä¸éœ€è¦åœ¨ä¼ è¾“ Source Connection ID å­—æ®µäº†ï¼Œåªéœ€è¦ä¼ è¾“ Destination Connection IDã€‚

Short Packet Header ä¸­çš„ `Packet Number` æ˜¯æ¯ä¸ªæŠ¥æ–‡ç‹¬ä¸€æ— äºŒçš„ç¼–å·ï¼Œå®ƒæ˜¯**ä¸¥æ ¼é€’å¢**çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®— Packet N ä¸¢å¤±äº†ï¼Œé‡ä¼ çš„ Packet N çš„ Packet Number å·²ç»ä¸æ˜¯ Nï¼Œè€Œæ˜¯ä¸€ä¸ªæ¯” N å¤§çš„å€¼ã€‚


<img src="https://cdn.xiaolincoding.com//mysql/other/635813465fbb449882da2e2bee39f24e.png" alt="img" style="zoom:67%;" />

> ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡å‘¢ï¼Ÿ

å½“ TCP å‘ç”Ÿè¶…æ—¶é‡ä¼ åï¼Œå®¢æˆ·ç«¯å‘èµ·é‡ä¼ ï¼Œç„¶åæ¥æ”¶åˆ°äº†æœåŠ¡ç«¯ç¡®è®¤ ACK ã€‚ç”±äºå®¢æˆ·ç«¯åŸå§‹æŠ¥æ–‡å’Œé‡ä¼ æŠ¥æ–‡åºåˆ—å·éƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯é’ˆå¯¹è¿™ä¸¤ä¸ªæŠ¥æ–‡å›å¤çš„éƒ½æ˜¯ç›¸åŒçš„ ACKã€‚

è¿™æ ·çš„è¯ï¼Œå®¢æˆ·ç«¯å°±æ— æ³•åˆ¤æ–­å‡ºæ˜¯ã€ŒåŸå§‹æŠ¥æ–‡çš„å“åº”ã€è¿˜æ˜¯ã€Œé‡ä¼ æŠ¥æ–‡çš„å“åº”ã€ï¼Œè¿™æ ·åœ¨è®¡ç®— RTTï¼ˆå¾€è¿”æ—¶é—´ï¼‰ æ—¶åº”è¯¥é€‰æ‹©ä»å‘é€åŸå§‹æŠ¥æ–‡å¼€å§‹è®¡ç®—ï¼Œè¿˜æ˜¯é‡ä¼ åŸå§‹æŠ¥æ–‡å¼€å§‹è®¡ç®—å‘¢ï¼Ÿ

- å¦‚æœç®—æˆåŸå§‹è¯·æ±‚çš„å“åº”ï¼Œä½†å®é™…ä¸Šæ˜¯é‡ä¼ è¯·æ±‚çš„å“åº”ï¼ˆä¸Šå›¾å·¦ï¼‰ï¼Œä¼šå¯¼è‡´é‡‡æ · RTT å˜å¤§ã€‚
- å¦‚æœç®—æˆé‡ä¼ è¯·æ±‚çš„å“åº”ï¼Œä½†å®é™…ä¸Šæ˜¯åŸå§‹è¯·æ±‚çš„å“åº”ï¼ˆä¸Šå›¾å³ï¼‰ï¼Œåˆå¾ˆå®¹æ˜“å¯¼è‡´é‡‡æ · RTT è¿‡å°ã€‚

RTO ï¼ˆè¶…æ—¶æ—¶é—´ï¼‰æ˜¯åŸºäº RTT æ¥è®¡ç®—çš„ï¼Œé‚£ä¹ˆå¦‚æœ RTT è®¡ç®—ä¸ç²¾å‡†ï¼Œé‚£ä¹ˆ RTO ï¼ˆè¶…æ—¶æ—¶é—´ï¼‰ä¹Ÿä¼šä¸ç²¾ç¡®ï¼Œè¿™æ ·å¯èƒ½å¯¼è‡´é‡ä¼ çš„æ¦‚ç‡äº‹ä»¶å¢å¤§ã€‚

QUIC æŠ¥æ–‡ä¸­çš„ Packet Number æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œ å³ä½¿æ˜¯é‡ä¼ æŠ¥æ–‡ï¼Œå®ƒçš„ Packet Number ä¹Ÿæ˜¯é€’å¢çš„ï¼Œè¿™æ ·å°±èƒ½æ›´åŠ ç²¾ç¡®è®¡ç®—å‡ºæŠ¥æ–‡çš„ RTTã€‚


![img](https://cdn.xiaolincoding.com//mysql/other/ca91985c9a94487a8a29db1249109717.png)

**å¦‚æœ ACK çš„ Packet Number æ˜¯ N+Mï¼Œå°±æ ¹æ®é‡ä¼ æŠ¥æ–‡è®¡ç®—é‡‡æ · RTTã€‚å¦‚æœ ACK çš„ Packet Number æ˜¯ Nï¼Œå°±æ ¹æ®åŸå§‹æŠ¥æ–‡çš„æ—¶é—´è®¡ç®—é‡‡æ · RTTï¼Œæ²¡æœ‰æ­§ä¹‰æ€§çš„é—®é¢˜**

å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œ**QUIC ä½¿ç”¨çš„ Packet Number å•è°ƒé€’å¢çš„è®¾è®¡ï¼Œå¯ä»¥è®©æ•°æ®åŒ…ä¸å†åƒ TCP é‚£æ ·å¿…é¡»æœ‰åºç¡®è®¤ï¼ŒQUIC æ”¯æŒä¹±åºç¡®è®¤ï¼Œå½“æ•°æ®åŒ…Packet N ä¸¢å¤±åï¼Œåªè¦æœ‰æ–°çš„å·²æ¥æ”¶æ•°æ®åŒ…ç¡®è®¤ï¼Œå½“å‰å‘é€çª—å£å°±ä¼šç»§ç»­å‘å³æ»‘åŠ¨**

å¾…å‘é€ç«¯è·çŸ¥æ•°æ®åŒ…Packet N ä¸¢å¤±åï¼Œä¼šå°†éœ€è¦é‡ä¼ çš„æ•°æ®åŒ…æ”¾åˆ°å¾…å‘é€é˜Ÿåˆ—ï¼Œ**é‡æ–°ç¼–å·**æ¯”å¦‚æ•°æ®åŒ…Packet N+M åé‡æ–°å‘é€ç»™æ¥æ”¶ç«¯ï¼Œå¯¹é‡ä¼ æ•°æ®åŒ…çš„å¤„ç†è·Ÿå‘é€æ–°çš„æ•°æ®åŒ…ç±»ä¼¼ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºä¸¢åŒ…é‡ä¼ å°†å½“å‰çª—å£é˜»å¡åœ¨åŸåœ°ï¼Œä»è€Œè§£å†³äº†é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚

æ‰€ä»¥ï¼ŒPacket Number å•è°ƒé€’å¢çš„ä¸¤ä¸ªå¥½å¤„ï¼š

- å¯ä»¥æ›´åŠ ç²¾ç¡®è®¡ç®— RTTï¼Œæ²¡æœ‰ TCP é‡ä¼ çš„æ­§ä¹‰æ€§é—®é¢˜ï¼›
- å¯ä»¥æ”¯æŒä¹±åºç¡®è®¤ï¼Œå› ä¸ºä¸¢åŒ…é‡ä¼ å°†å½“å‰çª—å£é˜»å¡åœ¨åŸåœ°ï¼Œè€Œ **TCP å¿…é¡»æ˜¯é¡ºåºç¡®è®¤çš„ï¼Œä¸¢åŒ…æ—¶ä¼šå¯¼è‡´çª—å£ä¸æ»‘åŠ¨**ï¼›





> é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ—¢ç„¶é‡ä¼ æ•°æ®åŒ…çš„ Packet N+M ä¸ä¸¢å¤±æ•°æ®åŒ…çš„ Packet N ç¼–å·å¹¶ä¸ä¸€è‡´ï¼Œæˆ‘ä»¬æ€ä¹ˆç¡®å®šè¿™ä¸¤ä¸ªæ•°æ®åŒ…çš„å†…å®¹ä¸€æ ·å‘¢ï¼Ÿ

ä¸€ä¸ª Packet æŠ¥æ–‡ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ª QUIC Frameï¼ˆä»¥Streamç±»å‹çš„Frameä¸ºä¾‹ï¼Œè¯¥Frameä¸­æœ‰Stream ID+Offsetï¼‰:

<img src="https://cdn.xiaolincoding.com//mysql/other/6a94d41ef3d14cb6b7846e73da6c3104.png" alt="img" style="zoom: 67%;" />



æ‰€ä»¥å¼•å…¥ Frame Header è¿™ä¸€å±‚ï¼Œ**é€šè¿‡ Stream ID + Offset å­—æ®µä¿¡æ¯å®ç°æ•°æ®çš„æœ‰åºæ€§**ï¼Œé€šè¿‡æ¯”è¾ƒä¸¤ä¸ªæ•°æ®åŒ…çš„ `Stream ID` ä¸ `Stream Offset` ï¼Œå¦‚æœéƒ½æ˜¯ä¸€è‡´ï¼Œå°±è¯´æ˜è¿™ä¸¤ä¸ªæ•°æ®åŒ…çš„å†…å®¹ä¸€è‡´ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹å›¾ä¸­ï¼Œæ•°æ®åŒ… Packet N ä¸¢å¤±äº†ï¼Œåé¢é‡ä¼ è¯¥æ•°æ®åŒ…çš„ç¼–å·ä¸º Packet N+2ï¼Œ**ä¸¢å¤±çš„æ•°æ®åŒ…å’Œé‡ä¼ çš„æ•°æ®åŒ… Stream ID ä¸ Offset éƒ½ä¸€è‡´ï¼Œè¯´æ˜è¿™ä¸¤ä¸ªæ•°æ®åŒ…çš„å†…å®¹ä¸€è‡´**ã€‚è¿™äº›æ•°æ®åŒ…ä¼ è¾“åˆ°æ¥æ”¶ç«¯åï¼Œæ¥æ”¶ç«¯èƒ½æ ¹æ® Stream ID ä¸ Offset å­—æ®µä¿¡æ¯å°† Stream x å’Œ Stream x+y æŒ‰ç…§é¡ºåºç»„ç»‡èµ·æ¥ï¼Œç„¶åäº¤ç»™åº”ç”¨ç¨‹åºå¤„ç†ã€‚

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/network/quic/Packet%E4%B8%A2%E5%A4%B1.jpeg)

æ€»çš„æ¥è¯´ï¼Œ**QUIC é€šè¿‡å•å‘é€’å¢çš„ Packet Numberï¼Œé…åˆ Stream ID ä¸ Offset å­—æ®µä¿¡æ¯ï¼Œå¯ä»¥æ”¯æŒä¹±åºç¡®è®¤è€Œä¸å½±å“æ•°æ®åŒ…çš„æ­£ç¡®ç»„è£…**ï¼Œæ‘†è„±äº†TCP å¿…é¡»æŒ‰é¡ºåºç¡®è®¤åº”ç­” ACK çš„é™åˆ¶ï¼Œè§£å†³äº† TCP å› æŸä¸ªæ•°æ®åŒ…é‡ä¼ è€Œé˜»å¡åç»­æ‰€æœ‰å¾…å‘é€æ•°æ®åŒ…çš„é—®é¢˜



> QUICå¦‚ä½•å®ç°æ›´å¿«çš„è¿æ¥å»ºç«‹ï¼Ÿ
>
> å¯¹äº HTTP/1 å’Œ HTTP/2 åè®®ï¼ŒTCP å’Œ TLS æ˜¯åˆ†å±‚çš„ï¼Œåˆ†åˆ«å±äºå†…æ ¸å®ç°çš„ä¼ è¾“å±‚ã€openssl åº“å®ç°çš„è¡¨ç¤ºå±‚ï¼Œå› æ­¤å®ƒä»¬éš¾ä»¥åˆå¹¶åœ¨ä¸€èµ·ï¼Œéœ€è¦åˆ†æ‰¹æ¬¡æ¥æ¡æ‰‹ï¼Œå…ˆ TCP æ¡æ‰‹ï¼ˆ1RTTï¼‰ï¼Œå† TLS æ¡æ‰‹ï¼ˆ2RTTï¼‰ï¼Œæ‰€ä»¥éœ€è¦ 3RTT çš„å»¶è¿Ÿæ‰èƒ½ä¼ è¾“æ•°æ®ï¼Œå°±ç®— Session ä¼šè¯æœç”¨ï¼Œä¹Ÿéœ€è¦è‡³å°‘ 2 ä¸ª RTTã€‚
>
> HTTP/3 åœ¨ä¼ è¾“æ•°æ®å‰è™½ç„¶éœ€è¦ QUIC åè®®æ¡æ‰‹ï¼Œè¿™ä¸ªæ¡æ‰‹è¿‡ç¨‹åªéœ€è¦ 1 RTTï¼Œæ¡æ‰‹çš„ç›®çš„æ˜¯ä¸ºç¡®è®¤åŒæ–¹çš„ã€Œè¿æ¥ IDã€ï¼Œè¿æ¥è¿ç§»å°±æ˜¯åŸºäºè¿æ¥ ID å®ç°çš„ã€‚
>
> å¦‚ä¸‹å›¾å³è¾¹éƒ¨åˆ†ï¼ŒHTTP/3 å½“ä¼šè¯æ¢å¤æ—¶ï¼Œæœ‰æ•ˆè´Ÿè½½æ•°æ®ä¸ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ä¸€èµ·å‘é€ï¼Œå¯ä»¥åšåˆ° 0-RTTï¼ˆä¸‹å›¾çš„å³ä¸‹è§’ï¼‰ï¼š
>
> <img src="https://github.com/amonstercat/PicGo/blob/main/dell/202403061850142.png?raw=true">
>
> 





## Cookie  Session  JWT



### **Cookie**

åœ¨HTTPè¯·æ±‚ä¸­ï¼ŒCookieä¿¡æ¯å­˜å‚¨åœ¨è¯·æ±‚å¤´éƒ¨çš„"Cookie"å­—æ®µä¸­ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å‘é€ç»™æœåŠ¡å™¨ã€‚

Cookieçš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š

(1)æœåŠ¡å™¨åœ¨å“åº”æµè§ˆå™¨çš„è¯·æ±‚æ—¶ï¼Œåœ¨å“åº”å¤´éƒ¨è®¾ç½®ä¸€ä¸ªåä¸º"`Set-Cookie`"çš„å­—æ®µï¼Œè¯¥å­—æ®µåŒ…å«äº†æœåŠ¡å™¨è¦è®¾ç½®çš„Cookieä¿¡æ¯ã€‚ä¾‹å¦‚:

```http
Set-Cookie: session_id=abc123; HttpOnly; Secure; Max-Age=3600; Path=/
```

(2)æµè§ˆå™¨æ¥æ”¶åˆ°æœåŠ¡å™¨å“åº”åï¼Œä¼šå°†è¿™ä¸ªCookieä¿¡æ¯ä¿å­˜åœ¨æœ¬åœ°

(3)åœ¨åç»­çš„æ¯ä¸ªè¯·æ±‚ä¸­ï¼Œæµè§ˆå™¨éƒ½ä¼šåœ¨è¯·æ±‚å¤´éƒ¨æ·»åŠ ä¸€ä¸ªåä¸º"Cookie"çš„å­—æ®µï¼Œå€¼ä¸ºä¹‹å‰ä¿å­˜çš„æ‰€æœ‰Cookieä¿¡æ¯ã€‚ä¾‹å¦‚ï¼š

```http
Cookie: session_id=abc123; other_cookie=xyz456
```

æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè§£æ"Cookie"å­—æ®µä¸­çš„ä¿¡æ¯ï¼Œä»ä¸­æå–å‡ºå¯¹åº”çš„æ•°æ®ï¼Œå®ç°ä¼šè¯è·Ÿè¸ªã€ç”¨æˆ·çŠ¶æ€ç®¡ç†ç­‰åŠŸèƒ½ã€‚





### **Session**

å¦‚æœæŠŠç”¨æˆ·åã€å¯†ç ç­‰é‡è¦éšç§éƒ½å­˜åˆ°å®¢æˆ·ç«¯çš„ Cookie ä¸­ï¼Œæœ‰æ³„å¯†é£é™©ã€‚ä¸ºäº†æ›´å®‰å…¨ï¼Œæ•…æŠŠæœºå¯†ä¿¡æ¯ä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šï¼Œè¿™å°±æ˜¯ `Session`ã€‚`Session`æ˜¯æœåŠ¡å™¨ä¸Šç»´æŠ¤çš„å®¢æˆ·æ¡£æ¡ˆï¼Œ**å¯ä»¥ç†è§£ä¸ºæœåŠ¡å™¨ç«¯æ•°æ®åº“ä¸­æœ‰ä¸€å¼  user è¡¨ï¼Œé‡Œé¢å­˜æ”¾äº†å®¢æˆ·ç«¯çš„ç”¨æˆ·ä¿¡æ¯ã€‚SessionID å°±æ˜¯è¿™å¼ è¡¨çš„ä¸»é”® ID**

> **Sessionæœºåˆ¶é€šå¸¸ä¾èµ–äºCookieæ¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“æ•°æ®**ã€‚åœ¨å…¸å‹çš„Webåº”ç”¨ä¸­ï¼ŒæœåŠ¡å™¨ä¼šåœ¨å®¢æˆ·ç«¯çš„æµè§ˆå™¨ä¸­è®¾ç½®ä¸€ä¸ªåä¸º"session_id"ï¼ˆæˆ–å…¶ä»–è‡ªå®šä¹‰åç§°ï¼‰çš„Cookieï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†è¯¥ç”¨æˆ·çš„ä¼šè¯:
>
> `Set-Cookie: session_id=abc123; HttpOnly; Secure; Path=/`

åŸºäºSessionä¼ è¾“æ•°æ®çš„æ–¹å¼åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šé¢ä¸´ä»¥ä¸‹é—®é¢˜ï¼š :astonished:

1. çŠ¶æ€ç®¡ç†ï¼šSessionæ•°æ®é€šå¸¸å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå› æ­¤éœ€è¦å¯¹ä¼šè¯çŠ¶æ€è¿›è¡Œç®¡ç†ã€‚å¯¹äºå¤§é‡å¹¶å‘ç”¨æˆ·çš„ç³»ç»Ÿï¼Œè¿™å¯èƒ½å¯¼è‡´**æœåŠ¡å™¨è´Ÿæ‹…è¿‡é‡ï¼Œéœ€è¦æ¶ˆè€—æ›´å¤šçš„æœåŠ¡å™¨èµ„æºæ¥ç»´æŠ¤è¿™äº›ä¼šè¯çŠ¶æ€**ã€‚

2. æ‰©å±•æ€§ï¼šç”±äºSessionæ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰©å±•ä¼šè¯ç®¡ç†å¯èƒ½ä¼šå˜å¾—å¤æ‚ã€‚éœ€è¦è€ƒè™‘å¦‚ä½•åœ¨å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´å…±äº«ä¼šè¯æ•°æ®æˆ–ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜(`Redis`å®ç°`session`å…±äº«)

   > Sessionå…±äº«æ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å™¨ä¹‹é—´å…±äº«ä¼šè¯æ•°æ®çš„é—®é¢˜ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•å¯ä»¥æœ‰å¤šç§ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼š
   >
   > 1. ä½¿ç”¨å…±äº«å­˜å‚¨ï¼šå°†Sessionæ•°æ®å­˜å‚¨åœ¨æ‰€æœ‰æœåŠ¡å™¨éƒ½å¯ä»¥è®¿é—®çš„å…±äº«å­˜å‚¨ä¸­ï¼Œä¾‹å¦‚å…±äº«æ•°æ®åº“ã€åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚Redisã€Memcachedï¼‰æˆ–åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚è¿™æ ·æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å¯ä»¥ä»åŒä¸€ä¸ªå­˜å‚¨ä½ç½®è¯»å–å’Œæ›´æ–°Sessionæ•°æ®ã€‚
   > 2. ä½¿ç”¨ç²˜æ€§ä¼šè¯ï¼ˆSticky Sessionsï¼‰ï¼šåœ¨è´Ÿè½½å‡è¡¡å™¨ä¸­å¯ç”¨ç²˜æ€§ä¼šè¯é…ç½®ï¼Œå³ç¡®ä¿åŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚æ€»æ˜¯å‘é€åˆ°åŒä¸€ä¸ªåç«¯æœåŠ¡å™¨ï¼Œè¿™æ ·åœ¨æŸä¸ªæœåŠ¡å™¨ä¸Šåˆ›å»ºçš„Sessionå¯ä»¥åœ¨æ•´ä¸ªä¼šè¯æœŸé—´ä¸€ç›´ä½¿ç”¨
   > 3. ä½¿ç”¨åˆ†å¸ƒå¼Sessionï¼šä½¿ç”¨ä¸“é—¨çš„åˆ†å¸ƒå¼Sessionç®¡ç†æ–¹æ¡ˆï¼Œä¾‹å¦‚Spring Sessionç­‰ã€‚è¿™äº›æ–¹æ¡ˆé€šè¿‡å°†Sessionæ•°æ®å­˜å‚¨åœ¨å…±äº«å­˜å‚¨ä¸­ï¼ŒåŒæ—¶ä½¿ç”¨Cookieæˆ–Headerä¸­çš„æ ‡è¯†æ¥è·Ÿè¸ªç”¨æˆ·çš„ä¼šè¯ã€‚
   > 4. ä½¿ç”¨æ— çŠ¶æ€è®¤è¯ï¼š**é¿å…åœ¨æœåŠ¡å™¨ç«¯å­˜å‚¨ä¼šè¯æ•°æ®ï¼Œè€Œæ˜¯ä½¿ç”¨æ— çŠ¶æ€è®¤è¯æ–¹æ¡ˆ**ï¼Œå¦‚JSON Web Token (JWT)ã€‚JWTå°†ä¼šè¯æ•°æ®ç¼–ç ä¸ºTokenï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å­˜å‚¨ï¼Œè¿™æ ·å°±ä¸éœ€è¦åœ¨æœåŠ¡å™¨ç«¯å…±äº«ä¼šè¯æ•°æ®ã€‚
   > 5. ä½¿ç”¨ä¸­å¤®è®¤è¯æœåŠ¡ï¼ˆ`Centralized Authentication Service`ï¼‰ï¼šé‡‡ç”¨å•ç‚¹ç™»å½•ï¼ˆSingle Sign-Onï¼ŒSSOï¼‰è§£å†³æ–¹æ¡ˆï¼Œå¼•å…¥ä¸€ä¸ªç‹¬ç«‹çš„ä¸­å¤®è®¤è¯æœåŠ¡æ¥ç®¡ç†ç”¨æˆ·çš„ä¼šè¯çŠ¶æ€ã€‚è¿™æ ·ç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡ï¼Œå°±å¯ä»¥åœ¨å¤šä¸ªç›¸å…³ç³»ç»Ÿä¸­å…±äº«ä¼šè¯çŠ¶æ€ã€‚

3. å†…å­˜æ¶ˆè€—ï¼šéšç€ç”¨æˆ·æ•°é‡çš„å¢åŠ ï¼Œ**æœåŠ¡å™¨éœ€è¦å­˜å‚¨å’Œç»´æŠ¤æ›´å¤šçš„Sessionæ•°æ®**ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ¶ˆè€—è¿‡å¤§

4. ä¼šè¯è¿‡æœŸï¼šSessioné€šå¸¸æœ‰ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä¸€æ—¦è¶…è¿‡è¯¥æ—¶é—´ï¼Œä¼šè¯æ•°æ®å°†è¢«æ¸…é™¤ã€‚è¿™å¯èƒ½å¯¼è‡´ç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ´»åŠ¨åéœ€è¦é‡æ–°ç™»å½•æˆ–é‡æ–°æäº¤æ•°æ®



`Cookie`å’Œ`Session`éƒ½æ˜¯ç”¨äºåœ¨Webåº”ç”¨ä¸­å­˜å‚¨å’Œç®¡ç†ç”¨æˆ·çŠ¶æ€ä¿¡æ¯çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬æœ‰ä¸€äº›å…³é”®çš„åŒºåˆ«ï¼š

1. å­˜å‚¨ä½ç½®ï¼š
   - Cookieï¼šCookieæ˜¯å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ç«¯çš„å°æ®µæ–‡æœ¬ä¿¡æ¯ã€‚å½“æœåŠ¡å™¨å“åº”æµè§ˆå™¨çš„è¯·æ±‚æ—¶ï¼Œä¼šåœ¨å“åº”å¤´ä¸­è®¾ç½®ä¸€ä¸ªåä¸º"Set-Cookie"çš„å­—æ®µï¼Œæµè§ˆå™¨ä¼šå°†è¿™ä¸ªCookieä¿å­˜åœ¨æœ¬åœ°ï¼Œä»¥åæ¯æ¬¡è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨æºå¸¦è¿™ä¸ªCookieä¿¡æ¯
   - Sessionï¼šSessionæ˜¯å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯çš„ç”¨æˆ·çŠ¶æ€ä¿¡æ¯ã€‚å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„Sessionæ ‡è¯†ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šã€‚ç„¶ååœ¨ç”¨æˆ·çš„æ¯æ¬¡è¯·æ±‚ä¸­ï¼Œæµè§ˆå™¨ä¼šæºå¸¦è¿™ä¸ªSessionæ ‡è¯†ï¼ŒæœåŠ¡å™¨é€šè¿‡å®ƒæ¥è¯†åˆ«ç”¨æˆ·å¹¶ç®¡ç†å…¶çŠ¶æ€
2. å­˜å‚¨å†…å®¹ï¼š
   - Cookieï¼šCookieä¸€èˆ¬å­˜å‚¨å°‘é‡çš„æ–‡æœ¬ä¿¡æ¯ï¼Œç”¨äºæ ‡è¯†å’Œå­˜å‚¨ç”¨æˆ·çš„ä¸€äº›çŠ¶æ€ï¼Œå¦‚ç™»å½•ä¿¡æ¯ã€ç”¨æˆ·åå¥½ç­‰
   - Sessionï¼šSessionåœ¨æœåŠ¡å™¨ç«¯å­˜å‚¨ï¼Œå› æ­¤å¯ä»¥å­˜å‚¨æ›´å¤§é‡çš„æ•°æ®ï¼Œä¸€èˆ¬ç”¨äºå­˜å‚¨ç”¨æˆ·åœ¨ç½‘ç«™ä¸Šçš„äº¤äº’ä¿¡æ¯ã€è´­ç‰©è½¦å†…å®¹ã€æƒé™ç­‰
3. å®‰å…¨æ€§ï¼š
   - Cookieï¼šCookieå­˜å‚¨åœ¨æµè§ˆå™¨ç«¯ï¼Œè™½ç„¶å¯ä»¥è®¾ç½®Cookieçš„è¿‡æœŸæ—¶é—´å’Œå®‰å…¨æ ‡è®°ï¼ˆSecureå’ŒHttpOnlyï¼‰ï¼Œä½†ä»ç„¶å®¹æ˜“å—åˆ°ä¸€äº›å®‰å…¨æ”»å‡»ï¼Œå¦‚è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰å’Œè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰
   - Sessionï¼šSessionå­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œç›¸å¯¹æ¥è¯´æ›´å®‰å…¨ï¼Œå› ä¸ºç”¨æˆ·æ— æ³•ç›´æ¥ä¿®æ”¹å…¶ä¸­çš„æ•°æ®ï¼Œä½†ä¹Ÿè¦é˜²èŒƒSessionåŠ«æŒç­‰å®‰å…¨é—®é¢˜







### JWT

JWT çš„è‹±æ–‡å…¨ç§°æ˜¯ `JSON Web Token`ã€‚JWT æŠŠæ‰€æœ‰ä¿¡æ¯éƒ½å­˜åœ¨è‡ªå·±èº«ä¸Šäº†ï¼ŒåŒ…æ‹¬ç”¨æˆ·åå¯†ç ã€åŠ å¯†ä¿¡æ¯ç­‰ï¼Œä¸”ä»¥ JSON å¯¹è±¡å­˜å‚¨çš„

**ä¸€ä¸ªJWTå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œå¤´éƒ¨ã€è½½è·ä¸ç­¾å**

**1. å¤´éƒ¨ï¼ˆHeaderï¼‰**

å¤´éƒ¨ç”¨äºæè¿°å…³äºè¯¥JWTçš„æœ€åŸºæœ¬çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å…¶ç±»å‹ä»¥åŠç­¾åæ‰€ç”¨çš„ç®—æ³•ç­‰ã€‚è¿™ä¹Ÿå¯ä»¥è¢«è¡¨ç¤ºæˆä¸€ä¸ªJSONå¯¹è±¡ï¼Œä¸‹é¢å­—ç¬¦ä¸²åœ¨å¤´éƒ¨æŒ‡æ˜äº†ç­¾åç®—æ³•æ˜¯HS256ç®—æ³•,**å¤´éƒ¨ä½¿ç”¨Base64ç¼–ç ï¼Œä½†ä¸åŠ å¯†**

```text
{
  "alg": "HS256",
  "typ": "JWT"
}
```



**2. è½½è·ï¼ˆpayloadï¼‰**

è½½è·å°±æ˜¯æ˜¯å­˜å‚¨å®é™…æ•°æ®çš„éƒ¨åˆ†ã€‚JWTçš„è½½è·å¯ä»¥åŒ…å«è‡ªå®šä¹‰çš„å£°æ˜ï¼ˆClaimï¼‰ï¼Œå¦‚ç”¨æˆ·IDã€è§’è‰²ã€æƒé™ç­‰ï¼Œ**è½½è·åŒæ ·ä½¿ç”¨Base64ç¼–ç ï¼Œä½†ä¸è¿›è¡ŒåŠ å¯†**

å®šä¹‰ä¸€ä¸ªpayload:

```
{
  "sub": "john_doe",
  "role": "admin",
  "iat": 1626302604,
  "exp": 1626303504
}


```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œè½½è·åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š

- "sub"ï¼ˆSubjectï¼‰ï¼šç”¨æˆ·åï¼Œè¿™é‡Œæ˜¯"john_doe"ã€‚
- "role"ï¼šç”¨æˆ·è§’è‰²ï¼Œè¿™é‡Œæ˜¯"admin"ï¼Œè¡¨ç¤ºç”¨æˆ·å…·æœ‰ç®¡ç†å‘˜æƒé™ã€‚
- "iat"ï¼ˆIssued Atï¼‰ï¼šJWTçš„å‘è¡Œæ—¶é—´ï¼Œè¿™é‡Œæ˜¯Unixæ—¶é—´æˆ³ï¼Œè¡¨ç¤ºJWTçš„å‘è¡Œæ—¶é—´ä¸º2021å¹´7æœˆ15æ—¥ 10:30:04ã€‚
- "exp"ï¼ˆExpiration Timeï¼‰ï¼šJWTçš„è¿‡æœŸæ—¶é—´ï¼Œè¿™é‡Œä¹Ÿæ˜¯Unixæ—¶é—´æˆ³ï¼Œè¡¨ç¤ºJWTçš„è¿‡æœŸæ—¶é—´ä¸º2021å¹´7æœˆ15æ—¥ 10:45:04



**3.ç­¾è¯ï¼ˆsignatureï¼‰**

jwtçš„ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ä¸€ä¸ªç­¾åï¼Œsignature æ˜¯å¯¹å‰ä¸¤ä¸ªéƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®è¢«ç¯¡æ”¹ã€‚

```javascript
data = base64urlEncode( header ) + "." + base64urlEncode( payload );
signature = Hash( data, secret );
```

åœ¨ JWT ä¸­ï¼Œ`secret` æ˜¯æŒ‡ç”¨äºç”Ÿæˆå’ŒéªŒè¯ç­¾åçš„å¯†é’¥ã€‚å½“ä½¿ç”¨ HMAC ç®—æ³•ï¼ˆå¦‚ HS256ã€HS384ã€HS512ï¼‰æ—¶ï¼Œ`secret` æ˜¯ä¸€ä¸ªå¯¹ç§°å¯†é’¥ï¼Œç”±ç­¾å‘ JWT çš„æœåŠ¡ç«¯ç”Ÿæˆå¹¶å­˜å‚¨ã€‚å…·ä½“æ¥è¯´ï¼Œ`secret` çš„ä½œç”¨å¦‚ä¸‹ï¼š

1. **ç”Ÿæˆç­¾åï¼š** åœ¨ç­¾å‘ JWT æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨ `secret` å¯¹å¤´éƒ¨å’Œè½½è·è¿›è¡Œç­¾åç”Ÿæˆç­¾åéƒ¨åˆ†ã€‚è¿™æ˜¯é€šè¿‡å°†å¤´éƒ¨å’Œè½½è·åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨æŒ‡å®šçš„å“ˆå¸Œç®—æ³•å’Œ `secret` è¿›è¡Œå“ˆå¸Œè¿ç®—æ¥å®ç°çš„ã€‚
2. **éªŒè¯ç­¾åï¼š** åœ¨éªŒè¯ JWT æ—¶ï¼Œæ¥æ”¶ç«¯éœ€è¦è·å–åˆ° JWT ä¸­çš„ç­¾åéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨ä¸ç­¾å‘ç«¯ç›¸åŒçš„ `secret` å¯¹å¤´éƒ¨å’Œè½½è·è¿›è¡Œç›¸åŒçš„å“ˆå¸Œè¿ç®—ã€‚æ¥æ”¶ç«¯ä¼šæ¯”è¾ƒç”Ÿæˆçš„ç­¾åéƒ¨åˆ†ä¸ JWT ä¸­çš„ç­¾åéƒ¨åˆ†æ˜¯å¦ä¸€è‡´ï¼Œä»è€ŒéªŒè¯ JWT çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚

ç”±äº HMAC ç®—æ³•ä½¿ç”¨çš„æ˜¯å¯¹ç§°å¯†é’¥ï¼Œå› æ­¤éœ€è¦ç¡®ä¿ç­¾å‘ JWT å’ŒéªŒè¯ JWT çš„ä¸¤ç«¯éƒ½çŸ¥é“ç›¸åŒçš„ `secret`ã€‚**è¿™æ„å‘³ç€ `secret` å¿…é¡»åœ¨ç­¾å‘ JWT æ—¶ä¸æ¥æ”¶ç«¯å…±äº«ï¼Œä»¥ä¾¿æ¥æ”¶ç«¯èƒ½å¤Ÿä½¿ç”¨ç›¸åŒçš„å¯†é’¥æ¥éªŒè¯ JWT çš„ç­¾åï¼Œå³å®¢æˆ·ç«¯å‘é€jwtç»™æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨å·²ç»æœ‰äº†è¿™ä¸ªsecretå¯†é’¥äº†ï¼**



JWTçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€ç™»å½•è¯·æ±‚ï¼ŒæœåŠ¡å™¨éªŒè¯ç”¨æˆ·çš„èº«ä»½å’Œå‡­æ®
2. æœåŠ¡å™¨åœ¨éªŒè¯æˆåŠŸåç”Ÿæˆä¸€ä¸ªJWTï¼Œå°†ç”¨æˆ·çš„ä¿¡æ¯å’Œå…¶ä»–å¿…è¦ä¿¡æ¯æ·»åŠ åˆ°JWTçš„è½½è·ä¸­
3. æœåŠ¡å™¨å°†JWTå‘é€å›å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°†å…¶ä¿å­˜ï¼Œé€šå¸¸å­˜å‚¨åœ¨æœ¬åœ°å­˜å‚¨ï¼ˆ`LocalStorage`ï¼‰æˆ–ä¼šè¯å­˜å‚¨ï¼ˆ`SessionStorage`ï¼‰ä¸­
4. å®¢æˆ·ç«¯åœ¨åç»­è¯·æ±‚ä¸­ï¼Œå°†JWTé€šè¿‡è¯·æ±‚å¤´æˆ–å…¶ä»–æ–¹å¼å‘é€ç»™æœåŠ¡å™¨
5. æœåŠ¡å™¨æ¥æ”¶åˆ°JWTåï¼Œä½¿ç”¨ä¹‹å‰è®¾ç½®çš„å¯†é’¥æ¥éªŒè¯JWTçš„ç­¾åï¼Œå¹¶è§£æå‡ºç”¨æˆ·ä¿¡æ¯å’Œå…¶ä»–æ•°æ®ï¼Œå®Œæˆç”¨æˆ·è®¤è¯å’Œæˆæƒ



ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

å‡è®¾æœ‰ä¸€ä¸ªWebåº”ç”¨ç¨‹åºï¼Œç”¨æˆ·é€šè¿‡ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼ŒæœåŠ¡å™¨éªŒè¯ç”¨æˆ·ä¿¡æ¯åï¼Œä½¿ç”¨JWTç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Œå¹¶å°†å…¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚JWTçš„è½½è·ä¸­åŒ…å«äº†ç”¨æˆ·åå’Œç”¨æˆ·è§’è‰²ä¿¡æ¯ã€‚

**ç™»å½•è¯·æ±‚**ï¼š å®¢æˆ·ç«¯å‘é€ç™»å½•è¯·æ±‚

```http
POST /login HTTP/1.1
Content-Type: application/json

{
  "username": "john_doe",
  "password": "secret123"
}
```

æœåŠ¡å™¨éªŒè¯ç”¨æˆ·åå’Œå¯†ç æˆåŠŸåï¼Œ**ç”ŸæˆJWTå¹¶å‘é€å›å®¢æˆ·ç«¯**ï¼š

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "access_token": #JWT
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImpvaG5fZG9lIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNjI2MzAyNjA0LCJleHAiOjE2MjYzMDM1MDR9.BQzczqJLk5pODe0fojQGtfIhLOJ-i4Fm4tS7VqO8Bmo"
}
```

**åç»­è¯·æ±‚**ï¼š å®¢æˆ·ç«¯åœ¨åç»­çš„è¯·æ±‚ä¸­ï¼Œåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦JWTä½œä¸ºèº«ä»½è®¤è¯ä¿¡æ¯ï¼š

```http
GET /api/data HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImpvaG5fZG9lIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNjI2MzAyNjA0LCJleHAiOjE2MjYzMDM1MDR9.BQzczqJLk5pODe0fojQGtfIhLOJ-i4Fm4tS7VqO8Bmo
```

æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè§£æJWTå¹¶éªŒè¯ç­¾åå’Œæœ‰æ•ˆæœŸã€‚å¦‚æœéªŒè¯æˆåŠŸï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®JWTä¸­çš„ä¿¡æ¯å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒï¼Œå¹¶è¿”å›è¯·æ±‚çš„æ•°æ®ã€‚è¿™æ ·ï¼Œé€šè¿‡JWTï¼ŒæœåŠ¡å™¨å¯ä»¥åœ¨ä¸éœ€è¦å­˜å‚¨ä¼šè¯ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼Œå¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒï¼Œå®ç°äº†æ— çŠ¶æ€çš„èº«ä»½éªŒè¯æ–¹æ¡ˆ

> `Authorization: Bearer`æ˜¯ä¸€ç§HTTPè¯·æ±‚å¤´ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶æºå¸¦èº«ä»½éªŒè¯å‡­è¯ï¼ˆé€šå¸¸æ˜¯ä»¤ç‰Œï¼‰ã€‚è¿™ç§èº«ä»½éªŒè¯æ–¹å¼é€šå¸¸ä¸JWTï¼ˆJSON Web Tokenï¼‰ä¸€èµ·ä½¿ç”¨ã€‚
>
> åœ¨ä½¿ç”¨JWTè¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œå®¢æˆ·ç«¯é€šå¸¸åœ¨è¯·æ±‚å¤´ä¸­ä½¿ç”¨`Authorization: Bearer`å¤´éƒ¨æ¥ä¼ é€’JWTä»¤ç‰Œã€‚è¿™ä¸ªå¤´éƒ¨çš„æ ¼å¼å¦‚ä¸‹ï¼š
>
> ```http
> Authorization: Bearer <token>
> ```
>
> å…¶ä¸­ï¼Œ`<token>`æ˜¯ç”±æœåŠ¡å™¨é¢å‘çš„JWTä»¤ç‰Œï¼Œå®ƒä¼šæ”¾åœ¨`Bearer`åé¢ï¼Œå¹¶ç”¨ç©ºæ ¼åˆ†éš”ã€‚





## HTTP

### HTTPæŠ¥æ–‡æ ¼å¼

```
[è¯·æ±‚è¡Œ/çŠ¶æ€è¡Œ]
[è¯·æ±‚å¤´/å“åº”å¤´]
[ç©ºè¡Œ]
[è¯·æ±‚ä½“/å“åº”ä½“]
```

åœ¨HTTPåè®®ä¸­ï¼Œå¤´éƒ¨ï¼ˆHeaderï¼‰å’Œä¸»ä½“ï¼ˆBodyï¼‰ä¹‹é—´é€šè¿‡ä¸€ä¸ªç©ºè¡Œæ¥è¿›è¡Œåˆ†å‰²ã€‚è¿™ä¸ªç©ºè¡Œæ˜¯ç”±**å›è½¦ç¬¦ï¼ˆCRï¼‰å’Œæ¢è¡Œç¬¦ï¼ˆLFï¼‰**ç»„æˆçš„ä¸€è¡Œï¼Œå³"\r\n"ï¼Œè¿™ä¸ªç©ºè¡Œæ ‡å¿—ç€å¤´éƒ¨çš„ç»“æŸå’Œä¸»ä½“çš„å¼€å§‹

è¯·æ±‚è¡Œæˆ–çŠ¶æ€è¡ŒåŒ…å«äº†HTTPæ–¹æ³•ï¼ˆGETã€POSTã€PUTï¼‰**æˆ–HTTPåè®®ç‰ˆæœ¬**ã€çŠ¶æ€ç å’ŒçŠ¶æ€æè¿°ï¼ˆå¯¹äºçŠ¶æ€è¡Œï¼‰

è¯·æ±‚å¤´æˆ–å“åº”å¤´åŒ…å«äº†ä¸€ç³»åˆ—çš„é”®å€¼å¯¹ï¼Œç”¨äºä¼ é€’å…³äºè¯·æ±‚æˆ–å“åº”çš„é™„åŠ ä¿¡æ¯ã€‚æ¯ä¸ªé”®å€¼å¯¹ä»¥å†’å·ï¼ˆ:ï¼‰åˆ†éš”ï¼Œä¾‹å¦‚`Content-Type: application/json`

ç©ºè¡Œï¼ˆå³åªåŒ…å«å›è½¦ç¬¦å’Œæ¢è¡Œç¬¦çš„è¡Œï¼‰ç”¨äºåˆ†éš”å¤´éƒ¨å’Œä¸»ä½“ã€‚

è¯·æ±‚ä½“æˆ–å“åº”ä½“åŒ…å«äº†å®é™…çš„æ•°æ®ï¼Œä¾‹å¦‚HTMLæ–‡æ¡£ã€JSONæ•°æ®ç­‰

ç¤ºä¾‹ä¸€ä¸ªHTTPè¯·æ±‚æŠ¥æ–‡çš„ä¾‹å­ï¼š

```http
GET /index.html HTTP/1.1     è¯·æ±‚è¡Œ
Host: example.com          
User-Agent: Mozilla/5.0
Accept: text/html

[è¯·æ±‚ä½“]
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¯·æ±‚è¡Œä¸º`GET /index.html HTTP/1.1`ï¼Œè¯·æ±‚å¤´åŒ…æ‹¬ `Hostã€User-Agentå’ŒAccept` å­—æ®µï¼Œç©ºè¡Œä¹‹åæ˜¯è¯·æ±‚ä½“ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚

### HTTPé¦–éƒ¨å­—æ®µï¼ˆheaderï¼‰

HTTPé¦–éƒ¨å­—æ®µæ ¹æ®ç”¨é€”å¯åˆ†ä¸º4ç§ç±»å‹ï¼š

- é€šç”¨é¦–éƒ¨å­—æ®µï¼ˆGeneral Header Fieldsï¼‰ è¯·æ±‚å’Œå“åº”æŠ¥æ–‡ä¸¤æ–¹éƒ½ä¼šä½¿ç”¨çš„é¦–éƒ¨å­—æ®µ

  ```
  Connetcion: Keep-Alive //é•¿è¿æ¥
  Cache-Controlï¼šno-cache
  Date: åˆ›å»ºæŠ¥æ–‡çš„æ—¥æœŸ
  ```

- è¯·æ±‚é¦–éƒ¨å­—æ®µï¼ˆRequest Header Fieldsï¼‰å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚çš„æŠ¥æ–‡æ—¶ä½¿ç”¨çš„é¦–éƒ¨ã€‚è¡¥å……äº†è¯·æ±‚çš„é™„åŠ å†…å®¹ã€å®¢æˆ·ç«¯ä¿¡æ¯ã€å“åº”å†…å®¹ç›¸å…³çš„ä¼˜å…ˆç­‰çº§ä¿¡æ¯

  ```
  Accept: text/plain     */* è¡¨ç¤ºå¯ä»¥æ¥æ”¶æ‰€æœ‰ç±»å‹æ•°æ®
  Accept-Language: en-US  //èƒ½å¤Ÿæ¥å—çš„å›åº”å†…å®¹çš„è‡ªç„¶è¯­è¨€åˆ—è¡¨
  Accept-Encoding: gzip, deflate  //èƒ½å¤Ÿæ¥å—çš„ç¼–ç æ–¹å¼åˆ—è¡¨
  If-Modified-Since:  Sat, 29 Oct 2020 19:43:31 GMT  //è®©æœåŠ¡å™¨åˆ¤æ–­è¯¥èµ„æºåœ¨è¯¥æ—¥æœŸåæ˜¯å¦è¢«ä¿®æ”¹è¿‡
  If-Match:  If-Match: "737060cd8c284d8af7ad3082f209582d" ä»…å½“å®¢æˆ·ç«¯æä¾›çš„å®ä½“ä¸æœåŠ¡å™¨ä¸Šå¯¹åº”çš„å®ä½“ç›¸åŒ¹é…æ—¶ï¼Œæ‰è¿›è¡Œå¯¹åº”çš„æ“ä½œ
  If-None-Matchï¼š æ¯”è¾ƒå®ä½“æ ‡è®°(ETage)ï¼Œä¸ç›¸ç­‰æ—¶æ‰ç»§ç»­æ“ä½œ   ä¸ If-Matchç›¸å
  User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:12.0) Gecko/20100101 Firefox/21.0
  Cookie:
  ```

- å“åº”é¦–éƒ¨å­—æ®µï¼ˆResponse Header Fieldsï¼‰ä»æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å“åº”æ—¶ä½¿ç”¨çš„å­—æ®µï¼Œè¡¥å……å“åº”çš„é™„åŠ å†…å®¹ï¼Œä¹Ÿä¼šè¦æ±‚å®¢æˆ·ç«¯é™„åŠ é¢å¤–ä¿¡æ¯

  ```
  Location: ä»¤å®¢æˆ·ç«¯é‡å®šå‘çš„URI
  Server: æœåŠ¡å™¨çš„ä¿¡æ¯
  Proxy-Authenticate: ä»£ç†æœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯çš„éªŒè¯ä¿¡æ¯
  Retry-After:   å’ŒçŠ¶æ€ç 503ä¸€èµ·ä½¿ç”¨çš„é¦–éƒ¨å­—æ®µï¼Œè¡¨ç¤ºä¸‹æ¬¡è¯·æ±‚æœåŠ¡å™¨çš„æ—¶é—´
  ETag: èƒ½å¤Ÿè¡¨ç¤ºèµ„æºå”¯ä¸€èµ„æºçš„å­—ç¬¦ä¸²
  Last-Modified: è¯¥å“åº”èµ„æºæœ€åçš„ä¿®æ”¹æ—¶é—´
  Set-Cookie:
  ```

- å®ä½“é¦–éƒ¨å­—æ®µï¼ˆEntiy Header Fieldsï¼‰ é’ˆå¯¹è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡çš„å®ä½“éƒ¨åˆ†ä½¿ç”¨é¦–éƒ¨ã€‚è¡¥å……äº†èµ„æºå†…å®¹æ›´æ–°æ—¶é—´ç­‰å®ä½“æœ‰å…³çš„ä¿¡æ¯

  ```
  Content-Language:
  Content-Encoding:gzip  //å®ä½“çš„ç¼–ç æ ¼å¼
  Content-Lengthï¼š1000   //å®ä½“çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  Content-Type: text/html; Charset=utf-8  å®ä½“åª’ä½“ç±»å‹
  Last-Modified: èµ„æºæœ€åçš„ä¿®æ”¹æ—¶é—´
  ```





### HTTPS

é¢„å¤‡çŸ¥è¯†ï¼š

ï¼ˆ1ï¼‰æ··åˆåŠ å¯†ï¼šHTTPS é‡‡ç”¨çš„æ˜¯**å¯¹ç§°åŠ å¯†**å’Œ**éå¯¹ç§°åŠ å¯†**ç»“åˆçš„ã€Œæ··åˆåŠ å¯†ã€æ–¹å¼

- åœ¨é€šä¿¡å»ºç«‹å‰é‡‡ç”¨**éå¯¹ç§°åŠ å¯†**çš„æ–¹å¼**äº¤æ¢ã€Œä¼šè¯ç§˜é’¥ã€**ï¼Œåç»­å°±ä¸å†ä½¿ç”¨éå¯¹ç§°åŠ å¯†ã€‚
- åœ¨é€šä¿¡è¿‡ç¨‹ä¸­å…¨éƒ¨ä½¿ç”¨**å¯¹ç§°åŠ å¯†**çš„ã€Œä¼šè¯ç§˜é’¥ã€çš„æ–¹å¼åŠ å¯†æ˜æ–‡æ•°æ®ã€‚

ï¼ˆ2ï¼‰æ‘˜è¦ç®—æ³•+æ•°å­—ç­¾åï¼š

- å¯¹å¯†æ–‡è¿›è¡Œå“ˆå¸Œè¿ç®—

![MAC](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%91%98%E8%A6%81%E7%AE%97%E6%B3%95.jpg)

- åŒæ—¶å¯¹è®¡ç®—åçš„å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼ˆç§é’¥åŠ å¯†-å…¬é’¥è§£å¯†ï¼‰

![æ•°å­—ç­¾å](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D.jpg)

ï¼ˆ3ï¼‰æ•°å­—è¯ä¹¦ï¼ˆCAæœºæ„ï¼‰

CAå¯¹æœåŠ¡å™¨æä¾›çš„å…¬é’¥è¿›è¡Œæ•°å­—ç­¾åï¼ˆ**ç§é’¥åŠ å¯†**ï¼‰ï¼Œå¹¶å°†æœåŠ¡å™¨çš„å…¬é’¥æ”¾åœ¨æ•°å­—è¯ä¹¦ä¸­ï¼Œ**å®¢æˆ·ç«¯é€šè¿‡CAå…¬é’¥è§£å¯†æ•°å­—è¯ä¹¦**ï¼Œæ—¢å¾—åˆ°äº†æœåŠ¡å™¨çš„å…¬é’¥ï¼Œåˆè¯æ˜äº†æƒå¨æ€§ï¼š

![Certificate-Authentication](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/CA.jpg)





åœ¨è¿›è¡Œ HTTPS é€šä¿¡æ—¶ï¼Œ**TLS æ¡æ‰‹ï¼ˆTLS Handshakeï¼‰æ˜¯åœ¨ TCP æ¡æ‰‹ï¼ˆTCP Handshakeï¼‰ä¹‹åè¿›è¡Œçš„**ã€‚



SSL/TLS åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

- å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç´¢è¦å¹¶éªŒè¯æœåŠ¡å™¨çš„å…¬é’¥
- åŒæ–¹åå•†ç”Ÿäº§ã€Œä¼šè¯ç§˜é’¥ã€
- åŒæ–¹é‡‡ç”¨ã€Œä¼šè¯ç§˜é’¥ã€è¿›è¡ŒåŠ å¯†é€šä¿¡

å‰ä¸¤æ­¥å³`TLS`çš„å»ºç«‹ï¼ŒåŸºäº `RSA` ç®—æ³•çš„`TLS`å››æ¬¡æ¡æ‰‹è¿‡ç¨‹å¦‚ä¸‹:
![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/23-HTTPS%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.jpg)

*1. `ClientHello`*
é¦–å…ˆï¼Œç”±å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·åŠ å¯†é€šä¿¡è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ `ClientHello` è¯·æ±‚ã€‚

åœ¨è¿™ä¸€æ­¥ï¼Œå®¢æˆ·ç«¯ä¸»è¦å‘æœåŠ¡å™¨å‘é€ä»¥ä¸‹ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰**å®¢æˆ·ç«¯æ”¯æŒçš„ TLS åè®®ç‰ˆæœ¬**ï¼Œå¦‚ TLS 1.2 ç‰ˆæœ¬

ï¼ˆ2ï¼‰å®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºæ•°ï¼ˆ`Client Random`ï¼‰ï¼Œåé¢ç”¨äºç”Ÿæˆã€Œä¼šè¯ç§˜é’¥ã€æ¡ä»¶ä¹‹ä¸€ã€‚

ï¼ˆ3ï¼‰å®¢æˆ·ç«¯æ”¯æŒçš„å¯†ç å¥—ä»¶åˆ—è¡¨ï¼Œå¦‚ RSA åŠ å¯†ç®—æ³•

*2. `SeverHello`*

æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œå‘å®¢æˆ·ç«¯å‘å‡ºå“åº”ï¼Œä¹Ÿå°±æ˜¯ `SeverHello`ã€‚æœåŠ¡å™¨å›åº”çš„å†…å®¹æœ‰å¦‚ä¸‹å†…å®¹ï¼š

ï¼ˆ1ï¼‰ç¡®è®¤ TLS åè®®ç‰ˆæœ¬ï¼Œå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒï¼Œåˆ™å…³é—­åŠ å¯†é€šä¿¡(æµè§ˆå™¨è¦åŒ¹é…å®¢æˆ·ç«¯çš„TLSåè®®)

ï¼ˆ2ï¼‰æœåŠ¡å™¨ç”Ÿäº§çš„éšæœºæ•°ï¼ˆ`Server Random`ï¼‰ï¼Œä¹Ÿæ˜¯åé¢ç”¨äºç”Ÿäº§ã€Œä¼šè¯ç§˜é’¥ã€æ¡ä»¶ä¹‹ä¸€

ï¼ˆ3ï¼‰ç¡®è®¤çš„å¯†ç å¥—ä»¶åˆ—è¡¨ï¼Œå¦‚ RSA åŠ å¯†ç®—æ³•

ï¼ˆ4ï¼‰**æœåŠ¡å™¨çš„æ•°å­—è¯ä¹¦**

*3.å®¢æˆ·ç«¯å›åº”*

å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„å›åº”ä¹‹åï¼Œé¦–å…ˆ**é€šè¿‡æµè§ˆå™¨æˆ–è€…æ“ä½œç³»ç»Ÿä¸­çš„ CA å…¬é’¥ï¼Œç¡®è®¤æœåŠ¡å™¨çš„æ•°å­—è¯ä¹¦çš„çœŸå®æ€§**ã€‚

å¦‚æœè¯ä¹¦æ²¡æœ‰é—®é¢˜ï¼Œå®¢æˆ·ç«¯ä¼š**ä»æ•°å­—è¯ä¹¦ä¸­å–å‡ºæœåŠ¡å™¨çš„å…¬é’¥**ï¼Œç„¶åä½¿ç”¨å®ƒåŠ å¯†æŠ¥æ–‡ï¼Œå‘æœåŠ¡å™¨å‘é€å¦‚ä¸‹ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰ä¸€ä¸ªéšæœºæ•°ï¼ˆ`pre-master key`ï¼‰ã€‚**è¯¥éšæœºæ•°ä¼šè¢«æœåŠ¡å™¨å…¬é’¥åŠ å¯†ï¼ˆå› ä¸ºå‰ä¸¤æ¬¡äº¤äº’äº§ç”Ÿçš„éšæœºæ•°æœ‰å¯èƒ½è¢«çªƒå¬åˆ°ï¼‰**ã€‚

ï¼ˆ2ï¼‰**åŠ å¯†é€šä¿¡ç®—æ³•æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨ã€Œä¼šè¯ç§˜é’¥ã€åŠ å¯†é€šä¿¡**ã€‚

ï¼ˆ3ï¼‰å®¢æˆ·ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶æŠŠä¹‹å‰æ‰€æœ‰å†…å®¹çš„å‘ç”Ÿçš„æ•°æ®åšä¸ªæ‘˜è¦ï¼Œç”¨æ¥ä¾›æœåŠ¡ç«¯æ ¡éªŒã€‚

ä¸Šé¢ç¬¬ä¸€é¡¹çš„éšæœºæ•°æ˜¯æ•´ä¸ªæ¡æ‰‹é˜¶æ®µçš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ï¼Œä¼šå‘ç»™æœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¿™ä¸ªéšæœºæ•°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½æ˜¯ä¸€æ ·çš„ã€‚

**æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æœ‰äº†è¿™ä¸‰ä¸ªéšæœºæ•°ï¼ˆClient Randomã€Server Randomã€pre-master keyï¼‰ï¼Œæ¥ç€å°±ç”¨åŒæ–¹åå•†çš„åŠ å¯†ç®—æ³•ï¼Œå„è‡ªç”Ÿæˆæœ¬æ¬¡é€šä¿¡çš„ã€Œä¼šè¯ç§˜é’¥ã€**ã€‚

*4. æœåŠ¡å™¨çš„æœ€åå›åº”*

æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ç¬¬ä¸‰ä¸ªéšæœºæ•°ï¼ˆ`pre-master key`ï¼‰ä¹‹åï¼Œé€šè¿‡åå•†çš„åŠ å¯†ç®—æ³•ï¼Œè®¡ç®—å‡ºæœ¬æ¬¡é€šä¿¡çš„ã€Œä¼šè¯ç§˜é’¥ã€ã€‚

ç„¶åï¼Œå‘å®¢æˆ·ç«¯å‘é€æœ€åçš„ä¿¡æ¯ï¼š

ï¼ˆ1ï¼‰**åŠ å¯†é€šä¿¡ç®—æ³•æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨ã€Œä¼šè¯ç§˜é’¥ã€åŠ å¯†é€šä¿¡**

ï¼ˆ2ï¼‰æœåŠ¡å™¨æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶æŠŠä¹‹å‰æ‰€æœ‰å†…å®¹çš„å‘ç”Ÿçš„æ•°æ®åšä¸ªæ‘˜è¦ï¼Œç”¨æ¥ä¾›å®¢æˆ·ç«¯æ ¡éªŒ

è‡³æ­¤ï¼Œæ•´ä¸ª TLS çš„æ¡æ‰‹é˜¶æ®µå…¨éƒ¨ç»“æŸã€‚æ¥ä¸‹æ¥ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›å…¥åŠ å¯†é€šä¿¡(æµç¨‹çš„ç¬¬ä¸‰é˜¶æ®µ)ï¼Œå°±å®Œå…¨æ˜¯ä½¿ç”¨æ™®é€šçš„ HTTP åè®®ï¼Œåªä¸è¿‡ç”¨ã€Œä¼šè¯ç§˜é’¥ã€åŠ å¯†å†…å®¹







### HTTPæ¼”å˜ ğŸ˜¶â€ğŸŒ«ï¸

#### http1.1

`Keep-Alive`:  æ—©æœŸçš„ `HTTP 1.0` æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½è¦æ–°å»ºä¸€æ¬¡ TCP è¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰ï¼Œè€Œä¸”æ˜¯ä¸²è¡Œè¯·æ±‚ï¼Œåšäº†æ— è°“çš„ TCP è¿æ¥å»ºç«‹å’Œæ–­å¼€ï¼Œå¢åŠ äº†é€šä¿¡å¼€é”€,ä¸ºäº†è§£å†³ä¸Šè¿° TCP è¿æ¥é—®é¢˜ï¼Œ**HTTP/1.1** æå‡ºäº†**é•¿è¿æ¥**çš„é€šä¿¡æ–¹å¼ï¼Œä¹Ÿå«`Keep-Alive` ï¼Œè¿™ç§æ–¹å¼çš„å¥½å¤„åœ¨äºå‡å°‘äº† `TCP` è¿æ¥çš„é‡å¤å»ºç«‹å’Œæ–­å¼€æ‰€é€ æˆçš„é¢å¤–å¼€é”€ï¼Œå‡è½»äº†æœåŠ¡å™¨ç«¯çš„è´Ÿè½½

ç®¡é“ä¼ è¾“: åŒæ—¶http1.1æ”¯æŒç®¡é“ä¼ è¾“ï¼šå³åœ¨åŒä¸€ä¸ª TCP è¿æ¥é‡Œé¢ï¼Œå®¢æˆ·ç«¯å¯ä»¥å‘èµ·å¤šä¸ªè¯·æ±‚ï¼Œ**åªè¦ç¬¬ä¸€ä¸ªè¯·æ±‚å‘å‡ºå»äº†ï¼Œä¸å¿…ç­‰å…¶å›æ¥ï¼Œå°±å¯ä»¥å‘ç¬¬äºŒä¸ªè¯·æ±‚å‡ºå»**ï¼Œä½†æ˜¯**æœåŠ¡å™¨å¿…é¡»æŒ‰ç…§æ¥æ”¶è¯·æ±‚çš„é¡ºåºå‘é€å¯¹è¿™äº›ç®¡é“åŒ–è¯·æ±‚çš„å“åº”**ï¼Œå¦‚æœæœåŠ¡ç«¯åœ¨å¤„ç†å‰é¢è¯·æ±‚æ—¶è€—æ—¶æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆåç»­è¯·æ±‚çš„å¤„ç†éƒ½ä¼šè¢«é˜»å¡ä½ï¼Œè¿™ç§°ä¸ºå“åº”ç«¯çš„é˜Ÿå¤´å µå¡ã€‚æ‰€ä»¥ **HTTP/1.1** ç®¡é“**è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ï¼ˆAè¯·æ±‚å‘å‡ºåå°±å¯æ¥ç€å‘é€Bã€Cè¯·æ±‚ï¼‰**ï¼Œä½†æ˜¯**æ²¡æœ‰è§£å†³å“åº”çš„é˜Ÿå¤´é˜»å¡**( HTTP/1.1 ç®¡é“åŒ–æŠ€æœ¯ä¸æ˜¯é»˜è®¤å¼€å¯ï¼Œè€Œä¸”æµè§ˆå™¨åŸºæœ¬éƒ½æ²¡æœ‰æ”¯æŒ)



#### http2

1 å®‰å…¨æ€§ï¼š`HTTP/2` åè®®æ˜¯åŸºäº **HTTPS** çš„ï¼Œæ‰€ä»¥ `HTTP/2` çš„å®‰å…¨æ€§æœ‰äº†ä¿éšœ

2 å‹ç¼©å¤´éƒ¨ï¼š HTTP/2 ä¼š**å‹ç¼©å¤´**ï¼ˆHeaderï¼‰å¦‚æœåŒæ—¶å‘å‡ºå¤šä¸ªè¯·æ±‚ï¼Œä»–ä»¬çš„å¤´æ˜¯ä¸€æ ·çš„æˆ–æ˜¯ç›¸ä¼¼çš„ï¼Œé‚£ä¹ˆåè®®ä¼šå¸®ä½ **æ¶ˆé™¤é‡å¤çš„éƒ¨åˆ†**

3 äºŒè¿›åˆ¶æ ¼å¼ï¼š HTTP/2 ä¸å†åƒ HTTP/1.1 é‡Œçš„çº¯æ–‡æœ¬å½¢å¼çš„æŠ¥æ–‡ï¼Œè€Œæ˜¯**å…¨é¢é‡‡ç”¨äº†äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¤´ä¿¡æ¯å’Œæ•°æ®ä½“éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œå¹¶ä¸”ç»Ÿç§°ä¸ºå¸§**

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E7%BD%91%E7%BB%9C/http2/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%B8%A7.png" alt="HTTP/1 ä¸ HTTP/2 " style="zoom:50%;" />



4 å¹¶å‘ä¼ è¾“`Stream`: 

HTTP/1.1 çš„å®ç°æ˜¯åŸºäºè¯·æ±‚-å“åº”æ¨¡å‹çš„ã€‚**åŒä¸€ä¸ªè¿æ¥ä¸­ï¼ŒHTTP å®Œæˆä¸€ä¸ªäº‹åŠ¡ï¼ˆè¯·æ±‚ä¸å“åº”ï¼‰ï¼Œæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªäº‹åŠ¡**ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å‘å‡ºè¯·æ±‚ç­‰å¾…å“åº”çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯æ²¡åŠæ³•åšå…¶ä»–äº‹æƒ…çš„ï¼Œå¦‚æœå“åº”è¿Ÿè¿Ÿä¸æ¥ï¼Œé‚£ä¹ˆåç»­çš„è¯·æ±‚æ˜¯æ— æ³•å‘é€çš„(é»˜è®¤æ²¡æœ‰å¼€å¯ç®¡é“ä¼ è¾“)ï¼Œä¹Ÿé€ æˆäº†**é˜Ÿå¤´é˜»å¡**çš„é—®é¢˜

**é’ˆå¯¹ä¸åŒçš„ HTTP è¯·æ±‚ç”¨ç‹¬ä¸€æ— äºŒçš„ Stream ID æ¥åŒºåˆ†ï¼Œæ¥æ”¶ç«¯å¯ä»¥é€šè¿‡ Stream ID æœ‰åºç»„è£…æˆ HTTP æ¶ˆæ¯ï¼Œä¸åŒ Stream çš„å¸§æ˜¯å¯ä»¥ä¹±åºå‘é€çš„ï¼Œå› æ­¤å¯ä»¥å¹¶å‘ä¸åŒçš„ Stream(Stream é‡Œå¯ä»¥åŒ…å« 1 ä¸ªæˆ–å¤šä¸ª Messageï¼ŒMessage å¯¹åº” HTTP/1 ä¸­çš„è¯·æ±‚æˆ–å“åº”) ï¼Œä¹Ÿå°±æ˜¯ HTTP/2 å¯ä»¥å¹¶è¡Œäº¤é”™åœ°å‘é€è¯·æ±‚å’Œå“åº”**,å®¢æˆ·ç«¯/æœåŠ¡ç«¯åœ¨æ”¶åˆ°Streamåæ ¹æ®ç›¸åŒçš„`StreamID`æœ‰åºç»„è£…æˆå®Œæ•´çš„HTTPæ¶ˆæ¯ã€‚ æ¯”å¦‚ä¸‹å›¾ï¼ŒæœåŠ¡ç«¯**å¹¶è¡Œäº¤é”™åœ°**å‘é€äº†ä¸¤ä¸ªå“åº”ï¼š Stream 1 å’Œ Stream 3ï¼Œè¿™ä¸¤ä¸ª Stream éƒ½æ˜¯è·‘åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸Šï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åï¼Œä¼šæ ¹æ®ç›¸åŒçš„ Stream ID æœ‰åºç»„è£…æˆ HTTP æ¶ˆæ¯

![HTTP2](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/http2%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.webp)



>  æ¯”å¦‚`Server`æ”¶åˆ°äº†å¤šä¸ª`stream 1`å¸§ï¼Œä¼šå°†æ‰€æœ‰IDç›¸åŒçš„å¸§ç»„è£…æˆä¸€ä¸ª`HTTP`æ¶ˆæ¯



5 æœåŠ¡å™¨ä¸»åŠ¨æ¨é€ï¼šHTTP/2ä¸­æœåŠ¡ç«¯ä¸å†æ˜¯è¢«åŠ¨åœ°å“åº”ï¼Œå¯ä»¥**ä¸»åŠ¨**å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨**åŒæ–¹éƒ½å¯ä»¥å»ºç«‹ `Stream`**ï¼Œ`Stream ID` ä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼Œå®¢æˆ·ç«¯å»ºç«‹çš„ `Stream ID` å¿…é¡»æ˜¯å¥‡æ•°å·ï¼Œè€ŒæœåŠ¡å™¨å»ºç«‹çš„ `Stream ID` å¿…é¡»æ˜¯å¶æ•°å·







**é—®é¢˜æ‰€åœ¨**ï¼š

`HTTP/2` é€šè¿‡ `Stream` çš„å¹¶å‘èƒ½åŠ›ï¼Œè§£å†³äº† `HTTP/1` é˜Ÿå¤´é˜»å¡(è¯·æ±‚ç«¯+å“åº”ç«¯)çš„é—®é¢˜ï¼Œçœ‹ä¼¼å¾ˆå®Œç¾äº†ï¼Œä½†æ˜¯ HTTP/2 è¿˜æ˜¯å­˜åœ¨â€œé˜Ÿå¤´é˜»å¡â€çš„é—®é¢˜ï¼Œåªä¸è¿‡é—®é¢˜ä¸æ˜¯åœ¨ HTTP è¿™ä¸€å±‚é¢ï¼Œ**è€Œæ˜¯åœ¨ `TCP` è¿™ä¸€å±‚**ï¼š

ä¾‹å¦‚å‘é€æ–¹å‘é€äº†å¾ˆå¤šä¸ª packetï¼ˆ1-6ï¼‰ï¼Œæ¯ä¸ª packet éƒ½æœ‰è‡ªå·±çš„åºå·ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ TCP çš„åºåˆ—å·ï¼Œå…¶ä¸­ packet 3 åœ¨ç½‘ç»œä¸­ä¸¢å¤±äº†ï¼Œå³ä½¿ packet 4-6 è¢«æ¥æ”¶æ–¹æ”¶åˆ°åï¼Œç”±äºå†…æ ¸ä¸­çš„ TCP æ•°æ®ä¸æ˜¯è¿ç»­çš„ï¼Œäºæ˜¯æ¥æ”¶æ–¹çš„åº”ç”¨å±‚å°±æ— æ³•ä»å†…æ ¸ä¸­è¯»å–åˆ°**ï¼Œåªæœ‰ç­‰åˆ° packet 3 é‡ä¼ åï¼Œæ¥æ”¶æ–¹çš„åº”ç”¨å±‚æ‰å¯ä»¥ä»å†…æ ¸ä¸­è¯»å–åˆ°æ•°æ®ï¼Œè¿™å°±æ˜¯ HTTP/2 çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼Œæ˜¯åœ¨ TCP å±‚é¢å‘ç”Ÿçš„**ã€‚å³ä¸€æ—¦å‘ç”Ÿäº†ä¸¢åŒ…ç°è±¡ï¼Œå°±ä¼š**è§¦å‘ TCP çš„é‡ä¼ æœºåˆ¶**ï¼Œè¿™æ ·åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸­çš„**æ‰€æœ‰çš„ HTTP è¯·æ±‚éƒ½å¿…é¡»ç­‰å¾…è¿™ä¸ªä¸¢äº†çš„åŒ…è¢«é‡ä¼ å›æ¥**





#### http3(å¿…çœ‹ğŸ‘€)



HTTP/1.1 å’Œ HTTP/2 éƒ½æœ‰é˜Ÿå¤´é˜»å¡çš„é—®é¢˜ï¼š

- HTTP/1.1 ä¸­çš„ç®¡é“ï¼ˆ pipelineï¼‰è™½ç„¶è§£å†³äº†è¯·æ±‚çš„é˜Ÿå¤´é˜»å¡ï¼Œä½†æ˜¯**æ²¡æœ‰è§£å†³å“åº”çš„é˜Ÿå¤´é˜»å¡**ï¼Œå› ä¸ºæœåŠ¡ç«¯éœ€è¦æŒ‰é¡ºåºå“åº”æ”¶åˆ°çš„è¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯å¤„ç†æŸä¸ªè¯·æ±‚æ¶ˆè€—çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œé‚£ä¹ˆåªèƒ½ç­‰å“åº”å®Œè¿™ä¸ªè¯·æ±‚åï¼Œ æ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™å±äº HTTP å±‚é˜Ÿå¤´é˜»å¡
- HTTP/2 è™½ç„¶é€šè¿‡å¤šä¸ªè¯·æ±‚å¤ç”¨ä¸€ä¸ª TCP è¿æ¥è§£å†³äº† HTTP çš„é˜Ÿå¤´é˜»å¡ ï¼Œä½†æ˜¯**ä¸€æ—¦å‘ç”Ÿä¸¢åŒ…ï¼Œå°±ä¼šé˜»å¡ä½æ‰€æœ‰çš„ HTTP è¯·æ±‚**ï¼Œè¿™å±äº TCP å±‚é˜Ÿå¤´é˜»å¡





HTTP/2 é˜Ÿå¤´é˜»å¡çš„é—®é¢˜æ˜¯å› ä¸º TCPï¼Œæ‰€ä»¥ **HTTP/3 æŠŠ HTTP ä¸‹å±‚çš„ TCP åè®®æ”¹æˆäº† UDPï¼**

`UDP`å‘é€æ˜¯ä¸ç®¡é¡ºåºï¼Œä¹Ÿä¸ç®¡ä¸¢åŒ…çš„ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°åƒ HTTP/2 é˜Ÿå¤´é˜»å¡çš„é—®é¢˜,ä¸”åŸºäº UDP çš„ **`QUIC` åè®®** å¯ä»¥å®ç°ç±»ä¼¼ TCP çš„å¯é æ€§ä¼ è¾“ï¼





> **æ²¡æœ‰é˜Ÿå¤´é˜»å¡çš„ QUIC**

QUIC ä¹Ÿå€Ÿé‰´ HTTP/2 é‡Œçš„ Stream çš„æ¦‚å¿µï¼Œåœ¨ä¸€æ¡ QUIC è¿æ¥ä¸Šå¯ä»¥å¹¶å‘å‘é€å¤šä¸ª HTTP è¯·æ±‚ (Stream)ã€‚

ä½†æ˜¯ **QUIC ç»™æ¯ä¸€ä¸ª Stream éƒ½åˆ†é…äº†ä¸€ä¸ªç‹¬ç«‹çš„æ»‘åŠ¨çª—å£ï¼Œè¿™æ ·ä½¿å¾—ä¸€ä¸ªè¿æ¥ä¸Šçš„å¤šä¸ª Stream ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œéƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå„è‡ªæ§åˆ¶çš„æ»‘åŠ¨çª—å£**ã€‚

å‡å¦‚ Stream2 ä¸¢äº†ä¸€ä¸ª UDP åŒ…ï¼Œä¹Ÿåªä¼šå½±å“ Stream2 çš„å¤„ç†ï¼Œä¸ä¼šå½±å“å…¶ä»– Streamï¼Œä¸ HTTP/2 ä¸åŒï¼ŒHTTP/2 åªè¦æŸä¸ªæµä¸­çš„æ•°æ®åŒ…ä¸¢å¤±äº†ï¼Œå…¶ä»–æµä¹Ÿä¼šå› æ­¤å—å½±å“(å› ä¸ºè¿™äº›streamæ˜¯è·‘åœ¨ä¸€ä¸ªtcpè¿æ¥ä¸Šçš„)

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/network/quic/quic%E6%97%A0%E9%98%BB%E5%A1%9E.jpeg)





**`QUIC`åè®®**(ä½äºä¼ è¾“å±‚ï¼ï¼ï¼)æœ‰ä»¥ä¸‹ 3 ä¸ªç‰¹ç‚¹ï¼š

- æ— é˜Ÿå¤´é˜»å¡ 

- æ›´å¿«çš„è¿æ¥å»ºç«‹
- è¿æ¥è¿ç§»







(1) `QUIC` åè®®ä¹Ÿæœ‰ç±»ä¼¼ HTTP/2 `Stream` ä¸å¤šè·¯å¤ç”¨çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯å¯ä»¥åœ¨åŒä¸€æ¡è¿æ¥ä¸Šå¹¶å‘ä¼ è¾“å¤šä¸ª `Stream`ï¼Œ`Stream` å¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€æ¡ HTTP è¯·æ±‚ï¼ŒåŒæ—¶ QUIC æœ‰è‡ªå·±çš„ä¸€å¥—æœºåˆ¶å¯ä»¥ä¿è¯ä¼ è¾“çš„å¯é æ€§ï¼Œ**å½“æŸä¸ªæµå‘ç”Ÿä¸¢åŒ…æ—¶ï¼Œåªä¼šé˜»å¡è¿™ä¸ªæµï¼Œå…¶ä»–æµä¸ä¼šå—åˆ°å½±å“ï¼Œå› æ­¤ä¸å­˜åœ¨é˜Ÿå¤´é˜»å¡é—®é¢˜**ï¼Œè¿™ä¸ HTTP/2 ä¸åŒï¼Œ**HTTP/2 åªè¦æŸä¸ªæµä¸­çš„æ•°æ®åŒ…ä¸¢å¤±äº†ï¼Œå…¶ä»–æµä¹Ÿä¼šå› æ­¤å—å½±å“(å› ä¸ºæ¶‰åŠåˆ°TCPçš„ACKé‡ä¼ æœºåˆ¶)**





(2) å¯¹äº HTTP/1 å’Œ HTTP/2 åè®®ï¼Œ`TCP` å’Œ `TLS` æ˜¯åˆ†å±‚çš„ï¼Œåˆ†åˆ«å±äºå†…æ ¸å®ç°çš„ä¼ è¾“å±‚ã€`openssl` åº“å®ç°çš„è¡¨ç¤ºå±‚ï¼Œå› æ­¤å®ƒä»¬éš¾ä»¥åˆå¹¶åœ¨ä¸€èµ·ï¼Œéœ€è¦åˆ†æ‰¹æ¬¡æ¥æ¡æ‰‹ï¼Œå…ˆ TCP æ¡æ‰‹ï¼Œå† TLS æ¡æ‰‹; è€Œ`HTTP/3` åœ¨ä¼ è¾“æ•°æ®å‰è™½ç„¶éœ€è¦ `QUIC` åè®®æ¡æ‰‹ï¼Œä½†æ˜¯è¿™ä¸ªæ¡æ‰‹è¿‡ç¨‹åªéœ€è¦ 1 RTT( **HTTP/3 çš„ QUIC åè®®å¹¶ä¸æ˜¯ä¸ TLS åˆ†å±‚ï¼Œè€Œæ˜¯ QUIC å†…éƒ¨åŒ…å«äº† TLS**)ï¼Œæ¡æ‰‹çš„ç›®çš„æ˜¯ä¸ºç¡®è®¤åŒæ–¹çš„ã€Œè¿æ¥ IDã€ï¼Œ**è¿æ¥è¿ç§»å°±æ˜¯åŸºäºè¿æ¥ ID å®ç°**





(3) åŸºäº TCP ä¼ è¾“åè®®çš„ HTTP åè®®ï¼Œæ˜¯é€šè¿‡å››å…ƒç»„ï¼ˆæº IPã€æºç«¯å£ã€ç›®çš„ IPã€ç›®çš„ç«¯å£ï¼‰ç¡®å®šä¸€æ¡ `TCP` è¿æ¥,**å½“ç§»åŠ¨è®¾å¤‡çš„ç½‘ç»œä» 4G åˆ‡æ¢åˆ° WIFI æ—¶ï¼Œæ„å‘³ç€ IP åœ°å€å˜åŒ–äº†ï¼Œé‚£ä¹ˆå°±å¿…é¡»è¦æ–­å¼€è¿æ¥ï¼Œç„¶åé‡æ–°å»ºç«‹è¿æ¥**ã€‚è€Œå»ºç«‹è¿æ¥çš„è¿‡ç¨‹åŒ…å« TCP ä¸‰æ¬¡æ¡æ‰‹å’Œ TLS å››æ¬¡æ¡æ‰‹çš„æ—¶å»¶ï¼Œä»¥åŠ TCP æ…¢å¯åŠ¨çš„å‡é€Ÿè¿‡ç¨‹ï¼Œç»™ç”¨æˆ·çš„æ„Ÿè§‰å°±æ˜¯ç½‘ç»œçªç„¶å¡é¡¿äº†ä¸€ä¸‹;è€Œ `QUIC` åè®®æ˜¯é€šè¿‡**è¿æ¥ ID** æ¥æ ‡è®°é€šä¿¡çš„ä¸¤ä¸ªç«¯ç‚¹ï¼Œ**å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥å„è‡ªé€‰æ‹©ä¸€ç»„ ID æ¥æ ‡è®°è‡ªå·±ï¼Œå› æ­¤å³ä½¿ç§»åŠ¨è®¾å¤‡çš„IPåœ°å€å˜åŒ–äº†ï¼Œåªè¦ä»ä¿æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆæ¯”å¦‚è¿æ¥ IDã€TLS å¯†é’¥ç­‰ï¼‰ï¼Œå°±å¯ä»¥æ— ç¼å¤ç”¨åŸè¿æ¥ï¼Œæ¶ˆé™¤é‡è¿çš„æˆæœ¬**







### HTTPä¸RPCå¯¹æ¯”

é¦–å…ˆè¦çŸ¥é“ TCP æœ‰ä¸‰ä¸ªç‰¹ç‚¹ï¼Œé¢å‘è¿æ¥ã€å¯é ã€åŸºäº**å­—èŠ‚æµ(æ— è¾¹ç•Œ)**ï¼Œè€Œå­—èŠ‚æµå°±æ˜¯01ä¸²ï¼Œæ— æ³•åŒºåˆ†ä¸€æ¡æ¶ˆæ¯çš„è¾¹ç•Œï¼Œå› æ­¤éœ€è¦åŠ å…¥ä¸€äº›è‡ªå®šä¹‰è§„åˆ™ï¼ŒæŠŠæ¯æ¡è¦å‘é€çš„æ•°æ®éƒ½åŒ…è£…ä¸€ä¸‹ï¼Œæ¯”å¦‚åŠ å…¥**æ¶ˆæ¯å¤´**ï¼Œ**æ¶ˆæ¯å¤´é‡Œå†™æ¸…æ¥šä¸€ä¸ªå®Œæ•´çš„åŒ…é•¿åº¦æ˜¯å¤šå°‘**ï¼Œæ ¹æ®è¿™ä¸ªé•¿åº¦å¯ä»¥ç»§ç»­æ¥æ”¶æ•°æ®ï¼Œæˆªå–å‡ºæ¥åå®ƒä»¬å°±æ˜¯æˆ‘ä»¬çœŸæ­£è¦ä¼ è¾“çš„**æ¶ˆæ¯ä½“**ï¼ŒåŸºäº TCP é€ å‡ºæ¥çš„ `HTTP` å’Œ**å„ç±»** `RPC` åè®®ï¼Œå®ƒä»¬éƒ½åªæ˜¯å®šä¹‰äº†ä¸åŒæ¶ˆæ¯æ ¼å¼çš„**åº”ç”¨å±‚åè®®**

æ—©æœŸç”µè„‘ä¸Šå„ç§è”ç½‘è½¯ä»¶ä½œä¸º**å®¢æˆ·ç«¯ï¼ˆClientï¼‰éœ€è¦è·ŸæœåŠ¡ç«¯ï¼ˆServerï¼‰å»ºç«‹è¿æ¥æ”¶å‘æ¶ˆæ¯**ï¼Œåœ¨è¿™ç§C/Sæ¶æ„ä¸‹ï¼Œä½¿ç”¨è‡ªå®¶é€ çš„ `RPC` åè®®å°±å¤Ÿäº†ï¼›è€Œ**æµè§ˆå™¨ï¼ˆBrowserï¼‰**ä¸ä»…è¦èƒ½è®¿é—®è‡ªå®¶å…¬å¸çš„**æœåŠ¡å™¨ï¼ˆServerï¼‰**ï¼Œè¿˜éœ€è¦è®¿é—®å…¶ä»–å…¬å¸çš„ç½‘ç«™æœåŠ¡å™¨ï¼Œå› æ­¤å®ƒä»¬éœ€è¦æœ‰ä¸ªç»Ÿä¸€çš„æ ‡å‡†ï¼ŒHTTP å°±æ˜¯é‚£ä¸ªæ—¶ä»£ç”¨äºç»Ÿä¸€ **(B/S)** çš„åè®® ï¼Œä¸‹é¢æ¥æ€»ç»“ä¸€ä¸‹ä¸¤è€…çš„ä¸»è¦åŒºåˆ«ï¼š

#### æœåŠ¡å‘ç°

è¦å‘æŸä¸ªæœåŠ¡å‘èµ·è¯·æ±‚ï¼Œè¦å…ˆå»ºç«‹è¿æ¥ï¼Œè¿™æ ·å°±å¿…é¡»ç¡®å®šå¯¹æ–¹çš„ **IPåœ°å€å’Œç«¯å£**ï¼Œæ‰¾åˆ°æœåŠ¡å¯¹åº”çš„IPç«¯å£çš„è¿‡ç¨‹ï¼Œå°±æ˜¯**æœåŠ¡å‘ç°ï¼Œ**åœ¨ **HTTP** ä¸­ï¼ŒçŸ¥é“æœåŠ¡çš„åŸŸåï¼Œå°±å¯ä»¥é€šè¿‡ **DNS **å»è§£æå¾—åˆ°èƒŒåçš„ IP åœ°å€ï¼Œ è€Œ **RPC** ä¸€èˆ¬ä¼šæœ‰ä¸“é—¨çš„**æœåŠ¡æ³¨å†Œä¸­å¿ƒ**å»ä¿å­˜æœåŠ¡åå’ŒIPä¿¡æ¯ï¼Œæ¯”å¦‚`Nacos`ã€`Zookeeper`ã€**`Consul`** ,å¦‚æœæƒ³è¦è®¿é—®æŸä¸ªæœåŠ¡ï¼Œæ¶ˆè´¹è€…é¦–å…ˆéœ€è¦å»æ³¨å†Œä¸­å¿ƒè·å–åˆ°æœåŠ¡çš„IP å’Œç«¯å£ä¿¡æ¯

#### åº•å±‚è¿æ¥å½¢å¼

ä¸»æµçš„ **HTTP/1.1** åè®®ä¸ºä¾‹ï¼Œé»˜è®¤åœ¨å»ºç«‹åº•å±‚ TCP è¿æ¥ä¹‹åä¼šä¸€ç›´ä¿æŒè¿™ä¸ªè¿æ¥ï¼ˆ**Keep Alive**ï¼‰ï¼Œä¹‹åçš„è¯·æ±‚å’Œå“åº”éƒ½ä¼šå¤ç”¨è¿™æ¡è¿æ¥ï¼Œè€Œ **RPC** åè®®è·Ÿ HTTP ç±»ä¼¼ï¼Œä¹Ÿé€šè¿‡å»ºç«‹ TCP é•¿è¿æ¥è¿›è¡Œæ•°æ®äº¤äº’ï¼Œä½†ä¸åŒçš„åœ°æ–¹åœ¨äºRPC åè®®ä¸€èˆ¬è¿˜ä¼šå†å»ºä¸ª**è¿æ¥æ± **ï¼Œåœ¨è¯·æ±‚é‡å¤§çš„æ—¶å€™ï¼Œå»ºç«‹å¤šæ¡è¿æ¥æ”¾åœ¨æ± å†…ï¼Œè¦å‘æ•°æ®çš„æ—¶å€™å°±ä»æ± é‡Œå–ä¸€æ¡è¿æ¥å‡ºæ¥ï¼Œ**ç”¨å®Œæ”¾å›å»ï¼Œä¸‹æ¬¡å†å¤ç”¨**



#### ä¼ è¾“å†…å®¹

åŸºäº TCP ä¼ è¾“çš„æ¶ˆæ¯å°±æ˜¯ **æ¶ˆæ¯å¤´ Header +æ¶ˆæ¯ä½“ Body**

**Header** æ˜¯ç”¨äºæ ‡è®°ä¸€äº›ç‰¹æ®Šä¿¡æ¯ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯**æ¶ˆæ¯ä½“é•¿åº¦**

**Body** åˆ™æ˜¯æ”¾æˆ‘ä»¬çœŸæ­£éœ€è¦ä¼ è¾“çš„å†…å®¹ï¼Œè€Œè¿™äº›å†…å®¹åªèƒ½æ˜¯äºŒè¿›åˆ¶ 01 ä¸²ï¼Œæ‰€ä»¥ TCP ä¼ å­—ç¬¦ä¸²å’Œæ•°å­—éƒ½å¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºå­—ç¬¦ä¸²å¯ä»¥è½¬æˆç¼–ç å†å˜æˆ 01 ä¸²ï¼Œè€Œæ•°å­—æœ¬èº«ä¹Ÿèƒ½ç›´æ¥è½¬ä¸ºäºŒè¿›åˆ¶ã€‚ä½†ç»“æ„ä½“/å¯¹è±¡å‘¢ï¼Œéœ€è¦å°†å®ƒä»¬è½¬ä¸ºäºŒè¿›åˆ¶ 01 ä¸²(åºåˆ—åŒ–)ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨`Json`ã€`Protobuf`ã€`Hessian`ã€`Kryo`ç­‰åºåˆ—åŒ–æ–¹æ³•

ä¸»æµçš„ HTTP/1.1ï¼Œä¼ çš„å†…å®¹ä»¥å­—ç¬¦ä¸²ä¸ºä¸»(Header å’Œ Body éƒ½æ˜¯å¦‚æ­¤),åœ¨ Body è¿™å—ï¼Œå®ƒä½¿ç”¨ **Json** æ¥**åºåˆ—åŒ–**ç»“æ„ä½“æ•°æ®ï¼Œè€Œ RPCå› ä¸ºå®ƒå®šåˆ¶åŒ–ç¨‹åº¦æ›´é«˜ï¼Œå¯ä»¥é‡‡ç”¨ä½“ç§¯æ›´å°çš„ `Protobuf` æˆ–å…¶ä»–åºåˆ—åŒ–åè®®å»ä¿å­˜ç»“æ„ä½“/å¯¹è±¡æ•°æ®ï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦åƒ HTTP é‚£æ ·è€ƒè™‘å„ç§æµè§ˆå™¨è¡Œä¸ºï¼Œæ¯”å¦‚ `302` é‡å®šå‘è·³è½¬ç­‰

HTTP/2 åœ¨å‰è€…çš„åŸºç¡€ä¸Šåšäº†å¾ˆå¤šæ”¹è¿›(å¤´ä¿¡æ¯å’Œæ•°æ®ä½“éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œå¹¶ä¸”ç»Ÿç§°ä¸ºå¸§ï¼ˆframeï¼‰)ï¼Œæ‰€ä»¥**æ€§èƒ½å¯èƒ½æ¯”å¾ˆå¤š RPC åè®®è¿˜è¦å¥½**ï¼Œç”šè‡³è¿ `gRPC` åº•å±‚éƒ½ç›´æ¥ç”¨çš„ `HTTP/2`



**æ€»ç»“**ï¼š

-  çº¯è£¸ TCP æ˜¯èƒ½æ”¶å‘æ•°æ®ï¼Œä½†å®ƒæ˜¯ä¸ª**æ— è¾¹ç•Œ**çš„æ•°æ®æµï¼Œä¸Šå±‚éœ€è¦å®šä¹‰**æ¶ˆæ¯æ ¼å¼**ç”¨äºå®šä¹‰**æ¶ˆæ¯è¾¹ç•Œ**ã€‚äºæ˜¯å°±æœ‰äº†å„ç§åè®®ï¼ŒHTTP å’Œå„ç±» RPC åè®®å°±æ˜¯åœ¨ TCP ä¹‹ä¸Šå®šä¹‰çš„åº”ç”¨å±‚åè®®
- RPC æœ¬è´¨ä¸Šä¸ç®—æ˜¯åè®®ï¼Œè€Œæ˜¯ä¸€ç§è°ƒç”¨æ–¹å¼**ï¼Œè€Œåƒ gRPC å’Œ Thrift è¿™æ ·çš„å…·ä½“å®ç°ï¼Œæ‰æ˜¯åè®®ï¼Œå®ƒä»¬æ˜¯å®ç°äº† RPC è°ƒç”¨çš„åè®®ã€‚ç›®çš„æ˜¯å¸Œæœ›ç¨‹åºå‘˜èƒ½åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•é‚£æ ·å»è°ƒç”¨è¿œç«¯çš„æœåŠ¡æ–¹æ³•ã€‚åŒæ—¶ RPC æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œ**ä¸ä¸€å®šåŸºäº TCP åè®®
- **HTTP ä¸»è¦ç”¨äº B/S æ¶æ„ï¼Œè€Œ RPC æ›´å¤šç”¨äº C/S æ¶æ„ã€‚ä½†ç°åœ¨ï¼ŒB/S å’Œ C/S åœ¨æ…¢æ…¢èåˆ**ï¼Œå¾ˆå¤šè½¯ä»¶åŒæ—¶æ”¯æŒå¤šç«¯ï¼Œæ‰€ä»¥å¯¹å¤–ä¸€èˆ¬ç”¨ HTTP åè®®ï¼Œè€Œ**å†…éƒ¨é›†ç¾¤çš„å¾®æœåŠ¡ä¹‹é—´åˆ™é‡‡ç”¨ RPC åè®®è¿›è¡Œé€šè®¯**



### HTTPçŠ¶æ€ç  :ear:

 ![ äº”å¤§ç±» HTTP çŠ¶æ€ç  ](https://cdn.jsdelivr.net/gh/amonstercat/PicGo@master/202403081513864.png)

`1xx` ç±»çŠ¶æ€ç å±äº**æç¤ºä¿¡æ¯**ï¼Œæ˜¯åè®®å¤„ç†ä¸­çš„ä¸€ç§ä¸­é—´çŠ¶æ€ï¼Œå®é™…ç”¨åˆ°çš„æ¯”è¾ƒå°‘ã€‚

`2xx` ç±»çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡å™¨**æˆåŠŸ**å¤„ç†äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æœ€æ„¿æ„çœ‹åˆ°çš„çŠ¶æ€ã€‚

- ã€Œ**200 OK**ã€æ˜¯æœ€å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œè¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ã€‚å¦‚æœæ˜¯é `HEAD` è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”å¤´éƒ½ä¼šæœ‰ body æ•°æ®ã€‚
- ã€Œ**204 No Content**ã€ä¹Ÿæ˜¯å¸¸è§çš„æˆåŠŸçŠ¶æ€ç ï¼Œä¸ 200 OK åŸºæœ¬ç›¸åŒï¼Œä½†å“åº”å¤´æ²¡æœ‰ body æ•°æ®ã€‚
- ã€Œ**206 Partial Content**ã€æ˜¯åº”ç”¨äº HTTP åˆ†å—ä¸‹è½½æˆ–æ–­ç‚¹ç»­ä¼ ï¼Œè¡¨ç¤ºå“åº”è¿”å›çš„ body æ•°æ®å¹¶ä¸æ˜¯èµ„æºçš„å…¨éƒ¨ï¼Œè€Œæ˜¯å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœåŠ¡å™¨å¤„ç†æˆåŠŸçš„çŠ¶æ€ã€‚

`3xx` ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„èµ„æºå‘ç”Ÿäº†å˜åŠ¨ï¼Œéœ€è¦å®¢æˆ·ç«¯ç”¨æ–°çš„ URL é‡æ–°å‘é€è¯·æ±‚è·å–èµ„æºï¼Œä¹Ÿå°±æ˜¯**é‡å®šå‘**ã€‚

- ã€Œ**301 Moved Permanently**ã€è¡¨ç¤ºæ°¸ä¹…é‡å®šå‘ï¼Œè¯´æ˜è¯·æ±‚çš„èµ„æºå·²ç»ä¸å­˜åœ¨äº†ï¼Œéœ€æ”¹ç”¨æ–°çš„ URL å†æ¬¡è®¿é—®ã€‚
- ã€Œ**302 Found**ã€è¡¨ç¤ºä¸´æ—¶é‡å®šå‘ï¼Œè¯´æ˜è¯·æ±‚çš„èµ„æºè¿˜åœ¨ï¼Œä½†æš‚æ—¶éœ€è¦ç”¨å¦ä¸€ä¸ª URL æ¥è®¿é—®ã€‚

301 å’Œ 302 éƒ½ä¼šåœ¨å“åº”å¤´é‡Œä½¿ç”¨å­—æ®µ `Location`ï¼ŒæŒ‡æ˜åç»­è¦è·³è½¬çš„ URLï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨é‡å®šå‘æ–°çš„ URLã€‚

- ã€Œ**304 Not Modified**ã€ä¸å…·æœ‰è·³è½¬çš„å«ä¹‰ï¼Œè¡¨ç¤ºèµ„æºæœªä¿®æ”¹ï¼Œé‡å®šå‘å·²å­˜åœ¨çš„ç¼“å†²æ–‡ä»¶ï¼Œä¹Ÿç§°ç¼“å­˜é‡å®šå‘ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰å®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜èµ„æºï¼Œç”¨äºç¼“å­˜æ§åˆ¶ã€‚

`4xx` ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯å‘é€çš„**æŠ¥æ–‡æœ‰è¯¯**ï¼ŒæœåŠ¡å™¨æ— æ³•å¤„ç†ï¼Œä¹Ÿå°±æ˜¯é”™è¯¯ç çš„å«ä¹‰ã€‚

- ã€Œ**400 Bad Request**ã€è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æŠ¥æ–‡æœ‰é”™è¯¯ï¼Œä½†åªæ˜¯ä¸ªç¬¼ç»Ÿçš„é”™è¯¯ã€‚
- ã€Œ**403 Forbidden**ã€è¡¨ç¤ºæœåŠ¡å™¨ç¦æ­¢è®¿é—®èµ„æºï¼Œå¹¶ä¸æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚å‡ºé”™ã€‚
- ã€Œ**404 Not Found**ã€è¡¨ç¤ºè¯·æ±‚çš„èµ„æºåœ¨æœåŠ¡å™¨ä¸Šä¸å­˜åœ¨æˆ–æœªæ‰¾åˆ°ï¼Œæ‰€ä»¥æ— æ³•æä¾›ç»™å®¢æˆ·ç«¯ã€‚
- ã€Œ**429 Too Many Requests**ã€è¯¥çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯åœ¨ç»™å®šçš„æ—¶é—´å†…å‘é€äº†å¤ªå¤šçš„è¯·æ±‚ï¼Œè¶…å‡ºäº†æœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›æˆ–é™åˆ¶ã€‚æœåŠ¡å™¨ä¼šé€šè¿‡è¿™ä¸ªçŠ¶æ€ç æ¥å‘ŠçŸ¥å®¢æˆ·ç«¯æš‚æ—¶æ— æ³•å¤„ç†è¯·æ±‚ï¼Œå¹¶å»ºè®®å®¢æˆ·ç«¯åœ¨ç¨åé‡è¯•ã€‚

`5xx` ç±»çŠ¶æ€ç è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡æ­£ç¡®ï¼Œä½†æ˜¯**æœåŠ¡å™¨å¤„ç†æ—¶å†…éƒ¨å‘ç”Ÿäº†é”™è¯¯**ï¼Œå±äºæœåŠ¡å™¨ç«¯çš„é”™è¯¯ç ã€‚

- ã€Œ**500 Internal Server Error**ã€ä¸ 400 ç±»å‹ï¼Œæ˜¯ä¸ªç¬¼ç»Ÿé€šç”¨çš„é”™è¯¯ç ï¼ŒæœåŠ¡å™¨å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“ã€‚
- ã€Œ**501 Not Implemented**ã€è¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„åŠŸèƒ½è¿˜ä¸æ”¯æŒï¼Œç±»ä¼¼â€œå³å°†å¼€ä¸šï¼Œæ•¬è¯·æœŸå¾…â€çš„æ„æ€ã€‚
- ã€Œ**502 Bad Gateway**ã€é€šå¸¸æ˜¯æœåŠ¡å™¨ä½œä¸ºç½‘å…³æˆ–ä»£ç†æ—¶è¿”å›çš„é”™è¯¯ç ï¼Œè¡¨ç¤ºæœåŠ¡å™¨è‡ªèº«å·¥ä½œæ­£å¸¸ï¼Œè®¿é—®åç«¯æœåŠ¡å™¨å‘ç”Ÿäº†é”™è¯¯ã€‚
- ã€Œ**503 Service Unavailable**ã€è¡¨ç¤ºæœåŠ¡å™¨å½“å‰å¾ˆå¿™ï¼Œæš‚æ—¶æ— æ³•å“åº”å®¢æˆ·ç«¯ï¼Œç±»ä¼¼â€œç½‘ç»œæœåŠ¡æ­£å¿™ï¼Œè¯·ç¨åé‡è¯•â€çš„æ„æ€ã€‚



### HTTPç¼“å­˜

https://xiaolincoding.com/network/2_http/http_interview.html#http-%E7%BC%93%E5%AD%98%E6%8A%80%E6%9C%AF

ï¼ˆ1ï¼‰å¼ºåˆ¶ç¼“å­˜

  å¼ºç¼“å­˜æŒ‡çš„æ˜¯åªè¦æµè§ˆå™¨åˆ¤æ–­ç¼“å­˜æ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥ä½¿ç”¨æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜ï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜çš„ä¸»åŠ¨æ€§åœ¨äºæµè§ˆå™¨è¿™è¾¹ã€‚

å¦‚ä¸‹å›¾ä¸­ï¼Œè¿”å›çš„æ˜¯ 200 çŠ¶æ€ç ï¼Œä½†åœ¨ size é¡¹ä¸­æ ‡è¯†çš„æ˜¯ from disk cacheï¼Œå°±æ˜¯ä½¿ç”¨äº†å¼ºåˆ¶ç¼“å­˜ã€‚

![img](https://cdn.jsdelivr.net/gh/amonstercat/PicGo@master/202403081524922.png)

å¼ºç¼“å­˜æ˜¯åˆ©ç”¨ä¸‹é¢è¿™ä¸¤ä¸ª HTTP å“åº”å¤´éƒ¨ï¼ˆResponse Headerï¼‰å­—æ®µå®ç°çš„ï¼Œå®ƒä»¬éƒ½ç”¨æ¥è¡¨ç¤ºèµ„æºåœ¨å®¢æˆ·ç«¯ç¼“å­˜çš„æœ‰æ•ˆæœŸï¼š

- `Cache-Control`ï¼Œ æ˜¯ä¸€ä¸ªç›¸å¯¹æ—¶é—´ï¼›
- `Expires`ï¼Œæ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼›

å¦‚æœ HTTP å“åº”å¤´éƒ¨åŒæ—¶æœ‰ Cache-Control å’Œ Expires å­—æ®µçš„è¯ï¼Œ**Cache-Control çš„ä¼˜å…ˆçº§é«˜äº Expires** ã€‚

Cache-control é€‰é¡¹æ›´å¤šä¸€äº›ï¼Œè®¾ç½®æ›´åŠ ç²¾ç»†ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨ Cache-Control æ¥å®ç°å¼ºç¼“å­˜ã€‚å…·ä½“çš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š

- å½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨ä¼šåœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨ Response å¤´éƒ¨åŠ ä¸Š Cache-Controlï¼ŒCache-Control ä¸­è®¾ç½®äº†è¿‡æœŸæ—¶é—´å¤§å°ï¼›
- æµè§ˆå™¨å†æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨ä¸­çš„è¯¥èµ„æºæ—¶ï¼Œä¼šå…ˆ**é€šè¿‡è¯·æ±‚èµ„æºçš„æ—¶é—´ä¸ Cache-Control ä¸­è®¾ç½®çš„è¿‡æœŸæ—¶é—´å¤§å°ï¼Œæ¥è®¡ç®—å‡ºè¯¥èµ„æºæ˜¯å¦è¿‡æœŸ**ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨è¯¥ç¼“å­˜ï¼Œå¦åˆ™é‡æ–°è¯·æ±‚æœåŠ¡å™¨ï¼›
- æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå†æ¬¡æ›´æ–° Response å¤´éƒ¨çš„ Cache-Controlã€‚



ï¼ˆ2ï¼‰åå•†ç¼“å­˜

æŸäº›è¯·æ±‚çš„å“åº”ç æ˜¯ `304`ï¼Œè¿™ä¸ªæ˜¯å‘Šè¯‰æµè§ˆå™¨å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„èµ„æºï¼Œé€šå¸¸è¿™ç§**é€šè¿‡æœåŠ¡ç«¯å‘ŠçŸ¥å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜**çš„æ–¹å¼è¢«ç§°ä¸ºåå•†ç¼“å­˜ã€‚

å½“ä½¿ç”¨ ETag å­—æ®µå®ç°çš„åå•†ç¼“å­˜çš„è¿‡ç¨‹ï¼š

- å½“æµè§ˆå™¨ç¬¬ä¸€æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨èµ„æºæ—¶ï¼ŒæœåŠ¡å™¨ä¼šåœ¨è¿”å›è¿™ä¸ªèµ„æºçš„åŒæ—¶ï¼Œåœ¨ Response å¤´éƒ¨åŠ ä¸Š ETag å”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ªå”¯ä¸€æ ‡è¯†çš„å€¼æ˜¯æ ¹æ®å½“å‰è¯·æ±‚çš„èµ„æºç”Ÿæˆçš„ï¼›
- å½“æµè§ˆå™¨å†æ¬¡è¯·æ±‚è®¿é—®æœåŠ¡å™¨ä¸­çš„è¯¥èµ„æºæ—¶ï¼Œé¦–å…ˆä¼šå…ˆæ£€æŸ¥å¼ºåˆ¶ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼š
  - å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼›
  - å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œä¼šåœ¨ Request å¤´éƒ¨åŠ ä¸Š If-None-Match å­—æ®µï¼Œè¯¥å­—æ®µçš„å€¼å°±æ˜¯ ETag å”¯ä¸€æ ‡è¯†ï¼›
- æœåŠ¡å™¨å†æ¬¡æ”¶åˆ°è¯·æ±‚åï¼Œä¼šæ ¹æ®è¯·æ±‚ä¸­çš„ If-None-Match å€¼ä¸å½“å‰è¯·æ±‚çš„èµ„æºç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†è¿›è¡Œæ¯”è¾ƒï¼š
  - **å¦‚æœå€¼ç›¸ç­‰ï¼Œåˆ™è¿”å› 304 Not Modifiedï¼Œä¸ä¼šè¿”å›èµ„æº**ï¼›
  - å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› 200 çŠ¶æ€ç å’Œè¿”å›èµ„æºï¼Œå¹¶åœ¨ Response å¤´éƒ¨åŠ ä¸Šæ–°çš„ ETag å”¯ä¸€æ ‡è¯†ï¼›
- å¦‚æœæµè§ˆå™¨æ”¶åˆ° 304 çš„è¯·æ±‚å“åº”çŠ¶æ€ç ï¼Œåˆ™ä¼šä»æœ¬åœ°ç¼“å­˜ä¸­åŠ è½½èµ„æºï¼Œå¦åˆ™æ›´æ–°èµ„æºã€‚



## TCP 

### TCPçš„ç¼ºé™·æœ‰å“ªäº›ï¼Ÿ

ï¼ˆ1ï¼‰å‡çº§ TCP çš„å·¥ä½œå¾ˆå›°éš¾ï¼›

ï¼ˆ2ï¼‰**TCP å»ºç«‹è¿æ¥çš„å»¶è¿Ÿ**ï¼šä¸‰æ¬¡æ¡æ‰‹å»¶è¿Ÿï¼ˆé€šè¿‡fast-openæœºåˆ¶è§£å†³ï¼‰ï¼Œhttpsä¸­å››æ¬¡æ¡æ‰‹å’Œtcpä¸‰æ¬¡æ¡æ‰‹æ— æ³•ç»“åˆåœ¨ä¸€èµ·çš„ï¼Œå› ä¸ºï¼ŒTLS æ˜¯åœ¨åº”ç”¨å±‚å®ç°çš„æ¡æ‰‹ï¼Œè€Œ TCP æ˜¯åœ¨å†…æ ¸å®ç°çš„æ¡æ‰‹ï¼Œä¹Ÿæ­£æ˜¯ TCP æ˜¯åœ¨å†…æ ¸å®ç°çš„ï¼Œæ‰€ä»¥ TLS æ˜¯æ— æ³•å¯¹ TCP å¤´éƒ¨åŠ å¯†çš„ï¼Œè¿™æ„å‘³ç€ TCP çš„åºåˆ—å·éƒ½æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œæ‰€ä»¥å°±å­˜å®‰å…¨çš„é—®é¢˜ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯æ”»å‡»è€…ä¼ªé€ ä¸€ä¸ªçš„ RST æŠ¥æ–‡å¼ºåˆ¶å…³é—­ä¸€æ¡ TCP è¿æ¥ï¼Œè€Œæ”»å‡»æˆåŠŸçš„å…³é”®åˆ™æ˜¯ TCP å­—æ®µé‡Œçš„åºåˆ—å·ä½äºæ¥æ”¶æ–¹çš„æ»‘åŠ¨çª—å£å†…ï¼Œè¯¥æŠ¥æ–‡å°±æ˜¯åˆæ³•çš„ï¼›

ï¼ˆ3ï¼‰TCP å­˜åœ¨é˜Ÿå¤´é˜»å¡é—®é¢˜ï¼š**TCP å±‚å¿…é¡»ä¿è¯æ”¶åˆ°çš„å­—èŠ‚æ•°æ®æ˜¯å®Œæ•´ä¸”æœ‰åºçš„**ï¼Œå¦‚æœåºåˆ—å·è¾ƒä½çš„ TCP æ®µåœ¨ç½‘ç»œä¼ è¾“ä¸­ä¸¢å¤±äº†ï¼Œå³ä½¿åºåˆ—å·è¾ƒé«˜çš„ TCP æ®µå·²ç»è¢«æ¥æ”¶äº†ï¼Œåº”ç”¨å±‚ä¹Ÿæ— æ³•ä»å†…æ ¸ä¸­è¯»å–åˆ°è¿™éƒ¨åˆ†æ•°æ®ã€‚å¦‚ä¸‹å›¾ï¼š

<img src="https://mmbiz.qpic.cn/mmbiz_png/J0g14CUwaZfxxjvoTicwpUmESgBvvjqH5SYu8ia2MhC558SptjRWvg441iadibERibF7gaRia8PcuTWpxSicLwVk8icDiaw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1">

å…¶ä¸­ `packet #3` åœ¨ç½‘ç»œä¸­ä¸¢å¤±äº†ï¼Œå³ä½¿ `packet #4-6` è¢«æ¥æ”¶æ–¹æ”¶åˆ°åï¼Œç”±äºå†…æ ¸ä¸­çš„ TCP æ•°æ®ä¸æ˜¯è¿ç»­çš„ï¼Œäºæ˜¯æ¥æ”¶æ–¹çš„åº”ç”¨å±‚å°±æ— æ³•ä»å†…æ ¸ä¸­è¯»å–åˆ°ï¼Œ**åªæœ‰ç­‰åˆ° `packet #3` é‡ä¼ åï¼Œæ¥æ”¶æ–¹çš„åº”ç”¨å±‚æ‰å¯ä»¥ä»å†…æ ¸ä¸­è¯»å–åˆ°æ•°æ®**ã€‚HTTP/2 å¤šä¸ªè¯·æ±‚æ˜¯è·‘åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸­çš„ï¼Œé‚£ä¹ˆå½“ TCP ä¸¢åŒ…æ—¶ï¼Œæ•´ä¸ª TCP éƒ½è¦ç­‰å¾…é‡ä¼ ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡è¯¥ TCP è¿æ¥ä¸­çš„æ‰€æœ‰è¯·æ±‚ï¼Œæ‰€ä»¥ HTTP/2 é˜Ÿå¤´é˜»å¡é—®é¢˜å°±æ˜¯å› ä¸º TCP åè®®å¯¼è‡´çš„ã€‚è§£å†³åŠæ³•æ˜¯é€šè¿‡QUICåè®®ä¸­çš„Packet+StreamID+Offsetæ¥è¾¨è®¤é‡å‘åŒ…ï¼Œä¸”æ”¯æŒä¹±åºç¡®è®¤æ¥é˜²æ­¢é˜Ÿå¤´é˜»å¡ã€‚

ï¼ˆ4ï¼‰ç½‘ç»œè¿ç§»éœ€è¦é‡æ–°å»ºç«‹ TCP è¿æ¥ï¼š

åŸºäº TCP ä¼ è¾“åè®®çš„ HTTP åè®®ï¼Œç”±äºæ˜¯é€šè¿‡å››å…ƒç»„ï¼ˆæº IPã€æºç«¯å£ã€ç›®çš„ IPã€ç›®çš„ç«¯å£ï¼‰ç¡®å®šä¸€æ¡ TCP è¿æ¥ï¼Œé‚£ä¹ˆ**å½“ç§»åŠ¨è®¾å¤‡çš„ç½‘ç»œä» 4G åˆ‡æ¢åˆ° WIFI æ—¶ï¼Œæ„å‘³ç€ IP åœ°å€å˜åŒ–äº†ï¼Œé‚£ä¹ˆå°±å¿…é¡»è¦æ–­å¼€è¿æ¥ï¼Œç„¶åé‡æ–°å»ºç«‹ TCP è¿æ¥**ã€‚

![å›¾ç‰‡](https://github.com/amonstercat/PicGo/blob/main/dell/202403061754203.png?raw=true)

è€Œå»ºç«‹è¿æ¥çš„è¿‡ç¨‹åŒ…å« TCP ä¸‰æ¬¡æ¡æ‰‹å’Œ TLS å››æ¬¡æ¡æ‰‹çš„æ—¶å»¶ï¼Œä»¥åŠ TCP æ…¢å¯åŠ¨çš„å‡é€Ÿè¿‡ç¨‹ï¼Œç»™ç”¨æˆ·çš„æ„Ÿè§‰å°±æ˜¯ç½‘ç»œçªç„¶å¡é¡¿äº†ä¸€ä¸‹ï¼Œå› æ­¤è¿æ¥çš„è¿ç§»æˆæœ¬æ˜¯å¾ˆé«˜çš„ã€‚

ï¼ˆ5ï¼‰TCPé‡ä¼ å…·æœ‰æ­§ä¹‰æ€§ï¼Œå‘é€é‡å‘åŒ…åæ— æ³•ç²¾ç¡®è®¡ç®—RTTï¼ˆé€šè¿‡QUICåè®®æ¥è§£å†³ï¼‰ã€‚



### TCP Fast Openç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ

TCP Fast Open å¹¶ä¸ç›´æ¥å†²çªäºä¼ ç»Ÿçš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œè€Œæ˜¯åœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œäº†ä¼˜åŒ–ã€‚åœ¨ä¼ ç»Ÿçš„ TCP ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œäº†ä¸‰æ¬¡å¾€è¿”çš„æ¡æ‰‹ï¼Œç”¨äºå»ºç«‹è¿æ¥ã€‚è€Œ **TCP Fast Open å…è®¸åœ¨åˆå§‹çš„ SYN åŒ…ä¸­æºå¸¦æ•°æ®ï¼Œä»è€Œåœ¨å»ºç«‹è¿æ¥çš„åŒæ—¶ä¼ è¾“æ•°æ®ï¼Œä»¥å‡å°‘å»ºç«‹è¿æ¥çš„æ—¶å»¶ã€‚**

å…·ä½“æ¥è¯´ï¼Œåœ¨ TCP Fast Open ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨å‘é€ SYN åŒ…æ—¶æºå¸¦æ•°æ®ï¼Œè¿™æ ·æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ° SYN åŒ…æ—¶å°±å¯ä»¥åŒæ—¶æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå¹¶åœ¨ SYN-ACK åŒ…ä¸­å¯¹è¿™äº›æ•°æ®è¿›è¡Œç¡®è®¤ã€‚å› æ­¤ï¼ŒTCP Fast Open ä»ç„¶éµå¾ªäº† TCP çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œåªæ˜¯åœ¨å»ºç«‹è¿æ¥çš„åŒæ—¶è¿›è¡Œäº†æ•°æ®ä¼ è¾“ã€‚

<img src="https://mmbiz.qpic.cn/mmbiz_png/J0g14CUwaZfxxjvoTicwpUmESgBvvjqH5aRa7S02Zd6b8sX8ibHjRicsMJTfBxQHQiaGpD9yCgdHop8IOC1rlVCrEA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1">

è¿‡ç¨‹å¦‚ä¸‹ï¼š

- åœ¨ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯åœ¨ç¬¬äºŒæ¬¡æ¡æ‰‹äº§ç”Ÿä¸€ä¸ª `Cookie` ï¼ˆå·²åŠ å¯†ï¼‰å¹¶é€šè¿‡ SYNã€ACK åŒ…ä¸€èµ·å‘ç»™å®¢æˆ·ç«¯ï¼Œäºæ˜¯å®¢æˆ·ç«¯å°±ä¼šç¼“å­˜è¿™ä¸ª `Cookie`ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡å‘èµ· HTTP Get è¯·æ±‚çš„æ—¶å€™ï¼ˆç¬¬ä¸‰æ¬¡æ¡æ‰‹å°±å¯ä»¥ç›´æ¥ä¼ è¾“æ•°æ®ï¼‰ï¼Œè¿˜æ˜¯éœ€è¦ 2 ä¸ª RTT çš„æ—¶å»¶ï¼›
- åœ¨ä¸‹æ¬¡è¯·æ±‚çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åœ¨ SYN åŒ…å¸¦ä¸Š `Cookie` å‘ç»™æœåŠ¡ç«¯ï¼Œå°±æå‰å¯ä»¥è·³è¿‡ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œå› ä¸º `Cookie` ä¸­ç»´æŠ¤äº†ä¸€äº›ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯å¯ä»¥ä» `Cookie` è·å– TCP ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™æ—¶å‘èµ·çš„ HTTP GET è¯·æ±‚å°±åªéœ€è¦ 1 ä¸ª RTT çš„æ—¶å»¶ï¼›









### SOCKET(é‡è¦ï¼ï¼)

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP-%E5%8D%8A%E8%BF%9E%E6%8E%A5%E5%92%8C%E5%85%A8%E8%BF%9E%E6%8E%A5/3.jpg" alt="åŠè¿æ¥é˜Ÿåˆ—ä¸å…¨è¿æ¥é˜Ÿåˆ—" style="zoom:50%;" />

å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ˜¯éœ€è¦å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¾¾æˆä¸‹è¿°ä¸‰ä¸ªä¿¡æ¯çš„å…±è¯†

- **Socket**ï¼šç”± IP åœ°å€å’Œç«¯å£å·ç»„æˆ(åœ¨TCP/IPç½‘ç»œä¸­ï¼Œä¸€ä¸ªå¥—æ¥å­—ï¼ˆSocketï¼‰è¿æ¥é€šå¸¸ç”±å››å…ƒç»„å”¯ä¸€æ ‡è¯†)
- **åºåˆ—å·**ï¼šç”¨æ¥è§£å†³ä¹±åºé—®é¢˜ç­‰
- **çª—å£å¤§å°**ï¼šç”¨æ¥åšæµé‡æ§åˆ¶

ä»Cè¯­è¨€çš„è§’åº¦åˆ†æè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

1ã€æœåŠ¡å™¨åˆ›å»ºå¥—æ¥å­—`socket`ï¼Œ`bind`è‡³æŒ‡å®šåœ°å€å’Œç«¯å£ï¼Œ`listen`ï¼Œå¾ªç¯`accpet`ç­‰å¾…å®¢æˆ·ç«¯æ¥å…¥ï¼Œé˜»å¡ç­‰å¾…

2ã€å®¢æˆ·ç«¯åˆ›å»ºå¥—æ¥å­—`socket`ï¼Œï¼ˆ`bind`æŒ‡å®šåœ°å€å’Œç«¯å£ï¼Œ**é»˜è®¤ä¸`bind`ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†é…**ï¼‰ï¼Œè°ƒç”¨`connect()`æ–¹æ³•å‘æœåŠ¡å™¨å‘èµ·è¿æ¥è¯·æ±‚ï¼ˆå‘é€SYNåŒ…(åŒ…ä¸­åˆå§‹åŒ–ä¸€ä¸ª`Seg Num`)è‡³æœåŠ¡å™¨ï¼Œç¬¬ä¸€æ¬¡æ¡æ‰‹è¿æ¥ï¼‰ï¼Œé˜»å¡ç­‰å¾…

3ã€æœåŠ¡å™¨æ¥æ”¶åˆ°SYNåŒ…å‘é€ç¬¬äºŒä¸ªSYNåŒ…è‡³å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°æ­¤åŒ…ç¡®è®¤å»ºç«‹è¿æ¥ï¼Œå‘é€`ACK`åŒ…è‡³æœåŠ¡å™¨

4ã€æœåŠ¡å™¨æ¥æ”¶åˆ°ACKåŒ…ç¡®è®¤å»ºç«‹è¿æ¥

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/SOCKET.webp)

- æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åˆå§‹åŒ– `socket`ï¼Œå¾—åˆ°æ–‡ä»¶æè¿°ç¬¦ï¼›
- æœåŠ¡ç«¯è°ƒç”¨ `bind`ï¼Œå°† `socket` ç»‘å®šåœ¨æŒ‡å®šçš„ IP åœ°å€å’Œç«¯å£;
- æœåŠ¡ç«¯è°ƒç”¨ `listen`ï¼Œè¿›è¡Œç›‘å¬(**æ‰§è¡Œ listenæ–¹æ³•æ—¶ï¼Œä¼šåˆ›å»ºåŠè¿æ¥é˜Ÿåˆ—å’Œå…¨è¿æ¥é˜Ÿåˆ—**)ï¼›
- æœåŠ¡ç«¯è°ƒç”¨ `accept`ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼›
- å®¢æˆ·ç«¯è°ƒç”¨ `connect`ï¼Œå‘æœåŠ¡ç«¯çš„åœ°å€å’Œç«¯å£å‘èµ·è¿æ¥è¯·æ±‚(**TCPä¸‰æ¬¡æ¡æ‰‹æ‰§è¡Œæµç¨‹åœ¨è¿™é‡Œï¼Œä¸”æœåŠ¡ç«¯æ”¶åˆ°ç¬¬ä¸€æ¬¡æ¡æ‰‹åä¼šå°†è¯¥`socket`æ”¾å…¥åŠè¿æ¥é˜Ÿåˆ—**)ï¼›
- **ç›´åˆ°æ”¶åˆ°ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œä»åŠè¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€æ¡`socket`è¿æ¥æ”¾å…¥åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­**ï¼Œéšåå°±ç­‰å¾…æœåŠ¡ç«¯é˜»å¡è°ƒç”¨`accept()`ä»å…¨è¿æ¥é˜Ÿåˆ—ä¸­å–ä¸€æ¡è¿æ¥å‡ºæ¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªå·²å®Œæˆçš„`socket`ï¼Œæ­¤æ—¶è¿”å›ç”¨äºä¼ è¾“çš„ `socket` çš„æ–‡ä»¶æè¿°ç¬¦()ï¼›
- å®¢æˆ·ç«¯è°ƒç”¨ `write` å†™å…¥æ•°æ®ï¼›æœåŠ¡ç«¯è°ƒç”¨ `read` è¯»å–æ•°æ®ï¼›
- å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œä¼šè°ƒç”¨ `close`ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ `read` è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šè¯»å–åˆ°äº† `EOF`ï¼Œå¾…å¤„ç†å®Œæ•°æ®åï¼ŒæœåŠ¡ç«¯è°ƒç”¨ `close`ï¼Œè¡¨ç¤ºè¿æ¥å…³é—­ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æœåŠ¡ç«¯è°ƒç”¨ `accept` æ—¶ï¼Œè¿æ¥æˆåŠŸäº†ä¼šè¿”å›ä¸€ä¸ªå·²å®Œæˆè¿æ¥çš„ socketï¼Œåç»­ç”¨æ¥ä¼ è¾“æ•°æ®(ä»åŠè¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥æ”¾å…¥å…¨è¿æ¥é˜Ÿåˆ—ä¸­ï¼Œè¡¨ç¤ºå·²å®Œæˆä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥)**

æ‰€ä»¥ï¼Œç›‘å¬çš„ socket å’ŒçœŸæ­£ç”¨æ¥ä¼ é€æ•°æ®çš„ socketï¼Œæ˜¯ã€Œä¸¤ä¸ªã€ socketï¼Œä¸€ä¸ªå«ä½œ**ç›‘å¬ socket**ï¼Œä¸€ä¸ªå«ä½œ**å·²å®Œæˆè¿æ¥ socket**

æˆåŠŸè¿æ¥å»ºç«‹ä¹‹åï¼ŒåŒæ–¹å¼€å§‹é€šè¿‡ read å’Œ write å‡½æ•°æ¥è¯»å†™æ•°æ®ï¼Œå°±åƒå¾€ä¸€ä¸ªæ–‡ä»¶æµé‡Œé¢å†™ä¸œè¥¿ä¸€æ ·

> - **åŠè¿æ¥é˜Ÿåˆ—ï¼ˆSYNé˜Ÿåˆ—ï¼‰**ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°**ç¬¬ä¸€æ¬¡æ¡æ‰‹**åï¼Œä¼šå°†`socket`åŠ å…¥åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œé˜Ÿåˆ—å†…çš„`socket`éƒ½å¤„äº`SYN_RECV` çŠ¶æ€ã€‚
> - **å…¨è¿æ¥é˜Ÿåˆ—ï¼ˆACCEPTé˜Ÿåˆ—ï¼‰**ï¼Œåœ¨æœåŠ¡ç«¯æ”¶åˆ°**ç¬¬ä¸‰æ¬¡æ¡æ‰‹**åï¼Œä¼šå°†åŠè¿æ¥é˜Ÿåˆ—çš„`socket`å–å‡ºï¼Œæ”¾åˆ°å…¨è¿æ¥é˜Ÿåˆ—ä¸­ã€‚é˜Ÿåˆ—é‡Œçš„`socket`éƒ½å¤„äº `ESTABLISHED`çŠ¶æ€ã€‚è¿™é‡Œé¢çš„è¿æ¥ï¼Œå°±**ç­‰ç€æœåŠ¡ç«¯æ‰§è¡Œaccept()åè¢«å–å‡ºäº†ã€‚**
>
> å› æ­¤å»ºç«‹è¿æ¥çš„è¿‡ç¨‹ä¸­æ ¹æœ¬ä¸éœ€è¦`accept()`å‚ä¸ï¼Œ**æ‰§è¡Œaccept()åªæ˜¯ä¸ºäº†ä»å…¨è¿æ¥é˜Ÿåˆ—é‡Œå–å‡ºä¸€æ¡è¿æ¥**

ä»¥ä¸‹æµç¨‹å›¾æ–¹ä¾¿ç†è§£ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8Bsockett.webp" style="zoom: 67%;" />

### ä¸UDPåŒºåˆ«

 UDP é¢å‘æ— è¿æ¥ã€æ”¯æŒä¸€å¯¹å¤š å¤šå¯¹å¤šé€šä¿¡ã€ä¸”æ˜¯ä¸€ä¸ªåŒ…ä¸€ä¸ªåŒ…çš„å‘é€ï¼Œ**æœ‰è¾¹ç•Œ**ï¼Œæ•…ç»å¸¸ç”¨äºï¼š

- åŒ…æ€»é‡è¾ƒå°‘çš„é€šä¿¡ï¼Œå¦‚ `DNS` ã€`SNMP` ç­‰
- è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šåª’ä½“é€šä¿¡(å…è®¸æ•°
- æ®ä¸¢å¤±)
- å¹¿æ’­é€šä¿¡(TCPåªæ”¯æŒä¸€å¯¹ä¸€é€šä¿¡)
- https3 åº•å±‚å·²ç»åŸºäºUDPå®ç°äº†QUICåè®®ï¼


### MSS MTUåˆ†ç‰‡æ˜¯ä»€ä¹ˆï¼Ÿ

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/mss-mtu.webp" style="zoom: 67%;" />

- `MTU`ï¼šä¸€ä¸ªç½‘ç»œåŒ…çš„æœ€å¤§é•¿åº¦ï¼Œä»¥å¤ªç½‘ä¸­ä¸€èˆ¬ä¸º `1500` å­—èŠ‚(ä¸€ä¸ªIPæ•°æ®åŒ…çš„æœ€å¤§é•¿åº¦)ï¼›
- `MSS`ï¼šé™¤å» IP å’Œ TCP å¤´éƒ¨ä¹‹åï¼Œä¸€ä¸ªç½‘ç»œåŒ…æ‰€èƒ½å®¹çº³çš„ TCP æ•°æ®çš„æœ€å¤§é•¿åº¦(TCPæŠ¥æ–‡æ®µçš„æœ‰æ•ˆæ•°æ®é•¿åº¦)ï¼›

  å¦‚æœäº¤ç»™IPå±‚è¿›è¡Œåˆ†ç‰‡ï¼Œå½“ IP å±‚æœ‰ä¸€ä¸ªè¶…è¿‡ `MTU` å¤§å°çš„æ•°æ®ï¼ˆTCP å¤´éƒ¨ + TCP æ•°æ®ï¼‰è¦å‘é€ï¼Œé‚£ä¹ˆ IP å±‚å°±è¦è¿›è¡Œåˆ†ç‰‡ï¼ŒæŠŠæ•°æ®åˆ†ç‰‡æˆè‹¥å¹²ç‰‡ï¼Œä¿è¯æ¯ä¸€ä¸ªåˆ†ç‰‡éƒ½å°äº MTUï¼Œ**é‚£ä¹ˆå¦‚æœä¸€ä¸ª IP åˆ†ç‰‡ä¸¢å¤±ï¼Œæ•´ä¸ª IP æŠ¥æ–‡çš„æ‰€æœ‰åˆ†ç‰‡éƒ½å¾—é‡ä¼ **ï¼Œå› ä¸º IP å±‚æœ¬èº«æ²¡æœ‰è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œå®ƒç”±ä¼ è¾“å±‚çš„ TCP æ¥è´Ÿè´£è¶…æ—¶å’Œé‡ä¼ ã€‚å½“æŸä¸€ä¸ª IP åˆ†ç‰‡ä¸¢å¤±åï¼Œæ¥æ”¶æ–¹çš„ IP å±‚å°±æ— æ³•ç»„è£…æˆä¸€ä¸ªå®Œæ•´çš„ TCP æŠ¥æ–‡ï¼ˆå¤´éƒ¨ + æ•°æ®ï¼‰ï¼Œä¹Ÿå°±æ— æ³•å°†æ•°æ®æŠ¥æ–‡é€åˆ° TCP å±‚ï¼Œæ‰€ä»¥æ¥æ”¶æ–¹ä¸ä¼šå“åº” ACK ç»™å‘é€æ–¹ï¼Œå› ä¸ºå‘é€æ–¹è¿Ÿè¿Ÿæ”¶ä¸åˆ° ACK ç¡®è®¤æŠ¥æ–‡ï¼Œæ‰€ä»¥ä¼šè§¦å‘è¶…æ—¶é‡ä¼ ï¼Œå°±ä¼šé‡å‘ã€Œæ•´ä¸ª TCP æŠ¥æ–‡ï¼ˆå¤´éƒ¨ + æ•°æ®ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†è¾¾åˆ°æœ€ä½³çš„ä¼ è¾“æ•ˆèƒ½ï¼Œ TCP åè®®åœ¨**å»ºç«‹è¿æ¥çš„æ—¶å€™é€šå¸¸è¦åå•†åŒæ–¹çš„ MSS å€¼**ï¼Œå½“ TCP å±‚å‘ç°æ•°æ®è¶…è¿‡ MSS æ—¶ï¼Œåˆ™å°±å…ˆä¼šè¿›è¡Œåˆ†ç‰‡ï¼Œç»è¿‡ TCP å±‚åˆ†ç‰‡åï¼Œå¦‚æœä¸€ä¸ª TCP åˆ†ç‰‡ä¸¢å¤±åï¼Œ**è¿›è¡Œé‡å‘æ—¶ä¹Ÿæ˜¯ä»¥ MSS ä¸ºå•ä½**ï¼Œè€Œä¸ç”¨é‡ä¼ æ‰€æœ‰çš„åˆ†ç‰‡ï¼Œå¤§å¤§å¢åŠ äº†é‡ä¼ çš„æ•ˆç‡



### ä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹

1ã€ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Ÿè€Œä¸æ˜¯ä¸¤æ¬¡/å››æ¬¡ 

(1)é˜»æ­¢é‡å¤å†å²è¿æ¥çš„åˆå§‹åŒ–æµªè´¹æœåŠ¡å™¨èµ„æº(å®¢æˆ·ç«¯æ—§çš„SYNæŠ¥æ–‡å…ˆåˆ°è¾¾ï¼Œä¸¤æ¬¡æ¡æ‰‹æœåŠ¡ç«¯åˆ™ç›´æ¥å»ºç«‹è¿æ¥äº†ï¼Œåé¢å®¢æˆ·ç«¯å‘é€RSTæŠ¥æ–‡çš„è¯ï¼ŒæœåŠ¡ç«¯å°±ç›´æ¥æµªè´¹æ‰äº†è¯¥è¿æ¥ï¼›ä¸‰æ¬¡æ¡æ‰‹çš„è¯ï¼ŒæœåŠ¡ç«¯åœ¨æ”¶åˆ°æ—§SYNæŠ¥æ–‡åè¿˜ä¸ä¼šç«‹å³å»ºç«‹è¿æ¥ï¼Œè¿™æ ·å³ä½¿åé¢å®¢æˆ·ç«¯å‘é€RSTæŠ¥æ–‡æ¥å–æ¶ˆæ—§SYNæŠ¥æ–‡ï¼ŒæœåŠ¡ç«¯ä¹Ÿä¸ä¼šæŸå¤±å¤ªå¤šèµ„æºï¼Œ)

(2)**åŒæ­¥åŒæ–¹çš„åˆå§‹åºåˆ—å·**,å®ç°å¯é ä¼ è¾“ï¼Œåºåˆ—å·æœºåˆ¶çš„ä½œç”¨åœ¨äºï¼š

- æ¥æ”¶æ–¹å¯ä»¥å»é™¤é‡å¤çš„æ•°æ®ï¼›
- æ¥æ”¶æ–¹å¯ä»¥æ ¹æ®æ•°æ®åŒ…çš„åºåˆ—å·**æŒ‰åº**æ¥æ”¶ï¼›
- å¯ä»¥æ ‡è¯†å‘é€å‡ºå»çš„æ•°æ®åŒ…ä¸­ï¼Œ å“ªäº›æ˜¯å·²ç»è¢«å¯¹æ–¹æ”¶åˆ°çš„ï¼ˆé€šè¿‡ ACK æŠ¥æ–‡ä¸­çš„åºåˆ—å·ï¼‰

(3) é¿å…æœåŠ¡å™¨èµ„æºæµªè´¹ï¼šå¦‚æœæ˜¯ä¸¤æ¬¡æ¡æ‰‹ï¼Œå‡è®¾å®¢æˆ·ç«¯è¶…æ—¶é‡ä¼ äº†SYNæŠ¥æ–‡ï¼ŒæœåŠ¡ç«¯åœ¨æ—§çš„SYNå’Œæ–°çš„SYNæŠ¥æ–‡æ—¶å‡ä¼šå»ºç«‹è¿æ¥è¿›å…¥`Established`çŠ¶æ€,è€Œå®¢æˆ·ç«¯å®é™…ä¸Šåªæƒ³å»ºç«‹ä¸€æ¬¡è¿æ¥ï¼Œè¿™å°±é€ æˆäº†æœåŠ¡å™¨çš„èµ„æºæµªè´¹




2ã€æ¡æ‰‹/æŒ¥æ‰‹ ä¸¢å¤±æƒ…å†µ

é’ˆå¯¹æ¡æ‰‹ï¼š

(1)ç¬¬ä¸€æ¬¡æ¡æ‰‹ä¸¢å¤±ï¼šå®¢æˆ·ç«¯è§¦å‘è¶…æ—¶é‡ä¼ SYNæŠ¥æ–‡ï¼Œ**é‡ä¼ çš„ SYN æŠ¥æ–‡çš„åºåˆ—å·ä¹Ÿä¸€æ ·**ï¼Œåœ¨ Linux é‡Œï¼Œå®¢æˆ·ç«¯çš„ SYN æŠ¥æ–‡æœ€å¤§é‡ä¼ æ¬¡æ•°ç”± `tcp_syn_retries`å†…æ ¸å‚æ•°æ§åˆ¶ï¼Œä¸€èˆ¬æ˜¯5ï¼Œæ¯æ¬¡è¶…æ—¶é‡ä¼ æ—¶é—´ç¿»å€ï¼Œå¦‚æœè¾¾åˆ°ä¸Šé™åä¾æ—§æ²¡æœ‰æ”¶åˆ°æœåŠ¡ç«¯çš„ACKï¼Œåˆ™ä¸»åŠ¨æ–­å¼€è¿æ¥è¿›å…¥`Closed`æ€

(2)ç¬¬äºŒæ¬¡æ¡æ‰‹ä¸¢å¤±ï¼š**å®¢æˆ·ç«¯å°±ä¼šè§¦å‘è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œé‡ä¼  SYN æŠ¥æ–‡**(ç¬¬ä¸€æ¬¡æ¡æ‰‹æœ€å¤§é‡ä¼ æ¬¡æ•°ç”± `tcp_syn_retries`å†…æ ¸å‚æ•°å†³å®š);**æœåŠ¡ç«¯è¿™è¾¹ä¹Ÿä¼šè§¦å‘è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œé‡ä¼  SYN-ACK æŠ¥æ–‡**ï¼Œæœ€å¤§é‡ä¼ æ¬¡æ•°ç”± `tcp_synack_retries` å†…æ ¸å‚æ•°å†³å®š

(3)ç¬¬ä¸‰æ¬¡æ¡æ‰‹ä¸¢å¤±ï¼š**å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ SYN-ACK æŠ¥æ–‡åï¼Œå°±ä¼šç»™æœåŠ¡ç«¯å›ä¸€ä¸ª ACK æŠ¥æ–‡ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯çŠ¶æ€è¿›å…¥åˆ° ESTABLISH çŠ¶æ€ã€‚å› ä¸ºè¿™ä¸ªç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ ACK æ˜¯å¯¹ç¬¬äºŒæ¬¡æ¡æ‰‹çš„ SYN çš„ç¡®è®¤æŠ¥æ–‡ï¼Œæ‰€ä»¥å½“ç¬¬ä¸‰æ¬¡æ¡æ‰‹ä¸¢å¤±äº†ï¼Œå¦‚æœæœåŠ¡ç«¯é‚£ä¸€æ–¹è¿Ÿè¿Ÿæ”¶ä¸åˆ°è¿™ä¸ªç¡®è®¤æŠ¥æ–‡ï¼Œå°±ä¼šè§¦å‘è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œé‡ä¼  SYN-ACK æŠ¥æ–‡ï¼Œç›´åˆ°æ”¶åˆ°ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§é‡ä¼ æ¬¡æ•°ã€‚æ³¨æ„ï¼ŒACK æŠ¥æ–‡æ˜¯ä¸ä¼šæœ‰é‡ä¼ çš„ï¼Œå½“ ACK ä¸¢å¤±äº†ï¼Œå°±ç”±å¯¹æ–¹é‡ä¼ å¯¹åº”çš„æŠ¥æ–‡**



é’ˆå¯¹æŒ¥æ‰‹ï¼š

(1)ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ä¸¢å¤±ï¼šå®¢æˆ·ç«¯(ä¸»åŠ¨å…³é—­æ–¹)è°ƒç”¨ `close` å‡½æ•°åå°±ä¼šè¿›å…¥`Finish_Wait_1`çŠ¶æ€ï¼Œç›´åˆ°æ”¶åˆ°å¯¹æ–¹çš„`ACK`åè¿›å…¥`Finish_Wait_2`æ€ï¼Œ**å¦‚æœç¬¬ä¸€æ¬¡æŒ¥æ‰‹ä¸¢å¤±ï¼Œå®¢æˆ·ç«¯è§¦å‘è¶…æ—¶é‡ä¼ æœºåˆ¶**ï¼Œé‡ä¼  FIN æŠ¥æ–‡ï¼Œé‡å‘æ¬¡æ•°ç”± `tcp_orphan_retries` å‚æ•°æ§åˆ¶

(2)ç¬¬äºŒæ¬¡æŒ¥æ‰‹ä¸¢å¤±ï¼š**å®¢æˆ·ç«¯è§¦å‘è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œé‡ä¼  FIN æŠ¥æ–‡**ï¼Œç›´åˆ°æ”¶åˆ°æœåŠ¡ç«¯çš„ç¬¬äºŒæ¬¡æŒ¥æ‰‹(é‡å‘æ¬¡æ•°åŒæ ·ç”± `tcp_orphan_retries` å‚æ•°æ§åˆ¶)ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§çš„é‡ä¼ æ¬¡æ•°ï¼Œè€Œ**æœåŠ¡ç«¯ä¸ä¼šé‡ä¼ **(`ACK`æŠ¥æ–‡ä¸ä¼šé‡ä¼ ,å› ä¸ºå››æ¬¡æŒ¥æ‰‹æ˜¯åŒå‘çš„ï¼ŒæœåŠ¡ç«¯ä¸éœ€è¦åœ¨æ”¶åˆ°ç¬¬ä¸€æ¬¡æŒ¥æ‰‹åä¹Ÿå…³é—­è¿æ¥ï¼Œæ•…åªéœ€è¦å›å¤å¯¹ç¬¬ä¸€æ¬¡æŒ¥æ‰‹æŠ¥æ–‡çš„ACKå³å¯)

(3)ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ä¸¢å¤±ï¼šæœåŠ¡ç«¯ï¼ˆè¢«åŠ¨å…³é—­æ–¹ï¼‰æ”¶åˆ°å®¢æˆ·ç«¯ï¼ˆä¸»åŠ¨å…³é—­æ–¹ï¼‰çš„ FIN æŠ¥æ–‡åå¤„äº `CLOSE_WAIT` çŠ¶æ€ï¼Œå½“è¢«åŠ¨å…³é—­æ–¹è°ƒç”¨äº† `close` å‡½æ•°åï¼Œè¿æ¥è¿›å…¥ `LAST_ACK` çŠ¶æ€ï¼Œå¹¶ç­‰å¾…å®¢æˆ·ç«¯è¿”å› ACK æ¥ç¡®è®¤è¿æ¥å…³é—­ï¼Œå¦‚æœæ­¤æ¬¡æŒ¥æ‰‹ä¸¢å¤±ï¼ŒæœåŠ¡ç«¯å°±ä¼šé‡å‘ FIN æŠ¥æ–‡ï¼Œé‡å‘æ¬¡æ•°ä»ç„¶ç”± `tcp_orphan_retries` å‚æ•°æ§åˆ¶

(4)ç¬¬å››æ¬¡æŒ¥æ‰‹ä¸¢å¤±ï¼šæœåŠ¡ç«¯ï¼ˆè¢«åŠ¨å…³é—­æ–¹ï¼‰æ²¡æœ‰æ”¶åˆ° ACK æŠ¥æ–‡å‰ï¼Œè¿˜æ˜¯å¤„äº `LAST_ACK` çŠ¶æ€,å¦‚æœç¬¬å››æ¬¡æŒ¥æ‰‹çš„ ACK æŠ¥æ–‡æ²¡æœ‰åˆ°è¾¾æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å°±ä¼šé‡å‘ FIN æŠ¥æ–‡ï¼Œé‡å‘æ¬¡æ•°ä»ç„¶ç”±`tcp_orphan_retries` å‚æ•°æ§åˆ¶



3ã€å¦‚ä½•é¿å…SYNæ”»å‡»ï¼Ÿ

- å¢å¤§ TCP åŠè¿æ¥é˜Ÿåˆ—ï¼›

- å¼€å¯ `tcp_syncookies`(è·³è¿‡SYNé˜Ÿåˆ—æ¥å»ºç«‹è¿æ¥)ï¼›

  - å½“ ã€Œ SYN é˜Ÿåˆ—ã€æ»¡ä¹‹åï¼Œåç»­æœåŠ¡ç«¯æ”¶åˆ° SYN åŒ…ï¼Œä¸ä¼šä¸¢å¼ƒï¼Œè€Œæ˜¯æ ¹æ®ç®—æ³•ï¼Œè®¡ç®—å‡ºä¸€ä¸ª `cookie` å€¼ï¼›

  - å°† cookie å€¼æ”¾åˆ°ç¬¬äºŒæ¬¡æ¡æ‰‹æŠ¥æ–‡çš„ã€Œåºåˆ—å·ã€é‡Œï¼Œç„¶åæœåŠ¡ç«¯å›ç¬¬äºŒæ¬¡æ¡æ‰‹ç»™å®¢æˆ·ç«¯ï¼›

  - æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„åº”ç­”æŠ¥æ–‡æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šæ£€æŸ¥è¿™ä¸ª ACK åŒ…çš„åˆæ³•æ€§ã€‚å¦‚æœåˆæ³•ï¼Œå°†è¯¥è¿æ¥å¯¹è±¡æ”¾å…¥åˆ°ã€Œ Accept é˜Ÿåˆ—ã€ã€‚

  - æœ€ååº”ç”¨ç¨‹åºé€šè¿‡è°ƒç”¨ `accpet()` æ¥å£ï¼Œä»ã€Œ Accept é˜Ÿåˆ—ã€å–å‡ºçš„è¿æ¥ã€‚

    å¯ä»¥çœ‹åˆ°ï¼Œå½“å¼€å¯äº† `tcp_syncookies` åï¼Œå³ä½¿å—åˆ° SYN æ”»å‡»è€Œå¯¼è‡´ SYN é˜Ÿåˆ—æ»¡æ—¶ï¼Œä¹Ÿèƒ½ä¿è¯æ­£å¸¸çš„è¿æ¥æˆåŠŸå»ºç«‹ã€‚

    `net.ipv4.tcp_syncookies` å‚æ•°ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªå€¼ï¼š

    - 0 å€¼ï¼Œè¡¨ç¤ºå…³é—­è¯¥åŠŸèƒ½ï¼›
    - 1 å€¼ï¼Œè¡¨ç¤ºä»…å½“ SYN åŠè¿æ¥é˜Ÿåˆ—æ”¾ä¸ä¸‹æ—¶ï¼Œå†å¯ç”¨å®ƒï¼›
    - 2 å€¼ï¼Œè¡¨ç¤ºæ— æ¡ä»¶å¼€å¯åŠŸèƒ½ï¼›Â·

- å‡å°‘ SYN+ACK é‡ä¼ æ¬¡æ•°



4ã€å››æ¬¡æŒ¥æ‰‹æµç¨‹å›¾

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.webp" style="zoom:75%;" />

(1) **ä¸»åŠ¨å…³é—­è¿æ¥çš„ï¼Œæ‰æœ‰ TIME_WAIT çŠ¶æ€**

(2) `FIN_WAIT2`çŠ¶æ€ä¸‹å®¢æˆ·ç«¯ä¾æ—§å¯ä»¥æ¥æ”¶è¢«åŠ¨å…³é—­æ–¹(æœåŠ¡ç«¯)çš„æ•°æ®

(3) è¢«åŠ¨å…³é—­æ–¹æ”¶åˆ°ä¸»åŠ¨å…³é—­æ–¹çš„FINæŠ¥æ–‡åå°±è¿›å…¥`CLOSED_WAIT`çŠ¶æ€,æ­¤æ—¶è¢«åŠ¨å…³é—­æ–¹ä¾æ—§å¯ä»¥å‘å¯¹ç«¯å‘é€æ•°æ®ï¼Œç›´åˆ°æ‰€æœ‰æ•°æ®å‘é€å®Œæˆåå‘é€FINæŠ¥æ–‡è¿›å…¥`LAST_ACK`çŠ¶æ€







###  TIME_WAITçŠ¶æ€



#### ä¸ºä»€ä¹ˆTIME_WAITç­‰å¾…æ—¶é—´ä¸º2MSL?



é¦–å…ˆè¦æ¸…æ¥šï¼šç½‘ç»œä¸­å¯èƒ½å­˜åœ¨æ¥è‡ªå‘é€æ–¹çš„æ•°æ®åŒ…ï¼Œå½“è¿™äº›å‘é€æ–¹çš„æ•°æ®åŒ…è¢«æ¥æ”¶æ–¹å¤„ç†ååˆä¼šå‘å¯¹æ–¹å‘é€å“åº”ï¼Œæ‰€ä»¥**ä¸€æ¥ä¸€å›éœ€è¦`2MSL`(Maximum Segment Lifetime)çš„æ—¶é—´** ï¼Œç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹ç¬¬å››æ¬¡æŒ¥æ‰‹ä¸¢å¤±çš„æƒ…å†µ(å› ä¸º**ç¬¬å››æ¬¡æŒ¥æ‰‹å‘èµ·æ—¶ä¸»åŠ¨å…³é—­æ–¹æ‰è¿›å…¥`TIME_WAIT`çŠ¶æ€**)ï¼šè¢«åŠ¨å…³é—­æ–¹æ²¡æœ‰æ”¶åˆ°æ–­å¼€è¿æ¥çš„æœ€åçš„ `ACK` æŠ¥æ–‡ï¼Œå°±ä¼šè§¦å‘è¶…æ—¶é‡å‘ `FIN` æŠ¥æ–‡ï¼Œä¸»åŠ¨å…³é—­æ–¹åœ¨`TIME_WAIT`çŠ¶æ€å†…æ¥æ”¶åˆ° `FIN` åï¼Œå°±ä¼šé‡å‘ `ACK` ç»™è¢«åŠ¨å…³é—­æ–¹ï¼Œ**å³ç¬¬å››æ¬¡æŒ¥æ‰‹çš„`ACK`è‹¥åœ¨ä¸€ä¸ª `MSL` å†…ä¸¢å¤±ï¼Œè¢«åŠ¨æ–¹é‡å‘çš„ `FIN` ä¼šåœ¨ç¬¬ 2 ä¸ª `MSL` å†…åˆ°è¾¾ï¼Œ`TIME_WAIT` çŠ¶æ€çš„è¿æ¥å¯ä»¥åº”å¯¹ï¼Œ**ä¸‹é¢ç”»å›¾æ¥å¸®åŠ©ç†è§£ä¸€ä¸‹ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/TIME-WAIT%E8%BF%9E%E6%8E%A5%E6%AD%A3%E5%B8%B8%E5%85%B3%E9%97%AD.drawio.jpg)







#### ä¸ºä»€ä¹ˆéœ€è¦TIME_WAITçŠ¶æ€ï¼Ÿ

(1) *é˜²æ­¢å†å²è¿æ¥ä¸­çš„æ•°æ®ï¼Œè¢«åé¢ç›¸åŒå››å…ƒç»„çš„è¿æ¥é”™è¯¯çš„æ¥æ”¶* ï¼šTCP è®¾è®¡äº† TIME_WAIT çŠ¶æ€ï¼ŒçŠ¶æ€ä¼šæŒç»­ `2MSL` æ—¶é•¿ï¼Œè¿™ä¸ªæ—¶é—´**è¶³ä»¥è®©ä¸¤ä¸ªæ–¹å‘ä¸Šçš„æ•°æ®åŒ…éƒ½è¢«ä¸¢å¼ƒï¼Œä½¿å¾—åŸæ¥è¿æ¥çš„æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­éƒ½è‡ªç„¶æ¶ˆå¤±ï¼Œå†å‡ºç°çš„æ•°æ®åŒ…ä¸€å®šéƒ½æ˜¯æ–°å»ºç«‹çš„è¿æ¥æ‰€äº§ç”Ÿçš„**

(2)*ä¿è¯ã€Œè¢«åŠ¨å…³é—­è¿æ¥ã€çš„ä¸€æ–¹ï¼Œèƒ½è¢«æ­£ç¡®çš„å…³é—­*ï¼šå®¢æˆ·ç«¯å¿…é¡»ç­‰å¾…è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼Œç¡®ä¿æœåŠ¡ç«¯èƒ½å¤Ÿæ”¶åˆ° `ACK`ï¼Œå¦‚æœæœåŠ¡ç«¯æ²¡æœ‰æ”¶åˆ° `ACK`ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ TCP é‡ä¼ æœºåˆ¶ï¼ŒæœåŠ¡ç«¯ä¼šé‡æ–°å‘é€ä¸€ä¸ª `FIN`ï¼Œè¿™æ ·ä¸€å»ä¸€æ¥åˆšå¥½ä¸¤ä¸ª `MSL` çš„æ—¶é—´



#### TIME_WAITçŠ¶æ€è¿‡å¤šçš„å±å®³

å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ TIME_WAIT è¿‡å¤šï¼Œé€ æˆçš„å½±å“æ˜¯ä¸åŒçš„

**å¦‚æœå®¢æˆ·ç«¯ï¼ˆä¸»åŠ¨å‘èµ·å…³é—­è¿æ¥æ–¹ï¼‰çš„ TIME_WAIT çŠ¶æ€è¿‡å¤š**ï¼Œå æ»¡äº†æ‰€æœ‰æºç«¯å£èµ„æº(å®¢æˆ·ç«¯å¤šä¸ª ip+port éƒ½å¤„äºtime_waitæ€)ï¼Œé‚£ä¹ˆå°±æ— æ³•å¯¹ã€Œç›®çš„ IP+ ç›®çš„ PORTã€éƒ½ä¸€æ ·çš„æœåŠ¡ç«¯å‘èµ·è¿æ¥äº†,æ³¨æ„ï¼šåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œ**åªè¦è¿æ¥çš„æ˜¯ä¸åŒçš„æœåŠ¡ç«¯ï¼Œç«¯å£æ˜¯å¯ä»¥é‡å¤ä½¿ç”¨çš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è¿˜æ˜¯å¯ä»¥å‘å…¶ä»–æœåŠ¡ç«¯å‘èµ·è¿æ¥çš„**ï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸åœ¨å®šä½ä¸€ä¸ªè¿æ¥çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡å››å…ƒç»„ï¼ˆæºIPã€æºç«¯å£ã€ç›®çš„IPã€ç›®çš„ç«¯å£ï¼‰ä¿¡æ¯æ¥å®šä½çš„ï¼Œå¹¶ä¸ä¼šå› ä¸ºå®¢æˆ·ç«¯çš„ç«¯å£ä¸€æ ·ï¼Œè€Œå¯¼è‡´è¿æ¥å†²çª

**å¦‚æœæœåŠ¡ç«¯ï¼ˆä¸»åŠ¨å‘èµ·å…³é—­è¿æ¥æ–¹ï¼‰çš„ TIME_WAIT çŠ¶æ€è¿‡å¤š**ï¼Œå¹¶ä¸ä¼šå¯¼è‡´ç«¯å£èµ„æºå—é™ï¼Œå› ä¸ºæœåŠ¡ç«¯åªç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œè€Œä¸”ç”±äºä¸€ä¸ªå››å…ƒç»„å”¯ä¸€ç¡®å®šä¸€ä¸ª TCP è¿æ¥ï¼Œå› æ­¤ç†è®ºä¸ŠæœåŠ¡ç«¯å¯ä»¥å»ºç«‹å¾ˆå¤šè¿æ¥ï¼Œä½†æ˜¯ **TCP è¿æ¥è¿‡å¤šï¼Œä¼šå ç”¨ç³»ç»Ÿèµ„æº**ï¼Œ**æ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜èµ„æº**ã€CPU èµ„æºã€çº¿ç¨‹èµ„æºç­‰





####  æœåŠ¡å™¨å‡ºç°å¤§é‡ TIME_WAIT çŠ¶æ€çš„åŸå› æœ‰å“ªäº›ï¼Ÿ



é¦–å…ˆè¦çŸ¥é“ TIME_WAIT çŠ¶æ€æ˜¯ä¸»åŠ¨å…³é—­è¿æ¥æ–¹æ‰ä¼šå‡ºç°çš„çŠ¶æ€ï¼Œæ‰€ä»¥**å¦‚æœæœåŠ¡å™¨å‡ºç°å¤§é‡çš„ TIME_WAIT çŠ¶æ€çš„ TCP è¿æ¥ï¼Œå°±æ˜¯è¯´æ˜æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€äº†å¾ˆå¤š TCP è¿æ¥**

**ä»€ä¹ˆåœºæ™¯ä¸‹æœåŠ¡ç«¯ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥å‘¢ï¼Ÿ**

- ç¬¬ä¸€ä¸ªåœºæ™¯ï¼šHTTPé€šä¿¡åŒæ–¹æ²¡æœ‰ä½¿ç”¨é•¿è¿æ¥
- ç¬¬äºŒä¸ªåœºæ™¯ï¼šHTTP é•¿è¿æ¥è¶…æ—¶
- ç¬¬ä¸‰ä¸ªåœºæ™¯ï¼šHTTP é•¿è¿æ¥çš„è¯·æ±‚æ•°é‡è¾¾åˆ°ä¸Šé™

(1) **æ ¹æ®å¤§å¤šæ•° Web æœåŠ¡çš„å®ç°ï¼Œä¸ç®¡å“ªä¸€æ–¹ç¦ç”¨äº† HTTP Keep-Aliveï¼Œéƒ½æ˜¯ç”±æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­è¿æ¥**ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºç° TIME_WAIT çŠ¶æ€çš„è¿æ¥ï¼Œæ•…**å½“æœåŠ¡ç«¯å‡ºç°å¤§é‡çš„ TIME_WAIT çŠ¶æ€è¿æ¥çš„æ—¶å€™ï¼Œå¯ä»¥æ’æŸ¥ä¸‹æ˜¯å¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¼€å¯äº† HTTP Keep-Alive**ï¼Œå› ä¸ºä»»æ„ä¸€æ–¹æ²¡æœ‰å¼€å¯ HTTP `Keep-Alive`ï¼Œéƒ½ä¼šå¯¼è‡´æœåŠ¡ç«¯åœ¨å¤„ç†å®Œä¸€ä¸ª HTTP è¯·æ±‚åï¼Œå°±ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºç°å¤§é‡çš„ TIME_WAIT çŠ¶æ€çš„è¿æ¥ã€‚è§£å†³çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œè®©å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¼€å¯ HTTP `Keep-Alive` æœºåˆ¶

(2) web æœåŠ¡è½¯ä»¶ä¸€èˆ¬éƒ½ä¼šæä¾›ä¸€ä¸ªå‚æ•°ï¼Œç”¨æ¥æŒ‡å®š HTTP é•¿è¿æ¥çš„è¶…æ—¶æ—¶é—´(é¿å…èµ„æºæµªè´¹)ï¼Œæ¯”å¦‚ `nginx` æä¾›çš„ `keepalive_timeout` å‚æ•°ï¼Œå‡è®¾è®¾ç½®äº† HTTP é•¿è¿æ¥çš„è¶…æ—¶æ—¶é—´æ˜¯ 60 ç§’ï¼Œnginx å°±ä¼šå¯åŠ¨ä¸€ä¸ªã€Œå®šæ—¶å™¨ã€ï¼Œ**å‡å¦‚å®¢æˆ·ç«¯åœ¨å®Œæˆä¸€ä¸ª HTTP è¯·æ±‚åï¼Œåœ¨ 60 ç§’å†…éƒ½æ²¡æœ‰å†å‘èµ·æ–°çš„è¯·æ±‚ï¼Œå®šæ—¶å™¨çš„æ—¶é—´ä¸€åˆ°ï¼Œnginx å°±ä¼šè§¦å‘å›è°ƒå‡½æ•°æ¥å…³é—­è¯¥è¿æ¥ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºç° TIME_WAIT çŠ¶æ€çš„è¿æ¥**

é‚£ä¹ˆè®¾æƒ³ä¸€ä¸‹ï¼šå¦‚æœæœ‰å¤§é‡çš„å®¢æˆ·ç«¯å»ºç«‹å®Œ TCP è¿æ¥åï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡æœ‰å‘é€æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šç”±äºHTTP é•¿è¿æ¥è¶…æ—¶ï¼Œå¯¼è‡´æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œä»è€Œäº§ç”Ÿå¤§é‡å¤„äº TIME_WAIT çŠ¶æ€çš„è¿æ¥

(3)Web æœåŠ¡å™¨é€šå¸¸ä¼šæœ‰ä¸ªå‚æ•°ï¼Œæ¥**å®šä¹‰ä¸€æ¡ HTTP é•¿è¿æ¥ä¸Šæœ€å¤§èƒ½å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œå½“è¶…è¿‡æœ€å¤§é™åˆ¶æ—¶ï¼Œå°±ä¼šä¸»åŠ¨å…³é—­è¿æ¥**ã€‚å¦‚ `nginx` çš„ `keepalive_requests` è¿™ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°æ˜¯æŒ‡ä¸€ä¸ª HTTP é•¿è¿æ¥å»ºç«‹ä¹‹åï¼Œ`nginx` å°±ä¼šä¸ºè¿™ä¸ªè¿æ¥è®¾ç½®ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®°å½•è¿™ä¸ª HTTP é•¿è¿æ¥ä¸Šå·²ç»æ¥æ”¶å¹¶å¤„ç†çš„å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°é‡ã€‚**å¦‚æœè¾¾åˆ°è¿™ä¸ªå‚æ•°è®¾ç½®çš„æœ€å¤§å€¼æ—¶ï¼Œåˆ™ nginx ä¼šä¸»åŠ¨å…³é—­è¿™ä¸ªé•¿è¿æ¥**ï¼Œé‚£ä¹ˆæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºç° `TIME_WAIT` çŠ¶æ€çš„è¿æ¥

é‚£ä¹ˆ**å¯¹äºä¸€äº› QPS æ¯”è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚è¶…è¿‡ 10000 QPSï¼Œç”šè‡³è¾¾åˆ° 30000 , 50000 ç”šè‡³æ›´é«˜ï¼Œå¦‚æœ `keepalive_requests` å‚æ•°å€¼æ˜¯ 100(é»˜è®¤å€¼)ï¼Œè¿™æ—¶å€™å°± nginx å°±ä¼šå¾ˆé¢‘ç¹åœ°å…³é—­è¿æ¥ï¼Œæ­¤æ—¶æœåŠ¡ç«¯ä¸Šå°±ä¼šå‡ºå¤§é‡çš„ `TIME_WAIT` çŠ¶æ€**



> è¡¥å……:æœåŠ¡å™¨å‡ºç°å¤§é‡ CLOSE_WAIT çŠ¶æ€çš„åŸå› æœ‰å“ªäº›ï¼Ÿ(ä»æ— æ³•è½¬æ¢è‡³`LASK_ACK`çŠ¶æ€çš„è§’åº¦ç­”)
>
> 
>
> CLOSE_WAIT çŠ¶æ€æ˜¯ã€Œè¢«åŠ¨å…³é—­æ–¹ã€æ‰ä¼šæœ‰çš„çŠ¶æ€ï¼Œè€Œä¸”å¦‚æœã€Œè¢«åŠ¨å…³é—­æ–¹ã€æ²¡æœ‰è°ƒç”¨ close å‡½æ•°å…³é—­è¿æ¥ï¼Œé‚£ä¹ˆå°±æ— æ³•å‘å‡º FIN æŠ¥æ–‡ï¼Œä»è€Œæ— æ³•ä½¿å¾— CLOSE_WAIT çŠ¶æ€çš„è¿æ¥è½¬å˜ä¸º LAST_ACK çŠ¶æ€
>
> æ‰€ä»¥ï¼Œ**å½“æœåŠ¡ç«¯å‡ºç°å¤§é‡ CLOSE_WAIT çŠ¶æ€çš„è¿æ¥çš„æ—¶å€™ï¼Œè¯´æ˜æœåŠ¡ç«¯çš„ç¨‹åºæ²¡æœ‰æˆåŠŸè°ƒç”¨ close å‡½æ•°å…³é—­è¿æ¥**





### TCPè¿æ¥æ•…éšœé—®é¢˜åˆ†æ :imp:

ä» æœ‰æ— æ•°æ®ä¼ è¾“ã€æ˜¯å¦å¼€å¯TCPä¿æ´»æœºåˆ¶ã€è¿›ç¨‹å´©æºƒ/ä¸»æœºé‡å¯/æ‹”æ‰ç½‘çº¿ ç­‰è§’åº¦æ¥åˆ†æ



#### æ‹”æ‰ç½‘çº¿åï¼ŒTCPè¿æ¥è¿˜å­˜åœ¨å—?

TCPè¿æ¥åœ¨ Linux å†…æ ¸ä¸­æ˜¯ä¸€ä¸ªåä¸º `struct socket` çš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“çš„å†…å®¹åŒ…å« TCP è¿æ¥çš„çŠ¶æ€ç­‰ä¿¡æ¯ã€‚**å½“æ‹”æ‰ç½‘çº¿çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸ä¼šå˜æ›´è¯¥ç»“æ„ä½“çš„ä»»ä½•å†…å®¹**ï¼Œæ‰€ä»¥TCPè¿æ¥çš„çŠ¶æ€ä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜

1. æ‹”æ‰ç½‘çº¿åï¼Œæœ‰æ•°æ®ä¼ è¾“

  åœ¨å®¢æˆ·ç«¯æ‹”æ‰ç½‘çº¿åï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æŠ¥æ–‡ä¼šå¾—ä¸åˆ°ä»»ä½•çš„å“åº”ï¼Œåœ¨ç­‰å¾…ä¸€å®šæ—¶é•¿åï¼ŒæœåŠ¡ç«¯å°±ä¼šè§¦å‘è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œé‡ä¼ æœªå¾—åˆ°å“åº”çš„æ•°æ®æŠ¥æ–‡ã€‚**å¦‚æœåœ¨æœåŠ¡ç«¯é‡ä¼ æŠ¥æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯åˆšå¥½æŠŠç½‘çº¿æ’å›å»äº†**ï¼Œ**ç”±äºæ‹”æ‰ç½‘çº¿å¹¶ä¸ä¼šæ”¹å˜å®¢æˆ·ç«¯çš„ TCP è¿æ¥çŠ¶æ€(å®•æœºé‡å¯ä¼šï¼ï¼)ï¼Œå¹¶ä¸”è¿˜æ˜¯å¤„äº `ESTABLISHED `çŠ¶æ€ï¼Œæ‰€ä»¥è¿™æ—¶å®¢æˆ·ç«¯æ˜¯å¯ä»¥æ­£å¸¸æ¥æ”¶æœåŠ¡ç«¯å‘æ¥çš„æ•°æ®æŠ¥æ–‡çš„**ï¼Œç„¶åå®¢æˆ·ç«¯å°±ä¼šå›é€ `ACK` å“åº”æŠ¥æ–‡;**å¦‚æœåœ¨æœåŠ¡ç«¯é‡ä¼ æŠ¥æ–‡çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯ä¸€ç›´æ²¡æœ‰å°†ç½‘çº¿æ’å›å»**ï¼ŒæœåŠ¡ç«¯è¶…æ—¶é‡ä¼ æŠ¥æ–‡çš„æ¬¡æ•°è¾¾åˆ°ä¸€å®šé˜ˆå€¼åï¼Œå†…æ ¸å°±ä¼šåˆ¤å®šå‡ºè¯¥ TCP æœ‰é—®é¢˜ï¼Œç„¶åé€šè¿‡ Socket æ¥å£å‘Šè¯‰åº”ç”¨ç¨‹åºè¯¥ TCP è¿æ¥å‡ºé—®é¢˜äº†ï¼Œäºæ˜¯æœåŠ¡ç«¯çš„ TCP è¿æ¥å°±ä¼šæ–­å¼€ã€‚è€Œç­‰å®¢æˆ·ç«¯æ’å›ç½‘çº¿åï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€äº†æ•°æ®ï¼Œç”±äºæœåŠ¡ç«¯å·²ç»æ²¡æœ‰ä¸å®¢æˆ·ç«¯ç›¸åŒå››å…ƒç»„çš„ TCP è¿æ¥äº†ï¼Œå› æ­¤æœåŠ¡ç«¯å†…æ ¸å°±ä¼šå›å¤ `RST` æŠ¥æ–‡ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åå°±ä¼šé‡Šæ”¾è¯¥ TCP è¿æ¥


2. æ‹”æ‰ç½‘çº¿åï¼Œæ²¡æœ‰æ•°æ®ä¼ è¾“:

**é’ˆå¯¹æ‹”æ‰ç½‘çº¿åï¼Œæ²¡æœ‰æ•°æ®ä¼ è¾“çš„åœºæ™¯ï¼Œè¿˜å¾—çœ‹æ˜¯å¦å¼€å¯äº† TCP `keep-alive` æœºåˆ¶ ï¼ˆTCP ä¿æ´»ï¼‰**ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯TCP `keepalive`æœºåˆ¶ï¼Œåœ¨å®¢æˆ·ç«¯æ‹”æ‰ç½‘çº¿åï¼Œå¹¶ä¸”åŒæ–¹éƒ½æ²¡æœ‰è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ TCP è¿æ¥å°†ä¼šä¸€ç›´ä¿æŒå­˜åœ¨;å¦‚æœå¼€å¯äº† TCP çš„`keepalive` æœºåˆ¶ï¼Œåœ¨å®¢æˆ·ç«¯æ‹”æ‰ç½‘çº¿åï¼Œå³ä½¿åŒæ–¹éƒ½æ²¡æœ‰è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œåœ¨æŒç»­ä¸€æ®µæ—¶é—´å TCP å°±ä¼šå‘é€æ¢æµ‹æŠ¥æ–‡

- å¦‚æœ**å¯¹ç«¯æ­£å¸¸å·¥ä½œ**,å½“ TCP ä¿æ´»çš„æ¢æµ‹æŠ¥æ–‡å‘é€ç»™å¯¹ç«¯, å¯¹ç«¯ä¼šæ­£å¸¸å“åº”ï¼Œè¿™æ ·**TCP ä¿æ´»æ—¶é—´å™¨ä¼šè¢«é‡ç½®**ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ª TCP ä¿æ´»æ—¶é—´çš„åˆ°æ¥
- å¦‚æœ**å¯¹ç«¯ä¸»æœºå®•æœºï¼ˆåŒºåˆ†è¿›ç¨‹å´©æºƒï¼Œè¿›ç¨‹å´©æºƒä¼šå‘é€finæŠ¥æ–‡ï¼‰**ï¼Œå½“ TCP ä¿æ´»çš„æ¢æµ‹æŠ¥æ–‡å‘é€ç»™å¯¹ç«¯åæ²¡æœ‰å“åº”ï¼Œè¿ç»­å‡ æ¬¡è¾¾åˆ°ä¿æ´»æ¢æµ‹æ¬¡æ•°ï¼ˆ`tcp_retries`ï¼‰åï¼Œ**TCPä¼šæŠ¥å‘Šè¯¥ TCP è¿æ¥å·²ç»æ­»äº¡**,å¹¶æœ€ç»ˆæ–­å¼€è¿æ¥



#### å¯¹äºTCPé€šä¿¡ç«¯ï¼Œæ–­ç”µå’Œè¿›ç¨‹å´©æºƒæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ



å‰ææ˜¯åŒæ–¹å‡æœªå¼€å¯`Keep-Alive`

1ã€å®¢æˆ·ç«¯ä¸»æœºå´©æºƒäº†ï¼ŒæœåŠ¡ç«¯æ˜¯**æ— æ³•æ„ŸçŸ¥åˆ°çš„**ï¼Œå†åŠ ä¸ŠæœåŠ¡ç«¯æ²¡æœ‰å¼€å¯ TCP `keep-alive`ï¼Œåˆæ²¡æœ‰æ•°æ®äº¤äº’çš„æƒ…å†µä¸‹ï¼Œ**æœåŠ¡ç«¯çš„ TCP è¿æ¥å°†ä¼šä¸€ç›´å¤„äº ESTABLISHED è¿æ¥çŠ¶æ€**ï¼Œç›´åˆ°æœåŠ¡ç«¯é‡å¯è¿›ç¨‹;

2ã€å®¢æˆ·ç«¯è¿›ç¨‹å´©æºƒï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯çš„æ“ä½œç³»ç»Ÿå°±ä¼šæ„ŸçŸ¥åˆ°ï¼Œå°±ä¼šç»™æœåŠ¡ç«¯å‘é€`FIN`æŠ¥æ–‡ï¼Œç„¶åä¸å¯¹æ–¹è¿›è¡Œå››æ¬¡æŒ¥æ‰‹



é’ˆå¯¹æœ‰æ•°æ®ä¼ è¾“çš„æƒ…å†µï¼š

å®¢æˆ·ç«¯ä¸»æœºå®•æœºåï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€çš„æŠ¥æ–‡ä¼šå¾—ä¸åˆ°ä»»ä½•çš„å“åº”ï¼Œåœ¨ä¸€å®šæ—¶é•¿åï¼ŒæœåŠ¡ç«¯å°±ä¼šè§¦å‘**è¶…æ—¶é‡ä¼ **æœºåˆ¶ï¼Œé‡ä¼ æœªå¾—åˆ°å“åº”çš„æŠ¥æ–‡ï¼Œå®¢æˆ·ç«¯ä¸»æœºé‡å¯å®Œæˆåï¼Œå†…æ ¸å°±ä¼šæ¥æ”¶é‡ä¼ çš„æŠ¥æ–‡ï¼Œç„¶åæ ¹æ®æŠ¥æ–‡çš„ä¿¡æ¯ä¼ é€’ç»™å¯¹åº”çš„è¿›ç¨‹ï¼š

- å¦‚æœå®¢æˆ·ç«¯ä¸»æœºä¸Š**æ²¡æœ‰**è¿›ç¨‹ç»‘å®šè¯¥ TCP æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£å·ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å†…æ ¸å°±ä¼š**å›å¤ RST æŠ¥æ–‡ï¼Œé‡ç½®è¯¥ TCP è¿æ¥**ï¼›
- å¦‚æœå®¢æˆ·ç«¯ä¸»æœºä¸Š**æœ‰**è¿›ç¨‹ç»‘å®šè¯¥ TCP æŠ¥æ–‡çš„ç›®æ ‡ç«¯å£å·ï¼Œç”±äºå®¢æˆ·ç«¯ä¸»æœºé‡å¯åï¼Œä¹‹å‰çš„ TCP è¿æ¥çš„æ•°æ®ç»“æ„å·²ç»ä¸¢å¤±äº†ï¼Œå®¢æˆ·ç«¯å†…æ ¸é‡Œåè®®æ ˆä¼šå‘ç°æ‰¾ä¸åˆ°è¯¥ TCP è¿æ¥çš„ `socket` ç»“æ„ä½“ï¼Œäºæ˜¯å°±ä¼š**å›å¤ RST æŠ¥æ–‡ï¼Œé‡ç½®è¯¥ TCP è¿æ¥**

æ‰€ä»¥ï¼Œ**åªè¦æœ‰ä¸€æ–¹é‡å¯å®Œæˆåï¼Œæ”¶åˆ°ä¹‹å‰ TCP è¿æ¥çš„æŠ¥æ–‡ï¼Œéƒ½ä¼šå›å¤ RST æŠ¥æ–‡ï¼Œä»¥æ–­å¼€è¿æ¥**



**æ€»ç»“ï¼š**

å¦‚æœã€Œ**å®¢æˆ·ç«¯è¿›ç¨‹å´©æºƒ**ã€ï¼Œå®¢æˆ·ç«¯çš„è¿›ç¨‹åœ¨å‘ç”Ÿå´©æºƒçš„æ—¶å€™ï¼Œå†…æ ¸ä¼šå‘é€ FIN æŠ¥æ–‡ï¼Œä¸æœåŠ¡ç«¯è¿›è¡Œå››æ¬¡æŒ¥æ‰‹ã€‚

ä½†æ˜¯ã€Œ**å®¢æˆ·ç«¯ä¸»æœºå®•æœº**ã€ï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šå‘ç”Ÿå››æ¬¡æŒ¥æ‰‹çš„ï¼Œå…·ä½“åç»­ä¼šå‘ç”Ÿä»€ä¹ˆ**è¿˜è¦çœ‹æœåŠ¡ç«¯ä¼šä¸ä¼šå‘é€æ•°æ®**

- å¦‚æœæœåŠ¡ç«¯ä¼šå‘é€æ•°æ®ï¼Œç”±äºå®¢æˆ·ç«¯å·²ç»ä¸å­˜åœ¨ï¼Œæ”¶ä¸åˆ°æ•°æ®æŠ¥æ–‡çš„å“åº”æŠ¥æ–‡ï¼ŒæœåŠ¡ç«¯çš„æ•°æ®æŠ¥æ–‡ä¼šè¶…æ—¶é‡ä¼ ï¼Œå½“é‡ä¼ æ€»é—´éš”æ—¶é•¿è¾¾åˆ°ä¸€å®šé˜ˆå€¼ï¼ˆå†…æ ¸ä¼šæ ¹æ® `tcp_retries2` è®¾ç½®çš„å€¼è®¡ç®—å‡ºä¸€ä¸ªé˜ˆå€¼ï¼‰åï¼Œä¼šæ–­å¼€ TCP è¿æ¥ï¼›
- å¦‚æœæœåŠ¡ç«¯ä¸€ç›´ä¸ä¼šå‘é€æ•°æ®ï¼Œå†çœ‹æœåŠ¡ç«¯æœ‰æ²¡æœ‰å¼€å¯ TCP keepalive æœºåˆ¶ï¼Ÿ
  - å¦‚æœæœ‰å¼€å¯ï¼ŒæœåŠ¡ç«¯åœ¨ä¸€æ®µæ—¶é—´æ²¡æœ‰è¿›è¡Œæ•°æ®äº¤äº’æ—¶ï¼Œä¼šè§¦å‘ TCP keepalive æœºåˆ¶ï¼Œæ¢æµ‹å¯¹æ–¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ¢æµ‹åˆ°å¯¹æ–¹å·²ç»æ¶ˆäº¡ï¼Œåˆ™ä¼šæ–­å¼€è‡ªèº«çš„ TCP è¿æ¥ï¼›
  - å¦‚æœæ²¡æœ‰å¼€å¯ï¼ŒæœåŠ¡ç«¯çš„ TCP è¿æ¥ä¼šä¸€ç›´å­˜åœ¨ï¼Œå¹¶ä¸”ä¸€ç›´ä¿æŒåœ¨ ESTABLISHED çŠ¶æ€



#### å®¢æˆ·ç«¯/æœåŠ¡ç«¯çªç„¶å‡ºç°æ•…éšœä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

1ã€å®¢æˆ·ç«¯å‡ºç°æ•…éšœ

TCPå…·æœ‰`Keep-Alive`ä¿æ´»æœºåˆ¶,æ¯éš”ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œä¼šå‘é€šä¿¡å¯¹æ–¹å‘é€ä¸€ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œå¦‚æœè¿ç»­å‡ ä¸ªæ¢æµ‹æŠ¥æ–‡éƒ½æ²¡æœ‰å¾—åˆ°å“åº”ï¼Œåˆ™è®¤ä¸ºå½“å‰çš„ TCP è¿æ¥å·²ç»æ­»äº¡ï¼Œ**ç³»ç»Ÿå†…æ ¸å°†é”™è¯¯ä¿¡æ¯é€šçŸ¥ç»™ä¸Šå±‚åº”ç”¨ç¨‹åº**

Linux å†…æ ¸å¯ä»¥æœ‰å¯¹åº”çš„å‚æ•°å¯ä»¥è®¾ç½®**ä¿æ´»æ—¶é—´ã€ä¿æ´»æ¢æµ‹çš„æ¬¡æ•°ã€ä¿æ´»æ¢æµ‹çš„æ—¶é—´é—´éš”**ï¼Œä»¥ä¸‹å‡ä¸ºé»˜è®¤å€¼ï¼š

```shell
net.ipv4.tcp_keepalive_time=7200  
ä¿æ´»æ—¶é—´æ˜¯ 7200 ç§’ï¼ˆ2å°æ—¶ï¼‰ï¼Œ2å°æ—¶å†…å¦‚æœæ²¡æœ‰ä»»ä½•è¿æ¥ç›¸å…³çš„æ´»åŠ¨ï¼Œåˆ™ä¼šå¯åŠ¨ä¿æ´»æœºåˆ¶
net.ipv4.tcp_keepalive_intvl=75  
è¡¨ç¤ºæ¯æ¬¡æ£€æµ‹é—´éš” 75 ç§’ï¼›
net.ipv4.tcp_keepalive_probes=9
è¡¨ç¤ºæ£€æµ‹ 9 æ¬¡æ— å“åº”ï¼Œè®¤ä¸ºå¯¹æ–¹æ˜¯ä¸å¯è¾¾çš„ï¼Œä»è€Œä¸­æ–­æœ¬æ¬¡çš„è¿æ¥
```

å¼€å¯äº† TCP ä¿æ´»ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

- ç¬¬ä¸€ç§ï¼Œå¯¹ç«¯ç¨‹åºæ˜¯æ­£å¸¸å·¥ä½œçš„ï¼šå½“ TCP ä¿æ´»çš„æ¢æµ‹æŠ¥æ–‡å‘é€ç»™å¯¹ç«¯, å¯¹ç«¯ä¼šæ­£å¸¸å“åº”ï¼Œè¿™æ · **TCP ä¿æ´»æ—¶é—´ä¼šè¢«é‡ç½®**ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ª TCP ä¿æ´»æ—¶é—´çš„åˆ°æ¥
- ç¬¬äºŒç§ï¼Œå¯¹ç«¯ä¸»æœºå®•æœºå¹¶**é‡å¯**ï¼š å½“ TCP ä¿æ´»çš„æ¢æµ‹æŠ¥æ–‡å‘é€ç»™é‡å¯åçš„å¯¹ç«¯åï¼Œå¯¹ç«¯æ˜¯å¯ä»¥å“åº”çš„ï¼Œä½†ç”±äºå·²ç»æ²¡æœ‰äº†è¯¥è¿æ¥çš„æœ‰æ•ˆä¿¡æ¯ï¼Œ**ä¼šäº§ç”Ÿä¸€ä¸ª RST æŠ¥æ–‡**ï¼Œè¿™æ ·å¾ˆå¿«å°±ä¼šå‘ç° TCP è¿æ¥å·²ç»è¢«é‡ç½®
- ç¬¬ä¸‰ç§ï¼Œæ˜¯å¯¹ç«¯ä¸»æœºå®•æœºï¼ˆ*æ³¨æ„ä¸æ˜¯è¿›ç¨‹å´©æºƒï¼Œ**è¿›ç¨‹å´©æºƒåæ“ä½œç³»ç»Ÿåœ¨å›æ”¶è¿›ç¨‹èµ„æºçš„æ—¶å€™ï¼Œä¼šå‘é€ FIN æŠ¥æ–‡ï¼Œè€Œä¸»æœºå®•æœºåˆ™æ˜¯æ— æ³•æ„ŸçŸ¥çš„**ï¼Œæ‰€ä»¥éœ€è¦ TCP ä¿æ´»æœºåˆ¶æ¥æ¢æµ‹å¯¹æ–¹æ˜¯ä¸æ˜¯å‘ç”Ÿäº†ä¸»æœºå®•æœº*ï¼‰ï¼Œæˆ–å¯¹ç«¯ç”±äºå…¶ä»–åŸå› å¯¼è‡´æŠ¥æ–‡ä¸å¯è¾¾ã€‚å½“ TCP ä¿æ´»çš„æ¢æµ‹æŠ¥æ–‡å‘é€ç»™å¯¹ç«¯åï¼Œè¿ç»­å‡ æ¬¡æ²¡æœ‰å“åº”ï¼Œè¾¾åˆ°ä¿æ´»æ¢æµ‹æ¬¡æ•°åï¼Œ**TCP ä¼šæŠ¥å‘Šè¯¥ TCP è¿æ¥å·²ç»æ­»äº¡**



2ã€æœåŠ¡ç«¯å‡ºç°æ•…éšœ

TCPçš„è¿æ¥ä¿¡æ¯æ˜¯ç”±**å†…æ ¸**ç»´æŠ¤çš„ï¼Œæ‰€ä»¥**å½“æœåŠ¡ç«¯çš„è¿›ç¨‹å´©æºƒå**ï¼Œ**å†…æ ¸éœ€è¦å›æ”¶è¯¥è¿›ç¨‹çš„æ‰€æœ‰ TCP è¿æ¥èµ„æºï¼Œäºæ˜¯å†…æ ¸ä¼šå‘é€ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ `FIN` æŠ¥æ–‡ï¼Œåç»­çš„æŒ¥æ‰‹è¿‡ç¨‹ä¹Ÿéƒ½æ˜¯åœ¨å†…æ ¸å®Œæˆï¼Œå¹¶ä¸éœ€è¦è¿›ç¨‹çš„å‚ä¸**ï¼Œæ‰€ä»¥å³ä½¿æœåŠ¡ç«¯è¿›ç¨‹å´©æºƒï¼Œè¿˜æ˜¯èƒ½ä¸å®¢æˆ·ç«¯å®Œæˆ `TCP` å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹







#### æœåŠ¡ç«¯æ²¡æœ‰ç›‘å¬ï¼Œè‹¥å®¢æˆ·ç«¯å‘èµ·è¿æ¥å»ºç«‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

**æœåŠ¡ç«¯å¦‚æœåª `bind` äº† IP åœ°å€å’Œç«¯å£ï¼Œè€Œæ²¡æœ‰è°ƒç”¨ `listen` çš„è¯ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯å‘èµ·äº†è¿æ¥å»ºç«‹ï¼ŒæœåŠ¡ç«¯ä¼šå› `RST` æŠ¥æ–‡**





### é‡ä¼ æœºåˆ¶



1ã€è¶…æ—¶é‡ä¼ 

åœ¨å‘é€æ•°æ®æ—¶ï¼Œè®¾å®šä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“è¶…è¿‡æŒ‡å®šçš„æ—¶é—´åï¼Œæ²¡æœ‰æ”¶åˆ°å¯¹æ–¹çš„ `ACK` ç¡®è®¤åº”ç­”æŠ¥æ–‡ï¼Œå°±ä¼šé‡å‘è¯¥æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„**è¶…æ—¶é‡ä¼ **ï¼Œè¶…æ—¶é‡ä¼ æ—¶é—´`RTO`åº”è¯¥**ç•¥å¤§äº**`RTT`(å¾€è¿”æ—¶å»¶)çš„å€¼



2ã€å¿«é‡ä¼ 

å¿«é‡ä¼ **ä¸ä»¥æ—¶é—´ä¸ºé©±åŠ¨ï¼Œè€Œæ˜¯ä»¥æ•°æ®é©±åŠ¨é‡ä¼ **ï¼Œå¿«é€Ÿé‡ä¼ çš„å·¥ä½œæ–¹å¼æ˜¯å½“æ”¶åˆ°ä¸‰ä¸ªç›¸åŒçš„ ACK æŠ¥æ–‡æ—¶ï¼Œä¼šåœ¨å®šæ—¶å™¨è¿‡æœŸä¹‹å‰ï¼Œé‡ä¼ ä¸¢å¤±çš„æŠ¥æ–‡æ®µï¼Œä¾‹å¦‚å‘é€æ–¹å…ˆå‘é€ï¼Œseq1æ¥æ”¶æ–¹æ”¶åˆ°ï¼Œéšåçš„seq2ä¸¢å¤±ï¼Œæ¥æ”¶æ–¹è¿”å›ack2(è¡¨ç¤ºæ”¶åˆ°seq2ä¹‹å‰çš„æ•°æ®),å‘é€æ–¹åœ¨æ”¶åˆ°ack2ä¹‹å‰åˆæ¥è¿å‘é€äº†seq3ã€seq4,è€Œæ¥æ”¶æ–¹åœ¨æ”¶åˆ°è¿™ä¸¤ä¸ªseqåä¾ç„¶è¦è¿”å›ack2ï¼Œè¿™æ ·å‘é€æ–¹æ¥è¿æ”¶åˆ°ä¸‰ä¸ªç›¸åŒçš„ack2ï¼Œ**å°±ä¼šåœ¨å®šæ—¶å™¨è¿‡æœŸä¹‹å‰ï¼Œé‡ä¼ ä¸¢å¤±çš„ Seq2**

æ³¨æ„ï¼šACKä¸­çš„åºåˆ—å·å‘Šè¯‰å‘é€ç«¯ï¼Œæ¥æ”¶ç«¯å·²ç»æˆåŠŸæ¥æ”¶åˆ°äº†åºåˆ—å·å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®åŒ…ï¼Œä¸‹ä¸€ä¸ªæœŸæœ›æ¥æ”¶çš„æ•°æ®åŒ…çš„åºåˆ—å·æ˜¯å¤šå°‘ã€‚

3ã€S-ACK(Selected-ACK) ååŒåŸACKå®ç°é‡ä¼ ç¡®è®¤

**é€‰æ‹©æ€§ç¡®è®¤**éœ€è¦åœ¨ TCP å¤´éƒ¨ã€Œé€‰é¡¹ã€å­—æ®µé‡ŒåŠ ä¸€ä¸ª `SACK` çš„ä¸œè¥¿ï¼Œå®ƒ**å¯ä»¥å°†å·²æ”¶åˆ°çš„æ•°æ®çš„ä¿¡æ¯å‘é€ç»™ã€Œå‘é€æ–¹ã€**ï¼Œè¿™æ ·å‘é€æ–¹å°±å¯ä»¥çŸ¥é“å“ªäº›æ•°æ®æ”¶åˆ°äº†ï¼Œå“ªäº›æ•°æ®æ²¡æ”¶åˆ°ï¼ŒçŸ¥é“äº†è¿™äº›ä¿¡æ¯ï¼Œå°±å¯ä»¥**åªé‡ä¼ ä¸¢å¤±çš„æ•°æ®**

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/sack.webp" alt="SACK" style="zoom: 67%;" />



TCPæ¥æ”¶ç«¯ä¼šæœ‰ä¸€ä¸ªæ¥æ”¶ç¼“å†²åŒºï¼Œå½“æ”¶åˆ°ä¸éœ€è¦çš„`segment`æ—¶ï¼Œä¼šå…ˆç¼“å­˜èµ·æ¥ï¼Œç›´åˆ°åé¢ç¼ºå¤±çš„ä¸¢å¤±æŠ¥æ–‡åˆ°è¾¾åå†è¿›è¡Œ**å»¶æ—¶ç¡®è®¤**ï¼ŒåŠ å…¥`S-ACK`çš„å¥½å¤„å°±æ˜¯TCPçš„å‘é€ç«¯åªéœ€è¦å‘é€ä¸¢å¤±çš„é‚£ä¸€æ®µæŠ¥æ–‡



4ã€ Duplicate-SACK



[D-SACK](https://xiaolincoding.com/network/3_tcp/tcp_feature.html#duplicate-sack)

### æ‹¥å¡æ§åˆ¶ç®—æ³•

æµé‡æ§åˆ¶æ˜¯é¿å…ã€Œå‘é€æ–¹ã€çš„æ•°æ®å¡«æ»¡ã€Œæ¥æ”¶æ–¹ã€çš„ç¼“å­˜,æ˜¯ç‚¹å¯¹ç‚¹çš„ï¼Œè€Œæ‹¥å¡æ§åˆ¶åˆ™æ˜¯é’ˆå¯¹å…¨å±€,å‘é€çª—å£ `swnd` å’Œæ¥æ”¶çª—å£ `rwnd` æ˜¯çº¦ç­‰äºçš„å…³ç³»ï¼ŒåŠ å…¥äº†æ‹¥å¡çª—å£çš„æ¦‚å¿µåï¼Œå‘é€çª—å£çš„å€¼æ˜¯`swnd = min(cwnd, rwnd)`ï¼Œä¹Ÿå°±æ˜¯æ‹¥å¡çª—å£å’Œæ¥æ”¶çª—å£ä¸­çš„æœ€å°å€¼,æ‹¥å¡çª—å£ `cwnd` å˜åŒ–çš„è§„åˆ™ä¸ºï¼š

- åªè¦ç½‘ç»œä¸­æ²¡æœ‰å‡ºç°æ‹¥å¡(æ”¶åˆ°ä¸€ä¸ªACKæŠ¥æ–‡)ï¼Œ`cwnd` å°±ä¼šå¢å¤§ï¼›
- ä½†ç½‘ç»œä¸­å‡ºç°äº†æ‹¥å¡ï¼Œ`cwnd` å°±å‡å°‘ï¼›



æ…¢å¯åŠ¨ç®—æ³•ï¼š**å½“å‘é€æ–¹æ¯æ”¶åˆ°ä¸€ä¸ª ACKï¼Œæ‹¥å¡çª—å£ cwnd çš„å¤§å°å°±ä¼šåŠ  1  cwnd++ â€”â€”>swnd=cwnd;æ•…å‘é€æ–¹çš„å‘é€çª—å£å¤§å°+1ï¼› **

**æ‹¥å¡é¿å…**ç®—æ³•ï¼šå½“æ‹¥å¡çª—å£ `cwnd` ã€Œè¶…è¿‡ã€æ…¢å¯åŠ¨é—¨é™ `ssthresh` å°±ä¼šè¿›å…¥æ‹¥å¡é¿å…ç®—æ³•ï¼Œæ­¤æ—¶**æ¯å½“æ”¶åˆ°ä¸€ä¸ª ACK æ—¶ï¼Œcwnd å¢åŠ  1/cwnd**



cwndè¿™ä¹ˆä¸€ç›´å¢é•¿ç€åï¼Œç½‘ç»œå°±ä¼šæ…¢æ…¢è¿›å…¥äº†æ‹¥å¡çš„çŠ¶å†µäº†ï¼Œäºæ˜¯å°±ä¼šå‡ºç°ä¸¢åŒ…ç°è±¡ï¼Œè¿™æ—¶å°±éœ€è¦å¯¹ä¸¢å¤±çš„æ•°æ®åŒ…è¿›è¡Œé‡ä¼ ã€‚å½“è§¦å‘äº†é‡ä¼ æœºåˆ¶ï¼Œä¹Ÿå°±è¿›å…¥äº†ã€Œæ‹¥å¡å‘ç”Ÿç®—æ³•ã€ï¼š



æœ€å¼€å§‹çš„æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…ç®—æ³•å°±ä¸å†èµ˜è¿°ï¼Œé‡ç‚¹åœ¨äºæ‹¥å¡å‘ç”Ÿæ—¶é‡‡ç”¨çš„ç®—æ³•ï¼Œè¦åˆ†æƒ…å†µè®¨è®ºï¼š

1. å¦‚æœå‘ç”Ÿçš„æ˜¯è¶…æ—¶é‡ä¼ ï¼Œè¯´æ˜å½“å‰ç½‘ç»œæ‹¥å¡ç¨‹åº¦å·²ç»æ¯”è¾ƒä¸¥é‡ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ…¢å¯åŠ¨é—¨é™`ssthresh` å’Œ æ‹¥å¡çª—å£`cwnd` çš„å€¼ä¼šå‘ç”Ÿå˜åŒ–ï¼š

- `ssthresh` è®¾ä¸º `cwnd/2`ï¼Œ
- `cwnd` é‡ç½®ä¸º `1` ï¼ˆå®é™…ä¸Šæ˜¯æ¢å¤ä¸º `cwnd` åˆå§‹åŒ–å€¼ï¼‰

æ¥ç€ï¼Œ**é‡æ–°å¼€å§‹æ…¢å¯åŠ¨ç®—æ³•**ï¼Œ**æ…¢å¯åŠ¨ä¼šçªç„¶å‡å°‘æ•°æ®æµçš„ï¼Œé€ æˆç½‘ç»œå¡é¡¿**



2. å¦‚æœå‘ç”Ÿçš„æ˜¯å¿«é€Ÿé‡ä¼ ï¼ˆ**å³å‘é€ç«¯è¿ç»­æ”¶åˆ°ä¸‰ä¸ªé‡å¤ACKï¼Œå‘é€ç«¯å°±ä¼šå¿«é€Ÿåœ°é‡ä¼ ï¼Œä¸å¿…ç­‰å¾…è¶…æ—¶å†é‡ä¼ **ï¼‰ï¼Œè¯´æ˜ç½‘ç»œæ‹¥å¡æƒ…å†µä¸ç®—ä¸¥é‡ï¼ˆå› ä¸ºè¿˜èƒ½æ”¶åˆ°å¯¹æ–¹çš„ACKï¼‰ï¼Œåˆ™`ssthresh` å’Œ `cwnd` å˜åŒ–å¦‚ä¸‹ï¼š

- `cwnd = cwnd/2` ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®ä¸ºåŸæ¥çš„ä¸€åŠ;
- `ssthresh = cwnd`;
- è¿›å…¥å¿«é€Ÿæ¢å¤ç®—æ³•ï¼›

ç„¶åï¼Œè¿›å…¥å¿«é€Ÿæ¢å¤ç®—æ³•å¦‚ä¸‹ï¼š

- æ‹¥å¡çª—å£ `cwnd = ssthresh + 3` ï¼ˆ3 çš„æ„æ€æ˜¯åœ¨è¿›å…¥æ‹¥å¡é¿å…ç®—æ³•å‰å·²ç»æœ‰3ä¸ª ACK æ•°æ®åŒ…è¢«æ”¶åˆ°äº†ï¼Œæ ¹æ®æ…¢å¯åŠ¨åŸç†ï¼Œæ¯æ”¶åˆ°ä¸€ä¸ªACKå°±è¦åŠ 1 æ•…ä¸º3ï¼‰ï¼›
- é‡ä¼ ä¸¢å¤±çš„æ•°æ®
- å¦‚æœå†æ”¶åˆ°é‡å¤çš„ ACKï¼Œé‚£ä¹ˆ cwnd å¢åŠ  1 ï¼›:zipper_mouth_face:
- å¦‚æœæ”¶åˆ°æ–°æ•°æ®çš„ ACK åï¼Œ**æŠŠ cwnd è®¾ç½®ä¸ºç¬¬ä¸€æ­¥ä¸­çš„ ssthresh çš„å€¼**ï¼ŒåŸå› æ˜¯è¯¥ ACK ç¡®è®¤äº†æ–°çš„æ•°æ®ï¼Œè¯´æ˜ä» `duplicated ACK` æ—¶çš„æ•°æ®éƒ½å·²æ”¶åˆ°ï¼Œè¯¥æ¢å¤è¿‡ç¨‹å·²ç»ç»“æŸï¼Œå¯ä»¥å›åˆ°æ¢å¤ä¹‹å‰çš„çŠ¶æ€äº†ï¼Œä¹Ÿå³å†æ¬¡è¿›å…¥æ‹¥å¡é¿å…çŠ¶æ€ï¼›

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%8B%A5%E5%A1%9E%E5%8F%91%E7%94%9F-%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0.drawio.webp" style="zoom:80%;" />







### ç²˜åŒ…é—®é¢˜



TCPæ˜¯é¢å‘å­—èŠ‚æµçš„åè®®ï¼Œä¼ è¾“åˆ°ç¼“å†²åŒºæ—¶åé¢ä¸€åŒ…æ•°æ®ç´§æ¥ç€å‰ä¸€åŒ…æ•°æ®çš„å°¾å·´ã€‚

- **åŸå› **ï¼š
  - ç”±äº TCP è¿æ¥å¤ç”¨é€ æˆï¼›
  - å› ä¸º TCP é»˜è®¤ä¼šä½¿ç”¨ `Nagle` ç®—æ³•ï¼Œè¯¥ç®—æ³•ä¼šå¯¼è‡´ç²˜åŒ…ï¼ˆä¸ºäº†å‡å°‘å°åˆ†ç»„æ•°ç›®ï¼Œä»è€Œå‡å°‘ç½‘ç»œæ‹¥å¡ï¼‰ï¼›
  - **æ•°æ®åŒ…è¿‡å¤§**ï¼›
  - ç½‘ç»œå»¶è¿Ÿå’Œæ‹¥å µï¼šå¦‚æœç½‘ç»œä¸­å­˜åœ¨è¾ƒå¤§çš„å»¶è¿Ÿæˆ–è€…æ‹¥å µï¼Œæ•°æ®åŒ…å¯èƒ½ä¼šè¢«ç¼“å­˜åˆ°æ¥æ”¶æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä¸­ï¼Œä»è€Œå¯¼è‡´å¤šä¸ªæ•°æ®åŒ…åˆå¹¶æˆä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®åŒ…ã€‚å³æ¥æ”¶æ–¹ä¸åŠæ—¶æ¥æ”¶ç¼“å†²åŒºçš„åŒ…ï¼Œé€ æˆå¤šä¸ªåŒ…æ¥æ”¶ã€‚
- è§£å†³æ–¹æ¡ˆï¼š
  - å…³é—­ Nagle ç®—æ³•
  - å°¾éƒ¨æ ‡è®°åºåˆ—ï¼ŒåŠ ä¸€ä¸ªç»“æŸç¬¦è¡¨ç¤ºåŒ…ç»“æŸäº†
  - å¤´éƒ¨æ ‡è®°åˆ†æ­¥éª¤æ¥æ”¶ï¼Œåœ¨ TCP æŠ¥æ–‡å¤´éƒ¨å­—æ®µåŠ ä¸€ä¸ªè¡¨ç¤ºåŒ…é•¿åº¦çš„å­—æ®µ
  - æ¶ˆæ¯é•¿åº¦å›ºå®šï¼šåœ¨æ¯ä¸ªæ•°æ®åŒ…çš„å¤´éƒ¨æ·»åŠ å›ºå®šé•¿åº¦çš„æŠ¥æ–‡å¤´ï¼ŒæŠ¥æ–‡å¤´ä¸­åŒ…å«æŠ¥æ–‡çš„é•¿åº¦ä¿¡æ¯ï¼Œæ¥æ”¶æ–¹å…ˆè¯»å–æŠ¥æ–‡å¤´ï¼Œç„¶åæ ¹æ®é•¿åº¦ä¿¡æ¯æ­£ç¡®åˆ’åˆ†å’Œå¤„ç†æ•°æ®
  - åº”ç”¨å±‚åè®®ï¼šåœ¨åº”ç”¨å±‚ä¸Šè®¾è®¡ä¸€ç§åè®®ï¼Œå°†æ•°æ®åŒ…è£…æˆç‹¬ç«‹çš„æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒ…å«æ•°æ®çš„é•¿åº¦ä¿¡æ¯æˆ–å…¶ä»–è¾…åŠ©ä¿¡æ¯

> `Nagle`ç®—æ³•æ˜¯ä¸€ç§ç”¨äºå‡å°‘å°æ•°æ®åŒ…å‘é€çš„ç½‘ç»œä¼˜åŒ–ç®—æ³•ã€‚å®ƒåœ¨TCPåè®®ä¸­å®ç°ï¼Œæ—¨åœ¨å‡å°‘ç½‘ç»œæ‹¥å¡å’Œæé«˜ç½‘ç»œååé‡
>
> 
>
> TCPåè®®æ˜¯ä¸€ç§å¯é çš„é¢å‘è¿æ¥çš„åè®®ï¼Œå®ƒå°†æ•°æ®åˆ‡åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„æ•°æ®åŒ…è¿›è¡Œä¼ è¾“ã€‚`Nagle`ç®—æ³•çš„ä¸»è¦æ€æƒ³æ˜¯å°†å¤šä¸ªå°æ•°æ®åŒ…åˆå¹¶æˆä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®åŒ…è¿›è¡Œå‘é€ï¼Œä»¥å‡å°‘ç½‘ç»œä¼ è¾“çš„å¼€é”€ã€‚
>
> `Nagle`ç®—æ³•çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š
>
> 1. å½“åº”ç”¨ç¨‹åºå‘é€æ•°æ®æ—¶ï¼ŒTCPå…ˆå°†æ•°æ®æ”¾å…¥å‘é€ç¼“å†²åŒºã€‚
> 2. TCPç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆä¸€èˆ¬æ˜¯200æ¯«ç§’ï¼‰ï¼Œçœ‹æ˜¯å¦æœ‰æ›´å¤šæ•°æ®åˆ°è¾¾ã€‚å¦‚æœæœ‰æ›´å¤šæ•°æ®ï¼Œåˆ™ç»§ç»­ç­‰å¾…ã€‚
> 3. å¦‚æœ**ç­‰å¾…æ—¶é—´åˆ°è¾¾æˆ–ç¼“å†²åŒºä¸­çš„æ•°æ®è¾¾åˆ°ä¸€å®šå¤§å°ï¼ˆä¸€èˆ¬æ˜¯MSSï¼Œæœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦ï¼‰**ï¼ŒTCPå°±ä¼šå°†ç¼“å†²åŒºä¸­çš„æ•°æ®ä¸€å¹¶å‘é€ç»™æ¥æ”¶æ–¹(**è¿™å°±å¯¼è‡´å¤šä¸ªå°æŠ¥æ–‡æ®µè¢«åˆå¹¶æˆäº†ä¸€ä¸ªå¤§æŠ¥æ–‡æ®µï¼Œæ¥æ”¶æ–¹æ”¶åˆ°å¤§æŠ¥æ–‡æ®µæ—¶å°±æ— æ³•åŒºåˆ†è¾¹ç•Œ**)
>
> è¿™ç§åˆå¹¶æ•°æ®åŒ…çš„æ–¹å¼å¯ä»¥å‡å°‘ç½‘ç»œä¸­çš„å°æ•°æ®åŒ…æ•°é‡ï¼Œä»è€Œå‡å°‘ç½‘ç»œçš„ä¼ è¾“å¼€é”€å’Œé™ä½ç½‘ç»œæ‹¥å¡çš„å¯èƒ½æ€§









#  æ“ä½œç³»ç»Ÿ





## è¿›ç¨‹ç®¡ç†









## å†…å­˜ç®¡ç†







# æ•°æ®ç»“æ„ä¸ç®—æ³•



## æ’åºç®—æ³•





### å¿«é€Ÿæ’åº





### å †æ’åº





### å½’å¹¶æ’åº







## é›ªèŠ±ç®—æ³•

ä¼ ç»Ÿé›ªèŠ±ç®—æ³•çš„å®ç°å¦‚ä¸‹ï¼š

```java
public class IdWorker{

    private long workerId;
    private long datacenterId;
    private long sequence;

    public IdWorker(long workerId, long datacenterId, long sequence){
        // sanity check for workerId
        if (workerId > maxWorkerId || workerId < 0) {
            throw new IllegalArgumentException(String.format("worker Id can't be greater than %d or less than 0",maxWorkerId));
        }
        if (datacenterId > maxDatacenterId || datacenterId < 0) {
            throw new IllegalArgumentException(String.format("datacenter Id can't be greater than %d or less than 0",maxDatacenterId));
        }
        System.out.printf("worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d",
                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, workerId);

        this.workerId = workerId;
        this.datacenterId = datacenterId;
        this.sequence = sequence;
    }

    private long twepoch = 1288834974657L; //èµ·å§‹æ—¶é—´æˆ³,ç”¨äºç”¨å½“å‰æ—¶é—´æˆ³å‡å»è¿™ä¸ªæ—¶é—´æˆ³ï¼Œç®—å‡ºåç§»é‡

    private long workerIdBits = 5L; //workerå çš„ä½æ•°
    private long datacenterIdBits = 5L; //datacenterå çš„ä½æ•°


    /*
    00000000 00000000 00000000 00000001 //åŸç ï¼š1çš„äºŒè¿›åˆ¶
    11111111 11111111 11111111 11111110 //å–åç ï¼š1çš„äºŒè¿›åˆ¶çš„åç 
    11111111 11111111 11111111 11111111 //åŠ 1ï¼š-1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰

    -1 çš„äºŒè¿›åˆ¶è¡¨ç¤º å…ˆå·¦ç§» 5ä½ï¼Œå¾—åˆ°ç»“æœa;
    å†è®© -1 å¼‚æˆ– a;
     */
    private long maxWorkerId = -1L ^ (-1L << workerIdBits); //åˆ©ç”¨ä½è¿ç®—è®¡ç®—å‡º5ä½èƒ½è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯31
    private long maxDatacenterId = -1L ^ (-1L << datacenterIdBits);//åŒç†
    private long sequenceBits = 12L;//åŒä¸€æœºå™¨åŒä¸€æ—¶é—´æˆªï¼ˆæ¯«ç§’)çš„å¹¶å‘æ•°æ‰€å ä½æ•°


    //åç§»é‡
    private long workerIdShift = sequenceBits; //12
    private long datacenterIdShift = sequenceBits + workerIdBits; //17
    private long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits; //22
    private long sequenceMask = -1L ^ (-1L << sequenceBits);  //4095    ä¸ºäº†é˜²æ­¢æº¢å‡º

    private long lastTimestamp = -1L; //å¯¹æ¯”çš„ä¸Šä¸€æ¬¡æ—¶é—´æˆ³ï¼Œèµ·å§‹å€¼ä¸ºæœ€å°å€¼

    public long getWorkerId(){
        return workerId;
    }

    public long getDatacenterId(){
        return datacenterId;
    }

    public long getTimestamp(){
        return System.currentTimeMillis();
    }


    // ç”Ÿæˆä¸‹ä¸€ä¸ªå”¯ä¸€ID
    public synchronized long nextId() {
        long timestamp = timeGen();//è·å–å½“å‰æ—¶é—´æˆ³

        //å½“å‰æ—¶é—´æˆ³<ä¸Šä¸€æ¬¡è·å–åˆ°çš„æ—¶é—´æˆ³ â€”â€” å‘ç”Ÿäº†æ—¶é’Ÿå›æ‹¨
        if (timestamp < lastTimestamp) {
            System.err.printf("clock is moving backwards.  Rejecting requests until %d.", lastTimestamp);
            throw new RuntimeException(String.format("Clock moved backwards.  Refusing to generate id for %d milliseconds",
                    lastTimestamp - timestamp));
        }

        //å¦‚æœä¸¤æ¬¡ç”Ÿæˆidæ˜¯åœ¨åŒä¸€æ¯«ç§’å†…
        if (lastTimestamp == timestamp) {
            sequence = (sequence + 1) & sequenceMask; //å¹¶å‘æ•°+1
            if (sequence == 0) {                  //4095+1=4096
                timestamp = tilNextMillis(lastTimestamp); //æ›´æ–°æ—¶é—´æˆ³ è¿›å…¥åˆ°ä¸‹ä¸€æ¯«ç§’
            }
        }
        //å¦‚æœå½“å‰æ—¶é—´æˆ³ä¸åŒï¼Œè¯´æ˜å·²ç»è¿›å…¥äº†ä¸‹ä¸€æ¯«ç§’ï¼Œåºåˆ—å·é‡æ–°å½’é›¶ã€‚
        else
        {
            sequence = 0;
        }

        lastTimestamp = timestamp;  //å°†å½“å‰æ—¶é—´æˆ³è®°å½•ä¸ºä¸Šä¸€æ¬¡çš„æ—¶é—´æˆ³ï¼Œä»¥å¤‡ä¸‹ä¸€æ¬¡ç”ŸæˆIDæ—¶ä½¿ç”¨ã€‚

        // å°†å„ä¸ªéƒ¨åˆ†ç»„åˆæˆæœ€ç»ˆçš„ID â€”â€”å…ˆå°†æ¯éƒ¨åˆ†å·¦ç§»è‡³å¯¹åº”éƒ¨åˆ†ï¼Œç„¶åå„éƒ¨åˆ†é€šè¿‡æˆ–è¿ç®—å¾—åˆ°æœ€ç»ˆç»“æœ
        return ((timestamp - twepoch) << timestampLeftShift) |
                (datacenterId << datacenterIdShift) |
                (workerId << workerIdShift) |
                sequence;
    }


    // åœ¨å½“å‰æ—¶é—´æˆ³åŸºç¡€ä¸Šç­‰å¾…ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ¯«ç§’
    private long tilNextMillis(long lastTimestamp) {

        long timestamp = timeGen();
        while (timestamp <= lastTimestamp) {
            timestamp = timeGen();
        }
        return timestamp;
    }


    //è¿”å›å½“å‰æ—¶é—´æˆ³
    private long timeGen(){
        return System.currentTimeMillis();
    }


    //---------------æµ‹è¯•---------------
    public static void main(String[] args) {
        IdWorker worker = new IdWorker(1,1,1);
        for (int i = 0; i < 30; i++) {
            System.out.println(worker.nextId()+"ç¬¬"+i+"æ¬¡ç”Ÿæˆ");
        }
    }
}
```

åœ¨è®¡ç®—æœºä¸­ï¼Œè´Ÿæ•°çš„äºŒè¿›åˆ¶æ˜¯ç”¨`è¡¥ç `æ¥è¡¨ç¤ºçš„ã€‚
å‡è®¾æˆ‘æ˜¯ç”¨Javaä¸­çš„intç±»å‹æ¥å­˜å‚¨æ•°å­—çš„ï¼Œ
intç±»å‹çš„å¤§å°æ˜¯32ä¸ªäºŒè¿›åˆ¶ä½ï¼ˆbitï¼‰ï¼Œå³4ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰ã€‚ï¼ˆ1 byte = 8 bitï¼‰
é‚£ä¹ˆåè¿›åˆ¶æ•°å­—`3`åœ¨äºŒè¿›åˆ¶ä¸­çš„è¡¨ç¤ºåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```
00000000 00000000 00000000 00000011
// 3çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå°±æ˜¯åŸç 
```

**è¡¥ç çš„æ„ä¹‰å°±æ˜¯å¯ä»¥æ‹¿è¡¥ç å’ŒåŸç ï¼ˆ3çš„äºŒè¿›åˆ¶ï¼‰ç›¸åŠ ï¼Œæœ€ç»ˆåŠ å‡ºä¸€ä¸ªâ€œæº¢å‡ºçš„0â€**

å› æ­¤`-1`çš„äºŒè¿›åˆ¶åº”è¯¥è¿™æ ·ç®—ï¼š

```
00000000 00000000 00000000 00000001 //åŸç ï¼š1çš„äºŒè¿›åˆ¶
11111111 11111111 11111111 11111110 //å–åç ï¼š1çš„äºŒè¿›åˆ¶çš„åç 
11111111 11111111 11111111 11111111 //åŠ 1ï¼š-1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰
```

çŸ¥é“ä¸Šè¿°çŸ¥è¯†åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹è¿™æ®µä»£ç ï¼š

```java
    private long workerIdBits = 5L;
    private long maxWorkerId = -1L ^ (-1L << workerIdBits);       
```

`long maxWorkerId = -1L ^ (-1L << 5L)`çš„äºŒè¿›åˆ¶è¿ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š

**-1 å·¦ç§» 5ï¼Œå¾—ç»“æœa ï¼š**

```apache
        11111111 11111111 11111111 11111111 //-1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰
  11111 11111111 11111111 11111111 11100000 //é«˜ä½æº¢å‡ºçš„ä¸è¦ï¼Œä½ä½è¡¥0
        11111111 11111111 11111111 11100000 //ç»“æœa
```

**-1 å¼‚æˆ– a ï¼š**

```apache
        11111111 11111111 11111111 11111111 //-1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰
    ^   11111111 11111111 11111111 11100000 //ä¸¤ä¸ªæ“ä½œæ•°çš„ä½ä¸­ï¼Œç›¸åŒåˆ™ä¸º0ï¼Œä¸åŒåˆ™ä¸º1
---------------------------------------------------------------------------
        00000000 00000000 00000000 00011111 //æœ€ç»ˆç»“æœ31
```

é‚£æ—¢ç„¶ç°åœ¨çŸ¥é“ç®—å‡ºæ¥`long maxWorkerId = -1L ^ (-1L << 5L)`ä¸­çš„`maxWorkerId = 31`ï¼Œæœ‰ä»€ä¹ˆå«ä¹‰ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨å·¦ç§»5æ¥ç®—ï¼Ÿå¦‚æœä½ çœ‹è¿‡`æ¦‚è¿°`éƒ¨åˆ†ï¼Œè¯·æ‰¾åˆ°è¿™æ®µå†…å®¹çœ‹çœ‹ï¼š

> `5ä½ï¼ˆbitï¼‰`å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯$2^{5}-1 = 31$ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€....31è¿™32ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºä¸åŒçš„datecenterIdæˆ–workerId

-1L ^ (-1L << 5L)ç»“æœæ˜¯31ï¼Œ$2^{5}-1$çš„ç»“æœä¹Ÿæ˜¯31ï¼Œæ‰€ä»¥åœ¨ä»£ç ä¸­ï¼Œ`-1L ^ (-1L << 5L)`çš„å†™æ³•æ˜¯åˆ©ç”¨ä½è¿ç®—è®¡ç®—å‡º5ä½èƒ½è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯å¤šå°‘



å†çœ‹æœ€åå¾—åˆ°æœ€ç»ˆç»“æœçš„è¿™å—ä»£ç å®ç°ï¼š

```java
 return ((timestamp - twepoch) << timestampLeftShift) |
                (datacenterId << datacenterIdShift) |
                (workerId << workerIdShift) |
                sequence;
```

å®ƒå¯¹å„ä¸ªéƒ¨åˆ†ï¼ˆæ—¶é—´æˆ³ã€æ•°æ®ä¸­å¿ƒIDã€å·¥ä½œèŠ‚ç‚¹IDå’Œåºåˆ—å·ï¼‰è¿›è¡Œä½è¿ç®—ï¼Œç„¶åé€šè¿‡æˆ–è¿ç®—è¿›è¡Œç»„åˆï¼Œç”Ÿæˆä¸€ä¸ªæœ€ç»ˆçš„64ä½å”¯ä¸€IDï¼š

- ä¾‹å¦‚ä¼ å…¥çš„workerIdä¸º3ï¼Œè®¡ç®—æœºä¸­çš„è¡¨ç¤ºä¸º000000.....11ï¼Œå°†å…¶å·¦ç§»`workerIdShift`ä½æ•°ï¼Œå³é›ªèŠ±ç®—æ³•ä¸­å¯¹åº”åˆ°çš„ç¬¬13ä½-ç¬¬17ä½ï¼Œå³è¯¥workerIdåœ¨æœ€ç»ˆå‚ä¸æ•´ä½“æˆ–è¿ç®—æ—¶çš„æ ·å­ä½ï¼š0000000........... 0000000**0  0011**0000 00000000 (æ³¨æ„åŠ ç²—éƒ¨åˆ† 5ä½)



>  ^ è¡¨ç¤ºå¼‚æˆ–è¿ç®—ï¼šä¸åŒå–1ï¼Œç›¸åŒå–0
>
>  | è¡¨ç¤ºä½æˆ–è¿ç®—ï¼š1|0=1 ã€1|1=1ã€ 0|0=0 





ç„¶è€Œä¼ ç»Ÿé›ªèŠ±ç®—æ³•å­˜åœ¨æ—¶é—´å›æ‹¨çš„é£é™©ï¼Œå¦‚æœä¸€å°æœºå™¨ä¸Šå‘ç”Ÿäº†æ—¶é’Ÿå›æ‹¨ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå†æ¬¡ç”Ÿæˆé‡å¤æ€§IDï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ç¾å›¢çš„`Leaf`æ–¹æ¡ˆæ˜¯å¦‚ä½•è§£å†³æ—¶é—´å›æ‹¨é—®é¢˜çš„



**`Leaf-Segment`æ–¹æ¡ˆ**(é’ˆå¯¹Nä¸ªæ•°æ®åº“ä¸åŒæ­¥é•¿ç”Ÿæˆå”¯ä¸€æ€§IDçš„æ–¹æ¡ˆæ¥åšçš„æ”¹è¿›)

ç¬¬ä¸€ç§Leaf-segmentæ–¹æ¡ˆï¼Œåœ¨ä½¿ç”¨æ•°æ®åº“çš„æ–¹æ¡ˆä¸Šï¼Œåšäº†å¦‚ä¸‹æ”¹å˜ï¼š - åŸæ–¹æ¡ˆæ¯æ¬¡è·å–IDéƒ½å¾—è¯»å†™ä¸€æ¬¡æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›å¤§ã€‚æ”¹ä¸ºåˆ©ç”¨proxy serveræ‰¹é‡è·å–ï¼Œæ¯æ¬¡è·å–ä¸€ä¸ªsegment(stepå†³å®šå¤§å°)å·æ®µçš„å€¼ã€‚ç”¨å®Œä¹‹åå†å»æ•°æ®åº“è·å–æ–°çš„å·æ®µï¼Œå¯ä»¥å¤§å¤§çš„å‡è½»æ•°æ®åº“çš„å‹åŠ›ã€‚ - å„ä¸ªä¸šåŠ¡ä¸åŒçš„å‘å·éœ€æ±‚ç”¨biz_tagå­—æ®µæ¥åŒºåˆ†ï¼Œæ¯ä¸ªbiz-tagçš„IDè·å–ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å½±å“ã€‚å¦‚æœä»¥åæœ‰æ€§èƒ½éœ€æ±‚éœ€è¦å¯¹æ•°æ®åº“æ‰©å®¹ï¼Œä¸éœ€è¦ä¸Šè¿°æè¿°çš„å¤æ‚çš„æ‰©å®¹æ“ä½œï¼Œåªéœ€è¦å¯¹biz_tagåˆ†åº“åˆ†è¡¨å°±è¡Œã€‚

æ•°æ®åº“è¡¨è®¾è®¡å¦‚ä¸‹ï¼š

```sql
+-------------+--------------+------+-----+-------------------+-----------------------------+
| Field       | Type         | Null | Key | Default           | Extra                       |
+-------------+--------------+------+-----+-------------------+-----------------------------+
| biz_tag     | varchar(128) | NO   | PRI |                   |                             |
| max_id      | bigint(20)   | NO   |     | 1                 |                             |
| step        | int(11)      | NO   |     | NULL              |                             |
| desc        | varchar(256) | YES  |     | NULL              |                             |
| update_time | timestamp    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |
+-------------+--------------+------+-----+-------------------+-----------------------------+
```

é‡è¦å­—æ®µè¯´æ˜ï¼š`biz_tag`ç”¨æ¥åŒºåˆ†ä¸šåŠ¡ï¼Œ`max_id`è¡¨ç¤ºè¯¥`biz_tag`ç›®å‰æ‰€è¢«åˆ†é…çš„IDå·æ®µçš„æœ€å¤§å€¼ï¼Œstepè¡¨ç¤ºæ¯æ¬¡åˆ†é…çš„å·æ®µé•¿åº¦ã€‚åŸæ¥è·å–IDæ¯æ¬¡éƒ½éœ€è¦å†™æ•°æ®åº“ï¼Œç°åœ¨åªéœ€è¦æŠŠstepè®¾ç½®å¾—è¶³å¤Ÿå¤§ï¼Œæ¯”å¦‚1000ã€‚é‚£ä¹ˆåªæœ‰å½“1000ä¸ªå·è¢«æ¶ˆè€—å®Œäº†ä¹‹åæ‰ä¼šå»é‡æ–°è¯»å†™ä¸€æ¬¡æ•°æ®åº“ã€‚è¯»å†™æ•°æ®åº“çš„é¢‘ç‡ä»1å‡å°åˆ°äº†1/stepï¼Œå¤§è‡´æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š(å…¶ä¸­çš„`Leaf`å¯ä»¥çœ‹ä½œæ˜¯ä»£ç†æœåŠ¡å™¨ `proxy-server`)

![img](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/5e4ff128.png)

test_tagåœ¨ç¬¬ä¸€å°Leafæœºå™¨ä¸Šæ˜¯1~1000çš„å·æ®µï¼Œå½“è¿™ä¸ªå·æ®µç”¨å®Œæ—¶ï¼Œä¼šå»åŠ è½½å¦ä¸€ä¸ªé•¿åº¦ä¸ºstep=1000çš„å·æ®µï¼Œå‡è®¾å¦å¤–ä¸¤å°å·æ®µéƒ½æ²¡æœ‰æ›´æ–°ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬ä¸€å°æœºå™¨æ–°åŠ è½½çš„å·æ®µå°±åº”è¯¥æ˜¯3001~4000ã€‚åŒæ—¶æ•°æ®åº“å¯¹åº”çš„biz_tagè¿™æ¡æ•°æ®çš„max_idä¼šä»3000è¢«æ›´æ–°æˆ4000ï¼Œæ›´æ–°å·æ®µçš„SQLè¯­å¥å¦‚ä¸‹ï¼š

```sql
Begin
UPDATE table SET max_id=max_id+step WHERE biz_tag=xxx
SELECT tag, max_id, step FROM table WHERE biz_tag=xxx
Commit
```

è¿™ç§æ¨¡å¼æœ‰ä»¥ä¸‹ä¼˜ç¼ºç‚¹ï¼š

ä¼˜ç‚¹ï¼š

- LeafæœåŠ¡å¯ä»¥å¾ˆæ–¹ä¾¿çš„çº¿æ€§æ‰©å±•ï¼Œæ€§èƒ½å®Œå…¨èƒ½å¤Ÿæ”¯æ’‘å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ã€‚
- IDå·ç æ˜¯è¶‹åŠ¿é€’å¢çš„8byteçš„64ä½æ•°å­—ï¼Œæ»¡è¶³ä¸Šè¿°æ•°æ®åº“å­˜å‚¨çš„ä¸»é”®è¦æ±‚ã€‚
- å®¹ç¾æ€§é«˜ï¼šLeafæœåŠ¡å†…éƒ¨æœ‰å·æ®µç¼“å­˜ï¼Œå³ä½¿DBå®•æœºï¼ŒçŸ­æ—¶é—´å†…Leafä»èƒ½æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ã€‚
- å¯ä»¥è‡ªå®šä¹‰max_idçš„å¤§å°ï¼Œéå¸¸æ–¹ä¾¿ä¸šåŠ¡ä»åŸæœ‰çš„IDæ–¹å¼ä¸Šè¿ç§»è¿‡æ¥ã€‚

ç¼ºç‚¹ï¼š

- **IDå·ç ä¸å¤Ÿéšæœºï¼Œèƒ½å¤Ÿæ³„éœ²å‘å·æ•°é‡çš„ä¿¡æ¯**ï¼Œä¸å¤ªå®‰å…¨ã€‚
- TP999æ•°æ®æ³¢åŠ¨å¤§ï¼Œ**å½“å·æ®µä½¿ç”¨å®Œä¹‹åè¿˜æ˜¯ä¼šhangåœ¨æ›´æ–°æ•°æ®åº“çš„I/Oä¸Šï¼Œä¼šå‡ºç°å¶å°”çš„å°–åˆº**
- DBå®•æœºä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ã€‚



å¯¹äºç¬¬äºŒä¸ªç¼ºç‚¹ï¼ŒLeaf-segmentåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œç®€å•çš„è¯´å°±æ˜¯ï¼š**åŒbufferä¼˜åŒ–**

Leaf å–å·æ®µçš„æ—¶æœºæ˜¯åœ¨å·æ®µæ¶ˆè€—å®Œçš„æ—¶å€™è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ„å‘³ç€å·æ®µä¸´ç•Œç‚¹çš„IDä¸‹å‘æ—¶é—´å–å†³äºä¸‹ä¸€æ¬¡ä»DBå–å›å·æ®µçš„æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¿™æœŸé—´è¿›æ¥çš„è¯·æ±‚ä¹Ÿä¼šå› ä¸ºDBå·æ®µæ²¡æœ‰å–å›æ¥ï¼Œå¯¼è‡´çº¿ç¨‹é˜»å¡ã€‚å¦‚æœè¯·æ±‚DBçš„ç½‘ç»œå’ŒDBçš„æ€§èƒ½ç¨³å®šï¼Œè¿™ç§æƒ…å†µå¯¹ç³»ç»Ÿçš„å½±å“æ˜¯ä¸å¤§çš„ï¼Œä½†æ˜¯å‡å¦‚å–DBçš„æ—¶å€™ç½‘ç»œå‘ç”ŸæŠ–åŠ¨ï¼Œæˆ–è€…DBå‘ç”Ÿæ…¢æŸ¥è¯¢å°±ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å“åº”æ—¶é—´å˜æ…¢ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›DBå–å·æ®µçš„è¿‡ç¨‹èƒ½å¤Ÿåšåˆ°æ— é˜»å¡ï¼Œ**ä¸éœ€è¦åœ¨DBå–å·æ®µçš„æ—¶å€™é˜»å¡è¯·æ±‚çº¿ç¨‹ï¼Œå³å½“å·æ®µæ¶ˆè´¹åˆ°æŸä¸ªç‚¹æ—¶å°±å¼‚æ­¥çš„æŠŠä¸‹ä¸€ä¸ªå·æ®µåŠ è½½åˆ°å†…å­˜ä¸­ã€‚è€Œä¸éœ€è¦ç­‰åˆ°å·æ®µç”¨å°½çš„æ—¶å€™æ‰å»æ›´æ–°å·æ®µ**ã€‚è¿™æ ·åšå°±å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šçš„é™ä½ç³»ç»Ÿçš„TP999æŒ‡æ ‡ã€‚

> TP99 å°±æ˜¯æ»¡è¶³ç™¾åˆ†ä¹‹ä¹åä¹çš„ç½‘ç»œè¯·æ±‚æ‰€éœ€è¦çš„æœ€ä½è€—æ—¶ã€‚ 
>
> åŒç† TP999 å°±æ˜¯**æ»¡è¶³åƒåˆ†ä¹‹ä¹ç™¾ä¹åä¹çš„ç½‘ç»œè¯·æ±‚æ‰€éœ€è¦çš„æœ€ä½è€—æ—¶**ã€‚

è¯¦ç»†å®ç°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/f2625fac.png)

é‡‡ç”¨åŒbufferçš„æ–¹å¼ï¼ŒLeafæœåŠ¡å†…éƒ¨æœ‰ä¸¤ä¸ªå·æ®µç¼“å­˜åŒºsegmentã€‚å½“å‰å·æ®µå·²ä¸‹å‘10%æ—¶ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå·æ®µæœªæ›´æ–°ï¼Œåˆ™å¦å¯ä¸€ä¸ªæ›´æ–°çº¿ç¨‹å»æ›´æ–°ä¸‹ä¸€ä¸ªå·æ®µã€‚å½“å‰å·æ®µå…¨éƒ¨ä¸‹å‘å®Œåï¼Œå¦‚æœä¸‹ä¸ªå·æ®µå‡†å¤‡å¥½äº†åˆ™åˆ‡æ¢åˆ°ä¸‹ä¸ªå·æ®µä¸ºå½“å‰segmentæ¥ç€ä¸‹å‘ï¼Œå¾ªç¯å¾€å¤ã€‚

- æ¯ä¸ªbiz-tagéƒ½æœ‰æ¶ˆè´¹é€Ÿåº¦ç›‘æ§ï¼Œé€šå¸¸æ¨èsegmenté•¿åº¦è®¾ç½®ä¸ºæœåŠ¡é«˜å³°æœŸå‘å·QPSçš„600å€ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œè¿™æ ·å³ä½¿DBå®•æœºï¼ŒLeafä»èƒ½æŒç»­å‘å·10-20åˆ†é’Ÿä¸å—å½±å“ã€‚
- æ¯æ¬¡è¯·æ±‚æ¥ä¸´æ—¶éƒ½ä¼šåˆ¤æ–­ä¸‹ä¸ªå·æ®µçš„çŠ¶æ€ï¼Œä»è€Œæ›´æ–°æ­¤å·æ®µï¼Œæ‰€ä»¥å¶å°”çš„ç½‘ç»œæŠ–åŠ¨ä¸ä¼šå½±å“ä¸‹ä¸ªå·æ®µçš„æ›´æ–°







**`Leaf-SnowFlake`æ–¹æ¡ˆ**(é’ˆå¯¹ä¼ ç»Ÿé›ªèŠ±ç®—æ³•åšçš„æ”¹è¿›)

Leaf-segmentæ–¹æ¡ˆå¯ä»¥ç”Ÿæˆè¶‹åŠ¿é€’å¢çš„IDï¼ŒåŒæ—¶IDå·æ˜¯å¯è®¡ç®—çš„ï¼Œä¸é€‚ç”¨äºè®¢å•IDç”Ÿæˆåœºæ™¯ï¼Œæ¯”å¦‚ç«å¯¹åœ¨ä¸¤å¤©ä¸­åˆ12ç‚¹åˆ†åˆ«ä¸‹å•ï¼Œé€šè¿‡è®¢å•idå·ç›¸å‡å°±èƒ½å¤§è‡´è®¡ç®—å‡ºå…¬å¸ä¸€å¤©çš„è®¢å•é‡ï¼Œè¿™ä¸ªæ˜¯ä¸èƒ½å¿å—çš„ã€‚é¢å¯¹è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬æä¾›äº† Leaf-snowflakeæ–¹æ¡ˆã€‚

![img](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/721ceeff.png)

Leaf-snowflakeæ–¹æ¡ˆå®Œå…¨æ²¿ç”¨snowflakeæ–¹æ¡ˆçš„bitä½è®¾è®¡ï¼Œå³æ˜¯â€œ1+41+10+12â€çš„æ–¹å¼ç»„è£…IDå·ã€‚å¯¹äºworkerIDçš„åˆ†é…ï¼Œå½“æœåŠ¡é›†ç¾¤æ•°é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥æ‰‹åŠ¨é…ç½®ã€‚LeafæœåŠ¡è§„æ¨¡è¾ƒå¤§ï¼ŒåŠ¨æ‰‹é…ç½®æˆæœ¬å¤ªé«˜ã€‚æ‰€ä»¥ä½¿ç”¨ZookeeperæŒä¹…é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§è‡ªåŠ¨å¯¹snowflakeèŠ‚ç‚¹é…ç½®wokerIDã€‚Leaf-snowflakeæ˜¯æŒ‰ç…§ä¸‹é¢å‡ ä¸ªæ­¥éª¤å¯åŠ¨çš„ï¼š

1. å¯åŠ¨Leaf-snowflakeæœåŠ¡ï¼Œè¿æ¥Zookeeperï¼Œåœ¨leaf_foreverçˆ¶èŠ‚ç‚¹ä¸‹æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»æ³¨å†Œè¿‡ï¼ˆæ˜¯å¦æœ‰è¯¥é¡ºåºå­èŠ‚ç‚¹ï¼‰ã€‚
2. å¦‚æœæœ‰æ³¨å†Œè¿‡ç›´æ¥å–å›è‡ªå·±çš„workerIDï¼ˆzké¡ºåºèŠ‚ç‚¹ç”Ÿæˆçš„intç±»å‹IDå·ï¼‰ï¼Œå¯åŠ¨æœåŠ¡ã€‚
3. å¦‚æœæ²¡æœ‰æ³¨å†Œè¿‡ï¼Œå°±åœ¨è¯¥çˆ¶èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºä¸€ä¸ªæŒä¹…é¡ºåºèŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸåå–å›é¡ºåºå·å½“åšè‡ªå·±çš„workerIDå·ï¼Œå¯åŠ¨æœåŠ¡ã€‚

![img](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/a3f985a8.png)



> `Leaf-snowflake`æ–¹æ¡ˆå¦‚ä½•è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜ï¼Ÿ

![img](https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/1453b4e9.png)





## ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•



```java

import java.util.LinkedList;
import java.util.List;
import java.util.SortedMap;
import java.util.TreeMap;

//å¸¦è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§å“ˆå¸Œ
public class ConsistentHash {


    /**
     * å¾…æ·»åŠ å…¥Hashç¯çš„æœåŠ¡å™¨åˆ—è¡¨
     */
    private static String[] servers = {"192.168.0.0:111", "192.168.0.1:111", "192.168.0.2:111",
            "192.168.0.3:111", "192.168.0.4:111"};

    /**
     * çœŸå®ç»“ç‚¹åˆ—è¡¨,è€ƒè™‘åˆ°æœåŠ¡å™¨ä¸Šçº¿ã€ä¸‹çº¿çš„åœºæ™¯ï¼Œå³æ·»åŠ ã€åˆ é™¤çš„åœºæ™¯ä¼šæ¯”è¾ƒé¢‘ç¹ï¼Œ
     * è¿™é‡Œä½¿ç”¨LinkedListä¼šæ›´å¥½
     */
    private static List<String> realNodes = new LinkedList<String>();

    /**
     * è™šæ‹ŸèŠ‚ç‚¹åˆ—è¡¨ï¼Œkeyè¡¨ç¤ºè™šæ‹ŸèŠ‚ç‚¹çš„hashå€¼ï¼Œvalueè¡¨ç¤ºè™šæ‹ŸèŠ‚ç‚¹çš„åç§°
     */
    private static SortedMap<Integer, String> virtualNodes =
            new TreeMap<Integer, String>();


    /**
     * è™šæ‹ŸèŠ‚ç‚¹çš„æ•°ç›®ï¼Œè¿™é‡Œå†™æ­»ï¼Œä¸ºäº†æ¼”ç¤ºéœ€è¦ï¼Œä¸€ä¸ªçœŸå®ç»“ç‚¹å¯¹åº”5ä¸ªè™šæ‹ŸèŠ‚ç‚¹
     */
    private static final int VIRTUAL_NODES = 5;

    static {
        for (int i = 0; i < servers.length; i++) {
            //å…ˆæŠŠçœŸå®èŠ‚ç‚¹ç”¨Listå­˜èµ·æ¥
            realNodes.add(servers[i]);
        }
        for(String  str : realNodes)
        {
            //é’ˆå¯¹æ¯ä¸ªçœŸå®ServerèŠ‚ç‚¹ï¼Œå°†å…¶å¯¹åº”çš„æ‰€æœ‰è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Š
            for (int i = 0; i < VIRTUAL_NODES; i++) {
                String  virtualNodeName=str+"&&"+String.valueOf(i);
                int hash=getHash(virtualNodeName);
                virtualNodes.put(hash,virtualNodeName);
            }
        }
    }


    public static void main(String[] args) {
        String[]  requests={
                "127.0.0.1:1111",
                "221.226.0.1:2222",
                "10.211.0.1:3333",
                "291.226.0.1:2222",
                "100.211.0.1:3333"
        };
        for (int i = 0; i < requests.length; i++) {
            System.out.println("è¯·æ±‚ "+i+requests[i]+
                    " ï¼šçš„å“ˆå¸Œå€¼ä¸º"+getHash(requests[i])+
                    "ï¼Œå…¶è¢«è·¯ç”±åˆ°çš„çœŸå®èŠ‚ç‚¹ä¸º"+getServer(requests[i]));
        }
    }

    private  static  String getServer(String request)
    {
        int reqHash=getHash(request);
        SortedMap<Integer,String> subMap = virtualNodes.tailMap(reqHash);
       //è¿”å›é¡ºæ—¶é’ˆæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹
        String virtualNode = subMap.get(subMap.firstKey());
        /*
        é€šè¿‡ virtualNode.substring(0, virtualNode.indexOf("&&"))ï¼Œ
        å¯ä»¥ä»è™šæ‹ŸèŠ‚ç‚¹çš„åç§°ä¸­æå–çœŸå®èŠ‚ç‚¹çš„éƒ¨åˆ†ï¼Œå³ä»å¼€å¤´åˆ° "&&" ä¹‹å‰çš„éƒ¨åˆ†ã€‚
         */
        return  virtualNode.substring(0,virtualNode.indexOf("&&"));
    }


    /**
     * ä½¿ç”¨FNV1_32_HASHç®—æ³•è®¡ç®—æœåŠ¡å™¨çš„Hashå€¼,è¿™é‡Œä¸ä½¿ç”¨é‡å†™hashCodeçš„æ–¹æ³•
     */
    public  static int getHash(String server)
    {
        final   int primeNum= 16777619; //è®¾ç½®çš„å¸¸æ•°è´¨æ•°â€”32ä½
        int     initialHash= (int) 2166136261L; //åˆå§‹Hashå€¼â€”32ä½
        for (int i = 0; i < server.length(); i++) {
            initialHash=(initialHash^server.charAt(i))*primeNum; //str.charAt(i) è¿”å›çš„æ˜¯å­—ç¬¦å¯¹åº”çš„ Unicode ç¼–ç å€¼ï¼ˆæ•´æ•°ï¼‰
            initialHash+=initialHash<<13; //å·¦ç§»13ä½
            initialHash^=initialHash>>7;
            initialHash+=initialHash<<3;
            initialHash^=initialHash>>17;
            initialHash+=initialHash<<5;
            if (initialHash<0)
            { //å¦‚æœç®—å‡ºæ¥çš„å€¼ä¸ºè´Ÿæ•° å–å…¶ç»å¯¹å€¼
                initialHash=Math.abs(initialHash);
            }
        }
        return  initialHash;
    }

}



//ä¸å¸¦è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§å“ˆå¸Œ
class  ConsistentHashWithoutVirtualNode{

    /*
    å¾…æ·»åŠ å…¥Hashç¯çš„æœåŠ¡å™¨åˆ—è¡¨
     */
    private  static String[] servers={
            "192.168.0.0:111",
            "192.168.0.1:111",
            "192.168.0.2:111",
            "192.168.0.3:111",
            "192.168.0.4:111"
    };

    /*
    * ä½¿ç”¨TreeMapæ¥æ¨¡æ‹Ÿå“ˆå¸Œç¯
    keyè¡¨ç¤ºæœåŠ¡å™¨çš„hashå€¼ï¼Œvalueè¡¨ç¤ºæœåŠ¡å™¨çš„ip+port(åç§°)
     */
    private  static SortedMap<Integer,String> sortedMap=new TreeMap<Integer,String>();

    //ç¨‹åºåˆå§‹åŒ–æ—¶å°†all servers æ”¾å…¥ å“ˆå¸Œç¯(TreeMap)ä¸Š
    static {
        for (String server : servers) {
            int hash = getHash(server); //è®¡ç®—æ¯ä¸ªæœåŠ¡å™¨çš„hashå€¼
            System.out.println(server+"æ”¾å…¥å“ˆå¸Œç¯ä¸Šï¼Œå…¶Hashå€¼ä¸º"+hash);
            sortedMap.put(hash, server);
        }
        System.out.println();
    }

    public static void main(String[] args) {
        String[] nodes={
                "127.0.0.1:1111",
                "221.226.0.1:2222",
                "192.168.100.1:8822",
                "10.211.0.1:3333"};
        for (int i = 0; i < nodes.length; i++) {
            System.out.println(nodes[i]+"çš„hashå€¼ä¸º"+getHash(nodes[i])+
                    "è¯·æ±‚è¢«è·¯ç”±åˆ°çš„ServerèŠ‚ç‚¹ä¸º"+getServer(nodes[i]));
        }
    }

    //å¤–æ¥è¯·æ±‚æ˜ å°„åˆ°æŒ‡å®šServer
    public  static String getServer(String node)
    {
        int nodeHash=getHash(node);
        //æ ¹æ®è¾“å…¥Keyæ‰¾åˆ°å¤§äºè¯¥keyçš„å­Mapï¼ˆå­çº¢é»‘æ ‘ï¼‰
        SortedMap<Integer, String> subMap = sortedMap.tailMap(nodeHash);
        return  subMap.get(subMap.firstKey());//è¿”å›é¡ºæ—¶é’ˆæŸ¥æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªServerèŠ‚ç‚¹çš„ip+port
    }

    //è®¡ç®—æ¯ä¸ªserverçš„å“ˆå¸Œå€¼
    /*
    FNV1_32_HASHï¼ˆFowler-Noll-Voï¼‰æ˜¯ä¸€ç§éå¸¸ç®€å•ä½†æœ‰æ•ˆçš„å“ˆå¸Œç®—æ³•ï¼Œ
    ç”¨äºå°†è¾“å…¥æ•°æ®æ˜ å°„ä¸ºä¸€ä¸ª32ä½çš„å“ˆå¸Œå€¼ã€‚
    FNV1_32_HASH ç®—æ³•çš„æ ¸å¿ƒæ­¥éª¤å¦‚ä¸‹ï¼š
     åˆå§‹åŒ–å“ˆå¸Œå€¼ä¸ºä¸€ä¸ªç§°ä¸ºâ€œåç§»åŸºå‡†â€ï¼ˆoffset basisï¼‰çš„å¸¸æ•°ã€‚
     éå†è¾“å…¥æ•°æ®çš„æ¯ä¸ªå­—èŠ‚ï¼ˆæˆ–å­—ç¬¦ï¼‰ï¼š
     å¯¹å½“å‰å­—èŠ‚çš„å€¼æ‰§è¡Œå¼‚æˆ–æ“ä½œã€‚
     å°†ç»“æœä¹˜ä»¥ä¸€ä¸ªç§°ä¸ºâ€œè´¨æ•°â€ï¼ˆprime numberï¼‰çš„å¸¸æ•°ã€‚
     æœ€ç»ˆå¾—åˆ°çš„ç»“æœå³ä¸ºå“ˆå¸Œå€¼ã€‚
     */
    public  static int getHash(String server)
    {
        final   int primeNum= 16777619; //è®¾ç½®çš„å¸¸æ•°è´¨æ•°â€”32ä½
        int     initialHash= (int) 2166136261L; //åˆå§‹Hashå€¼â€”32ä½
        for (int i = 0; i < server.length(); i++) {
            initialHash=(initialHash^server.charAt(i))*primeNum; //str.charAt(i) è¿”å›çš„æ˜¯å­—ç¬¦å¯¹åº”çš„ Unicode ç¼–ç å€¼ï¼ˆæ•´æ•°ï¼‰
            initialHash+=initialHash<<13; //å·¦ç§»13ä½
            initialHash^=initialHash>>7;
            initialHash+=initialHash<<3;
            initialHash^=initialHash>>17;
            initialHash+=initialHash<<5;
            if (initialHash<0)
            { //å¦‚æœç®—å‡ºæ¥çš„å€¼ä¸ºè´Ÿæ•° å–å…¶ç»å¯¹å€¼
                initialHash=Math.abs(initialHash);
            }
        }
        return  initialHash;
    }
}
```







## çº¢é»‘æ ‘



### æ’å…¥/åˆ é™¤æ“ä½œ

åœ¨äºŒå‰æœç´¢æ ‘ä¸­ï¼ŒåŠ¨æ€æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¯¼è‡´æ ‘çš„ä¸å¹³è¡¡ï¼Œä»è€Œé™ä½æŸ¥æ‰¾ç­‰æ“ä½œçš„æ•ˆç‡ã€‚ä¸ºäº†ä¿æŒå¹³è¡¡ï¼Œçº¢é»‘æ ‘é‡‡ç”¨äº†ä¸€ç³»åˆ—ç­–ç•¥ï¼ŒåŒ…æ‹¬æ—‹è½¬å’ŒèŠ‚ç‚¹é‡ç€è‰²ç­‰æ“ä½œã€‚ä»¥ä¸‹æ˜¯ä¿æŒåŠ¨æ€æ’å…¥å’Œåˆ é™¤æ“ä½œå¹³è¡¡çš„è¯¦ç»†æ­¥éª¤ï¼š

**1. æ’å…¥æ“ä½œçš„å¹³è¡¡ç»´æŠ¤ï¼š**

æ’å…¥æ–°èŠ‚ç‚¹æ—¶ï¼Œé¦–å…ˆå°†èŠ‚ç‚¹æ’å…¥äºŒå‰æœç´¢æ ‘çš„é€‚å½“ä½ç½®ï¼Œç„¶åæ ¹æ®çº¢é»‘æ ‘çš„æ€§è´¨è¿›è¡Œè°ƒæ•´ã€‚

a. **å°†æ–°æ’å…¥çš„èŠ‚ç‚¹ç€ä¸ºçº¢è‰²ã€‚è¿™ä¸ä¼šè¿åçº¢é»‘æ ‘çš„æ€§è´¨ï¼Œå› ä¸ºæ’å…¥çº¢è‰²èŠ‚ç‚¹ä¸ä¼šç ´åé»‘é«˜åº¦å¹³è¡¡**ã€‚

b. æ£€æŸ¥çˆ¶èŠ‚ç‚¹çš„é¢œè‰²ï¼š

- å¦‚æœçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œä¸ä¼šè¿åçº¢é»‘æ ‘çš„æ€§è´¨ï¼Œç›´æ¥æ’å…¥å³å¯ã€‚
- **å¦‚æœçˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œéœ€è¦ç»§ç»­è¿›è¡Œè°ƒæ•´ã€‚**

c. **è¿›è¡Œæ—‹è½¬å’Œé‡ç€è‰²æ“ä½œï¼Œä»¥æ¢å¤çº¢é»‘æ ‘çš„æ€§è´¨**ã€‚å¯èƒ½éœ€è¦è¿›è¡Œå·¦æ—‹ã€å³æ—‹ã€åŒæ—‹ç­‰æ“ä½œï¼Œä»¥ç¡®ä¿çº¢é»‘æ ‘çš„æ€§è´¨å¾—ä»¥ä¿æŒã€‚

**2. åˆ é™¤æ“ä½œçš„å¹³è¡¡ç»´æŠ¤ï¼š**

åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ é™¤èŠ‚ç‚¹çš„æ›¿ä»£èŠ‚ç‚¹ï¼ˆåç»§æˆ–å‰é©±èŠ‚ç‚¹ï¼‰ï¼Œå¹¶æ ¹æ®çº¢é»‘æ ‘çš„æ€§è´¨è¿›è¡Œè°ƒæ•´ã€‚

a. **å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œå¹¶ç”¨å…¶å­èŠ‚ç‚¹æ›¿ä»£**ã€‚

b. å¦‚æœè¦åˆ é™¤çš„èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œéœ€è¦æ‰¾åˆ°å…¶åç»§æˆ–å‰é©±èŠ‚ç‚¹ï¼Œå°†åç»§æˆ–å‰é©±èŠ‚ç‚¹çš„å€¼å¤åˆ¶åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œå¹¶å°†åˆ é™¤æ“ä½œè½¬æ¢ä¸ºåˆ é™¤åç»§æˆ–å‰é©±èŠ‚ç‚¹ã€‚

c. å¦‚æœåˆ é™¤çš„èŠ‚ç‚¹å’Œæ›¿ä»£èŠ‚ç‚¹éƒ½æ˜¯é»‘è‰²ï¼Œéœ€è¦è¿›è¡Œè°ƒæ•´æ¥ä¿æŒçº¢é»‘æ ‘çš„æ€§è´¨ã€‚

d. è¿›è¡Œæ—‹è½¬å’Œé‡ç€è‰²æ“ä½œï¼Œä»¥æ¢å¤çº¢é»‘æ ‘çš„æ€§è´¨ã€‚ä¸æ’å…¥æ“ä½œç±»ä¼¼ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œå·¦æ—‹ã€å³æ—‹ã€åŒæ—‹ç­‰æ“ä½œï¼Œä»¥ä¿æŒçº¢é»‘æ ‘çš„å¹³è¡¡ã€‚

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œçº¢é»‘æ ‘åœ¨åŠ¨æ€æ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶ä¼šè‡ªåŠ¨è¿›è¡Œè°ƒæ•´ï¼Œä»¥ä¿æŒæ ‘çš„å¹³è¡¡æ€§è´¨ã€‚è¿™äº›è°ƒæ•´æ“ä½œèƒ½å¤Ÿç¡®ä¿çº¢é»‘æ ‘çš„é»‘é«˜åº¦å¹³è¡¡ï¼Œä»è€Œä¿è¯äº†æ ‘çš„é«˜åº¦ä¿æŒåœ¨å¯¹æ•°çº§åˆ«ï¼Œä½¿å¾—åŸºæœ¬æ“ä½œçš„æ—¶é—´å¤æ‚åº¦èƒ½å¤Ÿä¿æŒåœ¨ `O(log n)` çº§åˆ«ã€‚æ€»ä¹‹ï¼Œçº¢é»‘æ ‘çš„å¹³è¡¡ç»´æŠ¤æ˜¯é€šè¿‡æ—‹è½¬å’Œé‡ç€è‰²ç­‰æ“ä½œæ¥ä¿æŒæ ‘çš„å¹³è¡¡æ€§è´¨çš„è¿‡ç¨‹ã€‚





###  TreeMapå®ç°ä¸€è‡´æ€§å“ˆå¸Œ





## å¸ƒéš†è¿‡æ»¤å™¨

å¸ƒéš†è¿‡æ»¤å™¨çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªç”±å¤šä¸ªäºŒè¿›åˆ¶ä½ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªé•¿çš„ä½æ•°ç»„æˆ–bitmapï¼‰ç»„æˆçš„æ•°æ®ç»“æ„ã€‚åˆå§‹æ—¶ï¼Œæ‰€æœ‰çš„äºŒè¿›åˆ¶ä½éƒ½è¢«è®¾ç½®ä¸º0ã€‚å½“å‘å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œ**é€šè¿‡å°†è¯¥å…ƒç´ ç»è¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°çš„è®¡ç®—ï¼Œå¾—åˆ°å¤šä¸ªå“ˆå¸Œå€¼ï¼Œç„¶åå°†å¯¹åº”çš„äºŒè¿›åˆ¶ä½è®¾ç½®ä¸º1ã€‚**æŸ¥è¯¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼ŒåŒæ ·ä¹Ÿæ˜¯é€šè¿‡è®¡ç®—å¤šä¸ªå“ˆå¸Œå€¼ï¼Œå¹¶æ£€æŸ¥å¯¹åº”çš„äºŒè¿›åˆ¶ä½æ˜¯å¦éƒ½ä¸º1æ¥åˆ¤æ–­ã€‚



å¸ƒéš†è¿‡æ»¤å™¨ç”±ã€Œåˆå§‹å€¼éƒ½ä¸º 0 çš„ä½å›¾æ•°ç»„ã€å’Œã€Œ N ä¸ªå“ˆå¸Œå‡½æ•°ã€ä¸¤éƒ¨åˆ†ç»„æˆã€‚å½“æˆ‘ä»¬åœ¨å†™å…¥æ•°æ®åº“æ•°æ®æ—¶ï¼Œåœ¨å¸ƒéš†è¿‡æ»¤å™¨é‡Œåšä¸ªæ ‡è®°ï¼Œè¿™æ ·ä¸‹æ¬¡æŸ¥è¯¢æ•°æ®æ˜¯å¦åœ¨æ•°æ®åº“æ—¶ï¼Œåªéœ€è¦æŸ¥è¯¢å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¦‚æœæŸ¥è¯¢åˆ°æ•°æ®æ²¡æœ‰è¢«æ ‡è®°ï¼Œè¯´æ˜ä¸åœ¨æ•°æ®åº“ä¸­ã€‚

å¸ƒéš†è¿‡æ»¤å™¨ä¼šé€šè¿‡ 3 ä¸ªæ“ä½œå®Œæˆæ ‡è®°ï¼š

- ç¬¬ä¸€æ­¥ï¼Œä½¿ç”¨ N ä¸ªå“ˆå¸Œå‡½æ•°åˆ†åˆ«å¯¹æ•°æ®åšå“ˆå¸Œè®¡ç®—ï¼Œå¾—åˆ° N ä¸ªå“ˆå¸Œå€¼ï¼›
- ç¬¬äºŒæ­¥ï¼Œå°†ç¬¬ä¸€æ­¥å¾—åˆ°çš„ N ä¸ªå“ˆå¸Œå€¼å¯¹ä½å›¾æ•°ç»„çš„é•¿åº¦å–æ¨¡ï¼Œå¾—åˆ°æ¯ä¸ªå“ˆå¸Œå€¼åœ¨ä½å›¾æ•°ç»„çš„å¯¹åº”ä½ç½®ã€‚
- ç¬¬ä¸‰æ­¥ï¼Œå°†æ¯ä¸ªå“ˆå¸Œå€¼åœ¨ä½å›¾æ•°ç»„çš„å¯¹åº”ä½ç½®çš„å€¼è®¾ç½®ä¸º 1ï¼›



ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªä½å›¾æ•°ç»„é•¿åº¦ä¸º 8ï¼Œå“ˆå¸Œå‡½æ•° 3 ä¸ªçš„å¸ƒéš†è¿‡æ»¤å™¨:

![å›¾ç‰‡](https://cdn.xiaolincoding.com//mysql/other/86b0046c2622b2c4bda697f9bc0f5b28.png)

åœ¨æ•°æ®åº“å†™å…¥æ•°æ® x åï¼ŒæŠŠæ•°æ® x æ ‡è®°åœ¨å¸ƒéš†è¿‡æ»¤å™¨æ—¶ï¼Œæ•°æ® x ä¼šè¢« 3 ä¸ªå“ˆå¸Œå‡½æ•°åˆ†åˆ«è®¡ç®—å‡º 3 ä¸ªå“ˆå¸Œå€¼ï¼Œç„¶ååœ¨å¯¹è¿™ 3 ä¸ªå“ˆå¸Œå€¼å¯¹ 8 å–æ¨¡ï¼Œå‡è®¾å–æ¨¡çš„ç»“æœä¸º 1ã€4ã€6ï¼Œç„¶åæŠŠä½å›¾æ•°ç»„çš„ç¬¬ 1ã€4ã€6 ä½ç½®çš„å€¼è®¾ç½®ä¸º 1ã€‚**å½“åº”ç”¨è¦æŸ¥è¯¢æ•°æ® x æ˜¯å¦æ•°æ®åº“æ—¶ï¼Œé€šè¿‡å¸ƒéš†è¿‡æ»¤å™¨åªè¦æŸ¥åˆ°ä½å›¾æ•°ç»„çš„ç¬¬ 1ã€4ã€6 ä½ç½®çš„å€¼æ˜¯å¦å…¨ä¸º 1ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸º 0ï¼Œå°±è®¤ä¸ºæ•°æ® x ä¸åœ¨æ•°æ®åº“ä¸­**ã€‚

å¸ƒéš†è¿‡æ»¤å™¨ç”±äºæ˜¯åŸºäºå“ˆå¸Œå‡½æ•°å®ç°æŸ¥æ‰¾çš„ï¼Œé«˜æ•ˆæŸ¥æ‰¾çš„åŒæ—¶**å­˜åœ¨å“ˆå¸Œå†²çªçš„å¯èƒ½æ€§**ï¼Œæ¯”å¦‚æ•°æ® x å’Œæ•°æ® y å¯èƒ½éƒ½è½åœ¨ç¬¬ 1ã€4ã€6 ä½ç½®ï¼Œè€Œäº‹å®ä¸Šï¼Œå¯èƒ½æ•°æ®åº“ä¸­å¹¶ä¸å­˜åœ¨æ•°æ® yï¼Œå­˜åœ¨è¯¯åˆ¤çš„æƒ…å†µã€‚

æ‰€ä»¥ï¼Œ**æŸ¥è¯¢å¸ƒéš†è¿‡æ»¤å™¨è¯´æ•°æ®å­˜åœ¨ï¼Œå¹¶ä¸ä¸€å®šè¯æ˜æ•°æ®åº“ä¸­å­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œä½†æ˜¯æŸ¥è¯¢åˆ°æ•°æ®ä¸å­˜åœ¨ï¼Œæ•°æ®åº“ä¸­ä¸€å®šå°±ä¸å­˜åœ¨è¿™ä¸ªæ•°æ®**

> ä¸åŒå¯¹è±¡çš„å“ˆå¸Œå€¼æœ‰å¯èƒ½ç›¸ç­‰ï¼›
>
> ä¸¤ä¸ªå¯¹è±¡å“ˆå¸Œå€¼ä¸åŒï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¸€å®šä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼›





## ZipList



`ZipList`å®ƒé‡‡ç”¨äº†**è¿ç»­å†…å­˜å—çš„æ–¹å¼å­˜å‚¨åˆ—è¡¨å…ƒç´ ï¼Œä¸åƒæ™®é€šçš„é“¾è¡¨ç»“æ„é‚£æ ·æ¯ä¸ªå…ƒç´ éƒ½éœ€è¦å•ç‹¬åˆ†é…å†…å­˜**ï¼Œ**ä»è€Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘äº†å†…å­˜ç¢ç‰‡**ï¼Œ`zipList`æœ¬è´¨å°±æ˜¯ä¸€ä¸ªç©ºé—´è¿ç»­çš„å­—èŠ‚æ•°ç»„,`zipList`ä¸­åŒ…å«å¤šä¸ªèŠ‚ç‚¹(entry)ï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ä¸²å€¼æˆ–æ•´æ•°å€¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹é€šè¿‡`struct zlentry`ç»“æ„è¡¨ç¤º:

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/ziplist.png)

å¯ä»¥çœ‹å‡ºï¼Œ`ziplist`ç”±åˆ—è¡¨å¤´ + åˆ—è¡¨èŠ‚ç‚¹ + åˆ—è¡¨å°¾è¿™ä¸‰éƒ¨åˆ†ç»„æˆã€‚æ¯ä¸ªç»„æˆéƒ¨åˆ†ä½œç”¨è¯´æ˜å¦‚ä¸‹ï¼š

- `zlbytes`å 4å­—èŠ‚ï¼Œç”¨äºè®°å½•æ•´ä¸ª`ziplist`å ç”¨å†…å­˜çš„æ€»å­—èŠ‚æ•°ï¼Œå¯¹äºç©ºè¡¨æ¥è¯´ï¼Œ`zlbytes`ç­‰äº11
- `zltail`å 4å­—èŠ‚ï¼Œç”¨äºè®°å½•è¡¨å°¾èŠ‚ç‚¹é¦–åœ°å€è·ç¦»ziplistèµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ã€‚è®¾è®¡è¿™ä¸ªå­—æ®µçš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿå®šä½è¡¨å°¾èŠ‚ç‚¹åœ°å€ï¼ˆZIPLIST_ENTRY_TAIL)
- `zllen`å 2å­—èŠ‚ï¼Œç”¨äºè®°å½•åˆ—è¡¨èŠ‚ç‚¹æ€»æ•°
- `ziplist`çš„æ¯ä¸ª`entry`ç»“æ„éƒ½ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
  - å‰ä¸€èŠ‚ç‚¹é•¿åº¦ä¿¡æ¯ï¼š`previous_entry_length`
  - å½“å‰èŠ‚ç‚¹ç¼–ç ä¿¡æ¯ï¼š`encoding`
  - å½“å‰èŠ‚ç‚¹å†…å®¹ï¼š`content`

> **ä¸ºä»€ä¹ˆè¦åœ¨å…ƒç´ è¾ƒå°‘çš„æ—¶å€™ä½¿ç”¨ `ziplist` ï¼Ÿ**
>
> redis ä¸­çš„é›†åˆå®¹å™¨ä¸­ï¼Œå¾ˆå¤šæƒ…å†µéƒ½ç”¨åˆ°äº†é“¾è¡¨çš„å®ç°ï¼Œå…ƒç´ å’Œå…ƒç´ ä¹‹é—´é€šè¿‡å‚¨å­˜çš„å…³è”æŒ‡é’ˆæœ‰åºçš„ä¸²è”èµ·æ¥ï¼Œä½†æ˜¯è¿™æ ·çš„æŒ‡é’ˆå¾€å¾€æ˜¯ **éšæœºI/O**ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆåœ°å€æ˜¯ä¸è¿ç»­çš„ï¼ˆåˆ†å¸ƒä¸å‡åŒ€ï¼‰ã€‚è€Œæˆ‘ä»¬çš„ ziplist å®ƒæœ¬èº«æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜å—ï¼Œæ‰€ä»¥å®ƒçš„è¯»å†™æ˜¯ **é¡ºåºI/O**ï¼Œ**é¡ºåºI/O** çš„æ•ˆç‡è‚¯å®šæ˜¯é«˜äº **éšæœºI/O** ã€‚ä½ å¯èƒ½ä¼šé—®äº†ï¼Œé‚£ä¸ºä»€ä¹ˆä¸éƒ½ç”¨ **é¡ºåºI/O** çš„ ziplist ä»£æ›¿ **éšæœºI/O** å‘¢ï¼Œå› ä¸º ziplist æ˜¯è¿ç»­å†…å­˜ï¼Œå½“ä½ å…ƒç´ æ•°é‡å¤šäº†ï¼Œæ„å‘³ç€å½“ä½ åˆ›å»ºå’Œæ‰©å±•çš„æ—¶å€™éœ€è¦æ“ä½œæ›´å¤šçš„å†…å­˜ï¼Œæ‰€ä»¥ ziplist é’ˆå¯¹å…ƒç´ å°‘çš„æ—¶å€™æ‰èƒ½æå‡æ•ˆç‡ã€‚







## QuickList

2ã€`QuickList`

```java
typedef struct quicklistNode {
    struct quicklistNode *prev;  //å‰ä¸€ä¸ªquicklistNode
    struct quicklistNode *next;  //åä¸€ä¸ªquicklistNode
    unsigned char *zl;           //quicklistNodeæŒ‡å‘çš„ziplist
    unsigned int sz;             //ziplistçš„å­—èŠ‚å¤§å°
    unsigned int count : 16;     //ziplistä¸­çš„å…ƒç´ ä¸ªæ•°
    unsigned int encoding : 2;   //ç¼–ç æ ¼å¼ï¼ŒåŸç”Ÿå­—èŠ‚æ•°ç»„æˆ–å‹ç¼©å­˜å‚¨
    unsigned int container : 2;  //å­˜å‚¨æ–¹å¼
    unsigned int recompress : 1; //æ•°æ®æ˜¯å¦è¢«å‹ç¼©
    unsigned int attempted_compress : 1; //æ•°æ®èƒ½å¦è¢«å‹ç¼©
    unsigned int extra : 10;     //é¢„ç•™çš„bitä½
} quicklistNode;
```

`quicklist` å®é™…ä¸Šæ˜¯ `zipList` å’Œ `linkedList` çš„æ··åˆä½“ï¼Œå®ƒå°† `linkedList` æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ `zipList` æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª `zipList` ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/QuickList.png" style="zoom: 80%;" />

> ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡`quickList`ï¼Ÿ
>
> 
>
> åŸºäºziplistå­˜åœ¨çš„é—®é¢˜ï¼Œè¦é¿å…zipliståˆ—è¡¨å¤ªå¤§é—®é¢˜ï¼Œå› æ­¤å°†å¤§zipliståˆ†æˆä¸€ç³»åˆ—å°çš„ziplistæ˜¯ä¸€ç§æ€è·¯ã€‚
>
> quicklistæ˜¯ç”±é“¾è¡¨ç»„æˆçš„ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ªé“¾è¡¨èŠ‚ç‚¹ä¸­éƒ½å­˜åœ¨ä¸€ä¸ªziplistã€‚æ˜¯ç”±ziplistæ”¹è¿›è€Œæ¥ï¼Œå……åˆ†åˆ©ç”¨é“¾è¡¨ + ziplistç‰¹æ€§
>
> 



`quicklist`çš„å¸¸ç”¨æ“ä½œ

1. æ’å…¥

`quicklist`å¯ä»¥é€‰æ‹©åœ¨å¤´éƒ¨æˆ–è€…å°¾éƒ¨è¿›è¡Œæ’å…¥(`quicklistPushHead`å’Œ`quicklistPushTail`)ï¼Œè€Œä¸ç®¡æ˜¯åœ¨å¤´éƒ¨è¿˜æ˜¯å°¾éƒ¨æ’å…¥æ•°æ®ï¼Œéƒ½åŒ…å«ä¸¤ç§æƒ…å†µï¼š

- å¦‚æœå¤´èŠ‚ç‚¹ï¼ˆæˆ–å°¾èŠ‚ç‚¹ï¼‰ä¸Š`ziplist`å¤§å°æ²¡æœ‰è¶…è¿‡é™åˆ¶ï¼ˆå³`_quicklistNodeAllowInsert`è¿”å›1ï¼‰ï¼Œé‚£ä¹ˆæ–°æ•°æ®è¢«ç›´æ¥æ’å…¥åˆ°`ziplist`ä¸­ï¼ˆè°ƒç”¨`ziplistPush`ï¼‰
- å¦‚æœå¤´èŠ‚ç‚¹ï¼ˆæˆ–å°¾èŠ‚ç‚¹ï¼‰ä¸Š`ziplist`å¤ªå¤§äº†ï¼Œé‚£ä¹ˆæ–°åˆ›å»ºä¸€ä¸ª`quicklistNode`èŠ‚ç‚¹ï¼ˆå¯¹åº”åœ°ä¹Ÿä¼šæ–°åˆ›å»ºä¸€ä¸ª`ziplist`ï¼‰ï¼Œç„¶åæŠŠè¿™ä¸ªæ–°åˆ›å»ºçš„èŠ‚ç‚¹æ’å…¥åˆ°`quicklist`åŒå‘é“¾è¡¨ä¸­ã€‚



2. æŸ¥æ‰¾

`list`çš„æŸ¥æ‰¾æ“ä½œä¸»è¦æ˜¯å¯¹`index`çš„ï¼Œ æˆ‘ä»¬çš„`quicklist`çš„èŠ‚ç‚¹æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªçš„`ziplist`æ„æˆçš„æ¯ä¸ª`ziplist`éƒ½æœ‰å¤§å°ã€‚æ‰€ä»¥æˆ‘ä»¬å°±åªéœ€è¦å…ˆæ ¹æ®æˆ‘ä»¬æ¯ä¸ª`node`çš„ä¸ªæ•°ï¼Œä»è€Œæ‰¾åˆ°å¯¹åº”çš„`ziplist`ï¼Œè°ƒç”¨`ziplist`çš„`index`å°±èƒ½æˆåŠŸæ‰¾åˆ°ã€‚







## SkipList



å¯¹äºå•é“¾è¡¨æ¥è¯´ï¼Œæˆ‘ä»¬æŸ¥æ‰¾æŸä¸ªæ•°æ®ï¼Œåªèƒ½ä»å¤´åˆ°å°¾éå†é“¾è¡¨ï¼Œæ­¤æ—¶æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)

é‚£ä¹ˆæ€ä¹ˆæé«˜å•é“¾è¡¨çš„æŸ¥æ‰¾æ•ˆç‡å‘¢ï¼Ÿçœ‹ä¸‹å›¾ï¼Œå¯¹é“¾è¡¨å»ºç«‹ä¸€çº§ `ç´¢å¼•`ï¼Œæ¯ä¸¤ä¸ªèŠ‚ç‚¹æå–ä¸€ä¸ªç»“ç‚¹åˆ°ä¸Šä¸€çº§ï¼Œè¢«æŠ½å‡ºæ¥çš„è¿™çº§å«åš `ç´¢å¼•` æˆ– `ç´¢å¼•å±‚`ã€‚

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xMTk4OTQ3OS02ZTljODQyODFhZmRmNTI2LmpwZw?x-oss-process=image/format,png)

å¦‚æœè¦æŸ¥æ‰¾13ï¼Œå°±ä¸éœ€è¦å°†16å‰çš„ç»“ç‚¹å…¨éå†ä¸€éï¼Œåªéœ€è¦éå†ç´¢å¼•ï¼Œæ‰¾åˆ°13ï¼Œç„¶åå‘ç°ä¸‹ä¸€ä¸ªç»“ç‚¹æ˜¯17ï¼Œé‚£ä¹ˆ16ä¸€å®šæ˜¯åœ¨ [13,17] ä¹‹é—´çš„ï¼Œæ­¤æ—¶åœ¨13ä½ç½®ä¸‹é™åˆ°åŸå§‹é“¾è¡¨å±‚ï¼Œæ‰¾åˆ°16ï¼ŒåŠ ä¸Šä¸€å±‚ç´¢å¼•åï¼ŒæŸ¥æ‰¾ä¸€ä¸ªç»“ç‚¹éœ€è¦éå†çš„ç»“ç‚¹ä¸ªæ•°å‡å°‘äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æŸ¥æ‰¾æ•ˆç‡æé«˜äº† 



é‚£ä¹ˆæˆ‘ä»¬å†åŠ ä¸€çº§ç´¢å¼•å‘¢ï¼Ÿ
è·Ÿå‰é¢å»ºç«‹ä¸€çº§ç´¢å¼•çš„æ–¹å¼ç›¸ä¼¼ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€çº§ç´¢å¼•çš„åŸºç¡€ä¸Šï¼Œæ¯ä¸¤ä¸ªç»“ç‚¹å°±æŠ½å‡ºä¸€ä¸ªç»“ç‚¹åˆ°ç¬¬äºŒçº§ç´¢å¼•ã€‚æ­¤æ—¶å†æŸ¥æ‰¾16ï¼Œåªéœ€è¦éå† 6 ä¸ªç»“ç‚¹äº†ï¼Œéœ€è¦éå†çš„ç»“ç‚¹æ•°é‡åˆå‡å°‘äº†

![img](https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xMTk4OTQ3OS01ZDM2NjQ2ODdmY2MxZTQ3LmpwZw?x-oss-process=image/format,png)

å½“ç»“ç‚¹æ•°é‡å¤šçš„æ—¶å€™ï¼Œè¿™ç§æ·»åŠ ç´¢å¼•çš„æ–¹å¼ï¼Œä¼šä½¿æŸ¥è¯¢æ•ˆç‡æé«˜çš„éå¸¸æ˜æ˜¾







å†æ¯”å¦‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå±‚çº§ä¸º 3 çš„è·³è¡¨ã€‚

![img](https://cdn.xiaolincoding.com//mysql/other/2ae0ed790c7e7403f215acb2bd82e884.png)

å›¾ä¸­å¤´èŠ‚ç‚¹æœ‰ L0~L2 ä¸‰ä¸ªå¤´æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘äº†ä¸åŒå±‚çº§çš„èŠ‚ç‚¹ï¼Œç„¶åæ¯ä¸ªå±‚çº§çš„èŠ‚ç‚¹éƒ½é€šè¿‡æŒ‡é’ˆè¿æ¥èµ·æ¥ï¼š

- L0 å±‚çº§å…±æœ‰ 5 ä¸ªèŠ‚ç‚¹ï¼Œåˆ†åˆ«æ˜¯èŠ‚ç‚¹1ã€2ã€3ã€4ã€5ï¼›
- L1 å±‚çº§å…±æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼Œåˆ†åˆ«æ˜¯èŠ‚ç‚¹ 2ã€3ã€5ï¼›
- L2 å±‚çº§åªæœ‰ 1 ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯èŠ‚ç‚¹ 3 

å¦‚æœæˆ‘ä»¬è¦åœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾èŠ‚ç‚¹ 4 è¿™ä¸ªå…ƒç´ ï¼Œåªèƒ½ä»å¤´å¼€å§‹éå†é“¾è¡¨ï¼Œéœ€è¦æŸ¥æ‰¾ 4 æ¬¡ï¼Œè€Œä½¿ç”¨äº†è·³è¡¨åï¼Œåªéœ€è¦æŸ¥æ‰¾ 2 æ¬¡å°±èƒ½å®šä½åˆ°èŠ‚ç‚¹ 4ï¼Œå› ä¸ºå¯ä»¥åœ¨å¤´èŠ‚ç‚¹ç›´æ¥ä» L2 å±‚çº§è·³åˆ°èŠ‚ç‚¹ 3ï¼Œç„¶åå†å¾€å‰éå†æ‰¾åˆ°èŠ‚ç‚¹ 4

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæŸ¥æ‰¾è¿‡ç¨‹å°±æ˜¯åœ¨å¤šä¸ªå±‚çº§ä¸Šè·³æ¥è·³å»ï¼Œæœ€åå®šä½åˆ°å…ƒç´ ã€‚å½“æ•°æ®é‡å¾ˆå¤§æ—¶ï¼Œè·³è¡¨çš„æŸ¥æ‰¾å¤æ‚åº¦å°±æ˜¯ `O(logN)`â€”â€”>(å°†é“¾è¡¨æŸ¥æ‰¾å‡çº§ä¸ºäºŒåˆ†æŸ¥æ‰¾)



é‚£è·³è¡¨èŠ‚ç‚¹æ˜¯æ€ä¹ˆå®ç°å¤šå±‚çº§çš„å‘¢ï¼Ÿè¿™å°±éœ€è¦çœ‹ã€Œè·³è¡¨èŠ‚ç‚¹ã€çš„æ•°æ®ç»“æ„äº†ï¼Œå¦‚ä¸‹ï¼š

```c++
typedef struct zskiplistNode {
    //Zset å¯¹è±¡çš„å…ƒç´ å€¼
    sds ele;
    //å…ƒç´ æƒé‡å€¼
    double score;
    //åå‘æŒ‡é’ˆ
    struct zskiplistNode *backward;
  
    //èŠ‚ç‚¹çš„levelæ•°ç»„ï¼Œä¿å­˜æ¯å±‚ä¸Šçš„å‰å‘æŒ‡é’ˆå’Œè·¨åº¦
    struct zskiplistLevel {
        struct zskiplistNode *forward;
        unsigned long span;
    } level[];
} zskiplistNode;
```

`Zset` å¯¹è±¡è¦åŒæ—¶ä¿å­˜ã€Œå…ƒç´ ã€å’Œã€Œå…ƒç´ çš„æƒé‡ã€ï¼Œå¯¹åº”åˆ°è·³è¡¨èŠ‚ç‚¹ç»“æ„é‡Œå°±æ˜¯ sds ç±»å‹çš„ ele å˜é‡å’Œ `double` ç±»å‹çš„ `score` å˜é‡ã€‚æ¯ä¸ªè·³è¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªåå‘æŒ‡é’ˆï¼ˆ`struct zskiplistNode *backward`ï¼‰ï¼ŒæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ä»è·³è¡¨çš„å°¾èŠ‚ç‚¹å¼€å§‹è®¿é—®èŠ‚ç‚¹ï¼Œè¿™æ ·å€’åºæŸ¥æ‰¾æ—¶å¾ˆæ–¹ä¾¿ã€‚

è·³è¡¨æ˜¯ä¸€ä¸ªå¸¦æœ‰å±‚çº§å…³ç³»çš„é“¾è¡¨ï¼Œè€Œä¸”æ¯ä¸€å±‚çº§å¯ä»¥åŒ…å«å¤šä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹é€šè¿‡æŒ‡é’ˆè¿æ¥èµ·æ¥ï¼Œå®ç°è¿™ä¸€ç‰¹æ€§å°±æ˜¯é è·³è¡¨èŠ‚ç‚¹ç»“æ„ä½“ä¸­çš„**`zskiplistLevel` ç»“æ„ä½“ç±»å‹çš„ `level` æ•°ç»„**

level æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨è·³è¡¨çš„ä¸€å±‚ï¼Œä¹Ÿå°±æ˜¯ç”± `zskiplistLevel` ç»“æ„ä½“è¡¨ç¤ºï¼Œæ¯”å¦‚ leve[0] å°±è¡¨ç¤ºç¬¬ä¸€å±‚ï¼Œleve[1] å°±è¡¨ç¤ºç¬¬äºŒå±‚ã€‚`zskiplistLevel` ç»“æ„ä½“é‡Œå®šä¹‰äº†ã€ŒæŒ‡å‘ä¸‹ä¸€ä¸ªè·³è¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆã€å’Œã€Œè·¨åº¦ã€ï¼Œè·¨åº¦æ—¶ç”¨æ¥è®°å½•ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»



æ¯”å¦‚ï¼Œä¸‹é¢è¿™å¼ å›¾ï¼Œå±•ç¤ºäº†å„ä¸ªèŠ‚ç‚¹çš„è·¨åº¦ã€‚

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/3%E5%B1%82%E8%B7%B3%E8%A1%A8-%E8%B7%A8%E5%BA%A6.png)







è·³è¡¨çš„æŸ¥è¯¢ï¼š

æŸ¥æ‰¾ä¸€ä¸ªè·³è¡¨èŠ‚ç‚¹çš„è¿‡ç¨‹æ—¶ï¼Œè·³è¡¨ä¼šä»å¤´èŠ‚ç‚¹çš„æœ€é«˜å±‚å¼€å§‹ï¼Œé€ä¸€éå†æ¯ä¸€å±‚ã€‚åœ¨éå†æŸä¸€å±‚çš„è·³è¡¨èŠ‚ç‚¹æ—¶ï¼Œä¼šç”¨è·³è¡¨èŠ‚ç‚¹ä¸­çš„ SDS ç±»å‹çš„å…ƒç´ å’Œå…ƒç´ çš„æƒé‡æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå…±æœ‰ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ï¼š

- å¦‚æœå½“å‰èŠ‚ç‚¹çš„æƒé‡ã€Œå°äºã€è¦æŸ¥æ‰¾çš„æƒé‡æ—¶ï¼Œè·³è¡¨å°±ä¼šè®¿é—®è¯¥å±‚ä¸Šçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
- å¦‚æœå½“å‰èŠ‚ç‚¹çš„æƒé‡ã€Œç­‰äºã€è¦æŸ¥æ‰¾çš„æƒé‡æ—¶ï¼Œå¹¶ä¸”å½“å‰èŠ‚ç‚¹çš„ SDS ç±»å‹æ•°æ®ã€Œå°äºã€è¦æŸ¥æ‰¾çš„æ•°æ®æ—¶ï¼Œè·³è¡¨å°±ä¼šè®¿é—®è¯¥å±‚ä¸Šçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

å¦‚æœä¸Šé¢ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºæ—¶ï¼Œè·³è¡¨å°±ä¼šä½¿ç”¨ç›®å‰éå†åˆ°çš„èŠ‚ç‚¹çš„ level æ•°ç»„é‡Œçš„ä¸‹ä¸€å±‚æŒ‡é’ˆï¼Œç„¶åæ²¿ç€ä¸‹ä¸€å±‚æŒ‡é’ˆç»§ç»­æŸ¥æ‰¾ï¼Œè¿™å°±ç›¸å½“äºè·³åˆ°äº†ä¸‹ä¸€å±‚æ¥ç€æŸ¥æ‰¾

ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹å›¾æœ‰ä¸ª 3 å±‚çº§çš„è·³è¡¨ã€‚

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/3%E5%B1%82%E8%B7%B3%E8%A1%A8-%E8%B7%A8%E5%BA%A6.drawio.png)

å¦‚æœè¦æŸ¥æ‰¾ã€Œå…ƒç´ ï¼šabcdï¼Œæƒé‡ï¼š4ã€çš„èŠ‚ç‚¹ï¼ŒæŸ¥æ‰¾çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š

- å…ˆä»å¤´èŠ‚ç‚¹çš„æœ€é«˜å±‚å¼€å§‹ï¼ŒL2 æŒ‡å‘äº†ã€Œå…ƒç´ ï¼šabcï¼Œæƒé‡ï¼š3ã€èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„æƒé‡æ¯”è¦æŸ¥æ‰¾èŠ‚ç‚¹çš„å°ï¼Œæ‰€ä»¥è¦è®¿é—®è¯¥å±‚ä¸Šçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼›
- ä½†æ˜¯è¯¥å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ç©ºèŠ‚ç‚¹ï¼ˆ leve[2]æŒ‡å‘çš„æ˜¯ç©ºèŠ‚ç‚¹ï¼‰ï¼Œäºæ˜¯å°±ä¼šè·³åˆ°ã€Œå…ƒç´ ï¼šabcï¼Œæƒé‡ï¼š3ã€èŠ‚ç‚¹çš„ä¸‹ä¸€å±‚å»æ‰¾ï¼Œä¹Ÿå°±æ˜¯ leve[1];
- ã€Œå…ƒç´ ï¼šabcï¼Œæƒé‡ï¼š3ã€èŠ‚ç‚¹çš„ leve[1] çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†ã€Œå…ƒç´ ï¼šabcdeï¼Œæƒé‡ï¼š4ã€çš„èŠ‚ç‚¹ï¼Œç„¶åå°†å…¶å’Œè¦æŸ¥æ‰¾çš„èŠ‚ç‚¹æ¯”è¾ƒã€‚è™½ç„¶ã€Œå…ƒç´ ï¼šabcdeï¼Œæƒé‡ï¼š4ã€çš„èŠ‚ç‚¹çš„æƒé‡å’Œè¦æŸ¥æ‰¾çš„æƒé‡ç›¸åŒï¼Œä½†æ˜¯å½“å‰èŠ‚ç‚¹çš„ SDS ç±»å‹æ•°æ®ã€Œå¤§äºã€è¦æŸ¥æ‰¾çš„æ•°æ®ï¼Œæ‰€ä»¥ä¼šç»§ç»­è·³åˆ°ã€Œå…ƒç´ ï¼šabcï¼Œæƒé‡ï¼š3ã€èŠ‚ç‚¹çš„ä¸‹ä¸€å±‚å»æ‰¾ï¼Œä¹Ÿå°±æ˜¯ leve[0]ï¼›
- ã€Œå…ƒç´ ï¼šabcï¼Œæƒé‡ï¼š3ã€èŠ‚ç‚¹çš„ leve[0] çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†ã€Œå…ƒç´ ï¼šabcdï¼Œæƒé‡ï¼š4ã€çš„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹æ­£æ˜¯è¦æŸ¥æ‰¾çš„èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢ç»“æŸ











## BitMap









# æ¶ˆæ¯é˜Ÿåˆ—







## æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼è¿˜æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Ÿ

æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ç”¨äºå®ç°å‘å¸ƒè®¢é˜…æ¨¡å¼æˆ–ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå–å†³äºå…·ä½“çš„ä½¿ç”¨æ–¹å¼å’Œè®¾è®¡ã€‚

1. å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼š åœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å……å½“äº†æ¶ˆæ¯çš„ä¸­ä»‹ï¼Œå…è®¸å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯è€Œä¸å¿…ç›´æ¥å°†æ¶ˆæ¯ä¼ é€’ç»™ç‰¹å®šçš„è®¢é˜…è€…ã€‚å‘å¸ƒè€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åè®¢é˜…è€…ä»é˜Ÿåˆ—ä¸­è®¢é˜…æ„Ÿå…´è¶£çš„æ¶ˆæ¯ã€‚å½“æ–°çš„æ¶ˆæ¯è¢«å‘å¸ƒåˆ°é˜Ÿåˆ—æ—¶ï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ¥æ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚è¿™ç§æ¨¡å¼å¹¿æ³›åº”ç”¨äºè§£è€¦å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´çš„å…³ç³»ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ çµæ´»å’Œå¯æ‰©å±•ã€‚
2. ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼š åœ¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å……å½“äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„ç¼“å†²åŒºã€‚ç”Ÿäº§è€…å°†æ¶ˆæ¯æ”¾å…¥é˜Ÿåˆ—ï¼Œè€Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆåœ°è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿä»¥ä¸åŒçš„é€Ÿç‡å·¥ä½œè€Œä¸ä¼šç›¸äº’é˜»å¡ã€‚è¿™ç§æ¨¡å¼åœ¨å¼‚æ­¥ä»»åŠ¡å¤„ç†ã€æµé‡æ§åˆ¶å’Œå‰Šå³°å¡«è°·ç­‰åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

æ€»ç»“ï¼šæ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«ä¸æ˜¯ç»‘å®šåˆ°ç‰¹å®šæ¨¡å¼çš„ï¼Œè€Œæ˜¯ä¸€ç§é€šç”¨çš„é€šä¿¡æ–¹å¼ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚ä½¿ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼æˆ–ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ã€‚å®é™…ä¸Šï¼Œä¸€äº›æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ˆå¦‚RabbitMQï¼‰æ”¯æŒåŒæ—¶å®ç°è¿™ä¸¤ç§æ¨¡å¼ï¼Œç”šè‡³æ›´å¤šå…¶ä»–é€šä¿¡æ¨¡å¼ï¼Œå› æ­¤å¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©æœ€é€‚åˆçš„ä½¿ç”¨æ–¹å¼







## ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹ï¼Ÿ

ä¼˜ç‚¹ä¸ç”¨å¤šè¯´ï¼Œå°±æ˜¯**åœ¨ç‰¹æ®Šåœºæ™¯ä¸‹æœ‰å…¶å¯¹åº”çš„å¥½å¤„**ï¼Œ**è§£è€¦**ã€**å¼‚æ­¥**ã€**å‰Šå³°**





**å¼•å…¥ MQ æ¶ˆæ¯ä¸­é—´ä»¶å®ç°ç³»ç»Ÿè§£è€¦ï¼Œä¼šå½±å“ç³»ç»Ÿä¹‹é—´æ•°æ®ä¼ è¾“çš„ä¸€è‡´æ€§**ã€‚ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´å­˜åœ¨æ•°æ®åŒæ­¥ï¼Œå°±ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚åŒç†ï¼Œåœ¨è¿™ä¸€è®²ä½ è¦è§£å†³çš„å°±æ˜¯ï¼šæ¶ˆæ¯ç”Ÿäº§ç«¯å’Œæ¶ˆæ¯æ¶ˆè´¹ç«¯çš„æ¶ˆæ¯æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼ˆä¹Ÿå°±æ˜¯å¦‚ä½•ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼‰ã€‚

è€Œå¼•å…¥ MQ æ¶ˆæ¯ä¸­é—´ä»¶è§£å†³æµé‡æ§åˆ¶ï¼Œ ä¼šä½¿æ¶ˆè´¹ç«¯å¤„ç†èƒ½åŠ›ä¸è¶³ä»è€Œå¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼Œè¿™ä¹Ÿæ˜¯ä½ è¦è§£å†³çš„é—®é¢˜ã€‚



æ•…ç¼ºç‚¹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹å‡ ä¸ªï¼š

- ç³»ç»Ÿå¯ç”¨æ€§é™ä½

  ç³»ç»Ÿå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œè¶Šå®¹æ˜“æŒ‚æ‰ã€‚æœ¬æ¥ä½ å°±æ˜¯ A ç³»ç»Ÿè°ƒç”¨ BCD ä¸‰ä¸ªç³»ç»Ÿçš„æ¥å£å°±å¥½äº†ï¼ŒABCD å››ä¸ªç³»ç»Ÿè¿˜å¥½å¥½çš„ï¼Œæ²¡å•¥é—®é¢˜ï¼Œä½ ååŠ ä¸ª MQ è¿›æ¥ï¼Œä¸‡ä¸€ MQ æŒ‚äº†å’‹æ•´ï¼ŸMQ ä¸€æŒ‚ï¼Œæ•´å¥—ç³»ç»Ÿå´©æºƒï¼Œä½ ä¸å°±å®Œäº†ï¼Ÿ

- ç³»ç»Ÿå¤æ‚åº¦æé«˜

  ç¡¬ç”Ÿç”ŸåŠ ä¸ª MQ è¿›æ¥ï¼Œä½ æ€ä¹ˆ[ä¿è¯æ¶ˆæ¯æ²¡æœ‰é‡å¤æ¶ˆè´¹](https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-that-messages-are-not-repeatedly-consumed)ï¼Ÿæ€ä¹ˆ[å¤„ç†æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µ](https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-the-reliable-transmission-of-messages)ï¼Ÿæ€ä¹ˆä¿è¯æ¶ˆæ¯ä¼ é€’çš„é¡ºåºæ€§ï¼Ÿå¤´å¤§å¤´å¤§ï¼Œé—®é¢˜ä¸€å¤§å †ï¼Œç—›è‹¦ä¸å·²ã€‚

- ä¸€è‡´æ€§é—®é¢˜

  A ç³»ç»Ÿå¤„ç†å®Œäº†ç›´æ¥è¿”å›æˆåŠŸäº†ï¼Œäººéƒ½ä»¥ä¸ºä½ è¿™ä¸ªè¯·æ±‚å°±æˆåŠŸäº†ï¼›ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œè¦æ˜¯ BCD ä¸‰ä¸ªç³»ç»Ÿé‚£é‡Œï¼ŒBD ä¸¤ä¸ªç³»ç»Ÿå†™åº“æˆåŠŸäº†ï¼Œç»“æœ C ç³»ç»Ÿå†™åº“å¤±è´¥äº†ï¼Œå’‹æ•´ï¼Ÿä½ è¿™æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚

  æ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—å®é™…æ˜¯ä¸€ç§éå¸¸å¤æ‚çš„æ¶æ„ï¼Œä½ å¼•å…¥å®ƒæœ‰å¾ˆå¤šå¥½å¤„ï¼Œä½†æ˜¯ä¹Ÿå¾—é’ˆå¯¹å®ƒå¸¦æ¥çš„åå¤„åšå„ç§é¢å¤–çš„æŠ€æœ¯æ–¹æ¡ˆå’Œæ¶æ„æ¥è§„é¿æ‰ï¼Œåšå¥½ä¹‹åï¼Œä½ ä¼šå‘ç°ï¼Œå¦ˆå‘€ï¼Œç³»ç»Ÿå¤æ‚åº¦æå‡äº†ä¸€ä¸ªæ•°é‡çº§ï¼Œä¹Ÿè®¸æ˜¯å¤æ‚äº† 10 å€ã€‚
  
  



## ä¸åŒæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”



[`Kafka`ã€`ActiveMQ`ã€`RabbitMQ`ã€`RocketMQ`] æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹ï¼Ÿ

| ç‰¹æ€§                     | ActiveMQ                              | RabbitMQ                                           | RocketMQ                                                     | Kafka                                                        |
| ------------------------ | ------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| å•æœºååé‡               | ä¸‡çº§ï¼Œæ¯” RocketMQã€Kafka ä½ä¸€ä¸ªæ•°é‡çº§ | åŒ ActiveMQ                                        | 10 ä¸‡çº§ï¼Œæ”¯æ’‘é«˜åå                                          | 10 ä¸‡çº§ï¼Œé«˜ååï¼Œä¸€èˆ¬**é…åˆå¤§æ•°æ®ç±»**çš„ç³»ç»Ÿæ¥è¿›è¡Œå®æ—¶æ•°æ®è®¡ç®—ã€**æ—¥å¿—é‡‡é›†**ç­‰åœºæ™¯ |
| topic æ•°é‡å¯¹ååé‡çš„å½±å“ |                                       |                                                    | topic å¯ä»¥è¾¾åˆ°å‡ ç™¾/å‡ åƒçš„çº§åˆ«ï¼Œååé‡ä¼šæœ‰è¾ƒå°å¹…åº¦çš„ä¸‹é™ï¼Œè¿™æ˜¯ RocketMQ çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼Œå¯ä»¥æ”¯æ’‘å¤§é‡çš„ topic | topic ä»å‡ ååˆ°å‡ ç™¾ä¸ªæ—¶å€™ï¼Œååé‡ä¼šå¤§å¹…åº¦ä¸‹é™ï¼Œåœ¨åŒç­‰æœºå™¨ä¸‹ï¼ŒKafka å°½é‡ä¿è¯ topic æ•°é‡ä¸è¦è¿‡å¤šï¼Œå¦‚æœè¦æ”¯æ’‘å¤§è§„æ¨¡çš„ topicï¼Œéœ€è¦å¢åŠ æ›´å¤šçš„æœºå™¨èµ„æº |
| æ—¶æ•ˆæ€§                   | ms çº§                                 | å¾®ç§’çº§ï¼Œè¿™æ˜¯ RabbitMQ çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå»¶è¿Ÿæœ€ä½         | ms çº§                                                        | å»¶è¿Ÿåœ¨ ms çº§ä»¥å†…                                             |
| å¯ç”¨æ€§                   | é«˜ï¼ŒåŸºäºä¸»ä»æ¶æ„å®ç°é«˜å¯ç”¨            | åŒ ActiveMQ                                        | éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼æ¶æ„                                           | éå¸¸é«˜ï¼Œåˆ†å¸ƒå¼ï¼Œä¸€ä¸ªæ•°æ®å¤šä¸ªå‰¯æœ¬ï¼Œå°‘æ•°æœºå™¨å®•æœºï¼Œä¸ä¼šä¸¢å¤±æ•°æ®ï¼Œä¸ä¼šå¯¼è‡´ä¸å¯ç”¨ |
| æ¶ˆæ¯å¯é æ€§               | æœ‰è¾ƒä½çš„æ¦‚ç‡ä¸¢å¤±æ•°æ®                  | åŸºæœ¬ä¸ä¸¢                                           | ç»è¿‡å‚æ•°ä¼˜åŒ–é…ç½®ï¼Œå¯ä»¥åšåˆ° 0 ä¸¢å¤±                            | åŒ RocketMQ                                                  |
| åŠŸèƒ½æ”¯æŒ                 | MQ é¢†åŸŸçš„åŠŸèƒ½æå…¶å®Œå¤‡                 | åŸºäº erlang å¼€å‘ï¼Œå¹¶å‘èƒ½åŠ›å¾ˆå¼ºï¼Œæ€§èƒ½æå¥½ï¼Œå»¶æ—¶å¾ˆä½ | MQ åŠŸèƒ½è¾ƒä¸ºå®Œå–„ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰©å±•æ€§å¥½                      | åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼Œä¸»è¦æ”¯æŒç®€å•çš„ MQ åŠŸèƒ½ï¼Œåœ¨å¤§æ•°æ®é¢†åŸŸçš„å®æ—¶è®¡ç®—ä»¥åŠæ—¥å¿—é‡‡é›†è¢«å¤§è§„æ¨¡ä½¿ç”¨ |







## æ€ä¹ˆä¿è¯æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹çš„å¹‚ç­‰æ€§ï¼Ÿ

è¿˜æ˜¯å¾—ç»“åˆä¸šåŠ¡æ¥æ€è€ƒï¼Œè¿™é‡Œç»™å‡ ä¸ªæ€è·¯ï¼š

- æ¯”å¦‚ä½ æ‹¿ä¸ªæ•°æ®è¦å†™åº“ï¼Œä½ å…ˆæ ¹æ®ä¸»é”®æŸ¥ä¸€ä¸‹ï¼Œå¦‚æœè¿™æ•°æ®éƒ½æœ‰äº†ï¼Œä½ å°±åˆ«æ’å…¥äº†ï¼Œupdate ä¸€ä¸‹å¥½å§ã€‚
- æ¯”å¦‚ä½ æ˜¯å†™ Redisï¼Œé‚£æ²¡é—®é¢˜äº†ï¼Œåæ­£æ¯æ¬¡éƒ½æ˜¯ setï¼Œå¤©ç„¶å¹‚ç­‰æ€§ã€‚
- æ¯”å¦‚ä½ ä¸æ˜¯ä¸Šé¢ä¸¤ä¸ªåœºæ™¯ï¼Œé‚£åšçš„ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½ éœ€è¦è®©ç”Ÿäº§è€…å‘é€æ¯æ¡æ•°æ®çš„æ—¶å€™ï¼Œé‡Œé¢åŠ ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ idï¼Œç±»ä¼¼è®¢å• id ä¹‹ç±»çš„ä¸œè¥¿ï¼Œç„¶åä½ è¿™é‡Œæ¶ˆè´¹åˆ°äº†ä¹‹åï¼Œå…ˆæ ¹æ®è¿™ä¸ª id å»æ¯”å¦‚ Redis é‡ŒæŸ¥ä¸€ä¸‹ï¼Œä¹‹å‰æ¶ˆè´¹è¿‡å—ï¼Ÿå¦‚æœæ²¡æœ‰æ¶ˆè´¹è¿‡ï¼Œä½ å°±å¤„ç†ï¼Œç„¶åè¿™ä¸ª id å†™ Redisã€‚å¦‚æœæ¶ˆè´¹è¿‡äº†ï¼Œé‚£ä½ å°±åˆ«å¤„ç†äº†ï¼Œä¿è¯åˆ«é‡å¤å¤„ç†ç›¸åŒçš„æ¶ˆæ¯å³å¯ã€‚
- æ¯”å¦‚åŸºäºæ•°æ®åº“çš„å”¯ä¸€é”®æ¥ä¿è¯é‡å¤æ•°æ®ä¸ä¼šé‡å¤æ’å…¥å¤šæ¡ã€‚å› ä¸ºæœ‰å”¯ä¸€é”®çº¦æŸäº†ï¼Œé‡å¤æ•°æ®æ’å…¥åªä¼šæŠ¥é”™ï¼Œä¸ä¼šå¯¼è‡´æ•°æ®åº“ä¸­å‡ºç°è„æ•°æ®ã€‚



åœ¨æ¶ˆæ¯æ¶ˆè´¹çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°å¤±è´¥çš„æƒ…å†µï¼Œé€šè¿‡è¡¥å¿çš„æœºåˆ¶å‘é€æ–¹ä¼šæ‰§è¡Œé‡è¯•ï¼Œé‡è¯•çš„è¿‡ç¨‹å°±æœ‰å¯èƒ½äº§ç”Ÿé‡å¤çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

è¿™ä¸ªé—®é¢˜å…¶å®å¯ä»¥æ¢ä¸€ç§è¯´æ³•ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³æ¶ˆè´¹ç«¯å¹‚ç­‰æ€§é—®é¢˜ï¼ˆå¹‚ç­‰æ€§ï¼Œå°±æ˜¯ä¸€æ¡å‘½ä»¤ï¼Œä»»æ„å¤šæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒï¼‰ï¼Œåªè¦æ¶ˆè´¹ç«¯å…·å¤‡äº†å¹‚ç­‰æ€§ï¼Œé‚£ä¹ˆé‡å¤æ¶ˆè´¹æ¶ˆæ¯çš„é—®é¢˜ä¹Ÿå°±è§£å†³äº†ã€‚

æˆ‘ä»¬è¿˜æ˜¯æ¥çœ‹æ‰£å‡äº¬è±†çš„ä¾‹å­ï¼Œå°†è´¦æˆ· X çš„é‡‘è±†ä¸ªæ•°æ‰£å‡ 100 ä¸ªï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹é€ ä¸šåŠ¡é€»è¾‘ï¼Œè®©å®ƒå…·å¤‡å¹‚ç­‰æ€§ã€‚

<img src="https://cdn.tobebetterjavaer.com/tobebetterjavaer/images/mq/100-budiushi-9d864624-2136-4770-942b-9a5f70c2aaf6.png" alt="img" style="zoom:67%;" />

æœ€ç®€å•çš„å®ç°æ–¹æ¡ˆï¼Œå°±æ˜¯åœ¨æ•°æ®åº“ä¸­å»ºä¸€å¼ æ¶ˆæ¯æ—¥å¿—è¡¨ï¼Œ è¿™ä¸ªè¡¨æœ‰ä¸¤ä¸ªå­—æ®µï¼šæ¶ˆæ¯ ID å’Œæ¶ˆæ¯æ‰§è¡ŒçŠ¶æ€ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬æ¶ˆè´¹æ¶ˆæ¯çš„é€»è¾‘å¯ä»¥å˜ä¸ºï¼šåœ¨æ¶ˆæ¯æ—¥å¿—è¡¨ä¸­å¢åŠ ä¸€æ¡æ¶ˆæ¯è®°å½•ï¼Œç„¶åå†æ ¹æ®æ¶ˆæ¯è®°å½•ï¼Œå¼‚æ­¥æ“ä½œæ›´æ–°ç”¨æˆ·äº¬è±†ä½™é¢ã€‚

å› ä¸ºæˆ‘ä»¬æ¯æ¬¡éƒ½ä¼šåœ¨æ’å…¥ä¹‹å‰æ£€æŸ¥æ˜¯å¦æ¶ˆæ¯å·²å­˜åœ¨ï¼Œæ‰€ä»¥å°±ä¸ä¼šå‡ºç°ä¸€æ¡æ¶ˆæ¯è¢«æ‰§è¡Œå¤šæ¬¡çš„æƒ…å†µï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªå¹‚ç­‰çš„æ“ä½œã€‚å½“ç„¶ï¼ŒåŸºäºè¿™ä¸ªæ€è·¯ï¼Œä¸ä»…å¯ä»¥ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Redis æ¥ä»£æ›¿æ•°æ®åº“å®ç°å”¯ä¸€çº¦æŸçš„æ–¹æ¡ˆã€‚

åœ¨è¿™é‡Œæˆ‘å¤šè¯´ä¸€å¥ï¼Œæƒ³è¦è§£å†³â€œæ¶ˆæ¯ä¸¢å¤±â€å’Œâ€œæ¶ˆæ¯é‡å¤æ¶ˆè´¹â€çš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªå‰ææ¡ä»¶å°±æ˜¯è¦å®ç°ä¸€ä¸ªå…¨å±€å”¯ä¸€ ID ç”Ÿæˆçš„æŠ€æœ¯æ–¹æ¡ˆã€‚è¿™ä¹Ÿæ˜¯é¢è¯•å®˜å–œæ¬¢è€ƒå¯Ÿçš„é—®é¢˜ï¼Œä½ ä¹Ÿè¦æŒæ¡ã€‚









## å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ä¼ è¾“ï¼Ÿ

æ•°æ®çš„ä¸¢å¤±é—®é¢˜ï¼Œå¯èƒ½å‡ºç°åœ¨ç”Ÿäº§è€…ã€MQã€æ¶ˆè´¹è€…ä¸­ï¼Œå…ˆä» `RabbitMQ` æ¥åˆ†æä¸€ä¸‹å§ã€‚

é¦–å…ˆè¦çŸ¥é“`rabbitmq`æ˜¯æŠŠæ¶ˆæ¯å­˜æ”¾åœ¨å†…å­˜ä¸­çš„

> RabbitMQå’ŒRocketMQåœ¨æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–æ–¹é¢æœ‰ä¸€äº›ä¸åŒçš„ç­–ç•¥
>
> 
>
> **RabbitMQï¼š** RabbitMQé»˜è®¤æƒ…å†µä¸‹å°†æ¶ˆæ¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿™ä½¿å¾—å®ƒèƒ½å¤Ÿæä¾›ä½å»¶è¿Ÿå’Œé«˜ååé‡çš„æ¶ˆæ¯ä¼ é€’ã€‚ç„¶è€Œï¼Œè¿™ä¹Ÿæ„å‘³ç€å¦‚æœRabbitMQæœåŠ¡å™¨åœ¨æ•…éšœæˆ–é‡å¯æ—¶ï¼Œå†…å­˜ä¸­å­˜å‚¨çš„æ¶ˆæ¯å°†ä¼šä¸¢å¤±ã€‚
>
> ä¸ºäº†ç¡®ä¿æ¶ˆæ¯çš„æŒä¹…æ€§ï¼ŒRabbitMQæä¾›äº†æŒä¹…åŒ–é€‰é¡¹ã€‚å½“å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…åŒ–æ—¶ï¼ŒRabbitMQä¼šå°†æ¶ˆæ¯å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„æŒä¹…åŒ–æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åœ¨é‡å¯åèƒ½å¤Ÿæ¢å¤æ¶ˆæ¯ã€‚åŒæ—¶ï¼Œé˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šçš„å…ƒæ•°æ®ä¹Ÿå¯ä»¥è¢«æ ‡è®°ä¸ºæŒä¹…åŒ–ï¼Œä»¥ç¡®ä¿åœ¨é‡å¯åèƒ½å¤Ÿæ¢å¤å®ƒä»¬ã€‚
>
> 
>
> **RocketMQï¼š** RocketMQåœ¨è®¾è®¡ä¸Šæ›´åŠ åå‘äºæ•°æ®æŒä¹…æ€§ï¼Œå®ƒå°†æ¶ˆæ¯é»˜è®¤å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚æ¶ˆæ¯å­˜å‚¨ä½¿ç”¨ç£ç›˜æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼Œè¿™ä½¿å¾—RocketMQèƒ½å¤Ÿæä¾›æ›´é«˜çš„æ¶ˆæ¯æŒä¹…æ€§å’Œæ•°æ®å®‰å…¨æ€§ã€‚
>
> RocketMQæ”¯æŒå¤šç§å­˜å‚¨æ¨¡å¼ï¼ŒåŒ…æ‹¬åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ï¼Œä»¥åŠæ”¯æŒå°†æ¶ˆæ¯å­˜å‚¨åˆ°ç‰©ç†ç£ç›˜çš„ CommitLog å’Œæ¶ˆæ¯ç´¢å¼•æ–‡ä»¶ã€‚è¿™äº›ç‰¹æ€§ä½¿å¾—RocketMQèƒ½å¤Ÿåœ¨é¢å¯¹é‡å¯ã€æ•…éšœå’Œå´©æºƒæ—¶æ›´å¥½åœ°ä¿æŒæ•°æ®çš„å¯é æ€§ã€‚



![rabbitmq-message-lose](https://doocs.github.io/advanced-java/docs/high-concurrency/images/rabbitmq-message-lose.png)



**1ã€ç”Ÿäº§è€…ä¸¢å¤±æ¶ˆæ¯**

ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœè¦ç¡®ä¿è¯´å†™ RabbitMQ çš„æ¶ˆæ¯åˆ«ä¸¢ï¼Œå¯ä»¥å¼€å¯ `confirm` æ¨¡å¼ï¼Œåœ¨ç”Ÿäº§è€…é‚£é‡Œè®¾ç½®å¼€å¯ `confirm` æ¨¡å¼ä¹‹åï¼Œä½ æ¯æ¬¡å†™çš„æ¶ˆæ¯éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ idï¼Œç„¶åå¦‚æœå†™å…¥äº† RabbitMQ ä¸­ï¼ŒRabbitMQ ä¼šç»™ä½ å›ä¼ ä¸€ä¸ª `ack` æ¶ˆæ¯ï¼Œå‘Šè¯‰ä½ è¯´è¿™ä¸ªæ¶ˆæ¯ ok äº†ã€‚å¦‚æœ RabbitMQ æ²¡èƒ½å¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œä¼šå›è°ƒä½ çš„ä¸€ä¸ª `nack` æ¥å£ï¼Œå‘Šè¯‰ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶å¤±è´¥ï¼Œä½ å¯ä»¥é‡è¯•ã€‚è€Œä¸”ä½ å¯ä»¥ç»“åˆè¿™ä¸ªæœºåˆ¶è‡ªå·±åœ¨å†…å­˜é‡Œç»´æŠ¤æ¯ä¸ªæ¶ˆæ¯ id çš„çŠ¶æ€ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´è¿˜æ²¡æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯çš„å›è°ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥é‡å‘ã€‚

äº‹åŠ¡æœºåˆ¶å’Œ `confirm` æœºåˆ¶æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œ**äº‹åŠ¡æœºåˆ¶æ˜¯åŒæ­¥çš„**ï¼Œä½ æäº¤ä¸€ä¸ªäº‹åŠ¡ä¹‹åä¼š**é˜»å¡**åœ¨é‚£å„¿ï¼Œä½†æ˜¯ `confirm` æœºåˆ¶æ˜¯**å¼‚æ­¥**çš„ï¼Œä½ å‘é€ä¸ªæ¶ˆæ¯ä¹‹åå°±å¯ä»¥å‘é€ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œç„¶åé‚£ä¸ªæ¶ˆæ¯ RabbitMQ æ¥æ”¶äº†ä¹‹åä¼šå¼‚æ­¥å›è°ƒä½ çš„ä¸€ä¸ªæ¥å£é€šçŸ¥ä½ è¿™ä¸ªæ¶ˆæ¯æ¥æ”¶åˆ°äº†ã€‚

æ‰€ä»¥ä¸€èˆ¬åœ¨ç”Ÿäº§è€…è¿™å—**é¿å…æ•°æ®ä¸¢å¤±**ï¼Œéƒ½æ˜¯ç”¨ `confirm` æœºåˆ¶çš„ã€‚





**2ã€Rabbitmqä¸¢å¤±æ¶ˆæ¯**

é’ˆå¯¹ `RabbitMQ` è‡ªå·±å¼„ä¸¢äº†æ•°æ®çš„æƒ…å†µï¼Œè¿™æ—¶å¿…é¡»**å¼€å¯ RabbitMQ çš„æŒä¹…åŒ–æœºåˆ¶**ï¼Œå°±æ˜¯æ¶ˆæ¯å†™å…¥ä¹‹åä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå“ªæ€•æ˜¯ `RabbitMQ` è‡ªå·±æŒ‚äº†ï¼Œ**æ¢å¤ä¹‹åä¼šè‡ªåŠ¨è¯»å–ä¹‹å‰å­˜å‚¨çš„æ•°æ®**ï¼Œä¸€èˆ¬æ•°æ®ä¸ä¼šä¸¢ã€‚é™¤éæå…¶ç½•è§çš„æ˜¯ï¼Œ`RabbitMQ` è¿˜æ²¡æŒä¹…åŒ–ï¼Œè‡ªå·±å°±æŒ‚äº†ï¼Œ**å¯èƒ½å¯¼è‡´å°‘é‡æ•°æ®ä¸¢å¤±**ï¼Œä½†æ˜¯è¿™ä¸ªæ¦‚ç‡è¾ƒå°ã€‚

è®¾ç½®æŒä¹…åŒ–æœ‰**ä¸¤ä¸ªæ­¥éª¤**ï¼š

- åˆ›å»º queue çš„æ—¶å€™å°†å…¶è®¾ç½®ä¸ºæŒä¹…åŒ–ã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯ RabbitMQ æŒä¹…åŒ– queue çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ä¼šæŒä¹…åŒ– queue é‡Œçš„æ•°æ®çš„
- ç¬¬äºŒä¸ªæ˜¯å‘é€æ¶ˆæ¯çš„æ—¶å€™å°†æ¶ˆæ¯çš„ `deliveryMode` è®¾ç½®ä¸º 2ã€‚å°±æ˜¯å°†æ¶ˆæ¯è®¾ç½®ä¸ºæŒä¹…åŒ–ï¼Œæ­¤æ—¶ RabbitMQ å°±ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šå»

å¿…é¡»è¦åŒæ—¶è®¾ç½®è¿™ä¸¤ä¸ªæŒä¹…åŒ–æ‰è¡Œï¼ŒRabbitMQ å“ªæ€•æ˜¯æŒ‚äº†ï¼Œå†æ¬¡é‡å¯ï¼Œä¹Ÿä¼šä»ç£ç›˜ä¸Šé‡å¯æ¢å¤ queueï¼Œæ¢å¤è¿™ä¸ª queue é‡Œçš„æ•°æ®ã€‚

æ³¨æ„ï¼Œå“ªæ€•æ˜¯ä½ ç»™ RabbitMQ å¼€å¯äº†æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿæœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯è¿™ä¸ªæ¶ˆæ¯å†™åˆ°äº† RabbitMQ ä¸­ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œç»“æœä¸å·§ï¼Œæ­¤æ—¶ RabbitMQ æŒ‚äº†ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜é‡Œçš„ä¸€ç‚¹ç‚¹æ•°æ®ä¸¢å¤±ã€‚

æ‰€ä»¥ï¼Œ**æŒä¹…åŒ–å¯ä»¥è·Ÿç”Ÿäº§è€…é‚£è¾¹çš„ `confirm` æœºåˆ¶é…åˆèµ·æ¥ï¼Œåªæœ‰æ¶ˆæ¯è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹åï¼Œæ‰ä¼šé€šçŸ¥ç”Ÿäº§è€… `ack` äº†ï¼Œæ‰€ä»¥å“ªæ€•æ˜¯åœ¨æŒä¹…åŒ–åˆ°ç£ç›˜ä¹‹å‰ï¼ŒRabbitMQ æŒ‚äº†ï¼Œæ•°æ®ä¸¢äº†ï¼Œç”Ÿäº§è€…æ”¶ä¸åˆ° `ack` ï¼Œä½ ä¹Ÿæ˜¯å¯ä»¥è‡ªå·±é‡å‘çš„**





**3ã€æ¶ˆè´¹ç«¯ä¸¢å¤±æ¶ˆæ¯**

ä¸ºäº†ä¿è¯æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­å¯é åœ°åˆ°è¾¾æ¶ˆè´¹è€…ï¼Œ`RabbitMQ` æä¾›äº†æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ã€‚æ¶ˆè´¹è€…åœ¨å£°æ˜é˜Ÿåˆ—æ—¶ï¼Œå¯ä»¥æŒ‡å®š `noAck` å‚æ•°ï¼Œå½“ `noAck=false`ï¼Œ`RabbitMQ` ä¼šç­‰å¾…æ¶ˆè´¹è€…æ˜¾å¼å‘å› `ack` ä¿¡å·åï¼Œæ‰ä»å†…å­˜ï¼ˆå’Œç£ç›˜ï¼Œå¦‚æœæ˜¯æŒä¹…åŒ–æ¶ˆæ¯ï¼‰ä¸­ç§»å»æ¶ˆæ¯ã€‚å¦åˆ™ï¼Œä¸€æ—¦æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œ`RabbitMQ` ä¼šåœ¨é˜Ÿåˆ—ä¸­ç«‹å³åˆ é™¤å®ƒ





## Rabbitmq

RabbitMQçš„åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š

Producer æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå³ç”Ÿäº§æ–¹å®¢æˆ·ç«¯ï¼Œå°†æ¶ˆæ¯å‘é€ç»™MQ

Consumer æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå³æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œæ¥æ”¶MQå‘é€çš„ä¿¡æ¯

Broker æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡è¿›ç¨‹ï¼Œæ­¤æœåŠ¡åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼šexchangeã€queue

Exchange æ¶ˆæ¯é˜Ÿåˆ—äº¤æ¢æœºï¼Œ**äº¤æ¢æœºæŒ‰ç…§ä¸€å®šçš„è§„åˆ™å°†æ¶ˆæ¯è·¯ç”±è½¬å‘åˆ°é˜Ÿåˆ—ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œè¿‡æ»¤**ã€‚

Queue æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—å¹¶å°†æ¶ˆæ¯è½¬å‘ç»™æ¶ˆè´¹æ–¹ã€‚

ä¿¡æ¯å‘é€æ¥æ”¶æµç¨‹å¦‚ä¸‹ï¼š

å‘é€æ¶ˆæ¯ï¼š

- ç”Ÿäº§è€…å’Œbrokerå»ºç«‹TCPè¿æ¥ å³MQçš„Connection
- ç”Ÿäº§è€…å’Œbrokerå»ºç«‹é€šé“ï¼Œé€šé“æ˜¯é€šè¿‡Connectionåˆ›å»ºçš„
- ç”Ÿäº§è€…é€šè¿‡é€šé“å°†æ¶ˆæ¯å‘é€ç»™brokerï¼Œç”±exchangeå°†æ¶ˆæ¯è½¬å‘
- exchangeå°†ä¿¡æ¯è½¬å‘ç»™æŒ‡å®šçš„é˜Ÿåˆ—
  æ¥æ”¶ä¿¡æ¯ï¼š

æ¥æ”¶æ¶ˆæ¯ï¼š

- æ¶ˆè´¹è€…å’Œbrokerå»ºç«‹TCPè¿æ¥
- æ¶ˆè´¹è€…å’Œbrokerå»ºç«‹é€šé“
- æ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—
- å½“æ¶ˆæ¯åˆ°è¾¾Queueæ—¶ï¼Œbrokeré»˜è®¤å°†æ¶ˆæ¯æ¨é€ç»™æ¶ˆè´¹è€…
- æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯
  



### å·¥ä½œæ¨¡å¼





### é«˜å¯ç”¨æ€§



RabbitMQ æ˜¯æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ï¼Œå› ä¸ºæ˜¯**åŸºäºä¸»ä»**ï¼ˆéåˆ†å¸ƒå¼ï¼‰åšé«˜å¯ç”¨æ€§çš„ï¼Œæˆ‘ä»¬å°±ä»¥ RabbitMQ ä¸ºä¾‹å­è®²è§£ç¬¬ä¸€ç§ MQ çš„é«˜å¯ç”¨æ€§æ€ä¹ˆå®ç°ã€‚RabbitMQ æœ‰ä¸‰ç§æ¨¡å¼ï¼šå•æœºæ¨¡å¼ã€æ™®é€šé›†ç¾¤æ¨¡å¼ã€é•œåƒé›†ç¾¤æ¨¡å¼



[å•æœºæ¨¡å¼](https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues?id=å•æœºæ¨¡å¼)

å•æœºæ¨¡å¼ï¼Œå°±æ˜¯ Demo çº§åˆ«çš„ï¼Œä¸€èˆ¬å°±æ˜¯æœ¬åœ°å¯åŠ¨äº†ç©ç©å„¿çš„ï¼Œæ²¡äººç”Ÿäº§ç”¨å•æœºæ¨¡å¼



[æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰](https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues?id=æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰)

æ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯å°æœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚ä½ **åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Š**ï¼Œ**ä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®**ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥

<img src="https://doocs.github.io/advanced-java/docs/high-concurrency/images/mq-7.png" alt="mq-7" style="zoom: 80%;" />

è¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œ**æ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼**ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰**æ•°æ®æ‹‰å–çš„å¼€é”€**ï¼Œåè€…å¯¼è‡´**å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆ**ã€‚

è€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ **å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–**ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œ**æ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢**ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚æ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±**æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§**ï¼Œ**è¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„**ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œ







[é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰](https://doocs.github.io/advanced-java/#/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues?id=é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰)

è¿™ç§æ¨¡å¼ï¼Œæ‰æ˜¯æ‰€è°“çš„ RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œ**æ— è®ºæ˜¯å…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼šå­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Š**ï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ª**å®Œæ•´é•œåƒ**ï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠ**æ¶ˆæ¯åŒæ­¥**åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚

![mq-8](https://doocs.github.io/advanced-java/docs/high-concurrency/images/mq-8.png)

é‚£ä¹ˆ**å¦‚ä½•å¼€å¯è¿™ä¸ªé•œåƒé›†ç¾¤æ¨¡å¼**å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒRabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯**é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥**ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹ï¼Œå†æ¬¡åˆ›å»º queue çš„æ—¶å€™ï¼Œåº”ç”¨è¿™ä¸ªç­–ç•¥ï¼Œå°±ä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚

è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚



åå¤„åœ¨äºï¼š

ç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼

ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±**æ²¡æœ‰æ‰©å±•æ€§å¯è¨€**äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¸”**æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•**ä½ çš„ queue ï¼Œè¯´ç™½äº†å°±æ˜¯ä¸å¤Ÿåˆ†å¸ƒå¼  :sweat: :sweat:(æ²¡æœ‰å°†æ¶ˆæ¯åˆ†æ•£å­˜å‚¨)







## Rocketmq



> Rocketmqä¸­çš„topicæ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨`Rocketmq`ä¸­ï¼Œ"topic"ï¼ˆä¸»é¢˜ï¼‰æ˜¯ä¸€ç§ç”¨æ¥ç»„ç»‡å’Œæ ‡è¯†æ¶ˆæ¯çš„æœºåˆ¶ã€‚å®ƒé€šå¸¸ç”¨äºå‘å¸ƒ-è®¢é˜…ï¼ˆ`publish-subscribe`ï¼‰æ¨¡å¼çš„æ¶ˆæ¯ä¼ é€’ï¼Œå…¶ä¸­æ¶ˆæ¯çš„ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜ï¼Œè€Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é¢˜æ¥æ¥æ”¶æ¶ˆæ¯















# Nginx





â€‹     

## æ­£/åå‘ä»£ç†



1. æ­£å‘ä»£ç†ï¼š

æ­£å‘ä»£ç†æœåŠ¡å™¨ä»£è¡¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å°†è¯·æ±‚å‘é€ç»™ä»£ç†æœåŠ¡å™¨ï¼Œç„¶åä»£ç†æœåŠ¡å™¨å°†è¯·æ±‚å‘é€åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œå¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»£ç†æœåŠ¡å™¨ç¡®å®å¯ä»¥éšè—å®¢æˆ·ç«¯çš„çœŸå®èº«ä»½ï¼Œå› ä¸ºç›®æ ‡æœåŠ¡å™¨åªèƒ½çœ‹åˆ°ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€ï¼Œæ— æ³•ç›´æ¥è¯†åˆ«çœŸæ­£çš„å®¢æˆ·ç«¯ã€‚ä½†å¹¶ä¸æ˜¯è¯´ä»£ç†æœåŠ¡å™¨å®Œå…¨å±è”½äº†å®¢æˆ·ç«¯ï¼Œå®ƒåªæ˜¯èµ·åˆ°äº†ä¸­é—´äººçš„è§’è‰²ï¼Œå¸®åŠ©å®¢æˆ·ç«¯è®¿é—®å¤–éƒ¨èµ„æº



2. åå‘ä»£ç†ï¼š

åå‘ä»£ç†æœåŠ¡å™¨ä½äºæœåŠ¡å™¨ç«¯ï¼Œå®ƒæ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å°†è¿™äº›è¯·æ±‚åˆ†å‘ç»™åç«¯çš„å¤šä¸ªæœåŠ¡å™¨ã€‚å®¢æˆ·ç«¯åªçŸ¥é“åå‘ä»£ç†çš„å­˜åœ¨ï¼Œä¸ç›´æ¥ä¸åç«¯æœåŠ¡å™¨é€šä¿¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¹¶ä¸èƒ½è¯´åå‘ä»£ç†å®Œå…¨å±è”½äº†æœåŠ¡ç«¯ï¼Œå®é™…ä¸Šï¼Œåå‘ä»£ç†å°†è¯·æ±‚åˆ†å‘ç»™åç«¯æœåŠ¡å™¨ï¼Œç„¶åå°†åç«¯æœåŠ¡å™¨çš„å“åº”è¿”å›ç»™å®¢æˆ·ç«¯





å‡è®¾æˆ‘ä»¬è¦è¾¾åˆ°ä¸€ä¸ªæ•ˆæœï¼Œè®¿é—®`127.0.0.1:9999`ï¼Œåå‘ä»£ç†åˆ°æˆ‘ä»¬çš„ç½‘ç«™https://www.aaa.cn

å…ˆçœ‹ä¸‹`nginx`çš„é…ç½®ï¼š

```conf
server {
   listen 9999;  # ç›‘å¬çš„ç«¯å£
   server_name localhost;   # è¡¨ç¤ºnginxç›‘å¬çš„åœ°å€
   location / {
        proxy_pass https://www.aaa.cn;   # è½¬å‘åˆ° www.aaa.cn
   }
}
```

- listenï¼šè¡¨ç¤º nginx ç›‘å¬çš„ç«¯å£ï¼Œä¹Ÿå°±æ˜¯ä½ åœ¨æµè§ˆå™¨è¾“å…¥çš„ç«¯å£å·ã€‚
- server_nameï¼šè¡¨ç¤º nginx ç›‘å¬çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä½ åœ¨æµè§ˆå™¨è¾“å…¥çš„åœ°å€æˆ–è€…åŸŸå
- locationï¼šç”¨æ¥åŒ¹é…ä¸åŒçš„urlï¼Œè¿™é‡Œ/ä»£è¡¨æ ¹è·¯å¾„ã€‚
- proxy_passï¼šä»£ç†çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬è¿™é‡Œæ˜¯ä»£ç†åˆ°https://www.aaa.cn





## å¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡ï¼Ÿ



Nginxè´Ÿè½½å‡è¡¡æ˜¯é€šè¿‡`upstream`æ¨¡å—æ¥å®ç°çš„ï¼Œå†…ç½®å®ç°äº†ä¸‰ç§è´Ÿè½½ç­–ç•¥ï¼Œé…ç½®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„

> `upstream` æ¨¡å—æ˜¯ `Nginx` ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œç”¨äºå®šä¹‰ä¸€ç»„åç«¯æœåŠ¡å™¨ï¼ˆä¹Ÿç§°ä¸ºä¸Šæ¸¸æœåŠ¡å™¨ï¼‰ï¼Œå¹¶ä¸ºè¿™äº›æœåŠ¡å™¨å®ç°è´Ÿè½½å‡è¡¡ã€‚é€šè¿‡ `upstream` æ¨¡å—ï¼Œæ‚¨å¯ä»¥å°†è¯·æ±‚åˆ†å‘ç»™ä¸€ç»„æœåŠ¡å™¨ï¼Œä»è€Œå®ç°é«˜å¯ç”¨æ€§å’Œæ€§èƒ½ä¼˜åŒ–



- è½®å¾ªï¼ˆé»˜è®¤ï¼‰ 

Nginxæ ¹æ®è¯·æ±‚æ¬¡æ•°ï¼Œå°†æ¯ä¸ªè¯·æ±‚å‡åŒ€åˆ†é…åˆ°æ¯å°æœåŠ¡å™¨

- æœ€å°‘è¿æ¥ 

å°†è¯·æ±‚åˆ†é…ç»™è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ã€‚Nginxä¼šç»Ÿè®¡å“ªäº›æœåŠ¡å™¨çš„è¿æ¥æ•°æœ€å°‘

- IP Hash 

ç»‘å®šå¤„ç†è¯·æ±‚çš„æœåŠ¡å™¨ã€‚ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œæ ¹æ®è¯¥å®¢æˆ·ç«¯çš„IPç®—å‡ºä¸€ä¸ªHASHå€¼ï¼Œå°†è¯·æ±‚åˆ†é…åˆ°é›†ç¾¤ä¸­çš„æŸä¸€å°æœåŠ¡å™¨ä¸Šã€‚åé¢è¯¥å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚ï¼Œéƒ½å°†é€šè¿‡HASHç®—æ³•ï¼Œæ‰¾åˆ°ä¹‹å‰å¤„ç†è¿™å°å®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡å™¨ï¼Œç„¶åå°†è¯·æ±‚äº¤ç»™å®ƒæ¥å¤„ç†



**è½®è¯¢ï¼š**

```
http {

    # ... çœç•¥å…¶å®ƒé…ç½®

    upstream tomcats {
        server 192.168.0.100:8080;
        server 192.168.0.101:8080;
        server example.com:8080;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://tomcats;
        }
    }

    # ... çœç•¥å…¶å®ƒé…ç½®
}
```



**æƒé‡ï¼š**

```
upstream tomcats {
    server 192.168.0.100:8080 weight=2;  # 2/6æ¬¡
    server 192.168.0.101:8080 weight=3;  # 3/6æ¬¡
    server 192.168.0.102:8080 weight=1;  # 1/6æ¬¡
}
```







# Linux



## å¸¸ç”¨å‘½ä»¤





# åˆ†å¸ƒå¼





## CAPç†è®º

CAPç†è®ºæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿã€ç‰¹åˆ«æ˜¯åˆ†å¸ƒå¼å­˜å‚¨é¢†åŸŸä¸­è¢«è®¨è®ºçš„æœ€å¤šçš„ç†è®ºã€‚å…¶ä¸­Cä»£è¡¨ä¸€è‡´æ€§ (Consistency)ï¼ŒAä»£è¡¨å¯ç”¨æ€§ (Availability)ï¼ŒPä»£è¡¨åˆ†åŒºå®¹é”™æ€§ (Partition tolerance)ã€‚CAPç†è®ºå‘Šè¯‰æˆ‘ä»¬Cã€Aã€Pä¸‰è€…ä¸èƒ½åŒæ—¶æ»¡è¶³ï¼Œæœ€å¤šåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ª(**å› ä¸ºåˆ†åŒºå®¹å¿æ€§ï¼ˆpartition toleranceï¼‰çš„å­˜åœ¨ï¼Œå°±å¿…å®šè¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿå¯ç”¨æ€§ï¼ˆavailabilityï¼‰å’Œæ•°æ®ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ä¸­åšå‡ºæƒè¡¡**)ï¼Œè¿™å°±æ˜¯è‘—åçš„ `CAP` å®šç†ã€‚

`ä¸€è‡´æ€§ (Consistency)`: ä¸€ä¸ªå†™æ“ä½œè¿”å›æˆåŠŸï¼Œé‚£ä¹ˆä¹‹åçš„è¯»è¯·æ±‚éƒ½å¿…é¡»è¯»åˆ°è¿™ä¸ªæ–°æ•°æ®ï¼›å¦‚æœè¿”å›å¤±è´¥ï¼Œé‚£ä¹ˆæ‰€æœ‰è¯»æ“ä½œéƒ½ä¸èƒ½è¯»åˆ°è¿™ä¸ªæ•°æ®ã€‚**æ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®ã€‚**

`å¯ç”¨æ€§ (Availability)`: å¯¹æ•°æ®æ›´æ–°å…·å¤‡é«˜å¯ç”¨æ€§ï¼Œè¯·æ±‚èƒ½å¤ŸåŠæ—¶å¤„ç†ï¼Œ**éæ•…éšœèŠ‚ç‚¹åœ¨åˆç†çš„æ—¶é—´å†…è¿”å›åˆç†å“åº”**

`åˆ†åŒºå®¹é”™æ€§ (Partition tolerance)`: **èƒ½å®¹å¿ç½‘ç»œåˆ†åŒº**â€”â€”åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œä»ç„¶èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡ã€‚**å³è¢«åˆ†éš”çš„èŠ‚ç‚¹å¯ä»¥æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ã€‚**



**ä»€ä¹ˆæ˜¯ç½‘ç»œåˆ†åŒºï¼Ÿ**

åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œæœ¬æ¥æ˜¯è¿é€šçš„ï¼Œä½†æ˜¯å› ä¸ºæŸäº›æ•…éšœï¼ˆæ¯”å¦‚éƒ¨åˆ†èŠ‚ç‚¹ç½‘ç»œå‡ºäº†é—®é¢˜ï¼‰æŸäº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸï¼Œè¿™å°±å« **ç½‘ç»œåˆ†åŒº**ã€‚

![partition-tolerance](https://oss.javaguide.cn/2020-11/partition-tolerance.png)



**ä¸æ˜¯æ‰€è°“çš„â€œ3 é€‰ 2â€  :exclamation: :exclamation: :exclamation: **

å¤§éƒ¨åˆ†äººè§£é‡Šè¿™ä¸€å®šå¾‹æ—¶ï¼Œå¸¸å¸¸ç®€å•çš„è¡¨è¿°ä¸ºï¼šâ€œä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹å¿æ€§ä¸‰è€…ä½ åªèƒ½åŒæ—¶è¾¾åˆ°å…¶ä¸­ä¸¤ä¸ªï¼Œä¸å¯èƒ½åŒæ—¶è¾¾åˆ°â€ã€‚å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªéå¸¸å…·æœ‰è¯¯å¯¼æ€§è´¨çš„è¯´æ³•ï¼Œè€Œä¸”åœ¨ CAP ç†è®ºè¯ç”Ÿ 12 å¹´ä¹‹åï¼ŒCAP ä¹‹çˆ¶ä¹Ÿåœ¨ 2012 å¹´é‡å†™äº†ä¹‹å‰çš„è®ºæ–‡ã€‚

> **å½“å‘ç”Ÿç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦ç»§ç»­æœåŠ¡ï¼Œé‚£ä¹ˆå¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§åªèƒ½ 2 é€‰ 1ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç½‘ç»œåˆ†åŒºä¹‹åä¿è¯ P æ˜¯å‰æï¼Œå†³å®šäº† P ä¹‹åæ‰æœ‰ C å’Œ A çš„é€‰æ‹©ã€‚ä¹Ÿå°±æ˜¯è¯´åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰æˆ‘ä»¬æ˜¯å¿…é¡»è¦å®ç°çš„ã€‚**
>
> ç®€è€Œè¨€ä¹‹å°±æ˜¯ï¼š**CAP ç†è®ºä¸­åˆ†åŒºå®¹é”™æ€§ P æ˜¯ä¸€å®šè¦æ»¡è¶³çš„ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šï¼Œåªèƒ½æ»¡è¶³å¯ç”¨æ€§ A æˆ–è€…ä¸€è‡´æ€§ Cã€‚**

å› æ­¤ï¼Œ**åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸Šä¸å¯èƒ½é€‰æ‹© CA æ¶æ„ï¼Œåªèƒ½é€‰æ‹© CP æˆ–è€… AP æ¶æ„ã€‚** æ¯”å¦‚ ZooKeeperã€HBase å°±æ˜¯ CP æ¶æ„ï¼ŒCassandraã€Eureka å°±æ˜¯ AP æ¶æ„ï¼ŒNacos ä¸ä»…æ”¯æŒ CP æ¶æ„ä¹Ÿæ”¯æŒ AP æ¶æ„ã€‚

**ä¸ºå•¥ä¸å¯èƒ½é€‰æ‹© CA æ¶æ„å‘¢ï¼Ÿ** ä¸¾ä¸ªä¾‹å­ï¼šè‹¥ç³»ç»Ÿå‡ºç°â€œåˆ†åŒºâ€ï¼Œç³»ç»Ÿä¸­çš„æŸä¸ªèŠ‚ç‚¹åœ¨è¿›è¡Œå†™æ“ä½œã€‚ä¸ºäº†ä¿è¯ Cï¼Œ å¿…é¡»è¦ç¦æ­¢å…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œï¼Œè¿™å°±å’Œ A å‘ç”Ÿå†²çªäº†ã€‚å¦‚æœä¸ºäº†ä¿è¯ Aï¼Œå…¶ä»–èŠ‚ç‚¹çš„è¯»å†™æ“ä½œæ­£å¸¸çš„è¯ï¼Œé‚£å°±å’Œ C å‘ç”Ÿå†²çªäº†ã€‚

**é€‰æ‹© CP è¿˜æ˜¯ AP çš„å…³é”®åœ¨äºå½“å‰çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ²¡æœ‰å®šè®ºï¼Œæ¯”å¦‚å¯¹äºéœ€è¦ç¡®ä¿å¼ºä¸€è‡´æ€§çš„åœºæ™¯å¦‚é“¶è¡Œä¸€èˆ¬ä¼šé€‰æ‹©ä¿è¯ CP ã€‚**

å¦å¤–ï¼Œéœ€è¦è¡¥å……è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼š**å¦‚æœç½‘ç»œåˆ†åŒºæ­£å¸¸çš„è¯ï¼ˆç³»ç»Ÿåœ¨ç»å¤§éƒ¨åˆ†æ—¶å€™æ‰€å¤„çš„çŠ¶æ€ï¼‰ï¼Œä¹Ÿå°±è¯´ä¸éœ€è¦ä¿è¯ P çš„æ—¶å€™ï¼ŒC å’Œ A èƒ½å¤ŸåŒæ—¶ä¿è¯ã€‚**





è¿™é‡Œä»¥æ³¨å†Œä¸­å¿ƒæ¥æ¢è®¨ä¸€ä¸‹ CAP çš„å®é™…åº”ç”¨,æ³¨å†Œä¸­å¿ƒè´Ÿè´£æœåŠ¡åœ°å€çš„æ³¨å†Œä¸æŸ¥æ‰¾ï¼Œç›¸å½“äºç›®å½•æœåŠ¡ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åªåœ¨å¯åŠ¨æ—¶ä¸æ³¨å†Œä¸­å¿ƒäº¤äº’ï¼Œæ³¨å†Œä¸­å¿ƒä¸è½¬å‘è¯·æ±‚ï¼Œå‹åŠ›è¾ƒå°ã€‚

å¸¸è§çš„å¯ä»¥ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ç»„ä»¶æœ‰ï¼š`ZooKeeper`ã€`Eureka`ã€`Nacos`...



1. ZooKeeper

**ZooKeeper ä¿è¯çš„æ˜¯ CPã€‚** ä»»ä½•æ—¶åˆ»å¯¹ ZooKeeper çš„è®¿é—®è¯·æ±‚éƒ½èƒ½å¾—åˆ°ä¸€è‡´æ€§çš„ç»“æœï¼ŒåŒæ—¶ç³»ç»Ÿå¯¹ç½‘ç»œåˆ†å‰²å…·å¤‡å®¹é”™æ€§ï¼Œä½†æ˜¯ Zookeeper ä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚éƒ½æ˜¯å¯è¾¾çš„ã€‚

**ä¸èƒ½ä¿è¯æ¯æ¬¡æœåŠ¡è¯·æ±‚çš„å¯ç”¨æ€§ï¼š**  ä» Zookeeper çš„å®é™…åº”ç”¨æƒ…å†µæ¥çœ‹ï¼Œåœ¨ä½¿ç”¨ Zookeeper è·å–æœåŠ¡åˆ—è¡¨æ—¶ï¼Œå¦‚æœæ­¤æ—¶çš„ Zookeeper é›†ç¾¤ä¸­çš„ Leader å®•æœºäº†ï¼Œè¯¥é›†ç¾¤å°±è¦è¿›è¡Œ Leader çš„é€‰ä¸¾ï¼Œåˆæˆ–è€… Zookeeper é›†ç¾¤ä¸­åŠæ•°ä»¥ä¸ŠæœåŠ¡å™¨èŠ‚ç‚¹ä¸å¯ç”¨(ä¾‹å¦‚æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹ä¸€æ£€æµ‹åˆ°èŠ‚ç‚¹ä¸‰æŒ‚äº† ï¼ŒèŠ‚ç‚¹äºŒä¹Ÿæ£€æµ‹åˆ°èŠ‚ç‚¹ä¸‰æŒ‚äº†ï¼Œé‚£è¿™ä¸ªèŠ‚ç‚¹æ‰ç®—æ˜¯çœŸçš„æŒ‚äº†)ï¼Œé‚£ä¹ˆæ­¤æ—¶å°†æ— æ³•å¤„ç†å¤–æ¥è¯·æ±‚ã€‚æ‰€ä»¥è¯´ï¼ŒZookeeper ä¸èƒ½ä¿è¯æœåŠ¡å¯ç”¨æ€§



**è¿›è¡Œ`leader`é€‰ä¸¾æ—¶é›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨**ã€‚åœ¨ä½¿ç”¨`ZooKeeper`è·å–æœåŠ¡åˆ—è¡¨æ—¶ï¼Œå½“`leader`èŠ‚ç‚¹å› ä¸ºç½‘ç»œæ•…éšœä¸å…¶ä»–èŠ‚ç‚¹å¤±å»è”ç³»æ—¶ï¼Œ**å‰©ä½™`follower`èŠ‚ç‚¹ä¼šæŠ•ç¥¨è¿›è¡Œåˆ¤æ–­masterèŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿(ç”±å•ä¸ªèŠ‚ç‚¹åˆ¤æ–­åˆ°çš„ä¸»è§‚ä¸‹çº¿åˆ°æ‰€æœ‰èŠ‚ç‚¹è¾¾æˆä¸€è‡´ååˆ¤æ–­masterèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿)ï¼Œ ä¸‹çº¿åä¼šé‡æ–°è¿›è¡Œleaderé€‰ä¸¾**ã€‚é—®é¢˜åœ¨äºï¼Œé€‰ä¸¾`leader`çš„æ—¶é—´å¤ªé•¿ï¼Œ ä¸”é€‰ä¸¾æœŸé—´æ•´ä¸ªzké›†ç¾¤éƒ½æ˜¯ä¸å¯ç”¨çš„ï¼Œè¿™å°±å¯¼è‡´åœ¨é€‰ä¸¾æœŸé—´æ³¨å†ŒæœåŠ¡ç˜«ç—ªï¼Œè™½ç„¶æœåŠ¡èƒ½å¤Ÿæœ€ç»ˆæ¢å¤ï¼Œä½†æ˜¯æ¼«é•¿çš„é€‰ä¸¾æ—¶é—´å¯¼è‡´çš„æ³¨å†Œé•¿æœŸä¸å¯ç”¨æ˜¯ä¸èƒ½å®¹å¿çš„ã€‚æ‰€ä»¥è¯´ï¼Œ`ZooKeeper`ä¸èƒ½ä¿è¯æœåŠ¡å¯ç”¨æ€§



2. Eureka  (è®¾è®¡æ€æƒ³ç±»ä¼¼`Redis`çš„é›†ç¾¤æ¶æ„)

Eurekaé›†ç¾¤ä¸‹æ¯ä¸ªèŠ‚ç‚¹ä¹‹é—´éƒ½ä¼š**å®šæ—¶å‘é€å¿ƒè·³ï¼Œå®šæ—¶åŒæ­¥æ•°æ®ï¼Œæ²¡æœ‰master/slaveä¹‹åˆ†ï¼Œæ˜¯ä¸€ä¸ªå®Œå…¨å»ä¸­å¿ƒåŒ–çš„æ¶æ„**

(`P2P`æ¶æ„ï¼ŒèŠ‚ç‚¹ä¹‹å‰é€šè¿‡`Gossip`åè®®å®šæ—¶è¿›è¡Œä¿¡æ¯åŒæ­¥)å› æ­¤æ¯ä¸ªæ³¨å†Œåˆ°Eurekaä¸‹çš„å®ä¾‹éƒ½ä¼šå®šæ—¶åŒæ­¥ipï¼ŒæœåŠ¡ä¹‹é—´

çš„è°ƒç”¨ä¹Ÿæ˜¯æ ¹æ®Eurekaæ‹¿åˆ°çš„ç¼“å­˜æœåŠ¡æ•°æ®è¿›è¡Œè°ƒç”¨ã€‚è‹¥ä¸€å°EurekaæœåŠ¡å®•æœºï¼Œå…¶ä»–Eurekaåœ¨ä¸€å®šæ—¶é—´å†…æœªæ„ŸçŸ¥åˆ°è¿™å°EurekaæœåŠ¡å®•æœºï¼Œå„ä¸ªæœåŠ¡ä¹‹é—´è¿˜æ˜¯å¯ä»¥æ­£å¸¸è°ƒç”¨

Eurekaçš„é›†ç¾¤ä¸­ï¼Œåªè¦æœ‰ä¸€å°Eurekaè¿˜åœ¨ï¼Œå°±èƒ½ä¿è¯æ³¨å†ŒæœåŠ¡å¯ç”¨ï¼ˆä¿è¯å¯ç”¨æ€§ï¼‰ï¼Œåªä¸è¿‡æŸ¥åˆ°çš„ä¿¡æ¯å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼ˆ**ä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œåªä¿è¯æœ€ç»ˆä¸€è‡´æ€§**ï¼‰ã€‚å½“æ•°æ®å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œè™½ç„¶A, Bä¸Šçš„æ³¨å†Œä¿¡æ¯ä¸å®Œå…¨ç›¸åŒï¼Œä½†æ¯ä¸ªEurekaèŠ‚ç‚¹ä¾ç„¶èƒ½å¤Ÿæ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™ä¼šå‡ºç°æŸ¥è¯¢æœåŠ¡ä¿¡æ¯æ—¶å¦‚æœè¯·æ±‚AæŸ¥ä¸åˆ°ï¼Œä½†è¯·æ±‚Bå°±èƒ½æŸ¥åˆ°ã€‚å¦‚æ­¤ä¿è¯äº†å¯ç”¨æ€§ï¼Œä½†ç‰ºç‰²äº†ä¸€è‡´æ€§ã€‚



3. Nacos

Nacosæ”¯æŒCP+APæ¨¡å¼ï¼Œå³Nacoså¯ä»¥æ ¹æ®é…ç½®è¯†åˆ«ä¸ºCPæ¨¡å¼æˆ–APæ¨¡å¼ï¼Œé»˜è®¤æ˜¯APæ¨¡å¼ã€‚å¦‚æœæ³¨å†ŒNacosçš„clientèŠ‚ç‚¹æ³¨å†Œæ—¶ephemeral=trueï¼Œé‚£ä¹ˆNacosé›†ç¾¤å¯¹è¿™ä¸ªclientèŠ‚ç‚¹çš„æ•ˆæœå°±æ˜¯APï¼Œé‡‡ç”¨distroåè®®å®ç°ï¼›è€Œæ³¨å†ŒNacosçš„clientèŠ‚ç‚¹æ³¨å†Œæ—¶ephemeral=falseï¼Œé‚£ä¹ˆNacosé›†ç¾¤å¯¹è¿™ä¸ªèŠ‚ç‚¹çš„æ•ˆæœå°±æ˜¯CPçš„ï¼Œé‡‡ç”¨raftåè®®å®ç°ã€‚æ ¹æ®clientæ³¨å†Œæ—¶çš„å±æ€§ï¼ŒAPï¼ŒCPåŒæ—¶æ··åˆå­˜åœ¨ï¼Œåªæ˜¯å¯¹ä¸åŒçš„clientèŠ‚ç‚¹æ•ˆæœä¸åŒã€‚Nacoså¯ä»¥å¾ˆå¥½çš„è§£å†³ä¸åŒåœºæ™¯çš„ä¸šåŠ¡éœ€æ±‚ã€‚



> åœ¨å¤§å¤šæ•°åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå°¤å…¶æ˜¯æ¶‰åŠåˆ°æ•°æ®å­˜å‚¨çš„åœºæ™¯ï¼Œæ•°æ®ä¸€è‡´æ€§åº”è¯¥æ˜¯é¦–å…ˆè¢«ä¿è¯çš„ï¼Œè¿™ä¹Ÿæ˜¯ Zookeeper è®¾è®¡ç´§éµCPåŸåˆ™çš„é‡è¦åŸå› ã€‚ä½†æ˜¯å¯¹äºæœåŠ¡å‘ç°æ¥è¯´ï¼Œæƒ…å†µå°±ä¸å¤ªä¸€æ ·äº†ï¼Œ**é’ˆå¯¹åŒä¸€ä¸ªæœåŠ¡ï¼Œå³ä½¿æ³¨å†Œä¸­å¿ƒçš„ä¸åŒèŠ‚ç‚¹ä¿å­˜çš„æœåŠ¡æä¾›è€…ä¿¡æ¯ä¸å°½ç›¸åŒï¼Œä¹Ÿå¹¶ä¸ä¼šé€ æˆç¾éš¾æ€§çš„åæœã€‚å› ä¸ºå¯¹äºæœåŠ¡æ¶ˆè´¹è€…æ¥è¯´ï¼Œèƒ½æ¶ˆè´¹æ‰æ˜¯æœ€é‡è¦çš„ï¼Œæ¶ˆè´¹è€…è™½ç„¶æ‹¿åˆ°å¯èƒ½ä¸æ­£ç¡®çš„æœåŠ¡å®ä¾‹ä¿¡æ¯åå°è¯•æ¶ˆè´¹ä¸€ä¸‹ï¼Œä¹Ÿè¦èƒœè¿‡å› ä¸ºæ— æ³•è·å–å®ä¾‹ä¿¡æ¯è€Œä¸å»æ¶ˆè´¹ï¼Œå¯¼è‡´ç³»ç»Ÿå¼‚å¸¸è¦å¥½ã€‚ä»è¿™ä¸€ç‚¹ä¸Šæ¥è¯´ï¼Œåˆ†å¸ƒå¼æœåŠ¡æ³¨å†Œä¸­å¿ƒAPæ¨¡å¼è¦æ›´ä¼˜äºCPæ¨¡å¼ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¶Šæ¥è¶Šå¤šçš„äººæŠ›å¼ƒZookeeperçš„åŸå› æ‰€åœ¨ã€‚**
>
> 
>
> æ€»ä¹‹ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒåˆ°åº•é€‰ç”¨CPæ¨¡å‹è¿˜æ˜¯APæ¨¡å‹ï¼Œè¿˜æ˜¯è¦ä¾ç…§ä¸šåŠ¡åœºæ™¯è¿›è¡Œå†³å®šï¼Œå¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜ï¼Œä¸”å¯ä»¥å®¹å¿ä¸€å®šæ—¶é—´çš„ä¸å¯ç”¨ï¼Œå°±é€‰ç”¨CPæ¨¡å‹ã€‚åä¹‹ï¼Œå¦‚æœå¯ä»¥å®¹å¿ä¸€å®šæ—¶å»¶çš„æ•°æ®ä¸ä¸€è‡´æ€§ï¼Œä½†ä¸èƒ½å®¹å¿ä¸å¯ç”¨æ˜¾ç°å‘ç”Ÿï¼Œåˆ™è¦é€‰ç”¨APæ¨¡å‹ã€‚





## Baseç†è®º

**BASE** æ˜¯ **Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰**ã€**Soft-stateï¼ˆè½¯çŠ¶æ€ï¼‰** å’Œ **Eventually Consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰** ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§ C å’Œå¯ç”¨æ€§ A æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œæ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„(æ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯å¯¹ CAP ä¸­ AP æ–¹æ¡ˆçš„ä¸€ä¸ªè¡¥å……ã€‚å…¶åŸºæœ¬æ€è·¯å°±æ˜¯ï¼šé€šè¿‡ä¸šåŠ¡ï¼Œç‰ºç‰²å¼ºä¸€è‡´æ€§è€Œè·å¾—å¯ç”¨æ€§ï¼Œå¹¶å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æ˜¯æœ€ç»ˆè¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€ã€‚)ï¼Œå®ƒå¤§å¤§é™ä½äº†æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„è¦æ±‚

Baseç†è®ºçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼ŒCAP çš„ä¸€è‡´æ€§å°±æ˜¯å¼ºä¸€è‡´æ€§ï¼‰ï¼Œä½†åº”ç”¨å¯ä»¥é‡‡ç”¨é€‚åˆçš„æ–¹å¼è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consitencyï¼‰,ä½†æ˜¯**è‡ªå§‹è‡³ç»ˆè¦ä¿è¯APï¼Œå³ä¸€å®šç¨‹åº¦ä¸Šç‰ºç‰²äº†ä¸€è‡´æ€§æ¥æ¢å–æ‰€æœ‰èŠ‚ç‚¹çš„å¯ç”¨æ€§**



:ear: å¯ä»¥è¿™ä¹ˆç†è§£ï¼šCAPç†è®ºä¸­çš„Cè¡¨ç¤ºçš„æ˜¯å¼ºä¸€è‡´æ€§ï¼Œè€ŒBASEç†è®ºæƒ³è¦è¾¾åˆ°çš„ç›®æ ‡æ˜¯æœ€ç»ˆä¸€è‡´æ€§

<img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91c2VyLWdvbGQtY2RuLnhpdHUuaW8vMjAxOC81LzI0LzE2MzkxNDgwNmQ5ZTE1YzY?x-oss-process=image/format,png" alt="BASEç†è®ºä¸‰è¦ç´ " style="zoom:50%;" />



åŸºæœ¬å¯ç”¨ï¼šæŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚ä½†æ˜¯ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚

**ä»€ä¹ˆå«å…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§å‘¢ï¼Ÿ**

- **å“åº”æ—¶é—´ä¸Šçš„æŸå¤±**: æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚éœ€è¦ 0.5s è¿”å›ç»“æœï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå¤„ç†ç”¨æˆ·è¯·æ±‚çš„æ—¶é—´å˜ä¸º 3 sã€‚
- **ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±**ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„å…¨éƒ¨åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿè®¿é—®é‡çªç„¶å‰§å¢ï¼Œç³»ç»Ÿçš„éƒ¨åˆ†éæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ã€‚



è½¯çŠ¶æ€ï¼šè½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼ˆ**CAP ç†è®ºä¸­çš„æ•°æ®ä¸ä¸€è‡´**ï¼‰ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚



æœ€ç»ˆä¸€è‡´æ€§ï¼šæœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§



> åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ 3 ç§çº§åˆ«ï¼š
>
> 1. **å¼ºä¸€è‡´æ€§**ï¼šç³»ç»Ÿå†™å…¥äº†ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„å°±æ˜¯ä»€ä¹ˆã€‚
> 2. **å¼±ä¸€è‡´æ€§**ï¼šä¸ä¸€å®šå¯ä»¥è¯»å–åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸ä¿è¯å¤šå°‘æ—¶é—´ä¹‹åè¯»å–åˆ°çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼Œåªæ˜¯ä¼šå°½é‡ä¿è¯æŸä¸ªæ—¶åˆ»è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€,ç”šè‡³ä¸èƒ½ä¿è¯å¯ä»¥è®¿é—®åˆ°ä¿®æ”¹ã€‚
> 3. **æœ€ç»ˆä¸€è‡´æ€§**ï¼šå¼±ä¸€è‡´æ€§çš„å‡çº§ç‰ˆï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…è¾¾åˆ°æ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚
>
> **ä¸šç•Œæ¯”è¾ƒæ¨å´‡æ˜¯æœ€ç»ˆä¸€è‡´æ€§çº§åˆ«ï¼Œä½†æ˜¯æŸäº›å¯¹æ•°æ®ä¸€è‡´è¦æ±‚ååˆ†ä¸¥æ ¼çš„åœºæ™¯æ¯”å¦‚é“¶è¡Œè½¬è´¦è¿˜æ˜¯è¦ä¿è¯å¼ºä¸€è‡´æ€§ã€‚**
>
> 









## Raftç®—æ³•



>  é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯æ‹œå åº­/éæ‹œå åº­ç®—æ³•ï¼Ÿ
>
>  
>
>  æ‹œå åº­å°†å†›é—®é¢˜ï¼ˆByzantine Generals Problemï¼‰æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­æå‡ºçš„ä¸€ä¸ªè‘—åé—®é¢˜ï¼Œç”¨æ¥æè¿°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­èŠ‚ç‚¹ä¹‹é—´çš„å¯é é€šä¿¡é—®é¢˜ã€‚é—®é¢˜çš„èƒŒæ™¯è®¾å®šæ˜¯ï¼šä¸€ç»„æ‹œå åº­å°†å†›å›´ç»•ä¸€åº§åŸå¸‚å±•å¼€è¿›æ”»ï¼Œè¿™äº›å°†å†›ä¹‹é—´éœ€è¦é€šè¿‡æ¶ˆæ¯äº¤æ¢æ¥è¾¾æˆå…³äºè¿›æ”»è¿˜æ˜¯æ’¤é€€çš„å…±è¯†ã€‚ç„¶è€Œï¼Œå­˜åœ¨ä¸€äº›å›å¾’å°†å†›ï¼Œä»–ä»¬å¯èƒ½ä¼šå‘é€è™šå‡çš„æ¶ˆæ¯æ¥æ··æ·†å…¶ä»–å°†å†›ï¼Œä»è€Œå¯¼è‡´æ— æ³•è¾¾æˆä¸€è‡´çš„å†³ç­–ã€‚
>
>  
>
>  éæ‹œå åº­çš„ä¸€è‡´æ€§ç®—æ³•æ˜¯ä¸€ç±»ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ç®—æ³•ï¼Œç”¨äºç¡®ä¿åœ¨å­˜åœ¨ä¸€äº›èŠ‚ç‚¹å¯èƒ½å‘ç”Ÿé”™è¯¯æˆ–è€…æ¶æ„è¡Œä¸ºçš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä»ç„¶èƒ½å¤Ÿåœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´è¾¾æˆä¸€è‡´çš„çŠ¶æ€æˆ–å†³ç­–ã€‚è¿™äº›é”™è¯¯å¯èƒ½åŒ…æ‹¬**èŠ‚ç‚¹å´©æºƒã€æ¶ˆæ¯ä¸¢å¤±ã€æ¶ˆæ¯å»¶è¿Ÿã€æ¶æ„èŠ‚ç‚¹**ç­‰,ä¸€äº›è‘—åçš„éæ‹œå åº­ä¸€è‡´æ€§ç®—æ³•åŒ…æ‹¬ï¼š
>
>  1. Paxosï¼šä¸€ç§ç»å…¸çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œç”¨äºç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹å°±æŸä¸ªå€¼è¾¾æˆå…±è¯†ã€‚
>  2. Raftï¼šç±»ä¼¼äºPaxosï¼Œä¹Ÿæ˜¯ç”¨äºåˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ç®—æ³•ï¼Œæ—¨åœ¨æ›´æ˜“äºç†è§£å’Œå®ç°ã€‚
>  3. ZooKeeperï¼šåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›äº†é«˜çº§åˆ«çš„åŸè¯­ï¼Œå¯ä»¥ç”¨äºå®ç°å„ç§åˆ†å¸ƒå¼åº”ç”¨åœºæ™¯ã€‚
>  4. etcdï¼šç±»ä¼¼äºZooKeeperï¼Œç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„é…ç½®ç®¡ç†å’ŒæœåŠ¡å‘ç°ã€‚
>  5. Consulï¼šç”¨äºæœåŠ¡å‘ç°ã€é…ç½®å’Œåˆ†å¸ƒå¼ä¸€è‡´æ€§çš„å·¥å…·ã€‚



Raftç®—æ³• æ­£å¸¸å·¥ä½œæ—¶çš„æµç¨‹å¦‚ä¸‹å›¾ï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸æƒ…å†µä¸‹æ—¥å¿—å¤åˆ¶çš„æµç¨‹ã€‚Raft ä¸­ä½¿ç”¨æ—¥å¿—æ¥è®°å½•æ‰€æœ‰æ“ä½œï¼Œæ‰€æœ‰ç»“ç‚¹éƒ½æœ‰è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨æ¥è®°å½•æ‰€æœ‰è¯·æ±‚ã€‚ç®—æ³•å°†æœºå™¨åˆ†æˆä¸‰ç§è§’è‰²ï¼š**Leader**ã€**Follower** å’Œ **Candidate**ã€‚æ­£å¸¸æƒ…å†µä¸‹åªå­˜åœ¨ä¸€ä¸ª `Leader`ï¼Œå…¶ä»–å‡ä¸º `Follower`ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½ä¸ `Leader` è¿›è¡Œäº¤äº’:

![tcCXcV](https://imgs.lfeng.tech/images/2023/04/tcCXcV.gif)

ä»¥ä¸‹æ˜¯Raftç®—æ³•ä¸­çš„ä¸‰ä¸ªè§’è‰²åŠå…¶èŒè´£ï¼š

1. **é¢†å¯¼è€…ï¼ˆLeaderï¼‰ï¼š**
   - é¢†å¯¼è€…æ˜¯Rafté›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè´Ÿè´£åè°ƒå’Œç®¡ç†æ—¥å¿—çš„å¤åˆ¶å’Œä¸€è‡´æ€§ã€‚
   - é¢†å¯¼è€…æ¥æ”¶å®¢æˆ·ç«¯çš„å†™è¯·æ±‚ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸ºä¸€ç³»åˆ—çš„æ—¥å¿—æ¡ç›®ã€‚
   - é¢†å¯¼è€…å°†è¿™äº›æ—¥å¿—æ¡ç›®åˆ†å‘ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œä»¥ç¡®ä¿é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¾¾åˆ°ç›¸åŒçš„çŠ¶æ€ã€‚
   - é¢†å¯¼è€…å‘¨æœŸæ€§åœ°å‘è·Ÿéšè€…å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œä»¥ä¿æŒå…¶é¢†å¯¼åœ°ä½ã€‚å¦‚æœè·Ÿéšè€…é•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œå®ƒä»¬ä¼šå¼€å§‹å¯»æ‰¾æ–°çš„é¢†å¯¼è€…ã€‚
2. **è·Ÿéšè€…ï¼ˆFollowerï¼‰ï¼š**
   - è·Ÿéšè€…æ˜¯Rafté›†ç¾¤ä¸­çš„æ™®é€šèŠ‚ç‚¹ï¼Œéµå¾ªé¢†å¯¼è€…çš„æŒ‡ä»¤å¹¶å¤åˆ¶å…¶æ—¥å¿—ã€‚
   - è·Ÿéšè€…å“åº”æ¥è‡ªé¢†å¯¼è€…çš„å¿ƒè·³æ¶ˆæ¯ï¼Œä»¥ç»´æŒé¢†å¯¼è€…çš„åœ°ä½ã€‚
   - å¦‚æœè·Ÿéšè€…è®¤ä¸ºè‡ªå·±ä¸å†æ”¶åˆ°æ¥è‡ªç°ä»»é¢†å¯¼è€…çš„æ¶ˆæ¯ï¼Œå®ƒå¯ä»¥å¼€å§‹æˆä¸ºå€™é€‰è€…ï¼Œå‘èµ·é€‰ä¸¾ä»¥å¯»æ‰¾æ–°çš„é¢†å¯¼è€…ã€‚
3. **å€™é€‰è€…ï¼ˆCandidateï¼‰ï¼š**
   - å€™é€‰è€…æ˜¯åœ¨é€‰ä¸¾ä¸­å¯»æ‰¾æ–°é¢†å¯¼è€…çš„èŠ‚ç‚¹ï¼Œå½“è·Ÿéšè€…è®¤ä¸ºç°ä»»é¢†å¯¼è€…ä¸å¯ç”¨æ—¶ï¼Œå®ƒä»¬å¯ä»¥æˆä¸ºå€™é€‰è€…ã€‚
   - å€™é€‰è€…å‘èµ·é€‰ä¸¾è¯·æ±‚(å‘é€RPCæ¶ˆæ¯)ï¼Œè¯·æ±‚å…¶ä»–èŠ‚ç‚¹çš„æŠ•ç¥¨æ”¯æŒã€‚
   - åœ¨ä¸€ä¸ªé€‰ä¸¾å‘¨æœŸå†…ï¼ŒèŠ‚ç‚¹åªèƒ½æŠ•ç»™ä¸€ä¸ªå€™é€‰è€…ï¼Œå€™é€‰è€…è·å¾—å¤šæ•°æŠ•ç¥¨å³å¯æˆä¸ºæ–°çš„é¢†å¯¼è€…ã€‚
   - å¦‚æœæ²¡æœ‰å€™é€‰è€…è·å¾—å¤šæ•°æŠ•ç¥¨ï¼Œé‚£ä¹ˆæ–°çš„é€‰ä¸¾å‘¨æœŸå°†åœ¨ç¨åé‡æ–°å¼€å§‹ã€‚





æ‰€æœ‰æ“ä½œé‡‡ç”¨ç±»ä¼¼**ä¸¤é˜¶æ®µæäº¤(`Two-Phase Commit Protocol`)**çš„æ–¹å¼ï¼ŒLeader åœ¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚åå¹¶ä¸ä¼šæ‰§è¡Œï¼Œåªæ˜¯å°†å…¶å†™å…¥è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨ä¸­ï¼Œç„¶åå°†è¯¥æ“ä½œå‘é€ç»™æ‰€æœ‰çš„ Followerã€‚Follower åœ¨æ”¶åˆ°è¯·æ±‚åä¹Ÿåªæ˜¯å†™å…¥è‡ªå·±çš„æ—¥å¿—åˆ—è¡¨ä¸­ç„¶åå›å¤ Leaderï¼Œå½“æœ‰è¶…è¿‡åŠæ•°çš„ç»“ç‚¹å†™å…¥å Leader æ‰ä¼šæäº¤è¯¥æ“ä½œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶é€šçŸ¥æ‰€æœ‰å…¶ä»–ç»“ç‚¹æäº¤è¯¥æ“ä½œã€‚

é€šè¿‡è¿™ä¸€æµç¨‹ä¿è¯äº†åªè¦æäº¤è¿‡åçš„æ“ä½œä¸€å®šåœ¨å¤šæ•°ç»“ç‚¹ä¸Šç•™æœ‰è®°å½•ï¼ˆåœ¨æ—¥å¿—åˆ—è¡¨ä¸­ï¼‰ï¼Œä»è€Œä¿è¯äº†è¯¥æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚





### Leaderé€‰ä¸¾

åœ¨ç®—æ³•åˆšå¼€å§‹æ—¶ï¼Œæ‰€æœ‰ç»“ç‚¹éƒ½æ˜¯ `Follower`ï¼Œæ¯ä¸ªç»“ç‚¹éƒ½ä¼šæœ‰ä¸€ä¸ªå®šæ—¶å™¨(æ¯ä¸ªèŠ‚ç‚¹çš„å®šæ—¶å™¨è®¾ç½®æ—¶é—´æ˜¯ä¸ä¸€è‡´çš„)ï¼Œæ¯æ¬¡æ”¶åˆ°æ¥è‡ª Leader çš„ä¿¡æ¯å°±ä¼šæ›´æ–°è¯¥å®šæ—¶å™¨(é‡æ–°ä»0å¼€å§‹è®¡æ—¶)



å¦‚æœå®šæ—¶å™¨è¶…æ—¶ï¼Œè¯´æ˜ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ° Leader çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸º Leader å·²æ­»æˆ–è€…ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè¯¥ç»“ç‚¹å°±ä¼šè½¬å˜æˆ Candidateï¼Œæ„æ€ä¸ºå‡†å¤‡ç«äº‰æˆä¸º Leaderã€‚

æˆä¸º Candidate åç»“ç‚¹ä¼šå‘æ‰€æœ‰å…¶ä»–ç»“ç‚¹å‘é€è¯·æ±‚æŠ•ç¥¨çš„è¯·æ±‚ï¼ˆRequestVoteï¼‰ï¼Œå…¶ä»–ç»“ç‚¹åœ¨æ”¶åˆ°è¯·æ±‚åä¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥æŠ•ç»™ä»–å¹¶è¿”å›ç»“æœã€‚Candidate å¦‚æœæ”¶åˆ°äº†åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨å°±å¯ä»¥æˆä¸º Leaderï¼Œæˆä¸ºä¹‹åä¼šç«‹å³å¹¶åœ¨ä»»æœŸå†…å®šæœŸå‘é€ä¸€ä¸ªå¿ƒè·³ä¿¡æ¯é€šçŸ¥å…¶ä»–æ‰€æœ‰ç»“ç‚¹æ–°çš„ Leader ä¿¡æ¯ï¼Œå¹¶ç”¨æ¥é‡ç½®å®šæ—¶å™¨ï¼Œé¿å…å…¶ä»–ç»“ç‚¹å†æ¬¡æˆä¸º Candidateã€‚

å¦‚æœ Candidate åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰è·å¾—è¶³å¤Ÿçš„æŠ•ç¥¨ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸€è½®æ–°çš„é€‰ä¸¾ï¼Œç›´åˆ°å…¶æˆä¸º Leader,æˆ–è€…å…¶ä»–ç»“ç‚¹æˆä¸ºäº†æ–°çš„ Leaderï¼Œè‡ªå·±å˜æˆ Followerã€‚



1ã€æ¯”å¦‚AèŠ‚ç‚¹ç­‰å¾…è¶…æ—¶æ—¶é—´ä¸º200msã€BèŠ‚ç‚¹ä¸º280msã€CèŠ‚ç‚¹ä¸º120ms,é‚£ä¹ˆCèŠ‚ç‚¹å…ˆè¶…æ—¶ï¼Œæœ€å…ˆå› ä¸ºæ²¡æœ‰ç­‰åˆ°é¢†å¯¼è€…Leaderçš„å¿ƒè·³ä¿¡æ¯ï¼Œå‘ç”Ÿè¶…æ—¶

<img src="https://ask.qcloudimg.com/http-save/yehe-1065851/sexgnei3nn.png" alt="img" style="zoom:67%;" />

2ã€å½“CèŠ‚ç‚¹è¶…æ—¶æ—¶é—´åˆ°äº†åï¼ŒCèŠ‚ç‚¹æˆä¸ºå€™é€‰è€…ï¼Œå¹¶å¢åŠ è‡ªå·±çš„ä»»æœŸç¼–å·ï¼ŒTermå€¼ä»0æ›´æ–°ä¸º1ï¼Œå¹¶ç»™è‡ªå·±æŠ•äº†ä¸€ç¥¨ï¼š

-  Node A: Term=0 
-  Node B: Term=0 
-  Node C: Term=1 Vote Count=1; 

<img src="https://ask.qcloudimg.com/http-save/yehe-1065851/shzzvffb0p.png" alt="img" style="zoom:67%;" />

æ­¤æ—¶æ²¡æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯é¢†å¯¼è€…ï¼ŒèŠ‚ç‚¹ç­‰å¾…å¿ƒè·³è¶…æ—¶åï¼Œä¼šæ¨èè‡ªå·±**èŠ‚ç‚¹C**ä¸ºå€™é€‰äººï¼Œå‘é›†ç¾¤å…¶ä»–èŠ‚ç‚¹å‘èµ·è¯·æ±‚æŠ•ç¥¨ä¿¡æ¯ï¼Œæ­¤æ—¶ä»»æœŸç¼–å· +1ï¼Œè‡ªèä¼šè·å¾—è‡ªå·±çš„ä¸€ç¥¨é€‰ç¥¨ã€‚



3ã€å…¶ä»–è·Ÿéšè€…æ”¶åˆ°è¯·æ±‚æŠ•ç¥¨ä¿¡æ¯åï¼Œå¦‚æœè¯¥å€™é€‰äººç¬¦åˆæŠ•ç¥¨è¦æ±‚åï¼Œåˆ™å°†è‡ªå·±å®è´µï¼ˆå› ä¸ºæ¯ä¸ªä»»æœŸå†…è·Ÿéšè€…åªèƒ½æŠ•ç»™å…ˆæ¥çš„å€™é€‰äººä¸€ç¥¨ï¼Œåé¢æ¥çš„å€™é€‰äººåˆ™ä¸èƒ½åœ¨æŠ•ç¥¨ç»™å®ƒäº†ï¼‰çš„ä¸€ç¥¨æŠ•ç»™è¯¥å€™é€‰äººï¼Œ**åŒæ—¶æ›´æ–°ä»»æœŸç¼–å·**ã€‚



<img src="https://ask.qcloudimg.com/http-save/yehe-1065851/g1e7qaa88m.png" alt="img" style="zoom:67%;" />



4ã€å½“èŠ‚ç‚¹ C èµ¢å¾—å¤§å¤šæ•°é€‰ç¥¨å(é¡»å¤§äº n/2+1)ï¼Œå®ƒä¼šæˆä¸ºæœ¬æ¬¡ä»»æœŸçš„é¢†å¯¼è€…Leader

<img src="https://ask.qcloudimg.com/http-save/yehe-1065851/4kp2oup9yu.png" alt="img" style="zoom:67%;" />

5ã€éšåé¢†å¯¼è€…å‘¨æœŸæ€§å‘é€å¿ƒè·³æ¶ˆæ¯ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå‘ŠçŸ¥è‡ªå·±æ˜¯é¢†å¯¼è€…ï¼ŒåŒæ—¶åˆ·æ–°è·Ÿéšè€…çš„è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢è·Ÿéšè€…å‘èµ·æ–°çš„é¢†å¯¼è€…é€‰ä¸¾ã€‚





> å…³äºä»»æœŸ`Term`çš„é—®é¢˜ï¼š
>
> ä»ä»¥ä¸Šçš„é€‰ä¸¾è¿‡ç¨‹çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ Raft ä¸­çš„é€‰ä¸¾ä¸­æ˜¯æœ‰ä»»æœŸæœºåˆ¶çš„ï¼Œé¡¾åæ€ä¹‰ï¼Œæ¯ä¸€ä»»é¢†å¯¼è€…ï¼Œéƒ½æœ‰å®ƒä¸“å±çš„ä»»æœŸï¼Œå½“é¢†å¯¼è€…æ›´æ¢åï¼Œä»»æœŸä¹Ÿä¼šå¢åŠ ï¼ŒRaft ä¸­çš„ä»»æœŸè¿˜è¦æ³¨æ„ä»¥ä¸‹ä¸ªç»†èŠ‚ï¼š
>
> 1. å¦‚æœæŸä¸ªèŠ‚ç‚¹ï¼Œå‘ç°è‡ªå·±çš„ä»»æœŸç¼–å·æ¯”å…¶ä»–èŠ‚ç‚¹å°(æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹çš„RPCæ¶ˆæ¯)ï¼Œåˆ™ä¼šå°†è‡ªå·±çš„ä»»æœŸç¼–å·æ›´æ–°æ¯”è‡ªå·±æ›´å¤§çš„å€¼ï¼›
> 2. ä»ä¸Šé¢çš„é€‰ä¸¾è¿‡ç¨‹çœ‹å‡ºï¼Œæ¯æ¬¡æ¨èè‡ªå·±æˆä¸ºå€™é€‰äººï¼Œéƒ½ä¼šè‡ªå·±ç»™è‡ªèº«æŠ•ä¸€ç¥¨ï¼›
> 3. å¦‚æœå€™é€‰äººæˆ–è€…é¢†å¯¼è€…å‘ç°è‡ªå·±çš„ä»»æœŸç¼–å·æ¯”å…¶å®ƒèŠ‚ç‚¹å‘æ¥çš„RPCæ¶ˆæ¯ä¸­çš„ç¼–å·è¦å°ï¼Œåˆ™ä¼šç«‹å³æ›´æ–°è‡ªå·±ä¸ºè·Ÿéšè€…ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼ŒæŒ‰ç…§æˆ‘çš„ç†è§£ï¼Œè¿™ä¸ªæœºåˆ¶èƒ½å¤Ÿè§£å†³åŒä¸€æ—¶é—´å†…æœ‰å¤šä¸ªé¢†å¯¼è€…çš„æƒ…å†µ(è§£å†³äº†**é›†ç¾¤è„‘è£‚ç°è±¡**)ï¼Œæ¯”å¦‚é¢†å¯¼è€… A æŒ‚äº†ä¹‹åï¼Œé›†ç¾¤å…¶ä»–èŠ‚ç‚¹ä¼šé€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„é¢†å¯¼è€… Bï¼Œåœ¨èŠ‚ç‚¹ A æ¢å¤ä¹‹åï¼Œä¼šæ¥æ”¶æ¥è‡ªæ–°é¢†å¯¼è€…çš„å¿ƒè·³æ¶ˆæ¯**(æ­¤æ—¶æ–°é¢†å¯¼å‘æ¥çš„æ¶ˆæ¯ä¸­ä»»æœŸç¼–å·è¦å¤§äºè‡ªèº«çš„ä»»æœŸç¼–å·)ï¼Œæ­¤æ—¶èŠ‚ç‚¹ A ä¼šç«‹å³æ¢å¤æˆè·Ÿéšè€…`Follower`çŠ¶æ€)ï¼›**
> 4. **å¦‚æœæŸä¸ªèŠ‚ç‚¹æ¥æ”¶åˆ°æ¯”è‡ªå·±ä»»æœŸå·å°çš„è¯·æ±‚ï¼Œåˆ™ä¼š**æ‹’ç»è¿™ä¸ªè¯·æ±‚ã€‚

Raft å®šä¹‰äº† **ä»»æœŸï¼ˆTermï¼‰** è¿™ä¸€æ¦‚å¿µï¼Œ**æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæœ‰ `currentTerm` è¿™ä¸ªå±æ€§ï¼Œå°±æ˜¯è¯¥èŠ‚ç‚¹å½“å‰æ‰€å¤„çš„ä»»æœŸ**ã€‚

ä»»æœŸåœ¨ Raft ç®—æ³•é‡Œèµ·ä¸€ä¸ª**é€»è¾‘æ—¶é’Ÿ**çš„ä½œç”¨ï¼Œç¬¬å‡ ä¸ªä»»æœŸï¼Œå³ç¬¬å‡ ä¸ª `term` å°±ç±»ä¼¼äºæˆ‘å›½çš„ç¬¬å‡ ä¸ªæœä»£è¿™ç§æ¦‚å¿µï¼Œè€Œé¢†å¯¼äººï¼Œå°±ä»¿ä½›æ˜¯æœä»£çš„å›ç‹ã€‚







### æ—¥å¿—åŒæ­¥

åœ¨ Raft ç®—æ³•ä¸­ï¼Œéœ€è¦å®ç°åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„æ•°æ®è¢«ç§°ä½œæ—¥å¿—ï¼Œæˆ‘ä»¬ Java åç«¯ç»å¤§éƒ¨åˆ†äººè°ˆåˆ°æ—¥å¿—ï¼Œä¸€èˆ¬ä¼šè”æƒ³åˆ°é¡¹ç›®é€šè¿‡ log4j ç­‰æ—¥å¿—æ¡†æ¶è¾“å‡ºçš„ä¿¡æ¯ï¼Œè€Œ Raft ç®—æ³•ä¸­çš„æ•°æ®æäº¤è®°å½•ï¼Œä»–ä»¬ä¼šæŒ‰ç…§æ—¶é—´é¡ºåºè¿›è¡Œè¿½åŠ ï¼ŒRaft ä¹Ÿæ˜¯ä¸¥æ ¼æŒ‰ç…§æ—¶é—´é¡ºåºå¹¶å·²ä¸€å®šçš„æ ¼å¼å†™å…¥æ—¥å¿—æ–‡ä»¶ä¸­



é¢†å¯¼è€…æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚(**åªæœ‰Leaderèƒ½å¤Ÿæ¥æ”¶å®¢æˆ·ç«¯çš„å†™è¯·æ±‚**)ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—é¡¹ï¼Œå¹¶å°†å…¶è¿½åŠ åˆ°æœ¬åœ°æ—¥å¿—ä¸­ï¼Œæ¥ç€é¢†å¯¼è€…é€šè¿‡è¿½åŠ æ¡ç›® RPC è¯·æ±‚ï¼Œå°†æ–°çš„æ—¥å¿—é¡¹å¤åˆ¶åˆ°è·Ÿéšè€…çš„æœ¬åœ°æ—¥å¿—ä¸­(**å¹¶è¡Œä¼ è¾“**)ï¼Œå½“é¢†å¯¼è€…æ”¶åˆ°å¤§å¤šæ•°è·Ÿéšè€…çš„æˆåŠŸå“åº”ä¹‹åï¼Œåˆ™å°†è¿™æ¡æ—¥å¿—é¡¹åº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼Œå¯ä»¥ç†è§£æˆè¯¥æ¡æ—¥å¿—å†™æˆåŠŸäº†ï¼Œæœ€åé¢†å¯¼è€…è¿”å›æ—¥å¿—å†™æˆåŠŸçš„æ¶ˆæ¯å“åº”å®¢æˆ·ç«¯ï¼Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://ask.qcloudimg.com/http-save/yehe-1065851/d73l7x0rtn.png)

å¯ä»¥çœ‹å‡ºï¼ŒRaft çš„å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œé¢†å¯¼è€…æ¥æ”¶åˆ°å¤§å¤šæ•°è·Ÿéšè€…æˆåŠŸå“åº”(è¿”å›ACK)ï¼Œå¹¶ä¸”å°†æ—¥å¿—é¡¹åº”ç”¨åˆ°çŠ¶æ€æœºä¹‹åï¼Œ**ä¸éœ€è¦å°†ç»“æœå“åº”ç»™è·Ÿéšè€…ï¼Œè€Œæ˜¯ç›´æ¥å°†æˆåŠŸæ¶ˆæ¯å“åº”ç»™å®¢æˆ·ç«¯**ï¼Œè¿™æ˜¯ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼ŒåŒæ—¶ Raft ä¼šåœ¨ä¸‹ä¸€æ¬¡ RPC è¿½åŠ æ—¥å¿—è¯·æ±‚ä¸­é™„åŠ ä¸Šæœ¬æ¬¡çš„æ—¥å¿—é¡¹ä¿¡æ¯ã€‚

ä»¥ä¸Šä»…ä»…åªæ˜¯ä¸€ç§æ²¡æœ‰å‘ç”Ÿä»»ä½•é—®é¢˜çš„å¤åˆ¶è¿‡ç¨‹ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­éš¾å…ä¼šå‘ç”ŸèŠ‚ç‚¹å®•æœºç­‰é—®é¢˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒRaft æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ











## Distroåè®®



â‘  æœåŠ¡å®ä¾‹æ³¨å†Œåˆ° Nacos èŠ‚ç‚¹åï¼Œé€šè¿‡ UDP æ–¹å¼æ¨é€åˆ°æ‰€æœ‰æœåŠ¡å®ä¾‹ã€‚è®©å…¶ä»–æœåŠ¡å®ä¾‹æ„ŸçŸ¥åˆ°æœåŠ¡åˆ—è¡¨çš„å˜åŒ–ã€‚

â‘¡ å¦‚ä½•å¤åˆ¶æ•°æ®åˆ°å…¶ä»–èŠ‚ç‚¹ï¼šå½“å‰ Nacos èŠ‚ç‚¹å¼€å¯ 1s çš„å»¶è¿Ÿä»»åŠ¡ï¼Œå°†æ•°æ®åŒæ­¥ç»™å…¶ä»– Nacos èŠ‚ç‚¹ã€‚ï¼ˆåˆ†åŒºä¸€è‡´æ€§ï¼‰

ç¬¬ â‘¡ ä¸ªçŸ¥è¯†ç‚¹å°±æ˜¯ Nacos è‡ªç ”çš„ Distro ä¸€è‡´æ€§åè®®çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

é¦–å…ˆè¿™ä¸ª Distro åè®®æ˜¯é’ˆå¯¹é›†ç¾¤ç¯å¢ƒçš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸‰ä¸ªé›†ç¾¤èŠ‚ç‚¹ç»„æˆäº†ä¸€ä¸ªé›†ç¾¤ã€‚æœåŠ¡ A å’ŒæœåŠ¡ B ä¼šå¾€è¿™ä¸ªé›†ç¾¤è¿›è¡Œæ³¨å†Œã€‚

<img src="https://dl-harmonyos.51cto.com/images/202205/d5cf64594d3e79b939886544d4fb7f41b3113c.png" alt="5000 å­— | æ­ç§˜ Nacos çš„ AP æ¶æ„ ã€ŒDistro ä¸€è‡´æ€§åè®®ã€ï¼ˆä¸€ï¼‰-å¼€æºåŸºç¡€è½¯ä»¶ç¤¾åŒº" style="zoom: 50%;" />

æˆ‘ä»¬çŸ¥é“ Nacos å®ƒæ˜¯æ”¯æŒä¸¤ç§åˆ†å¸ƒå¼å®šç†çš„ï¼šCPï¼ˆåˆ†åŒºä¸€è‡´æ€§ï¼‰å’Œ APï¼ˆåˆ†åŒºå¯ç”¨æ€§ï¼‰ ï¼Œè€Œ AP æ˜¯é€šè¿‡ Nacos è‡ªç ”çš„ Distro åè®®æ¥ä¿è¯çš„ï¼ŒCP æ˜¯é€šè¿‡ Nacos çš„ JRaft åè®®æ¥ä¿è¯çš„ã€‚

**å› ä¸ºæ³¨å†Œä¸­å¿ƒä½œä¸ºç³»ç»Ÿä¸­å¾ˆé‡è¦çš„çš„ä¸€ä¸ªæœåŠ¡ï¼Œéœ€è¦å°½æœ€å¤§å¯èƒ½å¯¹å¤–æä¾›å¯ç”¨çš„æœåŠ¡**ï¼Œæ‰€ä»¥é€‰æ‹© AP æ¥ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ï¼Œå¦å¤– Nacos è¿˜é‡‡å–äº†å¿ƒè·³æœºåˆ¶æ¥è‡ªåŠ¨å®ŒæˆæœåŠ¡æ•°æ®è¡¥å¿çš„æœºåˆ¶ï¼Œæ‰€ä»¥è¯´ Distro åè®®æ˜¯å¼±ä¸€è‡´æ€§çš„ã€‚

å¦‚æœé‡‡ç”¨ CP åè®®ï¼Œåˆ™éœ€è¦å½“å‰é›†ç¾¤å¯ç”¨çš„èŠ‚ç‚¹æ•°è¿‡åŠæ‰èƒ½å·¥ä½œã€‚

Distro åè®®æ˜¯ Nacos å¯¹äºä¸´æ—¶å®ä¾‹æ•°æ®å¼€å‘çš„ä¸€è‡´æ€§åè®®ã€‚

Distro åè®®æ˜¯é›† Gossip + Eureka åè®®çš„ä¼˜ç‚¹å¹¶åŠ ä»¥ä¼˜åŒ–åå‡ºç°çš„ã€‚

**Gossip åè®®æœ‰ä»€ä¹ˆå‘ï¼Ÿ**ç”±äºéšæœºé€‰å–å‘é€çš„èŠ‚ç‚¹ï¼Œä¸å¯é¿å…åœ°å­˜åœ¨æ¶ˆæ¯é‡å¤å‘é€ç»™åŒä¸€èŠ‚ç‚¹çš„æƒ…å†µï¼Œå¢åŠ äº†ç½‘ç»œçš„ä¼ è¾“çš„å‹åŠ›ï¼Œç»™æ¶ˆæ¯èŠ‚ç‚¹å¸¦æ¥é¢å¤–çš„å¤„ç†è´Ÿè½½ã€‚

**Distro åè®®çš„ä¼˜åŒ–**ï¼šæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ•°æ®ï¼Œç„¶åå°†æ•°æ®åŒæ­¥ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œæœ‰æ•ˆåœ°é™ä½äº†æ¶ˆæ¯å†—ä½™çš„é—®é¢˜ã€‚

å…³äºä¸´æ—¶å®ä¾‹æ•°æ®ï¼šä¸´æ—¶æ•°æ®å…¶å®æ˜¯å­˜å‚¨åœ¨å†…å­˜ç¼“å­˜ä¸­çš„ï¼Œå¹¶ä¸”åœ¨å…¶ä»–èŠ‚ç‚¹åœ¨å¯åŠ¨æ—¶ä¼šè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œç„¶åèŠ‚ç‚¹ä¹Ÿä¼šå®šæœŸè¿›è¡Œæ•°æ®æ ¡éªŒã€‚















## Sentinel



### Sentinel å…¥é—¨

 è¿™é‡Œå…ˆå¯åŠ¨ä¸‰ä¸ªå¾®æœåŠ¡:`orderservice`ã€`userservice`ã€`gateway`

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/nacos%20statrt.png)

åœ¨`order-service`ä¸­çš„`application.yaml`ä¸­é…ç½®`sentinel`ç›¸å…³è§„åˆ™ï¼š

```yaml
  cloud:
    nacos:
      server-addr: localhost:8848 # nacosæœåŠ¡åœ°å€
    sentinel:
      transport:
        dashboard: localhost:8899 # sentinelæ§åˆ¶å°åœ°å€
      web-context-unify: false # å…³é—­contextæ•´åˆ
      datasource:
        flow:
          nacos:
            server-addr: localhost:8848 # nacosåœ°å€
            dataId: orderservice-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow # è¿˜å¯ä»¥æ˜¯ï¼šdegradeã€authorityã€param-flow
```



ç„¶ååœ¨`sentinel`çš„å®‰è£…ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shell
java -Dserver.port=8899 -jar sentinel-dashboard-1.8.1.jar
```

æœ€ååœ¨æµè§ˆå™¨è¾“å…¥ `localhost:8899/#dashboard`å°±å¯ä»¥çœ‹åˆ°`sentinel`çš„æ§åˆ¶å°äº†ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/sentinel1.png)



ç„¶åæˆ‘ä»¬å¯åŠ¨`jmeter`æ¥æµ‹è¯•è¿™ä¸ªè¿œç¨‹è°ƒç”¨çš„ååé‡ï¼š

**é…ç½®çº¿ç¨‹æ•°ä¸º100ã€æ¯ä¸ªçº¿ç¨‹å¾ªç¯æ¬¡æ•°ä¸º100ï¼ŒRamp-Upä¸º1ç§’ï¼Œ**å³æ¯ç§’1wä¸ªè¯·æ±‚æ‰“åˆ°è¯¥æ¥å£ä¸Šï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/jmeter.png" style="zoom:67%;" />



æŸ¥çœ‹`jmeter`ä¸­çš„æ±‡æ€»æŠ¥å‘Šï¼š å¯ä»¥çœ‹åˆ°è¯¥æ¥å£çš„`QPS`ä¸º **633/sec**:

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/sentinel-res.png)



åŒæ—¶è§‚å¯Ÿ`sentinel`ç½‘é¡µçš„æ§åˆ¶å°ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/order-sentinel.png)





ä¹Ÿä¼šå®æ—¶æ˜¾ç¤ºå‡ºè¯¥æ¥å£çš„`QPS`

> 1. **QPSï¼ˆQueries Per Secondï¼‰ï¼š** QPSæ˜¯è¡¡é‡æ•°æ®åº“ã€ç¼“å­˜ç­‰æ•°æ®å­˜å–é¢‘ç‡çš„æŒ‡æ ‡ã€‚å®ƒè¡¨ç¤ºæ¯ç§’å†…å¤„ç†çš„æŸ¥è¯¢è¯·æ±‚æ•°é‡ã€‚å¯¹äºæ•°æ®åº“æ¥è¯´ï¼ŒQPSè¡¨ç¤ºæ¯ç§’å†…æ‰§è¡Œçš„æŸ¥è¯¢è¯­å¥æ•°é‡ï¼›å¯¹äºç¼“å­˜æ¥è¯´ï¼ŒQPSè¡¨ç¤ºæ¯ç§’å†…å¤„ç†çš„ç¼“å­˜è¯·æ±‚æ•°é‡ã€‚
> 2. **TPSï¼ˆTransactions Per Secondï¼‰ï¼š** TPSæ˜¯è¡¡é‡ç³»ç»Ÿå¤„ç†èƒ½åŠ›çš„æŒ‡æ ‡ï¼Œå®ƒè¡¨ç¤ºæ¯ç§’å†…å®Œæˆçš„äº‹åŠ¡æ•°é‡ã€‚äº‹åŠ¡å¯ä»¥æ˜¯æ›´å¹¿æ³›çš„æ“ä½œï¼Œä¾‹å¦‚ç”¨æˆ·è¯·æ±‚ã€HTTPè¯·æ±‚ã€æ”¯ä»˜äº¤æ˜“ç­‰ï¼Œä¸ä»…ä»…å±€é™äºæ•°æ®åº“æŸ¥è¯¢ã€‚TPSå¯ä»¥åŒ…æ‹¬å¤šä¸ªä¸åŒç±»å‹çš„æ“ä½œï¼Œåæ˜ äº†æ•´ä¸ªç³»ç»Ÿçš„ç»¼åˆæ€§èƒ½ã€‚





### ç°‡ç‚¹é“¾è·¯

ç°‡ç‚¹é“¾è·¯ï¼šå°±æ˜¯é¡¹ç›®å†…çš„**è°ƒç”¨é“¾è·¯**â€”â€”â€”â€”è¯·æ±‚ä»è¿›å…¥`SpringMvc`çš„é‚£ä¸€åˆ»ï¼Œé¦–å…ˆä¼šè¿›å…¥Controllerï¼ŒControllerè°ƒç”¨Service,Serviceè°ƒç”¨Mapper,è¿™æ ·`Controllerâ€”>Serviceâ€”>Mapper`å°±æ˜¯ä¸€ä¸ªè°ƒç”¨é“¾è·¯

é“¾è·¯ä¸­è¢«ç›‘æ§çš„æ¯ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ªèµ„æºã€‚é»˜è®¤æƒ…å†µä¸‹ sentinel ä¼šç›‘æ§`SpringMVC`çš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼‰ï¼Œå› æ­¤`SpringMVC`çš„æ¯ä¸€ä¸ªç«¯ç‚¹ï¼ˆEndpointï¼‰å°±æ˜¯è°ƒç”¨é“¾è·¯ä¸­çš„ä¸€ä¸ªèµ„æºã€‚

**æµæ§ã€ç†”æ–­ç­‰éƒ½æ˜¯é’ˆå¯¹ç°‡ç‚¹é“¾è·¯ä¸­çš„èµ„æºæ¥è®¾ç½®çš„**ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‚¹å‡»å¯¹åº”èµ„æº(`Controller`ä¸­çš„ **/order/orderId** )åé¢çš„æŒ‰é’®æ¥è®¾ç½®è§„åˆ™ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E9%93%BE%E8%B7%AF%E6%B5%81%E6%8E%A7.png)

å…¶å«ä¹‰æ˜¯é™åˆ¶ `/order/{orderId}`è¿™ä¸ªèµ„æºçš„å•æœºQPSä¸º600ï¼Œå³æ¯ç§’åªå…è®¸600æ¬¡è¯·æ±‚ï¼Œè¶…å‡ºçš„è¯·æ±‚ä¼šè¢«æ‹¦æˆªå¹¶æŠ¥é”™ã€‚ å…·ä½“æ¯ä¸ªæ¥å£çš„`QPS`å¯ä»¥é€šè¿‡`Jmeter`æ¥è¿›è¡Œå‹åŠ›æµ‹è¯•(**å¢åŠ çº¿ç¨‹æ•°å’Œæ¯ç§’å¾ªç¯æ¬¡æ•°â€”â€”æ¨¡æ‹Ÿé«˜å¹¶å‘**)å¾—åˆ°è¯¥æ¥å£çš„QPSä¸Šé™ï¼Œç„¶åè®¾ç½®è¯¥å€¼



ç„¶åæˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹é™æµï¼š é™åˆ¶è¯¥èµ„æºçš„QPSä¸Šé™é˜ˆå€¼ä¸º10

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%B5%81%E6%8E%A7%20qps10.png)

ç„¶ååœ¨`jmeter`ä¸­æŸ¥çœ‹ç»“æœæ ‘ï¼Œå¯ä»¥çœ‹åˆ°æ¯ç§’æœ€å¤šåªèƒ½æ¥æ”¶å…¶ä»–è¯·æ±‚ï¼Œå‰©ä½™è¯·æ±‚ç›´æ¥`fail-fast`:

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/res10.png" style="zoom:67%;" />

å¯ä»¥çœ‹åˆ°æ¯ç§’åªèƒ½æ¥æ”¶10ä¸ªè¯·æ±‚ï¼Œå…¶ä»–è¯·æ±‚ç›´æ¥å¤±è´¥:

åœ¨HTTP åè®®ä¸­ï¼Œå“åº”çŠ¶æ€ç  **429** :Too Many Requests` è¡¨ç¤º**åœ¨ä¸€å®šçš„æ—¶é—´å†…ç”¨æˆ·å‘é€äº†å¤ªå¤šçš„è¯·æ±‚ï¼Œå³è¶…å‡ºäº†â€œé¢‘æ¬¡é™åˆ¶â€**ã€‚

```http
Thread Name:çº¿ç¨‹ç»„ 1-99
Sample Start:2023-08-15 15:17:07 CST
Load time:0
Connect Time:0
Latency:0
Size in bytes:212
Sent bytes:128
Headers size in bytes:168
Body size in bytes:44
Sample Count:1
Error Count:1
Data type ("text"|"bin"|""):text
Response code:429   #Too Many Requests
Response message:
```

è¢«æ‹’ç»åçš„è¯·æ±‚`Response Body`çš„å†…å®¹ä¸ºï¼š

```json
{"msg": è¯·æ±‚è¢«é™æµäº†, "status": 429}
```

åŒæ—¶åœ¨`sentinel`çš„`DashBoard`ä¸­å¯ä»¥çœ‹åˆ°é€šè¿‡çš„QPSçš„ç¡®è¢«é™åˆ¶ä¸º`10/sec`äº†ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/blocked1%200.png)





### æµæ§æ¨¡å¼

ä¸Šè¿°ä¾‹å­æˆ‘ä»¬ç®€å•å…¥é—¨äº†ä¸€ä¸‹`Sentinel`å®ç°æ¥å£é™æµçš„ç”¨æ³•ï¼Œç„¶åæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æµæ§çš„é«˜çº§ç”¨æ³•ï¼š

åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œç‚¹å‡»é«˜çº§é€‰é¡¹ï¼Œå¯ä»¥é€‰æ‹©ä¸‰ç§æµæ§æ¨¡å¼ï¼š

â€¢ç›´æ¥ï¼šç»Ÿè®¡å½“å‰èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶å¯¹å½“å‰èµ„æºç›´æ¥é™æµï¼Œä¹Ÿæ˜¯é»˜è®¤çš„æ¨¡å¼(ä¸Šè¿°ç¤ºä¾‹ä¸­é‡‡ç”¨çš„æ¨¡å¼)

â€¢**å…³è”ï¼š**ç»Ÿè®¡ä¸å½“å‰èµ„æºç›¸å…³çš„å¦ä¸€ä¸ªèµ„æºï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹å½“å‰èµ„æºé™æµ

â€¢é“¾è·¯ï¼šç»Ÿè®¡ä»æŒ‡å®šé“¾è·¯è®¿é—®åˆ°æœ¬èµ„æºçš„è¯·æ±‚ï¼Œè§¦å‘é˜ˆå€¼æ—¶ï¼Œå¯¹æŒ‡å®šé“¾è·¯é™æµ





**1ã€å…³è”æ¨¡å¼**

å‡è®¾é€‰è¯¾åœºæ™¯æœ‰ä»¥ä¸‹ä¸¤ä¸ªå…³é”®èµ„æºï¼š

1. **ä¿®æ”¹ç”¨æˆ·è¯¾ç¨‹ä¿¡æ¯æ¥å£**ï¼ˆResource: `/update-course-info`ï¼‰ï¼šå­¦ç”Ÿé€‰è¯¾åï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹ç”¨æˆ·è¯¾ç¨‹ä¿¡æ¯ã€‚
2. **æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯æ¥å£**ï¼ˆResource: `/query-course-info`ï¼‰ï¼šå­¦ç”Ÿå¯ä»¥æŸ¥è¯¢å·²é€‰è¯¾ç¨‹çš„ä¿¡æ¯ã€‚

ä»¥ä¸‹æ˜¯å¯èƒ½çš„æ€è·¯ï¼š

1. **å®šä¹‰è§„åˆ™ï¼š** é’ˆå¯¹ `/update-course-info` å’Œ `/query-course-info` æ¥å£ï¼Œåˆ†åˆ«å®šä¹‰æµæ§è§„åˆ™ã€‚ä½ å¯ä»¥ä¸ºæ¯ä¸ªæ¥å£è®¾ç½®é€‚å½“çš„é˜ˆå€¼ã€QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰é™åˆ¶ç­‰ã€‚
2. **å…³è”è§„åˆ™ï¼š** åœ¨å…³è”æµæ§æ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥å°† `/update-course-info` å’Œ `/query-course-info` æ¥å£è¿›è¡Œå…³è”ï¼Œè¡¨ç¤ºè¿™ä¸¤ä¸ªæ¥å£ä¹‹é—´å­˜åœ¨å…³è”å…³ç³»ã€‚
3. **è®¾ç½®å…³è”ç­–ç•¥ï¼š** å®šä¹‰å…³è”ç­–ç•¥ï¼ŒæŒ‡å®šä¸€ä¸ªé˜ˆå€¼ï¼Œè¡¨ç¤ºå½“ `/update-course-info` æ¥å£çš„æµé‡è¾¾åˆ°ä¸€å®šå€¼æ—¶ï¼Œä¼šå½±å“ `/query-course-info` æ¥å£çš„æµæ§ã€‚
4. **æµæ§æ•ˆæœï¼š** å½“ `/update-course-info` æ¥å£çš„æµé‡è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿå°†å¼€å§‹å¯¹ `/query-course-info` æ¥å£åº”ç”¨æµæ§ï¼Œé™åˆ¶åŒæ—¶çš„æŸ¥è¯¢è¯·æ±‚ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚





å†æ¥çœ‹ä¸€ä¸ªè®¢å•ä¿®æ”¹å’Œè®¢å•æŸ¥è¯¢çš„å…³è”é™æµæ¡ˆä¾‹ï¼š

- åœ¨OrderControlleræ–°å»ºä¸¤ä¸ªç«¯ç‚¹ï¼š/order/queryå’Œ/order/updateï¼Œæ— éœ€å®ç°ä¸šåŠ¡

- é…ç½®æµæ§è§„åˆ™ï¼Œå½“`/order/update`èµ„æºè¢«è®¿é—®çš„`QPS`è¶…è¿‡5æ—¶ï¼Œå¯¹`/order/query`è¯·æ±‚é™æµ



`OrderController`ä¸­ä»£ç å¦‚ä¸‹ï¼š

```java
@RestController
@RequestMapping("order")
public class OrderController {

    @GetMapping("/query")
    public String queryOrder() {
        // æŸ¥è¯¢å•†å“
        orderService.queryGoods();
        // æŸ¥è¯¢è®¢å•
        System.err.println("æŸ¥è¯¢è®¢å•");
        return "æŸ¥è¯¢è®¢å•æˆåŠŸ";
    }
    
    @GetMapping("/update")
    public String updateOrder() {
        return "æ›´æ–°è®¢å•æˆåŠŸ";
    }
}
```

 	



åŒæ—¶é…ç½®æµæ§è§„åˆ™ï¼Œå½“ `/order/update` çš„QPSè¾¾åˆ°é˜ˆå€¼5æ—¶ï¼Œå¯¹ `/order/query` åšé™æµ

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/liukong.png)

å³è¢«å…³è”çš„èµ„æºè¾¾åˆ°æŸä¸ªé˜ˆå€¼åï¼Œå¯¹ç¬¬ä¸€è¡Œä¸­çš„èµ„æºå `/order/query` è¿›è¡Œé™æµ





æˆ‘ä»¬åœ¨jmeterä¸­æ¨¡æ‹Ÿ`update`è¯·æ±‚ï¼š

```http
POST  localhost:8088/order/update
```

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/gets.png)



å¯ä»¥çœ‹åˆ°`update`è¯·æ±‚æ˜¯æ²¡æœ‰è¢«é™æµçš„ï¼Œå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/ggggggg.png)



ç„¶ååŒæ—¶è§‚å¯ŸåŒä¸€`controller`ä¸­çš„  `GET  localhost:8088/order/query`æ¥å£æ˜¯å¦è¢«é™æµï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E8%A2%AB%E9%99%90%E6%B5%81%E7%9A%84query.png)

å¯ä»¥å‘ç°åœ¨é…ç½®äº†æµæ§è§„åˆ™(å…³è”æ¨¡å¼)åï¼Œå½“ä¼˜å…ˆçº§é«˜çš„èµ„æº `/order/update` è§¦å‘é˜ˆå€¼æ—¶ï¼Œä¼šå¯¹ä¼˜å…ˆçº§è¾ƒä½çš„èµ„æº `/order/query` è¿›è¡Œé™æµ







**2ã€é“¾è·¯æ¨¡å¼**



å¾…è¡¥å…… 





### æµæ§æ•ˆæœ



**æµæ§æ•ˆæœæ˜¯æŒ‡è¯·æ±‚è¾¾åˆ°æµæ§é˜ˆå€¼æ—¶åº”è¯¥é‡‡å–çš„æªæ–½ï¼ŒåŒ…æ‹¬ä¸‰ç§**ï¼š

- å¿«é€Ÿå¤±è´¥ï¼šè¾¾åˆ°é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»å¹¶æŠ›å‡º`FlowException`å¼‚å¸¸ã€‚æ˜¯é»˜è®¤çš„å¤„ç†æ–¹å¼

- **warm upï¼šé¢„çƒ­æ¨¡å¼**ï¼Œå¯¹è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚åŒæ ·æ˜¯æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä½†è¿™ç§æ¨¡å¼QPSçš„é˜ˆå€¼ä¼šåŠ¨æ€å˜åŒ–ï¼Œä»ä¸€ä¸ªè¾ƒå°å€¼é€æ¸å¢åŠ åˆ°æœ€å¤§é˜ˆå€¼

- æ’é˜Ÿç­‰å¾…ï¼šè®©æ‰€æœ‰çš„è¯·æ±‚æŒ‰ç…§å…ˆåæ¬¡åºæ’é˜Ÿæ‰§è¡Œï¼Œä¸¤ä¸ªè¯·æ±‚çš„é—´éš”ä¸èƒ½å°äºæŒ‡å®šæ—¶é•¿



**warm up**ï¼š

ä¹Ÿå«é¢„çƒ­æ¨¡å¼ï¼Œæ˜¯åº”å¯¹æœåŠ¡å†·å¯åŠ¨çš„ä¸€ç§æ–¹æ¡ˆã€‚è¯·æ±‚é˜ˆå€¼åˆå§‹å€¼æ˜¯ `threshold / coldFactor`ï¼ŒæŒç»­æŒ‡å®šæ—¶é•¿åï¼Œé€æ¸æé«˜åˆ°thresholdå€¼ã€‚è€ŒcoldFactorçš„é»˜è®¤å€¼æ˜¯3

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E9%A2%84%E7%83%AD.png)



ä¾‹å¦‚ï¼Œæˆ‘è®¾ç½®æŸä¸ªæ¥å£çš„ `QPS` çš„`threshold`ä¸º10ï¼Œé¢„çƒ­æ—¶é—´ä¸º10ç§’ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¯åŠ¨æ—¶çš„åˆå§‹QPSé˜ˆå€¼å°±æ˜¯ 10 / 3 ï¼Œä¹Ÿå°±æ˜¯3ï¼Œç„¶ååœ¨10ç§’åé€æ¸å¢é•¿åˆ°10`QPS`







**æ’é˜Ÿç­‰å¾…**ï¼š

å½“è¯·æ±‚è¶…è¿‡QPSé˜ˆå€¼æ—¶ï¼Œå¿«é€Ÿå¤±è´¥å’Œwarm up ä¼šæ‹’ç»æ–°çš„è¯·æ±‚å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚è€Œæ’é˜Ÿç­‰å¾…åˆ™æ˜¯è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œã€‚åæ¥çš„è¯·æ±‚å¿…é¡»ç­‰å¾…å‰é¢æ‰§è¡Œå®Œæˆï¼Œå¦‚æœè¯·æ±‚é¢„æœŸçš„ç­‰å¾…æ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿ï¼Œåˆ™ä¼šè¢«æ‹’ç»ã€‚

ä¾‹å¦‚ï¼šQPS = 5ï¼Œæ„å‘³ç€æ¯200msèƒ½å¤„ç†ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„è¯·æ±‚ï¼›`timeout = 2000`ï¼Œæ„å‘³ç€é¢„æœŸç­‰å¾…è¶…è¿‡2000msçš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%8E%92%E9%98%9F.png)





æ€»ç»“ä¸€ä¸‹ï¼Œæµæ§æ•ˆæœæœ‰å“ªäº›ï¼Ÿ

â€¢å¿«é€Ÿå¤±è´¥ï¼šQPSè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚

â€¢warm upï¼š QPSè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œæ‹’ç»æ–°çš„è¯·æ±‚ï¼›QPSé˜ˆå€¼æ˜¯é€æ¸æå‡çš„ï¼Œå¯ä»¥é¿å…å†·å¯åŠ¨æ—¶é«˜å¹¶å‘å¯¼è‡´æœåŠ¡å®•æœº

â€¢æ’é˜Ÿç­‰å¾…ï¼šè¯·æ±‚ä¼šè¿›å…¥é˜Ÿåˆ—ï¼ŒæŒ‰ç…§é˜ˆå€¼å…è®¸çš„æ—¶é—´é—´éš”ä¾æ¬¡æ‰§è¡Œè¯·æ±‚ï¼›å¦‚æœè¯·æ±‚é¢„æœŸç­‰å¾…æ—¶é•¿å¤§äºè¶…æ—¶æ—¶é—´ï¼Œç›´æ¥æ‹’ç»







## é™æµç®—æ³•



### è®¡æ•°å™¨ç®—æ³•



**å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•ï¼š**

å›ºå®šçª—å£å…¶å®å°±æ˜¯æ—¶é—´çª—å£ã€‚**å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•** è§„å®šäº†æˆ‘ä»¬å•ä½æ—¶é—´å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚

å‡å¦‚æˆ‘ä»¬è§„å®šç³»ç»Ÿä¸­æŸä¸ªæ¥å£ 1 åˆ†é’Ÿåªèƒ½è®¿é—® 33 æ¬¡çš„è¯ï¼Œä½¿ç”¨å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„å®ç°æ€è·¯å¦‚ä¸‹ï¼š

- ç»™å®šä¸€ä¸ª`Atomic`ç±»å‹å˜é‡ `counter` æ¥è®°å½•å½“å‰æ¥å£å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œåˆå§‹å€¼ä¸º 0ï¼ˆä»£è¡¨æ¥å£å½“å‰ 1 åˆ†é’Ÿå†…è¿˜æœªå¤„ç†è¯·æ±‚ï¼‰ã€‚
- 1 åˆ†é’Ÿä¹‹å†…æ¯å¤„ç†ä¸€ä¸ªè¯·æ±‚ä¹‹åå°±å°† `counter+1` ï¼Œå½“ `counter=33` ä¹‹åï¼ˆä¹Ÿå°±æ˜¯è¯´åœ¨è¿™ 1 åˆ†é’Ÿå†…æ¥å£å·²ç»è¢«è®¿é—® 33 æ¬¡çš„è¯ï¼‰ï¼Œåç»­çš„è¯·æ±‚å°±ä¼šè¢«å…¨éƒ¨æ‹’ç»ã€‚
- ç­‰åˆ° 1 åˆ†é’Ÿç»“æŸåï¼Œå°† `counter` é‡ç½® 0ï¼Œé‡æ–°å¼€å§‹è®¡æ•°ã€‚

**è¿™ç§é™æµç®—æ³•æ— æ³•ä¿è¯é™æµé€Ÿç‡ï¼Œå› è€Œæ— æ³•ä¿è¯çªç„¶æ¿€å¢çš„æµé‡ï¼Œè§‚å¯Ÿä¸‹å›¾ä¸­çš„è“è‰²åŒºåŸŸï¼š**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E5%9B%BA%E5%AE%9A%E7%AA%97%E5%8F%A3%E8%AE%A1%E6%95%B0%E5%99%A8.png)

4500-5500msä¹‹é—´ï¼Œåˆ°æ¥è¯·æ±‚å®é™…ä¸Šæœ‰6ä¸ªäº†ï¼Œè€Œæˆ‘ä»¬çš„ç³»ç»Ÿ1så†…åªèƒ½å¤„ç†3ä¸ªè¯·æ±‚ï¼Œå› æ­¤å­˜åœ¨è¿™æ ·çš„å¼Šç«¯

> é’ˆå¯¹å½“å‰å¹¶å‘æ‰§è¡Œçš„æ¬¡æ•°ï¼Œå¯ä»¥æœ‰ä¸‰ç§ç»Ÿè®¡æ–¹å¼ï¼š
>
> 
>
> 1. ä½¿ç”¨`AomicInteger`æ¥è¿›è¡Œç»Ÿè®¡å½“å‰æ­£åœ¨å¹¶å‘æ‰§è¡Œçš„æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡åŸŸå€¼å°±ç®€å•ç²—æš´çš„ç›´æ¥å“åº”ç»™ç”¨æˆ·ï¼Œè¯´æ˜ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•æˆ–å…¶å®ƒè·Ÿä¸šåŠ¡ç›¸å…³çš„ä¿¡æ¯
>
>    
>
>    å¼Šç«¯ï¼šä½¿ç”¨ `AomicInteger` ç®€å•ç²—æš´è¶…è¿‡åŸŸå€¼å°±æ‹’ç»è¯·æ±‚ï¼Œå¯èƒ½åªæ˜¯ç¬æ—¶çš„è¯·æ±‚é‡é«˜ï¼Œä¹Ÿä¼šæ‹’ç»è¯·æ±‚
>
> 2. ä½¿ç”¨ `Semaphore` ä¿¡å·é‡æ¥æ§åˆ¶å¹¶å‘æ‰§è¡Œçš„æ¬¡æ•°ï¼Œå¦‚æœè¶…è¿‡åŸŸå€¼ä¿¡å·é‡ï¼Œåˆ™è¿›å…¥é˜»å¡é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…è·å–ä¿¡å·é‡è¿›è¡Œæ‰§è¡Œã€‚å¦‚æœé˜»å¡é˜Ÿåˆ—ä¸­æ’é˜Ÿçš„è¯·æ±‚è¿‡å¤šè¶…å‡ºç³»ç»Ÿå¤„ç†èƒ½åŠ›ï¼Œåˆ™å¯ä»¥åœ¨æ‹’ç»è¯·æ±‚ã€‚
>
>    ç›¸å¯¹`Atomic`ä¼˜ç‚¹ï¼šå¦‚æœæ˜¯ç¬æ—¶çš„é«˜å¹¶å‘ï¼Œå¯ä»¥ä½¿è¯·æ±‚åœ¨é˜»å¡é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œè€Œä¸æ˜¯é©¬ä¸Šæ‹’ç»è¯·æ±‚ï¼Œä»è€Œè¾¾åˆ°ä¸€ä¸ªæµé‡å‰Šå³°çš„ç›®çš„
>
> 3. é‡‡ç”¨ `ThreadPoolExecutor`è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š å›ºå®šçº¿ç¨‹æ± å¤§å°,è¶…å‡ºå›ºå®šçº¿ç¨‹æ± å’Œæœ€å¤§çš„çº¿ç¨‹æ•°,æ‹’ç»çº¿ç¨‹è¯·æ±‚;
>
> 







**æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ï¼š**

**æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•** ç®—çš„ä¸Šæ˜¯å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„å‡çº§ç‰ˆã€‚

æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ç›¸æ¯”äºå›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•çš„ä¼˜åŒ–åœ¨äºï¼š**å®ƒæŠŠæ—¶é—´ä»¥ä¸€å®šæ¯”ä¾‹åˆ†ç‰‡** ã€‚

ä¾‹å¦‚æˆ‘ä»¬çš„æ¥å£é™æµæ¯åˆ†é’Ÿå¤„ç† 60 ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ 1 åˆ†é’Ÿåˆ†ä¸º 60 ä¸ªçª—å£ã€‚æ¯éš” 1 ç§’ç§»åŠ¨ä¸€æ¬¡ï¼Œæ¯ä¸ªçª—å£ä¸€ç§’åªèƒ½å¤„ç† ä¸å¤§äº `60(è¯·æ±‚æ•°)/60ï¼ˆçª—å£æ•°ï¼‰` çš„è¯·æ±‚ï¼Œ å¦‚æœå½“å‰çª—å£çš„è¯·æ±‚è®¡æ•°æ€»å’Œè¶…è¿‡äº†é™åˆ¶çš„æ•°é‡çš„è¯å°±ä¸å†å¤„ç†å…¶ä»–è¯·æ±‚ã€‚

å¾ˆæ˜¾ç„¶ï¼Œ **å½“æ»‘åŠ¨çª—å£çš„æ ¼å­åˆ’åˆ†çš„è¶Šå¤šï¼Œæ»‘åŠ¨çª—å£çš„æ»šåŠ¨å°±è¶Šå¹³æ»‘ï¼Œé™æµçš„ç»Ÿè®¡å°±ä¼šè¶Šç²¾ç¡®ã€‚**

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E8%AE%A1%E6%95%B0%E5%99%A8.png)

ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼š

ç¬¬1400msåˆ°æ¥çš„è¯·æ±‚ï¼Œå¦‚æœä½¿ç”¨å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•ï¼Œç³»ç»Ÿåˆ¤æ–­1000ms-1500msä¹‹é—´åˆ°æ¥3ä¸ªè¯·æ±‚ï¼Œæ˜¯åˆç†çš„ï¼Œæ•…æ¥æ”¶è¯·æ±‚ï¼Œä½†å®é™…ä¸Šä»ç¬¬900msåˆ°1500msä¹‹é—´å·²ç»æ¥äº†å››ä¸ªè¯·æ±‚ï¼Œç³»ç»Ÿå®é™…ä¸Šæ— æ³•åœ¨1ç§’å†…å¤„ç†ç¬¬4ä¸ªè¯·æ±‚çš„ï¼›

è€Œå¦‚æœä½¿ç”¨æ»‘åŠ¨çª—å£è®¡æ•°å™¨ï¼Œå½“ç¬¬1400msè¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ ¹æ®è®¡ç®—ç³»ç»Ÿä¼šå°†åŒºé—´åˆ’åˆ†è‡³500ms-1500msä¹‹é—´ï¼Œæ­¤æ—¶æ˜¯ç³»ç»Ÿå°±ä¼šåˆ¤å®šè¯¥è¯·æ±‚åˆ°æ¥åï¼Œå·²ç»è¶…å‡º1så†…æ‰€èƒ½å¤„ç†çš„æœ€å¤§å€¼ï¼Œæ•…ä¸¢å¼ƒ







### ä»¤ç‰Œæ¡¶ç®—æ³•



![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95.png)



è®¾ç½®ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°é‡æ—¶ï¼Œä¸€èˆ¬è¦è€ƒè™‘æœåŠ¡å™¨çš„å¹¶å‘æ•°ï¼Œä»¥åŠç¼“å†²èƒ½åŠ›

å‡å¦‚æœåŠ¡å™¨çš„æœ€å¤§å¹¶å‘æ•°ä¸º`1000QPS`ï¼Œä»¤ç‰Œæ¡¶ä¸­æœ€å¤§å®¹çº³ä»¤ç‰Œæ•°é‡ä¸º1500ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘å°†æ¯ç§’ç”Ÿæˆçš„ä»¤ç‰Œæ•°é‡è®¾ç½®ä¸º500/600ï¼Œè¿™æ ·ä½å³°æœŸçš„è¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œè€Œåˆ°è¾¾é«˜å³°æœŸå‰ï¼Œä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œæ•°é‡ä¹Ÿä¸ä¼šè¶…å‡ºæœåŠ¡å™¨æ‰€èƒ½æ‰¿è½½çš„å¹¶å‘æ•°å¤ªå¤šï¼Œä¸ä¼šç»™æœåŠ¡å™¨é€ æˆå¤ªå¤§å‹åŠ›ï¼Œ







### æ¼æ¡¶ç®—æ³•



æ¼æ¡¶ç®—æ³•çš„åŸç†å’Œ**æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°**çš„æ€æƒ³éå¸¸ç±»ä¼¼

å’Œæ¶ˆæ¯é˜Ÿåˆ—å¯¹é«˜å¹¶å‘è¯·æ±‚çš„å¤„ç†ç±»ä¼¼ï¼Œå°†å¤§é‡è¯·æ±‚ç›´æ¥å‹å…¥MQï¼Œæ•°æ®åº“ä½œä¸ºMQçš„æ¶ˆè´¹è€…æŒ‰ç…§å…¶å›ºå®šçš„æ¶ˆè´¹é€Ÿç‡æ¥ä»MQä¸­å–æ¶ˆæ¯ï¼Œè¿™æ ·ä¿è¯äº†æ•°æ®åº“ä¸ä¼šè¢«çªç„¶åˆ°æ¥çš„å¤§é‡è¯·æ±‚æ‰€å‡»å®

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E6%BC%8F%E6%A1%B6.png)









## é™çº§ä¸ç†”æ–­



> ä»€ä¹ˆæ˜¯å¾®æœåŠ¡é›ªå´©ï¼Ÿ

å¾®æœåŠ¡è°ƒç”¨é“¾è·¯ä¸­çš„æŸä¸ªæœåŠ¡æ•…éšœï¼Œå¼•èµ·æ•´ä¸ªé“¾è·¯ä¸­çš„æ‰€æœ‰å¾®æœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œè¿™å°±æ˜¯é›ªå´©

å‡è®¾**å‘ç”Ÿäº†è¯¾ç¨‹ç®¡ç†æœåŠ¡æ•…éšœï¼š** å‡è®¾è¯¾ç¨‹ç®¡ç†æœåŠ¡è´Ÿè´£å­˜å‚¨å’Œæä¾›è¯¾ç¨‹ä¿¡æ¯ã€‚å¦‚æœè¿™ä¸ªæœåŠ¡å‘ç”Ÿæ•…éšœï¼Œå…¶ä»–æœåŠ¡æ— æ³•è·å–è¯¾ç¨‹ä¿¡æ¯ï¼Œè¿™ä¼šå¯¼è‡´ç”¨æˆ·æ— æ³•æŸ¥çœ‹ã€æ³¨å†Œæˆ–ç®¡ç†è¯¾ç¨‹ï¼ŒåŒæ—¶ç”¨æˆ·æ”¯ä»˜æœåŠ¡ä¸‹å•è¯¾ç¨‹åæ— æ³•æŸ¥çœ‹ä¸‹å•æˆåŠŸçš„è¯¾ç¨‹ï¼Œå¯¼è‡´æ”¯ä»˜æœåŠ¡ä¹Ÿå‘ç”Ÿæ•…éšœï¼Œæ•™å¸ˆç®¡ç†å¾®æœåŠ¡æƒ³è¦ä¸Šæ–°ä¸€é—¨è¯¾ç¨‹ï¼Œä½†æ˜¯ç”±äºè¯¾ç¨‹ç®¡ç†æœåŠ¡æ•…éšœï¼Œæœ€ç»ˆå¯¼è‡´æ•™å¸ˆç®¡ç†å¾®æœåŠ¡ä¹Ÿçº§è”æ•…éšœï¼Œæœ€ç»ˆå¯¼è‡´å¾®æœåŠ¡é›ªå´©



è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹å¼æœ‰å››ç§ï¼š

- è¶…æ—¶å¤„ç†ï¼šè®¾å®šè¶…æ—¶æ—¶é—´ï¼Œè¯·æ±‚è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å“åº”å°±è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¸ä¼šæ— ä¼‘æ­¢ç­‰å¾…

  ä½†æ˜¯è¶…æ—¶å¤„ç†ä¸èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³é›ªå´©ï¼Œå‡è®¾è®¾ç½®è¶…æ—¶å“åº”æ—¶é—´ä¸º1sï¼Œä½†æ˜¯å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚é€Ÿåº¦è¿œè¿œå¤§äº1/sï¼Œè¿™æ ·æ—¶é—´ä¸€é•¿ä¾æ—§ä¼šå¯¼è‡´é›ªå´©

- èˆ±å£æ¨¡å¼ï¼šé™å®šæ¯ä¸ªä¸šåŠ¡èƒ½ä½¿ç”¨çš„çº¿ç¨‹æ•°ï¼Œé¿å…è€—å°½æ•´ä¸ªtomcatçš„èµ„æºï¼Œå› æ­¤ä¹Ÿå«çº¿ç¨‹éš”ç¦»(**`Hystrix`ä¸­çš„çº¿ç¨‹æ± éš”ç¦»æŠ€æœ¯**)
- ç†”æ–­é™çº§ï¼šç”±**æ–­è·¯å™¨**ç»Ÿè®¡ä¸šåŠ¡æ‰§è¡Œçš„å¼‚å¸¸æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥ä¸šåŠ¡ï¼Œæ‹¦æˆªè®¿é—®è¯¥ä¸šåŠ¡çš„ä¸€åˆ‡è¯·æ±‚
- æµé‡æ§åˆ¶ï¼šé™åˆ¶ä¸šåŠ¡è®¿é—®çš„QPSï¼Œé¿å…æœåŠ¡å› æµé‡çš„çªå¢è€Œæ•…éšœã€‚

å‰ä¸‰ç§æ–¹å¼æ˜¯åœ¨å·²ç»å‘ç”Ÿæ•…éšœçš„å‰æä¸‹é¿å…å¾®æœåŠ¡ä¼ æ’­å¯¼è‡´çº§è”é›ªå´©ï¼Œè€Œæµé‡æ§åˆ¶é‡‡å–çš„æ˜¯é¢„é˜²ç­–ç•¥



å‰é¢æ¥è§¦åˆ°çš„`Sentinel`å®ç°å¯¹èµ„æºçš„é™æµï¼Œåªæ˜¯é¢„é˜²ç­–ç•¥ï¼Œä½†æ˜¯å€˜è‹¥æŸä¸ªè¢«è°ƒç”¨çš„å¾®æœåŠ¡å†…éƒ¨å·²ç»å‡ºç°äº†æ•…éšœï¼Œè¿™æ—¶å€™å³ä½¿é‡‡å–é™æµç­–ç•¥ä¾ç„¶ä¼šå¯¼è‡´å¾®æœåŠ¡çº§è”é›ªå´©ï¼Œæ­¤æ—¶å°±åº”è¯¥é‡‡å–ç†”æ–­+é™çº§ç­–ç•¥æ¥é˜»æ­¢å¾®æœåŠ¡é›ªå´©ï¼š





çº¿ç¨‹æ± éš”ç¦»ï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%9A%94%E7%A6%BB.png" style="zoom:67%;" />



ç†”æ–­å™¨åˆ¤å®šï¼š

<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%86%94%E6%96%AD%E5%99%A8.png" style="zoom:67%;" />

ä¸ç®¡æ˜¯çº¿ç¨‹éš”ç¦»è¿˜æ˜¯ç†”æ–­é™çº§ï¼Œéƒ½æ˜¯å¯¹**æœåŠ¡è°ƒç”¨æ–¹**çš„ä¿æŠ¤



åœ¨`SpringCloud`ä¸­ï¼Œå¾®æœåŠ¡è°ƒç”¨éƒ½æ˜¯é€šè¿‡`Feign`æ¥å®ç°çš„ï¼Œå› æ­¤å®ç°å®¢æˆ·ç«¯ä¿æŠ¤å¿…é¡»æ•´åˆ`Feign`å’Œ`Sentinel`

1.ä¿®æ”¹`OrderService`çš„`application.yml`æ–‡ä»¶ï¼Œå¼€å¯`Feign`çš„`Sentinel`åŠŸèƒ½

```yaml
feign:
  sentinel:
    enabled: true # å¼€å¯feignå¯¹sentinelçš„æ”¯æŒ
```

å¼€å¯è¿™ä¸€é€‰é¡¹åï¼Œè¯¥å¾®æœåŠ¡ä¸‹çš„æ‰€æœ‰`feign`è¿œç¨‹è°ƒç”¨éƒ½ä¼šè¢«`sentinel dashboard`æ‰€ç›‘æµ‹åˆ°



2.ç»™`FeignClient`ç¼–å†™å¤±è´¥åçš„é™çº§é€»è¾‘

â‘ æ–¹å¼ä¸€ï¼š`FallbackClass`ï¼Œæ— æ³•å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†

â‘¡æ–¹å¼äºŒï¼š`FallbackFactory`ï¼Œ**å¯ä»¥å¯¹è¿œç¨‹è°ƒç”¨çš„å¼‚å¸¸åšå¤„ç†**ï¼Œæˆ‘ä»¬é€‰æ‹©è¿™ç§



ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š

```java
//OrderControllerä¸­çš„é€šè¿‡ç”¨æˆ·IDæ¥æŸ¥è¯¢è®¢å•å·çš„æ–¹æ³•
public Order queryOrderByUserId(@PathVariable("orderId") Long orderId) {
        // æ ¹æ®idæŸ¥è¯¢è®¢å•å¹¶è¿”å›
        return orderService.queryOrderById(orderId);
    }
```

è¯¥æ–¹æ³•å®é™…ä¸Šæ˜¯é€šè¿‡`Feign`æ¥è¿œç¨‹è°ƒç”¨`UserService`ä¸­çš„`findById`æ–¹æ³•ï¼š

```java
public class OrderService {
  private UserClient userClient;
  public Order queryOrderById(Long orderId) {
        // 1.æŸ¥è¯¢è®¢å•
        Order order = orderMapper.findById(orderId);
        // 2.ç”¨Feignè¿œç¨‹è°ƒç”¨
        User user = userClient.findById(order.getUserId());
        // 3.å°è£…useråˆ°Order
        order.setUser(user);
        // 4.è¿”å›
        return order;
    }
}



@FeignClient(value = "userservice", fallbackFactory = UserClientFallbackFactory.class)
public interface UserClient {

    @GetMapping("/user/{id}")
    User findById(@PathVariable("id") Long id);
}
```

æ³¨æ„ä¸Šè¿°`@FeignClient`æ³¨è§£ä¸­çš„valueå±æ€§è¡¨ç¤ºè¢«è°ƒç”¨çš„ç›®æ ‡å¾®æœåŠ¡åç§°ï¼Œè¿™é‡Œä¸º"`userservice`",

`userservice`çš„`application.yaml`ä¸­é…ç½®çš„æœåŠ¡åç§°(å¯¹åº”`nacos`ä¸­æœåŠ¡åˆ—è¡¨æ˜¾ç¤ºçš„åç§°)ï¼š

```yaml
spring:
  application:
    name: orderservice
```





ç¼–å†™å¤±è´¥é™çº§çš„é€»è¾‘ï¼š

```java
public class UserClientFallbackFactory implements FallbackFactory<UserClient> {
    @Override
    public UserClient create(Throwable throwable) {
        return new UserClient() {
            @Override
            public User findById(Long id) {
                log.error("æŸ¥è¯¢ç”¨æˆ·å¼‚å¸¸", throwable);
                return new User();
            }
        };
    }
}
```



**è¿™æ ·ç¼–å†™äº†é™çº§é€»è¾‘åï¼Œå½“è¢«è°ƒç”¨çš„å¾®æœåŠ¡ `userservice` å‘ç”Ÿæ•…éšœæˆ–å¼‚å¸¸æ—¶ï¼Œé™çº§é€»è¾‘ä¼šè§¦å‘ã€‚å½“ç”¨æˆ·æœåŠ¡å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„é™çº§é€»è¾‘ä¼šè¿”å›ä¸€ä¸ªç©ºçš„ `User` å¯¹è±¡ã€‚è¿™æ˜¯å› ä¸ºåœ¨ `UserClientFallbackFactory` çš„ `create` æ–¹æ³•ä¸­ï¼Œé™çº§é€»è¾‘ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ `UserClient` å®ä¾‹ï¼Œé‡å†™äº† `findById` æ–¹æ³•ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªç©ºçš„ `User` å¯¹è±¡**

**ç”±äºä¼šè¿”å›ä¸€ä¸ªç©ºç”¨æˆ·ï¼Œæ•…å®¢æˆ·ç«¯æš‚æ—¶æŸ¥è¯¢ä¸åˆ°è‡ªå·±æ‹¥æœ‰çš„è®¢å•å·ï¼Œè¿™ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„**



æˆ‘ä»¬åœ¨`sentinel`çš„`dashboard`å¯ä»¥çœ‹åˆ°è¢«ç›‘æ§çš„`feign`è¿œç¨‹è°ƒç”¨ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/feign-sentinel.png)



è¿™æ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡`sentinel`çš„æµæ§åŠŸèƒ½æ¥è®¾ç½®ä¸€ä¸ªé€‚å½“çš„é˜ˆå€¼ï¼Œç¡®ä¿æ¯ç§’åªæœ‰ä¸€å®šæ•°é‡çš„è¯·æ±‚è®¿é—® `findById` æ–¹æ³•(è¢«è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•)ã€‚è¿™å¯ä»¥é¿å…åœ¨ç”¨æˆ·æœåŠ¡å‡ºç°é—®é¢˜æ—¶ï¼Œè¿‡å¤šçš„è¯·æ±‚å¯¼è‡´æ›´ä¸¥é‡çš„æ•…éšœ







### ä¿¡å·é‡éš”ç¦»

çº¿ç¨‹éš”ç¦»æœ‰ä¸¤ç§æ‰‹æ®µ

- ä¿¡å·é‡éš”ç¦»ï¼šåŸºäºè®¡æ•°å™¨æ¨¡å¼ï¼Œç®€å•ï¼Œå¼€é”€å°â€”â€”â€”`Sentinel`é»˜è®¤

- çº¿ç¨‹æ± éš”ç¦»: Hystrixé»˜è®¤ç­–ç•¥



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%E5%8C%BA%E5%88%AB.png" style="zoom: 67%;" />









è¿™é‡Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¿¡å·é‡éš”ç¦»ï¼Œé€šè¿‡é…ç½®`sentinel`æµæ§è§„åˆ™ä¸­çš„çº¿ç¨‹æ•°æ¥å®ç°



1.åœ¨æ·»åŠ é™æµè§„åˆ™æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä¸¤ç§é˜ˆå€¼ç±»å‹ï¼š



<img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB.png" style="zoom:67%;" />

- QPSï¼šå°±æ˜¯æ¯ç§’çš„è¯·æ±‚æ•°ï¼Œåœ¨å¿«é€Ÿå…¥é—¨ä¸­å·²ç»æ¼”ç¤ºè¿‡

- çº¿ç¨‹æ•°ï¼šæ˜¯è¯¥èµ„æºèƒ½ä½¿ç”¨çš„tomcatçº¿ç¨‹æ•°çš„æœ€å¤§å€¼ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œå®ç°èˆ±å£æ¨¡å¼ã€‚

è®¾ç½®å¥½æ§åˆ¶å°æ˜¾ç¤ºå¦‚ä¸‹ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/1111111111111.png)



2.ç„¶ååœ¨`jmeter`ä¸­è®¾ç½®ä¸€ç¬é—´å‘èµ·è¯·æ±‚çš„çº¿ç¨‹æ•°é‡ä¸º10ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BBjmeter.png)



3.å‘èµ·æµ‹è¯•è¯·æ±‚ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/22222222222.png)

å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸€ç¬é—´(è®¾ç½®äº†`Ramp-Up`ç§’ä¸º0)**åªæœ‰å‰5ä¸ªçº¿ç¨‹çš„è¯·æ±‚**å¾—åˆ°äº†å“åº”ï¼Œå5ä¸ªçº¿ç¨‹éƒ½èµ°äº†é™çº§é€»è¾‘ï¼Œè¿œç¨‹è°ƒç”¨è¿”å›çš„éƒ½æ˜¯ç©ºç”¨æˆ·

æˆ‘ä»¬æœ€åå†æ¥ç†ä¸€ä¸‹å‰åé€»è¾‘ï¼š

- åœ¨`OrderController`ä¸­æœ‰ä¸€ä¸ª`queryOrderByUserId`(é€šè¿‡ç”¨æˆ·idæŸ¥è¯¢å…¶æ‰€æ‹¥æœ‰çš„è®¢å•å·)æ–¹æ³•ï¼Œåœ¨æŸä¸ªå®é™…åœºæ™¯ä¸­å¯èƒ½æœ‰ä¸€ç¬é—´æœ‰å¤§é‡ç”¨æˆ·è¦æŸ¥è¯¢è‡ªå·±æ‰€æ‹¥æœ‰çš„è¯¾ç¨‹(**æ¯”å¦‚é€‰è¯¾é«˜å³°æœŸ**)

- è¯¥`queryOrderByUserId`æ–¹æ³•ä¸­éœ€è¦é€šè¿‡`Feign`æ¥è¿œç¨‹è°ƒç”¨`userservice`ä¸­çš„æŸä¸ªæŸ¥è¯¢æ–¹æ³•`( findById`)ï¼Œä½†æ˜¯åœ¨é«˜å³°æœŸQPSå¤ªé«˜å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨æ‰¿å—ä¸ä½ï¼Œç»§è€Œå¯¼è‡´å¾®æœåŠ¡çº§è”é›ªå´©

- è€ƒè™‘åˆ°ç¬¬2ç‚¹ä¸­çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨åä¸º`orderservice`çš„å¾®æœåŠ¡ä¸­é€šè¿‡é…ç½®ä»¥ä¸‹é€‰é¡¹ï¼Œé€šè¿‡`sentinel`ç›‘æµ‹è¯¥å¾®æœåŠ¡ä¸‹çš„è¿œç¨‹è°ƒç”¨ï¼š

  ```yamL
  spring:
    application:
      name: orderservice
    cloud:
      sentinel:
        feign:
          enabled: true # å¼€å¯å¯¹Feignçš„ç›‘æµ‹
  ```

- ç„¶ååœ¨`sentinel`çš„`dashboard`æ§åˆ¶å°æ¥é…ç½®ä¿¡å·é‡ï¼Œæ§åˆ¶åŒä¸€ç¬é—´è¿›è¡Œ`feign`è¿œç¨‹è°ƒç”¨çš„çº¿ç¨‹æ•°é‡(è¿™é‡Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•è®¾ç½®å•æœºé˜ˆå€¼ä¸º5)ï¼š

â€‹    <img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB.png" style="zoom:67%;" />

   

- ç„¶åæˆ‘ä»¬åœ¨jmeterä¸­æ¨¡æ‹Ÿä¸€ç¬é—´å¤šçº¿ç¨‹è¯·æ±‚ï¼Œè®¾ç½®ç¬é—´è¯·æ±‚çš„çº¿ç¨‹æ•°é‡ä¸º10ï¼Œè¿™æ ·æŒ‰ç†æ¥è¯´ï¼Œå‰5ä¸ªçº¿ç¨‹ä¼šæ­£å¸¸å“åº”ï¼Œå5ä¸ªçº¿ç¨‹ä¼šç”±äºå·²ç»è¾¾åˆ°äº†è®¾ç½®çš„çº¿ç¨‹é˜ˆå€¼ï¼Œæ•…è¿œç¨‹è°ƒç”¨å¼‚å¸¸ï¼Œç»§è€Œèµ°é™çº§é€»è¾‘ï¼š

  <img src="https://cdn.jsdelivr.net/gh/amonstercat/blog-images/22222222222.png" style="zoom:67%;" />

- æˆ‘ä»¬é€šè¿‡æŸ¥çœ‹è¯¥httpè¯·æ±‚çš„`responsebody`ä¹Ÿå¯ä»¥çœ‹åˆ°,è¿”å›çš„Userå¯¹è±¡ä¸ºç©º

  ```http
  {"id":101,"price":699900,"name":"Apple è‹¹æœ iPhone 12 ","num":1,"userId":1,"user":{"id":null,"username":null,"address":null}}
  ```

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸Šè¿°æ‰€åšçš„å·¥ä½œä¾æ—§æ˜¯é€šè¿‡`sentinel`çš„æµé‡æ§åˆ¶å¯¹æŸä¸€æ¥å£è¿›è¡Œé™æµï¼Œå½“è§¦å‘é™æµé˜ˆå€¼(ä¸Šè¿°ä¾‹å­æ˜¯è§¦å‘çº¿ç¨‹æ•°é˜ˆå€¼)æ—¶ï¼Œè‡ªåŠ¨èµ°æˆ‘ä»¬æ‰€é…ç½®å¥½çš„é™çº§ç­–ç•¥ï¼Œä½†æ˜¯è¿™å¹¶æ²¡æœ‰æ¶‰åŠåˆ°ç†”æ–­æœºåˆ¶å‘€ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¦é€šè¿‡æ–­è·¯å™¨æ¥å®ç°æœåŠ¡ç†”æ–­







### æœåŠ¡ç†”æ–­

ç†”æ–­çš„æ€è·¯æ˜¯ç”±**æ–­è·¯å™¨**ç»Ÿè®¡æœåŠ¡è°ƒç”¨çš„å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼åˆ™ä¼š**ç†”æ–­**è¯¥æœåŠ¡ã€‚å³æ‹¦æˆªè®¿é—®è¯¥æœåŠ¡çš„ä¸€åˆ‡è¯·æ±‚ï¼›è€Œå½“æœåŠ¡æ¢å¤æ—¶ï¼Œæ–­è·¯å™¨ä¼šæ”¾è¡Œè®¿é—®è¯¥æœåŠ¡çš„è¯·æ±‚

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%86%94%E6%96%AD11.png)

æ–­è·¯å™¨ç†”æ–­ç­–ç•¥æœ‰ä¸‰ç§ï¼šæ…¢è°ƒç”¨ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°

- æ…¢è°ƒç”¨ï¼šä¸šåŠ¡çš„å“åº”æ—¶é•¿ï¼ˆRTï¼‰å¤§äºæŒ‡å®šæ—¶é•¿çš„è¯·æ±‚è®¤å®šä¸ºæ…¢è°ƒç”¨è¯·æ±‚ã€‚åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œå¦‚æœè¯·æ±‚æ•°é‡è¶…è¿‡è®¾å®šçš„æœ€å°æ•°é‡ï¼Œæ…¢è°ƒç”¨æ¯”ä¾‹å¤§äºè®¾å®šçš„é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ã€‚

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/%E7%86%94%E6%96%AD1111.png)

è§£è¯»ï¼šRTè¶…è¿‡500msçš„è°ƒç”¨æ˜¯æ…¢è°ƒç”¨ï¼Œç»Ÿè®¡æœ€è¿‘10000mså†…çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚é‡è¶…è¿‡10æ¬¡ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨æ¯”ä¾‹ä¸ä½äº0.5ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œç†”æ–­æ—¶é•¿ä¸º5ç§’ã€‚ç„¶åè¿›å…¥half-opençŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚åšæµ‹è¯•ã€‚



- å¼‚å¸¸æ¯”ä¾‹æˆ–å¼‚å¸¸æ•°ï¼šç»Ÿè®¡æŒ‡å®šæ—¶é—´å†…çš„è°ƒç”¨ï¼Œå¦‚æœè°ƒç”¨æ¬¡æ•°è¶…è¿‡æŒ‡å®šçš„æœ€å°è¯·æ±‚æ•°ï¼Œå¹¶ä¸”å‡ºç°å¼‚å¸¸çš„æ¯”ä¾‹è¾¾åˆ°è®¾å®šçš„æ¯”ä¾‹é˜ˆå€¼ï¼ˆæˆ–è¶…è¿‡æŒ‡å®šå¼‚å¸¸æ•°ï¼‰ï¼Œåˆ™è§¦å‘ç†”æ–­









## åˆ†å¸ƒå¼äº‹åŠ¡



åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯**æŒ‡ä¼šæ¶‰åŠåˆ°æ“ä½œå¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡ã€‚å…¶å®å°±æ˜¯å°†å¯¹åŒä¸€åº“äº‹åŠ¡çš„æ¦‚å¿µæ‰©å¤§åˆ°äº†å¯¹å¤šä¸ªåº“çš„äº‹åŠ¡**ã€‚

ç›®çš„æ˜¯ä¸ºäº†ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ä¸€è‡´æ€§ã€‚

åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†çš„å…³é”®æ˜¯å¿…é¡»æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥çŸ¥é“äº‹åŠ¡åœ¨ä»»ä½•åœ°æ–¹æ‰€åšçš„æ‰€æœ‰åŠ¨ä½œï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡çš„å†³å®šå¿…é¡»äº§ç”Ÿç»Ÿä¸€çš„ç»“æœï¼ˆå…¨éƒ¨æäº¤æˆ–å…¨éƒ¨å›æ»šï¼‰

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´åœ¨ç‰©ç†ä¸Šç›¸äº’ç‹¬ç«‹ï¼Œé€šè¿‡ç½‘ç»œè¿›è¡Œæ²Ÿé€šå’Œåè°ƒã€‚ç”±äºå­˜åœ¨äº‹åŠ¡æœºåˆ¶ï¼Œå¯ä»¥ä¿è¯æ¯ä¸ªç‹¬ç«‹èŠ‚ç‚¹ä¸Šçš„æ•°æ®æ“ä½œå¯ä»¥æ»¡è¶³ ACIDã€‚ä½†æ˜¯ï¼Œç›¸äº’ç‹¬ç«‹çš„èŠ‚ç‚¹ä¹‹é—´æ— æ³•å‡†ç¡®çš„çŸ¥é“å…¶ä»–èŠ‚ç‚¹ä¸­çš„äº‹åŠ¡æ‰§è¡Œæƒ…å†µã€‚æ‰€ä»¥ä»ç†è®ºä¸Šè®²ï¼Œä¸¤å°æœºå™¨ç†è®ºä¸Šæ— æ³•è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæƒ³è®©åˆ†å¸ƒå¼éƒ¨ç½²çš„å¤šå°æœºå™¨ä¸­çš„æ•°æ®ä¿æŒä¸€è‡´æ€§ï¼Œé‚£ä¹ˆå°±è¦ä¿è¯åœ¨æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®å†™æ“ä½œï¼Œè¦ä¸å…¨éƒ¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨çš„éƒ½ä¸æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œä¸€å°æœºå™¨åœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡çš„æ—¶å€™æ— æ³•çŸ¥é“å…¶ä»–æœºå™¨ä¸­çš„æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœã€‚æ‰€ä»¥ä»–ä¹Ÿå°±ä¸çŸ¥é“æœ¬æ¬¡äº‹åŠ¡åˆ°åº•åº”è¯¥ commit è¿˜æ˜¯ roolbackã€‚æ‰€ä»¥ï¼Œå¸¸è§„çš„è§£å†³åŠæ³•å°±æ˜¯å¼•å…¥ä¸€ä¸ªâ€œåè°ƒè€…â€çš„ç»„ä»¶æ¥ç»Ÿä¸€è°ƒåº¦æ‰€æœ‰åˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ‰§è¡Œã€‚



### Two-P-C (XAæ¨¡å¼)

2PCï¼Œæ˜¯ Two-Phase-Comimit çš„ç¼©å†™ï¼Œå³ã€Œ**äºŒé˜¶æ®µæäº¤**ã€ï¼Œæ˜¯è®¡ç®—æœºç½‘ç»œå°¤å…¶æ˜¯æ•°æ®åº“é¢†åŸŸå†…ï¼Œä¸ºäº†ä½¿åŸºäºåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„çš„æ‰€æœ‰èŠ‚ç‚¹åœ¨è¿›è¡Œ**äº‹åŠ¡å¤„ç†**è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒåŸå­æ€§å’Œä¸€è‡´æ€§è€Œè®¾è®¡çš„ä¸€ç§åè®®ã€‚ç°åœ¨å¾ˆå¤šæ•°æ®åº“éƒ½æ˜¯é‡‡ç”¨çš„äºŒé˜¶æ®µæäº¤åè®®æ¥å®Œæˆ**åˆ†å¸ƒå¼äº‹åŠ¡**çš„å¤„ç†ã€‚äºŒé˜¶æ®µï¼Œé¡¾åæ€ä¹‰å°±æ˜¯åˆ†ä¸¤ä¸ªé˜¶æ®µå¤„ç†äº‹åŠ¡ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

é˜¶æ®µä¸€ï¼šæäº¤äº‹åŠ¡è¯·æ±‚ï¼ˆâ€æŠ•ç¥¨é˜¶æ®µâ€œï¼‰

å½“è¦æ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡å‘èµ·è€…é¦–å…ˆå‘åè°ƒè€… `Coordinator` å‘èµ·äº‹åŠ¡è¯·æ±‚ï¼Œç„¶ååè°ƒè€…ä¼šç»™æ‰€æœ‰å‚ä¸è€…   `Participant` å‘é€ `prepare` è¯·æ±‚ï¼ˆå…¶ä¸­åŒ…æ‹¬äº‹åŠ¡å†…å®¹ï¼‰å‘Šè¯‰å‚ä¸è€…ä½ ä»¬éœ€è¦æ‰§è¡Œäº‹åŠ¡äº†ï¼Œ**å¦‚æœèƒ½æ‰§è¡Œæˆ‘å‘çš„äº‹åŠ¡å†…å®¹é‚£ä¹ˆå°±å…ˆæ‰§è¡Œä½†ä¸æäº¤ï¼Œæ‰§è¡Œåè¯·ç»™æˆ‘å›å¤**ã€‚ç„¶åå‚ä¸è€…æ”¶åˆ° `prepare` æ¶ˆæ¯åï¼Œä»–ä»¬ä¼šå¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼ˆä½†ä¸æäº¤ï¼‰ï¼Œå¹¶å°† `Undo` å’Œ `Redo` ä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ï¼Œä¹‹åå‚ä¸è€…å°±å‘åè°ƒè€…åé¦ˆæ˜¯å¦å‡†å¤‡å¥½äº†



é˜¶æ®µäºŒï¼šæ‰§è¡Œäº‹åŠ¡æäº¤

åè°ƒè€…æ ¹æ®å„å‚ä¸è€…çš„åé¦ˆæƒ…å†µå†³å®šæœ€ç»ˆæ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡ï¼Œ**å¦‚æœåé¦ˆéƒ½æ˜¯Yesï¼Œå‘é€æäº¤ `commit` è¯·æ±‚**ï¼Œå‚ä¸è€…æäº¤æˆåŠŸåè¿”å› `Ack` æ¶ˆæ¯ï¼Œåè°ƒè€…æ¥æ”¶åå°±å®Œæˆäº†ã€‚**å¦‚æœåé¦ˆæ˜¯ No æˆ–è€…è¶…æ—¶æœªåé¦ˆï¼Œå‘é€ `Rollback` è¯·æ±‚**ï¼Œåˆ©ç”¨é˜¶æ®µä¸€è®°å½•è¡¨çš„ `Undo` ä¿¡æ¯æ‰§è¡Œå›æ»šï¼Œå¹¶åé¦ˆç»™åè°ƒè€… `Ack` ï¼Œä¸­æ–­æ¶ˆæ¯



ç¼ºç‚¹ï¼š

- **å•ç‚¹æ•…éšœé—®é¢˜**ï¼Œå¦‚æœåè°ƒè€…æŒ‚äº†é‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿéƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€äº†
- **é˜»å¡é—®é¢˜**ï¼Œå³å½“åè°ƒè€…å‘é€ `prepare` è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°ä¹‹åå¦‚æœèƒ½å¤„ç†é‚£ä¹ˆå®ƒå°†ä¼šè¿›è¡Œäº‹åŠ¡çš„å¤„ç†ä½†å¹¶ä¸æäº¤ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä¸€ç›´å ç”¨ç€èµ„æºä¸é‡Šæ”¾ï¼Œå¦‚æœæ­¤æ—¶åè°ƒè€…æŒ‚äº†ï¼Œé‚£ä¹ˆè¿™äº›èµ„æºéƒ½ä¸ä¼šå†é‡Šæ”¾äº†ï¼Œè¿™ä¼šæå¤§å½±å“æ€§èƒ½
- **æ•°æ®ä¸ä¸€è‡´é—®é¢˜**ï¼Œæ¯”å¦‚å½“ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…åªå‘é€äº†ä¸€éƒ¨åˆ†çš„ `commit` è¯·æ±‚å°±æŒ‚äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼Œæ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œè€Œåé¢æ²¡æ”¶åˆ°çš„åˆ™ä¸ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜



æœ€å¤§çš„ç¼ºç‚¹åœ¨äºï¼š**2PCæ˜¯CPè®¾è®¡ï¼Œè¿™æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Œæ‰€ä»¥åŠ¿å¿…ä¼šæŸå¤±å¯ç”¨æ€§**ï¼Œå®ƒçš„é—®é¢˜åœ¨äºï¼š

- åŒæ­¥é˜»å¡æ‰§è¡Œä¸­æ‰€æœ‰å‚ä¸è€…çš„äº‹åŠ¡éƒ½ä¼šé˜»å¡ï¼Œæ‰€å çš„é”åŠèµ„æºä¸ä¼šé‡Šæ”¾
- æ•°æ®ä¸ä¸€è‡´ï¼Œåœ¨æäº¤é˜¶æ®µå¦‚æœå‡ºç°ç½‘ç»œæ•…éšœéƒ¨åˆ†å‚ä¸è€…å¯èƒ½ä¼šæ”¶ä¸åˆ°æäº¤å‘½ä»¤ä»è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- å•ç‚¹æ•…éšœï¼Œä½œä¸ºäº‹åŠ¡å¤„ç†é‡è¦ç»„æˆçš„åè°ƒå™¨å­˜åœ¨å•ç‚¹é—®é¢˜





### Three-Phase-Comimit



é˜¶æ®µä¸€ï¼šCanCommit

åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ `CanCommit` è¯·æ±‚ï¼Œå‚ä¸è€…æ”¶åˆ°è¯·æ±‚åä¼šæ ¹æ®è‡ªèº«æƒ…å†µæŸ¥çœ‹æ˜¯å¦èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™è¿”å› YES å“åº”å¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™è¿”å› NO



é˜¶æ®µäºŒï¼šPreCommit

åè°ƒè€…æ ¹æ®å‚ä¸è€…è¿”å›çš„å“åº”æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œä¸‹é¢çš„ `PreCommit` æ“ä½œã€‚å¦‚æœä¸Šé¢å‚ä¸è€…è¿”å›çš„éƒ½æ˜¯ YESï¼Œé‚£ä¹ˆåè°ƒè€…å°†å‘æ‰€æœ‰å‚ä¸è€…å‘é€ `PreCommit` é¢„æäº¤è¯·æ±‚ï¼Œ**å‚ä¸è€…æ”¶åˆ°é¢„æäº¤è¯·æ±‚åï¼Œä¼šè¿›è¡Œäº‹åŠ¡çš„æ‰§è¡Œæ“ä½œï¼Œå¹¶å°† Undo å’Œ Redo ä¿¡æ¯å†™å…¥äº‹åŠ¡æ—¥å¿—ä¸­** ï¼Œæœ€åå¦‚æœå‚ä¸è€…é¡ºåˆ©æ‰§è¡Œäº†äº‹åŠ¡åˆ™ç»™åè°ƒè€…è¿”å›æˆåŠŸçš„ `Ack` å“åº”ã€‚å¦‚æœåœ¨ç¬¬ä¸€é˜¶æ®µåè°ƒè€…æ”¶åˆ°äº† **ä»»ä½•ä¸€ä¸ª NO** çš„ä¿¡æ¯ï¼Œæˆ–è€… **åœ¨ä¸€å®šæ—¶é—´å†…** å¹¶æ²¡æœ‰æ”¶åˆ°å…¨éƒ¨çš„å‚ä¸è€…çš„å“åº”ï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡ï¼Œå®ƒä¼šå‘æ‰€æœ‰å‚ä¸è€…å‘é€ä¸­æ–­è¯·æ±‚ `abort`ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ä¹‹åä¼šç«‹å³ä¸­æ–­äº‹åŠ¡ï¼Œæˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°åè°ƒè€…çš„è¯·æ±‚ï¼Œå®ƒä¹Ÿä¼šä¸­æ–­äº‹åŠ¡



é˜¶æ®µä¸‰ï¼šDoCommit

è¿™ä¸ªé˜¶æ®µå…¶å®å’Œ `2PC` çš„ç¬¬äºŒé˜¶æ®µå·®ä¸å¤šï¼Œå¦‚æœåè°ƒè€…æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…åœ¨ `PreCommit` é˜¶æ®µçš„ YES å“åº”ï¼Œé‚£ä¹ˆåè°ƒè€…å°†ä¼šç»™æ‰€æœ‰å‚ä¸è€…å‘é€ `DoCommit` è¯·æ±‚ï¼Œ**å‚ä¸è€…æ”¶åˆ° DoCommit è¯·æ±‚ååˆ™ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤å·¥ä½œ**ï¼Œå®Œæˆååˆ™ä¼šç»™åè°ƒè€…è¿”å›å“åº”ï¼Œåè°ƒè€…æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…è¿”å›çš„äº‹åŠ¡æäº¤æˆåŠŸçš„å“åº”ä¹‹ååˆ™å®Œæˆäº‹åŠ¡ã€‚è‹¥åè°ƒè€…åœ¨ `PreCommit` é˜¶æ®µ **æ”¶åˆ°äº†ä»»ä½•ä¸€ä¸ª NO æˆ–è€…åœ¨ä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å“åº”** ï¼Œé‚£ä¹ˆå°±ä¼šè¿›è¡Œä¸­æ–­è¯·æ±‚çš„å‘é€ï¼Œå‚ä¸è€…æ”¶åˆ°ä¸­æ–­è¯·æ±‚ååˆ™ä¼š **é€šè¿‡ä¸Šé¢è®°å½•çš„å›æ»šæ—¥å¿—** æ¥è¿›è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶å‘åè°ƒè€…åé¦ˆå›æ»šçŠ¶å†µï¼Œåè°ƒè€…æ”¶åˆ°å‚ä¸è€…è¿”å›çš„æ¶ˆæ¯åï¼Œä¸­æ–­äº‹åŠ¡ã€‚

![3PC](https://img.starfish.ink/zookeeper/3pc.png)

ä¼˜ç¼ºç‚¹ï¼š

é™ä½äº†å‚ä¸è€…çš„é˜»å¡èŒƒå›´ï¼Œä¸”èƒ½åœ¨å•ç‚¹æ•…éšœåç»§ç»­è¾¾æˆä¸€è‡´ã€‚

ä½†æ˜¯æœ€é‡è¦çš„ä¸€è‡´æ€§å¹¶æ²¡æœ‰å¾—åˆ°æ ¹æœ¬çš„è§£å†³ï¼Œæ¯”å¦‚åœ¨ `PreCommit` é˜¶æ®µï¼Œå½“ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº†è¯·æ±‚ä¹‹åå…¶ä»–å‚ä¸è€…å’Œåè°ƒè€…æŒ‚äº†æˆ–è€…å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œè¿™ä¸ªæ—¶å€™æ”¶åˆ°æ¶ˆæ¯çš„å‚ä¸è€…éƒ½ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œè¿™å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚











### TCC





### SAGA

sagaçš„å®šä¹‰æ˜¯â€œé•¿æ—¶é—´æ´»åŠ¨çš„äº‹åŠ¡â€ï¼Œå³é’ˆå¯¹é•¿äº‹åŠ¡æå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆ

æ‰€è°“é•¿äº‹åŠ¡ï¼Œå°±æ˜¯éœ€è¦é•¿æ—¶é—´æ‰§è¡Œçš„äº‹åŠ¡ï¼Œè¿™ç±»äº‹åŠ¡å¾€å¾€éœ€è¦è®¿é—®å¤§é‡çš„æ•°æ®å¯¹è±¡ï¼Œå…¶æ‰§è¡Œå‘¨æœŸç”šè‡³èƒ½è¾¾åˆ°å‡ å‘¨æˆ–å‡ æœˆã€‚ä½†ä¼ ç»Ÿçš„äº‹åŠ¡æ‰§è¡Œæ—¶éœ€è¦é”å®šå ç”¨èµ„æºï¼Œå¦‚æœåœ¨è¿™æ ·çš„ä¸€ä¸ªåœºæ™¯ä¸‹ï¼Œèµ„æºè¢«é•¿æœŸé”å®šï¼Œå¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—å¯æƒ³è€ŒçŸ¥ã€‚å› æ­¤æˆ‘ä»¬å¼•å…¥äº†SAGAæ¨¡å¼æ¥è§£å†³é•¿äº‹åŠ¡ã€‚

SAGAçš„å·¥ä½œåŸç†å‘¢ï¼Œå°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼š

SAGAæ¨¡å¼ç”±ä¸€ä¸²æœ¬åœ°äº‹åŠ¡ç»„æˆï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡éƒ½æœ‰è‡ªå·±å›æ»šæ•°æ®çš„è¡¥å¿äº‹åŠ¡ã€‚äº‹åŠ¡ä¹‹é—´ä¸²å‹æ‰§è¡Œï¼Œå½“æ­£å‘æ‰§è¡Œçš„æŸä¸€ä¸ªäº‹åŠ¡å‡ºç°æŠ¥é”™ï¼Œé‚£ä¹ˆå°†æ‰§è¡Œè¿™ä¸ªäº‹åŠ¡çš„è¡¥å¿äº‹åŠ¡ï¼Œå¹¶ä¸”é€†è¡Œæ‰§è¡Œä¹‹å‰äº‹åŠ¡çš„è¡¥å¿äº‹åŠ¡

SAGAä¹Ÿæ˜¯æœ‰ä¸¤é˜¶æ®µçš„ï¼Œä¸€é˜¶æ®µæ˜¯æ­£å‘äº‹åŠ¡ï¼ŒäºŒé˜¶æ®µæ˜¯è¡¥å¿äº‹åŠ¡

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72f6680dd75b4ecba79cb2d0ce402fa4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" style="zoom:67%;" />

sagaæ¨¡å¼ä¾ç„¶è¦æ±‚æˆ‘ä»¬è‡ªå·±å®ç°æ­£å‘æœåŠ¡å’Œè¡¥å¿æœåŠ¡ã€‚ä½†æ˜¯å®ƒäºTCCæ¨¡å¼çš„åŒºåˆ«ä¹‹å¤„åœ¨äºï¼š

- sagaçš„æ¨¡å¼è®¾è®¡ä½¿å¾—å®ƒå¤©ç„¶é€‚åˆäºé•¿æµç¨‹çš„ä¸šåŠ¡ã€‚TCCè¦å®ç°åŒæ ·çš„é•¿æµç¨‹çš„è¯ï¼Œéœ€è¦å¤šå†™ä¸€ä¸ªconfirmæ“ä½œï¼Œå¹¶ä¸”è¦è€ƒè™‘å¦‚ä½•å°†ä¸šåŠ¡æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†
- sagaæ¨¡å¼åœ¨æ­£å‘æœåŠ¡ä¸­æ—¶å°±å·²ç»æäº¤äº†æœ¬åœ°äº‹åŠ¡äº†ï¼Œè€Œè¡¥å¿äº‹åŠ¡ä¹Ÿæ¯”è¾ƒå¥½å®ç°ï¼Œå°†æ­£å‘æœåŠ¡çš„ç»“åˆé€†å‘è¡¥å¿å³å¯ã€‚ æ¯”å¦‚æ­£å¸¸æœåŠ¡æ˜¯`update product set price=20 where price=30 and id=1;` é‚£ä¹ˆè¡¥å¿æœåŠ¡å°±æ˜¯`update product set price=30 where price=20 and id=1;`
- æ¯”èµ·TCCæ¨¡å¼ï¼Œsagaæ¨¡å¼æ›´é€‚ç”¨äºä¸€äº›è€æœåŠ¡ã€ç¬¬ä¸‰æ–¹æœåŠ¡æˆ–è€…å…¶ä»–æ— æ³•æ”¹é€ çš„æœåŠ¡ï¼Œè¦æ¥å…¥åˆ°æˆ‘ä»¬çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸­æ—¶ï¼Œå°±å¯ä»¥å°†å…¶ä½œä¸ºä¸€ä¸ªæ­£å‘æœåŠ¡å­˜åœ¨ï¼Œè€Œç›´æ¥å®ç°ä»–çš„è¡¥å¿æœåŠ¡å³å¯ã€‚è€ŒTCCå› ä¸ºè¦å¯¹ä¸šåŠ¡è¿›è¡Œæ‹†åˆ†ä¸ºtry-confirm-cancelï¼Œæ‰€ä»¥å®ƒä¸é€‚ç”¨äºä¸å¯æ”¹é€ çš„æœåŠ¡

åŒæ—¶ï¼Œsagaæ¨¡å¼åŒæ ·ä¸éœ€è¦å…¨å±€é”ï¼Œåªéœ€è¦ç»“åˆæœ¬åœ°äº‹åŠ¡åŠ æœ¬åœ°é”å³å¯ï¼Œæ‰€ä»¥æ€§èƒ½ä¾æ—§æœ‰ä¿è¯ã€‚



> `saga`ä¸ºä»€ä¹ˆé€‚åˆé•¿äº‹åŠ¡åœºæ™¯å‘¢ï¼Ÿ

SAGAæ¨¡å¼é€‚åˆé•¿äº‹åŠ¡çš„åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **åˆ†æ­¥æ‰§è¡Œï¼š** SAGAå°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€ä¸ªå±€éƒ¨äº‹åŠ¡ã€‚è¿™æ ·å¯ä»¥å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡ï¼Œå‡å°‘æ¯ä¸ªäº‹åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼Œé™ä½é”ç«äº‰å’Œæ•°æ®åº“èµ„æºå ç”¨ï¼Œä»è€Œæé«˜ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚
2. **å±€éƒ¨å›æ»šï¼š** åœ¨ä¼ ç»Ÿçš„ä¸¤é˜¶æ®µæäº¤ä¸­ï¼Œå¦‚æœåœ¨å‡†å¤‡é˜¶æ®µæŸä¸ªå‚ä¸è€…å‡ºç°é—®é¢˜ï¼Œæ•´ä¸ªå…¨å±€äº‹åŠ¡å¯èƒ½ä¼šè¢«å›æ»šï¼Œå¯¼è‡´é•¿äº‹åŠ¡æŒç»­çš„é˜»å¡ã€‚è€Œåœ¨SAGAæ¨¡å¼ä¸­ï¼Œæ¯ä¸ªå±€éƒ¨äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œï¼Œ**å¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œåªéœ€è¦å›æ»šè¯¥æ­¥éª¤å’Œä¹‹å‰çš„æ­¥éª¤ï¼Œä¸ä¼šå½±å“åˆ°åç»­æ­¥éª¤çš„æ‰§è¡Œï¼Œä»è€Œå‡å°‘äº†é•¿äº‹åŠ¡çš„é˜»å¡æ—¶é—´**ã€‚
3. **å®¹é”™æ€§ï¼š** SAGAæ¨¡å¼é€šè¿‡å±€éƒ¨äº‹åŠ¡çš„è¡¥å¿æ“ä½œæ¥å¤„ç†éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å®¹é”™æ€§ã€‚å³ä½¿æŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œç³»ç»Ÿä»ç„¶å¯ä»¥å°è¯•é€šè¿‡æ‰§è¡Œè¡¥å¿æ“ä½œæ¥å°†ç³»ç»ŸçŠ¶æ€æ¢å¤åˆ°æ­£ç¡®çš„çŠ¶æ€ã€‚
4. **å¯ä¼¸ç¼©æ€§ï¼š** ç”±äºSAGAæ¨¡å¼å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œä¸åŒæ­¥éª¤çš„å±€éƒ¨äº‹åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¯ä¼¸ç¼©æ€§ã€‚è¿™å¯¹äºå¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚ä»¥åŠåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ‰©å±•æ€§éå¸¸æœ‰ç›Šã€‚

æ€»ä¹‹ï¼ŒSAGAæ¨¡å¼é€šè¿‡å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œå¹¶å¼•å…¥å±€éƒ¨äº‹åŠ¡å’Œè¡¥å¿æ“ä½œçš„æ¦‚å¿µï¼Œæœ‰æ•ˆåœ°è§£å†³äº†é•¿äº‹åŠ¡åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¯èƒ½å‡ºç°çš„æ€§èƒ½ã€å¯ç”¨æ€§å’Œå¯ä¼¸ç¼©æ€§é—®é¢˜ï¼Œä½¿ç³»ç»Ÿæ›´åŠ å¥å£®å’Œå¯é ã€‚



### AT  :disappointed:



ATæ¨¡å¼æ˜¯Seataç‹¬æœ‰çš„ï¼Œå…ˆæ¥çœ‹çœ‹Seataçš„æ¶æ„å›¾ï¼š

![img](https:////upload-images.jianshu.io/upload_images/4420767-e84da60c060f3631.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

`Seata Architecture` æœ‰ 3 ä¸ªç»„ä»¶ï¼šTMï¼ˆTransaction Managerï¼‰ã€RMï¼ˆResource Managerï¼‰ å’Œ TCï¼ˆTransaction Coordinatorï¼‰ã€‚ä¸€ä¸ªå…¸å‹çš„äº‹åŠ¡è¿‡ç¨‹ï¼š

1. **TM å‘ TC ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡**ï¼Œå…¨å±€äº‹åŠ¡åˆ›å»ºæˆåŠŸå¹¶ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ XIDã€‚
2. XID åœ¨å¾®æœåŠ¡è°ƒç”¨é“¾è·¯çš„ä¸Šä¸‹æ–‡ä¸­ä¼ æ’­ã€‚
3. RM å‘ TC æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œå°†å…¶çº³å…¥ XID å¯¹åº”å…¨å±€äº‹åŠ¡çš„ç®¡è¾–ã€‚
4. **TM å‘ TC å‘èµ·é’ˆå¯¹ XID çš„å…¨å±€æäº¤æˆ–å›æ»šå†³è®®**ã€‚
5. TC è°ƒåº¦ **XID ä¸‹ç®¡è¾–çš„å…¨éƒ¨åˆ†æ”¯äº‹åŠ¡å®Œæˆæäº¤æˆ–å›æ»šè¯·æ±‚**ã€‚





åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆæœ‰å¾ˆå¤šé€‰æ‹©ï¼Œä½†åŸºäºç¼–ç¨‹æ¨¡å‹ä¸å˜çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å®é™…é¢ä¸´çš„é€‰æ‹©å°±ä¸å¤šäº†ã€‚

æœ€ç›´æ¥çš„é€‰æ‹©å°±æ˜¯ XAï¼ŒSeata AT æ¨¡å¼çš„æ ¸å¿ƒæ€è·¯ä¹Ÿæ˜¯ä»å®¡è§† XA çš„é—®é¢˜å¼€å§‹çš„ã€‚

<img src="https://upload-images.jianshu.io/upload_images/4420767-df427e999cc56037.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom: 50%;" />



å¦‚æœç”¨ XA åè®®æ¥æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¼šä»€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼š

![img](https:////upload-images.jianshu.io/upload_images/4420767-e95f7ada0e9c77c7.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

How Does XA Do ?

- æ•°æ®æºï¼ˆå›¾ä¸­ç»¿è‰²çš„åœˆï¼‰ï¼Œè¦æ±‚ç”¨ XA æ•°æ®æºã€‚
- SQL æ‰§è¡Œçš„å‰åï¼Œéœ€è¦åš xa start å’Œ xa end ã€‚
- æäº¤é˜¶æ®µï¼ŒXA çš„ä¸¤é˜¶æ®µæäº¤ï¼Œå…ˆè°ƒç”¨å„ä¸ªå‚ä¸æ–¹çš„ prepareï¼Œå†æ ¹æ®ç»“æœï¼Œè°ƒç”¨å‚ä¸æ–¹çš„ commit æˆ– rollbackã€‚

é¦–å…ˆï¼Œä¸Šè¿°è¿™äº›å·¥ä½œï¼Œå¯¹äºä¸šåŠ¡æ¥è¯´ï¼Œéƒ½æ˜¯é¢å¤–çš„å¼€é”€ã€‚å¤šè½®çš„äº¤äº’ï¼Œè¿™ä¸ªå¼€é”€æ˜¯ä¸å°çš„ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œæˆ‘è¿™é‡Œç”»äº†ä¸€äº›é”ã€‚åˆ†åˆ«åœ¨ä¸¤ä¸ªåœ°æ–¹æ¶‰åŠåˆ°é”ï¼š

- ä¸€ä¸ªæ˜¯æ•°æ®ï¼Œè¿™å¥½ç†è§£ï¼ŒXA äº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œæ•°æ®æ˜¯è¢«é”å®šçš„ã€‚
- å¦ä¸€æ–¹é¢æ˜¯è¿æ¥ï¼ŒXA äº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œè¿æ¥ä¹Ÿæ˜¯è¢«é”å®šçš„ã€‚è‡³å°‘åœ¨ä¸¤é˜¶æ®µæäº¤çš„ prepare ä¹‹å‰ï¼Œè¿æ¥æ˜¯ä¸èƒ½é‡Šæ”¾çš„ï¼ˆå› ä¸ºè¿æ¥æ–­å¼€ï¼Œè¿™ä¸ªè¿æ¥ä¸Šçš„ XA åˆ†æ”¯å°±ä¼šå›æ»šï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šè¢«è¿«å›æ»šï¼‰ã€‚

è¾ƒä¹‹äºæ•°æ®çš„é”å®šï¼ˆæ•°æ®çš„é”å®šå¯¹äºäº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯å¿…è¦çš„æœºåˆ¶ï¼‰ï¼Œ**è¿æ¥çš„é”å®šå¸¦ç»™æ•´ä¸ªä¸šåŠ¡ç³»ç»Ÿçš„ç›´æ¥å½±å“å°±æ˜¯ï¼Œé™åˆ¶äº†å¹¶å‘åº¦ã€‚**



å¯¹æ¯”ä¹‹å‰å¯¹ XA åˆ†æï¼ŒAT çš„æ ¸å¿ƒå‡ºå‘ç‚¹ï¼Œå°±æ˜¯ **æ–©æ–­** XA å¯èƒ½å¸¦æ¥çš„åˆ¶çº¦



**ATçš„å®ç°æ ¸å¿ƒå°±æ˜¯åœ¨å…¨å±€äº‹åŠ¡æ“ä½œæ—¶ç”Ÿæˆåå‘Sqlæ¥å®ç°æ•°æ®å›æ»šï¼Œéœ€è¦åœ¨æ•°æ®åº“é¢å¤–é™„åŠ UNDO_LOGè¡¨**

<img src="https://upload-images.jianshu.io/upload_images/4420767-2a68f3760a0825d5.png?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp" alt="img" style="zoom:50%;" />

è¿˜æ˜¯çœ‹è¿™ä¸ªå¾®æœåŠ¡åœºæ™¯ä¸‹çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹ï¼š

- **è°ƒç”¨é“¾è·¯**ä¸Šçš„ SQL æ“ä½œï¼Œå½“å‰æœåŠ¡è°ƒç”¨å®Œæˆåï¼Œç›´æ¥**æäº¤**ï¼Œé‡Šæ”¾èµ„æºï¼ˆè§£é™¤äº†è¿æ¥å’Œæœ¬åœ°äº‹åŠ¡çš„æ•°æ®é”å®šï¼‰
- ä¸šåŠ¡æ•°æ®æäº¤çš„åŒæ—¶ï¼ŒæŠŠæ•°æ®çš„ **å›æ»šæ—¥å¿—** ä¸€å¹¶å­˜æ”¾åˆ°å›æ»šæ—¥å¿—è¡¨é‡Œï¼Œä»¥å¤‡å…¨å±€å›æ»šæ—¶ä½¿ç”¨(åŸºäºUndoLog)

è¿™é‡Œé¢æœ‰ä¸¤ä¸ªå…³é”®ï¼š

ç¬¬ä¸€ï¼Œåˆ©ç”¨äº† **æ•°æ®åº“æœ¬åœ°äº‹åŠ¡** çš„ç‰¹æ€§ï¼Œè®©å›æ»šæ—¥å¿—å’Œä¸šåŠ¡æ•°æ®çš„å†™å…¥ä¿è¯åŸå­æ€§ï¼šåªè¦æœ‰ä¸šåŠ¡æ•°æ®æäº¤æˆåŠŸï¼Œå°±ä¸€å®šæœ‰ç›¸åº”çš„å›æ»šæ—¥å¿—æ•°æ®ã€‚

ç¬¬äºŒï¼Œè€ƒè™‘åˆ°å®é™…ä¸šåŠ¡çš„è¿è¡Œè¿‡ç¨‹ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹æœ€ç»ˆæ˜¯æˆåŠŸå…¨å±€æäº¤çš„ã€‚ç›´æ¥æœ¬åœ°æäº¤çš„æœºåˆ¶ï¼Œçœå»äº†ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ**ä¸¤é˜¶æ®µæäº¤çš„å¼€é”€**

ä½†æ˜¯ATæ¨¡å¼å­˜åœ¨ä¸­é—´æ€ï¼šå³å¤šä¸ªå¾®æœåŠ¡ä¹‹é—´æ•°æ®ä¸ä¸€è‡´æ€§çŠ¶æ€ï¼Œä½†æ˜¯è¿™ç§ä¸ä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§(ä»£è¡¨AP)ï¼ŒATæ¨¡å¼ä¸‹ä¾ç„¶ä¼šå®ç°æœ€ç»ˆä¸€è‡´æ€§







**ATæ¨¡å¼ä¸»è¦ç‰¹ç‚¹**:

1. æœ€ç»ˆä¸€è‡´æ€§
2. æ€§èƒ½è¾ƒXAé«˜
3. åªåœ¨ç¬¬ä¸€é˜¶æ®µè·å–é”ï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µè¿›è¡Œæäº¤åé‡Šæ”¾é”ã€‚

åœ¨ä¸€é˜¶æ®µä¸­ï¼ŒSeataä¼šæ‹¦æˆª ä¸šåŠ¡SQL ï¼Œé¦–å…ˆè§£æSQLè¯­ä¹‰ï¼Œæ‰¾åˆ°è¦æ“ä½œçš„ä¸šåŠ¡æ•°æ®ï¼Œåœ¨æ•°æ®è¢«æ“ä½œå‰ï¼Œä¿å­˜ä¸‹æ¥è®°å½• undo logï¼Œç„¶åæ‰§è¡Œ ä¸šåŠ¡SQL æ›´æ–°æ•°æ®ï¼Œæ›´æ–°ä¹‹åå†æ¬¡ä¿å­˜æ•°æ® redo logï¼Œæœ€åç”Ÿæˆè¡Œé”ï¼Œè¿™äº›æ“ä½œéƒ½åœ¨æœ¬åœ°æ•°æ®åº“äº‹åŠ¡å†…å®Œæˆï¼Œè¿™æ ·ä¿è¯äº†ä¸€é˜¶æ®µçš„åŸå­æ€§ã€‚

ç›¸å¯¹ä¸€é˜¶æ®µï¼ŒäºŒé˜¶æ®µæ¯”è¾ƒç®€å•ï¼Œè´Ÿè´£æ•´ä½“çš„å›æ»šå’Œæäº¤ï¼Œå¦‚æœä¹‹å‰çš„ä¸€é˜¶æ®µä¸­æœ‰æœ¬åœ°äº‹åŠ¡æ²¡æœ‰é€šè¿‡ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œå…¨å±€å›æ»šï¼Œå¦åœ¨æ‰§è¡Œå…¨å±€æäº¤ï¼Œå›æ»šç”¨åˆ°çš„å°±æ˜¯ä¸€é˜¶æ®µè®°å½•çš„ undo Log ï¼Œé€šè¿‡å›æ»šè®°å½•ç”Ÿæˆåå‘æ›´æ–°SQLå¹¶æ‰§è¡Œï¼Œä»¥å®Œæˆåˆ†æ”¯çš„å›æ»šã€‚å½“ç„¶äº‹åŠ¡å®Œæˆåä¼šé‡Šæ”¾æ‰€æœ‰èµ„æºå’Œåˆ é™¤æ‰€æœ‰æ—¥å¿—ã€‚

ATæµç¨‹åˆ†ä¸ºä¸¤é˜¶æ®µï¼Œä¸»è¦é€»è¾‘å…¨éƒ¨åœ¨ç¬¬ä¸€é˜¶æ®µï¼Œç¬¬äºŒé˜¶æ®µä¸»è¦åšå›æ»šæˆ–æ—¥å¿—æ¸…ç†çš„å·¥ä½œã€‚æµç¨‹å¦‚ä¸‹ï¼š

![](https://cdn.jsdelivr.net/gh/amonstercat/blog-images/SEATA.png)

ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè®¢å•æœåŠ¡ä¸­TMå‘TCç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œä¸€èˆ¬é€šè¿‡`@GlobalTransactional`æ ‡æ³¨å¼€å¯ï¼ŒTCä¼šè¿”å›ä¸€ä¸ªå…¨å±€äº‹åŠ¡ID(XID)ï¼Œè®¢å•æœåŠ¡åœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ä¹‹å‰ï¼ŒRMä¼šå…ˆå‘TCæ³¨å†Œä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡ï¼Œ è®¢å•æœåŠ¡ä¾æ¬¡ç”Ÿæˆundo log æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œç”Ÿæˆredo log æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå‘TCæ±‡æŠ¥ï¼Œäº‹åŠ¡æ‰§è¡ŒOKã€‚

è®¢å•æœåŠ¡å‘èµ·è¿œç¨‹è°ƒç”¨ï¼Œå°†äº‹åŠ¡IDä¼ é€’ç»™åº“å­˜æœåŠ¡ï¼Œåº“å­˜æœåŠ¡åœ¨æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ä¹‹å‰ï¼Œå…ˆå‘TCæ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œåº“å­˜æœåŠ¡åŒæ ·ç”Ÿæˆundo Logå’Œredo Logï¼Œå‘TCæ±‡æŠ¥ï¼Œäº‹åŠ¡çŠ¶æ€æˆåŠŸã€‚

å¦‚æœæ­£å¸¸å…¨å±€æäº¤ï¼ŒTCé€šçŸ¥æ¯ä¸ªRMä¸€æ­¥æ¸…ç†æ‰æœ¬åœ°undoå’Œredoæ—¥å¿—ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªæœåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œé‚£ä¹ˆå‘èµ·å›æ»šè¯·æ±‚ã€‚é€šè¿‡undo logè¿›è¡Œå›æ»šã€‚









### å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§



å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆæ˜¯æŒ‡å½“äº‹åŠ¡å‘èµ·æ–¹æ‰§è¡Œå®Œæˆæœ¬åœ°äº‹åŠ¡åå¹¶å‘å‡ºä¸€æ¡æ¶ˆæ¯ï¼Œäº‹åŠ¡å‚ä¸æ–¹(æ¶ˆæ¯æ¶ˆè´¹è€…)ä¸€å®šèƒ½å¤Ÿæ¥æ”¶æ¶ˆæ¯å¹¶å¤„ç†äº‹åŠ¡æˆåŠŸï¼Œæ­¤æ–¹æ¡ˆå¼ºè°ƒçš„æ˜¯åªè¦æ¶ˆæ¯å‘ç»™äº‹åŠ¡å‚ä¸æ–¹æœ€ç»ˆäº‹åŠ¡è¦è¾¾åˆ°ä¸€è‡´ã€‚ æ­¤æ–¹æ¡ˆæ˜¯åˆ©ç”¨æ¶ˆæ¯ä¸­é—´ä»¶å®Œæˆï¼Œå¦‚ä¸‹å›¾ï¼š   

<img src="https://it-blog-cn.com/assets/img/consis.53975859.png" alt="æœ€ç»ˆä¸€è‡´æ€§" style="zoom:67%;" />

äº‹åŠ¡å‘èµ·æ–¹ï¼ˆæ¶ˆæ¯ç”Ÿäº§æ–¹ï¼‰å°†æ¶ˆæ¯å‘ç»™æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œäº‹åŠ¡å‚ä¸æ–¹ä»æ¶ˆæ¯ä¸­é—´ä»¶æ¥æ”¶æ¶ˆæ¯ï¼Œäº‹åŠ¡å‚ä¸æ–¹ï¼ˆæ¶ˆæ¯æ¶ˆè´¹æ–¹ï¼‰å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä¹‹é—´éƒ½æ˜¯é€šè¿‡ç½‘ç»œé€šä¿¡ï¼Œç”±äºç½‘ç»œé€šä¿¡çš„ä¸ç¡®å®šæ€§ä¼šå¯¼è‡´åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚å› æ­¤å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆè¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š  

ã€1ã€‘æœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€çš„åŸå­æ€§é—®é¢˜ï¼š äº‹åŠ¡å‘èµ·æ–¹åœ¨æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸåæ¶ˆæ¯å¿…é¡»å‘å‡ºå»ï¼Œå¦åˆ™å°±ä¸¢å¼ƒæ¶ˆæ¯ã€‚å³å®ç°æœ¬åœ°äº‹åŠ¡å’Œæ¶ˆæ¯å‘é€çš„åŸå­æ€§ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚æœ¬åœ°äº‹åŠ¡ä¸æ¶ˆæ¯å‘é€çš„åŸå­æ€§é—®é¢˜æ˜¯å®ç°å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆçš„å…³é”®é—®é¢˜ã€‚å…ˆæ¥å°è¯•ä¸‹è¿™ç§æ“ä½œï¼Œå…ˆå‘é€æ¶ˆæ¯ï¼Œå†æ“ä½œæ•°æ®åº“ï¼šè¿™ç§æƒ…å†µä¸‹æ— æ³•ä¿è¯æ•°æ®åº“æ“ä½œä¸å‘é€æ¶ˆæ¯çš„ä¸€è‡´æ€§ï¼Œå› ä¸ºå¯èƒ½å‘é€æ¶ˆæ¯æˆåŠŸï¼Œæ®åº“æ“ä½œå¤±è´¥ã€‚

```sql
begin transactionï¼› 
    //1.å‘é€MQ 
    //2.æ•°æ®åº“æ“ä½œ 
commit transation;
```

ã€2ã€‘äº‹åŠ¡å‚ä¸æ–¹æ¥æ”¶æ¶ˆæ¯çš„å¯é æ€§ï¼šäº‹åŠ¡å‚ä¸æ–¹å¿…é¡»èƒ½å¤Ÿä»æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¦‚æœæ¥æ”¶æ¶ˆæ¯å¤±è´¥å¯ä»¥é‡å¤æ¥æ”¶æ¶ˆæ¯ã€‚
ã€3ã€‘æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜ï¼šç”±äºæ­¥éª¤2çš„å­˜åœ¨ï¼Œè‹¥æŸä¸€ä¸ªæ¶ˆè´¹èŠ‚ç‚¹è¶…æ—¶ä½†æ˜¯æ¶ˆè´¹æˆåŠŸï¼Œæ­¤æ—¶æ¶ˆæ¯ä¸­é—´ä»¶ä¼šé‡å¤æŠ•é€’æ­¤æ¶ˆæ¯ï¼Œå°±å¯¼è‡´äº†æ¶ˆæ¯çš„é‡å¤æ¶ˆè´¹ã€‚è¦è§£å†³æ¶ˆæ¯é‡å¤æ¶ˆè´¹çš„é—®é¢˜å°±è¦å®ç°äº‹åŠ¡å‚ä¸æ–¹çš„æ–¹æ³•å¹‚ç­‰æ€§ã€‚







RocketMQ çš„è®¾è®¡ä¸­ broker ä¸ producer ç«¯çš„åŒå‘é€šä¿¡èƒ½åŠ›ï¼Œä½¿å¾— broker å¤©ç”Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªäº‹åŠ¡åè°ƒè€…å­˜åœ¨ï¼›è€Œ RocketMQæœ¬èº«æä¾›çš„å­˜å‚¨æœºåˆ¶ä¸ºäº‹åŠ¡æ¶ˆæ¯æä¾›äº†æŒä¹…åŒ–èƒ½åŠ›ï¼›RocketMQ çš„é«˜å¯ç”¨æœºåˆ¶ä»¥åŠå¯é æ¶ˆæ¯è®¾è®¡åˆ™ä¸ºäº‹åŠ¡æ¶ˆæ¯åœ¨ç³»ç»Ÿå‘ç”Ÿå¼‚å¸¸æ—¶ä¾ç„¶èƒ½å¤Ÿä¿è¯è¾¾æˆäº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚åœ¨ RocketMQ 4.3åå®ç°äº†å®Œæ•´çš„äº‹åŠ¡æ¶ˆæ¯ï¼Œå®é™…ä¸Šæ˜¯å¯¹æœ¬åœ°æ¶ˆæ¯è¡¨çš„ä¸€ä¸ªå°è£…ï¼Œå°†æœ¬åœ°æ¶ˆæ¯è¡¨ç§»åŠ¨åˆ°äº† MQå†…éƒ¨ï¼Œè§£å†³Producer ç«¯çš„æ¶ˆæ¯å‘é€ä¸æœ¬åœ°äº‹åŠ¡æ‰§è¡Œçš„åŸå­æ€§é—®é¢˜ã€‚

ã€æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‘ï¼š ä¸ºæ–¹ä¾¿ç†è§£æˆ‘ä»¬è¿˜ä»¥æ³¨å†Œé€ç§¯åˆ†çš„ä¾‹å­æ¥æè¿°æ•´ä¸ªæµç¨‹ã€‚Producer å³MQå‘é€æ–¹ï¼Œæœ¬ä¾‹ä¸­æ˜¯ç”¨æˆ·æœåŠ¡ï¼Œè´Ÿè´£æ–°å¢ç”¨æˆ·ã€‚MQè®¢é˜…æ–¹å³æ¶ˆæ¯æ¶ˆè´¹æ–¹ï¼Œæœ¬ä¾‹ä¸­æ˜¯ç§¯åˆ†æœåŠ¡ï¼Œè´Ÿè´£æ–°å¢ç§¯åˆ†ã€‚ 

ã€1ã€‘Producer å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼š Producer ï¼ˆMQå‘é€æ–¹ï¼‰å‘é€äº‹åŠ¡æ¶ˆæ¯è‡³MQ Serverï¼ŒMQ Serverå°†æ¶ˆæ¯çŠ¶æ€æ ‡è®°ä¸ºPreparedï¼ˆé¢„å¤‡çŠ¶æ€ï¼‰ï¼Œæ³¨æ„æ­¤æ—¶è¿™æ¡æ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆMQè®¢é˜…æ–¹ï¼‰æ˜¯æ— æ³•æ¶ˆè´¹åˆ°çš„ã€‚æœ¬ä¾‹ä¸­ï¼ŒProducer å‘é€ â€å¢åŠ ç§¯åˆ†æ¶ˆæ¯â€œ åˆ°MQ Serverã€‚ 

ã€2ã€‘MQ Serverå›åº”æ¶ˆæ¯å‘é€æˆåŠŸï¼š MQ Serveræ¥æ”¶åˆ° Producer å‘é€ç»™çš„æ¶ˆæ¯åˆ™å›åº”å‘é€æˆåŠŸã€‚è¡¨ç¤º MQå·²æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ 

ã€3ã€‘Producer æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼š Producer ç«¯æ‰§è¡Œä¸šåŠ¡ä»£ç é€»è¾‘ï¼Œé€šè¿‡æœ¬åœ°æ•°æ®åº“äº‹åŠ¡æ§åˆ¶ã€‚æœ¬ä¾‹ä¸­ï¼ŒProducer æ‰§è¡Œæ·»åŠ ç”¨æˆ·æ“ä½œã€‚ 

ã€4ã€‘æ¶ˆæ¯æŠ•é€’ï¼š è‹¥ Producer æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸåˆ™è‡ªåŠ¨å‘ MQServerå‘é€ commitæ¶ˆæ¯ï¼ŒMQ Serveræ¥æ”¶åˆ° Commitæ¶ˆæ¯åå°†â€œå¢åŠ ç§¯åˆ†æ¶ˆæ¯â€ çŠ¶æ€æ ‡è®°ä¸ºå¯æ¶ˆè´¹ï¼Œæ­¤æ—¶MQè®¢é˜…æ–¹ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰å³æ­£å¸¸æ¶ˆè´¹æ¶ˆæ¯ã€‚è‹¥Producer æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥åˆ™è‡ªåŠ¨å‘ MQServerå‘é€ Rollbackæ¶ˆæ¯ï¼ŒMQ Serveræ¥æ”¶åˆ° Rollbackæ¶ˆæ¯åå°†åˆ é™¤â€œå¢åŠ ç§¯åˆ†æ¶ˆæ¯â€ã€‚MQè®¢é˜…æ–¹ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ¶ˆè´¹æˆåŠŸåˆ™å‘MQå›åº”ackï¼Œå¦åˆ™å°†é‡å¤æ¥æ”¶æ¶ˆæ¯ã€‚è¿™é‡Œ acké»˜è®¤è‡ªåŠ¨å›åº”ï¼Œå³ç¨‹åºæ‰§è¡Œæ­£å¸¸åˆ™è‡ªåŠ¨å›åº”ackã€‚ 

ã€5ã€‘äº‹åŠ¡å›æŸ¥ï¼š å¦‚æœæ‰§è¡Œ Producerç«¯æœ¬åœ°äº‹åŠ¡è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œç«¯æŒ‚æ‰ï¼Œæˆ–è€…è¶…æ—¶ï¼ŒMQ Serverå°†ä¼šä¸åœçš„è¯¢é—®åŒç»„çš„å…¶ä»– Produceræ¥è·å–äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼Œè¿™ä¸ªè¿‡ç¨‹å«äº‹åŠ¡å›æŸ¥ã€‚MQ Serverä¼šæ ¹æ®äº‹åŠ¡å›æŸ¥ç»“æœæ¥å†³å®šæ˜¯å¦æŠ•é€’æ¶ˆæ¯ã€‚ä»¥ä¸Šä¸»å¹²æµç¨‹å·²ç”±RocketMQå®ç°ï¼Œå¯¹ç”¨æˆ·ä¾§æ¥è¯´ï¼Œç”¨æˆ·éœ€è¦åˆ†åˆ«å®ç°æœ¬åœ°äº‹åŠ¡æ‰§è¡Œä»¥åŠæœ¬åœ°äº‹åŠ¡å›æŸ¥æ–¹æ³•ï¼Œå› æ­¤åªéœ€å…³æ³¨æœ¬åœ°äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆç»´æŠ¤æœ¬åœ°äº‹åŠ¡çŠ¶æ€è¡¨ï¼‰å³å¯ã€‚

 RoacketMQ æä¾›äº† RocketMQLocalTransactionListeneræ¥å£ï¼š









## Nacos



### Nacoså¦‚ä½•å®ç°CP?



**1.RaftController**

rafté›†ç¾¤å†…éƒ¨èŠ‚ç‚¹é—´æ˜¯é€šè¿‡æš´éœ²çš„ Restfulæ¥å£ï¼Œä»£ç åœ¨ `RaftController`ä¸­ã€‚`RaftController`æ§åˆ¶å™¨æ˜¯ Rafté›†ç¾¤å†…éƒ¨èŠ‚ç‚¹é—´é€šä¿¡ä½¿ç”¨çš„ï¼Œå…·ä½“çš„ä¿¡æ¯å¦‚ä¸‹:

```
 1 POST HTTP://{ip:port}/v1/ns/raft/vote : è¿›è¡ŒæŠ•ç¥¨è¯·æ±‚
 2 
 3 POST HTTP://{ip:port}/v1/ns/raft/beat : Leaderå‘Followerå‘é€å¿ƒè·³ä¿¡æ¯
 4 
 5 GET HTTP://{ip:port}/v1/ns/raft/peer : è·å–è¯¥èŠ‚ç‚¹çš„RaftPeerä¿¡æ¯
 6 
 7 PUT HTTP://{ip:port}/v1/ns/raft/datum/reload : é‡æ–°åŠ è½½æŸæ—¥å¿—ä¿¡æ¯
 8 
 9 POST HTTP://{ip:port}/v1/ns/raft/datum : Leaderæ¥æ”¶ä¼ æ¥çš„æ•°æ®å¹¶å­˜å…¥
10 
11 DELETE HTTP://{ip:port}/v1/ns/raft/datum : Leaderæ¥æ”¶ä¼ æ¥çš„æ•°æ®åˆ é™¤æ“ä½œ
12 
13 GET HTTP://{ip:port}/v1/ns/raft/datum : è·å–è¯¥èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®ä¿¡æ¯
14 
15 GET HTTP://{ip:port}/v1/ns/raft/state : è·å–è¯¥èŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯{UP or DOWN}
16 
17 POST HTTP://{ip:port}/v1/ns/raft/datum/commit : FollowerèŠ‚ç‚¹æ¥æ”¶Leaderä¼ æ¥å¾—åˆ°æ•°æ®å­˜å…¥æ“ä½œ
18 
19 DELETE HTTP://{ip:port}/v1/ns/raft/datum : FollowerèŠ‚ç‚¹æ¥æ”¶Leaderä¼ æ¥çš„æ•°æ®åˆ é™¤æ“ä½œ
20 
21 GET HTTP://{ip:port}/v1/ns/raft/leader : è·å–å½“å‰é›†ç¾¤çš„LeaderèŠ‚ç‚¹ä¿¡æ¯
22 
23 GET HTTP://{ip:port}/v1/ns/raft/listeners : è·å–å½“å‰Rafté›†ç¾¤çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬è€…
```



**2.RaftPeerSet**

è¿™ä¸ªå¯¹è±¡å­˜å‚¨çš„æ˜¯æ‰€æœ‰`raft`åè®®ä¸‹çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå­˜å‚¨çš„å…ƒç´ å¦‚ä¸‹

```java
// é›†ç¾¤èŠ‚ç‚¹åœ°å€ç®¡ç†
private ServerListManager serverListManager;

// å‘¨æœŸæ•°
private AtomicLong localTerm = new AtomicLong(0L);

// å½“å‰å‘¨æœŸå†…çš„Leader
private RaftPeer leader = null;

// æ‰€æœ‰çš„èŠ‚ç‚¹ä¿¡æ¯
private Map<String, RaftPeer> peers = new HashMap<String, RaftPeer>();

// æš‚æ—¶ä¸æ¸…æ¥šç”¨é€”
private Set<String> sites = new HashSet<>();

// æœ¬èŠ‚ç‚¹æ˜¯å¦å·²å‡†å¤‡å®Œæ¯•
private boolean ready = false;
```



**3.RaftCore**

è¯¥å¯¹è±¡æ˜¯`nacos`ä¸­`raft`åè®®çš„ä¸»è¦å®ç°ï¼Œåœ¨å¯åŠ¨ä¹‹åˆï¼Œä¼šè¿›è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–çš„æ“ä½œï¼Œåˆå§‹åŒ–çš„ä¸€ç³»åˆ—æ“ä½œå®Œæˆåï¼Œæ­¤æ—¶é›†ç¾¤è¿˜æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼Œå› ä¸ºæ­¤æ—¶`Leader`è¿˜æœªé€‰ä¸¾å‡ºæ¥ï¼Œéœ€è¦åœ¨`MasterElection`é€‰ä¸¾`Leader`æˆåŠŸåæ‰å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡

æ¯ä¸ªèŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šè®¤ä¸ºè‡ªå·±å¯ä»¥ä½œä¸º`Leader`ï¼Œå› æ­¤éƒ½ä¼šä»¥è‡ªå·±ä½œä¸ºè¢«é€‰ä¸¾äººï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘èµ·æŠ•ç¥¨è¯·æ±‚ï¼Œè€Œå…¶ä»–èŠ‚ç‚¹åœ¨æ¥æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚åçš„å·¥ä½œæµç¨‹å¦‚ä¸‹

```java
// å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°æŠ•ç¥¨è¯·æ±‚åçš„ååº”
public RaftPeer receivedVote(RaftPeer remote) {
  // è¢«é€‰ä¸¾äººæ˜¯å¦åœ¨rafté›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨ä¸­
	if (!peers.contains(remote)) {
		throw new IllegalStateException("can not find peer: " + remote.ip);
	}

 	// è·å–è‡ªèº«èŠ‚ç‚¹ä¿¡æ¯
	RaftPeer local = peers.get(NetUtils.localServer());
  // å¦‚æœè¢«é€‰ä¸¾èŠ‚ç‚¹çš„å‘¨æœŸæ•°å°äºæœ¬èŠ‚ç‚¹çš„å‘¨æœŸæ•°ï¼Œåˆ™å°†è‡ªå·±çš„æŠ•ç¥¨æŠ•ç»™è‡ªå·±å¹¶å‘Šè¯‰è¢«é€‰ä¸¾è€…
	if (remote.term.get() <= local.term.get()) {
		String msg = "received illegitimate vote" + ", voter-term:" + remote.term + ", votee-term:" + local.term;
		Loggers.RAFT.info(msg);
		if (StringUtils.isEmpty(local.voteFor)) {
			local.voteFor = local.ip;
		}
		return local;
	}
  // æ»¡è¶³æŠ•ç¥¨æ¡ä»¶åï¼Œæœ¬èŠ‚ç‚¹ç¡®è®¤å°†è‡ªå·±çš„ç¥¨æŠ•ç»™è¢«é€‰ä¸¾è€…
	local.resetLeaderDue();
	local.state = RaftPeer.State.FOLLOWER;
	local.voteFor = remote.ip;
	local.term.set(remote.term.get());
	Loggers.RAFT.info("vote {} as leader, term: {}", remote.ip, remote.term);
	return local;
```

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæœ€ç»ˆé€‰ä¸¾å‡ºäº†`Leader`èŠ‚ç‚¹ï¼Œæ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†

å› ä¸ºæ˜¯`CP`æ¨¡å¼ï¼Œæ‰€ä»¥æ“ä½œéƒ½æ˜¯é€šè¿‡`Leader`èŠ‚ç‚¹è¿›è¡Œä¼ è¾¾çš„ï¼Œ`Follower`èŠ‚ç‚¹æœ¬èº«ä¸ä¸`Client`è¿›è¡Œè”ç³»ï¼Œ`Follower`åªèƒ½æ¥å—æ¥è‡ª`Leader`çš„æ“ä½œè¯·æ±‚ï¼Œå› æ­¤å°±å­˜åœ¨è¯·æ±‚è½¬å‘çš„é—®é¢˜ã€‚å› æ­¤åœ¨`RaftCore`ä¸­çš„`singlePublish`ä»¥åŠ`singleDelete`ä¸­ï¼Œå­˜åœ¨ç€å¯¹`Leader`èŠ‚ç‚¹çš„åˆ¤æ–­ä»¥åŠè¯·æ±‚è½¬å‘çš„é€»è¾‘



åŒæ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æœºåˆ¶â€”â€”å¿ƒè·³æœºåˆ¶ï¼Œ`raft`é€šè¿‡å¿ƒè·³æœºåˆ¶æ¥ç»´æŒ`Leader`ä»¥åŠ`Follower`çš„å…³ç³»,æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

```java
// éå†æ‰€æœ‰çš„FollowerèŠ‚ç‚¹è¿›è¡Œå‘é€å¿ƒè·³æ•°æ®åŒ…
		for (final String server : peers.allServersWithoutMySelf()) {
			try {
				final String url = buildURL(server, API_BEAT);
				Loggers.RAFT.info("send beat to server " + server);
        // é‡‡ç”¨å¼‚æ­¥HTTPè¯·æ±‚è¿›è¡Œå¿ƒè·³æ•°æ®å‘é€
				HttpClient.asyncHttpPostLarge(url, null, compressedBytes, new AsyncCompletionHandler<Integer>() {
					@Override
					public Integer onCompleted(Response response) throws Exception {
						if (response.getStatusCode() != HttpURLConnection.HTTP_OK) {
							Loggers.RAFT.error("NACOS-RAFT beat failed: {}, peer: {}", response.getResponseBody(), server);
            	MetricsMonitor.getLeaderSendBeatFailedException().increment();
						}
            // æˆåŠŸåæ¥æ”¶FollowerèŠ‚ç‚¹çš„å¿ƒè·³å›å¤(FollowerèŠ‚ç‚¹çš„å½“å‰ä¿¡æ¯)è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°æ“ä½œ
						peers.update(JSON.parseObject(response.getResponseBody(), RaftPeer.class));
						Loggers.RAFT.info("receive beat response from: {}", url);
						return 0;
```

å¿ƒè·³æœºåˆ¶ï¼š Raftä¸­ä½¿ç”¨å¿ƒè·³æœºåˆ¶æ¥è§¦å‘Leaderé€‰ä¸¾ã€‚å¿ƒè·³å®šæ—¶ä»»åŠ¡æ˜¯åœ¨`GlobalExecutor`ä¸­ï¼Œé€šè¿‡`GlobalExecutor.register(new HeartBeat())`æ³¨å†Œå¿ƒè·³å®šæ—¶ä»»åŠ¡ï¼Œå…·ä½“æ“ä½œåŒ…æ‹¬ï¼š 

ã€1ã€‘é‡ç½®LeaderèŠ‚ç‚¹çš„heart timeoutã€election timeout

ã€2ã€‘sendBeat()å‘é€å¿ƒè·³åŒ…





### Nacoså¦‚ä½•å®ç°APï¼Ÿ

Nacosåœ¨APæ¨¡å¼ä¸‹çš„ä¸€è‡´æ€§ç­–ç•¥å°±ç±»ä¼¼äºEurekaï¼Œé‡‡ç”¨`Server`ä¹‹é—´äº’ç›¸çš„æ•°æ®åŒæ­¥æ¥å®ç°æ•°æ®åœ¨é›†ç¾¤ä¸­çš„åŒæ­¥ã€å¤åˆ¶æ“ä½œ

**è§¦å‘æ•°æ®å¹¿æ’­ï¼š**

```java
DistroConsistencyServiceImpl.java

@Override
public void put(String key, Record value) throws NacosException {
    onPut(key, value);
    taskDispatcher.addTask(key);
}
```

https://www.liaochuntao.cn/2019/05/09/java-web-32/



### æœåŠ¡æ³¨å†Œ

1.åœ¨`Nacos Server`çš„`nacos-naming`å·¥ç¨‹ä¸‹çš„`InstanceController`ç±»ä¸­çš„`register`æ–¹æ³•ä½œä¸ºæœåŠ¡æ³¨å†Œçš„å…¥å£ï¼š

```java
@RestController
@RequestMapping(UtilsAndCommons.NACOS_NAMING_CONTEXT + "/instance")
public class InstanceController {

    @Autowired
    private ServiceManager serviceManager;

    @CanDistro
    @PostMapping
    @Secured(parser = NamingResourceParser.class, action = ActionTypes.WRITE)
    public String register(HttpServletRequest request) throws Exception {
        //è¿™é‡Œå¯ä»¥çœ‹å‡ºNacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ²¡æœ‰ç”¨åˆ°group
        //å‘½åç©ºé—´
        final String namespaceId = WebUtils
                .optional(request, CommonParams.NAMESPACE_ID, Constants.DEFAULT_NAMESPACE_ID);
        //æœåŠ¡åç§°
        final String serviceName = WebUtils.required(request, CommonParams.SERVICE_NAME);
        NamingUtils.checkServiceNameFormat(serviceName);
        
        //å°†æœåŠ¡æ³¨å†Œæ³¨å†Œè¯·æ±‚å‚æ•°è½¬æ¢æˆInstance
        final Instance instance = parseInstance(request);
        
        //æ³¨å†Œå®ä¾‹
        serviceManager.registerInstance(namespaceId, serviceName, instance);
        return "ok";
    }
}
```



2.`serviceManager.registerInstance`æ³¨å†ŒæœåŠ¡å®ä¾‹

```JAVA
@Component
public class ServiceManager implements RecordListener<Service> {

    //Nacosçš„æ³¨å†Œè¡¨
    private final Map<String, Map<String, Service>> serviceMap = new ConcurrentHashMap<>();

    @Resource(name = "consistencyDelegate")
    private ConsistencyService consistencyService;

    public void registerInstance(String namespaceId, String serviceName, Instance instance) throws NacosException {
        //åˆ›å»ºä¸€ä¸ªç©ºçš„æœåŠ¡
        createEmptyService(namespaceId, serviceName, instance.isEphemeral());
        
        //è·å–æœåŠ¡,ä»Nacosçš„æ³¨å†Œè¡¨è·å–æœåŠ¡
        Service service = getService(namespaceId, serviceName);
        
        if (service == null) {
            throw new NacosException(NacosException.INVALID_PARAM,
                    "service not found, namespace: " + namespaceId + ", service: " + serviceName);
        }
        
        //æ–°å¢å®ä¾‹
        addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);
    }
    
    public void addInstance(String namespaceId, String serviceName, boolean ephemeral, Instance... ips)
            throws NacosException {
        
        String key = KeyBuilder.buildInstanceListKey(namespaceId, serviceName, ephemeral);
        
        //è·å–æœåŠ¡,ä»Nacosçš„æ³¨å†Œè¡¨è·å–æœåŠ¡
        Service service = getService(namespaceId, serviceName);
        
        //åŠ é”,åŒä¸€æ—¶é—´åŒä¸€å‘½åç©ºé—´ä¸‹çš„åŒä¸€æœåŠ¡ï¼Œåªèƒ½å…è®¸æœ‰ä¸€ä¸ªæœåŠ¡æ³¨å†Œè¯·æ±‚
        synchronized (service) {
            //æ›´æ–°å¹¶è¿”å›æ€»çš„instanceListåˆ—è¡¨
            List<Instance> instanceList = addIpAddresses(service, ephemeral, ips);
            
            //åˆ›å»ºæ–°çš„instanceåˆ—è¡¨å¯¹è±¡
            Instances instances = new Instances();
            instances.setInstanceList(instanceList);
            //å°†å®ä¾‹åˆ—è¡¨é›†åˆå’Œkeyè®¾ç½®è¿›consistencyServiceä¸­
            consistencyService.put(key, instances);
        }
    }
    
    //è·å–æœåŠ¡
    public Service getService(String namespaceId, String serviceName) {
        if (serviceMap.get(namespaceId) == null) {
            return null;
        }
        return chooseServiceMap(namespaceId).get(serviceName);
    }   
}
```



**3.å°†æœåŠ¡æ³¨å†Œè¯·æ±‚æ”¾å…¥åˆ°`ArrayBlockingQueue`é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†æœåŠ¡å®ä¾‹å­˜å…¥DataStoreä¸­çš„dataMapä¸­**



**4.å°†æœåŠ¡æ³¨å†Œè¯·æ±‚æ”¾å…¥åˆ°ArrayBlockingQueueé˜»å¡é˜Ÿåˆ—åï¼Œå¤„ç†è¯¥é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œåœ¨Notifierä¸­çš„runæ–¹æ³•ä¸­å¤„ç†è¯¥ä»»åŠ¡**

```
@DependsOn("ProtocolManager")
@org.springframework.stereotype.Service("distroConsistencyService")
public class DistroConsistencyServiceImpl implements EphemeralConsistencyService, DistroDataProcessor {
    
    private final DataStore dataStore;
    
    private volatile Notifier notifier = new Notifier();    
    
    public class Notifier implements Runnable {
        
        private ConcurrentHashMap<String, String> services = new ConcurrentHashMap<>(10 * 1024);
        
        private BlockingQueue<Pair<String, DataOperation>> tasks = new ArrayBlockingQueue<>(1024 * 1024);
        
        public int getTaskSize() {
            return tasks.size();
        }
        
        @Override
        public void run() {
            Loggers.DISTRO.info("distro notifier started");
            
            for (; ; ) {
                try {
                    //å–å‡ºæ³¨å†Œè¯·æ±‚ä»»åŠ¡
                    Pair<String, DataOperation> pair = tasks.take();
                    //å¤„ç†ä»»åŠ¡
                    handle(pair);
                } catch (Throwable e) {
                    Loggers.DISTRO.error("[NACOS-DISTRO] Error while handling notifying task", e);
                }
            }
        }
        
        private void handle(Pair<String, DataOperation> pair) {
            try {
                String datumKey = pair.getValue0();
                DataOperation action = pair.getValue1();
                
                services.remove(datumKey);
                
                int count = 0;
                
                if (!listeners.containsKey(datumKey)) {
                    return;
                }
                
                for (RecordListener listener : listeners.get(datumKey)) {
                    
                    count++;
                    
                    try {
                        //å¦‚æœæ˜¯ä¸€ä¸ªæ•°æ®å˜æ›´åŠ¨ä½œï¼ŒæœåŠ¡æ³¨å†Œæ•°æ®æ•°æ®å˜æ›´
                        if (action == DataOperation.CHANGE) {
                            //ä»dataStoreä¸­è·å–æœåŠ¡æ³¨å†Œè¯·æ±‚æ”¾å…¥çš„æœåŠ¡å®ä¾‹é›†åˆ
                            listener.onChange(datumKey, dataStore.get(datumKey).value);
                            continue;
                        }
                        //å¦‚æœæ˜¯ä¸€ä¸ªæ•°æ®åˆ é™¤åŠ¨ä½œ
                        if (action == DataOperation.DELETE) {
                            listener.onDelete(datumKey);
                            continue;
                        }
                    } catch (Throwable e) {
                        Loggers.DISTRO.error("[NACOS-DISTRO] error while notifying listener of key: {}", datumKey, e);
                    }
                }
                
                if (Loggers.DISTRO.isDebugEnabled()) {
                    Loggers.DISTRO
                            .debug("[NACOS-DISTRO] datum change notified, key: {}, listener count: {}, action: {}",
                                    datumKey, count, action.name());
                }
            } catch (Throwable e) {
                Loggers.DISTRO.error("[NACOS-DISTRO] Error while handling notifying task", e);
            }
        }
    }
}
```



5.ä»dataStoreä¸­è·å–æœåŠ¡æ³¨å†Œè¯·æ±‚æ”¾å…¥çš„æœåŠ¡å®ä¾‹é›†åˆï¼Œè°ƒç”¨listener.onChangeæ–¹æ³•æ³¨å†Œ

```
public class Cluster extends com.alibaba.nacos.api.naming.pojo.Cluster implements Cloneable {

    @JsonIgnore
    private Set<Instance> persistentInstances = new HashSet<>();
    
    @JsonIgnore
    private Set<Instance> ephemeralInstances = new HashSet<>();

    public void updateIps(List<Instance> ips, boolean ephemeral) {
        //æ‹¿åˆ°clusterä¸­æ—§çš„instanceåˆ—è¡¨
        Set<Instance> toUpdateInstances = ephemeral ? ephemeralInstances : persistentInstances;
        
        HashMap<String, Instance> oldIpMap = new HashMap<>(toUpdateInstances.size());
        
        for (Instance ip : toUpdateInstances) {
            oldIpMap.put(ip.getDatumKey(), ip);
        }
         //updatedIpsä¸»è¦åšçš„æ˜¯æ‰¾å‡ºoldipmapä¸­çš„å®ä¾‹å¹¶è¿”å›
        List<Instance> updatedIPs = updatedIps(ips, oldIpMap.values());
        if (updatedIPs.size() > 0) {
            for (Instance ip : updatedIPs) {
                Instance oldIP = oldIpMap.get(ip.getDatumKey());
                
                // do not update the ip validation status of updated ips
                // because the checker has the most precise result
                // Only when ip is not marked, don't we update the health status of IP:
                if (!ip.isMarked()) {
                    ip.setHealthy(oldIP.isHealthy());
                }
                
                if (ip.isHealthy() != oldIP.isHealthy()) {
                    // ip validation status updated
                    Loggers.EVT_LOG.info("{} {SYNC} IP-{} {}:{}@{}", getService().getName(),
                            (ip.isHealthy() ? "ENABLED" : "DISABLED"), ip.getIp(), ip.getPort(), getName());
                }
                
                if (ip.getWeight() != oldIP.getWeight()) {
                    // ip validation status updated
                    Loggers.EVT_LOG.info("{} {SYNC} {IP-UPDATED} {}->{}", getService().getName(), oldIP.toString(),
                            ip.toString());
                }
            }
        }
        //æ‰¾å‡ºæ–°å¢çš„å®ä¾‹åˆ—è¡¨,å³ipsä¸­çš„å®ä¾‹ï¼Œoldipmapä¸å­˜åœ¨çš„å®ä¾‹åˆ—è¡¨
        List<Instance> newIPs = subtract(ips, oldIpMap.values());
        if (newIPs.size() > 0) {
            Loggers.EVT_LOG
                    .info("{} {SYNC} {IP-NEW} cluster: {}, new ips size: {}, content: {}", getService().getName(),
                            getName(), newIPs.size(), newIPs.toString());
            
            for (Instance ip : newIPs) {
                //è¿›è¡Œæ–°å®ä¾‹çš„å¥åº·æ£€æŸ¥è®¾ç½®
                HealthCheckStatus.reset(ip);
            }
        }
        //æ‰¾å‡ºoldipmapçš„ipçš„å®ä¾‹ã€‚ä¸å­˜åœ¨äºipsä¸­çš„å®ä¾‹
        List<Instance> deadIPs = subtract(oldIpMap.values(), ips);
        
        if (deadIPs.size() > 0) {
            Loggers.EVT_LOG
                    .info("{} {SYNC} {IP-DEAD} cluster: {}, dead ips size: {}, content: {}", getService().getName(),
                            getName(), deadIPs.size(), deadIPs.toString());
            
            for (Instance ip : deadIPs) {
                //å°†ä¸å­˜åœ¨æ–°å®ä¾‹ipåˆ—è¡¨çš„å€¼çš„å¥åº·æ£€æŸ¥åˆ é™¤
                HealthCheckStatus.remv(ip);
            }
        }
        
        toUpdateInstances = new HashSet<>(ips);
        
        //æ›´æ–°æœåŠ¡ä¸‹clusterçš„intancesåˆ—è¡¨
        if (ephemeral) {
            ephemeralInstances = toUpdateInstances;
        } else {
            persistentInstances = toUpdateInstances;
        }
    }
}
```

**æœ€æ ¸å¿ƒçš„å°±æ˜¯updateIPs**

ä¸ºäº†é˜²æ­¢è¯»å†™å¹¶å‘å†²çªï¼Œç›´æ¥åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„HashMapï¼Œç„¶åå»æ“ä½œæ–°çš„HashMapï¼Œæ“ä½œå®Œäº†ä¹‹åå†å»æ›¿æ¢è€çš„Mapæ•°æ®ï¼ŒCopyOnWriteçš„æ€æƒ³ã€‚æœ€åè¿˜å‘å¸ƒäº†æœåŠ¡å˜åŒ–äº‹ä»¶ã€‚

- **æœåŠ¡æ³¨å†Œé€šè¿‡CopyOnWriteæ”¯æŒå¹¶å‘è¯»å†™çš„èƒ½åŠ›**
- Clusterç±»ä¸­çš„updateIPsæ–¹æ³•ä¸­æ˜¯å¯¹åŸæœåŠ¡IPåˆ—è¡¨çš„å‰¯æœ¬è¿›è¡Œæ“ä½œï¼Œæ³¨å†Œå®Œæˆæ›¿æ¢åŸæœ‰æœåŠ¡IPåˆ—è¡¨å³å¯ï¼Œå³CopyOnWriteæ“ä½œï¼Œä¸éœ€è¦åŠ é”ï¼Œæ€§èƒ½é«˜ï¼Œå­˜åœ¨æœåŠ¡å»¶è¿Ÿ(AP)

Eurekaé˜²æ­¢è¯»å†™å†²çªç”¨çš„æ˜¯å¤šçº§ç¼“å­˜ç»“æ„ï¼Œå¤šçº§ç¼“å­˜å®šæ—¶åŒæ­¥ï¼Œå®¢æˆ·ç«¯æ„ŸçŸ¥åŠæ—¶æ€§ä¸å¦‚Nacosã€‚





### æœåŠ¡å¿ƒè·³æ£€æµ‹











## è´Ÿè½½å‡è¡¡ç®—æ³•



### ä¸€è‡´æ€§å“ˆå¸Œ

RPCæ¡†æ¶ä¸­çš„ä¸€è‡´æ€§å“ˆå¸Œå®ç°ä¸ºï¼š

```java

public class IpHashLoadBalancer implements LoadBalancer{
    @Override
    public Instance select(List<Instance> instances , String address) {
        ConsistentHash ch = new ConsistentHash(instances, 160);//è™šæ‹ŸèŠ‚ç‚¹è®¾ç½®ä¸ºäº†160
        HashMap<String,Instance> map = ch.map;
        return map.get(ch.getServer(address));
    }
}



//ä¸€è‡´æ€§hash åˆ©ç”¨treemapå®ç°
class ConsistentHash {
    
    //TreeMapä¸­çš„keyè¡¨ç¤ºæœåŠ¡å™¨çš„hashå€¼ï¼Œvalueè¡¨ç¤ºæœåŠ¡å™¨ipã€‚æ¨¡æ‹Ÿä¸€ä¸ªå“ˆå¸Œç¯
    private static TreeMap<Integer,String> Nodes = new TreeMap();
    
    private static int VIRTUAL_NODES = 160;//è™šæ‹ŸèŠ‚ç‚¹ä¸ªæ•°ï¼Œç”¨æˆ·æŒ‡å®šï¼Œé»˜è®¤160
    private static List<Instance> instances = new ArrayList<>();//çœŸå®ç‰©ç†èŠ‚ç‚¹é›†åˆ
    public ConsistentHash(List<Instance> instances, int VIRTUAL_NODES){
        this.instances = instances;
        this.VIRTUAL_NODES = VIRTUAL_NODES;
    }
 
    public static HashMap<String,Instance> map = new HashMap<>();//å°†æœåŠ¡å®ä¾‹ä¸ipåœ°å€ä¸€ä¸€æ˜ å°„
    //é¢„å¤„ç† å½¢æˆå“ˆå¸Œç¯
    static {
        //ç¨‹åºåˆå§‹åŒ–ï¼Œå°†æ‰€æœ‰çš„æœåŠ¡å™¨(çœŸå®èŠ‚ç‚¹ä¸è™šæ‹ŸèŠ‚ç‚¹)æ”¾å…¥Nodesï¼ˆåº•å±‚ä¸ºçº¢é»‘æ ‘ï¼‰ä¸­
        for (Instance instance : instances) {
            String ip = instance.getIp();
            
            Nodes.put(getHash(ip),ip); //ç¯ä¸Šæ”¾å…¥çœŸå®èŠ‚ç‚¹
            
            map.put(ip,instance);  // mapä¸­å­˜æ”¾ çœŸå®èŠ‚ç‚¹çš„ipâ€”â€”Instanceå¯¹åº”ä¿¡æ¯
            
            for(int i = 0; i < VIRTUAL_NODES; i++) {
                int hash = getHash(ip+"#"+i);
                Nodes.put(hash,ip); //ç¯TreeMapä¸Šæ”¾å…¥æ¯ä¸ªçœŸå®èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹
            }
        }
    }
    
    
    //å¾—åˆ°è¯·æ±‚è¢«åˆ†é…åˆ°çš„å®ä¾‹ â€”â€” å¯¹åº”çš„Ipåœ°å€
    public  String getServer(String clientInfo) {
        int hash = getHash(clientInfo); // è®¡ç®—å®¢æˆ·ç«¯è¯·æ±‚çš„hash,ä¸éœ€è¦æ”¾å…¥ç¯ä¸Šï¼
        
        //å¾—åˆ°å¤§äºè¯¥Hashå€¼çš„å­çº¢é»‘æ ‘â€”â€”â€”â€”â€”â€”å› ä¸ºçº¢é»‘æ ‘æ»¡è¶³ AVL&&BST 
        SortedMap<Integer,String> subMap = Nodes.tailMap(hash);
        
        //è·å–è¯¥å­æ ‘æœ€å°å…ƒç´  ï¼Œå³é¡ºæ—¶é’ˆçš„ç¬¬ä¸€ä¸ªå®ä¾‹
        Integer nodeIndex = subMap.firstKey();
        
        //æ²¡æœ‰å¤§äºè¯¥å…ƒç´ çš„å­æ ‘ å–æ•´æ ‘çš„ç¬¬ä¸€ä¸ªå…ƒç´ (æƒ³è±¡æˆä¸€ä¸ªç¯ï¼Œè¶…è¿‡å°¾éƒ¨åˆ™å–ç¬¬ä¸€ä¸ª key)
        if (nodeIndex == null) {
            nodeIndex = Nodes.firstKey();
        }   
         String virtualNodeIp = Nodes.get(nodeIndex);//é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹çš„å“ˆå¸Œå€¼æ‰¾åˆ°å¯¹åº”çœŸå®èŠ‚ç‚¹çš„IP
        
        return  map.get(virtualNodeIp); //// è¿”å›çœŸå®èŠ‚ç‚¹å¯¹åº”çš„Instance
    }
    
    
    
    //ä½¿ç”¨FNV1_32_HASHç®—æ³•è®¡ç®—æœåŠ¡å™¨çš„Hashå€¼,è¿™é‡Œä¸ä½¿ç”¨é‡å†™hashCodeçš„æ–¹æ³•ï¼Œæœ€ç»ˆæ•ˆæœæ²¡åŒºåˆ«
    private static int getHash(String str) {
        final int p = 16777619;
        int hash = (int) 2166136261L;
        for (int i = 0; i < str.length(); i++) {
            hash = (hash^str.charAt(i))*p;
            hash +=hash <<13;
            hash ^=hash >>7;
            hash +=hash <<3;
            hash ^=hash >>17;
            hash +=hash <<5;
            //å¦‚æœç®—å‡ºæ¥çš„å€¼ä¸ºè´Ÿæ•° å–å…¶ç»å¯¹å€¼
            if(hash < 0) {
                hash = Math.abs(hash);
            }
        }
        return hash;
    }
}
```



### åŠ æƒéšæœº

```java

public class WeightRandom {

    public  static Map<String,Integer>  map=new HashMap<>(); //Mapä¿å­˜IPåœ°å€å’Œæƒé‡çš„å¯¹åº”å…³ç³»
    static {
        map.put("10.180.11.126:8888",6);
        map.put("10.180.11.128:8888",6);
        map.put("10.180.11.132:8888",6);
        map.put("10.180.11.144:8888",3);
        map.put("10.180.11.155:8888",3);
        map.put("10.180.11.166:8888",3);
    }
    static Random random = new Random();

    public  String getServer()
    {
        Set<String> keySet=map.keySet(); //å–å¾—IPåœ°å€list
        Iterator<String> iterator=keySet.iterator();
        List<String> serverList= new ArrayList<String>();
        while (iterator.hasNext())
        {  //éå†ipåœ°å€
            String  sever=iterator.next();
            int  weight=map.get(sever);
            for (int i = 0; i < weight; i++) {
                serverList.add(sever); //å¦‚æœæ˜¯æƒé‡ä¸º3çš„server,å°±æ·»åŠ 3å°è¯¥serveråˆ°listé›†åˆä¸­
            }
        }
        int randomPos=random.nextInt(serverList.size());
        String res= serverList.get(randomPos);
        return  res+"å¯¹åº”æƒé‡ä¸ºï¼š "+map.get(res);
    }
    public static void main(String[] args) {
        for (int i = 0; i < 10; i++) {
            System.out.println(new WeightRandom().getServer());
        }
    }
}

```







## Dubbo





## Netty



åœ¨äº†è§£ Netty é«˜æ€§èƒ½åŸç†ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆå‚¨å¤‡ I/O æ¨¡å‹çš„åŸºæœ¬çŸ¥è¯†ã€‚

I/O è¯·æ±‚å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸ºè°ƒç”¨é˜¶æ®µå’Œæ‰§è¡Œé˜¶æ®µã€‚

- ç¬¬ä¸€ä¸ªé˜¶æ®µä¸º**I/O è°ƒç”¨é˜¶æ®µ**ï¼Œå³ç”¨æˆ·è¿›ç¨‹å‘å†…æ ¸å‘èµ·ç³»ç»Ÿè°ƒç”¨ã€‚
- ç¬¬äºŒä¸ªé˜¶æ®µä¸º**I/O æ‰§è¡Œé˜¶æ®µ**ã€‚æ­¤æ—¶ï¼Œå†…æ ¸ç­‰å¾… I/O è¯·æ±‚å¤„ç†å®Œæˆè¿”å›ã€‚è¯¥é˜¶æ®µåˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹ï¼šé¦–å…ˆç­‰å¾…æ•°æ®å°±ç»ªï¼Œå¹¶å†™å…¥å†…æ ¸ç¼“å†²åŒºï¼›éšåå°†å†…æ ¸ç¼“å†²åŒºæ•°æ®æ‹·è´è‡³ç”¨æˆ·æ€ç¼“å†²åŒºã€‚

ä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™å¼ å›¾ï¼š

<img src="https://learn.lianglianglee.com/%e4%b8%93%e6%a0%8f/Netty%20%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8e%20RPC%20%e5%ae%9e%e8%b7%b5-%e5%ae%8c/assets/Ciqc1F-NAZ6Ae3bPAAHigveMsIQ514.png" alt="Drawing 0.png" style="zoom: 50%;" />

:heavy_exclamation_mark: é›¶æ‹·è´å°±æ˜¯å‡å°‘äº†å†…æ ¸ç¼“å†²åŒºâ€”â€”â€”>ç”¨æˆ·ç¼“å†²åŒºçš„ä¸€æ¬¡æ‹·è´







Netty åŸºäº **`ä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å‹`** åšäº†ä¸€å®šçš„ **`æ”¹è¿›`**ï¼Œå…¶ä¸­ä¸»`Reactor`åœ¨`Netty`ä¸­å¯¹åº”`Boss group` çº¿ç¨‹ç»„ï¼Œå­`Reactor`å¯¹åº”`Worker Group` çº¿ç¨‹ç»„ã€‚ä¸»`Reactor`ä»…è´Ÿè´£å»ºç«‹è¿æ¥ï¼Œ`å·¥ä½œç®€å•`ï¼Œä¸€èˆ¬è®¾ç½®1ä¸ªçº¿ç¨‹å°±è¶³å¤Ÿã€‚åœ¨ä¸»`Reactor`å»ºç«‹å¥½è¿æ¥åï¼Œå°†å…¶æ³¨å†Œåˆ°`Worker Group`çº¿ç¨‹ç»„ï¼Œè§¦å‘ç›¸åº”çš„IOäº‹ä»¶ï¼Œæœ€ç»ˆç”±`Pipeline`ä¸­çš„å¤šä¸ª`Handler`è¿›è¡Œæœ‰åºå¤„ç†

- BossGroup çº¿ç¨‹ç»´æŠ¤Selector , åªå…³æ³¨Accecptï¼›
- å½“æ¥æ”¶åˆ°Acceptäº‹ä»¶ï¼Œè·å–åˆ°å¯¹åº”çš„SocketChannel, å°è£…æˆ NIOScoketChannelå¹¶æ³¨å†Œåˆ° Worker çº¿ç¨‹(äº‹ä»¶å¾ªç¯)ï¼Œå¹¶è¿›è¡Œç»´æŠ¤ï¼›
- å½“Workerçº¿ç¨‹ç›‘å¬åˆ°selector ä¸­é€šé“å‘ç”Ÿè‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶åï¼Œå°±è¿›è¡Œå¤„ç†(å°±ç”±handler)ï¼Œ æ³¨æ„ handler å·²ç»åŠ å…¥åˆ°é€šé“

![netty thread](https://img-blog.csdnimg.cn/9637c27dfbdf47c5ac2b7f5546debf61.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5LiA5Liq5bCP56CB5Yac55qE6L-b6Zi25LmL5peF,size_17,color_FFFFFF,t_70,g_se,x_16)

- NettyæŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± ï¼šBossGroup å’Œ WorkerGroup

  - BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥
  - WorkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™

- BossGroup å’Œ WorkerGroup ç±»å‹éƒ½æ˜¯ NioEventLoopGroupï¼ŒNioEventLoopGroup ç›¸å½“äºä¸€ä¸ª äº‹ä»¶å¾ªç¯ç»„ï¼Œè¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯ NioEventLoop

- NioEventLoop è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œ æ¯ä¸ªNioEventLoop éƒ½æœ‰ä¸€ä¸ªselector , ç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„socketçš„ç½‘ç»œé€šè®¯ã€‚

- NioEventLoopGroup å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹, å³å¯ä»¥å«æœ‰å¤šä¸ªNioEventLoop

- æ¯ä¸ªBoss Group ä¸­çš„ NioEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š
  1ï¼‰è½®è¯¢accept äº‹ä»¶
  2ï¼‰å¤„ç†accept äº‹ä»¶ï¼Œä¸clientå»ºç«‹è¿æ¥ , ç”Ÿæˆ NioScocketChannelï¼Œå¹¶å°†å…¶æ³¨å†Œ Worker Group ä¸Šçš„æŸä¸ª NIOEventLoop ä¸Šçš„ selector
  3ï¼‰å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³ runAllTasks

  

- æ¯ä¸ª Worker Group ä¸­çš„ NIOEventLoop å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š
  1ï¼‰è½®è¯¢ read/write äº‹ä»¶
  2ï¼‰å¤„ç† I/O äº‹ä»¶ï¼Œ å³ read/write äº‹ä»¶ï¼Œåœ¨å¯¹åº”çš„ NioScocketChannel ä¸Šå¤„ç†
  3ï¼‰å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ ï¼Œ å³ runAllTasks

  

- æ¯ä¸ªWorker NIOEventLoop å¤„ç†ä¸šåŠ¡æ—¶ï¼Œä¼šä½¿ç”¨ pipeline(ç®¡é“)ã€‚pipelineä¸­åŒ…å«äº† channelï¼Œå³é€šè¿‡piplineå¯ä»¥è·å–åˆ°å¯¹åº”çš„ channelï¼Œå¹¶ä¸”piplineç»´æŠ¤äº†å¾ˆå¤šçš„ handler(å¤„ç†å™¨)æ¥å¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œä¸€ç³»åˆ—çš„å¤„ç†ã€‚

- handler(å¤„ç†å™¨) æœ‰Nettyå†…ç½®çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰



ä¸‹é¢æ˜¯Nettyä½¿ç”¨ä¸­å¾ˆå¸¸è§çš„ä¸€æ®µä»£ç :

```java
public class Server {
    public static void main(String[] args) throws Exception {
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(bossGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .childOption(ChannelOption.TCP_NODELAY, true)
                    .childAttr(AttributeKey.newInstance("childAttr"), "childAttrValue")
                    .handler(new ServerHandler())
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        public void initChannel(SocketChannel ch) {
                        }
                    });
            ChannelFuture f = b.bind(8888).sync();
            f.channel().closeFuture().sync();
        } finally {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
```

**bossçº¿ç¨‹æ± ä½œç”¨ï¼š**

1. æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œåˆå§‹åŒ–Channelå‚æ•°ã€‚
2. å°†é“¾è·¯çŠ¶æ€å˜æ›´æ—¶é—´é€šçŸ¥ç»™ChannelPipelineã€‚



**workerçº¿ç¨‹æ± ä½œç”¨ï¼š**

1. å¼‚æ­¥è¯»å–é€šä¿¡å¯¹ç«¯çš„æ•°æ®æŠ¥ï¼Œå‘é€è¯»äº‹ä»¶åˆ°ChannelPipelineã€‚
2. å¼‚æ­¥å‘é€æ¶ˆæ¯åˆ°é€šä¿¡å¯¹ç«¯ï¼Œè°ƒç”¨ChannelPipelineçš„æ¶ˆæ¯å‘é€æ¥å£ã€‚
3. æ‰§è¡Œç³»ç»Ÿè°ƒç”¨Taskã€‚
4. æ‰§è¡Œå®šæ—¶ä»»åŠ¡Taskã€‚



Nettyé€šè¿‡Reactoræ¨¡å‹åŸºäºå¤šè·¯å¤ç”¨å™¨æ¥æ”¶å¹¶å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå†…éƒ¨å®ç°äº†ä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œbossçº¿ç¨‹æ± å’Œworkçº¿ç¨‹æ± ï¼Œå…¶ä¸­bossçº¿ç¨‹æ± çš„çº¿ç¨‹è´Ÿè´£å¤„ç†è¯·æ±‚çš„acceptäº‹ä»¶ï¼Œå½“æ¥æ”¶åˆ°acceptäº‹ä»¶çš„è¯·æ±‚æ—¶ï¼ŒæŠŠå¯¹åº”çš„socketå°è£…åˆ°ä¸€ä¸ªNioSocketChannelä¸­ï¼Œå¹¶äº¤ç»™workçº¿ç¨‹æ± ï¼Œå…¶ä¸­workçº¿ç¨‹æ± è´Ÿè´£è¯·æ±‚çš„readå’Œwriteäº‹ä»¶ 

Netty çš„ I/O æ¨¡å‹æ˜¯åŸºäºéé˜»å¡ I/O å®ç°çš„ï¼Œåº•å±‚ä¾èµ–çš„æ˜¯ JDK NIO æ¡†æ¶çš„å¤šè·¯å¤ç”¨å™¨ Selectorã€‚ä¸€ä¸ªå¤šè·¯å¤ç”¨å™¨ Selector å¯ä»¥åŒæ—¶è½®è¯¢å¤šä¸ª Channelï¼Œé‡‡ç”¨ epoll æ¨¡å¼åï¼Œåªéœ€è¦ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ Selector çš„è½®è¯¢ï¼Œå°±å¯ä»¥æ¥å…¥æˆåƒä¸Šä¸‡çš„å®¢æˆ·ç«¯ã€‚

åœ¨ I/O å¤šè·¯å¤ç”¨çš„åœºæ™¯ä¸‹ï¼Œå½“æœ‰æ•°æ®å¤„äºå°±ç»ªçŠ¶æ€åï¼Œéœ€è¦ä¸€ä¸ªäº‹ä»¶åˆ†å‘å™¨ï¼ˆEvent Dispatcherï¼‰ï¼Œå®ƒè´Ÿè´£å°†è¯»å†™äº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„è¯»å†™äº‹ä»¶å¤„ç†å™¨ï¼ˆEvent Handlerï¼‰ã€‚äº‹ä»¶åˆ†å‘å™¨æœ‰ä¸¤ç§è®¾è®¡æ¨¡å¼ï¼šReactor å’Œ Proactorï¼Œ**Reactor é‡‡ç”¨åŒæ­¥ I/Oï¼Œ Proactor é‡‡ç”¨å¼‚æ­¥ I/O** 



![6.png](https://learn.lianglianglee.com/%e4%b8%93%e6%a0%8f/Netty%20%e6%a0%b8%e5%bf%83%e5%8e%9f%e7%90%86%e5%89%96%e6%9e%90%e4%b8%8e%20RPC%20%e5%ae%9e%e8%b7%b5-%e5%ae%8c/assets/Ciqc1F-NKE-AWqZfAARsOnKW3pg690.png)



ä¸Šå›¾æ‰€æè¿°çš„ä¾¿æ˜¯ Netty æ‰€é‡‡ç”¨çš„ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å‹ï¼Œæ‰€æœ‰çš„ I/O äº‹ä»¶éƒ½æ³¨å†Œåˆ°ä¸€ä¸ª I/O å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå½“æœ‰ I/O äº‹ä»¶å‡†å¤‡å°±ç»ªåï¼ŒI/O å¤šè·¯å¤ç”¨å™¨ä¼šå°†è¯¥ I/O äº‹ä»¶é€šè¿‡äº‹ä»¶åˆ†å‘å™¨åˆ†å‘åˆ°å¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨ä¸­ã€‚è¯¥çº¿ç¨‹æ¨¡å‹é¿å…äº†åŒæ­¥é—®é¢˜ä»¥åŠå¤šçº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„èµ„æºå¼€é”€ï¼ŒçœŸæ­£åšåˆ°é«˜æ€§èƒ½ã€ä½å»¶è¿Ÿã€‚







## å¦‚ä½•è®¾è®¡é«˜å¹¶å‘ç³»ç»Ÿï¼Ÿ



[ç³»ç»Ÿæ‹†åˆ†](https://doocs.github.io/advanced-java/#/docs/high-concurrency/high-concurrency-design?id=ç³»ç»Ÿæ‹†åˆ†)

å°†ä¸€ä¸ªç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªå­ç³»ç»Ÿï¼Œç”¨ dubbo æ¥æã€‚ç„¶åæ¯ä¸ªç³»ç»Ÿè¿ä¸€ä¸ªæ•°æ®åº“ï¼Œè¿™æ ·æœ¬æ¥å°±ä¸€ä¸ªåº“ï¼Œç°åœ¨å¤šä¸ªæ•°æ®åº“ï¼Œä¸ä¹Ÿå¯ä»¥æ‰›é«˜å¹¶å‘ä¹ˆ





[ç¼“å­˜](https://doocs.github.io/advanced-java/#/docs/high-concurrency/high-concurrency-design?id=ç¼“å­˜)

ç¼“å­˜ï¼Œå¿…é¡»å¾—ç”¨ç¼“å­˜ã€‚å¤§éƒ¨åˆ†çš„é«˜å¹¶å‘åœºæ™¯ï¼Œéƒ½æ˜¯**è¯»å¤šå†™å°‘**ï¼Œé‚£ä½ å®Œå…¨å¯ä»¥åœ¨æ•°æ®åº“å’Œç¼“å­˜é‡Œéƒ½å†™ä¸€ä»½ï¼Œç„¶åè¯»çš„æ—¶å€™å¤§é‡èµ°ç¼“å­˜ä¸å°±å¾—äº†ã€‚æ¯•ç«Ÿäººå®¶ redis è½»è½»æ¾æ¾å•æœºå‡ ä¸‡çš„å¹¶å‘ã€‚æ‰€ä»¥ä½ å¯ä»¥è€ƒè™‘è€ƒè™‘ä½ çš„é¡¹ç›®é‡Œï¼Œé‚£äº›æ‰¿è½½ä¸»è¦è¯·æ±‚çš„**è¯»åœºæ™¯ï¼Œæ€ä¹ˆç”¨ç¼“å­˜æ¥æŠ—é«˜å¹¶å‘**





[MQ](https://doocs.github.io/advanced-java/#/docs/high-concurrency/high-concurrency-design?id=mq)

MQï¼Œå¿…é¡»å¾—ç”¨ MQã€‚å¯èƒ½ä½ è¿˜æ˜¯ä¼šå‡ºç°é«˜å¹¶å‘å†™çš„åœºæ™¯ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªä¸šåŠ¡æ“ä½œé‡Œè¦é¢‘ç¹ææ•°æ®åº“å‡ åæ¬¡ï¼Œå¢åˆ æ”¹å¢åˆ æ”¹ï¼Œç–¯äº†ã€‚é‚£é«˜å¹¶å‘ç»å¯¹ææŒ‚ä½ çš„ç³»ç»Ÿï¼Œä½ è¦æ˜¯ç”¨ redis æ¥æ‰¿è½½å†™é‚£è‚¯å®šä¸è¡Œï¼Œäººå®¶æ˜¯ç¼“å­˜ï¼Œæ•°æ®éšæ—¶å°±è¢« LRU äº†ï¼Œæ•°æ®æ ¼å¼è¿˜æ— æ¯”ç®€å•ï¼Œæ²¡æœ‰äº‹åŠ¡æ”¯æŒã€‚æ‰€ä»¥è¯¥ç”¨ mysql è¿˜å¾—ç”¨ mysql å•Šã€‚é‚£ä½ å’‹åŠï¼Ÿç”¨ MQ å§ï¼Œå¤§é‡çš„å†™è¯·æ±‚çŒå…¥ MQ é‡Œï¼Œæ’é˜Ÿæ…¢æ…¢ç©å„¿ï¼Œ**åè¾¹ç³»ç»Ÿæ¶ˆè´¹åæ…¢æ…¢å†™**ï¼Œæ§åˆ¶åœ¨ mysql æ‰¿è½½èŒƒå›´ä¹‹å†…ã€‚æ‰€ä»¥ä½ å¾—è€ƒè™‘è€ƒè™‘ä½ çš„é¡¹ç›®é‡Œï¼Œé‚£äº›æ‰¿è½½å¤æ‚å†™ä¸šåŠ¡é€»è¾‘çš„åœºæ™¯é‡Œï¼Œå¦‚ä½•ç”¨ MQ æ¥å¼‚æ­¥å†™ï¼Œæå‡å¹¶å‘æ€§ã€‚MQ å•æœºæŠ—å‡ ä¸‡å¹¶å‘ä¹Ÿæ˜¯ ok çš„







[åˆ†åº“åˆ†è¡¨](https://doocs.github.io/advanced-java/#/docs/high-concurrency/high-concurrency-design?id=åˆ†åº“åˆ†è¡¨)

åˆ†åº“åˆ†è¡¨ï¼Œå¯èƒ½åˆ°äº†æœ€åæ•°æ®åº“å±‚é¢è¿˜æ˜¯å…ä¸äº†æŠ—é«˜å¹¶å‘çš„è¦æ±‚ï¼Œå¥½å§ï¼Œé‚£ä¹ˆå°±å°†ä¸€ä¸ªæ•°æ®åº“æ‹†åˆ†ä¸ºå¤šä¸ªåº“ï¼Œå¤šä¸ªåº“æ¥æ‰›æ›´é«˜çš„å¹¶å‘ï¼›ç„¶åå°†ä¸€ä¸ªè¡¨**æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨**ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®é‡ä¿æŒå°‘ä¸€ç‚¹ï¼Œæé«˜è·‘sqlçš„æ€§èƒ½





[è¯»å†™åˆ†ç¦»](https://doocs.github.io/advanced-java/#/docs/high-concurrency/high-concurrency-design?id=è¯»å†™åˆ†ç¦»)

è¯»å†™åˆ†ç¦»ï¼Œè¿™ä¸ªå°±æ˜¯è¯´å¤§éƒ¨åˆ†æ—¶å€™æ•°æ®åº“å¯èƒ½ä¹Ÿæ˜¯è¯»å¤šå†™å°‘ï¼Œæ²¡å¿…è¦æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªåº“ä¸Šå§ï¼Œå¯ä»¥æä¸ªä¸»ä»æ¶æ„ï¼Œ**ä¸»åº“å†™**å…¥ï¼Œ**ä»åº“è¯»**å–ï¼Œæä¸€ä¸ªè¯»å†™åˆ†ç¦»ã€‚**è¯»æµé‡å¤ªå¤š**çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥**åŠ æ›´å¤šçš„ä»åº“**





[ElasticSearch](https://doocs.github.io/advanced-java/#/docs/high-concurrency/high-concurrency-design?id=elasticsearch)

es æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå¯ä»¥éšä¾¿æ‰©å®¹ï¼Œåˆ†å¸ƒå¼å¤©ç„¶å°±å¯ä»¥æ”¯æ’‘é«˜å¹¶å‘ï¼Œå› ä¸ºåŠ¨ä¸åŠ¨å°±å¯ä»¥æ‰©å®¹åŠ æœºå™¨æ¥æ‰›æ›´é«˜çš„å¹¶å‘ã€‚é‚£ä¹ˆä¸€äº›æ¯”è¾ƒç®€å•çš„æŸ¥è¯¢ã€ç»Ÿè®¡ç±»çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ç”¨ es æ¥æ‰¿è½½ï¼Œè¿˜æœ‰ä¸€äº›å…¨æ–‡æœç´¢ç±»çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥è€ƒè™‘ç”¨ es æ¥æ‰¿è½½ã€‚



ä¸Šé¢çš„ 6 ç‚¹ï¼ŒåŸºæœ¬å°±æ˜¯é«˜å¹¶å‘ç³»ç»Ÿè‚¯å®šè¦å¹²çš„ä¸€äº›äº‹å„¿ï¼Œå¤§å®¶å¯ä»¥ä»”ç»†ç»“åˆä¹‹å‰è®²è¿‡çš„çŸ¥è¯†è€ƒè™‘ä¸€ä¸‹ï¼Œåˆ°æ—¶å€™ä½ å¯ä»¥ç³»ç»Ÿçš„æŠŠè¿™å—é˜è¿°ä¸€ä¸‹ï¼Œç„¶åæ¯ä¸ªéƒ¨åˆ†è¦æ³¨æ„å“ªäº›é—®é¢˜ï¼Œä¹‹å‰éƒ½è®²è¿‡äº†ï¼Œä½ éƒ½å¯ä»¥é˜è¿°é˜è¿°ï¼Œè¡¨æ˜ä½ å¯¹è¿™å—æ˜¯æœ‰ç‚¹ç§¯ç´¯çš„ã€‚

è¯´å¥å®è¯ï¼Œæ¯•ç«Ÿä½ çœŸæ­£å‰å®³çš„ä¸€ç‚¹ï¼Œä¸æ˜¯åœ¨äºå¼„æ˜ç™½ä¸€äº›æŠ€æœ¯ï¼Œæˆ–è€…å¤§æ¦‚çŸ¥é“ä¸€ä¸ªé«˜å¹¶å‘ç³»ç»Ÿåº”è¯¥é•¿ä»€ä¹ˆæ ·ï¼Ÿå…¶å®å®é™…ä¸Šåœ¨çœŸæ­£çš„å¤æ‚çš„ä¸šåŠ¡ç³»ç»Ÿé‡Œï¼Œåšé«˜å¹¶å‘è¦è¿œè¿œæ¯”ä¸Šé¢æåˆ°çš„ç‚¹è¦å¤æ‚å‡ åå€åˆ°ä¸Šç™¾å€ã€‚ä½ éœ€è¦è€ƒè™‘ï¼šå“ªäº›éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Œå“ªäº›ä¸éœ€è¦åˆ†åº“åˆ†è¡¨ï¼Œå•åº“å•è¡¨è·Ÿåˆ†åº“åˆ†è¡¨å¦‚ä½• joinï¼Œå“ªäº›æ•°æ®è¦æ”¾åˆ°ç¼“å­˜é‡Œå»ï¼Œæ”¾å“ªäº›æ•°æ®æ‰å¯ä»¥æ‰›ä½é«˜å¹¶å‘çš„è¯·æ±‚ï¼Œä½ éœ€è¦å®Œæˆå¯¹ä¸€ä¸ªå¤æ‚ä¸šåŠ¡ç³»ç»Ÿçš„åˆ†æä¹‹åï¼Œç„¶åé€æ­¥é€æ­¥çš„åŠ å…¥é«˜å¹¶å‘çš„ç³»ç»Ÿæ¶æ„çš„æ”¹é€ ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ— æ¯”å¤æ‚çš„ï¼Œä¸€æ—¦åšè¿‡ä¸€æ¬¡ï¼Œå¹¶ä¸”åšå¥½äº†ï¼Œä½ åœ¨è¿™ä¸ªå¸‚åœºä¸Šå°±ä¼šéå¸¸çš„åƒé¦™ã€‚







# æ‚é¡¹





## è®¾è®¡æ¨¡å¼å…­å¤§åŸåˆ™







## CPUå¯†é›†å‹å’ŒIOå¯†é›†å‹



> `CPUå¯†é›†å‹`ä¸`I/Oå¯†é›†å‹`æ˜¯åœ¨è®¡ç®—æœºä¸Šæ‰§è¡Œä»»åŠ¡çš„ä¸¤ç§ç­–ç•¥ï¼Œåœ¨å¹¶å‘æ‰§è¡Œä»»åŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©ä½¿ç”¨å¤šçº¿ç¨‹è¿˜æ˜¯å¤šè¿›ç¨‹ï¼š
> â€ƒâ€ƒå¦‚æœæ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå¦‚æœæ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼Œä½¿ç”¨å¤šè¿›ç¨‹ã€‚
> â€ƒâ€ƒå‰è€…æŒ‡å†…å­˜ç£ç›˜I/Oä½¿ç”¨ç‡é«˜ï¼ŒCPUä½¿ç”¨ç‡ä½ï¼›ç›¸åï¼Œåè€…æŒ‡CPUä½¿ç”¨ç‡é«˜ï¼Œå†…å­˜ç£ç›˜I/Oä½¿ç”¨ç‡ä½ã€‚



é’ˆå¯¹**CPUå¯†é›†å‹ï¼š**

`CPUå¯†é›†å‹`ï¼Œä¹Ÿå«`è®¡ç®—å¯†é›†å‹`ï¼Œä¸€èˆ¬æ˜¯æŒ‡æœåŠ¡å™¨çš„ç¡¬ç›˜ã€å†…å­˜ç¡¬ä»¶æ€§èƒ½ç›¸å¯¹CPUå¥½å¾ˆå¤šï¼Œæˆ–è€…ä½¿ç”¨ç‡ä½å¾ˆå¤šã€‚ç³»ç»Ÿè¿è¡ŒCPUè¯»å†™I/O(ç¡¬ç›˜/å†…å­˜)æ—¶å¯ä»¥åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å®Œæˆï¼Œå‡ ä¹æ²¡æœ‰é˜»å¡ï¼ˆç­‰å¾…I/Oçš„å®æ—¶é—´ï¼‰æ—¶é—´ï¼Œè€ŒCPUä¸€ç›´æœ‰å¤§é‡è¿ç®—è¦å¤„ç†ï¼Œå› æ­¤CPUè´Ÿè½½é•¿æœŸè¿‡é«˜ã€‚

â€ƒâ€ƒCPUå¯†é›†å‡ ä¹æ— I/Oé˜»å¡ï¼ŒCPUä¸€ç›´ä¼šå…¨é€Ÿè¿è¡Œã€‚`å¦‚æœæ˜¯å•æ ¸æƒ…å†µä¸‹ï¼Œå¼€å¤šçº¿ç¨‹æ˜¯æ²¡æœ‰æ„ä¹‰çš„`ï¼Œè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªCPUæ¥å›åˆ‡ç€è¿è¡Œè€Œå·²ï¼Œå¾’å¢çº¿ç¨‹åˆ‡æ¢çš„èµ„æºæ¶ˆè€—ï¼Œåµç”¨æ²¡æœ‰ã€‚å¯è§ï¼ŒCPUå¯†é›†ä»»åŠ¡åªæœ‰åœ¨`å¤šæ ¸CPUä¸Š`ã€`å¼€å¤šçº¿ç¨‹`æ‰å¯èƒ½æé€Ÿã€‚

â€ƒâ€ƒCPUä½¿ç”¨ç‡è¾ƒé«˜æ—¶ï¼ˆå¦‚æˆ‘ä»¬è®­ç»ƒç®—æ³•æ¨¡å‹ã€æè®­ç»ƒé›†ï¼‰ï¼Œé€šå¸¸çº¿ç¨‹æ•°åªéœ€è¦è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°çš„çº¿ç¨‹ä¸ªæ•°å°±å¯ä»¥äº†ã€‚å•CPUå¯¹åº”å•çº¿ç¨‹æ•ˆç‡æœ€é«˜ã€‚

> ä¸€èˆ¬å…¶è®¡ç®—å…¬å¼å¯éµå¾ªï¼š**CPUå¯†é›†å‹æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•°**+1
>
> 
>
> è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„ä¸»è¦æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†çº¿ç¨‹æ•°è®¾ç½®ä¸º Nï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰+1ã€‚æ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å¶å‘çš„ç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU å°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´ã€‚





é’ˆå¯¹**IOå¯†é›†å‹ï¼š**

`I/Oå¯†é›†å‹`ç›¸åï¼Œä¸€èˆ¬æ˜¯æŒ‡æœåŠ¡å™¨CPUçš„æ€§èƒ½ç›¸å¯¹ç¡¬ç›˜ã€å†…å­˜ç¡¬ä»¶å¥½å¾ˆå¤šï¼Œæˆ–è€…ä½¿ç”¨ç‡ä½å¾ˆå¤šã€‚ç³»ç»Ÿè¿è¡Œå¤šæ˜¯CPUåœ¨ç­‰I/O (ç¡¬ç›˜/å†…å­˜) çš„è¯»å†™æ“ä½œï¼Œæ­¤ç±»æƒ…æ™¯ä¸‹CPUè´Ÿè½½å¹¶ä¸é«˜ã€‚

â€ƒâ€ƒI/Oå¯†é›†å‹çš„ç¨‹åºä¸€èˆ¬åœ¨è¾¾åˆ°æ€§èƒ½æé™æ—¶ï¼ŒCPUå ç”¨ç‡ä»ç„¶è¾ƒä½ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºä»»åŠ¡æœ¬èº«éœ€è¦å¤§é‡I/Oæ“ä½œï¼Œè€Œç¨‹åºçš„é€»è¾‘åšå¾—å¹¶ä¸å¥½ï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨CPUèƒ½åŠ›ï¼Œå¯¼è‡´`çº¿ç¨‹ç©ºä½™æ—¶é—´å¾ˆå¤š`ã€‚é€šå¸¸æˆ‘ä»¬ä¼šå¼€`CPUæ ¸å¿ƒæ•°`æ•°å€çš„çº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹è¿›è¡Œ I/O æ“ä½œ CPU ç©ºé—²æ—¶ï¼Œå¯ç”¨å…¶ä»–çº¿ç¨‹ç»§ç»­ä½¿ç”¨ CPUï¼Œä»¥æé«˜ CPU çš„ä½¿ç”¨ç‡ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚

> ä¸€èˆ¬å…¶è®¡ç®—å…¬å¼å¯éµå¾ªï¼š**I/Oå¯†é›†å‹æ ¸å¿ƒçº¿ç¨‹æ•° = CPUæ ¸æ•° / ï¼ˆ1-é˜»å¡ç³»æ•°ï¼‰**

â€ƒâ€ƒé˜»å¡ç³»æ•°åœ¨åœ¨0åˆ°1èŒƒå›´å†…ã€‚ä¸€èˆ¬ä¸º0.8~0.9ä¹‹é—´ï¼Œä¹Ÿå¯ä»¥å–0.8æˆ–è€…0.9ã€‚å¯¹äºåŒæ ¸CPUæ¥è¯´ï¼Œå®ƒæ¯”è¾ƒç†æƒ³çš„çº¿ç¨‹æ•°å°±æ˜¯20ï¼Œå½“ç„¶è¿™éƒ½ä¸æ˜¯ç»å¯¹çš„ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µä»¥åŠå®é™…ä¸šåŠ¡æ¥è°ƒæ•´ã€‚

è¿™ç§ä»»åŠ¡åº”ç”¨èµ·æ¥ï¼Œç³»ç»Ÿä¼šç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I/O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I/O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ã€‚å› æ­¤åœ¨ I/O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2N



## RestFulé£æ ¼

`REST`ï¼ˆRepresentational State Transferï¼‰æ˜¯ä¸€ç§è®¾è®¡ç†å¿µï¼Œå®ƒå¼ºè°ƒèµ„æºçš„çŠ¶æ€ä»¥åŠå¯¹èµ„æºè¿›è¡Œæ“ä½œçš„æ–¹å¼ã€‚RESTfulé£æ ¼æ˜¯åŸºäºRESTåŸåˆ™çš„åº”ç”¨ç¨‹åºè®¾è®¡è§„èŒƒï¼Œä¸»è¦ç”¨äºæ„å»ºWebæœåŠ¡å’ŒAPIã€‚ä»¥ä¸‹æ˜¯RESTfulé£æ ¼çš„ä¸€äº›ä¸»è¦ç‰¹ç‚¹ï¼š

1. èµ„æºï¼ˆResourceï¼‰ï¼šåœ¨RESTfulé£æ ¼ä¸­ï¼Œæ¯ä¸ªå®ä½“ï¼ˆå¯¹è±¡ã€æ•°æ®ç­‰ï¼‰éƒ½è¢«è§†ä¸ºä¸€ä¸ªèµ„æºï¼Œèµ„æºå¯ä»¥ç”¨URLè¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚
2. è¡¨ç°å±‚çŠ¶æ€è½¬æ¢ï¼ˆRepresentational State Transferï¼‰ï¼šèµ„æºçš„çŠ¶æ€ä»¥åŠå¯¹èµ„æºçš„æ“ä½œé€šè¿‡HTTPæ–¹æ³•æ¥è¡¨ç¤ºã€‚å¸¸ç”¨çš„HTTPæ–¹æ³•åŒ…æ‹¬GETï¼ˆè·å–èµ„æºï¼‰ã€POSTï¼ˆåˆ›å»ºèµ„æºï¼‰ã€PUTï¼ˆæ›´æ–°èµ„æºï¼‰å’ŒDELETEï¼ˆåˆ é™¤èµ„æºï¼‰ç­‰ã€‚
3. URLä½œä¸ºèµ„æºçš„å”¯ä¸€æ ‡è¯†ï¼šæ¯ä¸ªèµ„æºéƒ½æœ‰å”¯ä¸€çš„URLï¼Œé€šè¿‡è®¿é—®ä¸åŒçš„URLæ¥æ“ä½œä¸åŒçš„èµ„æºã€‚
4. æ— çŠ¶æ€æ€§ï¼ˆStatelessnessï¼‰ï¼šRESTfulæ¶æ„æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¿ç•™å®¢æˆ·ç«¯çš„çŠ¶æ€ä¿¡æ¯ã€‚å®¢æˆ·ç«¯å¿…é¡»åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯åœ¨è¯·æ±‚ä¸­ï¼ŒæœåŠ¡å™¨åœ¨æ¯ä¸ªè¯·æ±‚ä¹‹é—´æ²¡æœ‰ä»»ä½•è®°å¿†ã€‚
5. ä½¿ç”¨HTTPåè®®ï¼šRESTful APIé€šå¸¸ä½¿ç”¨HTTPåè®®ä½œä¸ºé€šä¿¡åè®®ï¼Œåˆ©ç”¨HTTPçš„æ–¹æ³•ã€çŠ¶æ€ç ã€è¯·æ±‚å¤´ç­‰ç‰¹æ€§æ¥è¡¨ç¤ºèµ„æºçŠ¶æ€å’Œæ“ä½œã€‚





å‡è®¾æˆ‘ä»¬è¦æ„å»ºä¸€ä¸ªç”¨äºç®¡ç†å›¾ä¹¦ä¿¡æ¯çš„ RESTful APIï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ RESTful é£æ ¼çš„ä¾‹å­ï¼š

1ã€è·å–ç‰¹å®šå›¾ä¹¦ä¿¡æ¯ï¼šä½¿ç”¨ HTTP GET æ–¹æ³•å’Œå›¾ä¹¦çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆæ¯”å¦‚å›¾ä¹¦çš„IDï¼‰æ¥è·å–ç‰¹å®šå›¾ä¹¦çš„ä¿¡æ¯ã€‚

```
GET /books/{bookId}
```



2ã€æ›´æ–°å›¾ä¹¦ä¿¡æ¯ï¼šä½¿ç”¨ HTTP PUT æ–¹æ³•å’Œå›¾ä¹¦çš„å”¯ä¸€æ ‡è¯†ç¬¦æ¥æ›´æ–°ç‰¹å®šå›¾ä¹¦çš„ä¿¡æ¯ã€‚

```
PUT /books/{bookId}
```

(Putè¯·æ±‚åº”å½“æ˜¯**å¹‚ç­‰**çš„ï¼Œå¤šæ¬¡è¯·æ±‚åŒä¸€URLçš„PUTæ“ä½œåº”è¯¥äº§ç”Ÿç›¸åŒçš„ç»“æœï¼Œä¸ä¼šå¯¹æœåŠ¡å™¨ç«¯èµ„æºäº§ç”Ÿé‡å¤çš„å‰¯ä½œç”¨    `Put`å¯ä»¥çœ‹ä½œæ˜¯`Update`)

> PUT å’Œ POST æ˜¯ä¸¤ç§ä¸åŒçš„ HTTP è¯·æ±‚æ–¹æ³•ï¼Œå®ƒä»¬åœ¨ä½¿ç”¨æ–¹å¼å’Œè¯­ä¹‰ä¸Šæœ‰ä»¥ä¸‹åŒºåˆ«ï¼š
>
> 1. è¯­ä¹‰ä¸åŒï¼š
>    - POSTï¼šç”¨äºå‘æœåŠ¡å™¨æäº¤æ•°æ®ï¼Œè¯·æ±‚æœåŠ¡å™¨åˆ›å»ºæ–°çš„èµ„æºã€‚æ¯æ¬¡ POST è¯·æ±‚å‘é€æ—¶ï¼ŒæœåŠ¡å™¨é€šå¸¸ä¼šåœ¨èµ„æºä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¡¨ç¤ºè¯¥å®ä¾‹çš„å”¯ä¸€æ ‡è¯†ï¼ˆé€šå¸¸æ˜¯èµ„æºçš„ URLï¼‰ã€‚
>    - PUTï¼šç”¨äºå‘æœåŠ¡å™¨æäº¤æ•°æ®ï¼Œè¯·æ±‚æœåŠ¡å™¨æ›´æ–°å·²å­˜åœ¨çš„èµ„æºã€‚æ¯æ¬¡ PUT è¯·æ±‚å‘é€æ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦æä¾›å®Œæ•´çš„æ›´æ–°æ•°æ®ï¼Œå¹¶æŒ‡å®šæ›´æ–°çš„èµ„æºçš„ä½ç½®ã€‚
> 2. å¹‚ç­‰æ€§ï¼š
>    - POSTï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ**POST è¯·æ±‚ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡è¯·æ±‚åŒä¸€ä¸ª POST æ¥å£å¯èƒ½ä¼šåˆ›å»ºå¤šä¸ªç›¸åŒçš„èµ„æº**ã€‚
>    - PUTï¼š**PUT è¯·æ±‚åº”è¯¥æ˜¯å¹‚ç­‰çš„**ï¼Œå¤šæ¬¡è¯·æ±‚åŒä¸€ä¸ª PUT æ¥å£åº”è¯¥å…·æœ‰ç›¸åŒçš„æ•ˆæœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤šæ¬¡ä½¿ç”¨ç›¸åŒçš„æ•°æ®è¿›è¡Œ PUT è¯·æ±‚ï¼ŒæœåŠ¡å™¨çš„èµ„æºçŠ¶æ€åº”è¯¥ä¿æŒä¸€è‡´ã€‚
> 3. ä½¿ç”¨åœºæ™¯ï¼š
>    - POSTï¼š**é€‚ç”¨äºåˆ›å»ºæ–°èµ„æº**ï¼Œæ¯”å¦‚æäº¤ä¸€ä¸ªæ–°çš„è®¢å•ã€åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è´¦å·ç­‰ã€‚å› ä¸ºæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°èµ„æºï¼Œå› æ­¤ POST è¯·æ±‚å¯èƒ½ä¼šå¯¹æœåŠ¡å™¨äº§ç”Ÿå‰¯ä½œç”¨ï¼ˆå¦‚æ–°å¢èµ„æºï¼‰ã€‚
>    - PUTï¼š**é€‚ç”¨äºæ›´æ–°å·²å­˜åœ¨çš„èµ„æº**ï¼Œæ¯”å¦‚æ›´æ–°ç”¨æˆ·èµ„æ–™ã€ä¿®æ”¹å·²æœ‰çš„æ–‡ç« ç­‰ã€‚PUT è¯·æ±‚é€šå¸¸ç”¨äºæ›¿æ¢æ•´ä¸ªèµ„æºï¼Œæ‰€ä»¥è¦æ±‚å®¢æˆ·ç«¯æä¾›å®Œæ•´çš„èµ„æºè¡¨è¿°ï¼Œå³ä½¿åªæ›´æ–°äº†éƒ¨åˆ†å­—æ®µã€‚



3ã€æœç´¢å›¾ä¹¦ï¼šå¯ä»¥é€šè¿‡æŸ¥è¯¢å‚æ•°æ¥æœç´¢å›¾ä¹¦ï¼Œæ¯”å¦‚æ ¹æ®ä½œè€…ã€æ ‡é¢˜ç­‰è¿›è¡Œè¿‡æ»¤ã€‚

```
GET /books?author=John%20Doe
```



å†æ¥çœ‹ä¸€ä¸ªè¾ƒä¸ºè¯¦ç»†çš„ä¾‹å­ï¼š

1. 
   åˆ›å»ºä¹¦ç±èµ„æºï¼š

   - POST /api/books
   
   - è¯·æ±‚ä½“ï¼ˆRequest Bodyï¼‰
   
   - ```json
     {
       "title": "RESTful API Design",
       "author": "John Doe",
       "year": 2023,
       "genre": "Technology"
     }
     ```
   
   - å“åº”ï¼ˆResponseï¼‰ï¼š
   
   - ```json
     {
       "id": "123456",
       "title": "RESTful API Design",
       "author": "John Doe",
       "year": 2023,
       "genre": "Technology"
     }
     ```
   
     æœåŠ¡å™¨åœ¨æˆåŠŸå¤„ç†è¯¥è¯·æ±‚åï¼Œåˆ›å»ºäº†ä¸€æœ¬åä¸º "RESTful API Design" çš„æ–°ä¹¦ï¼Œå¹¶è¿”å›è¯¥ä¹¦çš„å”¯ä¸€æ ‡è¯† "123456"(è¿”å›çš„IDå…·ä½“ä¸ºå¤šå°‘ä¸€èˆ¬æ˜¯æ ¹æ®æ•°æ®åº“ä¸»é”®ç”Ÿæˆç­–ç•¥)
   
2. æ›´æ–°ä¹¦ç±èµ„æºï¼š

   - PUT /api/books/123456  (æ ¹æ®ä¹¦çš„IDæ›´æ–°)

   - è¯·æ±‚ä½“ï¼ˆRequest Bodyï¼‰

   - ```json
     {
       "title": "Updated RESTful API Design",
       "author": "John Doe",
       "year": 2023,
       "genre": "Technology"
     }
     ```

   - å“åº”ï¼ˆResponseï¼‰ï¼š

   - ```json
     {
       "id": "123456",
       "title": "Updated RESTful API Design",
       "author": "John Doe",
       "year": 2023,
       "genre": "Technology"
     }
     ```

   - æœåŠ¡å™¨æ¥æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œä½¿ç”¨æä¾›çš„æ•°æ®æ›´æ–° ID ä¸º "123456" çš„ä¹¦ç±èµ„æºï¼Œå°†ä¹¦åä» "RESTful API Design" æ›´æ–°ä¸º "Updated RESTful API Design"ã€‚



**æ€»ç»“ï¼š** POST ç”¨äºåˆ›å»ºæ–°èµ„æºï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å¯èƒ½å¯¼è‡´èµ„æºçš„æ–°å¢ï¼Œè€Œ PUT ç”¨äºæ›´æ–°å·²å­˜åœ¨çš„èµ„æºï¼Œè¦æ±‚å®¢æˆ·ç«¯æä¾›å®Œæ•´çš„èµ„æºæ•°æ®ä»¥æ›¿æ¢ç›®æ ‡èµ„æºã€‚åŒæ—¶ï¼Œ**PUT è¯·æ±‚åº”è¯¥æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡è¯·æ±‚ç›¸åŒçš„ PUT æ¥å£åº”è¯¥å…·æœ‰ç›¸åŒçš„æ•ˆæœ** 

 









## Oauth2.0



